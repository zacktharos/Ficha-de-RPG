<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ficha de Personagem RPG</title>
    <link href="https://fonts.googleapis.com/css2?family=MedievalSharp&family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <style>
        /* Estilos mantidos iguais ao original para brevidade. Copie os estilos do código fornecido aqui. */
    </style>
</head>
<body>
    <div id="fichas-sidebar">
        <div id="add-ficha-btn"><span>+ Fichas</span></div>
    </div>

    <div id="ficha-container">
        <h1 id="nome-personagem-titulo">Ficha de Personagem</h1>
        <div id="game-master-message">Você virou o Game Master</div>
        <div id="character-image-container" onclick="document.getElementById('character-image-input').click()">
            <img id="character-image" alt="Imagem do Personagem">
            <input type="file" id="character-image-input" accept="image/*" style="display: none;">
        </div>
        <div id="dice-container">
            <label>Role seu dado:</label>
            <div id="dice-roll">-</div>
            <div id="dice-result"></div>
        </div>

        <div id="ficha-content">
            <!-- Informações Básicas -->
            <section id="informacoes-basicas">
                <h2>Informações Básicas</h2>
                <label for="nome-personagem">Nome do Personagem:</label>
                <input type="text" id="nome-personagem" placeholder="Digite o nome do seu personagem">
                <label for="descricao-personagem">Descrição do Personagem:</label>
                <textarea id="descricao-personagem" placeholder="Digite a descrição do seu personagem"></textarea>
            </section>

            <!-- Recursos -->
            <section id="recursos">
                <h2>Recursos</h2>
                <div class="vida-magia-vigor">
                    <div class="atributo-container vida">
                        <h3>Vida</h3>
                        <div class="valor-total medieval-box">
                            <span>Vida Total: </span><span id="vida-total" readonly>50</span>
                        </div>
                        <div class="valor-atual medieval-box">
                            <span>Vida Atual: </span>
                            <button onclick="diminuirVida()" title="Diminuir Vida">▼</button>
                            <span id="vida-atual">50</span>
                            <button onclick="aumentarVida()" title="Aumentar Vida">▲</button>
                        </div>
                        <div class="regeneracao">
                            <span>Regeneração por turno: <span id="regeneracao-vida">0</span> (parado)</span>
                        </div>
                    </div>
                    <div class="atributo-container magia">
                        <h3>Magia</h3>
                        <div class="valor-total medieval-box">
                            <span>Magia Total: </span><span id="magia-total" readonly>20</span>
                        </div>
                        <div class="valor-atual medieval-box">
                            <span>Magia Atual: </span>
                            <button onclick="diminuirMagia()" title="Diminuir Magia">▼</button>
                            <span id="magia-atual">20</span>
                            <button onclick="aumentarMagia()" title="Aumentar Magia">▲</button>
                        </div>
                        <div class="regeneracao">
                            <span>Regeneração por turno: <span id="regeneracao-magia">0</span></span>
                        </div>
                    </div>
                    <div class="atributo-container vigor">
                        <h3>Vigor</h3>
                        <div class="valor-total medieval-box">
                            <span>Vigor Total: </span><span id="vigor-total" readonly>10</span>
                        </div>
                        <div class="valor-atual medieval-box">
                            <span>Vigor Atual: </span>
                            <button onclick="diminuirVigor()" title="Diminuir Vigor">▼</button>
                            <span id="vigor-atual">10</span>
                            <button onclick="aumentarVigor()" title="Aumentar Vigor">▲</button>
                        </div>
                        <div class="regeneracao">
                            <span>Regeneração por turno: <span id="regeneracao-vigor">0</span> (parado)</span>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Atributos -->
            <section id="atributos">
                <h2>Atributos</h2>
                <div class="atributos-container">
                    <div class="atributos-coluna">
                        <div class="atributo"><label for="forca">Força:</label><input type="number" id="forca" value="0" min="0"></div>
                        <div class="atributo"><label for="destreza">Destreza:</label><input type="number" id="destreza" value="0" min="0"></div>
                        <div class="atributo"><label for="agilidade">Agilidade:</label><input type="number" id="agilidade" value="0" min="0"></div>
                        <div class="atributo"><label for="constituicao">Constituição:</label><input type="number" id="constituicao" value="0" min="0"></div>
                        <div class="atributo"><label for="inteligencia">Inteligência:</label><input type="number" id="inteligencia" value="0" min="0"></div>
                    </div>
                    <div class="atributos-coluna-destaque">
                        <div class="atributo-destaque"><label>Ataque:</label><span id="ataque" readonly>0</span></div>
                        <div class="atributo-destaque"><label>Ataque Mágico:</label><span id="ataque-magico" readonly>0</span></div>
                        <div class="atributo-destaque"><label>Acerto:</label><span id="acerto" readonly>0</span></div>
                        <div class="atributo-destaque"><label>Esquiva:</label><span id="esquiva" readonly>0</span></div>
                        <div class="atributo-destaque"><label>RDF:</label><span id="rdf" readonly>0</span></div>
                        <div class="atributo-destaque"><label>RDM:</label><span id="rdm" readonly>0</span></div>
                    </div>
                </div>
            </section>

            <!-- Combate -->
            <section id="combate">
                <h2>Combate</h2>
                <div class="armamento-container">
                    <div class="armamento-coluna">
                        <label>Armamento Mão Direita:</label>
                        <div class="flex items-center mb-2">
                            <input type="text" id="arma-direita-nome" placeholder="Nome da Arma" class="mr-2">
                            <span>Ataque </span><input type="number" id="arma-direita-ataque" value="0" class="w-20 mr-2">
                            <span>Ataque Mágico </span><input type="number" id="arma-direita-ataque-magico" value="0" class="w-20">
                        </div>
                    </div>
                    <div class="armamento-coluna">
                        <label>Armamento Mão Esquerda:</label>
                        <div class="flex items-center">
                            <input type="text" id="arma-esquerda-nome" placeholder="Nome da Arma" class="mr-2">
                            <span>Ataque </span><input type="number" id="arma-esquerda-ataque" value="0" class="w-20 mr-2">
                            <span>Ataque Mágico </span><input type="number" id="arma-esquerda-ataque-magico" value="0" class="w-20">
                        </div>
                    </div>
                </div>
            </section>

            <!-- Inventário e Habilidades -->
            <section id="inventario-habilidades">
                <h2>Inventário e Habilidades</h2>
                <div class="flex gap-20">
                    <div style="width: 50%;">
                        <label>Inventário (Peso Total: <span id="peso-total">0</span> kg):</label>
                        <div id="inventario-slots">
                            <!-- 10 slots iniciais -->
                            <div class="inventory-slot"><input type="text" placeholder="Item" class="inventory-item"><input type="number" min="0" value="0" class="inventory-weight" title="Peso em kg"></div>
                            <div class="inventory-slot"><input type="text" placeholder="Item" class="inventory-item"><input type="number" min="0" value="0" class="inventory-weight"></div>
                            <div class="inventory-slot"><input type="text" placeholder="Item" class="inventory-item"><input type="number" min="0" value="0" class="inventory-weight"></div>
                            <div class="inventory-slot"><input type="text" placeholder="Item" class="inventory-item"><input type="number" min="0" value="0" class="inventory-weight"></div>
                            <div class="inventory-slot"><input type="text" placeholder="Item" class="inventory-item"><input type="number" min="0" value="0" class="inventory-weight"></div>
                            <div class="inventory-slot"><input type="text" placeholder="Item" class="inventory-item"><input type="number" min="0" value="0" class="inventory-weight"></div>
                            <div class="inventory-slot"><input type="text" placeholder="Item" class="inventory-item"><input type="number" min="0" value="0" class="inventory-weight"></div>
                            <div class="inventory-slot"><input type="text" placeholder="Item" class="inventory-item"><input type="number" min="0" value="0" class="inventory-weight"></div>
                            <div class="inventory-slot"><input type="text" placeholder="Item" class="inventory-item"><input type="number" min="0" value="0" class="inventory-weight"></div>
                            <div class="inventory-slot"><input type="text" placeholder="Item" class="inventory-item"><input type="number" min="0" value="0" class="inventory-weight"></div>
                        </div>
                    </div>
                    <div style="width: 50%;">
                        <label>Magias e Habilidades:</label>
                        <div id="magias-list"></div>
                    </div>
                </div>
            </section>

            <!-- Botões -->
            <div class="botoes-container">
                <button id="reset-pontos" class="botao botao-reset">Reiniciar Pontos</button>
                <button id="recomecar" class="botao botao-recomecar">Recomeçar</button>
                <button id="bloquear-ficha" class="botao botao-bloquear">Bloquear Ficha</button>
            </div>
        </div>
    </div>

    <div id="nome-ficha-modal" class="modal">
        <div class="modal-content">
            <h3>Dê um Nome à Ficha</h3>
            <input type="text" id="nome-ficha-input" placeholder="Nome da ficha" maxlength="20">
            <button class="confirm-btn" onclick="criarNovaFicha()">Confirmar</button>
            <button class="cancel-btn" onclick="fecharModal('nome-ficha-modal')">Cancelar</button>
        </div>
    </div>

    <div id="bloquear-ficha-modal" class="modal">
        <div class="modal-content">
            <h3>Ponha sua Senha de 4 Dígitos</h3>
            <input type="password" id="senha-bloqueio-input" placeholder="Senha (4 dígitos)" maxlength="4">
            <button class="confirm-btn" onclick="bloquearFicha()">Confirmar</button>
            <button class="cancel-btn" onclick="fecharModal('bloquear-ficha-modal')">Cancelar</button>
        </div>
    </div>

    <div id="password-modal" class="modal">
        <div class="modal-content">
            <h3>Digite sua Senha</h3>
            <input type="password" id="senha-desbloqueio-input" placeholder="Senha (4 dígitos)" maxlength="4">
            <button class="confirm-btn" onclick="desbloquearFicha()">Confirmar</button>
            <button class="cancel-btn" onclick="fecharModal('password-modal')">Cancelar</button>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "Sua_API_Key",
            authDomain: "Seu_Dominio.firebaseapp.com",
            databaseURL: "https://Seu_Database_URL.firebaseio.com",
            projectId: "Seu_Project_ID",
            storageBucket: "Seu_Storage_Bucket.appspot.com",
            messagingSenderId: "Seu_Sender_ID",
            appId: "Seu_App_ID"
        };

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        let fichas = {};
        let currentFichaId = null;
        let isFichaLocked = false;
        let fichaPassword = null;

        // Elementos DOM
        const nomePersonagemInput = document.getElementById('nome-personagem');
        const descricaoPersonagemInput = document.getElementById('descricao-personagem');
        const forcaInput = document.getElementById('forca');
        const destrezaInput = document.getElementById('destreza');
        const agilidadeInput = document.getElementById('agilidade');
        const constituicaoInput = document.getElementById('constituicao');
        const inteligenciaInput = document.getElementById('inteligencia');
        const ataqueSpan = document.getElementById('ataque');
        const ataqueMagicoSpan = document.getElementById('ataque-magico');
        const acertoSpan = document.getElementById('acerto');
        const esquivaSpan = document.getElementById('esquiva');
        const rdfSpan = document.getElementById('rdf');
        const rdmSpan = document.getElementById('rdm');
        const armaDireitaNomeInput = document.getElementById('arma-direita-nome');
        const armaDireitaAtaqueInput = document.getElementById('arma-direita-ataque');
        const armaDireitaAtaqueMagicoInput = document.getElementById('arma-direita-ataque-magico');
        const armaEsquerdaNomeInput = document.getElementById('arma-esquerda-nome');
        const armaEsquerdaAtaqueInput = document.getElementById('arma-esquerda-ataque');
        const armaEsquerdaAtaqueMagicoInput = document.getElementById('arma-esquerda-ataque-magico');
        const inventarioSlots = document.getElementById('inventario-slots');
        const pesoTotalSpan = document.getElementById('peso-total');
        const magiasList = document.getElementById('magias-list');
        const vidaTotalSpan = document.getElementById('vida-total');
        const vidaAtualSpan = document.getElementById('vida-atual');
        const magiaTotalSpan = document.getElementById('magia-total');
        const magiaAtualSpan = document.getElementById('magia-atual');
        const vigorTotalSpan = document.getElementById('vigor-total');
        const vigorAtualSpan = document.getElementById('vigor-atual');

        // Inicialização
        function criarFichaMatriz() {
            const fichaMatrizId = 'ficha-matriz';
            const fichaMatriz = {
                nomeFicha: 'Matriz',
                nomePersonagem: 'Personagem Matriz',
                descricaoPersonagem: 'Ficha original do sistema',
                forca: '0',
                destreza: '0',
                agilidade: '0',
                inteligencia: '0',
                constituicao: '0',
                armaDireitaNome: '',
                armaDireitaAtaque: '0',
                armaDireitaAtaqueMagico: '0',
                armaEsquerdaNome: '',
                armaEsquerdaAtaque: '0',
                armaEsquerdaAtaqueMagico: '0',
                inventario: Array(10).fill({ item: '', peso: '0' }),
                magiasHabilidades: '',
                vidaTotal: '50',
                vidaAtual: '50',
                magiaTotal: '20',
                magiaAtual: '20',
                vigorTotal: '10',
                vigorAtual: '10',
                isLocked: true,
                password: '777'
            };

            database.ref('fichas/ficha-matriz').once('value', (snapshot) => {
                if (!snapshot.exists()) {
                    database.ref(`fichas/${fichaMatrizId}`).set(fichaMatriz).then(() => {
                        currentFichaId = fichaMatrizId;
                        carregarFicha(fichaMatrizId);
                    });
                } else {
                    currentFichaId = fichaMatrizId;
                    carregarFicha(fichaMatrizId);
                    carregarFichas();
                }
            });
        }

        function carregarFichas() {
            database.ref('fichas').on('value', (snapshot) => {
                fichas = snapshot.val() || {};
                if (!fichas['ficha-matriz']) {
                    criarFichaMatriz();
                } else {
                    atualizarAbasFichas();
                }
            });
        }

        function atualizarAbasFichas() {
            const fichasSidebar = document.getElementById('fichas-sidebar');
            const addFichaBtn = document.getElementById('add-ficha-btn');
            while (fichasSidebar.children.length > 1) {
                fichasSidebar.removeChild(fichasSidebar.children[1]);
            }
            for (let fichaId in fichas) {
                if (fichaId !== 'ficha-matriz') {
                    const tab = document.createElement('div');
                    tab.className = 'ficha-tab';
                    const span = document.createElement('span');
                    span.textContent = fichas[fichaId].nomeFicha || 'Sem Nome';
                    tab.appendChild(span);
                    tab.dataset.fichaId = fichaId;
                    if (fichaId === currentFichaId) {
                        tab.classList.add('active');
                    }
                    tab.onclick = () => {
                        currentFichaId = fichaId;
                        carregarFicha(fichaId);
                        atualizarAbasFichas();
                    };
                    fichasSidebar.appendChild(tab);
                }
            }
            fichasSidebar.insertBefore(addFichaBtn, fichasSidebar.firstChild);
        }

        document.getElementById('add-ficha-btn').onclick = () => {
            document.getElementById('nome-ficha-modal').style.display = 'flex';
            document.getElementById('nome-ficha-input').focus();
        };

        function criarNovaFicha() {
            const nomeFicha = document.getElementById('nome-ficha-input').value.trim();
            if (!nomeFicha) {
                alert('Por favor, dê um nome à ficha!');
                return;
            }

            const fichaId = database.ref('fichas').push().key;
            const novaFicha = {
                nomeFicha: nomeFicha,
                nomePersonagem: '',
                descricaoPersonagem: '',
                forca: '0',
                destreza: '0',
                agilidade: '0',
                inteligencia: '0',
                constituicao: '0',
                armaDireitaNome: '',
                armaDireitaAtaque: '0',
                armaDireitaAtaqueMagico: '0',
                armaEsquerdaNome: '',
                armaEsquerdaAtaque: '0',
                armaEsquerdaAtaqueMagico: '0',
                inventario: Array(10).fill({ item: '', peso: '0' }),
                magiasHabilidades: '',
                vidaTotal: '50',
                vidaAtual: '50',
                magiaTotal: '20',
                magiaAtual: '20',
                vigorTotal: '10',
                vigorAtual: '10',
                isLocked: false,
                password: null
            };

            database.ref(`fichas/${fichaId}`).set(novaFicha).then(() => {
                currentFichaId = fichaId;
                carregarFicha(fichaId);
                fecharModal('nome-ficha-modal');
                atualizarAbasFichas();
            }).catch((error) => {
                console.error('Erro ao criar nova ficha:', error);
            });
        }

        function fecharModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function carregarFicha(fichaId) {
            if (!fichas[fichaId]) return;

            const ficha = fichas[fichaId];
            nomePersonagemInput.value = ficha.nomePersonagem || '';
            descricaoPersonagemInput.value = ficha.descricaoPersonagem || '';
            forcaInput.value = ficha.forca || '0';
            destrezaInput.value = ficha.destreza || '0';
            agilidadeInput.value = ficha.agilidade || '0';
            inteligenciaInput.value = ficha.inteligencia || '0';
            constituicaoInput.value = ficha.constituicao || '0';
            armaDireitaNomeInput.value = ficha.armaDireitaNome || '';
            armaDireitaAtaqueInput.value = ficha.armaDireitaAtaque || '0';
            armaDireitaAtaqueMagicoInput.value = ficha.armaDireitaAtaqueMagico || '0';
            armaEsquerdaNomeInput.value = ficha.armaEsquerdaNome || '';
            armaEsquerdaAtaqueInput.value = ficha.armaEsquerdaAtaque || '0';
            armaEsquerdaAtaqueMagicoInput.value = ficha.armaEsquerdaAtaqueMagico || '0';
            vidaTotalSpan.textContent = ficha.vidaTotal || '50';
            vidaAtualSpan.textContent = ficha.vidaAtual || '50';
            magiaTotalSpan.textContent = ficha.magiaTotal || '20';
            magiaAtualSpan.textContent = ficha.magiaAtual || '20';
            vigorTotalSpan.textContent = ficha.vigorTotal || '10';
            vigorAtualSpan.textContent = ficha.vigorAtual || '10';
            isFichaLocked = ficha.isLocked || false;
            fichaPassword = ficha.password || null;

            const inventario = Array.isArray(ficha.inventario) ? ficha.inventario : Array(10).fill({ item: '', peso: '0' });
            const slots = inventarioSlots.querySelectorAll('.inventory-slot');
            slots.forEach((slot, index) => {
                const itemInput = slot.querySelector('.inventory-item');
                const weightInput = slot.querySelector('.inventory-weight');
                itemInput.value = inventario[index]?.item || '';
                weightInput.value = inventario[index]?.peso || '0';
            });
            calcularPesoTotal();

            carregarMagias(ficha.magiasHabilidades);
            calcularAtributos();
        }

        function carregarMagias(magiasHabilidades) {
            magiasList.innerHTML = '';
            const magias = magiasHabilidades ? magiasHabilidades.split('\n').filter(m => m.trim()) : [];
            magias.forEach(magia => {
                const [nome, custo] = magia.split(';');
                const slot = document.createElement('div');
                slot.className = 'inventory-slot';
                slot.innerHTML = `
                    <input type="text" value="${nome || ''}" class="magia-nome">
                    <input type="number" min="0" value="${custo || '0'}" class="magia-custo" title="Custo de Mana">
                `;
                magiasList.appendChild(slot);
            });
            addMagiaSlot();
            const addButton = document.createElement('button');
            addButton.textContent = '+ Adicionar Magia';
            addButton.className = 'mt-2';
            addButton.onclick = addMagiaSlot;
            magiasList.appendChild(addButton);

            magiasList.addEventListener('change', (event) => {
                if (event.target.classList.contains('magia-nome') || event.target.classList.contains('magia-custo')) {
                    salvarMagias();
                }
            });
        }

        function addMagiaSlot() {
            const slot = document.createElement('div');
            slot.className = 'inventory-slot';
            slot.innerHTML = `
                <input type="text" placeholder="Nome da Magia" class="magia-nome">
                <input type="number" min="0" value="0" class="magia-custo" title="Custo de Mana">
            `;
            magiasList.insertBefore(slot, magiasList.querySelector('button'));
        }

        function salvarMagias() {
            const magiasSlots = magiasList.querySelectorAll('.inventory-slot');
            const magias = Array.from(magiasSlots).map(slot => {
                const nome = slot.querySelector('.magia-nome').value.trim();
                const custo = slot.querySelector('.magia-custo').value;
                return nome ? `${nome};${custo}` : '';
            }).filter(magia => magia).join('\n');
            database.ref(`fichas/${currentFichaId}/magiasHabilidades`).set(magias).catch(error => console.error('Erro ao salvar magias:', error));
        }

        function calcularPesoTotal() {
            const slots = inventarioSlots.querySelectorAll('.inventory-slot');
            let total = 0;
            slots.forEach(slot => {
                const weight = parseFloat(slot.querySelector('.inventory-weight').value) || 0;
                total += weight;
            });
            pesoTotalSpan.textContent = total.toFixed(2);
            salvarInventario();
        }

        function salvarInventario() {
            const slots = inventarioSlots.querySelectorAll('.inventory-slot');
            const inventario = Array.from(slots).map(slot => ({
                item: slot.querySelector('.inventory-item').value.trim(),
                peso: slot.querySelector('.inventory-weight').value
            }));
            database.ref(`fichas/${currentFichaId}/inventario`).set(inventario).catch(error => console.error('Erro ao salvar inventario:', error));
        }

        function calcularAtributos() {
            const forca = parseInt(forcaInput.value) || 0;
            const destreza = parseInt(destrezaInput.value) || 0;
            const agilidade = parseInt(agilidadeInput.value) || 0;
            const inteligencia = parseInt(inteligenciaInput.value) || 0;
            const constituicao = parseInt(constituicaoInput.value) || 0;
            const armaDireitaAtaque = parseInt(armaDireitaAtaqueInput.value) || 0;
            const armaDireitaAtaqueMagico = parseInt(armaDireitaAtaqueMagicoInput.value) || 0;
            const armaEsquerdaAtaque = parseInt(armaEsquerdaAtaqueInput.value) || 0;
            const armaEsquerdaAtaqueMagico = parseInt(armaEsquerdaAtaqueMagicoInput.value) || 0;

            ataqueSpan.textContent = forca + destreza + armaDireitaAtaque + armaEsquerdaAtaque;
            ataqueMagicoSpan.textContent = inteligencia + armaDireitaAtaqueMagico + armaEsquerdaAtaqueMagico;
            acertoSpan.textContent = destreza + agilidade;
            esquivaSpan.textContent = agilidade;
            rdfSpan.textContent = forca + constituicao;
            rdmSpan.textContent = inteligencia;

            vidaTotalSpan.textContent = 50 + constituicao * 10;
            magiaTotalSpan.textContent = 20 + inteligencia * 5;
            vigorTotalSpan.textContent = 10 + constituicao * 2;

            salvarFicha();
        }

        function salvarFicha() {
            if (!currentFichaId || isFichaLocked) return;

            const fichaAtualizada = {
                nomePersonagem: nomePersonagemInput.value,
                descricaoPersonagem: descricaoPersonagemInput.value,
                forca: forcaInput.value,
                destreza: destrezaInput.value,
                agilidade: agilidadeInput.value,
                inteligencia: inteligenciaInput.value,
                constituicao: constituicaoInput.value,
                armaDireitaNome: armaDireitaNomeInput.value,
                armaDireitaAtaque: armaDireitaAtaqueInput.value,
                armaDireitaAtaqueMagico: armaDireitaAtaqueMagicoInput.value,
                armaEsquerdaNome: armaEsquerdaNomeInput.value,
                armaEsquerdaAtaque: armaEsquerdaAtaqueInput.value,
                armaEsquerdaAtaqueMagico: armaEsquerdaAtaqueMagicoInput.value,
                vidaTotal: vidaTotalSpan.textContent,
                vidaAtual: vidaAtualSpan.textContent,
                magiaTotal: magiaTotalSpan.textContent,
                magiaAtual: magiaAtualSpan.textContent,
                vigorTotal: vigorTotalSpan.textContent,
                vigorAtual: vigorAtualSpan.textContent
            };

            database.ref(`fichas/${currentFichaId}`).update(fichaAtualizada).catch(error => console.error('Erro ao salvar ficha:', error));
        }

        function diminuirVida() {
            let atual = parseInt(vidaAtualSpan.textContent);
            if (atual > 0) {
                vidaAtualSpan.textContent = atual - 1;
                salvarFicha();
            }
        }

        function aumentarVida() {
            let atual = parseInt(vidaAtualSpan.textContent);
            let total = parseInt(vidaTotalSpan.textContent);
            if (atual < total) {
                vidaAtualSpan.textContent = atual + 1;
                salvarFicha();
            }
        }

        function diminuirMagia() {
            let atual = parseInt(magiaAtualSpan.textContent);
            if (atual > 0) {
                magiaAtualSpan.textContent = atual - 1;
                salvarFicha();
            }
        }

        function aumentarMagia() {
            let atual = parseInt(magiaAtualSpan.textContent);
            let total = parseInt(magiaTotalSpan.textContent);
            if (atual < total) {
                magiaAtualSpan.textContent = atual + 1;
                salvarFicha();
            }
        }

        function diminuirVigor() {
            let atual = parseInt(vigorAtualSpan.textContent);
            if (atual > 0) {
                vigorAtualSpan.textContent = atual - 1;
                salvarFicha();
            }
        }

        function aumentarVigor() {
            let atual = parseInt(vigorAtualSpan.textContent);
            let total = parseInt(vigorTotalSpan.textContent);
            if (atual < total) {
                vigorAtualSpan.textContent = atual + 1;
                salvarFicha();
            }
        }

        function bloquearFicha() {
            const senha = document.getElementById('senha-bloqueio-input').value;
            if (senha.length !== 4 || isNaN(senha)) {
                alert('A senha deve ter 4 dígitos numéricos!');
                return;
            }
            isFichaLocked = true;
            fichaPassword = senha;
            database.ref(`fichas/${currentFichaId}`).update({ isLocked: true, password: senha });
            fecharModal('bloquear-ficha-modal');
        }

        function desbloquearFicha() {
            const senha = document.getElementById('senha-desbloqueio-input').value;
            if (senha === fichaPassword) {
                isFichaLocked = false;
                fecharModal('password-modal');
            } else {
                alert('Senha incorreta!');
            }
        }

        document.getElementById('bloquear-ficha').onclick = () => {
            if (!isFichaLocked) {
                document.getElementById('bloquear-ficha-modal').style.display = 'flex';
            } else {
                document.getElementById('password-modal').style.display = 'flex';
            }
        };

        // Eventos
        [nomePersonagemInput, descricaoPersonagemInput, armaDireitaNomeInput, armaDireitaAtaqueInput, armaDireitaAtaqueMagicoInput,
         armaEsquerdaNomeInput, armaEsquerdaAtaqueInput, armaEsquerdaAtaqueMagicoInput].forEach(input => {
            input.addEventListener('change', salvarFicha);
        });

        [forcaInput, destrezaInput, agilidadeInput, inteligenciaInput, constituicaoInput].forEach(input => {
            input.addEventListener('input', calcularAtributos);
        });

        inventarioSlots.addEventListener('change', calcularPesoTotal);

        // Iniciar
        carregarFichas();
    </script>
</body>
</html>
