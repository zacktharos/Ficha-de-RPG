[source: 1] <!DOCTYPE html>
 <html lang="pt-br">
 <head>
     <meta charset="UTF-8">
     <meta name="viewport" content="width=device-width, initial-scale=1.0">
     <title>Ficha de Personagem RPG</title>
     <link href="https://fonts.googleapis.com/css2?family=MedievalSharp&family=Inter:wght@400;600&display=swap" rel="stylesheet">
     <script src="https://unpkg.com/@tailwindcss/browser@4"></script>
     <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
     <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
     <style>
         body {
             font-family: 'Inter', sans-serif;
 [source: 2] background-color: #f0e6d2; /* Cor de pergaminho padrão */
             color: #000;
 [source: 3] display: flex;
             min-height: 100vh;
             margin: 0;
             padding: 20px;
             background-image: none;
             background-size: cover; /* Garante que cubra inicialmente */
             background-position: center;
             background-attachment: fixed; /* <<< ADICIONADO: Fixa o background */
             transition: background 0.3s, color 0.3s;
 [source: 4] }
         body.dark-mode {
             background-color: #121212 !important;
 [source: 5] /* Garante que o fundo seja sempre escuro */
             color: #e0e0e0;
 [source: 6] }
         #chat-btn-container { position: fixed; left: 10px; top: calc(50% - 120px); z-index: 1000;
 [source: 7] }
         #chat-btn {
             padding: 15px;
 [source: 8] background: #f0e6d2;
             border: 2px solid #b8860b;
             border-radius: 8px;
             font-family: 'MedievalSharp', serif;
             font-size: 1.2rem;
             color: #000;
             cursor: pointer;
 [source: 9] transition: background-color 0.3s ease, transform 0.2s ease;
             box-shadow: 3px 3px 7px rgba(0, 0, 0, 0.3);
             z-index: 1000;
 [source: 10] }
         #chat-btn:hover { background: #a0522d; transform: translateY(-3px);
 [source: 11] }
         #chat-btn::after {
             content: attr(data-unread);
 [source: 12] position: absolute;
             top: -10px;
             right: -10px;
             background-color: red;
             color: white;
             border-radius: 50%;
             padding: 5px;
             font-size: 0.8rem;
             min-width: 20px;
             text-align: center;
 [source: 13] display: none;
         }
         #chat-btn[data-unread]:after { display: block;
 [source: 14] }
         body.dark-mode #chat-btn { background: #1e1e1e; color: #e0e0e0; border-color: #444;
 [source: 15] }
         body.dark-mode #chat-btn:hover { background: #333;
 [source: 16] }
         #fichas-sidebar {
             width: 100%;
 [source: 17] height: 60px; padding: 0; display: flex; flex-direction: row;
             align-items: center; justify-content: flex-start; position: fixed;
             top: 0; left: 0; z-index: 1000;
 [source: 18] overflow-x: auto; background: transparent;
         }
         .ficha-tab {
             visibility: visible;
 [source: 19] width: 100px; height: 50px; background: #f0e6d2;
             border: 2px solid #b8860b; border-radius: 10px 10px 0 0; margin-right: 10px;
             display: flex;
 [source: 20] align-items: center; justify-content: center; cursor: pointer;
             transition: background-color 0.3s ease, transform 0.2s ease;
 [source: 21] box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.2);
         }
         .ficha-tab:hover, .ficha-tab.active { background: #a0522d;
 [source: 22] transform: translateY(-5px); }
         .ficha-tab span {
             font-family: 'MedievalSharp', serif;
 [source: 23] color: #000; font-size: 0.9rem; text-align: center;
             max-width: 90px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
 [source: 24] }
         #add-ficha-btn {
             width: 100px;
 [source: 25] height: 50px; background: #f0e6d2; border: 2px solid #b8860b;
             border-radius: 10px 10px 0 0; margin-right: 10px; display: flex; align-items: center;
 [source: 26] justify-content: center; cursor: pointer; transition: transform 0.2s ease;
             box-shadow: 0 0 10px #ffd700, 0 0 20px #ffd700; z-index: 1001;
 [source: 27] }
         #add-ficha-btn span { font-family: 'MedievalSharp', serif; color: #000; font-size: 0.9rem;
 [source: 28] }
         #add-ficha-btn:hover { background: #a0522d; transform: translateY(-5px);
 [source: 29] }
         #ficha-container {
             background: rgba(240, 230, 210, 0.95);
 [source: 30] padding: 30px; border-radius: 12px;
             box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2); width: 95%; max-width: 1200px;
             margin: 80px auto 20px; /* Ajustado para dar espaço para as abas */
 [source: 31] border: 2px solid #b8860b; position: relative; z-index: 1; /* Garante que o conteúdo fique sobre o body */
         }
         body.dark-mode #ficha-container { background: rgba(30, 30, 30, 0.95);
 [source: 32] color: #e0e0e0; }
         #ficha-container.aura-azul { box-shadow: 0 0 30px 15px #00BFFF;
 [source: 33] animation: pulsar-aura 2s infinite; }
         @keyframes pulsar-aura {
             0% { box-shadow: 0 0 20px #00BFFF, 0 0 30px #00BFFF, 0 0 40px #00BFFF;
 [source: 34] }
             50% { box-shadow: 0 0 30px #00BFFF, 0 0 50px #00BFFF, 0 0 60px #00BFFF;
 [source: 35] }
             100% { box-shadow: 0 0 20px #00BFFF, 0 0 30px #00BFFF, 0 0 40px #00BFFF;
 [source: 36] }
         }
         h1#nome-personagem-titulo {
             font-family: 'MedievalSharp', serif;
 [source: 37] color: #1C2526; font-size: 3rem; margin-bottom: 20px;
             text-align: center; text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
 [source: 38] animation: raios 2s infinite linear;
         }
         @keyframes raios {
             0% { text-shadow: 0 0 5px #FFD700, 0 0 10px #FFD700, 0 0 15px #FFD700, 0 0 20px #FF4500;
 [source: 39] }
             50% { text-shadow: 0 0 10px #FFD700, 0 0 15px #FFD700, 0 0 20px #FF4500, 0 0 25px #FF4500;
 [source: 40] }
             100% { text-shadow: 0 0 5px #FFD700, 0 0 10px #FFD700, 0 0 15px #FFD700, 0 0 20px #FF4500;
 [source: 41] }
         }
         #game-master-message { display: none;
 [source: 42] color: blue; font-size: 1.5rem; text-align: center; font-family: 'MedievalSharp', serif; margin-bottom: 10px;
 [source: 43] }
         section { background: #f0e6d2; border: 2px solid #b8860b; border-radius: 8px; padding: 15px;
 [source: 44] margin-bottom: 20px; }
         section h2 { text-align: center;
 [source: 45] }
         body.dark-mode section { background: #1e1e1e; border-color: #444;
 [source: 46] }
         label { font-weight: 600; color: #000; margin-bottom: 8px; display: block;
 [source: 47] }
         body.dark-mode label { color: #e0e0e0;
 [source: 48] }
         input[type="text"], input[type="number"], textarea {
             padding: 10px;
 [source: 49] border: 2px solid #b8860b; border-radius: 6px; width: calc(100% - 24px);
             margin-bottom: 15px; font-size: 1rem; transition: border-color 0.3s ease;
             background: #fff;
 [source: 50] color: #000;
         }
         body.dark-mode input[type="text"], body.dark-mode input[type="number"], body.dark-mode textarea {
             background: #333;
 [source: 51] color: #e0e0e0; border-color: #555;
         }
         input[type="text"]:focus, input[type="number"]:focus, textarea:focus {
             border-color: #a0522d;
 [source: 52] outline: none; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
 [source: 53] }
         input[readonly], span[readonly] { background: #e8e8e8; border: 1px solid #ccc; cursor: not-allowed;
 [source: 54] }
         body.dark-mode input[readonly], body.dark-mode span[readonly] { background: #444; border-color: #666;
 [source: 55] }
         textarea { resize: vertical;
 [source: 56] }
         .atributos-container { display: flex; justify-content: space-between; gap: 20px;
 [source: 57] }
         .atributos-coluna, .atributos-coluna-destaque {
             width: 48%;
 [source: 58] display: flex; flex-direction: column; align-items: flex-start;
         }
         .atributos-coluna-destaque { background: #fff; padding: 10px;
 [source: 59] border-radius: 6px; border: 1px solid #b8860b; }
         body.dark-mode .atributos-coluna-destaque { background: #333;
 [source: 60] border-color: #555; }
         .atributo-destaque { padding: 8px; margin-bottom: 10px; display: flex; align-items: center;
 [source: 61] justify-content: space-between; width: 100%; }
         .atributo-destaque label { font-size: 1.1rem; font-weight: 700;
 [source: 62] color: #a0522d; }
         .atributo-destaque span { font-size: 1.2rem; font-family: 'MedievalSharp', serif; color: #000;
 [source: 63] }
         body.dark-mode .atributo-destaque span { color: #e0e0e0;
 [source: 64] }
         .atributo-fogo { animation: fogo 1.5s infinite;
 [source: 65] }
         @keyframes fogo {
             0% { text-shadow: 0 0 5px #ff4500, 0 0 10px #ff4500;
 [source: 66] }
             50% { text-shadow: 0 0 10px #ff4500, 0 0 15px #ffd700;
 [source: 67] }
             100% { text-shadow: 0 0 5px #ff4500, 0 0 10px #ff4500;
 [source: 68] }
         }
         .vida-magia-vigor { display: flex;
 [source: 69] justify-content: space-around; gap: 15px; flex-wrap: wrap; }
         .atributo-container {
             background: rgba(255, 255, 255, 0.8);
 [source: 70] padding: 12px; border-radius: 8px; border: 1px solid #b8860b;
             box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); width: 30%; min-width: 200px;
 [source: 71] text-align: center;
         }
         body.dark-mode .atributo-container { background: rgba(50, 50, 50, 0.8);
 [source: 72] }
         .atributo-container::before { font-size: 1.5rem; margin-bottom: 5px; display: block;
 [source: 73] }
         .atributo-container.vida::before { content: "❤️";
 [source: 74] }
         .atributo-container.magia::before { content: "✨";
 [source: 75] }
         .atributo-container.vigor::before { content: "⚡";
 [source: 76] }
         .medieval-box { background: #f0e6d2; border: 2px solid #b8860b; border-radius: 8px; padding: 10px;
 [source: 77] margin: 5px 0; text-align: center; }
         body.dark-mode .medieval-box { background: #1e1e1e; border-color: #444;
 [source: 78] }
         .regeneracao { font-size: 0.8rem; color: #555; margin-top: 5px;
 [source: 79] }
         body.dark-mode .regeneracao { color: #aaa;
 [source: 80] }
         button {
             background: #b8860b;
 [source: 81] color: #fff; border: none; padding: 5px 10px;
             cursor: pointer; font-size: 1.2rem; border-radius: 4px; margin: 0 5px;
             transition: background-color 0.3s ease;
 [source: 82] }
         body.dark-mode button { background: #555;
 [source: 83] }
         button:hover { background: #a0522d;
 [source: 84] }
         body.dark-mode button:hover { background: #777;
 [source: 85] }
         .botoes-container { display: flex; justify-content: center; gap: 10px; margin-top: 20px; margin-bottom: 20px;
 [source: 86] flex-wrap: wrap; /* Allow wrapping */ }
         .botao {
             padding: 12px 25px;
 [source: 87] border: none; border-radius: 6px; font-size: 1rem; cursor: pointer;
             transition: background-color 0.3s ease, transform 0.2s ease; font-family: 'MedievalSharp', serif;
             color: #fff;
 [source: 88] text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
         }
         body.dark-mode .botao { background: #555;
 [source: 89] }
         body.dark-mode .botao:hover { background: #777;
 [source: 90] }
         /* Removed individual background colors - keeping them for specific buttons */
         #reset-pontos, #recomecar, #bloquear-ficha, #plano-fundo-btn, #excluir-ficha { background-color: #800000;
 [source: 91] }
         .botao-reset:hover, .botao-recomecar:hover, .botao-bloquear:hover, .botao-desbloquear:hover, #excluir-ficha:hover {
             background: #a0522d;
 [source: 92] transform: translateY(-2px);
         }
         /* New styles for icon buttons */
         .icon-btn {
             padding: 10px;
 [source: 93] width: 44px; height: 44px;
             font-size: 1.2rem; line-height: 1; text-align: center;
 [source: 94] }
         #lua-btn { background-color: #333; color: #eee;
 [source: 95] } /* Keep specific colors */
         #sol-btn { background-color: #ffdd00; color: #333;
 [source: 96] } /* Keep specific colors */
         #cor-fundo-btn { background-color: #800000;
 [source: 97] } /* Keep specific color */

         #cor-fundo-btn-wrapper { line-height: 1; vertical-align: middle;
 [source: 98] }

         #nivel-container { text-align: center; margin-top: 10px;
 [source: 99] }
         #nivel {
             padding: 10px;
 [source: 100] background: #f0e6d2; border: 3px solid #000; border-radius: 50%;
              width: 100px; height: 100px; display: flex; align-items: center; justify-content: center;
              font-size: 3.125rem;
 [source: 101] box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.5); margin: 0 auto;
 [source: 102] }
         body.dark-mode #nivel { background: #1e1e1e; border-color: #444;
 [source: 103] }
         #nivel.aura-azul { animation: pulsar-aura 2s 10;
 [source: 104] }
         .expandable-textarea {
             height: 100px;
 [source: 105] width: 100%; background: #fff; border: 2px solid #b8860b;
              border-radius: 6px; padding: 10px; font-size: 0.9rem; transition: height 0.3s ease;
 [source: 106] }
         body.dark-mode .expandable-textarea { background: #333;
 [source: 107] }
         .expandable-textarea:focus { height: 15cm;
 [source: 108] }
         #dice-container {
             position: absolute;
 [source: 109] top: 20px; right: 20px; width: 200px; text-align: center;
              font-family: 'MedievalSharp', serif; cursor: move; z-index: 10; user-select: none;
 [source: 110] }
         #dice-container label { font-size: 1.2rem; color: #000; display: flex; align-items: center;
 [source: 111] justify-content: center; margin-bottom: 10px; }
         body.dark-mode #dice-container label { color: #e0e0e0;
 [source: 112] }
         #dice-container label::before { content: "🎲"; margin-right: 5px; font-size: 1.5rem;
 [source: 113] }
         #dice-roll {
             width: 100px;
 [source: 114] height: 100px; background: #f0e6d2; border: 2px solid #b8860b; border-radius: 10px;
              display: flex; align-items: center; justify-content: center; font-size: 2rem; cursor: pointer;
 [source: 115] margin: 0 auto; position: relative; transition: all 0.3s ease;
         }
         body.dark-mode #dice-roll { background: #1e1e1e;
 [source: 116] border-color: #444; }
         #dice-roll::before { content: "⚅"; font-size: 1.5rem; position: absolute; top: 5px;
 [source: 117] right: 5px; color: #a0522d; }
         #dice-result { margin-top: 10px; font-size: 1rem; color: #000;
 [source: 118] display: none; animation: blink 1s infinite; }
         body.dark-mode #dice-result { color: #e0e0e0;
 [source: 119] }
         @keyframes blink { 50% { opacity: 0;
 [source: 120] } }
         #dice-roll.critical-failure { animation: aura-vermelha 2s infinite;
 [source: 121] }
         #dice-roll.critical-success { animation: aura-verde 2s infinite;
 [source: 122] }
         @keyframes aura-vermelha {
             0% { box-shadow: 0 0 5px #ff0000, 0 0 10px #ff0000;
 [source: 123] }
             50% { box-shadow: 0 0 15px #ff0000, 0 0 20px #ff0000;
 [source: 124] }
             100% { box-shadow: 0 0 5px #ff0000, 0 0 10px #ff0000;
 [source: 125] }
         }
         @keyframes aura-verde {
             0% { box-shadow: 0 0 5px #00ff00, 0 0 10px #00ff00;
 [source: 126] }
             50% { box-shadow: 0 0 15px #00ff00, 0 0 20px #00ff00;
 [source: 127] }
             100% { box-shadow: 0 0 5px #00ff00, 0 0 10px #00ff00;
 [source: 128] }
         }
         #notification {
             position: fixed;
 [source: 129] top: 50%; left: 50%; transform: translate(-50%, -50%); padding: 20px;
              border-radius: 8px; font-family: 'MedievalSharp', serif; font-size: 1.5rem; color: #fff;
 [source: 130] text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5); display: none; z-index: 100;
              background: rgba(0, 0, 0, 0.7);
 [source: 131] transition: opacity 0.3s ease;
         }
         #notification.critical-failure { background: rgba(255, 0, 0, 0.8);
 [source: 132] animation: aura-vermelha 2s infinite; }
         #notification.critical-success { background: rgba(0, 255, 0, 0.8);
 [source: 133] animation: aura-verde 2s infinite; }
         #notification.normal-result, #notification.save-success { animation: blink 1s infinite;
 [source: 134] }
         #notification.save-success { background: rgba(0, 200, 0, 0.8);
 [source: 135] }
         #character-image-container {
             position: absolute;
 [source: 136] top: 10px; left: 10px; width: 100px; height: 100px; background: #f0e6d2;
              border: 2px solid #b8860b; border-radius: 8px; display: flex; align-items: center;
 [source: 137] justify-content: center; cursor: pointer; overflow: hidden; z-index: 10;
         }
         body.dark-mode #character-image-container { background: #1e1e1e;
 [source: 138] }
         #character-image { width: 100%; height: 100%; object-fit: cover; display: none;
 [source: 139] }
         #character-image-container:hover { box-shadow: 0 0 10px #ffd700;
 [source: 140] }
         .modal {
             display: none;
 [source: 141] position: fixed; top: 0; left: 0; width: 100%; height: 100%;
              background: rgba(0, 0, 0, 0.5); justify-content: center; align-items: center;
 [source: 142] z-index: 1000;
         }
         .modal-content {
             background: #f0e6d2;
 [source: 143] padding: 20px; border-radius: 8px; border: 2px solid #b8860b;
              box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3); width: 300px; text-align: center;
 [source: 144] }
         body.dark-mode .modal-content { background: #1e1e1e; border-color: #444;
 [source: 145] }
         .modal-content h3 { font-family: 'MedievalSharp', serif; color: #000; margin-bottom: 15px;
 [source: 146] }
         body.dark-mode .modal-content h3 { color: #e0e0e0;
 [source: 147] }
         .modal-content input { width: calc(100% - 20px); padding: 10px; margin-bottom: 15px;
 [source: 148] border: 1px solid #ccc; border-radius: 6px; }
         body.dark-mode .modal-content input { background: #333;
 [source: 149] color: #e0e0e0; border-color: #555; }
         .modal-content button {
             padding: 10px 20px;
 [source: 150] border: none; border-radius: 6px; font-family: 'MedievalSharp', serif;
              color: #fff; cursor: pointer; margin: 0 5px;
 [source: 151] }
         .modal-content .confirm-btn { background: #b8860b;
 [source: 152] }
         .modal-content .confirm-btn:hover { background: #a0522d;
 [source: 153] }
         .modal-content .cancel-btn { background: #a52a2a;
 [source: 154] }
         .modal-content .cancel-btn:hover { background: #8b0000;
 [source: 155] }
         #vantagens-desvantagens-btn, #racas-btn, #classes-btn {
             padding: 10px 20px;
 [source: 156] background: #f0e6d2; border: 2px solid #b8860b; border-radius: 6px;
              font-family: 'MedievalSharp', serif; font-size: 1rem; color: #000; cursor: pointer;
 [source: 157] transition: background-color 0.3s ease; z-index: 10;
         }
         body.dark-mode #vantagens-desvantagens-btn, body.dark-mode #racas-btn, body.dark-mode #classes-btn {
             background: #1e1e1e;
 [source: 158] color: #e0e0e0;
         }
         #vantagens-desvantagens-btn:hover, #racas-btn:hover, #classes-btn:hover { background: #a0522d; color: #fff;
 [source: 159] }
         #vantagens-desvantagens-panel, #racas-panel, #classes-panel {
             display: none;
 [source: 160] position: fixed; top: 0; left: 0; width: 100%; height: 100%;
              background: rgba(240, 230, 210, 0.95); padding: 20px; overflow-y: auto;
 [source: 161] z-index: 999;
              border: 2px solid #b8860b; box-shadow: 0 0 20px rgba(0, 0, 0, 0.3);
 [source: 162] }
         body.dark-mode #vantagens-desvantagens-panel, body.dark-mode #racas-panel, body.dark-mode #classes-panel {
             background: rgba(30, 30, 30, 0.95);
 [source: 163] }
         #vantagens-desvantagens-panel h2, #racas-panel h2, #classes-panel h2 {
             font-family: 'MedievalSharp', serif;
 [source: 164] font-size: 2rem; text-align: center;
              color: #a0522d; margin-bottom: 20px;
         }
         #racas-panel h2 { font-size: 3rem;
 [source: 165] }
         .vantagem-item, .desvantagem-item, .raca-item {
             padding: 10px;
 [source: 166] margin: 5px 0; background: #fff; border: 1px solid #ccc;
              border-radius: 6px; cursor: pointer; transition: background-color 0.3s ease;
 [source: 167] }
         body.dark-mode .vantagem-item, body.dark-mode .desvantagem-item, body.dark-mode .raca-item {
             background: #333;
 [source: 168] border-color: #555;
         }
         .vantagem-item:hover, .desvantagem-item:hover, .raca-item:hover { background: #f0e6d2;
 [source: 169] }
         body.dark-mode .vantagem-item:hover, body.dark-mode .desvantagem-item:hover, body.dark-mode .raca-item:hover { background: #444;
 [source: 170] }
         .vantagem-item.comprada, .raca-item.comprada { background: #ffcccc; color: #f00; cursor: default;
 [source: 171] }
         .desvantagem-item.comprada { background: #ccffcc; color: #080; cursor: default;
 [source: 172] }
         #salvar-vantagens-btn, #salvar-racas-btn, #fechar-pagina-btn, #fechar-racas-btn, #fechar-classes-btn {
             position: fixed;
 [source: 173] bottom: 20px; padding: 12px 25px; background: #a52a2a; color: #fff;
              border: none; border-radius: 6px; font-family: 'MedievalSharp', serif; font-size: 1.2rem;
              cursor: pointer;
 [source: 174] transition: transform 0.2s ease;
         }
         #salvar-vantagens-btn, #salvar-racas-btn { right: 250px;
 [source: 175] animation: aura-verde-btn 2s infinite; display: none; background: #000; }
         #fechar-pagina-btn, #fechar-racas-btn, #fechar-classes-btn { right: 20px;
 [source: 176] }
         #salvar-vantagens-btn:hover, #salvar-racas-btn:hover, #fechar-pagina-btn:hover, #fechar-racas-btn:hover, #fechar-classes-btn:hover {
             transform: translateY(-2px);
 [source: 177] }
         @keyframes aura-verde-btn {
             0% { box-shadow: 0 0 5px #00ff00, 0 0 10px #00ff00;
 [source: 178] }
             50% { box-shadow: 0 0 15px #00ff00, 0 0 20px #00ff00;
 [source: 179] }
             100% { box-shadow: 0 0 5px #00ff00, 0 0 10px #00ff00;
 [source: 180] }
         }
         .locomotion-container { background: #8B4513;
 [source: 181] border: 3px solid #FFD700; border-radius: 10px; padding: 15px; color: #FFD700; font-family: 'MedievalSharp', serif;
 [source: 182] }
         .locomotion-item { display: flex; align-items: center; margin-bottom: 10px;
 [source: 183] }
         .locomotion-item label { font-weight: bold; color: #FFD700;
 [source: 184] }
         .locomotion-item span { font-size: 1.2rem; color: #FFF; text-shadow: 1px 1px 2px #000;
 [source: 185] margin-left: 5px; font-weight: bold; }
         #distancia-pulo, #altura-pulo, #velocidade-corrida { background-color: #8B4513; border-color: #8B4513;
 [source: 186] }
         .list-display { background: #fff; border: 2px solid #b8860b; border-radius: 6px; padding: 10px;
 [source: 187] min-height: 100px; max-height: 200px; overflow-y: auto; }
         body.dark-mode .list-display { background: #333;
 [source: 188] border-color: #555; }
         .list-item { cursor: pointer; margin-bottom: 5px; padding: 5px;
 [source: 189] border-bottom: 1px solid #ccc; }
         body.dark-mode .list-item { border-color: #555;
 [source: 190] }
         .list-item:hover { background: #e0e0e0;
 [source: 191] }
         body.dark-mode .list-item:hover { background: #444;
 [source: 192] }
         .inventory-slot { display: flex; align-items: center; margin-bottom: 10px;
 [source: 193] }
         .inventory-slot input[type="text"] { flex-grow: 1; margin-right: 10px;
 [source: 194] }
         .inventory-slot input[type="number"] { width: 60px;
 [source: 195] }
         #anotacoes-btn {
             position: fixed;
 [source: 196] left: 10px; top: 50%; transform: translateY(-50%); padding: 10px 20px;
              background: #f0e6d2; border: 2px solid #b8860b; border-radius: 6px;
              font-family: 'MedievalSharp', serif;
 [source: 197] font-size: 1rem; color: #000; cursor: pointer;
              transition: background-color 0.3s ease; z-index: 1000;
 [source: 198] }
         body.dark-mode #anotacoes-btn { background: #1e1e1e; color: #e0e0e0;
 [source: 199] }
         #anotacoes-btn:hover, #historico-dados-btn:hover { background: #a0522d; color: #fff;
 [source: 200] }
         #anotacoes-textarea {
             display: none;
 [source: 201] position: fixed; left: 60px; top: 50%; transform: translateY(-50%);
              width: 400px; height: 400px; background: #fff; border: 2px solid #b8860b;
              border-radius: 6px;
 [source: 202] padding: 10px; font-size: 0.9rem; resize: none; z-index: 1001;
         }
         body.dark-mode #anotacoes-textarea { background: #333;
 [source: 203] color: #e0e0e0; }
         #historico-dados-btn {
             position: fixed;
 [source: 204] right: 10px; top: 50%; transform: translateY(-50%); padding: 10px 20px;
              background: #f0e6d2; border: 2px solid #b8860b; border-radius: 6px;
              font-family: 'MedievalSharp', serif;
 [source: 205] font-size: 1rem; color: #000; cursor: pointer;
              transition: background-color 0.3s ease;
 [source: 206] }
         body.dark-mode #historico-dados-btn { background: #1e1e1e; color: #e0e0e0;
 [source: 207] }
         #historico-dados-panel {
             display: none;
 [source: 208] position: fixed; right: 10px; top: 50%; transform: translateY(-50%);
              width: 300px; background: #fff; border: 2px solid #b8860b; border-radius: 6px;
              padding: 10px;
 [source: 209] max-height: 400px; overflow-y: auto;
         }
         body.dark-mode #historico-dados-panel { background: #333; border-color: #555;
 [source: 210] }
         #historico-dados-panel h3 { font-family: 'MedievalSharp', serif; color: #000; margin-bottom: 10px;
 [source: 211] }
         body.dark-mode #historico-dados-panel h3 { color: #e0e0e0;
 [source: 212] }
         #historico-lista div { padding: 5px; border-bottom: 1px solid #ccc;
 [source: 213] }
         body.dark-mode #historico-lista div { border-color: #555;
 [source: 214] }
         #excluir-historico-btn { background: #a52a2a; color: #fff; padding: 8px 16px; border-radius: 6px;
 [source: 215] cursor: pointer; margin-top: 10px; }
         #excluir-historico-btn:hover { background: #8b0000;
 [source: 216] }
         .magias-container { max-height: 300px; overflow-y: auto; border: 2px solid #b8860b; border-radius: 6px;
 [source: 217] padding: 10px; background: #fff; }
         body.dark-mode .magias-container { background: #333; border-color: #555;
 [source: 218] }
         .magias-container input { margin-bottom: 10px;
 [source: 219] }
         #adicionar-magia-btn { background: #b8860b; color: #fff; padding: 8px 16px; border-radius: 6px;
 [source: 220] cursor: pointer; display: block; margin-top: 10px; }
         #adicionar-magia-btn:hover { background: #a0522d;
 [source: 221] }
         .classe-raca-container { background: #f0e6d2; border: 2px solid #b8860b; padding: 10px; border-radius: 6px;
 [source: 222] margin-top: 10px; }
         body.dark-mode .classe-raca-container { background: #1e1e1e; border-color: #444;
 [source: 223] }
         .classe-raca-container label { font-family: 'MedievalSharp', serif; color: #a0522d; font-size: 1.2rem;
 [source: 224] }
         .classe-raca-container span[onclick] { background: #fff; border: 2px solid #b8860b; padding: 10px;
 [source: 225] cursor: pointer; display: block; }
         body.dark-mode .classe-raca-container span[onclick] { background: #333; color: #e0e0e0;
 [source: 226] }
         .classe-raca-container textarea { width: 100%; background: #fff; border: 2px solid #b8860b;
 [source: 227] }
         body.dark-mode .classe-raca-container textarea { background: #333; color: #e0e0e0;
 [source: 228] }
         .raca-item { margin-bottom: 20px; padding: 10px; background: #fff; border: 2px solid #b8860b;
 [source: 229] border-radius: 6px; }
         .raca-item h3 { font-family: 'MedievalSharp', serif; font-size: 1.5rem; color: #a0522d;
 [source: 230] }
         .raca-item p { font-size: 1rem; color: #000;
 [source: 231] }
         body.dark-mode .raca-item { background: #333; border-color: #555;
 [source: 232] }
         body.dark-mode .raca-item p { color: #e0e0e0;
 [source: 233] }
         /* Container for theme/color buttons */
         .theme-color-container { display: flex;
 [source: 234] justify-content: center; gap: 10px; margin-top: -10px; margin-bottom: 20px; }
         #background-color-selector {
              bottom: 100%;
 [source: 235] /* Position above the button */
              left: 50%;
 [source: 236] transform: translateX(-50%);
              margin-bottom: 5px; /* Space between button and selector */
              margin-top: 0;
 [source: 237] display: none; /* Keep hidden initially */
              position: absolute;
 [source: 238] background-color: #fff; border: 1px solid #ccc; padding: 10px; border-radius: 5px; z-index: 1002; display: flex; gap: 10px;
 [source: 239] }
          /* Ensure popup display logic works */
         #background-color-selector { display: none;
 [source: 240] }

         @media (max-width: 768px) {
             body { padding: 10px;
 [source: 241] }
             #ficha-container { padding: 15px; margin-top: 70px; /* Adjust margin for sidebar */
 [source: 242] }
             h1#nome-personagem-titulo { font-size: 2rem;
 [source: 243] }
             section h2 { font-size: 1.2rem;
 [source: 244] }
             input, textarea { font-size: 0.9rem;
 [source: 245] }
             .atributos-container, .vida-magia-vigor { flex-direction: column;
 [source: 246] }
             .atributos-coluna, .atributos-coluna-destaque, .atributo-container { width: 100%;
 [source: 247] }
             .botoes-container, .theme-color-container { flex-direction: row; flex-wrap: wrap;
 [source: 248] } /* Ensure wrapping on small screens */
         }
         /* Estilos para o modal de chat */
         #chat-modal { display: none;
 [source: 249] }
         #chat-modal .modal-content { width: 500px; max-height: 80vh; display: flex; flex-direction: column;
 [source: 250] }
         #chat-modal .chat-header { padding: 10px; border-bottom: 1px solid #ccc; font-family: 'MedievalSharp', serif;
 [source: 251] font-size: 1.5rem; text-align: center; }
         #chat-modal .chat-body { flex-grow: 1; display: flex;
 [source: 252] overflow: hidden; }
         #chat-modal .user-list { width: 150px; border-right: 1px solid #ccc;
 [source: 253] overflow-y: auto; padding: 10px; }
         #chat-modal .user-list h4 { font-family: 'MedievalSharp', serif;
 [source: 254] margin-bottom: 5px; }
         #chat-modal .user-list .user-item { padding: 8px; cursor: pointer;
 [source: 255] border-bottom: 1px solid #eee; }
         #chat-modal .user-list .user-item:hover { background-color: #f0e6d2;
 [source: 256] }
         body.dark-mode #chat-modal .user-list .user-item:hover { background-color: #333;
 [source: 257] }
         #chat-modal .conversation { flex-grow: 1; padding: 10px; overflow-y: auto; display: flex;
 [source: 258] flex-direction: column; }
         #chat-modal .message-container { display: flex; flex-direction: column; margin-bottom: 8px;
 [source: 259] }
         #chat-modal .message { padding: 8px; border-radius: 5px; background-color: #e0e0e0; color: #000;
 [source: 260] width: fit-content; max-width: 80%; }
         body.dark-mode #chat-modal .message { background-color: #444; color: #e0e0e0;
 [source: 261] }
         #chat-modal .message.sent { background-color: #cce5ff; align-self: flex-end;
 [source: 262] }
         body.dark-mode #chat-modal .message.sent { background-color: #6699cc; color: #e0e0e0;
 [source: 263] }
         #chat-modal .sender-name { font-size: 0.8rem; color: #777; margin-bottom: 2px;
 [source: 264] }
         body.dark-mode #chat-modal .sender-name { color: #aaa;
 [source: 265] }
         #chat-modal .chat-input { padding: 10px; border-top: 1px solid #ccc; display: flex;
 [source: 266] }
         #chat-modal .chat-input input[type="text"] { flex-grow: 1; padding: 8px; border-radius: 5px;
 [source: 267] border: 1px solid #ccc; margin-right: 10px; }
         body.dark-mode #chat-modal .chat-input input[type="text"] { background-color: #333;
 [source: 268] color: #e0e0e0; border-color: #555; }
         #chat-modal .chat-input button { padding: 8px 15px;
 [source: 269] border-radius: 5px; }
         /* Estilos para os modais de senha do chat */
         #chat-password-modal .modal-content, #open-chat-modal .modal-content { width: 350px;
 [source: 270] }
         /* Espaçamento dos botões de raça */
         #raca-opcoes-modal .modal-content button:nth-child(2) { margin-top: 10px;
 [source: 271] }
         /* Estilos para o modal de plano de fundo */
         #background-modal { display: none;
 [source: 272] }
         #background-modal .modal-content { width: 400px; text-align: left;
 [source: 273] }
         #background-modal .modal-content label { display: block; margin-bottom: 5px;
 [source: 274] }
         #background-modal .modal-content input[type="file"] { margin-bottom: 10px;
 [source: 275] }
         /* <<< REMOVIDO: Grupo de radio buttons para tamanho */
         /* [source: 276] #background-modal .modal-content .radio-group { margin-bottom: 15px; } */
         /* [source: 277] #background-modal .modal-content .radio-group label { display: inline-block; margin-right: 10px; } */

         /* Estilos para o seletor de cor de fundo */
         .color-option { width: 24px;
 [source: 278] height: 24px; border-radius: 50%; cursor: pointer; border: 1px solid #ccc;
 [source: 279] }
     </style>
 </head>
 <body>
     <div id="chat-btn-container">
         <button id="chat-btn" data-unread="0">💬 Chat</button>
     </div>
     <div id="fichas-sidebar">
         <div id="add-ficha-btn"><span>+ Fichas</span></div>
     </div>
     <div id="ficha-container">
         <h1 id="nome-personagem-titulo">Ficha de Personagem</h1>
         <div id="game-master-message">Você virou o Game Master</div>
         <div id="character-image-container" onclick="document.getElementById('character-image-input').click()">
             <img id="character-image" alt="Imagem do Personagem">
 [source: 280] <input type="file" id="character-image-input" accept="image/*" style="display:none">
         </div>
         <div id="dice-container">
             <label>Role seu dado:</label>
             <div id="dice-roll">-</div>
             <div id="dice-result"></div>
         </div>
         <div id="ficha-content">
             
 [source: 281] <section id="informacoes-basicas">
                 <h2>Informações Básicas</h2>
                 <label for="nome-personagem">Nome do Personagem:</label>
                 <input type="text" id="nome-personagem" placeholder="Digite o nome do seu personagem">
                 <label for="descricao-personagem">Descrição do Personagem:</label>
                 <textarea id="descricao-personagem" placeholder="Digite a 
 [source: 282] descrição do seu personagem"></textarea>
             </section>
             <section id="recursos">
                 <h2>Recursos</h2>
                 <div class="vida-magia-vigor">
                     <div class="atributo-container vida">
                  
 [source: 283]        <h3>Vida</h3>
                         <div class="valor-total medieval-box">
                             <span>Vida Total: </span>
                             <span id="vida-total" readonly>50</span>
        
 [source: 284]                  </div>
                         <div class="valor-atual medieval-box">
                             <span>Vida Atual: </span>
                            
 [source: 285]  <button onclick="diminuirVida()" title="Diminuir Vida">▼</button>
                             <span id="vida-atual">50</span>
                             <button onclick="aumentarVida()" title="Aumentar Vida">▲</button>
                         </div>
             
 [source: 286]             <div class="regeneracao">
                             <span>Regeneração por turno: <span id="regeneracao-vida">0</span> (parado)</span>
                         </div>
                     </div>
           
 [source: 287]           <div class="atributo-container magia">
                         <h3>Magia</h3>
                         <div class="valor-total medieval-box">
                             <span>Magia Total: </span>
         
 [source: 288]                     <span id="magia-total" readonly>20</span>
                         </div>
                         <div class="valor-atual medieval-box">
                             
 [source: 289] <span>Magia Atual: </span>
                             <button onclick="diminuirMagia()" title="Diminuir Magia">▼</button>
                             <span id="magia-atual">20</span>
                             <button onclick="aumentarMagia()" title="Aumentar Magia">▲</button>
        
 [source: 290]                  </div>
                         <div class="regeneracao">
                             <span>Regeneração por turno: <span id="regeneracao-magia">0</span></span>
                         </div>
   
 [source: 291]                   </div>
                     <div class="atributo-container vigor">
                         <h3>Vigor</h3>
                         <div class="valor-total medieval-box">
           
 [source: 292]                   <span>Vigor Total: </span>
                             <span id="vigor-total" readonly>10</span>
                         </div>
                         <div class="valor-atual 
 [source: 293] medieval-box">
                             <span>Vigor Atual: </span>
                             <button onclick="diminuirVigor()" title="Diminuir Vigor">▼</button>
                             <span id="vigor-atual">10</span>
           
 [source: 294]                   <button onclick="aumentarVigor()" title="Aumentar Vigor">▲</button>
                         </div>
                         <div class="regeneracao">
                             <span>Regeneração por 
 [source: 295] turno: <span id="regeneracao-vigor">0</span> (parado)</span>
                         </div>
                     </div>
                 </div>
             </section>
             <section id="atributos">
             
 [source: 296]     <h2>Atributos</h2>
                 <div class="atributos-container">
                     <div class="atributos-coluna">
                         <div class="atributo">
                             <label for="forca" title="Afeta ataque e 
 [source: 297] RDF">Força:</label>
                             <input type="number" id="forca" value="0" min="0">
                         </div>
                         <div class="atributo">
                    
 [source: 298]          <label for="destreza" title="Afeta ataque e acerto">Destreza:</label>
                             <input type="number" id="destreza" value="0" min="0">
                         </div>
                         <div class="atributo">
      
 [source: 299]                        <label for="agilidade" title="Afeta esquiva e acerto">Agilidade:</label>
                             <input type="number" id="agilidade" value="0" min="0">
                         </div>
                 
 [source: 300]         <div class="atributo">
                             <label for="constituicao" title="Afeta vida, magia e vigor">Constituição:</label>
                             <input type="number" id="constituicao" value="0" min="0">
                         </div>
  
 [source: 301]                        <div class="atributo">
                             <label for="inteligencia" title="Afeta ataque mágico e RDM">Inteligência:</label>
                             <input type="number" id="inteligencia" value="0" min="0">
           
 [source: 302]               </div>
                     </div>
                     <div class="atributos-coluna-destaque">
                         <div class="atributo-destaque">
                     
 [source: 303]         <label>Ataque:</label>
                             <span id="ataque" readonly>0</span>
                         </div>
                         <div class="atributo-destaque">
              
 [source: 304]                <label>Ataque Mágico:</label>
                             <span id="ataque-magico" readonly>0</span>
                         </div>
                         <div class="atributo-destaque">
      
 [source: 305]                        <label>Acerto:</label>
                             <span id="acerto" readonly>0</span>
                         </div>
                        
 [source: 306]  <div class="atributo-destaque">
                             <label>Esquiva:</label>
                             <span id="esquiva" readonly>0</span>
                         </div>
                 
 [source: 307]         <div class="atributo-destaque">
                             <label>RDF:</label>
                             <span id="rdf" readonly>0</span>
                         </div>
          
 [source: 308]                <div class="atributo-destaque">
                             <label>RDM:</label>
                             <span id="rdm" readonly>0</span>
                         </div>
   
 [source: 309]                   </div>
                 </div>
             </section>
             <section id="combate">
                 <h2>Combate</h2>
                 <div class="armamento-container">
         
 [source: 310]             <div class="armamento-coluna">
                         <label>Armamento Mão Direita:</label>
                         <div class="flex items-center mb-2">
                             <input type="text" id="arma-direita-nome" placeholder="Nome da Arma" 
 [source: 311] class="mr-2">
                             <span>Ataque </span>
                             <input type="number" id="arma-direita-ataque" value="0" class="w-20 mr-2">
                             <span>Ataque Mágico </span>
         
 [source: 312]                     <input type="number" id="arma-direita-ataque-magico" value="0" class="w-20">
                         </div>
                     </div>
                     <div class="armamento-coluna">
            
 [source: 313]              <label>Armamento Mão Esquerda:</label>
                         <div class="flex items-center">
                             <input type="text" id="arma-esquerda-nome" placeholder="Nome da Arma" class="mr-2">
                          
 [source: 314]    <span>Ataque </span>
                             <input type="number" id="arma-esquerda-ataque" value="0" class="w-20 mr-2">
                             <span>Ataque Mágico </span>
                             <input type="number" id="arma-esquerda-ataque-magico" value="0" class="w-20">
  
 [source: 315]                        </div>
                     </div>
                 </div>
             </section>
             <section id="inventario-habilidades">
                 
 [source: 316] <h2>Inventário e Habilidades</h2>
                 <div class="flex gap-20">
                     <div style="width:50%">
                         <label>Inventário (Peso Total: <span id="peso-total">0</span> kg):</label>
                         <div id="inventario-slots">
      
 [source: 317]                        <div class="inventory-slot"><input type="text" placeholder="Item 1" class="inventory-item"><input type="number" min="0" value="0" class="inventory-weight" title="Peso em kg"></div>
                             <div class="inventory-slot"><input type="text" placeholder="Item 2" class="inventory-item"><input type="number" min="0" value="0" class="inventory-weight"></div>
                             
 [source: 318] <div class="inventory-slot"><input type="text" placeholder="Item 3" class="inventory-item"><input type="number" min="0" value="0" class="inventory-weight"></div>
                             <div class="inventory-slot"><input type="text" placeholder="Item 4" class="inventory-item"><input type="number" min="0" value="0" class="inventory-weight"></div>
                             <div class="inventory-slot"><input type="text" placeholder="Item 5" class="inventory-item"><input type="number" min="0" value="0" class="inventory-weight"></div>
                  
 [source: 319]            <div class="inventory-slot"><input type="text" placeholder="Item 6" class="inventory-item"><input type="number" min="0" value="0" class="inventory-weight"></div>
                             <div class="inventory-slot"><input type="text" placeholder="Item 7" class="inventory-item"><input type="number" min="0" value="0" class="inventory-weight"></div>
                             <div class="inventory-slot"><input type="text" placeholder="Item 8" class="inventory-item"><input type="number" min="0" value="0" class="inventory-weight"></div>
       
 [source: 320]                       <div class="inventory-slot"><input type="text" placeholder="Item 9" class="inventory-item"><input type="number" min="0" value="0" class="inventory-weight"></div>
                             <div class="inventory-slot"><input type="text" placeholder="Item 10" class="inventory-item"><input type="number" min="0" value="0" class="inventory-weight"></div>
                         </div>
         
 [source: 321]             </div>
                     <div style="width:50%">
                         <label>Magias e Habilidades:</label>
                         <div id="magias-list" class="magias-container">
                
 [source: 322]              <input type="text" placeholder="Magia/Habilidade 1" class="magia-nome">
                             <input type="text" placeholder="Magia/Habilidade 2" class="magia-nome">
                             <input type="text" placeholder="Magia/Habilidade 3" class="magia-nome">
                    
 [source: 323]          <input type="text" placeholder="Magia/Habilidade 4" class="magia-nome">
                             <input type="text" placeholder="Magia/Habilidade 5" class="magia-nome">
                             <input type="text" placeholder="Magia/Habilidade 6" class="magia-nome">
                        
 [source: 324]      <input type="text" placeholder="Magia/Habilidade 7" class="magia-nome">
                             <input type="text" placeholder="Magia/Habilidade 8" class="magia-nome">
                             <input type="text" placeholder="Magia/Habilidade 9" class="magia-nome">
                            
 [source: 325]  <input type="text" placeholder="Magia/Habilidade 10" class="magia-nome">
                         </div>
                         <button id="adicionar-magia-btn">Adicionar Magia</button>
                     </div>
                 </div>
          
 [source: 326]        <div class="mt-4">
                     <label>Vantagens:</label>
                     <div id="vantagens-list-display" class="list-display"></div>
                     <label>Desvantagens:</label>
                     <div id="desvantagens-list-display" class="list-display"></div>
         
 [source: 327]         </div>
                 <div class="classe-raca-container">
                     <label>Classe:</label>
                     <input type="text" id="classe-nome" placeholder="Nome da Classe">
                     <textarea id="classe-descricao" placeholder="Descrição da Classe" class="expandable-textarea"></textarea>
      
 [source: 328]                <label>Raça:</label>
                     <span id="raca-nome" onclick="abrirModalRaca()"></span>
                     <textarea id="raca-descricao" placeholder="Descrição da Raça" class="expandable-textarea" readonly></textarea>
                 </div>
             </section>
          
 [source: 329]    <section id="locomocao">
                 <h2>Locomoção</h2>
                 <div class="locomotion-container">
                     <div class="locomotion-item">
                         <label>Velocidade de Corrida (km/h):</label><span>🏃‍♂️</span><span id="velocidade-corrida" readonly>25</span>
              
 [source: 330]        </div>
                     <div class="locomotion-item">
                         <label>Altura do Pulo (m):</label><span>⬆️</span><span id="altura-pulo" readonly>1</span>
                     </div>
                     <div class="locomotion-item">
   
 [source: 331]                       <label>Distância do Pulo (m):</label><span>➡️</span><span id="distancia-pulo" readonly>3</span>
                     </div>
                 </div>
             </section>
             <section id="status">
             
 [source: 332]     <h2>Status</h2>
                 <div class="flex gap-20">
                     <div>
                         <label>Experiência:</label>
                         <input type="number" id="experiencia" value="0" min="0">
       
 [source: 333]                   <label>Pontos de Habilidade (PD):</label>
                         <span id="pontos-habilidade" readonly>25</span>
                         <label>Pontos de Vantagem (PH):</label>
                         <span id="pontos-vantagem" 
 [source: 334] readonly>8</span>
                     </div>
                     <div></div>
                 </div>
                 <div id="nivel-container">
                     <label>Nível:</label>
        
 [source: 335]              <span id="nivel">0</span>
                 </div>
             </section>

             <div style="display:flex;justify-content:center;gap:20px;margin-bottom:20px">
                 <button id="vantagens-desvantagens-btn">Vantagens e Desvantagens</button>
                 <button id="racas-btn">Raças 🏰</button>
         
 [source: 336]         <button id="classes-btn">Classes ⚔️</button>
             </div>

             <div class="botoes-container">
                 <button id="reset-pontos" class="botao botao-reset">Reiniciar Pontos</button>
                 <button id="recomecar" class="botao botao-recomecar">Recomeçar</button>
                 <button id="bloquear-ficha" class="botao botao-bloquear">Bloquear Ficha</button>
       
 [source: 337]           <button id="plano-fundo-btn" class="botao">Plano de fundo</button>
                 <button id="excluir-ficha" class="botao botao-excluir">Excluir Ficha</button> </div>

             <div class="theme-color-container">
                 <button id="lua-btn" class="botao icon-btn">🌙</button>
                 <button id="sol-btn" class="botao icon-btn">☀️</button>
               
 [source: 338]   <div id="cor-fundo-btn-wrapper" style="display: inline-block; position: relative;">
                      <button id="cor-fundo-btn" class="botao icon-btn">🎨</button> <div id="background-color-selector">
                           <div class="color-option" style="background-color: #800000;" data-color="#800000"></div>
                           <div class="color-option" style="background-color: #000080;" data-color="#000080"></div>
        
 [source: 339]                    <div class="color-option" style="background-color: #ffffff;" data-color="#ffffff"></div>
                           <div class="color-option" style="background-color: #f0e6d2;" data-color="#f0e6d2"></div>
                           <div class="color-option" style="background-color: #ffc0cb;" data-color="#ffc0cb"></div>
                  
 [source: 340]          <div class="color-option" style="background-color: #006400;" data-color="#006400"></div>
                           <div class="color-option" style="background-color: #ff0000;" data-color="#ff0000"></div>
                           <div class="color-option" style="background-color: #808080;" data-color="#808080"></div>
                      </div>
       
 [source: 341]           </div>
             </div>
         </div> </div> <button id="anotacoes-btn">Anotações</button>
     <textarea id="anotacoes-textarea" placeholder="Suas anotações aqui..."></textarea>
     <button id="historico-dados-btn">Histórico de dados</button>
     <div id="historico-dados-panel">
         <h3>Histórico de Dados</h3>
         <div id="historico-lista"></div>
         <button id="excluir-historico-btn">Excluir histórico</button>
     </div>
     <div id="vantagens-desvantagens-panel">
         <h2>Vantagens 
 [source: 342] e Desvantagens</h2>
         <div>Pontos de Vantagem Temporários: <span id="ph-temp">0</span></div>
         <div id="vantagens-list"></div>
         <div id="desvantagens-list"></div>
         <button id="salvar-vantagens-btn">SALVAR</button>
         <button id="fechar-pagina-btn">Fechar Página</button>
     </div>
     <div id="racas-panel">
         <h2>Raças</h2>
         <div id="ph-temp-raca-container" style="text-align: center;
 [source: 343] margin-bottom: 10px;">Pontos de Vantagem Temporários: <span id="ph-temp-raca">0</span></div> <div id="racas-list"></div>
         <button id="salvar-racas-btn">SALVAR</button>
         <button id="fechar-racas-btn">Fechar Página</button>
     </div>
     <div id="classes-panel">
         <h2>Classes</h2>
         <button id="fechar-classes-btn">Fechar Página</button>
     </div>
     <div id="nome-ficha-modal" class="modal">
         <div class="modal-content">
             <h3>Dê um Nome à Ficha</h3>
            
 [source: 344]  <input type="text" id="nome-ficha-input" placeholder="Nome da ficha" maxlength="20">
             <button class="confirm-btn" onclick="criarNovaFicha()">Confirmar</button>
             <button class="cancel-btn" onclick="fecharModal('nome-ficha-modal')">Cancelar</button>
         </div>
     </div>
     <div id="bloquear-ficha-modal" class="modal">
         <div class="modal-content">
             <h3>Ponha sua Senha de 4 Dígitos</h3>
             <input type="password" id="senha-bloqueio-input" placeholder="Senha (4 dígitos)" maxlength="4">
    
 [source: 345]          <button class="confirm-btn" onclick="bloquearFicha()">Confirmar</button>
             <button class="cancel-btn" onclick="fecharModal('bloquear-ficha-modal')">Cancelar</button>
         </div>
     </div>
     <div id="password-modal" class="modal">
         <div class="modal-content">
             <h3>Digite sua Senha</h3>
             <input type="password" id="senha-desbloqueio-input" placeholder="Senha (4 dígitos)" maxlength="4">
             <button class="confirm-btn" onclick="desbloquearFicha()">Confirmar</button>
   
 [source: 346]           <button class="cancel-btn" onclick="cancelarDesbloqueio()">Cancelar</button>
         </div>
     </div>
     <div id="confirmar-compra-modal" class="modal">
         <div class="modal-content">
             <h3>Tem certeza que quer comprar isso?</h3>
             <button class="confirm-btn" id="confirmar-compra-btn">Sim</button>
             <button class="cancel-btn" onclick="fecharModal('confirmar-compra-modal')">Não</button>
         </div>
     </div>
     
 [source: 347] <div id="salvar-vantagens-modal" class="modal"> <div class="modal-content">
             <h3 id="salvar-modal-texto">Se salvar, as alterações não poderão ser desfeitas.</h3>
             <button class="confirm-btn" id="confirmar-salvar-btn">OK</button> <button class="cancel-btn" onclick="fecharModal('salvar-vantagens-modal')">Cancelar</button>
         </div>
     </div>
     <div id="senha-gm-modal" class="modal">
         <div class="modal-content">
             <h3>Peça permissão ao GM</h3>
             <input type="password" id="senha-gm-input" placeholder="Senha GM">
  
 [source: 348]            <button class="confirm-btn" id="confirmar-senha-gm-btn">Confirmar</button>
             <button class="cancel-btn" onclick="fecharModal('senha-gm-modal')">Cancelar</button>
         </div>
     </div>
     <div id="raca-opcoes-modal" class="modal">
         <div class="modal-content">
             <h3>O que você deseja fazer?</h3>
             <button class="confirm-btn" onclick="excluirRacaSelecionadaModal()">Excluir Raça</button>
             <button class="confirm-btn" onclick="editarRacaSelecionadaModal()" 
 [source: 349] style="margin-top: 10px;">Editar Raça</button>
             <button class="cancel-btn" onclick="fecharModal('raca-opcoes-modal')">Cancelar</button>
         </div>
     </div>
     <div id="editar-raca-modal" class="modal">
         <div class="modal-content">
             <h3>Editar Raça</h3>
             <label for="editar-raca-nome">Nome:</label>
             <input type="text" id="editar-raca-nome">
             <label for="editar-raca-descricao">Descrição:</label>
     
 [source: 350]         <textarea id="editar-raca-descricao"></textarea>
             <button class="confirm-btn" onclick="salvarEdicaoRaca()">Salvar</button>
             <button class="cancel-btn" onclick="fecharModal('editar-raca-modal')">Cancelar</button>
         </div>
     </div>
     <div id="chat-password-modal" class="modal">
         <div class="modal-content">
             <h3>Definir Senha do Chat</h3>
             <input type="password" id="chat-senha-input" placeholder="Senha do Chat">
     
 [source: 351]         <input type="password" id="chat-confirmar-senha-input" placeholder="Confirmar Senha">
             <button class="confirm-btn" onclick="definirSenhaChat()">Confirmar</button>
             <button class="cancel-btn" onclick="fecharModal('chat-password-modal')">Cancelar</button>
         </div>
     </div>
     <div id="open-chat-modal" class="modal">
         <div class="modal-content">
             <h3>Digite a Senha do Chat</h3>
             <input type="password" id="abrir-chat-senha-input" placeholder="Senha do 
 [source: 352] Chat">
             <button class="confirm-btn" onclick="abrirChat()">Confirmar</button>
             <button class="cancel-btn" onclick="fecharModal('open-chat-modal')">Cancelar</button>
         </div>
     </div>
     <div id="chat-modal" class="modal">
         <div class="modal-content">
             <div class="chat-header">Chat Privado</div>
             <div class="chat-body">
                 <div class="user-list">
  
 [source: 353]                    <h4>Fichas Online</h4>
                     <div id="available-fichas"></div>
                 </div>
                 <div class="conversation" id="conversation-area"></div>
             </div>
             <div 
 [source: 354] class="chat-input">
                 <input type="text" id="mensagem-input" placeholder="Digite sua mensagem...">
                 <button onclick="enviarMensagem()">Enviar</button>
             </div>
             <button class="cancel-btn" onclick="fecharModal('chat-modal')">Fechar Chat</button>
         </div>
     </div>
     <div id="notification"></div>
     <audio id="new-message-sound" preload="auto">
         <source src="notification_sound.mp3" type="audio/mpeg">
   
 [source: 355]   </audio>
     <div id="background-modal" class="modal">
         <div class="modal-content">
             <h3>Plano de Fundo</h3>
             <label for="background-image-input">Selecionar Imagem:</label>
             <input type="file" id="background-image-input" accept="image/*">
             <button class="confirm-btn" onclick="aplicarPlanoDeFundo()">Aplicar</button>
             <button class="cancel-btn" onclick="fecharModal('background-modal')">Cancelar</button>
             <button class="cancel-btn" onclick="excluirPlanoDeFundo()">Excluir Imagem</button>
         </div>
    
 [source: 357]  </div>
     <script>
         const firebaseConfig = {
             apiKey: "AIzaSyBbbwbwPXv6gztkyP3TXK-DtooEI7FcClI", // Atenção: Chaves hardcoded podem ser um risco de segurança.
 [source: 358] authDomain: "ficha-de-rpg-b9685.firebaseapp.com",
             databaseURL: "https://ficha-de-rpg-b9685-default-rtdb.firebaseio.com",
             projectId: "ficha-de-rpg-b9685",
             storageBucket: "ficha-de-rpg-b9685.firebasestorage.app",
             messagingSenderId: "528610398062",
             appId: "1:528610398062:web:8fdb9cfd5ded8167613b7f"
         };
 [source: 359] firebase.initializeApp(firebaseConfig);
         const database = firebase.database();

         let fichas = {}, currentFichaId = null, isFichaLocked = false, fichaPassword = null,
             isFichaUnlocked = false, senhaMatriz = "1040", vantagensSelecionadas = [],
             desvantagensSelecionadas = [], tempVantagensSelecionadas = [], tempDesvantagensSelecionadas = [],
             racaSelecionada = null, tempRacaSelecionada = null, vidaTotal, vidaAtual, magiaTotal, magiaAtual,
             vigorTotal, vigorAtual, previousValues = new Map(), chatPassword = null, isChatOpen 
 [source: 360] = false, selectedChatUser = null;

         const vantagensData = [
             { nome: "Maestria com Armas curtas (2)", custo: 2, descricao: "+1 em ataque, +1 em acerto com armas curtas."
 [source: 361] }, { nome: "Maestria com armas pesadas (2)", custo: 2, descricao: "+2 em ataque com armas pesadas."
 [source: 362] }, { nome: "Maestria com armas de longo alcance (2)", custo: 2, descricao: "+2 em acerto com armas de longo alcance."
 [source: 363] }, { nome: "Furtar (2)", custo: 2, descricao: "+4 em testes de furto."
 [source: 364] }, { nome: "Lábia (2)", custo: 2, descricao: "+5 em testes de lábia."
 [source: 365] }, { nome: "Velejar (1)", custo: 1, descricao: "" }, { nome: "Beleza (1)", custo: 1, descricao: "+3 o teste em lábia, paquera e persuasão."
 [source: 366] }, { nome: "Boa Fama (2)", custo: 2, descricao: "+4 chance de descontos em armamentos, pousadas, alimentos, etc."
 [source: 367] }, { nome: "Arremedo (2)", custo: 2, descricao: "Capacidade de imitar qualquer som SIMPLES."
 [source: 368] }, { nome: "Destemor (1)", custo: 1, descricao: "Dificilmente é assustado por algo."
 [source: 369] }, { nome: "Empatia (3)", custo: 3, descricao: "Sensibilidade extraordinária em relação aos outras pessoas. Excelente para identificar impostores, possessões por espirito, etc."
 [source: 370] }, { nome: "Empatia com animais (1)", custo: 1, descricao: "Pode compreender as motivações dos animais."
 [source: 371] }, { nome: "Patrono (4)", custo: 4, descricao: "Possui um mentor/mestre/professor, até mesmo uma organização/guilda que pode lhe oferecer ajuda."
 [source: 372] }, { nome: "Reconhecimento Social (2)", custo: 2, descricao: "Membro de um grupo respeitado/temido/venerado. +2 teste em lábia, paquera e persuasão."
 [source: 373] }, { nome: "Riqueza (2)", custo: 2, descricao: "Inicia com 20 moedas de ouro."
 [source: 374] }, { nome: "Aptidão para magia (4)", custo: 4, descricao: "+15% dano e -15% custo de magia para a magia que tem aptidão."
 [source: 375] }, { nome: "Combo Físico (4)", custo: 4, descricao: "Inicia com 50km velocidade corrida, pulo de 3m altura e 9m distância.", restricao: "inicio" }, { nome: "Nadar (1)", custo: 1, descricao: "" }, { nome: "Escalar (2)", custo: 2, descricao: "" }, { nome: "Segunda língua (1)", custo: 1, descricao: "Fala mais um idioma."
 [source: 376] }, { nome: "Paquerador (2)", custo: 2, descricao: "+4 em teste para paquera e persuasão envolvendo flerte."
 [source: 377] }, { nome: "Senso de perigo (5)", custo: 5, descricao: "Quando algo grave ocorrer o mestre pedirá pra você jogar um dado para reagir."
 [source: 378] }, { nome: "Acrobata (3)", custo: 3, descricao: "+ fama ao lutar em público."
 [source: 379] }, { nome: "Equilíbrio Perfeito (3)", custo: 3, descricao: "+8 em testes de equilíbrio."
 [source: 380] }, { nome: "Tecnologia (2)", custo: 2, descricao: "Engenhoso, pode inventar coisas, criar objetos improvisados."
 [source: 381] }, { nome: "Poder Oculto (7)", custo: 7, descricao: "Com 10% vida, ativa +50% em todos atributos. Volta ao normal acima de 10% vida."
 [source: 382] }, { nome: "Sobrevivência em floresta (2)", custo: 2, descricao: "Facilidade para achar cavernas, criar assentamentos, achar comida, gravar caminhos, achar água, etc."
 [source: 383] }
         ];
         const desvantagensData = [
             { nome: "Fobia (+2)", ganho: 2, descricao: "Medo irracional de algo específico."
 [source: 384] }, { nome: "Má Fama (+2)", ganho: 2, descricao: "Mal visto pela sociedade, dificultando interações sociais."
 [source: 385] }, { nome: "Alcoolismo (+2)", ganho: 2, descricao: "Dependência de álcool que afeta suas decisões."
 [source: 386] }, { nome: "Altruísmo (+2)", ganho: 2, descricao: "Se sacrifica por outras pessoas, pouco se importa com fama ou riqueza."
 [source: 387] }, { nome: "Avareza (+2)", ganho: 2, descricao: "Preocupação permanente na conservação de riquezas."
 [source: 388] }, { nome: "Bullying (+3)", ganho: 3, descricao: "Gosta de caçoar, agredir, denegrir, difamar e apontar defeitos."
 [source: 389] }, { nome: "Circunspeção (+2)", ganho: 2, descricao: "Não entende piadas, entende tudo literal e acredita que todos estão sérios."
 [source: 390] }, { nome: "Compulsões (+3)", ganho: 3, descricao: "Hábito ou vício que toma boa parte dos seus recursos e tempo."
 [source: 391] }, { nome: "Covardia (+2)", ganho: 2, descricao: "Extremo cuidado com bem-estar físico e dificuldade em assumir riscos."
 [source: 392] }, { nome: "Dependentes (+4)", ganho: 4, descricao: "Alguém depende de você a todo momento (filhos, parentes, etc.)."
 [source: 393] }, { nome: "Fúria (+2)", ganho: 2, descricao: "Tendência a perder o controle e atacar freneticamente (ativado por dano, insulto ou aleatório)."
 [source: 394] }, { nome: "Honestidade (+3)", ganho: 3, descricao: "Não consegue mentir ou omitir, sempre fala a verdade e desmascara mentiras."
 [source: 395] }, { nome: "Impulsividade (+2)", ganho: 2, descricao: "Sempre age sem pensar."
 [source: 396] }, { nome: "Luxúria (+2)", ganho: 2, descricao: "Desejo incontrolável por romance."
 [source: 397] }, { nome: "Magnetismo Sobrenatural (+2)", ganho: 2, descricao: "Coisas estranhas acontecem com seu personagem em nível alarmante."
 [source: 398] }, { nome: "No Limite (+4)", ganho: 4, descricao: "Assume riscos extremamente irracionais diante de perigo mortal."
 [source: 399] }, { nome: "Teimosia (+1)", ganho: 1, descricao: "Quer sempre fazer as coisas do seu modo, não segue planos que não sejam seus."
 [source: 400] }, { nome: "Amnésia (+2)", ganho: 2, descricao: "Em certos momentos, não consegue lembrar de coisas importantes."
 [source: 401] }
         ];
         let racasData = [
             { nome: "Humano (3)", custo: 3, descricao: "Versáteis, ambiciosos, mestres em adaptação.", vantagens: ["Explorador Nato: Cavalo superior, equipamentos, mapa detalhado.", "Mestre das Profissões: Escolha (Ferreiro Lendário, Costureiro Arcano, Arquiteto Visionário) com benefícios únicos.", "Rede de Influência: Aliado influente (guildas, mercadores, líderes) com acesso a informações ou ajuda.", "Determinação Inabalável: Uma vez/dia, ignore uma desvantagem (exaustão, ferimento, magia) por um curto período."] }, { nome: "Elfo (4)", custo: 4, descricao: "Sábios, mágicos, conectados à natureza.", vantagens: ["Sabedoria 
 [source: 402] Ancestral: Domina área (arcana, história, natureza), decifra itens antigos, aprende 1 língua extra.", "Visão Élfica Suprema: Enxerga 10m escuro, detecta magias fracas 20m, percebe intenções hostis (teste 19+).", "Escudo Mágico: Resistência inata a um tipo de efeito mágico hostil (dano ou duração -50%)."] }, { nome: "Anão (4)", custo: 4, descricao: "Resilientes, habilidosos, ligados à terra.", vantagens: ["Fortitude Indomável: Trabalha 3 dias sem descanso, recupera vida/energia 2x mais rápido em rocha/subterrâneo.", "Artesão: Escolha (Mestre Minerador, Forjador de Lendas, Joalheiro Divino) com impacto massivo.", "Senhor das Profundezas: Nunca se perde subterrâneo, detecta armadilhas, sente vibrações (prever emboscada/colapso)."] }, { nome: "Orc 
 [source: 403] (3)", custo: 3, descricao: "Guerreiros ferozes, líderes pela força.", vantagens: ["Lenda entre Guerreiros: Inspira temor/respeito, alianças marciais, acesso missões épicas;
 [source: 404] inimigos menores fogem (teste 16+).", "Resiliência Brutal: Luta sem penalidades com ferimentos graves, só cai com PV 0, regenera ferimentos leves fora de combate.", "Domínio da Intimidação: Força inimigos a render/recuar com grito (1x/encontro, afeta grupos), bônus massivo negociações (força/medo).", "Fúria Ancestral: Fúria 2x/dia (dobra força/resistência por curto período)."] }, { nome: "Meio Animal (Selvagem) (4)", custo: 4, descricao: "Instinto primal com astúcia.", vantagens: ["Sentidos Predatórios: Escolha (visão, olfato, audição) aguçado;
 [source: 405] rastreia km, detecta invisíveis, evita surpresa (teste 12+).", "Senhor dos Terrenos: Adapta-se a 1 ambiente (floresta, deserto, pântano), ignora efeitos negativos, bônus movimento/furtividade (+1).", "Frenesi Instintivo: 1x/dia, velocidade sobrenatural (2x movimento), ataques adicionais, percepção pré-monitória (10 min)."] }
         ];
         const nivelData = [
             { nivel: 0, xp: 0, pd: 25, ph: 8 }, { nivel: 1, xp: 10, pd: 31, ph: 9 }, { nivel: 2, xp: 30, pd: 37, ph: 10 }, { nivel: 
 [source: 406] 3, xp: 60, pd: 43, ph: 11 }, { nivel: 4, xp: 100, pd: 49, ph: 12 }, { nivel: 5, xp: 150, pd: 55, ph: 13 }, { nivel: 6, xp: 210, pd: 61, ph: 14 }, { nivel: 7, xp: 280, pd: 67, ph: 15 }, { nivel: 8, xp: 360, pd: 73, ph: 16 }, { nivel: 9, xp: 450, pd: 79, ph: 17 }, { nivel: 10, xp: 550, pd: 85, ph: 18 }, { nivel: 11, xp: 670, pd: 91, ph: 19 }, { nivel: 12, xp: 810, pd: 97, ph: 20 }, { nivel: 
 [source: 407] 13, xp: 970, pd: 103, ph: 21 }, { nivel: 14, xp: 1150, pd: 109, ph: 22 }, { nivel: 15, xp: 1350, pd: 115, ph: 23 }, { nivel: 16, xp: 1570, pd: 121, ph: 24 }, { nivel: 17, xp: 1810, pd: 127, ph: 25 }, { nivel: 18, xp: 2070, pd: 133, ph: 26 }, { nivel: 19, xp: 2350, pd: 139, ph: 27 }, { nivel: 20, xp: 2650, pd: 145, ph: 28 }, { nivel: 21, xp: 2980, pd: 148, ph: 29 }, { nivel: 22, xp: 3340, pd: 151, ph: 30 }, { nivel: 
 [source: 408] 23, xp: 3730, pd: 154, ph: 31 }, { nivel: 24, xp: 4150, pd: 157, ph: 32 }, { nivel: 25, xp: 4600, pd: 160, ph: 33 }, { nivel: 26, xp: 5080, pd: 163, ph: 34 }, { nivel: 27, xp: 5590, pd: 166, ph: 35 }, { nivel: 28, xp: 6130, pd: 169, ph: 36 }, { nivel: 29, xp: 8000, pd: 219, ph: 37 }, { nivel: 30, xp: 10000, pd: 319, ph: 38 }
         ];
 [source: 409] // Cache DOM Elements
         const nomePersonagemInput = document.getElementById("nome-personagem"), descricaoPersonagemInput = document.getElementById("descricao-personagem"),
             forcaInput = document.getElementById("forca"), destrezaInput = document.getElementById("destreza"), agilidadeInput = document.getElementById("agilidade"),
             inteligenciaInput = document.getElementById("inteligencia"), constituicaoInput = document.getElementById("constituicao"),
             ataqueSpan = document.getElementById("ataque"), ataqueMagicoSpan = document.getElementById("ataque-magico"), acertoSpan = document.getElementById("acerto"),
             esquivaSpan = document.getElementById("esquiva"), rdfSpan = document.getElementById("rdf"), rdmSpan = document.getElementById("rdm"),
       
 [source: 410]       armaDireitaNomeInput = document.getElementById("arma-direita-nome"), armaDireitaAtaqueInput = document.getElementById("arma-direita-ataque"),
             armaDireitaAtaqueMagicoInput = document.getElementById("arma-direita-ataque-magico"), armaEsquerdaNomeInput = document.getElementById("arma-esquerda-nome"),
             armaEsquerdaAtaqueInput = document.getElementById("arma-esquerda-ataque"), armaEsquerdaAtaqueMagicoInput = document.getElementById("arma-esquerda-ataque-magico"),
             resetPontosButton = document.getElementById("reset-pontos"), recomecarButton = document.getElementById("recomecar"),
             bloquearFichaButton = document.getElementById("bloquear-ficha"), experienciaInput = document.getElementById("experiencia"),
             nivelSpan = document.getElementById("nivel"), pontosHabilidadeSpan = document.getElementById("pontos-habilidade"),
     
 [source: 411]         pontosVantagemSpan = document.getElementById("pontos-vantagem"), velocidadeCorridaSpan = document.getElementById("velocidade-corrida"),
             alturaPuloSpan = document.getElementById("altura-pulo"), distanciaPuloSpan = document.getElementById("distancia-pulo"),
             nomePersonagemTitulo = document.getElementById("nome-personagem-titulo"), gameMasterMessage = document.getElementById("game-master-message"),
             vantagensListDisplay = document.getElementById("vantagens-list-display"), desvantagensListDisplay = document.getElementById("desvantagens-list-display"),
             inventarioSlots = document.getElementById("inventario-slots"), pesoTotalSpan = document.getElementById("peso-total"),
             diceContainer = document.getElementById("dice-container"), diceRoll = document.getElementById("dice-roll"), diceResult 
 [source: 412] = document.getElementById("dice-result"),
             notification = document.getElementById("notification"), characterImageInput = document.getElementById("character-image-input"),
             characterImage = document.getElementById("character-image"), vantagensDesvantagensBtn = document.getElementById("vantagens-desvantagens-btn"),
             vantagensDesvantagensPanel = document.getElementById("vantagens-desvantagens-panel"), vantagensList = document.getElementById("vantagens-list"),
             desvantagensList = document.getElementById("desvantagens-list"), salvarVantagensBtn = document.getElementById("salvar-vantagens-btn"),
             fecharPaginaBtn = document.getElementById("fechar-pagina-btn"), fichaContainer = document.getElementById("ficha-container"),
             magiasList = 
 [source: 413] document.getElementById("magias-list"), adicionarMagiaBtn = document.getElementById("adicionar-magia-btn"),
             anotacoesBtn = document.getElementById("anotacoes-btn"), anotacoesTextarea = document.getElementById("anotacoes-textarea"),
             racasBtn = document.getElementById("racas-btn"), classesBtn = document.getElementById("classes-btn"), racasPanel = document.getElementById("racas-panel"),
             classesPanel = document.getElementById("classes-panel"), fecharRacasBtn = document.getElementById("fechar-racas-btn"),
             fecharClassesBtn = document.getElementById("fechar-classes-btn"), classeNomeInput = document.getElementById("classe-nome"),
             classeDescricaoInput = document.getElementById("classe-descricao"), racaNomeSpan = document.getElementById("raca-nome"),
          
 [source: 414]    racaDescricaoInput = document.getElementById("raca-descricao"), luaBtn = document.getElementById("lua-btn"), solBtn = document.getElementById("sol-btn"),
             salvarRacasBtn = document.getElementById("salvar-racas-btn"), racasList = document.getElementById("racas-list"),
             atributosInputs = [forcaInput, destrezaInput, agilidadeInput, inteligenciaInput, constituicaoInput],
             chatBtn = document.getElementById("chat-btn"), availableFichasDiv = document.getElementById("available-fichas"),
             conversationAreaDiv = document.getElementById("conversation-area"), mensagemInput = document.getElementById("mensagem-input"),
             newMessageSound = document.getElementById("new-message-sound"), planoFundoBtn = document.getElementById("plano-fundo-btn"),
    
 [source: 415]          backgroundImageInput = document.getElementById("background-image-input"), backgroundModal = document.getElementById("background-modal"),
             corFundoBtn = document.getElementById("cor-fundo-btn"), backgroundColorSelector = document.getElementById("background-color-selector"),
             confirmarSalvarBtn = document.getElementById("confirmar-salvar-btn"), // Use the specific ID for the confirm button
             phTempRacaSpan = document.getElementById("ph-temp-raca");
 [source: 416] // Get the PH display span in race panel


         let nivel = 0, nivelAnterior = 0, pontosHabilidadeTotal = 25, pontosHabilidadeUsados = 0, experiencia = 0, vidaBase = 50;
 [source: 417] function criarFichaMatriz() {
             const fichaId = "ficha-matriz";
 [source: 418] const fichaMatriz = {
                 nomeFicha: "Matriz", nomePersonagem: "Personagem Matriz", descricaoPersonagem: "Ficha original do sistema",
                 forca: "0", destreza: "0", agilidade: "0", inteligencia: "0", constituicao: "0", experiencia: "0",
                 armaDireitaNome: "", armaDireitaAtaque: "0", armaDireitaAtaqueMagico: "0",
                 armaEsquerdaNome: "", armaEsquerdaAtaque: "0", armaEsquerdaAtaqueMagico: "0",
    
 [source: 419]              vantagens: "", magiasHabilidades: "", desvantagens: "",
                 inventario: Array(10).fill({ item: "", peso: "0" }),
                 velocidadeCorrida: "25", alturaPulo: "1", distanciaPulo: "3",
                 isLocked: true, password: senhaMatriz, imagem: null, anotacoes: "",
                 
 [source: 420] classeNome: "", classeDescricao: "", racaNome: "", racaDescricao: "", racaSelecionada: "",
                 chatPassword: null, backgroundImage: null, /* Removido: backgroundSize: 'cover', */ backgroundColor: '#f0e6d2' // Mantem cor de fundo
             };
 [source: 421] database.ref("fichas/ficha-matriz").once("value", snapshot => {
                 if (snapshot.exists()) {
                     currentFichaId = fichaId; carregarFicha(fichaId); carregarFichas();
                     aplicarPlanoDeFundoInicial(); aplicarCorDeFundoInicial();
                 } else {
                 
 [source: 422]     database.ref(`fichas/${fichaId}`).set(fichaMatriz).then(() => {
                         currentFichaId = fichaId; carregarFicha(fichaId);
                         aplicarPlanoDeFundoInicial(); aplicarCorDeFundoInicial();
                     });
                 }
       
 [source: 423]       });
         }

         function carregarFichas() {
             database.ref("fichas").on("value", snapshot => {
                 fichas = snapshot.val() || {};
                 if (fichas["ficha-matriz"]) {
                     atualizarAbasFichas(); atualizarListaFichasChat(); verificarNovasMensagens();
         
 [source: 424]         } else { criarFichaMatriz(); }
             });
 [source: 425] }

         function atualizarAbasFichas() {
             const sidebar = document.getElementById("fichas-sidebar"), addBtn = document.getElementById("add-ficha-btn");
 [source: 426] while (sidebar.children.length > 1) sidebar.removeChild(sidebar.children[0]);
             for (let fichaId in fichas) {
                 if (fichaId !== "ficha-matriz") {
                     const tab = document.createElement("div");
 [source: 427] tab.className = "ficha-tab";
                     const span = document.createElement("span"); span.textContent = fichas[fichaId].nomeFicha || "Sem Nome";
                     tab.appendChild(span); tab.dataset.fichaId = fichaId;
 [source: 428] if (fichaId === currentFichaId) tab.classList.add("active");
                     tab.onclick = () => {
                         currentFichaId = fichaId;
 [source: 429] carregarFicha(fichaId); atualizarAbasFichas();
                         atualizarListaFichasChat(); verificarNovasMensagens();
                     };
                     sidebar.insertBefore(tab, addBtn);
                 }
             }
         }

         document.getElementById("add-ficha-btn").onclick = () => {
             document.getElementById("nome-ficha-modal").style.display = "flex";
 [source: 430] document.getElementById("nome-ficha-input").value = ""; document.getElementById("nome-ficha-input").focus();
         };

         function criarNovaFicha() {
             const nomeFicha = document.getElementById("nome-ficha-input").value.trim();
 [source: 431] if (!nomeFicha) return alert("Por favor, dê um nome à ficha!");
             const novaFichaId = database.ref("fichas").push().key;
 [source: 432] const novaFicha = {
                 nomeFicha, nomePersonagem: "", descricaoPersonagem: "", forca: "0", destreza: "0", agilidade: "0",
                 inteligencia: "0", constituicao: "0", experiencia: "0", armaDireitaNome: "", armaDireitaAtaque: "0",
                 armaDireitaAtaqueMagico: "0", armaEsquerdaNome: "", armaEsquerdaAtaque: "0", armaEsquerdaAtaqueMagico: "0",
                 vantagens: "", magiasHabilidades: Array(10).fill("").join("\n"), desvantagens: "",
   
 [source: 433]               inventario: Array(10).fill({ item: "", peso: "0" }),
                 velocidadeCorrida: "25", alturaPulo: "1", distanciaPulo: "3",
                 isLocked: false, password: null, imagem: null, anotacoes: "",
                 classeNome: "", classeDescricao: "", racaNome: "", racaDescricao: "", racaSelecionada: "",
            
 [source: 434]      chatPassword: null, backgroundImage: null, /* Removido: backgroundSize: 'cover', */ backgroundColor: '#f0e6d2'
             };
 [source: 435] database.ref(`fichas/${novaFichaId}`).set(novaFicha).then(() => {
                 currentFichaId = novaFichaId; carregarFicha(novaFichaId); fecharModal("nome-ficha-modal");
                 atualizarAbasFichas(); atualizarListaFichasChat();
             }).catch(error => console.error("Erro ao criar nova ficha:", error));
 [source: 436] }

         function fecharModal(modalId) { document.getElementById(modalId).style.display = "none";
 [source: 437] }

         function carregarFicha(fichaId) {
             if (!fichas[fichaId]) return;
 [source: 438] const ficha = fichas[fichaId];
             nomePersonagemInput.value = ficha.nomePersonagem || ""; descricaoPersonagemInput.value = ficha.descricaoPersonagem || "";
             forcaInput.value = ficha.forca || "0";
 [source: 439] destrezaInput.value = ficha.destreza || "0"; agilidadeInput.value = ficha.agilidade || "0";
             inteligenciaInput.value = ficha.inteligencia || "0"; constituicaoInput.value = ficha.constituicao || "0";
 [source: 440] experienciaInput.value = ficha.experiencia || "0";
             armaDireitaNomeInput.value = ficha.armaDireitaNome || ""; armaDireitaAtaqueInput.value = ficha.armaDireitaAtaque || "0"; armaDireitaAtaqueMagicoInput.value = ficha.armaDireitaAtaqueMagico || "0";
 [source: 441] armaEsquerdaNomeInput.value = ficha.armaEsquerdaNome || ""; armaEsquerdaAtaqueInput.value = ficha.armaEsquerdaAtaque || "0"; armaEsquerdaAtaqueMagicoInput.value = ficha.armaEsquerdaAtaqueMagico || "0";
             velocidadeCorridaSpan.textContent = ficha.velocidadeCorrida || "25";
 [source: 442] alturaPuloSpan.textContent = ficha.alturaPulo || "1"; distanciaPuloSpan.textContent = ficha.distanciaPulo || "3";
             isFichaLocked = ficha.isLocked || false; fichaPassword = ficha.password || null;
 [source: 443] isFichaUnlocked = false;
             vantagensSelecionadas = ficha.vantagens ? ficha.vantagens.split("\n").filter(v => v.trim()) : [];
             desvantagensSelecionadas = ficha.desvantagens ?
 [source: 444] ficha.desvantagens.split("\n").filter(d => d.trim()) : [];
             racaSelecionada = ficha.racaSelecionada || "";
             racaNomeSpan.textContent = racaSelecionada ?
 [source: 445] racaSelecionada.split(" (")[0] : ""; // Handle empty selection display
             racaDescricaoInput.value = racasData.find(r => r.nome === racaSelecionada)?.vantagens.join("\n\n") || "";

             vantagensListDisplay.innerHTML = ""; desvantagensListDisplay.innerHTML = "";
             vantagensSelecionadas.forEach(v => { const div = document.createElement("div"); div.textContent = v; div.className = "list-item"; div.onclick = () => removerVantagem(v); vantagensListDisplay.appendChild(div); });
             desvantagensSelecionadas.forEach(d => { const div = document.createElement("div"); div.textContent = d; div.className = 
 [source: 446] "list-item"; div.onclick = () => removerDesvantagem(d); desvantagensListDisplay.appendChild(div); });

             const inventario = Array.isArray(ficha.inventario) ? ficha.inventario : Array(10).fill({ item: "", peso: "0" });
             const slots = inventarioSlots.querySelectorAll(".inventory-slot");
             slots.forEach((slot, i) => { slot.querySelector(".inventory-item").value = inventario[i]?.item ||
 [source: 447] ""; slot.querySelector(".inventory-weight").value = inventario[i]?.peso || "0"; });
             calcularPesoTotal();

             const magias = ficha.magiasHabilidades ? ficha.magiasHabilidades.split("\n") : Array(10).fill("");
             magiasList.innerHTML = "";
 [source: 448] magias.forEach((m, i) => { const input = document.createElement("input"); input.type = "text"; input.className = "magia-nome"; input.placeholder = `Magia/Habilidade ${i + 1}`; input.value = m; magiasList.appendChild(input); });
 [source: 449] anotacoesTextarea.value = ficha.anotacoes || ""; classeNomeInput.value = ficha.classeNome || ""; classeDescricaoInput.value = ficha.classeDescricao || "";
 [source: 450] if (ficha.imagem && ficha.imagem.startsWith('data:image')) { characterImage.src = ficha.imagem; characterImage.style.display = "block"; } else { characterImage.src = ''; characterImage.style.display = "none";
 [source: 451] }

             atualizarBotaoBloquear(); atualizarVantagensDesvantagensPanel();
 [source: 452] // Update display only
             atualizarRacasPanel();
 [source: 453] // Update display only
             experiencia = parseInt(experienciaInput.value) || 0;
 [source: 454] atualizarNivel(); calcularAtributos(); // This calculates derived stats including Total HP/MP etc.

             // Initialize current HP/MP/Stamina based on calculated totals if not already set or if they exceed new totals
             vidaTotal = parseInt(document.getElementById("vida-total").textContent);
 [source: 455] // Get calculated total
             magiaTotal = parseInt(document.getElementById("magia-total").textContent);
 [source: 456] vigorTotal = parseFloat(document.getElementById("vigor-total").textContent);
             // <<< MODIFICADO: Carrega valores atuais salvos se existirem
             vidaAtual = typeof ficha.vidaAtual === 'number' ? Math.min(ficha.vidaAtual, vidaTotal) : vidaTotal;
 [source: 457] magiaAtual = typeof ficha.magiaAtual === 'number' ? Math.min(ficha.magiaAtual, magiaTotal) : magiaTotal;
             vigorAtual = typeof ficha.vigorAtual === 'number' ?
 [source: 458] Math.min(ficha.vigorAtual, vigorTotal) : vigorTotal;
             document.getElementById("vida-atual").textContent = vidaAtual; document.getElementById("magia-atual").textContent = magiaAtual; document.getElementById("vigor-atual").textContent = vigorAtual.toFixed(1);

             pontosVantagemSpan.textContent = getPontosVantagem();
 [source: 459] // Update displayed PH based on loaded advantages/race
             previousValues.clear();
 [source: 460] document.querySelectorAll('input[type="text"],input[type="number"],textarea').forEach(input => previousValues.set(input, input.value));
             chatPassword = ficha.chatPassword; atualizarEstadoChatBotao();
             aplicarPlanoDeFundoInicial(); aplicarCorDeFundoInicial();
 [source: 461] }

         function atualizarBotaoBloquear() {
             bloquearFichaButton.textContent = isFichaLocked ?
 [source: 462] "Desbloquear Ficha" : "Bloquear Ficha";
             bloquearFichaButton.classList.toggle("botao-bloquear", !isFichaLocked); bloquearFichaButton.classList.toggle("botao-desbloquear", isFichaLocked);
         }

         function salvarDados() {
             if (!currentFichaId || (isFichaLocked && !isFichaUnlocked)) return;
 [source: 463] const inventario = Array.from(inventarioSlots.querySelectorAll(".inventory-slot")).map(slot => ({ item: slot.querySelector(".inventory-item").value, peso: slot.querySelector(".inventory-weight").value }));
             const magias = Array.from(magiasList.querySelectorAll(".magia-nome")).map(input => input.value);
 [source: 464] const dados = {
                 nomePersonagem: nomePersonagemInput.value, descricaoPersonagem: descricaoPersonagemInput.value,
                 forca: forcaInput.value, destreza: destrezaInput.value, agilidade: agilidadeInput.value, inteligencia: inteligenciaInput.value, constituicao: constituicaoInput.value,
                 experiencia: experienciaInput.value, armaDireitaNome: armaDireitaNomeInput.value, armaDireitaAtaque: armaDireitaAtaqueInput.value, armaDireitaAtaqueMagico: armaDireitaAtaqueMagicoInput.value,
                 armaEsquerdaNome: armaEsquerdaNomeInput.value, armaEsquerdaAtaque: armaEsquerdaAtaqueInput.value, armaEsquerdaAtaqueMagico: armaEsquerdaAtaqueMagicoInput.value,
          
 [source: 465]        vantagens: vantagensSelecionadas.join("\n"), magiasHabilidades: magias.join("\n"), desvantagens: desvantagensSelecionadas.join("\n"),
                 inventario, velocidadeCorrida: velocidadeCorridaSpan.textContent, alturaPulo: alturaPuloSpan.textContent, distanciaPulo: distanciaPuloSpan.textContent,
                 isLocked: isFichaLocked, password: fichaPassword, imagem: characterImage.src.startsWith('data:image') ?
 [source: 466] characterImage.src : null, anotacoes: anotacoesTextarea.value,
                 classeNome: classeNomeInput.value, classeDescricao: classeDescricaoInput.value, racaNome: racaNomeSpan.textContent, racaDescricao: racaDescricaoInput.value, racaSelecionada: racaSelecionada,
                 chatPassword: chatPassword,
                 backgroundImage: document.body.style.backgroundImage === 'none' ?
 [source: 467] null : document.body.style.backgroundImage.slice(5, -2), // Salva apenas a URL
                 // Removido: backgroundSize: document.body.style.backgroundSize,
                 backgroundColor: document.body.style.backgroundColor,
                 // Persist current resource values (optional but good practice)
                 vidaAtual: vidaAtual,
                 magiaAtual: magiaAtual,
      
 [source: 468]            vigorAtual: vigorAtual
             };
 [source: 469] database.ref(`fichas/${currentFichaId}`).update(dados).then(() => {
                 showNotification("Salvo!", "save-success");
                 previousValues.clear(); document.querySelectorAll('input[type="text"],input[type="number"],textarea').forEach(input => previousValues.set(input, input.value));
             }).catch(error => console.error("Erro ao salvar dados:", error));
 [source: 470] // Added error handling
         }

         function calcularNivel(exp) { return nivelData.findLast(data => exp >= data.xp)?.nivel ??
 [source: 471] 0; } // Use ?? for nullish coalescing

         function atualizarNivel() {
             nivelAnterior = nivel;
 [source: 472] nivel = calcularNivel(experiencia); nivelSpan.textContent = nivel;
             pontosHabilidadeTotal = nivelData[nivel]?.pd ?? nivelData[0].pd;
 [source: 473] // Safe access
             pontosVantagemSpan.textContent = getPontosVantagem();
 [source: 474] if (nivel > nivelAnterior) { nivelSpan.classList.add("aura-azul"); setTimeout(() => nivelSpan.classList.remove("aura-azul"), 20000);
 [source: 475] }
             gameMasterMessage.style.display = nivel >= 30 ?
 [source: 476] "block" : "none"; fichaContainer.classList.toggle("aura-azul", nivel >= 30);
             calcularAtributos();
         }

         function getPontosVantagem() {
             let ph = nivelData.find(data => data.nivel === nivel)?.ph ??
 [source: 477] nivelData[0].ph; // Safe access
             vantagensSelecionadas.forEach(v => { const vantagem = vantagensData.find(d => d.nome === v); if (vantagem) ph -= vantagem.custo; });
 [source: 478] desvantagensSelecionadas.forEach(d => { const desvantagem = desvantagensData.find(desv => desv.nome === d); if (desvantagem) ph += desvantagem.ganho; });
 [source: 479] if (racaSelecionada) { const raca = racasData.find(r => r.nome === racaSelecionada); if (raca) ph -= raca.custo;
 [source: 480] }
             return ph;
 [source: 481] }

         function calcularPontosVantagemTemp() {
             let ph = nivelData.find(data => data.nivel === nivel)?.ph ??
 [source: 482] nivelData[0].ph; // Safe access
             tempVantagensSelecionadas.forEach(v => { const vantagem = vantagensData.find(d => d.nome === v); if (vantagem) ph -= vantagem.custo; });
 [source: 483] tempDesvantagensSelecionadas.forEach(d => { const desvantagem = desvantagensData.find(desv => desv.nome === d); if (desvantagem) ph += desvantagem.ganho; });
 [source: 484] if (tempRacaSelecionada) { const raca = racasData.find(r => r.nome === tempRacaSelecionada); if (raca) ph -= raca.custo;
 [source: 485] }
             return ph;
 [source: 486] }

         function aumentarVida() { if (vidaAtual < vidaTotal) { vidaAtual++; document.getElementById("vida-atual").textContent = vidaAtual;
 [source: 487] salvarDados(); } }
         function diminuirVida() { if (vidaAtual > 0) { vidaAtual--;
 [source: 488] document.getElementById("vida-atual").textContent = vidaAtual; salvarDados(); } }
         function aumentarMagia() { if (magiaAtual < magiaTotal) { magiaAtual++;
 [source: 489] document.getElementById("magia-atual").textContent = magiaAtual; salvarDados(); } }
         function diminuirMagia() { if (magiaAtual > 0) { magiaAtual--;
 [source: 490] document.getElementById("magia-atual").textContent = magiaAtual; salvarDados(); } }
         function aumentarVigor() { if (vigorAtual < vigorTotal) { vigorAtual = Math.min(vigorAtual + 0.1, vigorTotal);
 [source: 491] document.getElementById("vigor-atual").textContent = vigorAtual.toFixed(1); salvarDados(); } }
         function diminuirVigor() { if (vigorAtual > 0) { vigorAtual = Math.max(vigorAtual - 0.1, 0);
 [source: 492] document.getElementById("vigor-atual").textContent = vigorAtual.toFixed(1); salvarDados(); } }

         function calcularAtributos() {
             const forca = parseInt(forcaInput.value) ||
 [source: 493] 0, destreza = parseInt(destrezaInput.value) || 0, agilidade = parseInt(agilidadeInput.value) ||
 [source: 494] 0,
                   inteligencia = parseInt(inteligenciaInput.value) ||
 [source: 495] 0, constituicao = parseInt(constituicaoInput.value) || 0;
             let totalPontos = forca + destreza + agilidade + inteligencia + constituicao;
 [source: 496] if (totalPontos > pontosHabilidadeTotal) {
                 alert("Pontos de habilidade insuficientes!");
 [source: 497] forcaInput.value = previousValues.get(forcaInput) || "0"; destrezaInput.value = previousValues.get(destrezaInput) || "0";
                 agilidadeInput.value = previousValues.get(agilidadeInput) || "0"; inteligenciaInput.value = previousValues.get(inteligenciaInput) || "0";
 [source: 498] constituicaoInput.value = previousValues.get(constituicaoInput) || "0"; return;
             }
             pontosHabilidadeUsados = totalPontos;
 [source: 499] pontosHabilidadeSpan.textContent = pontosHabilidadeTotal - pontosHabilidadeUsados;

             let ataque = forca + Math.floor(destreza / 5), acerto = Math.floor(destreza / 3) + Math.floor(agilidade / 10),
                 esquiva = Math.floor(agilidade / 3), rdf = Math.floor(forca / 5), rdm = Math.floor(inteligencia / 5),
                 ataqueMagico = inteligencia, magiaBase = 20 + 3 * constituicao, vigorBase = 10 + 0.4 * constituicao;
 [source: 500] vidaBase = 50 + (constituicao * (3 + Math.floor(forca / 10))) + 10 * nivel;
 [source: 501] if (inteligencia >= 10) magiaBase += constituicao * Math.floor(inteligencia / 10);

             ataque += (parseInt(armaDireitaAtaqueInput.value) || 0) + (parseInt(armaEsquerdaAtaqueInput.value) || 0);
 [source: 502] ataqueMagico += (parseInt(armaDireitaAtaqueMagicoInput.value) || 0) + (parseInt(armaEsquerdaAtaqueMagicoInput.value) || 0);

             const velocidadeBase = 25 + Math.floor(agilidade / 3) * 3, alturaPuloBase = 1 + Math.floor(forca / 10), distanciaPuloBase = 3 + 3 * Math.min(Math.floor(forca / 5), Math.floor(agilidade / 5));
 [source: 503] let bonusVelocidade = vantagensSelecionadas.includes("Combo Físico (4)") ? 25 : 0, bonusAlturaPulo = vantagensSelecionadas.includes("Combo Físico (4)") ?
 [source: 504] 2 : 0, bonusDistanciaPulo = vantagensSelecionadas.includes("Combo Físico (4)") ? 6 : 0;

             velocidadeCorridaSpan.textContent = velocidadeBase + bonusVelocidade;
 [source: 505] alturaPuloSpan.textContent = alturaPuloBase + bonusAlturaPulo; distanciaPuloSpan.textContent = distanciaPuloBase + bonusDistanciaPulo;
             ataqueSpan.textContent = ataque; ataqueMagicoSpan.textContent = ataqueMagico; acertoSpan.textContent = acerto;
 [source: 506] esquivaSpan.textContent = esquiva; rdfSpan.textContent = rdf; rdmSpan.textContent = rdm;
             vidaTotal = Math.ceil(vidaBase); magiaTotal = Math.ceil(magiaBase); vigorTotal = parseFloat(vigorBase.toFixed(1));
 [source: 507] // Don't reset current values here, just update totals. Current values are loaded/managed elsewhere.
             document.getElementById("vida-total").textContent = vidaTotal; document.getElementById("magia-total").textContent = magiaTotal;
 [source: 508] document.getElementById("vigor-total").textContent = vigorTotal.toFixed(1);
             // Update current values display in case they exceed the new total
             document.getElementById("vida-atual").textContent = Math.min(vidaAtual, vidaTotal);
 [source: 509] document.getElementById("magia-atual").textContent = Math.min(magiaAtual, magiaTotal); document.getElementById("vigor-atual").textContent = Math.min(vigorAtual, vigorTotal).toFixed(1);

             const regeneracaoVida = (0.2 * constituicao).toFixed(1), regeneracaoMagia = (0.8 * constituicao).toFixed(1), regeneracaoVigor = (0.4 * constituicao).toFixed(1);
 [source: 510] document.getElementById("regeneracao-vida").textContent = regeneracaoVida; document.getElementById("regeneracao-magia").textContent = regeneracaoMagia; document.getElementById("regeneracao-vigor").textContent = regeneracaoVigor;

             const atributos = [{ span: ataqueSpan, valor: ataque }, { span: ataqueMagicoSpan, valor: ataqueMagico }, { span: acertoSpan, valor: acerto }, { span: esquivaSpan, valor: esquiva }, { span: rdfSpan, valor: rdf }, { span: rdmSpan, valor: rdm }];
 [source: 511] atributos.forEach(a => a.span.classList.remove("atributo-fogo"));
             const maxAtributo = atributos.reduce((prev, curr) => prev.valor > curr.valor ? prev : curr, { valor: 0 });
 [source: 512] if (maxAtributo.valor > 0) maxAtributo.span.classList.add("atributo-fogo");
         }

         function resetarPontos() {
             if (isFichaLocked && !isFichaUnlocked) return abrirModalSenha(resetPontosButton);
 [source: 513] // Pass element for context
             if (confirm("Tem certeza que deseja reiniciar os pontos? Você precisará da permissão do GM.")) {
                 document.getElementById("senha-gm-modal").style.display = "flex";
 [source: 514] document.getElementById("senha-gm-input").value = "";
                 document.getElementById("confirmar-senha-gm-btn").onclick = () => {
                     if (document.getElementById("senha-gm-input").value === senhaMatriz) {
                         atributosInputs.forEach(input => input.value = 0);
 [source: 515] pontosHabilidadeUsados = 0; pontosHabilidadeSpan.textContent = pontosHabilidadeTotal;
                         velocidadeCorridaSpan.textContent = "25"; alturaPuloSpan.textContent = "1"; distanciaPuloSpan.textContent = "3";
                         calcularAtributos(); pontosVantagemSpan.textContent = getPontosVantagem(); salvarDados();
 [source: 516] fecharModal("senha-gm-modal");
                     } else { alert("Senha do GM incorreta!"); fecharModal("senha-gm-modal"); }
                 };
 [source: 517] }
         }

         function recomecarFicha() {
              if (isFichaLocked && !isFichaUnlocked) return abrirModalSenha(recomecarButton);
 [source: 518] // Pass element for context
             if (confirm("Tem certeza que deseja recomeçar a ficha? Todas as alterações serão perdidas.")) {
                 atributosInputs.forEach(input => input.value = 0);
 [source: 519] pontosHabilidadeUsados = 0; experiencia = 0; nivel = 0; // Reset XP and level
                 pontosHabilidadeTotal = nivelData[nivel].pd;
 [source: 520] pontosHabilidadeUsados = 0; nivelSpan.textContent = nivel; pontosHabilidadeSpan.textContent = pontosHabilidadeTotal; vidaBase = 50;
                 velocidadeCorridaSpan.textContent = "25"; alturaPuloSpan.textContent = "1";
 [source: 521] distanciaPuloSpan.textContent = "3";
                 nomePersonagemInput.value = ""; descricaoPersonagemInput.value = ""; experienciaInput.value = 0;
 [source: 522] // Set XP input too
                 armaDireitaNomeInput.value = "";
 [source: 523] armaDireitaAtaqueInput.value = "0"; armaDireitaAtaqueMagicoInput.value = "0";
                 armaEsquerdaNomeInput.value = ""; armaEsquerdaAtaqueInput.value = "0"; armaEsquerdaAtaqueMagicoInput.value = "0";
                 magiasList.innerHTML = "";
 [source: 524] for (let i = 0; i < 10; i++) { const input = document.createElement("input"); input.type = "text"; input.className = "magia-nome";
 [source: 525] input.placeholder = `Magia/Habilidade ${i + 1}`; magiasList.appendChild(input); }
                 const slots = inventarioSlots.querySelectorAll(".inventory-slot");
 [source: 526] slots.forEach(slot => { slot.querySelector(".inventory-item").value = ""; slot.querySelector(".inventory-weight").value = "0"; });
                 characterImage.style.display = "none"; characterImage.src = ""; vantagensSelecionadas = [];
 [source: 527] desvantagensSelecionadas = []; racaSelecionada = null;
                 vantagensListDisplay.innerHTML = ""; desvantagensListDisplay.innerHTML = ""; anotacoesTextarea.value = "";
                 classeNomeInput.value = "";
 [source: 528] classeDescricaoInput.value = ""; racaNomeSpan.textContent = ""; racaDescricaoInput.value = "";
                 calcularAtributos();
 [source: 529] // Calculate based on zeroed stats
                 // Reset current HP/MP/Stamina to new totals
                 vidaAtual = vidaTotal;
 [source: 530] magiaAtual = magiaTotal; vigorAtual = vigorTotal;
                 document.getElementById("vida-atual").textContent = vidaAtual; document.getElementById("magia-atual").textContent = magiaAtual; document.getElementById("vigor-atual").textContent = vigorAtual.toFixed(1);
                 pontosVantagemSpan.textContent = getPontosVantagem();
 [source: 531] // Recalculate PH
                 salvarDados();
 [source: 532] }
         }

         bloquearFichaButton.onclick = () => {
             if (isFichaLocked) abrirModalSenha();
 [source: 533] else { document.getElementById("bloquear-ficha-modal").style.display = "flex"; document.getElementById("senha-bloqueio-input").value = ""; document.getElementById("senha-bloqueio-input").focus(); }
         };
 [source: 534] function bloquearFicha() {
             const senha = document.getElementById("senha-bloqueio-input").value;
 [source: 535] if (senha.length !== 4 || !/^\d{4}$/.test(senha)) return alert("A senha deve ter exatamente 4 dígitos numéricos!");
 [source: 536] // Removed disadvantage check here, can be done elsewhere if needed
             isFichaLocked = true;
 [source: 537] fichaPassword = senha;
             database.ref(`fichas/${currentFichaId}`).update({ isLocked: true, password: senha }).then(() => {
                 fecharModal("bloquear-ficha-modal"); alert("Ficha bloqueada com sucesso!"); atualizarBotaoBloquear();
             }).catch(error => console.error("Erro ao bloquear ficha:", error));
 [source: 538] }

         function abrirModalSenha(element = null) {
             document.getElementById("password-modal").style.display = "flex";
 [source: 539] document.getElementById("senha-desbloqueio-input").value = ""; document.getElementById("senha-desbloqueio-input").focus();
             if (element) document.getElementById("password-modal").dataset.elementId = element.id; else delete document.getElementById("password-modal").dataset.elementId;
 [source: 540] }

         function desbloquearFicha() {
             const senha = document.getElementById("senha-desbloqueio-input").value, modal = document.getElementById("password-modal"), elementId = modal.dataset.elementId;
 [source: 541] if (senha !== senhaMatriz && senha !== fichaPassword) return alert("Senha incorreta!");
             isFichaUnlocked = true;
 [source: 542] // Unlock temporarily
             if (currentFichaId !== "ficha-matriz" && senha !== senhaMatriz) {
                 // Ask if permanent unlock is desired
                 if(confirm("Senha correta! Deseja desbloquear a ficha permanentemente? (Cancelar para desbloqueio temporário)")) {
                     database.ref(`fichas/${currentFichaId}`).update({ isLocked: false, password: null }).then(() => {
   
 [source: 543]                        isFichaLocked = false; // Update local state
                          fichaPassword = null; // Update local state
                          fecharModal("password-modal"); alert("Ficha desbloqueada permanentemente!"); atualizarBotaoBloquear();
            
 [source: 544]               // Trigger original action if needed
                          if (elementId === "reset-pontos") resetarPontos(); else if (elementId === "recomecar") recomecarFicha();
                     }).catch(error => console.error("Erro ao desbloquear ficha:", error));
 [source: 545] } else {
                      fecharModal("password-modal");
 [source: 546] alert("Ficha desbloqueada temporariamente!");
                      // Trigger original action if needed
                      if (elementId === "reset-pontos") resetarPontos();
 [source: 547] else if (elementId === "recomecar") recomecarFicha();
                 }
             } else { // Using GM password or on Matrix sheet
                 fecharModal("password-modal");
 [source: 548] alert(`Ficha desbloqueada temporariamente ${senha === senhaMatriz ? 'com a senha matriz!' : ''}`);
 [source: 549] // Trigger original action if needed
                 if (elementId === "reset-pontos") resetarPontos();
 [source: 550] else if (elementId === "recomecar") recomecarFicha();
             }
         }


         function cancelarDesbloqueio() {
             const modal = document.getElementById("password-modal"), elementId = modal.dataset.elementId;
 [source: 551] // If an input triggered the lock, revert its value
             if (elementId && document.getElementById(elementId) && previousValues.has(document.getElementById(elementId))) {
                  document.getElementById(elementId).value = previousValues.get(document.getElementById(elementId)) ||
 [source: 552] "";
             }
             fecharModal("password-modal");
 [source: 553] }


         function verificarAlteracao(event) {
             const input = event.target;
 [source: 554] // Store previous value *before* checking lock, only if different from current
             const currentVal = input.value;
 [source: 555] if(!previousValues.has(input) || previousValues.get(input) !== currentVal) {
                  // Find the value just before the input event started (might require more complex handling like tracking focus/blur)
                  // For simplicity, let's assume the value before 'beforeinput' is the one to revert to.
 [source: 556] // This might not be perfect if multiple inputs happen quickly.
                  // Let's capture on focus instead.
 [source: 557] // Updated logic: Capture on focus, check lock on input.
 [source: 558] }

              // Check lock on actual input attempt
              if (isFichaLocked && !isFichaUnlocked) {
                  event.preventDefault();
 [source: 559] // Prevent the input
                  // Revert to stored value if possible (use value captured on focus)
                  input.value = previousValues.get(input) ||
 [source: 560] "";
                  abrirModalSenha(input); // Pass the input itself for context if needed
              } else {
                 // Update previous value *after* successful input allowed
                 // Handled by the 'input' event listener now
             }
         }

         document.querySelectorAll('input[type="text"],input[type="number"],textarea').forEach(input 
 [source: 561] => {
             input.addEventListener("focus", (event) => {
                 // Store value on focus to revert if needed
                 previousValues.set(event.target, event.target.value);
             });
             // Removed beforeinput listener, check lock directly on input attempt
           
 [source: 562]   input.addEventListener("input", (event) => { // Check lock on input
                 const inputTarget = event.target;
                 if (isFichaLocked && !isFichaUnlocked) {
                     // Prevent change and show password modal
                     inputTarget.value = previousValues.get(inputTarget) || ""; 
 [source: 563] // Revert
                     abrirModalSenha(inputTarget);
 [source: 564] } else {
                     // Allowed change, update previous value map for next potential revert
                     previousValues.set(inputTarget, inputTarget.value);
 [source: 565] // Trigger calculations and save
                     if (inputTarget.id === "experiencia") { experiencia = parseInt(inputTarget.value) ||
 [source: 566] 0; atualizarNivel(); }
                     else if (atributosInputs.includes(inputTarget)) { calcularAtributos();
 [source: 567] } // Check PH moved inside calculate
                     else if (inputTarget.id.includes("arma")) { calcularAtributos();
 [source: 568] }
                     // Handle inventory weight change separately if needed for peso total update
                     else if (inputTarget.classList.contains('inventory-weight')) { calcularPesoTotal();
 [source: 569] }

                     salvarDados();
 [source: 570] // Save on every valid input
                 }
             });
 [source: 571] });
         nomePersonagemInput.oninput = salvarDados; // Keep direct save for name


         characterImageInput.onchange = e => {
             const file = e.target.files[0];
 [source: 572] if (file) { const reader = new FileReader(); reader.onload = e => { characterImage.src = e.target.result; characterImage.style.display = "block"; salvarDados();
 [source: 573] }; reader.readAsDataURL(file); }
         };
 [source: 574] document.getElementById("excluir-ficha").onclick = () => {
             if (currentFichaId === "ficha-matriz") return alert("A ficha matriz não pode ser excluída!");
 [source: 575] if (isFichaLocked && !isFichaUnlocked) return abrirModalSenha(document.getElementById("excluir-ficha")); // Pass element
             if (confirm("Tem certeza que deseja excluir esta ficha?"))
                 database.ref(`fichas/${currentFichaId}`).remove().then(() => { currentFichaId = "ficha-matriz"; carregarFicha(currentFichaId); atualizarAbasFichas(); });
 [source: 576] };
         let isDragging = false, currentX = 0, currentY = 0, initialX, initialY;
 [source: 577] // Initialize currentX/Y
         // Get initial position on first load correctly
         document.addEventListener('DOMContentLoaded', () => {
             currentX = diceContainer.offsetLeft;
             currentY = diceContainer.offsetTop;
         });
 [source: 578] diceContainer.onmousedown = e => { isDragging = true; initialX = e.clientX - currentX; initialY = e.clientY - currentY;
 [source: 579] diceContainer.style.cursor = "grabbing"; };
         document.onmousemove = e => { if (isDragging) { e.preventDefault(); currentX = e.clientX - initialX;
 [source: 580] currentY = e.clientY - initialY; diceContainer.style.left = `${currentX}px`; diceContainer.style.top = `${currentY}px`; diceContainer.style.right = "auto"; } };
 [source: 581] document.onmouseup = () => { if(isDragging) {isDragging = false; diceContainer.style.cursor = "move";} };
 [source: 582] // Check isDragging before resetting cursor


         database.ref('dadosRolados').on('child_added', snapshot => { const dado = snapshot.val(); if (dado.fichaId !== currentFichaId) showNotification(`${dado.nomeFicha} rolou: ${dado.resultado}`, "normal-result"); });
 [source: 583] diceRoll.onclick = () => {
             if (isFichaLocked && !isFichaUnlocked) return abrirModalSenha(diceRoll);
 [source: 584] // Pass element
             diceRoll.textContent = "Rolling..."; diceResult.style.display = "none";
 [source: 585] diceRoll.classList.remove("critical-failure", "critical-success");
             setTimeout(() => {
                 const roll = Math.floor(Math.random() * 20) + 1, fichaNome = fichas[currentFichaId]?.nomeFicha || "Sem Nome";
                 diceRoll.textContent = roll; let notificationClass = "normal-result", notificationMsg = `${fichaNome} rolou: ${roll}`;
                 if (roll === 1) { diceRoll.classList.add("critical-failure"); notificationClass = "critical-failure"; notificationMsg = `${fichaNome} - FALHA CRÍTICA!`; }
          
 [source: 586]        else if (roll === 20) { diceRoll.classList.add("critical-success"); notificationClass = "critical-success"; notificationMsg = `${fichaNome} - SUCESSO CRÍTICO!`; }
                 else { diceResult.textContent = notificationMsg; diceResult.style.display = "block"; }
                 showNotification(notificationMsg, notificationClass);
                 const dadoRef = database.ref('dadosRolados').push(); dadoRef.set({ fichaId: currentFichaId, nomeFicha: fichaNome, resultado: roll });
          
 [source: 587]    }, 1000);
         };

         vantagensDesvantagensBtn.onclick = () => {
             if (isFichaLocked && !isFichaUnlocked) return abrirModalSenha(vantagensDesvantagensBtn);
 [source: 588] // Pass element
             tempVantagensSelecionadas = [...vantagensSelecionadas]; tempDesvantagensSelecionadas = [...desvantagensSelecionadas];
 [source: 589] vantagensDesvantagensPanel.style.display = "block"; document.getElementById("salvar-vantagens-btn").style.display = "none"; atualizarVantagensDesvantagensPanel();
         };
         fecharPaginaBtn.onclick = () => { vantagensDesvantagensPanel.style.display = "none"; };
 [source: 590] salvarVantagensBtn.onclick = () => { // Button specific to advantages panel
              document.getElementById("salvar-modal-texto").textContent = "Se salvar, as alterações de Vantagens/Desvantagens não poderão ser desfeitas.";
 [source: 591] document.getElementById("salvar-vantagens-modal").style.display = "flex";
         };
          salvarRacasBtn.onclick = () => { // Button specific to races panel
              document.getElementById("salvar-modal-texto").textContent = "Se salvar, a alteração de Raça não poderá ser desfeita.";
 [source: 592] document.getElementById("salvar-vantagens-modal").style.display = "flex";
         };

         // Combined Save Logic
         confirmarSalvarBtn.onclick = () => { // Use the specific ID
             if (racasPanel.style.display === "block") { // Save from Races panel
                 if (tempRacaSelecionada && tempRacaSelecionada !== racaSelecionada) {
                     const raca = racasData.find(r => r.nome === tempRacaSelecionada);
 [source: 593] // Re-verify PH just in case, using the temp state
                     if (raca && calcularPontosVantagemTemp() >= 0) {
                         racaSelecionada = tempRacaSelecionada;
 [source: 594] // Commit the temporary selection
                         racaNomeSpan.textContent = racaSelecionada.split(" (")[0];
                         racaDescricaoInput.value = raca.vantagens.join("\n\n");
                         salvarDados(); // Save the new permanent state
              
 [source: 595]            pontosVantagemSpan.textContent = getPontosVantagem(); // Update display based on new permanent state
                         racasPanel.style.display = "none";
                         fecharModal("salvar-vantagens-modal");
                         calcularAtributos(); // Recalculate based on 
 [source: 596] new state
                     } else if (raca){ // PH check failed
                         alert("Pontos de Vantagem insuficientes para confirmar esta raça!");
                         fecharModal("salvar-vantagens-modal"); // Close modal but don't close panel
           
 [source: 597]           } else { // Should not happen if selection logic is correct
                          fecharModal("salvar-vantagens-modal");
                          racasPanel.style.display = "none";
 [source: 598] }
                 } else { // No change in race selection
                     racasPanel.style.display = "none";
 [source: 599] fecharModal("salvar-vantagens-modal");
                 }
             } else { // Save from Advantages/Disadvantages panel
                 if (tempDesvantagensSelecionadas.length > 3) {
                      alert("Você pode ter no máximo 3 desvantagens!");
 [source: 600] return fecharModal("salvar-vantagens-modal"); // Close modal but don't close panel
                 }
                  // Check PH for advantages/disadvantages
                 if (calcularPontosVantagemTemp() < 0) {
                      alert("Pontos de Vantagem insuficientes com as vantagens selecionadas!");
 [source: 601] return fecharModal("salvar-vantagens-modal"); // Close modal but don't close panel
                 }

                 vantagensSelecionadas = [...tempVantagensSelecionadas];
 [source: 602] desvantagensSelecionadas = [...tempDesvantagensSelecionadas];
                 vantagensListDisplay.innerHTML = ""; desvantagensListDisplay.innerHTML = "";
                 vantagensSelecionadas.forEach(v => { const div = document.createElement("div"); div.textContent = v; div.className = "list-item"; div.onclick = () => removerVantagem(v); vantagensListDisplay.appendChild(div); });
 [source: 603] desvantagensSelecionadas.forEach(d => { const div = document.createElement("div"); div.textContent = d; div.className = "list-item"; div.onclick = () => removerDesvantagem(d); desvantagensListDisplay.appendChild(div); });
 [source: 604] pontosVantagemSpan.textContent = getPontosVantagem(); // Update based on new permanent state
                 salvarDados();
 [source: 605] vantagensDesvantagensPanel.style.display = "none";
                 fecharModal("salvar-vantagens-modal");
                 calcularAtributos();
             }
         };
 [source: 606] function atualizarVantagensDesvantagensPanel() {
             vantagensList.innerHTML = "<h3>Vantagens</h3>"; desvantagensList.innerHTML = "<h3>Desvantagens</h3>";
 [source: 607] vantagensData.forEach(v => {
                 const div = document.createElement("div"); div.className = "vantagem-item"; div.textContent = `${v.nome} - Custo: ${v.custo} PH - ${v.descricao}`;
                 if (tempVantagensSelecionadas.includes(v.nome)) div.classList.add("comprada");
                 div.onclick = () => {
                     if (vantagensSelecionadas.includes(v.nome)) alert("Vantagem salva só pode ser removida com 
 [source: 608] permissão do GM.");
                     else if (tempVantagensSelecionadas.includes(v.nome)) tempVantagensSelecionadas = tempVantagensSelecionadas.filter(t => t !== v.nome);
                     else {
                         if (v.restricao === "inicio" && nivel > 0) return alert("Compra dessa vantagem é somente no nível 0.");
         
 [source: 609]                  // Check PH before adding temporarily
                         if ((calcularPontosVantagemTemp() - v.custo) >= 0) tempVantagensSelecionadas.push(v.nome); else alert("PH insuficientes!");
                     }
                     atualizarVantagensDesvantagensPanel();
 [source: 610] document.getElementById("salvar-vantagens-btn").style.display = "block";
                 }; vantagensList.appendChild(div);
             });
             desvantagensData.forEach(d => {
                 const div = document.createElement("div"); div.className = "desvantagem-item"; div.textContent = `${d.nome} - Ganho: ${d.ganho} PH - ${d.descricao}`;
                 if (tempDesvantagensSelecionadas.includes(d.nome)) div.classList.add("comprada");
                 div.onclick = () => {
                     if (desvantagensSelecionadas.includes(d.nome)) alert("Desvantagem 
 [source: 611] salva só pode ser removida com permissão do GM.");
                     else if (tempDesvantagensSelecionadas.includes(d.nome)) tempDesvantagensSelecionadas = tempDesvantagensSelecionadas.filter(t => t !== d.nome);
                     else { if (tempDesvantagensSelecionadas.length < 3) tempDesvantagensSelecionadas.push(d.nome); else alert("Limite de 3 desvantagens!"); }
                     atualizarVantagensDesvantagensPanel(); document.getElementById("salvar-vantagens-btn").style.display = "block";
         
 [source: 612]         }; desvantagensList.appendChild(div);
             });
 [source: 613] document.getElementById("ph-temp").textContent = calcularPontosVantagemTemp();
         }

         function removerVantagem(v) {
             if (isFichaLocked && !isFichaUnlocked) return abrirModalSenha();
 [source: 614] if (confirm(`Deseja remover a vantagem "${v}"?`)) {
                 document.getElementById("senha-gm-modal").style.display = "flex";
 [source: 615] document.getElementById("senha-gm-input").value = "";
                 document.getElementById("confirmar-senha-gm-btn").onclick = () => {
                     if (document.getElementById("senha-gm-input").value === senhaMatriz) {
                         vantagensSelecionadas = vantagensSelecionadas.filter(t => t !== v);
 [source: 616] Array.from(vantagensListDisplay.children).find(div => div.textContent === v)?.remove();
                         pontosVantagemSpan.textContent = getPontosVantagem(); database.ref(`fichas/${currentFichaId}/vantagens`).set(vantagensSelecionadas.join("\n"));
                         fecharModal("senha-gm-modal"); calcularAtributos();
                     } else { alert("Senha do GM incorreta!"); fecharModal("senha-gm-modal");
 [source: 617] }
                 };
 [source: 618] }
         }
         function removerDesvantagem(d) {
             if (isFichaLocked && !isFichaUnlocked) return abrirModalSenha();
 [source: 619] if (confirm(`Deseja remover a desvantagem "${d}"?`)) {
                 document.getElementById("senha-gm-modal").style.display = "flex";
 [source: 620] document.getElementById("senha-gm-input").value = "";
                 document.getElementById("confirmar-senha-gm-btn").onclick = () => {
                     if (document.getElementById("senha-gm-input").value === senhaMatriz) {
                         desvantagensSelecionadas = desvantagensSelecionadas.filter(t => t !== d);
 [source: 621] Array.from(desvantagensListDisplay.children).find(div => div.textContent === d)?.remove();
                         pontosVantagemSpan.textContent = getPontosVantagem(); database.ref(`fichas/${currentFichaId}/desvantagens`).set(desvantagensSelecionadas.join("\n"));
                         fecharModal("senha-gm-modal"); calcularAtributos();
                     } else { alert("Senha do GM incorreta!"); fecharModal("senha-gm-modal");
 [source: 622] }
                 };
 [source: 623] }
         }

         function calcularPesoTotal() { pesoTotalSpan.textContent = Array.from(inventarioSlots.querySelectorAll(".inventory-weight")).reduce((total, weight) => total + (parseFloat(weight.value) || 0), 0).toFixed(1);
 [source: 624] }
         inventarioSlots.addEventListener("input", (event) => { if(event.target.classList.contains('inventory-weight')){ calcularPesoTotal(); salvarDados(); } });
 [source: 625] // Save when weight changes

         anotacoesBtn.onclick = () => { anotacoesTextarea.style.display = anotacoesTextarea.style.display === "block" ?
 [source: 626] "none" : "block"; };
         document.addEventListener('click', (event) => { if (anotacoesTextarea.style.display === "block" && !anotacoesTextarea.contains(event.target) && !anotacoesBtn.contains(event.target)) anotacoesTextarea.style.display = 'none'; });
 [source: 627] anotacoesTextarea.oninput = salvarDados;

         adicionarMagiaBtn.onclick = () => {
              if (isFichaLocked && !isFichaUnlocked) return abrirModalSenha(adicionarMagiaBtn);
 [source: 628] if (magiasList.children.length < 20) { const input = document.createElement("input"); input.type = "text"; input.className = "magia-nome";
 [source: 629] input.placeholder = `Magia/Habilidade ${magiasList.children.length + 1}`; magiasList.appendChild(input); input.addEventListener('input', salvarDados); /* Add listener */ salvarDados();
 [source: 630] } // Save after adding
             else alert("Limite de 20 magias/habilidades!");
 [source: 631] };
         // Add listener to initially loaded magic inputs too
         magiasList.querySelectorAll('.magia-nome').forEach(input => input.addEventListener('input', salvarDados));
 [source: 632] racasBtn.onclick = () => { if (isFichaLocked && !isFichaUnlocked) return abrirModalSenha(racasBtn); tempRacaSelecionada = racaSelecionada; atualizarRacasPanel(); racasPanel.style.display = "block";
 [source: 633] document.getElementById("salvar-racas-btn").style.display = "none"; };
         fecharRacasBtn.onclick = () => { racasPanel.style.display = "none"; };
 [source: 634] // Save button onclick handler is combined now (confirmarSalvarBtn)

         function atualizarRacasPanel() {
             racasList.innerHTML = "";
 [source: 635] racasData.forEach(r => {
                 const div = document.createElement("div"); div.className = "raca-item";
                 div.innerHTML = `<h3><span class="math-inline">\{r\.nome\}</h3\><p\></span>{r.descricao}</p><p><strong>Vantagens:</strong></p><ul>${r.vantagens.map(v => `<li>${v}</li>`).join("")}</ul>`;
                 if (tempRacaSelecionada === r.nome) div.classList.add("comprada");
                 div.onclick = () => {
                 
 [source: 636]     if (racaSelecionada && racaSelecionada !== r.nome) alert("Raça salva só pode ser alterada com permissão do GM.");
                     else if (tempRacaSelecionada === r.nome) { tempRacaSelecionada = null; } // Desselecionar
                     else { // Tentar selecionar
                         // Calcula 
 [source: 637] PH disponível *antes* de selecionar a nova raça (considerando remover a antiga temporária, se houver)
                         let phDisponivelParaNovaRaca = calcularPontosVantagemTemp() + (tempRacaSelecionada ? (racasData.find(ra => ra.nome === tempRacaSelecionada)?.custo ||
 [source: 638] 0) : 0);
                         if (phDisponivelParaNovaRaca >= r.custo) {
                             tempRacaSelecionada = r.nome;
 [source: 639] // Seleciona a nova raça temporariamente
                              document.getElementById("confirmar-compra-modal").style.display = "flex";
 [source: 640] document.getElementById("confirmar-compra-btn").onclick = () => {
                                  atualizarRacasPanel();
 [source: 641] // Re-render com a seleção temp
                                  document.getElementById("salvar-racas-btn").style.display = "block";
 [source: 642] // Habilita salvar
                                  fecharModal("confirmar-compra-modal");
 [source: 643] };
                         } else { alert("PH insuficientes!"); tempRacaSelecionada = null; } // Reset temp if PH fails
                     }
                     atualizarRacasPanel();
 [source: 644] // Re-render to show selection/deselection
                     document.getElementById("salvar-racas-btn").style.display = tempRacaSelecionada && tempRacaSelecionada !== racaSelecionada ?
 [source: 645] "block" : "none"; // Mostra botão salvar se mudou E É DIFERENTE DA SALVA
                 };
 [source: 646] racasList.appendChild(div);
             });
              // Atualiza PH temporário no painel de raças
              phTempRacaSpan.textContent = calcularPontosVantagemTemp();
 [source: 647] }


         function abrirModalRaca() { document.getElementById("raca-opcoes-modal").style.display = "flex";
 [source: 648] }
         function excluirRacaSelecionadaModal() {
             fecharModal('raca-opcoes-modal');
 [source: 649] if (isFichaLocked && !isFichaUnlocked) return abrirModalSenha();
             if (confirm("Tem certeza que deseja excluir a raça selecionada?")) {
                 document.getElementById("senha-gm-modal").style.display = "flex";
 [source: 650] document.getElementById("senha-gm-input").value = "";
                 document.getElementById("confirmar-senha-gm-btn").onclick = () => {
                     if (document.getElementById("senha-gm-input").value === senhaMatriz) {
                         racaSelecionada = null;
 [source: 651] tempRacaSelecionada = null; racaNomeSpan.textContent = ""; racaDescricaoInput.value = "";
                         pontosVantagemSpan.textContent = getPontosVantagem(); salvarDados(); fecharModal("senha-gm-modal"); calcularAtributos();
 [source: 652] } else { alert("Senha do GM incorreta!"); fecharModal("senha-gm-modal"); }
                 };
 [source: 653] }
         }
         function editarRacaSelecionadaModal() {
             if (isFichaLocked && !isFichaUnlocked) return abrirModalSenha();
 [source: 654] fecharModal('raca-opcoes-modal');
             document.getElementById("editar-raca-modal").style.display = "flex"; document.getElementById("editar-raca-nome").value = racaNomeSpan.textContent;
             document.getElementById("editar-raca-descricao").value = racaDescricaoInput.value;
 [source: 655] }
         function salvarEdicaoRaca() {
             if (isFichaLocked && !isFichaUnlocked) return abrirModalSenha();
 [source: 656] if (confirm("Tem certeza que deseja editar a raça selecionada?")) {
                 document.getElementById("senha-gm-modal").style.display = "flex";
 [source: 657] document.getElementById("senha-gm-input").value = "";
                 document.getElementById("confirmar-senha-gm-btn").onclick = () => {
                     if (document.getElementById("senha-gm-input").value === senhaMatriz) {
                         racaNomeSpan.textContent = document.getElementById("editar-raca-nome").value;
 [source: 658] racaDescricaoInput.value = document.getElementById("editar-raca-descricao").value;
                         fecharModal('editar-raca-modal'); salvarDados(); fecharModal("senha-gm-modal");
                     } else { alert("Senha do GM incorreta!"); fecharModal("senha-gm-modal");
 [source: 659] }
                 };
 [source: 660] }
         }

         classesBtn.onclick = () => { classesPanel.style.display = "block";
 [source: 661] };
         fecharClassesBtn.onclick = () => { classesPanel.style.display = "none"; };
         luaBtn.onclick = () => { document.body.classList.add("dark-mode"); salvarDados(); };
 [source: 662] // Save theme preference
         solBtn.onclick = () => { document.body.classList.remove("dark-mode"); salvarDados(); };
 [source: 663] // Save theme preference
         resetPontosButton.onclick = resetarPontos;
         recomecarButton.onclick = recomecarFicha;
 [source: 664] function showNotification(message, type) {
             notification.textContent = message;
 [source: 665] notification.className = type; notification.style.display = "block";
             setTimeout(() => { notification.style.display = "none"; notification.className = ""; }, 2000);
 [source: 666] }

         document.getElementById("historico-dados-btn").onclick = () => { document.getElementById("historico-dados-panel").style.display = "block"; };
 [source: 667] document.addEventListener('click', (event) => { const panel = document.getElementById("historico-dados-panel"); if (panel.style.display === "block" && !panel.contains(event.target) && !document.getElementById("historico-dados-btn").contains(event.target)) panel.style.display = "none"; });
 [source: 668] database.ref('dadosRolados').on('value', snapshot => { const dados = snapshot.val(), lista = document.getElementById("historico-lista"); lista.innerHTML = ""; if (dados) { const keys = Object.keys(dados).reverse(); /* Show newest first */ keys.forEach(key => { const dado = dados[key], div = document.createElement("div"); div.textContent = `${dado.nomeFicha} rolou: ${dado.resultado}`; lista.appendChild(div); });} });
 [source: 669] document.getElementById("excluir-historico-btn").onclick = () => { document.getElementById("senha-gm-modal").style.display = "flex"; document.getElementById("senha-gm-input").value = "";
 [source: 670] document.getElementById("confirmar-senha-gm-btn").onclick = () => { if (document.getElementById("senha-gm-input").value === senhaMatriz) { database.ref('dadosRolados').remove().then(() => { alert("Histórico de dados excluído!"); fecharModal("senha-gm-modal"); });
 [source: 671] } else { alert("Senha do GM incorreta!"); fecharModal("senha-gm-modal"); } }; };
 [source: 672] // Chat Functionality (unchanged)
         chatBtn.onclick = () => { if (!chatPassword) { document.getElementById("chat-password-modal").style.display = "flex";
 [source: 673] } else { document.getElementById("open-chat-modal").style.display = "flex"; } };
         function definirSenhaChat() { const senha = document.getElementById("chat-senha-input").value, confirmarSenha = document.getElementById("chat-confirmar-senha-input").value;
 [source: 674] if (senha !== confirmarSenha) return alert("As senhas não coincidem."); if (senha.length < 4) return alert("A senha deve ter pelo menos 4 caracteres.");
 [source: 675] chatPassword = senha; database.ref(`fichas/${currentFichaId}`).update({ chatPassword: senha }).then(() => { fecharModal("chat-password-modal"); alert("Senha do chat definida!"); atualizarEstadoChatBotao(); }).catch(error => console.error("Erro ao definir senha do chat:", error));
 [source: 676] }
         function abrirChat() { const senhaDigitada = document.getElementById("abrir-chat-senha-input").value;
 [source: 677] if (senhaDigitada === chatPassword) { fecharModal("open-chat-modal"); document.getElementById("chat-modal").style.display = "flex"; isChatOpen = true; selectedChatUser = null; document.getElementById("conversation-area").innerHTML = ""; marcarMensagensComoLidas();
 [source: 678] } else { alert("Senha do chat incorreta."); } } // Marcar como lidas ao abrir
         function atualizarEstadoChatBotao() { chatBtn.textContent = chatPassword ?
 [source: 679] "💬 Chat" : "💬 Definir Chat"; }
         function atualizarListaFichasChat() { availableFichasDiv.innerHTML = "";
 [source: 680] for (const fichaId in fichas) { if (fichaId !== "ficha-matriz" && fichaId !== currentFichaId) { const ficha = fichas[fichaId], userDiv = document.createElement("div");
 [source: 681] userDiv.className = "user-item"; userDiv.textContent = ficha.nomeFicha || "Sem Nome"; userDiv.dataset.fichaId = fichaId;
 [source: 682] userDiv.onclick = () => iniciarConversa(fichaId, ficha.nomeFicha || "Sem Nome"); availableFichasDiv.appendChild(userDiv);
 [source: 683] } } }
         function iniciarConversa(otherFichaId, otherFichaNome) { selectedChatUser = otherFichaId;
 [source: 684] document.getElementById("conversation-area").innerHTML = `<h3 style='text-align: center; font-family: MedievalSharp, serif;'>Conversa com ${otherFichaNome}</h3><div id="mensagens" style="flex-grow: 1; overflow-y: auto; display: flex; flex-direction: column-reverse;"></div>`;
 [source: 685] /* Reverse display */ carregarMensagens(otherFichaId); marcarMensagensComoLidas(otherFichaId); } // Marcar como lidas ao iniciar
         function enviarMensagem() { if (!selectedChatUser) return alert("Selecione uma ficha para enviar a mensagem.");
 [source: 686] const mensagem = mensagemInput.value.trim(); if (mensagem) { const chatRef = database.ref('mensagens').child(getChatId(currentFichaId, selectedChatUser)).push();
 [source: 687] chatRef.set({ senderId: currentFichaId, receiverId: selectedChatUser, content: mensagem, timestamp: firebase.database.ServerValue.TIMESTAMP, read: false }); mensagemInput.value = "";
 [source: 688] } } // Add read: false
         function carregarMensagens(otherFichaId) { const mensagensDiv = document.getElementById("mensagens");
 [source: 689] mensagensDiv.innerHTML = ''; /* Clear previous */ database.ref('mensagens').child(getChatId(currentFichaId, otherFichaId)).orderByChild('timestamp').on('child_added', snapshot => { const msgData = snapshot.val(), msgContainer = document.createElement("div"); msgContainer.className = "message-container"; const senderName = document.createElement("div"); senderName.className = "sender-name"; senderName.textContent = fichas[msgData.senderId]?.nomeFicha || 'Desconhecido'; const msgDiv = document.createElement("div"); msgDiv.className = `message ${msgData.senderId === currentFichaId ? 'sent' : 'received'}`; msgDiv.textContent = msgData.content; msgContainer.appendChild(senderName); msgContainer.appendChild(msgDiv); mensagensDiv.insertBefore(msgContainer, mensagensDiv.firstChild); /* Insert at top for reverse display */ });
 [source: 690] }
         function getChatId(id1, id2) { return id1 < id2 ? `<span class="math-inline">\{id1\}\_</span>{id2}` : `<span class="math-inline">\{id2\}\_</span>{id1}`;
 [source: 691] }
         function marcarMensagensComoLidas(otherUserId = null) { if (!currentFichaId) return;
 [source: 692] database.ref('mensagens').once('value', (snapshot) => { const updates = {}; snapshot.forEach((chat) => { const chatId = chat.key; if (chatId.includes(currentFichaId)) { const otherId = chatId.replace(currentFichaId, '').replace('_', ''); // Find other user in chat ID
          // Mark as read only if chat with specific user is open, or mark all if no specific user provided (e.g., initial load)
         if (!otherUserId || otherId === otherUserId) { chat.forEach((msgSnapshot) => { const msg = msgSnapshot.val(); if (msg.receiverId === currentFichaId && msg.senderId !== currentFichaId && !msg.read) { updates[`<span class="math-inline">\{chatId\}/</span>{msgSnapshot.key}/read`] = true; } }); } 
 [source: 693] } }); if (Object.keys(updates).length > 0) database.ref('mensagens').update(updates); }); }
         function verificarNovasMensagens() { if (!currentFichaId) return;
 [source: 694] database.ref('mensagens').on('value', (snapshot) => { let unreadCount = 0; let shouldPlaySound = false; snapshot.forEach((chat) => { const chatId = chat.key; if (chatId.includes(currentFichaId)) { chat.forEach((msgSnapshot) => { const msg = msgSnapshot.val(); if (msg.receiverId === currentFichaId && msg.senderId !== currentFichaId && !msg.read) { unreadCount++; // If chat isn't open OR chat is open but not with this sender
         if (!isChatOpen || (isChatOpen && selectedChatUser !== msg.senderId)) { shouldPlaySound = true; } } }); } }); chatBtn.dataset.unread = unreadCount > 0 ? unreadCount : 0; chatBtn.style.setProperty('--unread-count', `"${unreadCount}"`); // For potential CSS display
       
 [source: 695]   if (shouldPlaySound && document.getElementById("new-message-sound")) { newMessageSound.play().catch(e => console.log("Erro ao tocar som:", e)); } });
 [source: 696] }


         // <<< MODIFICADO: Funções de Background >>>
         planoFundoBtn.onclick = () => { backgroundModal.style.display = "flex";
 [source: 697] };
         function aplicarPlanoDeFundo() {
             const file = backgroundImageInput.files[0];
             if (file) {
                 const reader = new FileReader();
 [source: 698] reader.onload = e => {
                     const imageUrl = e.target.result;
                     document.body.style.backgroundImage = `url('${imageUrl}')`;
                     document.body.style.backgroundSize = 'cover'; // <<< FORÇADO: Sempre cover
                     document.body.style.backgroundAttachment = 'fixed'; // <<< FORÇADO: Sempre fixed
                     salvarDados();
 [source: 699] fecharModal('background-modal');
                 };
                 reader.readAsDataURL(file);
             } else {
                 // Se não selecionou novo arquivo, mas já existe um, apenas fecha o modal
                 // A opção de mudar o 'size' foi removida
                 if (document.body.style.backgroundImage !== 'none') {
                    fecharModal('background-modal');
                 } else {
                     alert("Nenhuma imagem selecionada.");
                 }
             }
         }

         function excluirPlanoDeFundo() {
             if (confirm("Remover imagem de fundo?")) {
                 document.body.style.backgroundImage = 'none';
                 document.body.style.backgroundAttachment = 'scroll'; // <<< Voltar ao padrão se remover
 [source: 701] salvarDados();
                 fecharModal('background-modal');
             }
         }

         function aplicarPlanoDeFundoInicial() {
             const bgImage = fichas[currentFichaId]?.backgroundImage;
             // Removido: const bgSize = fichas[currentFichaId]?.backgroundSize || 'cover';
             if (currentFichaId && fichas[currentFichaId] && bgImage) {
                 document.body.style.backgroundImage = `url('${bgImage}')`;
                 document.body.style.backgroundSize = 'cover'; // <<< FORÇADO: Sempre cover
                 document.body.style.backgroundAttachment = 'fixed'; // <<< FORÇADO: Sempre fixed
 [source: 702, 703] } else {
                  document.body.style.backgroundImage = 'none';
                  document.body.style.backgroundAttachment = 'scroll'; // <<< Voltar ao padrão
             }
         }


         // Background Color Functionality
         corFundoBtn.onclick = () => { backgroundColorSelector.style.display = backgroundColorSelector.style.display === 'none' ||
 [source: 704] backgroundColorSelector.style.display === '' ? 'flex' : 'none'; };
         backgroundColorSelector.addEventListener('click', (event) => { if (event.target.classList.contains('color-option')) { const color = event.target.dataset.color; document.body.style.backgroundColor = color; salvarDados(); backgroundColorSelector.style.display = 'none'; document.querySelectorAll('#background-color-selector .color-option').forEach(option => option.classList.remove('active')); event.target.classList.add('active'); } });
 [source: 705] function aplicarCorDeFundoInicial() { const bgColor = fichas[currentFichaId]?.backgroundColor; if (currentFichaId && fichas[currentFichaId] && bgColor) { document.body.style.backgroundColor = bgColor;
 [source: 706] document.querySelectorAll('#background-color-selector .color-option').forEach(option => { option.classList.toggle('active', option.dataset.color === bgColor); }); } else { document.body.style.backgroundColor = '#f0e6d2';
 [source: 707] /* Default color */ } }
         // Close color picker if clicking outside
         document.addEventListener('click', function(event) { if (!backgroundColorSelector.contains(event.target) && !corFundoBtn.contains(event.target)) { backgroundColorSelector.style.display = 'none'; } });
 [source: 708] carregarFichas();
     </script>
 </body>
 </html>
