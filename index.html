<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ficha de Personagem RPG</title>
    <link href="https://fonts.googleapis.com/css2?family=MedievalSharp&family=Inter:wght@400;600&display=swap"
        rel="stylesheet">
    <script src="https://unpkg.com/@tailwindcss/browser@4"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: #f5f5f5;
            color: #000;
            display: flex;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            background-image: url('medieval_background.jpg');
            background-size: cover;
            background-position: center;
            transition: background 0.3s, color 0.3s
        }

        body.dark-mode {
            background: #121212;
            color: #e0e0e0
        }

        #fichas-sidebar {
            width: 100%;
            height: 60px;
            padding: 0;
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: flex-start;
            position: fixed;
            top: 0;
            left: 0;
            z-index: 1000;
            overflow-x: auto;
            background: transparent
        }

        .ficha-tab {
            visibility: visible;
            width: 100px;
            height: 50px;
            background: #f0e6d2;
            border: 2px solid #b8860b;
            border-radius: 10px 10px 0 0;
            margin-right: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.2)
        }

        .ficha-tab:hover {
            background: #a0522d;
            transform: translateY(-5px)
        }

        .ficha-tab.active {
            background: #a0522d;
            transform: translateY(-5px)
        }

        .ficha-tab span {
            font-family: 'MedievalSharp', serif;
            color: #000;
            font-size: 0.9rem;
            text-align: center;
            max-width: 90px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap
        }

        #add-ficha-btn {
            width: 100px;
            height: 50px;
            background: #f0e6d2;
            border: 2px solid #b8860b;
            border-radius: 10px 10px 0 0;
            margin-right: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: transform 0.2s ease;
            box-shadow: 0 0 10px #ffd700, 0 0 20px #ffd700;
            z-index: 1001
        }

        #add-ficha-btn span {
            font-family: 'MedievalSharp', serif;
            color: #000;
            font-size: 0.9rem
        }

        #add-ficha-btn:hover {
            background: #a0522d;
            transform: translateY(-5px)
        }

        #ficha-container {
            background: rgba(240, 230, 210, 0.95);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
            width: 95%;
            max-width: 1200px;
            margin: 80px auto 20px;
            border: 2px solid #b8860b;
            position: relative
        }

        body.dark-mode #ficha-container {
            background: rgba(30, 30, 30, 0.95);
            color: #e0e0e0
        }

        #ficha-container.aura-azul {
            box-shadow: 0 0 30px 15px #00BFFF;
            animation: pulsar-aura 2s infinite
        }

        @keyframes pulsar-aura {
            0% {
                box-shadow: 0 0 20px #00BFFF, 0 0 30px #00BFFF, 0 0 40px #00BFFF
            }

            50% {
                box-shadow: 0 0 30px #00BFFF, 0 0 50px #00BFFF, 0 0 60px #00BFFF
            }

            100% {
                box-shadow: 0 0 20px #00BFFF, 0 0 30px #00BFFF, 0 0 40px #00BFFF
            }
        }

        h1#nome-personagem-titulo {
            font-family: 'MedievalSharp', serif;
            color: #1C2526;
            font-size: 3rem;
            margin-bottom: 20px;
            text-align: center;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
            animation: raios 2s infinite linear
        }

        @keyframes raios {
            0% {
                text-shadow: 0 0 5px #FFD700, 0 0 10px #FFD700, 0 0 15px #FFD700, 0 0 20px #FF4500
            }

            50% {
                text-shadow: 0 0 10px #FFD700, 0 0 15px #FFD700, 0 0 20px #FF4500, 0 0 25px #FF4500
            }

            100% {
                text-shadow: 0 0 5px #FFD700, 0 0 10px #FFD700, 0 0 15px #FFD700, 0 0 20px #FF4500
            }
        }

        #game-master-message {
            display: none;
            color: blue;
            font-size: 1.5rem;
            text-align: center;
            font-family: 'MedievalSharp', serif;
            margin-bottom: 10px
        }

        section {
            background: #f0e6d2;
            border: 2px solid #b8860b;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px
        }

        section h2 {
            text-align: center
        }

        body.dark-mode section {
            background: #1e1e1e;
            border-color: #444
        }

        label {
            font-weight: 600;
            color: #000;
            margin-bottom: 8px;
            display: block
        }

        body.dark-mode label {
            color: #e0e0e0
        }

        input[type="text"],
        input[type="number"],
        textarea {
            padding: 10px;
            border: 2px solid #b8860b;
            border-radius: 6px;
            width: calc(100% - 24px);
            margin-bottom: 15px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
            background: #fff;
            color: #000
        }

        body.dark-mode input[type="text"],
        body.dark-mode input[type="number"],
        body.dark-mode textarea {
            background: #333;
            color: #e0e0e0;
            border-color: #555
        }

        input[type="text"]:focus,
        input[type="number"]:focus,
        textarea:focus {
            border-color: #a0522d;
            outline: none;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1)
        }

        input[readonly],
        span[readonly] {
            background: #e8e8e8;
            border: 1px solid #ccc;
            cursor: not-allowed
        }

        body.dark-mode input[readonly],
        body.dark-mode span[readonly] {
            background: #444;
            border-color: #666
        }

        textarea {
            resize: vertical
        }

        .atributos-container {
            display: flex;
            justify-content: space-between;
            gap: 20px
        }

        .atributos-coluna,
        .atributos-coluna-destaque {
            width: 48%;
            display: flex;
            flex-direction: column;
            align-items: flex-start
        }

        .atributos-coluna-destaque {
            background: #fff;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #b8860b
        }

        body.dark-mode .atributos-coluna-destaque {
            background: #333;
            border-color: #555
        }

        .atributo-destaque {
            padding: 8px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%
        }

        .atributo-destaque label {
            font-size: 1.1rem;
            font-weight: 700;
            color: #a0522d
        }

        .atributo-destaque span {
            font-size: 1.2rem;
            font-family: 'MedievalSharp', serif;
            color: #000
        }

        body.dark-mode .atributo-destaque span {
            color: #e0e0e0
        }

        .atributo-fogo {
            animation: fogo 1.5s infinite
        }

        @keyframes fogo {
            0% {
                text-shadow: 0 0 5px #ff4500, 0 0 10px #ff4500
            }

            50% {
                text-shadow: 0 0 10px #ff4500, 0 0 15px #ffd700
            }

            100% {
                text-shadow: 0 0 5px #ff4500, 0 0 10px #ff4500
            }
        }

        .vida-magia-vigor {
            display: flex;
            justify-content: space-around;
            gap: 15px;
            flex-wrap: wrap
        }

        .atributo-container {
            background: rgba(255, 255, 255, 0.8);
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #b8860b;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            width: 30%;
            min-width: 200px;
            text-align: center
        }

        body.dark-mode .atributo-container {
            background: rgba(50, 50, 50, 0.8)
        }

        .atributo-container::before {
            font-size: 1.5rem;
            margin-bottom: 5px;
            display: block
        }

        .atributo-container.vida::before {
            content: "‚ù§Ô∏è"
        }

        .atributo-container.magia::before {
            content: "‚ú®"
        }

        .atributo-container.vigor::before {
            content: "‚ö°"
        }

        .medieval-box {
            background: #f0e6d2;
            border: 2px solid #b8860b;
            border-radius: 8px;
            padding: 10px;
            margin: 5px 0;
            text-align: center
        }

        body.dark-mode .medieval-box {
            background: #1e1e1e;
            border-color: #444
        }

        .regeneracao {
            font-size: 0.8rem;
            color: #555;
            margin-top: 5px
        }

        body.dark-mode .regeneracao {
            color: #aaa
        }

        button {
            background: #b8860b;
            color: #fff;
            border: none;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 1.2rem;
            border-radius: 4px;
            margin: 0 5px;
            transition: background-color 0.3s ease
        }

        body.dark-mode button {
            background: #555
        }

        button:hover {
            background: #a0522d
        }

        body.dark-mode button:hover {
            background: #777
        }

        .botoes-container {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px
        }

        .botao {
            padding: 12px 25px;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            font-family: 'MedievalSharp', serif;
            color: #fff;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3)
        }

        body.dark-mode .botao {
            background: #555
        }

        body.dark-mode .botao:hover {
            background: #777
        }

        .botao-reset {
            background: #b8860b
        }

        .botao-reset:hover {
            background: #a0522d;
            transform: translateY(-2px)
        }

        .botao-recomecar {
            background: #a52a2a
        }

        .botao-recomecar:hover {
            background: #8b0000;
            transform: translateY(-2px)
        }

        .botao-bloquear,
        .botao-desbloquear {
            background: #4a4a4a
        }

        .botao-bloquear:hover,
        .botao-desbloquear:hover {
            background: #2a2a2a;
            transform: translateY(-2px)
        }

        .botao-excluir {
            background: #a52a2a;
            position: absolute;
            bottom: 20px;
            left: 20px
        }

        .botao-excluir:hover {
            background: #8b0000;
            transform: translateY(-2px)
        }

        #nivel-container {
            text-align: center;
            margin-top: 10px
        }

        #nivel {
            padding: 10px;
            background: #f0e6d2;
            border: 3px solid #000;
            border-radius: 50%;
            width: 100px;
            height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3.125rem;
            box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.5);
            margin: 0 auto
        }

        body.dark-mode #nivel {
            background: #1e1e1e;
            border-color: #444
        }

        #nivel.aura-azul {
            animation: pulsar-aura 2s 10
        }

        .expandable-textarea {
            height: 100px;
            width: 100%;
            background: #fff;
            border: 2px solid #b8860b;
            border-radius: 6px;
            padding: 10px;
            font-size: 0.9rem;
            transition: height 0.3s ease
        }

        body.dark-mode .expandable-textarea {
            background: #333
        }

        .expandable-textarea:focus {
            height: 15cm
        }

        #dice-container {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 200px;
            text-align: center;
            font-family: 'MedievalSharp', serif;
            cursor: move;
            z-index: 10;
            user-select: none
        }

        #dice-container label {
            font-size: 1.2rem;
            color: #000;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 10px
        }

        body.dark-mode #dice-container label {
            color: #e0e0e0
        }

        #dice-container label::before {
            content: "üé≤";
            margin-right: 5px;
            font-size: 1.5rem
        }

        #dice-roll {
            width: 100px;
            height: 100px;
            background: #f0e6d2;
            border: 2px solid #b8860b;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            cursor: pointer;
            margin: 0 auto;
            position: relative;
            transition: all 0.3s ease
        }

        body.dark-mode #dice-roll {
            background: #1e1e1e;
            border-color: #444
        }

        #dice-roll::before {
            content: "‚öÖ";
            font-size: 1.5rem;
            position: absolute;
            top: 5px;
            right: 5px;
            color: #a0522d
        }

        #dice-result {
            margin-top: 10px;
            font-size: 1rem;
            color: #000;
            display: none;
            animation: blink 1s infinite
        }

        body.dark-mode #dice-result {
            color: #e0e0e0
        }

        @keyframes blink {
            50% {
                opacity: 0
            }
        }

        #dice-roll.critical-failure {
            animation: aura-vermelha 2s infinite
        }

        #dice-roll.critical-success {
            animation: aura-verde 2s infinite
        }

        @keyframes aura-vermelha {
            0% {
                box-shadow: 0 0 5px #ff0000, 0 0 10px #ff0000
            }

            50% {
                box-shadow: 0 0 15px #ff0000, 0 0 20px #ff0000
            }

            100% {
                box-shadow: 0 0 5px #ff0000, 0 0 10px #ff0000
            }
        }

        @keyframes aura-verde {
            0% {
                box-shadow: 0 0 5px #00ff00, 0 0 10px #00ff00
            }

            50% {
                box-shadow: 0 0 15px #00ff00, 0 0 20px #00ff00
            }

            100% {
                box-shadow: 0 0 5px #00ff00, 0 0 10px #00ff00
            }
        }

        #notification {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 20px;
            border-radius: 8px;
            font-family: 'MedievalSharp', serif;
            font-size: 1.5rem;
            color: #fff;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
            display: none;
            z-index: 100;
            background: rgba(0, 0, 0, 0.7);
            transition: opacity 0.3s ease
        }

        #notification.critical-failure {
            background: rgba(255, 0, 0, 0.8);
            animation: aura-vermelha 2s infinite
        }

        #notification.critical-success {
            background: rgba(0, 255, 0, 0.8);
            animation: aura-verde 2s infinite
        }

        #notification.normal-result,
        #notification.save-success {
            animation: blink 1s infinite
        }

        #notification.save-success {
            background: rgba(0, 200, 0, 0.8)
        }

        #character-image-container {
            position: absolute;
            top: 10px;
            left: 10px;
            width: 100px;
            height: 100px;
            background: #f0e6d2;
            border: 2px solid #b8860b;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            overflow: hidden;
            z-index: 10
        }

        body.dark-mode #character-image-container {
            background: #1e1e1e
        }

        #character-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: none
        }

        #character-image-container:hover {
            box-shadow: 0 0 10px #ffd700
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000
        }

        .modal-content {
            background: #f0e6d2;
            padding: 20px;
            border-radius: 8px;
            border: 2px solid #b8860b;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            width: 300px;
            text-align: center
        }

        body.dark-mode .modal-content {
            background: #1e1e1e;
            border-color: #444
        }

        .modal-content h3 {
            font-family: 'MedievalSharp', serif;
            color: #000;
            margin-bottom: 15px
        }

        body.dark-mode .modal-content h3 {
            color: #e0e0e0
        }

        .modal-content input {
            width: calc(100% - 20px);
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #ccc;
            border-radius: 6px
        }

        body.dark-mode .modal-content input {
            background: #333;
            color: #e0e0e0;
            border-color: #555
        }

        .modal-content button {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-family: 'MedievalSharp', serif;
            color: #fff;
            cursor: pointer;
            margin: 0 5px
        }

        .modal-content .confirm-btn {
            background: #b8860b
        }

        .modal-content .confirm-btn:hover {
            background: #a0522d
        }

        .modal-content .cancel-btn {
            background: #a52a2a
        }

        .modal-content .cancel-btn:hover {
            background: #8b0000
        }

        #vantagens-desvantagens-btn,
        #racas-btn,
        #classes-btn {
            padding: 10px 20px;
            background: #f0e6d2;
            border: 2px solid #b8860b;
            border-radius: 6px;
            font-family: 'MedievalSharp', serif;
            font-size: 1rem;
            color: #000;
            cursor: pointer;
            transition: background-color 0.3s ease;
            z-index: 10
        }

        body.dark-mode #vantagens-desvantagens-btn,
        body.dark-mode #racas-btn,
        body.dark-mode #classes-btn {
            background: #1e1e1e;
            color: #e0e0e0
        }

        #vantagens-desvantagens-btn:hover,
        #racas-btn:hover,
        #classes-btn:hover {
            background: #a0522d;
            color: #fff
        }

        #vantagens-desvantagens-panel,
        #racas-panel,
        #classes-panel {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(240, 230, 210, 0.95);
            padding: 20px;
            overflow-y: auto;
            z-index: 999;
            border: 2px solid #b8860b;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.3)
        }

        body.dark-mode #vantagens-desvantagens-panel,
        body.dark-mode #racas-panel,
        body.dark-mode #classes-panel {
            background: rgba(30, 30, 30, 0.95)
        }

        #vantagens-desvantagens-panel h2,
        #racas-panel h2,
        #classes-panel h2 {
            font-family: 'MedievalSharp', serif;
            font-size: 2rem;
            text-align: center;
            color: #a0522d;
            margin-bottom: 20px
        }

        #racas-panel h2 {
            font-size: 3rem
        }

        .vantagem-item,
        .desvantagem-item,
        .raca-item {
            padding: 10px;
            margin: 5px 0;
            background: #fff;
            border: 1px solid #ccc;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.3s ease
        }

        body.dark-mode .vantagem-item,
        body.dark-mode .desvantagem-item,
        body.dark-mode .raca-item {
            background: #333;
            border-color: #555
        }

        .vantagem-item:hover,
        .desvantagem-item:hover,
        .raca-item:hover {
            background: #f0e6d2
        }

        body.dark-mode .vantagem-item:hover,
        body.dark-mode .desvantagem-item:hover,
        body.dark-mode .raca-item:hover {
            background: #444
        }

        .vantagem-item.comprada,
        .raca-item.comprada {
            background: #ffcccc;
            color: #f00;
            cursor: default
        }

        .desvantagem-item.comprada {
            background: #ccffcc;
            color: #080;
            cursor: default
        }

        #salvar-vantagens-btn,
        #salvar-racas-btn,
        #fechar-pagina-btn,
        #fechar-racas-btn,
        #fechar-classes-btn {
            position: fixed;
            bottom: 20px;
            padding: 12px 25px;
            background: #a52a2a;
            color: #fff;
            border: none;
            border-radius: 6px;
            font-family: 'MedievalSharp', serif;
            font-size: 1.2rem;
            cursor: pointer;
            transition: transform 0.2s ease
        }

        #salvar-vantagens-btn,
        #salvar-racas-btn {
            right: 250px;
            animation: aura-verde-btn 2s infinite;
            display: none;
            background: #000
        }

        #fechar-pagina-btn,
        #fechar-racas-btn,
        #fechar-classes-btn {
            right: 20px
        }

        #salvar-vantagens-btn:hover,
        #salvar-racas-btn:hover,
        #fechar-pagina-btn:hover,
        #fechar-racas-btn:hover,
        #fechar-classes-btn:hover {
            transform: translateY(-2px)
        }

        @keyframes aura-verde-btn {
            0% {
                box-shadow: 0 0 5px #00ff00, 0 0 10px #00ff00
            }

            50% {
                box-shadow: 0 0 15px #00ff00, 0 0 20px #00ff00
            }

            100% {
                box-shadow: 0 0 5px #00ff00, 0 0 10px #00ff00
            }
        }

        .locomotion-container {
            background: #8B4513;
            border: 3px solid #FFD700;
            border-radius: 10px;
            padding: 15px;
            color: #FFD700;
            font-family: 'MedievalSharp', serif
        }

        .locomotion-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px
        }

        .locomotion-item label {
            font-weight: bold;
            color: #FFD700
        }

        .locomotion-item span {
            font-size: 1.2rem;
            color: #FFF;
            text-shadow: 1px 1px 2px #000;
            margin-left: 5px;
            font-weight: bold
        }

        #distancia-pulo,
        #altura-pulo,
        #velocidade-corrida {
            background-color: #8B4513;
            border-color: #8B4513
        }

        .list-display {
            background: #fff;
            border: 2px solid #b8860b;
            border-radius: 6px;
            padding: 10px;
            min-height: 100px;
            max-height: 200px;
            overflow-y: auto
        }

        body.dark-mode .list-display {
            background: #333;
            border-color: #555
        }

        .list-item {
            cursor: pointer;
            margin-bottom: 5px;
            padding: 5px;
            border-bottom: 1px solid #ccc
        }

        body.dark-mode .list-item {
            border-color: #555
        }

        .list-item:hover {
            background: #e0e0e0
        }

        body.dark-mode .list-item:hover {
            background: #444
        }

        .inventory-slot {
            display: flex;
            align-items: center;
            margin-bottom: 10px
        }

        .inventory-slot input[type="text"] {
            flex-grow: 1;
            margin-right: 10px
        }

        .inventory-slot input[type="number"] {
            width: 60px
        }

        #anotacoes-btn {
            position: fixed;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            padding: 10px 20px;
            background: #f0e6d2;
            border: 2px solid #b8860b;
            border-radius: 6px;
            font-family: 'MedievalSharp', serif;
            font-size: 1rem;
            color: #000;
            cursor: pointer;
            transition: background-color 0.3s ease
        }

        body.dark-mode #anotacoes-btn {
            background: #1e1e1e;
            color: #e0e0e0
        }

        #anotacoes-btn:hover {
            background: #a0522d;
            color: #fff
        }

        #anotacoes-textarea {
            display: none;
            position: fixed;
            left: 60px;
            top: 50%;
            transform: translateY(-50%);
            width: 400px;
            height: 400px;
            background: #fff;
            border: 2px solid #b8860b;
            border-radius: 6px;
            padding: 10px;
            font-size: 0.9rem;
            resize: none
        }

        body.dark-mode #anotacoes-textarea {
            background: #333;
            color: #e0e0e0
        }

        #historico-dados-btn {
            position: fixed;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            padding: 10px 20px;
            background: #f0e6d2;
            border: 2px solid #b8860b;
            border-radius: 6px;
            font-family: 'MedievalSharp', serif;
            font-size: 1rem;
            color: #000;
            cursor: pointer;
            transition: background-color 0.3s ease
        }

        body.dark-mode #historico-dados-btn {
            background: #1e1e1e;
            color: #e0e0e0
        }

        #historico-dados-btn:hover {
            background: #a0522d;
            color: #fff
        }

        #historico-dados-panel {
            display: none;
            position: fixed;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            width: 300px;
            background: #fff;
            border: 2px solid #b8860b;
            border-radius: 6px;
            padding: 10px;
            max-height: 400px;
            overflow-y: auto
        }

        body.dark-mode #historico-dados-panel {
            background: #333;
            border-color: #555
        }

        #historico-dados-panel h3 {
            font-family: 'MedievalSharp', serif;
            color: #000;
            margin-bottom: 10px
        }

        body.dark-mode #historico-dados-panel h3 {
            color: #e0e0e0
        }

        #historico-lista div {
            padding: 5px;
            border-bottom: 1px solid #ccc
        }

        body.dark-mode #historico-lista div {
            border-color: #555
        }

        #excluir-historico-btn {
            background: #a52a2a;
            color: #fff;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            margin-top: 10px
        }

        #excluir-historico-btn:hover {
            background: #8b0000
        }

        .magias-container {
            max-height: 300px;
            overflow-y: auto;
            border: 2px solid #b8860b;
            border-radius: 6px;
            padding: 10px;
            background: #fff
        }

        body.dark-mode .magias-container {
            background: #333;
            border-color: #555
        }

        .magias-container input {
            margin-bottom: 10px
        }

        #adicionar-magia-btn {
            background: #b8860b;
            color: #fff;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            display: block;
            margin-top: 10px
        }

        #adicionar-magia-btn:hover {
            background: #a0522d
        }

        .classe-raca-container {
            background: #f0e6d2;
            border: 2px solid #b8860b;
            padding: 10px;
            border-radius: 6px;
            margin-top: 10px
        }

        body.dark-mode .classe-raca-container {
            background: #1e1e1e;
            border-color: #444
        }

        .classe-raca-container label {
            font-family: 'MedievalSharp', serif;
            color: #a0522d;
            font-size: 1.2rem
        }

        .classe-raca-container span[onclick] {
            background: #fff;
            border: 2px solid #b8860b;
            padding: 10px;
            cursor: pointer;
            display: block
        }

        body.dark-mode .classe-raca-container span[onclick] {
            background: #333;
            color: #e0e0e0
        }

        .classe-raca-container textarea {
            width: 100%;
            background: #fff;
            border: 2px solid #b8860b
        }

        body.dark-mode .classe-raca-container textarea {
            background: #333;
            color: #e0e0e0
        }

        .raca-item {
            margin-bottom: 20px;
            padding: 10px;
            background: #fff;
            border: 2px solid #b8860b;
            border-radius: 6px
        }

        .raca-item h3 {
            font-family: 'MedievalSharp', serif;
            font-size: 1.5rem;
            color: #a0522d
        }

        .raca-item p {
            font-size: 1rem;
            color: #000
        }

        body.dark-mode .raca-item {
            background: #333;
            border-color: #555
        }

        body.dark-mode .raca-item p {
            color: #e0e0e0
        }

        @media (max-width: 768px) {
            body {
                padding: 10px
            }

            #ficha-container {
                padding: 15px
            }

            h1#nome-personagem-titulo {
                font-size: 2rem
            }

            section h2 {
                font-size: 1.2rem
            }

            input,
            textarea {
                font-size: 0.9rem
            }

            .atributos-container,
            .vida-magia-vigor {
                flex-direction: column
            }

            .atributos-coluna,
            .atributos-coluna-destaque,
            .atributo-container {
                width: 100%
            }
        }
    </style>
</head>

<body>
    <div id="fichas-sidebar">
        <div id="add-ficha-btn"><span>+ Fichas</span></div>
    </div>

    <div id="ficha-container">
        <h1 id="nome-personagem-titulo">Ficha de Personagem</h1>
        <div id="game-master-message">Voc√™ virou o Game Master</div>

        <div id="character-image-container" onclick="document.getElementById('character-image-input').click()">
            <img id="character-image" alt="Imagem do Personagem">
            <input type="file" id="character-image-input" accept="image/*" style="display:none">
        </div>

        <div id="dice-container">
            <label>Role seu dado:</label>
            <div id="dice-roll">-</div>
            <div id="dice-result"></div>
        </div>

        <div id="ficha-content">
            <section id="informacoes-basicas">
                <h2>Informa√ß√µes B√°sicas</h2>
                <label for="nome-personagem">Nome do Personagem:</label>
                <input type="text" id="nome-personagem" placeholder="Digite o nome do seu personagem">

                <label for="descricao-personagem">Descri√ß√£o do Personagem:</label>
                <textarea id="descricao-personagem" placeholder="Digite a descri√ß√£o do seu personagem"></textarea>
            </section>

            <section id="recursos">
                <h2>Recursos</h2>
                <div class="vida-magia-vigor">
                    <div class="atributo-container vida">
                        <h3>Vida</h3>
                        <div class="valor-total medieval-box">
                            <span>Vida Total: </span>
                            <span id="vida-total" readonly>50</span>
                        </div>
                        <div class="valor-atual medieval-box">
                            <span>Vida Atual: </span>
                            <button onclick="diminuirVida()" title="Diminuir Vida">‚ñº</button>
                            <span id="vida-atual">50</span>
                            <button onclick="aumentarVida()" title="Aumentar Vida">‚ñ≤</button>
                        </div>
                        <div class="regeneracao">
                            <span>Regenera√ß√£o por turno: <span id="regeneracao-vida">0</span> (parado)</span>
                        </div>
                    </div>

                    <div class="atributo-container magia">
                        <h3>Magia</h3>
                        <div class="valor-total medieval-box">
                            <span>Magia Total: </span>
                            <span id="magia-total" readonly>20</span>
                        </div>
                        <div class="valor-atual medieval-box">
                            <span>Magia Atual: </span>
                            <button onclick="diminuirMagia()" title="Diminuir Magia">‚ñº</button>
                            <span id="magia-atual">20</span>
                            <button onclick="aumentarMagia()" title="Aumentar Magia">‚ñ≤</button>
                        </div>
                        <div class="regeneracao">
                            <span>Regenera√ß√£o por turno: <span id="regeneracao-magia">0</span></span>
                        </div>
                    </div>

                    <div class="atributo-container vigor">
                        <h3>Vigor</h3>
                        <div class="valor-total medieval-box">
                            <span>Vigor Total: </span>
                            <span id="vigor-total" readonly>10</span>
                        </div>
                        <div class="valor-atual medieval-box">
                            <span>Vigor Atual: </span>
                            <button onclick="diminuirVigor()" title="Diminuir Vigor">‚ñº</button>
                            <span id="vigor-atual">10</span>
                            <button onclick="aumentarVigor()" title="Aumentar Vigor">‚ñ≤</button>
                        </div>
                        <div class="regeneracao">
                            <span>Regenera√ß√£o por turno: <span id="regeneracao-vigor">0</span> (parado)</span>
                        </div>
                    </div>
                </div>
            </section>

            <section id="atributos">
                <h2>Atributos</h2>
                <div class="atributos-container">
                    <div class="atributos-coluna">
                        <div class="atributo">
                            <label for="forca" title="Afeta ataque e RDF">For√ßa:</label>
                            <input type="number" id="forca" value="0" min="0">
                        </div>

                        <div class="atributo">
                            <label for="destreza" title="Afeta ataque e acerto">Destreza:</label>
                            <input type="number" id="destreza" value="0" min="0">
                        </div>

                        <div class="atributo">
                            <label for="agilidade" title="Afeta esquiva e acerto">Agilidade:</label>
                            <input type="number" id="agilidade" value="0" min="0">
                        </div>

                        <div class="atributo">
                            <label for="constituicao" title="Afeta vida, magia e vigor">Constitui√ß√£o:</label>
                            <input type="number" id="constituicao" value="0" min="0">
                        </div>

                        <div class="atributo">
                            <label for="inteligencia" title="Afeta ataque m√°gico e RDM">Intelig√™ncia:</label>
                            <input type="number" id="inteligencia" value="0" min="0">
                        </div>
                    </div>

                    <div class="atributos-coluna-destaque">
                        <div class="atributo-destaque">
                            <label>Ataque:</label>
                            <span id="ataque" readonly>0</span>
                        </div>
                        <div class="atributo-destaque">
                            <label>Ataque M√°gico:</label>
                            <span id="ataque-magico" readonly>0</span>
                        </div>
                        <div class="atributo-destaque">
                            <label>Acerto:</label>
                            <span id="acerto" readonly>0</span>
                        </div>
                        <div class="atributo-destaque">
                            <label>Esquiva:</label>
                            <span id="esquiva" readonly>0</span>
                        </div>
                        <div class="atributo-destaque">
                            <label>RDF:</label>
                            <span id="rdf" readonly>0</span>
                        </div>
                        <div class="atributo-destaque">
                            <label>RDM:</label>
                            <span id="rdm" readonly>0</span>
                        </div>
                    </div>
                </div>
            </section>

            <section id="combate">
                <h2>Combate</h2>
                <div class="armamento-container">
                    <div class="armamento-coluna">
                        <label>Armamento M√£o Direita:</label>
                        <div class="flex items-center mb-2">
                            <input type="text" id="arma-direita-nome" placeholder="Nome da Arma" class="mr-2">
                            <span>Ataque </span>
                            <input type="number" id="arma-direita-ataque" value="0" class="w-20 mr-2">
                            <span>Ataque M√°gico </span>
                            <input type="number" id="arma-direita-ataque-magico" value="0" class="w-20">
                        </div>
                    </div>
                    <div class="armamento-coluna">
                        <label>Armamento M√£o Esquerda:</label>
                        <div class="flex items-center">
                            <input type="text" id="arma-esquerda-nome" placeholder="Nome da Arma" class="mr-2">
                            <span>Ataque </span>
                            <input type="number" id="arma-esquerda-ataque" value="0" class="w-20 mr-2">
                            <span>Ataque M√°gico </span>
                            <input type="number" id="arma-esquerda-ataque-magico" value="0" class="w-20">
                        </div>
                    </div>
                </div>
            </section>

            <section id="inventario-habilidades">
                <h2>Invent√°rio e Habilidades</h2>
                <div class="flex gap-20">
                    <div style="width:50%">
                        <label>Invent√°rio (Peso Total: <span id="peso-total">0</span> kg):</label>
                        <div id="inventario-slots">
                            <div class="inventory-slot">
                                <input type="text" placeholder="Item 1" class="inventory-item">
                                <input type="number" min="0" value="0" class="inventory-weight" title="Peso em kg">
                            </div>
                            <div class="inventory-slot">
                                <input type="text" placeholder="Item 2" class="inventory-item">
                                <input type="number" min="0" value="0" class="inventory-weight">
                            </div>
                            <div class="inventory-slot">
                                <input type="text" placeholder="Item 3" class="inventory-item">
                                <input type="number" min="0" value="0" class="inventory-weight">
                            </div>
                            <div class="inventory-slot">
                                <input type="text" placeholder="Item 4" class="inventory-item">
                                <input type="number" min="0" value="0" class="inventory-weight">
                            </div>
                            <div class="inventory-slot">
                                <input type="text" placeholder="Item 5" class="inventory-item">
                                <input type="number" min="0" value="0" class="inventory-weight">
                            </div>
                            <div class="inventory-slot">
                                <input type="text" placeholder="Item 6" class="inventory-item">
                                <input type="number" min="0" value="0" class="inventory-weight">
                            </div>
                            <div class="inventory-slot">
                                <input type="text" placeholder="Item 7" class="inventory-item">
                                <input type="number" min="0" value="0" class="inventory-weight">
                            </div>
                            <div class="inventory-slot">
                                <input type="text" placeholder="Item 8" class="inventory-item">
                                <input type="number" min="0" value="0" class="inventory-weight">
                            </div>
                            <div class="inventory-slot">
                                <input type="text" placeholder="Item 9" class="inventory-item">
                                <input type="number" min="0" value="0" class="inventory-weight">
                            </div>
                            <div class="inventory-slot">
                                <input type="text" placeholder="Item 10" class="inventory-item">
                                <input type="number" min="0" value="0" class="inventory-weight">
                            </div>
                        </div>
                    </div>

                    <div style="width:50%">
                        <label>Magias e Habilidades:</label>
                        <div id="magias-list" class="magias-container">
                            <input type="text" placeholder="Magia/Habilidade 1" class="magia-nome">
                            <input type="text" placeholder="Magia/Habilidade 2" class="magia-nome">
                            <input type="text" placeholder="Magia/Habilidade 3" class="magia-nome">
                            <input type="text" placeholder="Magia/Habilidade 4" class="magia-nome">
                            <input type="text" placeholder="Magia/Habilidade 5" class="magia-nome">
                            <input type="text" placeholder="Magia/Habilidade 6" class="magia-nome">
                            <input type="text" placeholder="Magia/Habilidade 7" class="magia-nome">
                            <input type="text" placeholder="Magia/Habilidade 8" class="magia-nome">
                            <input type="text" placeholder="Magia/Habilidade 9" class="magia-nome">
                            <input type="text" placeholder="Magia/Habilidade 10" class="magia-nome">
                        </div>
                        <button id="adicionar-magia-btn">Adicionar Magia</button>
                    </div>
                </div>

                <div class="mt-4">
                    <label>Vantagens:</label>
                    <div id="vantagens-list-display" class="list-display"></div>
                    <label>Desvantagens:</label>
                    <div id="desvantagens-list-display" class="list-display"></div>
                </div>

                <div class="classe-raca-container">
                    <label>Classe:</label>
                    <input type="text" id="classe-nome" placeholder="Nome da Classe">
                    <textarea id="classe-descricao" placeholder="Descri√ß√£o da Classe"
                        class="expandable-textarea"></textarea>

                    <label>Ra√ßa:</label>
                    <span id="raca-nome" onclick="abrirModalRaca()"></span>
                    <textarea id="raca-descricao" placeholder="Descri√ß√£o da Ra√ßa" class="expandable-textarea"
                        readonly></textarea>
                </div>
            </section>

            <section id="locomocao">
                <h2>Locomo√ß√£o</h2>
                <div class="locomotion-container">
                    <div class="locomotion-item">
                        <label>Velocidade de Corrida (km/h):</label>
                        <span>üèÉ‚Äç‚ôÇÔ∏è</span>
                        <span id="velocidade-corrida" readonly>25</span>
                    </div>
                    <div class="locomotion-item">
                        <label>Altura do Pulo (m):</label>
                        <span>‚¨ÜÔ∏è</span>
                        <span id="altura-pulo" readonly>1</span>
                    </div>
                    <div class="locomotion-item">
                        <label>Dist√¢ncia do Pulo (m):</label>
                        <span>‚û°Ô∏è</span>
                        <span id="distancia-pulo" readonly>3</span>
                    </div>
                </div>
            </section>

            <section id="status">
                <h2>Status</h2>
                <div class="flex gap-20">
                    <div>
                        <label>Experi√™ncia:</label>
                        <input type="number" id="experiencia" value="0" min="0">
                        <label>Pontos de Habilidade (PD):</label>
                        <span id="pontos-habilidade" readonly>25</span>
                        <label>Pontos de Vantagem (PH):</label>
                        <span id="pontos-vantagem" readonly>8</span>
                    </div>
                    <div>
                    </div>
                </div>
                <div id="nivel-container">
                    <label>N√≠vel:</label>
                    <span id="nivel">0</span>
                </div>
            </section>

            <div style="display:flex;justify-content:center;gap:20px;margin-bottom:20px">
                <button id="vantagens-desvantagens-btn">Vantagens e Desvantagens</button>
                <button id="racas-btn">Ra√ßas üè∞</button>
                <button id="classes-btn">Classes ‚öîÔ∏è</button>
            </div>

            <div class="botoes-container">
                <button id="reset-pontos" class="botao botao-reset">Reiniciar Pontos</button>
                <button id="recomecar" class="botao botao-recomecar">Recome√ßar</button>
                <button id="bloquear-ficha" class="botao botao-bloquear">Bloquear Ficha</button>
                <button id="lua-btn" class="botao">üåô</button>
                <button id="sol-btn" class="botao">‚òÄÔ∏è</button>
            </div>

            <button id="excluir-ficha" class="botao botao-excluir">Excluir Ficha</button>
        </div>
    </div>

    <button id="anotacoes-btn">Anota√ß√µes</button>
    <textarea id="anotacoes-textarea" placeholder="Suas anota√ß√µes aqui..."></textarea>

    <button id="historico-dados-btn">Hist√≥rico de dados</button>
    <div id="historico-dados-panel">
        <h3>Hist√≥rico de Dados</h3>
        <div id="historico-lista"></div>
        <button id="excluir-historico-btn">Excluir hist√≥rico</button>
    </div>

    <div id="vantagens-desvantagens-panel">
        <h2>Vantagens e Desvantagens</h2>
        <div>Pontos de Vantagem Tempor√°rios: <span id="ph-temp">0</span></div>
        <div id="vantagens-list"></div>
        <div id="desvantagens-list"></div>
        <button id="salvar-vantagens-btn">SALVAR</button>
        <button id="fechar-pagina-btn">Fechar P√°gina</button>
    </div>

    <div id="racas-panel">
        <h2>Ra√ßas</h2>
        <div id="racas-list"></div>
        <button id="salvar-racas-btn">SALVAR</button>
        <button id="fechar-racas-btn">Fechar P√°gina</button>
    </div>

    <div id="classes-panel">
        <h2>Classes</h2>
        <button id="fechar-classes-btn">Fechar P√°gina</button>
    </div>

    <div id="nome-ficha-modal" class="modal">
        <div class="modal-content">
            <h3>D√™ um Nome √† Ficha</h3>
            <input type="text" id="nome-ficha-input" placeholder="Nome da ficha" maxlength="20">
            <button class="confirm-btn" onclick="criarNovaFicha()">Confirmar</button>
            <button class="cancel-btn" onclick="fecharModal('nome-ficha-modal')">Cancelar</button>
        </div>
    </div>

    <div id="bloquear-ficha-modal" class="modal">
        <div class="modal-content">
            <h3>Ponha sua Senha de 4 D√≠gitos</h3>
            <input type="password" id="senha-bloqueio-input" placeholder="Senha (4 d√≠gitos)" maxlength="4">
            <button class="confirm-btn" onclick="bloquearFicha()">Confirmar</button>
            <button class="cancel-btn" onclick="fecharModal('bloquear-ficha-modal')">Cancelar</button>
        </div>
    </div>

    <div id="password-modal" class="modal">
        <div class="modal-content">
            <h3>Digite sua Senha</h3>
            <input type="password" id="senha-desbloqueio-input" placeholder="Senha (4 d√≠gitos)" maxlength="4">
            <button class="confirm-btn" onclick="desbloquearFicha()">Confirmar</button>
            <button class="cancel-btn" onclick="cancelarDesbloqueio()">Cancelar</button>
        </div>
    </div>

    <div id="confirmar-compra-modal" class="modal">
        <div class="modal-content">
            <h3>Tem certeza que quer comprar isso?</h3>
            <button class="confirm-btn" id="confirmar-compra-btn">Sim</button>
            <button class="cancel-btn" onclick="fecharModal('confirmar-compra-modal')">N√£o</button>
        </div>
    </div>

    <div id="salvar-vantagens-modal" class="modal">
        <div class="modal-content">
            <h3>Se salvar, as altera√ß√µes n√£o poder√£o ser desfeitas.</h3>
            <button class="confirm-btn" id="confirmar-salvar-vantagens-btn">OK</button>
            <button class="cancel-btn" onclick="fecharModal('salvar-vantagens-modal')">Cancelar</button>
        </div>
    </div>

    <div id="senha-gm-modal" class="modal">
        <div class="modal-content">
            <h3>Pe√ßa permiss√£o ao GM</h3>
            <input type="password" id="senha-gm-input" placeholder="Senha GM">
            <button class="confirm-btn" id="confirmar-senha-gm-btn">Confirmar</button>
            <button class="cancel-btn" onclick="fecharModal('senha-gm-modal')">Cancelar</button>
        </div>
    </div>

    <div id="raca-opcoes-modal" class="modal">
        <div class="modal-content">
            <h3>O que voc√™ deseja fazer?</h3>
            <button class="confirm-btn" onclick="excluirRacaSelecionadaModal()">Excluir Ra√ßa</button>
            <button class="confirm-btn" onclick="editarRacaSelecionadaModal()">Editar Ra√ßa</button>
            <button class="cancel-btn" onclick="fecharModal('raca-opcoes-modal')">Cancelar</button>
        </div>
    </div>

    <div id="editar-raca-modal" class="modal">
        <div class="modal-content">
            <h3>Editar Ra√ßa</h3>
            <label for="editar-raca-nome">Nome:</label>
            <input type="text" id="editar-raca-nome">
            <label for="editar-raca-descricao">Descri√ß√£o:</label>
            <textarea id="editar-raca-descricao"></textarea>
            <button class="confirm-btn" onclick="salvarEdicaoRaca()">Salvar</button>
            <button class="cancel-btn" onclick="fecharModal('editar-raca-modal')">Cancelar</button>
        </div>
    </div>

    <div id="chat-modal" class="modal">
        <div class="modal-content">
            <h3>Bate-papo</h3>
            <div id="chat-messages" style="height: 200px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; margin-bottom: 10px;"></div>
            <textarea id="chat-input" placeholder="Digite sua mensagem" style="width: calc(100% - 20px); padding: 8px; margin-bottom: 10px;"></textarea>
            <div style="display: flex; gap: 10px; justify-content: center;">
                <button class="confirm-btn" onclick="enviarMensagem()">Enviar</button>
                <button class="cancel-btn" onclick="fecharModal('chat-modal')">Fechar</button>
            </div>
        </div>
    </div>

    <div id="chat-senha-modal" class="modal">
        <div class="modal-content">
            <h3>Digite a Senha do Bate-papo</h3>
            <input type="password" id="chat-senha-input" placeholder="Senha do Bate-papo (4 d√≠gitos)" maxlength="4">
            <button class="confirm-btn" onclick="entrarNoChat()">Confirmar</button>
            <button class="cancel-btn" onclick="fecharModal('chat-senha-modal')">Cancelar</button>
        </div>
    </div>

    <button id="chat-btn" style="position: fixed; left: 10px; top: 60%; transform: translateY(-50%); padding: 10px 20px; background: #f0e6d2; border: 2px solid #b8860b; border-radius: 6px; font-family: 'MedievalSharp', serif; font-size: 1rem; color: #000; cursor: pointer; transition: background-color 0.3s ease;">
        Chat
    </button>


    <div id="notification"></div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBbbwbwPXv6gztkyP3TXK-DtooEI7FcClI",
            authDomain: "ficha-de-rpg-b9685.firebaseapp.com",
            databaseURL: "https://ficha-de-rpg-b9685-default-rtdb.firebaseio.com",
            projectId: "ficha-de-rpg-b9685",
            storageBucket: "ficha-de-rpg-b9685.firebasestorage.app",
            messagingSenderId: "528610398062",
            appId: "1:528610398062:web:8fdb9cfd5ded8167613b7f"
        };

        firebase.initializeApp(firebaseConfig);

        const database = firebase.database();

        let fichas = {},
            currentFichaId = null,
            isFichaLocked = false,
            fichaPassword = null,
            isFichaUnlocked = false,
            senhaMatriz = "1040",
            vantagensSelecionadas = [],
            desvantagensSelecionadas = [],
            tempVantagensSelecionadas = [],
            tempDesvantagensSelecionadas = [],
            racaSelecionada = null,
            tempRacaSelecionada = null,
            vidaTotal,
            vidaAtual,
            magiaTotal,
            magiaAtual,
            vigorTotal,
            vigorAtual,
            previousValues = newMap(),
            chatMessages = [];

        let chatPassword = null;

        const chatBtn = document.getElementById("chat-btn");
        const chatModal = document.getElementById("chat-modal");
        const chatMessagesDisplay = document.getElementById("chat-messages");
        const chatInput = document.getElementById("chat-input");
        const chatSenhaModal = document.getElementById("chat-senha-modal");
        const chatSenhaInput = document.getElementById("chat-senha-input");


        chatBtn.addEventListener("click", () => {
            if (chatPassword) {
                abrirModalChat();
            } else {
                chatSenhaModal.style.display = "flex";
                chatSenhaInput.value = "";
                chatSenhaInput.focus();
            }
        });

        function abrirModalChat() {
            chatModal.style.display = "flex";
            carregarMensagensDoChat();
        }

        function entrarNoChat() {
            const senha = chatSenhaInput.value;
            if (senha.length !== 4 || !/^\d{4}$/.test(senha)) {
                alert("A senha do chat deve ter exatamente 4 d√≠gitos num√©ricos!");
                return;
            }

            chatPassword = senha;
            fecharModal("chat-senha-modal");
            abrirModalChat();
        }

        function enviarMensagem() {
            const mensagem = chatInput.value.trim();
            if (!mensagem) return;

            const fichaNome = fichas[currentFichaId]?.nomeFicha || "Sem Nome";
            const mensagemObj = {
                fichaId: currentFichaId,
                nomeFicha: fichaNome,
                mensagem: mensagem,
                timestamp: Date.now()
            };

            database.ref('mensagens').push(mensagemObj).then(() => {
                chatInput.value = "";
            });
        }

        function carregarMensagensDoChat() {
            database.ref('mensagens').orderByChild('timestamp').limitToLast(50).on('value', (snapshot) => {
                chatMessagesDisplay.innerHTML = '';
                snapshot.forEach(childSnapshot => {
                    const mensagemObj = childSnapshot.val();
                    const mensagemDiv = document.createElement('div');
                    mensagemDiv.textContent = `${mensagemObj.nomeFicha}: ${mensagemObj.mensagem}`;
                    chatMessagesDisplay.appendChild(mensagemDiv);
                });
                chatMessagesDisplay.scrollTop = chatMessagesDisplay.scrollHeight;
            });
        }


        function criarFichaMatriz() {
            const fichaId = "ficha-matriz";
            const fichaMatriz = {
                nomeFicha: "Matriz",
                nomePersonagem: "Personagem Matriz",
                descricaoPersonagem: "Ficha original do sistema",
                forca: "0",
                destreza: "0",
                agilidade: "0",
                inteligencia: "0",
                constituicao: "0",
                experiencia: "0",
                armaDireitaNome: "",
                armaDireitaAtaque: "0",
                armaDireitaAtaqueMagico: "0",
                armaEsquerdaNome: "",
                armaEsquerdaAtaque: "0",
                armaEsquerdaAtaqueMagico: "0",
                vantagens: "",
                magiasHabilidades: "",
                desvantagens: "",
                inventario: Array(10).fill({
                    item: "",
                    peso: "0"
                }),
                velocidadeCorrida: "25",
                alturaPulo: "1",
                distanciaPulo: "3",
                isLocked: true,
                password: senhaMatriz,
                imagem: null,
                anotacoes: "",
                classeNome: "",
                classeDescricao: "",
                racaNome: "",
                racaDescricao: "",
                racaSelecionada: ""
            };

            database.ref("fichas/ficha-matriz").once("value", snapshot => {
                if (snapshot.exists()) {
                    currentFichaId = fichaId;
                    carregarFicha(fichaId);
                    carregarFichas();
                } else {
                    database.ref(`fichas/${fichaId}`).set(fichaMatriz).then(() => {
                        currentFichaId = fichaId;
                        carregarFicha(fichaId);
                    });
                }
            });
        }

        function carregarFichas() {
            database.ref("fichas").on("value", snapshot => {
                fichas = snapshot.val() || {};
                if (fichas["ficha-matriz"]) {
                    atualizarAbasFichas();
                } else {
                    criarFichaMatriz();
                }
            });
        }

        function atualizarAbasFichas() {
            const sidebar = document.getElementById("fichas-sidebar");
            const addBtn = document.getElementById("add-ficha-btn");

            while (sidebar.children.length > 1) {
                sidebar.removeChild(sidebar.children[0]);
            }

            for (let fichaId in fichas) {
                if (fichaId !== "ficha-matriz") {
                    const tab = document.createElement("div");
                    tab.className = "ficha-tab";
                    const span = document.createElement("span");
                    span.textContent = fichas[fichaId].nomeFicha || "Sem Nome";
                    tab.appendChild(span);
                    tab.dataset.fichaId = fichaId;

                    if (fichaId === currentFichaId) tab.classList.add("active");

                    tab.onclick = () => {
                        currentFichaId = fichaId;
                        carregarFicha(fichaId);
                        atualizarAbasFichas();
                    };

                    sidebar.insertBefore(tab, addBtn);
                }
            }
        }

        document.getElementById("add-ficha-btn").onclick = () => {
            document.getElementById("nome-ficha-modal").style.display = "flex";
            document.getElementById("nome-ficha-input").value = "";
            document.getElementById("nome-ficha-input").focus();
        };

        function criarNovaFicha() {
            const nomeFicha = document.getElementById("nome-ficha-input").value.trim();
            if (!nomeFicha) return alert("Por favor, d√™ um nome √† ficha!");

            const novaFichaId = database.ref("fichas").push().key;
            const novaFicha = {
                nomeFicha,
                nomePersonagem: "",
                descricaoPersonagem: "",
                forca: "0",
                destreza: "0",
                agilidade: "0",
                inteligencia: "0",
                constituicao: "0",
                experiencia: "0",
                armaDireitaNome: "",
                armaDireitaAtaque: "0",
                armaDireitaAtaqueMagico: "0",
                armaEsquerdaNome: "",
                armaEsquerdaAtaque: "0",
                armaEsquerdaAtaqueMagico: "0",
                vantagens: "",
                magiasHabilidades: Array(10).fill("").join("\n"),
                desvantagens: "",
                inventario: Array(10).fill({
                    item: "",
                    peso: "0"
                }),
                velocidadeCorrida: "25",
                alturaPulo: "1",
                distanciaPulo: "3",
                isLocked: false,
                password: null,
                imagem: null,
                anotacoes: "",
                classeNome: "",
                classeDescricao: "",
                racaNome: "",
                racaDescricao: "",
                racaSelecionada: ""
            };

            database.ref(`fichas/${novaFichaId}`).set(novaFicha).then(() => {
                currentFichaId = novaFichaId;
                carregarFicha(novaFichaId);
                fecharModal("nome-ficha-modal");
                atualizarAbasFichas();
            }).catch(error => console.error("Erro ao criar nova ficha:", error));
        }

        function fecharModal(modalId) {
            document.getElementById(modalId).style.display = "none";
        }

        const nomePersonagemInput = document.getElementById("nome-personagem"),
            descricaoPersonagemInput = document.getElementById("descricao-personagem"),
            forcaInput = document.getElementById("forca"),
            destrezaInput = document.getElementById("destreza"),
            agilidadeInput = document.getElementById("agilidade"),
            inteligenciaInput = document.getElementById("inteligencia"),
            constituicaoInput = document.getElementById("constituicao"),
            ataqueSpan = document.getElementById("ataque"),
            ataqueMagicoSpan = document.getElementById("ataque-magico"),
            acertoSpan = document.getElementById("acerto"),
            esquivaSpan = document.getElementById("esquiva"),
            rdfSpan = document.getElementById("rdf"),
            rdmSpan = document.getElementById("rdm"),
            armaDireitaNomeInput = document.getElementById("arma-direita-nome"),
            armaDireitaAtaqueInput = document.getElementById("arma-direita-ataque"),
            armaDireitaAtaqueMagicoInput = document.getElementById("arma-direita-ataque-magico"),
            armaEsquerdaNomeInput = document.getElementById("arma-esquerda-nome"),
            armaEsquerdaAtaqueInput = document.getElementById("arma-esquerda-ataque"),
            armaEsquerdaAtaqueMagicoInput = document.getElementById("arma-esquerda-ataque-magico"),
            resetPontosButton = document.getElementById("reset-pontos"),
            recomecarButton = document.getElementById("recomecar"),
            bloquearFichaButton = document.getElementById("bloquear-ficha"),
            experienciaInput = document.getElementById("experiencia"),
            nivelSpan = document.getElementById("nivel"),
            pontosHabilidadeSpan = document.getElementById("pontos-habilidade"),
            pontosVantagemSpan = document.getElementById("pontos-vantagem"),
            velocidadeCorridaSpan = document.getElementById("velocidade-corrida"),
            alturaPuloSpan = document.getElementById("altura-pulo"),
            distanciaPuloSpan = document.getElementById("distancia-pulo"),
            nomePersonagemTitulo = document.getElementById("nome-personagem-titulo"),
            gameMasterMessage = document.getElementById("game-master-message"),
            vantagensListDisplay = document.getElementById("vantagens-list-display"),
            desvantagensListDisplay = document.getElementById("desvantagens-list-display"),
            inventarioSlots = document.getElementById("inventario-slots"),
            pesoTotalSpan = document.getElementById("peso-total"),
            diceContainer = document.getElementById("dice-container"),
            diceRoll = document.getElementById("dice-roll"),
            diceResult = document.getElementById("dice-result"),
            notification = document.getElementById("notification"),
            characterImageInput = document.getElementById("character-image-input"),
            characterImage = document.getElementById("character-image"),
            vantagensDesvantagensBtn = document.getElementById("vantagens-desvantagens-btn"),
            vantagensDesvantagensPanel = document.getElementById("vantagens-desvantagens-panel"),
            vantagensList = document.getElementById("vantagens-list"),
            desvantagensList = document.getElementById("desvantagens-list"),
            salvarVantagensBtn = document.getElementById("salvar-vantagens-btn"),
            fecharPaginaBtn = document.getElementById("fechar-pagina-btn"),
            fichaContainer = document.getElementById("ficha-container"),
            magiasList = document.getElementById("magias-list"),
            adicionarMagiaBtn = document.getElementById("adicionar-magia-btn"),
            anotacoesBtn = document.getElementById("anotacoes-btn"),
            anotacoesTextarea = document.getElementById("anotacoes-textarea"),
            racasBtn = document.getElementById("racas-btn"),
            classesBtn = document.getElementById("classes-btn"),
            racasPanel = document.getElementById("racas-panel"),
            classesPanel = document.getElementById("classes-panel"),
            fecharRacasBtn = document.getElementById("fechar-racas-btn"),
            fecharClassesBtn = document.getElementById("fechar-classes-btn"),
            classeNomeInput = document.getElementById("classe-nome"),
            classeDescricaoInput = document.getElementById("classe-descricao"),
            racaNomeSpan = document.getElementById("raca-nome"),
            racaDescricaoInput = document.getElementById("raca-descricao"),
            luaBtn = document.getElementById("lua-btn"),
            solBtn = document.getElementById("sol-btn"),
            salvarRacasBtn = document.getElementById("salvar-racas-btn"),
            racasList = document.getElementById("racas-list"),
            atributosInputs = [forcaInput, destrezaInput, agilidadeInput, inteligenciaInput, constituicaoInput];

        let nivel = 0,
            nivelAnterior = 0,
            pontosHabilidadeTotal = 25,
            pontosHabilidadeUsados = 0,
            experiencia = 0,
            vidaBase = 50;

        const nivelData = [{
            nivel: 0,
            xp: 0,
            pd: 25,
            ph: 8
        }, {
            nivel: 1,
            xp: 10,
            pd: 31,
            ph: 9
        }, {
            nivel: 2,
            xp: 30,
            pd: 37,
            ph: 10
        }, {
            nivel: 3,
            xp: 60,
            pd: 43,
            ph: 11
        }, {
            nivel: 4,
            xp: 100,
            pd: 49,
            ph: 12
        }, {
            nivel: 5,
            xp: 150,
            pd: 55,
            ph: 13
        }, {
            nivel: 6,
            xp: 210,
            pd: 61,
            ph: 14
        }, {
            nivel: 7,
            xp: 280,
            pd: 67,
            ph: 15
        }, {
            nivel: 8,
            xp: 360,
            pd: 73,
            ph: 16
        }, {
            nivel: 9,
            xp: 450,
            pd: 79,
            ph: 17
        }, {
            nivel: 10,
            xp: 550,
            pd: 85,
            ph: 18
        }, {
            nivel: 11,
            xp: 670,
            pd: 91,
            ph: 19
        }, {
            nivel: 12,
            xp: 810,
            pd: 97,
            ph: 20
        }, {
            nivel: 13,
            xp: 970,
            pd: 103,
            ph: 21
        }, {
            nivel: 14,
            xp: 1150,
            pd: 109,
            ph: 22
        }, {
            nivel: 15,
            xp: 1350,
            pd: 115,
            ph: 23
        }, {
            nivel: 16,
            xp: 1570,
            pd: 121,
            ph: 24
        }, {
            nivel: 17,
            xp: 1810,
            pd: 127,
            ph: 25
        }, {
            nivel: 18,
            xp: 2070,
            pd: 133,
            ph: 26
        }, {
            nivel: 19,
            xp: 2350,
            pd: 139,
            ph: 27
        }, {
            nivel: 20,
            xp: 2650,
            pd: 145,
            ph: 28
        }, {
            nivel: 21,
            xp: 2980,
            pd: 148,
            ph: 29
        }, {
            nivel: 22,
            xp: 3340,
            pd: 151,
            ph: 30
        }, {
            nivel: 23,
            xp: 3730,
            pd: 154,
            ph: 31
        }, {
            nivel: 24,
            xp: 4150,
            pd: 157,
            ph: 32
        }, {
            nivel: 25,
            xp: 4600,
            pd: 160,
            ph: 33
        }, {
            nivel: 26,
            xp: 5080,
            pd: 163,
            ph: 34
        }, {
            nivel: 27,
            xp: 5590,
            pd: 166,
            ph: 35
        }, {
            nivel: 28,
            xp: 6130,
            pd: 169,
            ph: 36
        }, {
            nivel: 29,
            xp: 8000,
            pd: 219,
            ph: 37
        }, {
            nivel: 30,
            xp: 10000,
            pd: 319,
            ph: 38
        }];

        function carregarFicha(fichaId) {
            if (!fichas[fichaId]) return;

            const ficha = fichas[fichaId];

            nomePersonagemInput.value = ficha.nomePersonagem || "";
            descricaoPersonagemInput.value = ficha.descricaoPersonagem || "";
            forcaInput.value = ficha.forca || "0";
            destrezaInput.value = ficha.destreza || "0";
            agilidadeInput.value = ficha.agilidade || "0";
            inteligenciaInput.value = ficha.inteligencia || "0";
            constituicaoInput.value = ficha.constituicao || "0";
            experienciaInput.value = ficha.experiencia || "0";
            armaDireitaNomeInput.value = ficha.armaDireitaNome || "";
            armaDireitaAtaqueInput.value = ficha.armaDireitaAtaque || "0";
            armaDireitaAtaqueMagicoInput.value = ficha.armaDireitaAtaqueMagico || "0";
            armaEsquerdaNomeInput.value = ficha.armaEsquerdaNome || "";
            armaEsquerdaAtaqueInput.value = ficha.armaEsquerdaAtaque || "0";
            armaEsquerdaAtaqueMagicoInput.value = ficha.armaEsquerdaAtaqueMagico || "0";

            velocidadeCorridaSpan.textContent = ficha.velocidadeCorrida || "25";
            alturaPuloSpan.textContent = ficha.alturaPulo || "1";
            distanciaPuloSpan.textContent = ficha.distanciaPulo || "3";

            isFichaLocked = ficha.isLocked || false;
            fichaPassword = ficha.password || null;
            isFichaUnlocked = false;

            vantagensSelecionadas = ficha.vantagens ? ficha.vantagens.split("\n").filter(v => v.trim()) : [];
            desvantagensSelecionadas = ficha.desvantagens ? ficha.desvantagens.split("\n").filter(d => d.trim()) : [];

            racaSelecionada = ficha.racaSelecionada || "";
            racaNomeSpan.textContent = racaSelecionada.split(" (")[0];
            racaDescricaoInput.value = racasData.find(r => r.nome === racaSelecionada)?.vantagens.join("\n\n") || "";

            vantagensListDisplay.innerHTML = "";
            desvantagensListDisplay.innerHTML = "";

            vantagensSelecionadas.forEach(v => {
                const div = document.createElement("div");
                div.textContent = v;
                div.className = "list-item";
                div.onclick = () => removerVantagem(v);
                vantagensListDisplay.appendChild(div);
            });

            desvantagensSelecionadas.forEach(d => {
                const div = document.createElement("div");
                div.textContent = d;
                div.className = "list-item";
                div.onclick = () => removerDesvantagem(d);
                desvantagensListDisplay.appendChild(div);
            });

            const inventario = Array.isArray(ficha.inventario) ? ficha.inventario : Array(10).fill({
                item: "",
                peso: "0"
            });
            const slots = inventarioSlots.querySelectorAll(".inventory-slot");
            slots.forEach((slot, i) => {
                const itemInput = slot.querySelector(".inventory-item");
                const weightInput = slot.querySelector(".inventory-weight");
                itemInput.value = inventario[i]?.item || "";
                weightInput.value = inventario[i]?.peso || "0";
            });
            calcularPesoTotal();

            const magias = ficha.magiasHabilidades ? ficha.magiasHabilidades.split("\n") : Array(10).fill("");
            magiasList.innerHTML = "";
            magias.forEach((m, i) => {
                const input = document.createElement("input");
                input.type = "text";
                input.className = "magia-nome";
                input.placeholder = `Magia/Habilidade ${i+1}`;
                input.value = m;
                magiasList.appendChild(input);
            });

            anotacoesTextarea.value = ficha.anotacoes || "";

            classeNomeInput.value = ficha.classeNome || "";
            classeDescricaoInput.value = ficha.classeDescricao || "";

            if (ficha.imagem) {
                characterImage.src = ficha.imagem;
                characterImage.style.display = "block";
            } else {
                characterImage.style.display = "none";
            }

            atualizarBotaoBloquear();
            atualizarVantagensDesvantagensPanel();
            atualizarRacasPanel();

            experiencia = parseInt(experienciaInput.value) || 0;
            atualizarNivel();
            calcularAtributos();

            vidaAtual = vidaTotal;
            magiaAtual = magiaTotal;
            vigorAtual = vigorTotal;

            document.getElementById("vida-atual").textContent = vidaAtual;
            document.getElementById("magia-atual").textContent = magiaAtual;
            document.getElementById("vigor-atual").textContent = vigorAtual.toFixed(1);

            pontosVantagemSpan.textContent = getPontosVantagem();

            previousValues.clear();
            document.querySelectorAll('input[type="text"],input[type="number"],textarea').forEach(input => previousValues.set(input, input.value));
        }

        function atualizarBotaoBloquear() {
            bloquearFichaButton.textContent = isFichaLocked ? "Desbloquear Ficha" : "Bloquear Ficha";
            bloquearFichaButton.classList.toggle("botao-bloquear", !isFichaLocked);
            bloquearFichaButton.classList.toggle("botao-desbloquear", isFichaLocked);
        }

        function salvarDados() {
            if (!currentFichaId) return;
            if (isFichaLocked && !isFichaUnlocked) return abrirModalSenha();

            const inventario = Array.from(inventarioSlots.querySelectorAll(".inventory-slot")).map(slot => ({
                item: slot.querySelector(".inventory-item").value,
                peso: slot.querySelector(".inventory-weight").value
            }));

            const magias = Array.from(magiasList.querySelectorAll(".magia-nome")).map(input => input.value);

            const dados = {
                nomePersonagem: nomePersonagemInput.value,
                descricaoPersonagem: descricaoPersonagemInput.value,
                forca: forcaInput.value,
                destreza: destrezaInput.value,
                agilidade: agilidadeInput.value,
                inteligencia: inteligenciaInput.value,
                constituicao: constituicaoInput.value,
                experiencia: experienciaInput.value,
                armaDireitaNome: armaDireitaNomeInput.value,
                armaDireitaAtaque: armaDireitaAtaqueInput.value,
                armaDireitaAtaqueMagico: armaDireitaAtaqueMagicoInput.value,
                armaEsquerdaNome: armaEsquerdaNomeInput.value,
                armaEsquerdaAtaque: armaEsquerdaAtaqueInput.value,
                armaEsquerdaAtaqueMagico: armaEsquerdaAtaqueMagicoInput.value,
                vantagens: vantagensSelecionadas.join("\n"),
                magiasHabilidades: magias.join("\n"),
                desvantagens: desvantagensSelecionadas.join("\n"),
                inventario,
                velocidadeCorrida: velocidadeCorridaSpan.textContent,
                alturaPulo: alturaPuloSpan.textContent,
                distanciaPulo: distanciaPuloSpan.textContent,
                isLocked: isFichaLocked,
                password: fichaPassword,
                imagem: characterImage.src || null,
                anotacoes: anotacoesTextarea.value,
                classeNome: classeNomeInput.value,
                classeDescricao: classeDescricaoInput.value,
                racaNome: racaNomeSpan.textContent,
                racaDescricao: racaDescricaoInput.value,
                racaSelecionada: racaSelecionada
            };

            database.ref(`fichas/${currentFichaId}`).update(dados).then(() => {
                showNotification("Salvo!", "save-success");
                previousValues.clear();
                document.querySelectorAll('input[type="text"],input[type="number"],textarea').forEach(input => previousValues.set(input, input.value));
            });
        }

        function calcularNivel(exp) {
            return nivelData.findLast(data => exp >= data.xp)?.nivel || 0;
        }

        function atualizarNivel() {
            nivelAnterior = nivel;
            nivel = calcularNivel(experiencia);
            nivelSpan.textContent = nivel;
            pontosHabilidadeTotal = nivelData[nivel].pd;
            pontosVantagemSpan.textContent = getPontosVantagem();

            if (nivel > nivelAnterior) {
                nivelSpan.classList.add("aura-azul");
                setTimeout(() => nivelSpan.classList.remove("aura-azul"), 20000);
            }

            gameMasterMessage.style.display = nivel >= 30 ? "block" : "none";
            fichaContainer.classList.toggle("aura-azul", nivel >= 30);

            calcularAtributos();
        }

        function getPontosVantagem() {
            let ph = nivelData[nivel].ph;

            vantagensSelecionadas.forEach(v => {
                const vantagem = vantagensData.find(d => d.nome === v);
                if (vantagem) ph -= vantagem.custo;
            });

            desvantagensSelecionadas.forEach(d => {
                const desvantagem = desvantagensData.find(desv => desv.nome === d);
                if (desvantagem) ph += desvantagem.ganho;
            });

            if (racaSelecionada) {
                const raca = racasData.find(r => r.nome === racaSelecionada);
                if (raca) ph -= raca.custo;
            }

            return ph;
        }

        function calcularPontosVantagemTemp() {
            let ph = nivelData[nivel].ph;

            tempVantagensSelecionadas.forEach(v => {
                const vantagem = vantagensData.find(d => d.nome === v);
                if (vantagem) ph -= vantagem.custo;
            });

            tempDesvantagensSelecionadas.forEach(d => {
                const desvantagem = desvantagensData.find(desv => desv.nome === d);
                if (desvantagem) ph += desvantagem.ganho;
            });

            if (tempRacaSelecionada) {
                const raca = racasData.find(r => r.nome === tempRacaSelecionada);
                if (raca) ph -= raca.custo;
            }

            return ph;
        }

        function aumentarVida() {
            if (vidaAtual < vidaTotal) {
                vidaAtual++;
                document.getElementById("vida-atual").textContent = vidaAtual;
                salvarDados();
            }
        }

        function diminuirVida() {
            if (vidaAtual > 0) {
                vidaAtual--;
                document.getElementById("vida-atual").textContent = vidaAtual;
                salvarDados();
            }
        }

        function aumentarMagia() {
            if (magiaAtual < magiaTotal) {
                magiaAtual++;
                document.getElementById("magia-atual").textContent = magiaAtual;
                salvarDados();
            }
        }

        function diminuirMagia() {
            if (magiaAtual > 0) {
                magiaAtual--;
                document.getElementById("magia-atual").textContent = magiaAtual;
                salvarDados();
            }
        }

        function aumentarVigor() {
            if (vigorAtual < vigorTotal) {
                vigorAtual = Math.min(vigorAtual + 0.1, vigorTotal);
                document.getElementById("vigor-atual").textContent = vigorAtual.toFixed(1);
                salvarDados();
            }
        }

        function diminuirVigor() {
            if (vigorAtual > 0) {
                vigorAtual = Math.max(vigorAtual - 0.1, 0);
                document.getElementById("vigor-atual").textContent = vigorAtual.toFixed(1);
                salvarDados();
            }
        }

        function calcularAtributos() {
            const forca = parseInt(forcaInput.value) || 0,
                destreza = parseInt(destrezaInput.value) || 0,
                agilidade = parseInt(agilidadeInput.value) || 0,
                inteligencia = parseInt(inteligenciaInput.value) || 0,
                constituicao = parseInt(constituicaoInput.value) || 0;

            let totalPontos = forca + destreza + agilidade + inteligencia + constituicao;

            if (totalPontos > pontosHabilidadeTotal) {
                alert("Pontos de habilidade insuficientes!");
                forcaInput.value = previousValues.get(forcaInput) || "0";
                destrezaInput.value = previousValues.get(destrezaInput) || "0";
                agilidadeInput.value = previousValues.get(agilidadeInput) || "0";
                inteligenciaInput.value = previousValues.get(inteligenciaInput) || "0";
                constituicaoInput.value = previousValues.get(constituicaoInput) || "0";
                return;
            }

            pontosHabilidadeUsados = totalPontos;
            pontosHabilidadeSpan.textContent = pontosHabilidadeTotal - pontosHabilidadeUsados;

            let ataque = forca + Math.floor(destreza / 5),
                acerto = Math.floor(destreza / 3) + Math.floor(agilidade / 10),
                esquiva = Math.floor(agilidade / 3),
                rdf = Math.floor(forca / 5),
                rdm = Math.floor(inteligencia / 5),
                ataqueMagico = inteligencia,
                magiaBase = 20 + 3 * constituicao,
                vigorBase = 10 + 0.4 * constituicao;

            vidaBase = 50 + (constituicao * (3 + Math.floor(forca / 10))) + 10 * nivel;

            if (inteligencia >= 10) magiaBase += constituicao * Math.floor(inteligencia / 10);

            ataque += (parseInt(armaDireitaAtaqueInput.value) || 0) + (parseInt(armaEsquerdaAtaqueInput.value) || 0);
            ataqueMagico += (parseInt(armaDireitaAtaqueMagicoInput.value) || 0) + (parseInt(armaEsquerdaAtaqueMagicoInput.value) || 0);

            const velocidadeBase = 25 + Math.floor(agilidade / 3) * 3,
                alturaPuloBase = 1 + Math.floor(forca / 10),
                distanciaPuloBase = 3 + 3 * Math.min(Math.floor(forca / 5), Math.floor(agilidade / 5));

            let bonusVelocidade = vantagensSelecionadas.includes("Combo F√≠sico (4)") ? 25 : 0,
                bonusAlturaPulo = vantagensSelecionadas.includes("Combo F√≠sico (4)") ? 2 : 0,
                bonusDistanciaPulo = vantagensSelecionadas.includes("Combo F√≠sico (4)") ? 6 : 0;

            velocidadeCorridaSpan.textContent = velocidadeBase + bonusVelocidade;
            alturaPuloSpan.textContent = alturaPuloBase + bonusAlturaPulo;
            distanciaPuloSpan.textContent = distanciaPuloBase + bonusDistanciaPulo;

            ataqueSpan.textContent = ataque;
            ataqueMagicoSpan.textContent = ataqueMagico;
            acertoSpan.textContent = acerto;
            esquivaSpan.textContent = esquiva;
            rdfSpan.textContent = rdf;
            rdmSpan.textContent = rdm;

            vidaTotal = Math.ceil(vidaBase);
            magiaTotal = Math.ceil(magiaBase);
            vigorTotal = parseFloat(vigorBase.toFixed(1));

            vidaAtual = vidaAtual === undefined ? vidaTotal : Math.min(vidaAtual, vidaTotal);
            magiaAtual = magiaAtual === undefined ? magiaTotal : Math.min(magiaAtual, magiaTotal);
            vigorAtual = vigorAtual === undefined ? vigorTotal : Math.min(vigorAtual, vigorTotal);

            document.getElementById("vida-total").textContent = vidaTotal;
            document.getElementById("magia-total").textContent = magiaTotal;
            document.getElementById("vigor-total").textContent = vigorTotal.toFixed(1);
            document.getElementById("vida-atual").textContent = vidaAtual;
            document.getElementById("magia-atual").textContent = magiaAtual;
            document.getElementByI
