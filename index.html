<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ficha de Personagem RPG</title>
    <link href="https://fonts.googleapis.com/css2?family=MedievalSharp&family=Inter:wght@400;600&family=Times+New+Roman&family=Arial&family=Courier+New&family=Georgia&family=Verdana&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0e6d2; /* Cor de pergaminho padr√£o */
            color: #000;
            display: flex;
            flex-direction: column; /* Changed to column for sidebar and container */
            min-height: 100vh;
            margin: 0;
            /* padding: 20px; */ /* Padding moved to container or handled by sidebar */
            background-image: none;
            background-size: cover;
            background-position: center;
            transition: background 0.3s, color 0.3s, font-family 0.3s;
        }
        body.dark-mode {
            background-color: #121212 !important;
            color: #e0e0e0;
        }
        #fichas-sidebar {
            width: 100%; height: 60px; padding: 10px; display: flex; flex-direction: row;
            align-items: center; justify-content: flex-start; position: fixed;
            top: 0; left: 0; z-index: 1000; overflow-x: auto;
            background: rgba(240, 230, 210, 0.8); /* Slight background for visibility */
            border-bottom: 2px solid #b8860b;
        }
        body.dark-mode #fichas-sidebar {
            background: rgba(30, 30, 30, 0.8);
            border-bottom: 2px solid #444;
        }
        .ficha-tab {
            visibility: visible; min-width: 100px; height: 40px; background: #e0d4c0; /* Slightly darker tab */
            border: 2px solid #b8860b; border-bottom: none; border-radius: 8px 8px 0 0; margin-right: 5px;
            display: flex; align-items: center; justify-content: center; cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 2px -2px 5px rgba(0, 0, 0, 0.1);
            padding: 0 10px;
        }
        body.dark-mode .ficha-tab {
            background: #2a2a2a;
            border-color: #555;
        }
        .ficha-tab:hover, .ficha-tab.active { background: #a0522d; color: #fff; transform: translateY(-3px); }
        body.dark-mode .ficha-tab:hover, body.dark-mode .ficha-tab.active { background: #775533; }
        .ficha-tab span {
            font-family: 'MedievalSharp', serif; color: #3a2e1c; font-size: 0.9rem; text-align: center;
            max-width: 120px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
        }
        .ficha-tab.active span, .ficha-tab:hover span { color: #fff; }
        body.dark-mode .ficha-tab span { color: #c0c0c0; }
        body.dark-mode .ficha-tab.active span, body.dark-mode .ficha-tab:hover span { color: #fff; }

        #add-ficha-btn {
            min-width: 100px; height: 40px; background: #b8860b; border: 2px solid #b8860b; border-bottom:none;
            border-radius: 8px 8px 0 0; margin-right: 10px; display: flex; align-items: center;
            justify-content: center; cursor: pointer; transition: transform 0.2s ease;
            box-shadow: 0 0 10px #ffd700, 0 0 15px #ffd700; z-index: 1001; padding: 0 10px;
        }
        #add-ficha-btn span { font-family: 'MedievalSharp', serif; color: #fff; font-size: 0.9rem; }
        #add-ficha-btn:hover { background: #a0522d; transform: translateY(-3px); }

        #ficha-container {
            background: rgba(240, 230, 210, 0.95); padding: 30px; border-radius: 12px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2); width: 95%; max-width: 1200px;
            margin: 80px auto 20px; /* Adjusted margin-top for fixed sidebar */
            border: 2px solid #b8860b; position: relative; z-index: 1;
            transition: font-family 0.3s;
        }
        body.dark-mode #ficha-container { background: rgba(30, 30, 30, 0.95); color: #e0e0e0; }
        #ficha-container.aura-azul { box-shadow: 0 0 30px 15px #00BFFF; animation: pulsar-aura 2s infinite; }
        @keyframes pulsar-aura {
            0% { box-shadow: 0 0 20px #00BFFF, 0 0 30px #00BFFF, 0 0 40px #00BFFF; }
            50% { box-shadow: 0 0 30px #00BFFF, 0 0 50px #00BFFF, 0 0 60px #00BFFF; }
            100% { box-shadow: 0 0 20px #00BFFF, 0 0 30px #00BFFF, 0 0 40px #00BFFF; }
        }
        h1#nome-personagem-titulo {
            font-family: 'MedievalSharp', serif; color: #1C2526; font-size: 3rem; margin-bottom: 20px;
            text-align: center; text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1); animation: raios 2s infinite linear;
        }
        body.dark-mode h1#nome-personagem-titulo { color: #e0e0e0; }
        @keyframes raios {
            0% { text-shadow: 0 0 5px #FFD700, 0 0 10px #FFD700, 0 0 15px #FFD700, 0 0 20px #FF4500; }
            50% { text-shadow: 0 0 10px #FFD700, 0 0 15px #FFD700, 0 0 20px #FF4500, 0 0 25px #FF4500; }
            100% { text-shadow: 0 0 5px #FFD700, 0 0 10px #FFD700, 0 0 15px #FFD700, 0 0 20px #FF4500; }
        }
        #game-master-message { display: none; color: blue; font-size: 1.5rem; text-align: center; font-family: 'MedievalSharp', serif; margin-bottom: 10px; }
        section { background: #f7f0e4; border: 2px solid #b8860b; border-radius: 8px; padding: 15px; margin-bottom: 20px; }
        section h2 { text-align: center; font-family: 'MedievalSharp', serif; color: #5c4033;}
        body.dark-mode section { background: #252525; border-color: #4a4a4a; }
        body.dark-mode section h2 { color: #b8860b; }
        label { font-weight: 600; color: #4a3b30; margin-bottom: 8px; display: block; }
        body.dark-mode label { color: #c0c0c0; }
        input[type="text"], input[type="number"], textarea {
            padding: 10px; border: 2px solid #b8860b; border-radius: 6px; width: 100%; /* Changed from calc */
            box-sizing: border-box; /* Added for better width calculation */
            margin-bottom: 15px; font-size: 1rem; transition: border-color 0.3s ease;
            background: #fff; color: #000;
        }
        body.dark-mode input[type="text"], body.dark-mode input[type="number"], body.dark-mode textarea {
            background: #333; color: #e0e0e0; border-color: #555;
        }
        input[type="text"]:focus, input[type="number"]:focus, textarea:focus {
            border-color: #a0522d; outline: none; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        input[readonly], span[readonly] { background: #e8e8e8; border: 1px solid #ccc; cursor: not-allowed; }
        body.dark-mode input[readonly], body.dark-mode span[readonly] { background: #444; border-color: #666; }
        textarea { resize: vertical; }
        .atributos-container { display: flex; justify-content: space-between; gap: 20px; flex-wrap: wrap; /* Added wrap */}
        .atributos-coluna, .atributos-coluna-destaque {
            width: 100%; /* Full width on small screens */
            md:width: 48%; /* Tailwind class for medium screens and up */
            display: flex; flex-direction: column; align-items: flex-start;
        }
        .atributos-coluna-destaque { background: #fff; padding: 10px; border-radius: 6px; border: 1px solid #b8860b; }
        body.dark-mode .atributos-coluna-destaque { background: #333; border-color: #555; }
        .atributo-destaque { padding: 8px; margin-bottom: 10px; display: flex; align-items: center; justify-content: space-between; width: 100%; }
        .atributo-destaque label { font-size: 1.1rem; font-weight: 700; color: #a0522d; }
        body.dark-mode .atributo-destaque label { color: #d4af37; }
        .atributo-destaque span { font-size: 1.2rem; font-family: 'MedievalSharp', serif; color: #000; }
        body.dark-mode .atributo-destaque span { color: #e0e0e0; }
        .atributo-fogo { animation: fogo 1.5s infinite; }
        @keyframes fogo {
            0% { text-shadow: 0 0 5px #ff4500, 0 0 10px #ff4500; }
            50% { text-shadow: 0 0 10px #ff4500, 0 0 15px #ffd700; }
            100% { text-shadow: 0 0 5px #ff4500, 0 0 10px #ff4500; }
        }
        .vida-magia-vigor { display: flex; justify-content: space-around; gap: 15px; flex-wrap: wrap; }
        .atributo-container {
            background: rgba(255, 255, 255, 0.8); padding: 12px; border-radius: 8px; border: 1px solid #b8860b;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); width: 100%; /* Full width on small screens */
            md:width: 30%; /* Tailwind for medium screens */
            min-width: 200px; text-align: center; margin-bottom: 10px; /* Added margin for wrap */
        }
        body.dark-mode .atributo-container { background: rgba(50, 50, 50, 0.8); }
        .atributo-container h3 { font-family: 'MedievalSharp', serif; color: #5c4033; margin-bottom: 5px; }
        body.dark-mode .atributo-container h3 { color: #b8860b; }
        .atributo-container::before { font-size: 1.5rem; margin-bottom: 5px; display: block; }
        .atributo-container.vida::before { content: "‚ù§Ô∏è"; }
        .atributo-container.magia::before { content: "‚ú®"; }
        .atributo-container.vigor::before { content: "‚ö°"; }
        .medieval-box { background: #f0e6d2; border: 2px solid #b8860b; border-radius: 8px; padding: 10px; margin: 5px 0; text-align: center; }
        body.dark-mode .medieval-box { background: #1e1e1e; border-color: #444; }
        .regeneracao { font-size: 0.8rem; color: #555; margin-top: 5px; }
        body.dark-mode .regeneracao { color: #aaa; }
        button.control-btn { /* Specific class for +/- buttons */
            background: #b8860b; color: #fff; border: none; padding: 5px 10px;
            cursor: pointer; font-size: 1.2rem; border-radius: 4px; margin: 0 5px;
            transition: background-color 0.3s ease;
        }
        body.dark-mode button.control-btn { background: #555; }
        button.control-btn:hover { background: #a0522d; }
        body.dark-mode button.control-btn:hover { background: #777; }

        .botoes-container { display: flex; justify-content: center; gap: 10px; margin-top: 20px; margin-bottom: 20px; flex-wrap: wrap; }
        .botao {
            padding: 12px 25px; border: none; border-radius: 6px; font-size: 1rem; cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease; font-family: 'MedievalSharp', serif;
            color: #fff; text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
        }
        body.dark-mode .botao { background: #555; }
        body.dark-mode .botao:hover { background: #777; }
        #reset-pontos, #recomecar, #bloquear-ficha, #plano-fundo-btn, #excluir-ficha { background-color: #800000; }
        .botao-reset:hover, .botao-recomecar:hover, .botao-bloquear:hover, .botao-desbloquear:hover, #excluir-ficha:hover {
            background: #a0522d; transform: translateY(-2px);
        }
        .icon-btn {
            padding: 10px; width: 44px; height: 44px;
            font-size: 1.2rem; line-height: 1; text-align: center;
        }
        #lua-btn { background-color: #333; color: #eee; }
        #sol-btn { background-color: #ffdd00; color: #333; }
        #nivel-container { text-align: center; margin-top: 10px; }
        #nivel {
            padding: 10px; background: #f0e6d2; border: 3px solid #000; border-radius: 50%;
            width: 100px; height: 100px; display: flex; align-items: center; justify-content: center;
            font-size: 3.125rem; box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.5); margin: 0 auto;
            font-family: 'MedievalSharp', serif;
        }
        body.dark-mode #nivel { background: #1e1e1e; border-color: #444; }
        #nivel.aura-azul { animation: pulsar-aura 2s 10; }
        .expandable-textarea {
            min-height: 100px; /* Use min-height */
            width: 100%; background: #fff; border: 2px solid #b8860b;
            border-radius: 6px; padding: 10px; font-size: 0.9rem; transition: height 0.3s ease;
        }
        body.dark-mode .expandable-textarea { background: #333; }
        /* .expandable-textarea:focus { height: 15cm; } */ /* Removed fixed height on focus, allow natural expansion */
        #dice-container {
            position: absolute; top: 70px; /* Adjusted for sidebar */
            right: 20px; width: 200px; text-align: center;
            font-family: 'MedievalSharp', serif; cursor: move; z-index: 10; user-select: none;
            background: rgba(240,230,210,0.7); /* Added slight background */
            padding: 10px; border-radius: 8px; border: 1px solid #b8860b;
        }
        body.dark-mode #dice-container { background: rgba(30,30,30,0.7); border-color: #444;}

        #dice-container label { font-size: 1.2rem; color: #000; display: flex; align-items: center; justify-content: center; margin-bottom: 10px; }
        body.dark-mode #dice-container label { color: #e0e0e0; }
        #dice-container label::before { content: "üé≤"; margin-right: 5px; font-size: 1.5rem; }
        #dice-roll {
            width: 100px; height: 100px; background: #f0e6d2; border: 2px solid #b8860b; border-radius: 10px;
            display: flex; align-items: center; justify-content: center; font-size: 2rem; cursor: pointer;
            margin: 0 auto; position: relative; transition: all 0.3s ease;
             font-family: 'MedievalSharp', serif;
        }
        body.dark-mode #dice-roll { background: #1e1e1e; border-color: #444; }
        #dice-roll::before { content: "‚öÖ"; font-size: 1.5rem; position: absolute; top: 5px; right: 5px; color: #a0522d; }
        #dice-result { margin-top: 10px; font-size: 1rem; color: #000; display: none; animation: blink 1s infinite; }
        body.dark-mode #dice-result { color: #e0e0e0; }
        @keyframes blink { 50% { opacity: 0; } }
        #dice-roll.critical-failure { animation: aura-vermelha 2s infinite; }
        #dice-roll.critical-success { animation: aura-verde 2s infinite; }
        @keyframes aura-vermelha {
            0% { box-shadow: 0 0 5px #ff0000, 0 0 10px #ff0000; }
            50% { box-shadow: 0 0 15px #ff0000, 0 0 20px #ff0000; }
            100% { box-shadow: 0 0 5px #ff0000, 0 0 10px #ff0000; }
        }
        @keyframes aura-verde {
            0% { box-shadow: 0 0 5px #00ff00, 0 0 10px #00ff00; }
            50% { box-shadow: 0 0 15px #00ff00, 0 0 20px #00ff00; }
            100% { box-shadow: 0 0 5px #00ff00, 0 0 10px #00ff00; }
        }
        #notification {
            position: fixed; top: 70px; /* Adjusted for sidebar */
            left: 50%; transform: translateX(-50%); padding: 15px 25px;
            border-radius: 8px; font-family: 'MedievalSharp', serif; font-size: 1.2rem; color: #fff;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5); display: none; z-index: 2000; /* Higher z-index */
            background: rgba(0, 0, 0, 0.7); transition: opacity 0.3s ease;
        }
        #notification.critical-failure { background: rgba(255, 0, 0, 0.8); animation: aura-vermelha 2s infinite; }
        #notification.critical-success { background: rgba(0, 255, 0, 0.8); animation: aura-verde 2s infinite; }
        #notification.normal-result { animation: blink 1s infinite; }
        #notification.save-success { background: rgba(0, 128, 0, 0.8); animation: blink 1s infinite; } /* Darker green */

        #character-image-container {
            position: absolute; top: 70px; /* Adjusted for sidebar */
            left: 10px; width: 100px; height: 100px; background: #f0e6d2;
            border: 2px solid #b8860b; border-radius: 8px; display: flex; align-items: center;
            justify-content: center; cursor: pointer; overflow: hidden; z-index: 10;
        }
        body.dark-mode #character-image-container { background: #1e1e1e; }
        #character-image { width: 100%; height: 100%; object-fit: cover; display: none; }
        #character-image-container:hover { box-shadow: 0 0 10px #ffd700; }
        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.6); justify-content: center; align-items: center; z-index: 1000;
        }
        .modal-content {
            background: #f0e6d2; padding: 20px; border-radius: 8px; border: 2px solid #b8860b;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3); width: 90%; max-width: 400px; text-align: center;
        }
        body.dark-mode .modal-content { background: #1e1e1e; border-color: #444; }
        .modal-content h3 { font-family: 'MedievalSharp', serif; color: #000; margin-bottom: 15px; }
        body.dark-mode .modal-content h3 { color: #e0e0e0; }
        .modal-content input { width: calc(100% - 20px); padding: 10px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 6px; }
        body.dark-mode .modal-content input { background: #333; color: #e0e0e0; border-color: #555; }
        .modal-content button {
            padding: 10px 20px; border: none; border-radius: 6px; font-family: 'MedievalSharp', serif;
            color: #fff; cursor: pointer; margin: 5px; /* Added margin for better spacing */
        }
        .modal-content .confirm-btn { background: #b8860b; }
        .modal-content .confirm-btn:hover { background: #a0522d; }
        .modal-content .cancel-btn { background: #a52a2a; }
        .modal-content .cancel-btn:hover { background: #8b0000; }
        #vantagens-desvantagens-btn, #racas-btn, #classes-btn {
            padding: 10px 20px; background: #f0e6d2; border: 2px solid #b8860b; border-radius: 6px;
            font-family: 'MedievalSharp', serif; font-size: 1rem; color: #000; cursor: pointer;
            transition: background-color 0.3s ease; z-index: 10;
        }
        body.dark-mode #vantagens-desvantagens-btn, body.dark-mode #racas-btn, body.dark-mode #classes-btn {
            background: #1e1e1e; color: #e0e0e0;
        }
        #vantagens-desvantagens-btn:hover, #racas-btn:hover, #classes-btn:hover { background: #a0522d; color: #fff; }
        #vantagens-desvantagens-panel, #racas-panel, #classes-panel {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(240, 230, 210, 0.98); padding: 20px; overflow-y: auto; z-index: 999;
            border: 2px solid #b8860b; box-shadow: 0 0 20px rgba(0, 0, 0, 0.3);
            padding-top: 70px; /* Account for fixed sidebar */
        }
        body.dark-mode #vantagens-desvantagens-panel, body.dark-mode #racas-panel, body.dark-mode #classes-panel {
            background: rgba(30, 30, 30, 0.98);
        }
        #vantagens-desvantagens-panel h2, #racas-panel h2, #classes-panel h2 {
            font-family: 'MedievalSharp', serif; font-size: 2rem; text-align: center;
            color: #a0522d; margin-bottom: 20px;
        }
        #racas-panel h2 { font-size: 3rem; }
        .vantagem-item, .desvantagem-item, .raca-item-selector { /* Renamed .raca-item to avoid conflict */
            padding: 10px; margin: 5px 0; background: #fff; border: 1px solid #ccc;
            border-radius: 6px; cursor: pointer; transition: background-color 0.3s ease;
        }
        body.dark-mode .vantagem-item, body.dark-mode .desvantagem-item, body.dark-mode .raca-item-selector {
            background: #333; border-color: #555;
        }
        .vantagem-item:hover, .desvantagem-item:hover, .raca-item-selector:hover { background: #f0e6d2; }
        body.dark-mode .vantagem-item:hover, body.dark-mode .desvantagem-item:hover, body.dark-mode .raca-item-selector:hover { background: #444; }
        .vantagem-item.comprada, .raca-item-selector.comprada { background: #ffcccc; color: #f00; cursor: default; }
        .desvantagem-item.comprada { background: #ccffcc; color: #080; cursor: default; }

        #salvar-vantagens-btn, #salvar-racas-btn, #fechar-pagina-btn, #fechar-racas-btn, #fechar-classes-btn {
            position: fixed; bottom: 20px; padding: 12px 25px; background: #a52a2a; color: #fff;
            border: none; border-radius: 6px; font-family: 'MedievalSharp', serif; font-size: 1.2rem;
            cursor: pointer; transition: transform 0.2s ease; z-index: 1000; /* Ensure buttons are above panel content */
        }
        #salvar-vantagens-btn, #salvar-racas-btn { right: 250px; animation: aura-verde-btn 2s infinite; display: none; background: #000; }
        #fechar-pagina-btn, #fechar-racas-btn, #fechar-classes-btn { right: 20px; }
        #salvar-vantagens-btn:hover, #salvar-racas-btn:hover, #fechar-pagina-btn:hover, #fechar-racas-btn:hover, #fechar-classes-btn:hover {
            transform: translateY(-2px);
        }
        @keyframes aura-verde-btn {
            0% { box-shadow: 0 0 5px #00ff00, 0 0 10px #00ff00; }
            50% { box-shadow: 0 0 15px #00ff00, 0 0 20px #00ff00; }
            100% { box-shadow: 0 0 5px #00ff00, 0 0 10px #00ff00; }
        }
        .locomotion-container { background: #8B4513; border: 3px solid #FFD700; border-radius: 10px; padding: 15px; color: #FFD700; font-family: 'MedievalSharp', serif; }
        .locomotion-item { display: flex; align-items: center; margin-bottom: 10px; }
        .locomotion-item label { font-weight: bold; color: #FFD700; }
        .locomotion-item span { font-size: 1.2rem; color: #FFF; text-shadow: 1px 1px 2px #000; margin-left: 5px; font-weight: bold; }
        .list-display { background: #fff; border: 2px solid #b8860b; border-radius: 6px; padding: 10px; min-height: 100px; max-height: 200px; overflow-y: auto; }
        body.dark-mode .list-display { background: #333; border-color: #555; }
        .list-item { cursor: pointer; margin-bottom: 5px; padding: 5px; border-bottom: 1px solid #ccc; }
        body.dark-mode .list-item { border-color: #555; }
        .list-item:hover { background: #e0e0e0; }
        body.dark-mode .list-item:hover { background: #444; }
        .inventory-slot { display: flex; align-items: center; margin-bottom: 10px; }
        .inventory-slot input[type="text"] { flex-grow: 1; margin-right: 10px; }
        .inventory-slot input[type="number"] { width: 60px; }
        #anotacoes-btn {
            position: fixed; left: 10px; top: 50%; transform: translateY(-50%); padding: 10px 20px;
            background: #f0e6d2; border: 2px solid #b8860b; border-radius: 6px;
            font-family: 'MedievalSharp', serif; font-size: 1rem; color: #000; cursor: pointer;
            transition: background-color 0.3s ease; z-index: 1000;
        }
        body.dark-mode #anotacoes-btn { background: #1e1e1e; color: #e0e0e0; }
        #anotacoes-btn:hover { background: #a0522d; color: #fff; }
        #anotacoes-textarea {
            display: none; position: fixed; left: 150px; /* Adjusted left for button */
            top: 50%; transform: translateY(-50%);
            width: 300px; height: 300px; background: #fff; border: 2px solid #b8860b;
            border-radius: 6px; padding: 10px; font-size: 0.9rem; resize: none; z-index: 1001;
        }
        body.dark-mode #anotacoes-textarea { background: #333; color: #e0e0e0; }
        .magias-container { max-height: 300px; overflow-y: auto; border: 2px solid #b8860b; border-radius: 6px; padding: 10px; background: #fff; }
        body.dark-mode .magias-container { background: #333; border-color: #555; }
        .magias-container input { margin-bottom: 10px; }
        #adicionar-magia-btn { background: #b8860b; color: #fff; padding: 8px 16px; border-radius: 6px; cursor: pointer; display: block; margin-top: 10px; }
        #adicionar-magia-btn:hover { background: #a0522d; }
        .classe-raca-container { background: #f0e6d2; border: 2px solid #b8860b; padding: 10px; border-radius: 6px; margin-top: 10px; }
        body.dark-mode .classe-raca-container { background: #1e1e1e; border-color: #444; }
        .classe-raca-container label { font-family: 'MedievalSharp', serif; color: #a0522d; font-size: 1.2rem; }
        body.dark-mode .classe-raca-container label { color: #d4af37; }
        .classe-raca-container span#raca-nome { background: #fff; border: 2px solid #b8860b; padding: 10px; cursor: pointer; display: block; min-height: 40px; /* Ensure it's clickable */}
        body.dark-mode .classe-raca-container span#raca-nome { background: #333; color: #e0e0e0; }
        .classe-raca-container textarea { width: 100%; background: #fff; border: 2px solid #b8860b; }
        body.dark-mode .classe-raca-container textarea { background: #333; color: #e0e0e0; }
        .raca-item-display { margin-bottom: 20px; padding: 10px; background: #fff; border: 2px solid #b8860b; border-radius: 6px; } /* For displaying selected race details */
        .raca-item-display h3 { font-family: 'MedievalSharp', serif; font-size: 1.5rem; color: #a0522d; }
        .raca-item-display p { font-size: 1rem; color: #000; }
        body.dark-mode .raca-item-display { background: #333; border-color: #555; }
        body.dark-mode .raca-item-display p { color: #e0e0e0; }
        body.dark-mode .raca-item-display h3 { color: #d4af37; }
        .theme-color-container { display: flex; justify-content: center; align-items:center; gap: 10px; margin-top: -10px; margin-bottom: 20px; }
        .theme-option { position: relative; }
        #cor-fundo-visual-btn { cursor: pointer; }

        @media (max-width: 768px) {
            body { padding: 0; /* Remove body padding */ }
            #fichas-sidebar { padding: 5px; height: 50px; }
            .ficha-tab, #add-ficha-btn { height: 35px; min-width: 80px; font-size: 0.8rem;}
            .ficha-tab span, #add-ficha-btn span { font-size: 0.8rem; }
            #ficha-container { padding: 15px; margin: 60px auto 10px; /* Adjusted for sidebar */ width: 100%; border-radius:0; border-left:none; border-right:none;}
            h1#nome-personagem-titulo { font-size: 2rem; }
            section h2 { font-size: 1.2rem; }
            input, textarea { font-size: 0.9rem; }
            .atributos-container, .vida-magia-vigor { flex-direction: column; }
            .atributos-coluna, .atributos-coluna-destaque, .atributo-container { width: 100%; }
            .botoes-container, .theme-color-container { flex-direction: row; flex-wrap: wrap; }
            #dice-container { width: 150px; top: 60px; right: 10px;}
            #dice-roll { width: 80px; height: 80px; font-size: 1.5rem;}
            #character-image-container {width: 80px; height: 80px; top: 60px; left: 5px;}
            #anotacoes-textarea { width: calc(100% - 20px); left:10px; height: 250px;}
            .modal-content { width: 90%; }
        }
        #raca-opcoes-modal .modal-content button:nth-child(2) { margin-top: 10px; }
        #background-modal .modal-content { width: 90%; max-width:400px; text-align: left; }
        #background-modal .modal-content label { display: block; margin-bottom: 5px; }
        #background-modal .modal-content input[type="file"] { margin-bottom: 10px; }
        #background-modal .modal-content .radio-group { margin-bottom: 15px; }
        #background-modal .modal-content .radio-group label { display: inline-block; margin-right: 10px; }
        .color-option { width: 24px; height: 24px; border-radius: 50%; cursor: pointer; border: 1px solid #ccc; }
    </style>
</head>
<body>
    <div id="fichas-sidebar">
        <div id="add-ficha-btn"><span>+ Ficha</span></div>
        </div>
    <div id="ficha-container">
        <h1 id="nome-personagem-titulo">Ficha de Personagem</h1>
        <div id="game-master-message">Voc√™ virou o Game Master</div>
        <div id="character-image-container" onclick="document.getElementById('character-image-input').click()">
            <img id="character-image" alt="Imagem do Personagem">
            <input type="file" id="character-image-input" accept="image/*" style="display:none">
        </div>
        <div id="dice-container">
            <label>Role seu dado:</label>
            <div id="dice-roll">-</div>
            <div id="dice-result"></div>
        </div>
        <div id="ficha-content">
            <section id="informacoes-basicas">
                <h2>Informa√ß√µes B√°sicas</h2>
                <label for="nome-personagem">Nome do Personagem:</label>
                <input type="text" id="nome-personagem" placeholder="Digite o nome do seu personagem">
                <label for="descricao-personagem">Descri√ß√£o do Personagem:</label>
                <textarea id="descricao-personagem" placeholder="Digite a descri√ß√£o do seu personagem"></textarea>
            </section>
            <section id="recursos">
                <h2>Recursos</h2>
                <div class="vida-magia-vigor">
                    <div class="atributo-container vida">
                        <h3>Vida</h3>
                        <div class="valor-total medieval-box">
                            <span>Vida Total: </span>
                            <span id="vida-total" readonly>50</span>
                        </div>
                        <div class="valor-atual medieval-box">
                            <span>Vida Atual: </span>
                            <button id="btn-diminuir-vida" title="Diminuir Vida" class="control-btn">‚ñº</button>
                            <span id="vida-atual">50</span>
                            <button id="btn-aumentar-vida" title="Aumentar Vida" class="control-btn">‚ñ≤</button>
                        </div>
                        <div class="regeneracao">
                            <span>Regenera√ß√£o por turno: <span id="regeneracao-vida">0</span> (parado)</span>
                        </div>
                    </div>
                    <div class="atributo-container magia">
                        <h3>Magia</h3>
                        <div class="valor-total medieval-box">
                            <span>Magia Total: </span>
                            <span id="magia-total" readonly>20</span>
                        </div>
                        <div class="valor-atual medieval-box">
                            <span>Magia Atual: </span>
                            <button id="btn-diminuir-magia" title="Diminuir Magia" class="control-btn">‚ñº</button>
                            <span id="magia-atual">20</span>
                            <button id="btn-aumentar-magia" title="Aumentar Magia" class="control-btn">‚ñ≤</button>
                        </div>
                        <div class="regeneracao">
                            <span>Regenera√ß√£o por turno: <span id="regeneracao-magia">0</span></span>
                        </div>
                    </div>
                    <div class="atributo-container vigor">
                        <h3>Vigor</h3>
                        <div class="valor-total medieval-box">
                            <span>Vigor Total: </span>
                            <span id="vigor-total" readonly>10</span>
                        </div>
                        <div class="valor-atual medieval-box">
                            <span>Vigor Atual: </span>
                            <button id="btn-diminuir-vigor" title="Diminuir Vigor" class="control-btn">‚ñº</button>
                            <span id="vigor-atual">10</span>
                            <button id="btn-aumentar-vigor" title="Aumentar Vigor" class="control-btn">‚ñ≤</button>
                        </div>
                        <div class="regeneracao">
                            <span>Regenera√ß√£o por turno: <span id="regeneracao-vigor">0</span> (parado)</span>
                        </div>
                    </div>
                </div>
            </section>
            <section id="atributos">
                <h2>Atributos</h2>
                <div class="atributos-container">
                    <div class="atributos-coluna">
                        <div class="atributo">
                            <label for="forca" title="Afeta ataque e RDF">For√ßa:</label>
                            <input type="number" id="forca" value="0" min="0">
                        </div>
                        <div class="atributo">
                            <label for="destreza" title="Afeta ataque e acerto">Destreza:</label>
                            <input type="number" id="destreza" value="0" min="0">
                        </div>
                        <div class="atributo">
                            <label for="agilidade" title="Afeta esquiva e acerto">Agilidade:</label>
                            <input type="number" id="agilidade" value="0" min="0">
                        </div>
                        <div class="atributo">
                            <label for="constituicao" title="Afeta vida, magia e vigor">Constitui√ß√£o:</label>
                            <input type="number" id="constituicao" value="0" min="0">
                        </div>
                        <div class="atributo">
                            <label for="inteligencia" title="Afeta ataque m√°gico e RDM">Intelig√™ncia:</label>
                            <input type="number" id="inteligencia" value="0" min="0">
                        </div>
                    </div>
                    <div class="atributos-coluna-destaque">
                        <div class="atributo-destaque">
                            <label>Ataque:</label>
                            <span id="ataque" readonly>0</span>
                        </div>
                        <div class="atributo-destaque">
                            <label>Ataque M√°gico:</label>
                            <span id="ataque-magico" readonly>0</span>
                        </div>
                        <div class="atributo-destaque">
                            <label>Acerto:</label>
                            <span id="acerto" readonly>0</span>
                        </div>
                        <div class="atributo-destaque">
                            <label>Esquiva:</label>
                            <span id="esquiva" readonly>0</span>
                        </div>
                        <div class="atributo-destaque">
                            <label>RDF:</label>
                            <span id="rdf" readonly>0</span>
                        </div>
                        <div class="atributo-destaque">
                            <label>RDM:</label>
                            <span id="rdm" readonly>0</span>
                        </div>
                    </div>
                </div>
            </section>
            <section id="combate">
                <h2>Combate</h2>
                <div class="armamento-container md:flex md:gap-4">
                    <div class="armamento-coluna md:w-1/2">
                        <label>Armamento M√£o Direita:</label>
                        <div class="flex items-center mb-2 flex-wrap">
                            <input type="text" id="arma-direita-nome" placeholder="Nome da Arma" class="mr-2 mb-1 md:mb-0 flex-grow">
                            <span class="mr-1">Atq</span>
                            <input type="number" id="arma-direita-ataque" value="0" class="w-20 mr-2 mb-1 md:mb-0">
                            <span class="mr-1">AtqM</span>
                            <input type="number" id="arma-direita-ataque-magico" value="0" class="w-20 mb-1 md:mb-0">
                        </div>
                    </div>
                    <div class="armamento-coluna md:w-1/2">
                        <label>Armamento M√£o Esquerda:</label>
                        <div class="flex items-center flex-wrap">
                            <input type="text" id="arma-esquerda-nome" placeholder="Nome da Arma" class="mr-2 mb-1 md:mb-0 flex-grow">
                            <span class="mr-1">Atq</span>
                            <input type="number" id="arma-esquerda-ataque" value="0" class="w-20 mr-2 mb-1 md:mb-0">
                            <span class="mr-1">AtqM</span>
                            <input type="number" id="arma-esquerda-ataque-magico" value="0" class="w-20 mb-1 md:mb-0">
                        </div>
                    </div>
                </div>
            </section>
            <section id="inventario-habilidades">
                <h2>Invent√°rio e Habilidades</h2>
                <div class="flex flex-col md:flex-row gap-4 md:gap-8">
                    <div class="md:w-1/2">
                        <label>Invent√°rio (Peso Total: <span id="peso-total">0</span> kg / <span id="capacidade-carga">5</span> kg):</label>
                        <div id="inventario-slots">
                            <div class="inventory-slot"><input type="text" placeholder="Item 1" class="inventory-item"><input type="number" min="0" value="0" class="inventory-weight" title="Peso em kg"></div>
                            <div class="inventory-slot"><input type="text" placeholder="Item 2" class="inventory-item"><input type="number" min="0" value="0" class="inventory-weight"></div>
                            <div class="inventory-slot"><input type="text" placeholder="Item 3" class="inventory-item"><input type="number" min="0" value="0" class="inventory-weight"></div>
                            <div class="inventory-slot"><input type="text" placeholder="Item 4" class="inventory-item"><input type="number" min="0" value="0" class="inventory-weight"></div>
                            <div class="inventory-slot"><input type="text" placeholder="Item 5" class="inventory-item"><input type="number" min="0" value="0" class="inventory-weight"></div>
                            <div class="inventory-slot"><input type="text" placeholder="Item 6" class="inventory-item"><input type="number" min="0" value="0" class="inventory-weight"></div>
                            <div class="inventory-slot"><input type="text" placeholder="Item 7" class="inventory-item"><input type="number" min="0" value="0" class="inventory-weight"></div>
                            <div class="inventory-slot"><input type="text" placeholder="Item 8" class="inventory-item"><input type="number" min="0" value="0" class="inventory-weight"></div>
                            <div class="inventory-slot"><input type="text" placeholder="Item 9" class="inventory-item"><input type="number" min="0" value="0" class="inventory-weight"></div>
                            <div class="inventory-slot"><input type="text" placeholder="Item 10" class="inventory-item"><input type="number" min="0" value="0" class="inventory-weight"></div>
                        </div>
                    </div>
                    <div class="md:w-1/2">
                        <label>Magias e Habilidades:</label>
                        <div id="magias-list" class="magias-container">
                            <input type="text" placeholder="Magia/Habilidade 1" class="magia-nome">
                            <input type="text" placeholder="Magia/Habilidade 2" class="magia-nome">
                            <input type="text" placeholder="Magia/Habilidade 3" class="magia-nome">
                            <input type="text" placeholder="Magia/Habilidade 4" class="magia-nome">
                            <input type="text" placeholder="Magia/Habilidade 5" class="magia-nome">
                            <input type="text" placeholder="Magia/Habilidade 6" class="magia-nome">
                            <input type="text" placeholder="Magia/Habilidade 7" class="magia-nome">
                            <input type="text" placeholder="Magia/Habilidade 8" class="magia-nome">
                            <input type="text" placeholder="Magia/Habilidade 9" class="magia-nome">
                            <input type="text" placeholder="Magia/Habilidade 10" class="magia-nome">
                        </div>
                        <button id="adicionar-magia-btn">Adicionar Magia</button>
                    </div>
                </div>
                <div class="mt-4">
                    <label>Vantagens:</label>
                    <div id="vantagens-list-display" class="list-display"></div>
                    <label>Desvantagens:</label>
                    <div id="desvantagens-list-display" class="list-display"></div>
                </div>
                <div class="classe-raca-container">
                    <label>Classe:</label>
                    <input type="text" id="classe-nome" placeholder="Nome da Classe">
                    <textarea id="classe-descricao" placeholder="Descri√ß√£o da Classe" class="expandable-textarea"></textarea>
                    <label>Ra√ßa:</label>
                    <span id="raca-nome" onclick="abrirModalRaca()">Clique para selecionar/editar Ra√ßa</span>
                    <textarea id="raca-descricao" placeholder="Descri√ß√£o da Ra√ßa" class="expandable-textarea" readonly></textarea>
                </div>
            </section>
            <section id="locomocao">
                <h2>Locomo√ß√£o</h2>
                <div class="locomotion-container">
                    <div class="locomotion-item">
                        <label>Velocidade de Corrida (km/h):</label><span>üèÉ‚Äç‚ôÇÔ∏è</span><span id="velocidade-corrida" readonly>25</span>
                    </div>
                    <div class="locomotion-item">
                        <label>Altura do Pulo (m):</label><span>‚¨ÜÔ∏è</span><span id="altura-pulo" readonly>1</span>
                    </div>
                    <div class="locomotion-item">
                        <label>Dist√¢ncia do Pulo (m):</label><span>‚û°Ô∏è</span><span id="distancia-pulo" readonly>3</span>
                    </div>
                </div>
            </section>
            <section id="status">
                <h2>Status</h2>
                <div class="flex flex-col md:flex-row gap-4 md:gap-8">
                    <div class="md:w-1/2">
                        <label for="experiencia">Experi√™ncia:</label>
                        <input type="number" id="experiencia" value="0" min="0">
                        <label>Pontos de Habilidade (PD):</label>
                        <span id="pontos-habilidade" readonly>25</span>
                        <label>Pontos de Vantagem (PH):</label>
                        <span id="pontos-vantagem" readonly>8</span>
                    </div>
                    <div class="md:w-1/2" id="nivel-container">
                        <label>N√≠vel:</label>
                        <span id="nivel">0</span>
                    </div>
                </div>
            </section>

            <div class="flex justify-center gap-2 md:gap-5 my-5 flex-wrap">
                <button id="vantagens-desvantagens-btn" class="botao">Vantagens e Desvantagens</button>
                <button id="racas-btn" class="botao">Ra√ßas üè∞</button>
                <button id="classes-btn" class="botao">Classes ‚öîÔ∏è</button>
            </div>

            <div class="botoes-container">
                <button id="reset-pontos" class="botao botao-reset">Reiniciar Pontos</button>
                <button id="recomecar" class="botao botao-recomecar">Recome√ßar</button>
                <button id="bloquear-ficha" class="botao botao-bloquear">Bloquear Ficha</button>
                <button id="plano-fundo-btn" class="botao">Plano de fundo</button>
                <button id="excluir-ficha" class="botao">Excluir Ficha Atual</button>
            </div>

            <div class="theme-color-container">
                <button id="lua-btn" class="botao icon-btn">üåô</button>
                <button id="sol-btn" class="botao icon-btn">‚òÄÔ∏è</button>
                <div class="theme-option">
                    <label for="background-color-input" id="cor-fundo-visual-btn" class="botao icon-btn" title="Cor de Fundo" style="cursor: pointer;">üé®</label>
                    <input type="color" id="background-color-input" style="visibility: hidden; width: 0; height: 0; padding:0; margin:0; border:none;">
                </div>
                <div class="theme-option">
                    <select id="font-selector" class="botao" title="Fonte Principal" style="padding: 10px 15px; height: 44px; background-color: #800000; color:white; border:none; border-radius:6px; font-family:'MedievalSharp', serif;">
                        <option value="'Inter', sans-serif">Padr√£o (Inter)</option>
                        <option value="'MedievalSharp', cursive">Medieval</option>
                        <option value="'Times New Roman', Times, serif">Times New Roman</option>
                        <option value="'Arial', Helvetica, sans-serif">Arial</option>
                        <option value="'Courier New', Courier, monospace">Courier New</option>
                        <option value="'Georgia', serif">Georgia</option>
                        <option value="'Verdana', Geneva, sans-serif">Verdana</option>
                    </select>
                </div>
            </div>
        </div> </div> <button id="anotacoes-btn">Anota√ß√µes</button>
    <textarea id="anotacoes-textarea" placeholder="Suas anota√ß√µes aqui..."></textarea>

    <div id="vantagens-desvantagens-panel">
        <h2>Vantagens e Desvantagens</h2>
        <div>Pontos de Vantagem Tempor√°rios: <span id="ph-temp">0</span></div>
        <div id="vantagens-list"></div>
        <div id="desvantagens-list"></div>
        <button id="salvar-vantagens-btn">SALVAR</button>
        <button id="fechar-pagina-btn">Fechar P√°gina</button>
    </div>
    <div id="racas-panel">
        <h2>Ra√ßas</h2>
        <div id="ph-temp-raca-container" style="text-align: center; margin-bottom: 10px;">Pontos de Vantagem Tempor√°rios: <span id="ph-temp-raca">0</span></div> <div id="racas-list"></div>
        <button id="salvar-racas-btn">SALVAR</button>
        <button id="fechar-racas-btn">Fechar P√°gina</button>
    </div>
    <div id="classes-panel">
        <h2>Classes</h2>
        <button id="fechar-classes-btn">Fechar P√°gina</button>
    </div>
    <div id="nome-ficha-modal" class="modal">
        <div class="modal-content">
            <h3>D√™ um Nome √† Ficha</h3>
            <input type="text" id="nome-ficha-input" placeholder="Nome da ficha" maxlength="20">
            <button class="confirm-btn" id="confirmar-criar-ficha-btn">Confirmar</button> <button class="cancel-btn" onclick="fecharModal('nome-ficha-modal')">Cancelar</button>
        </div>
    </div>
    <div id="bloquear-ficha-modal" class="modal">
        <div class="modal-content">
            <h3>Ponha sua Senha de 4 D√≠gitos</h3>
            <input type="password" id="senha-bloqueio-input" placeholder="Senha (4 d√≠gitos)" maxlength="4">
            <button class="confirm-btn" id="confirmar-bloquear-ficha-btn">Confirmar</button> <button class="cancel-btn" onclick="fecharModal('bloquear-ficha-modal')">Cancelar</button>
        </div>
    </div>
    <div id="password-modal" class="modal">
        <div class="modal-content">
            <h3>Digite sua Senha</h3>
            <input type="password" id="senha-desbloqueio-input" placeholder="Senha (4 d√≠gitos)" maxlength="4">
            <button class="confirm-btn" id="confirmar-desbloquear-ficha-btn">Confirmar</button> <button class="cancel-btn" onclick="cancelarDesbloqueio()">Cancelar</button>
        </div>
    </div>
    <div id="confirmar-compra-modal" class="modal">
        <div class="modal-content">
            <h3>Tem certeza que quer comprar isso?</h3>
            <button class="confirm-btn" id="confirmar-compra-btn">Sim</button>
            <button class="cancel-btn" onclick="fecharModal('confirmar-compra-modal')">N√£o</button>
        </div>
    </div>
    <div id="salvar-vantagens-modal" class="modal"> <div class="modal-content">
            <h3 id="salvar-modal-texto">Se salvar, as altera√ß√µes n√£o poder√£o ser desfeitas.</h3>
            <button class="confirm-btn" id="confirmar-salvar-btn">OK</button> <button class="cancel-btn" onclick="fecharModal('salvar-vantagens-modal')">Cancelar</button>
        </div>
    </div>
    <div id="senha-gm-modal" class="modal">
        <div class="modal-content">
            <h3 id="senha-gm-titulo">Pe√ßa permiss√£o ao GM</h3>
            <input type="password" id="senha-gm-input" placeholder="Senha GM">
            <button class="confirm-btn" id="confirmar-senha-gm-btn">Confirmar</button>
            <button class="cancel-btn" onclick="fecharModal('senha-gm-modal')">Cancelar</button>
        </div>
    </div>
    <div id="raca-opcoes-modal" class="modal">
        <div class="modal-content">
            <h3>O que voc√™ deseja fazer?</h3>
            <button class="confirm-btn" id="excluir-raca-modal-btn">Excluir Ra√ßa</button> <button class="confirm-btn" id="editar-raca-modal-btn" style="margin-top: 10px;">Editar Ra√ßa</button> <button class="cancel-btn" onclick="fecharModal('raca-opcoes-modal')">Cancelar</button>
        </div>
    </div>
    <div id="editar-raca-modal" class="modal">
        <div class="modal-content">
            <h3>Editar Ra√ßa</h3>
            <label for="editar-raca-nome">Nome:</label>
            <input type="text" id="editar-raca-nome">
            <label for="editar-raca-descricao">Descri√ß√£o:</label>
            <textarea id="editar-raca-descricao"></textarea>
            <button class="confirm-btn" id="salvar-edicao-raca-btn">Salvar</button> <button class="cancel-btn" onclick="fecharModal('editar-raca-modal')">Cancelar</button>
        </div>
    </div>
    <div id="notification"></div>
    <div id="background-modal" class="modal">
        <div class="modal-content">
            <h3>Plano de Fundo</h3>
            <label for="background-image-input">Selecionar Imagem:</label>
            <input type="file" id="background-image-input" accept="image/*">
            <div class="radio-group">
                <label><input type="radio" name="background-size" value="cover" checked>Preencher Tela</label>
                <label><input type="radio" name="background-size" value="100% 100%">Estender</label>
                <label><input type="radio" name="background-size" value="auto">Tamanho Normal</label>
            </div>
            <button class="confirm-btn" id="aplicar-plano-de-fundo-btn">Aplicar</button> <button class="cancel-btn" onclick="fecharModal('background-modal')">Cancelar</button>
            <button class="cancel-btn" id="excluir-plano-de-fundo-btn">Excluir Imagem</button> </div>
    </div>

    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, remove, push, off } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-database.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBbbwbwPXv6gztkyP3TXK-DtooEI7FcClI",
            authDomain: "ficha-de-rpg-b9685.firebaseapp.com",
            databaseURL: "https://ficha-de-rpg-b9685-default-rtdb.firebaseio.com",
            projectId: "ficha-de-rpg-b9685",
            storageBucket: "ficha-de-rpg-b9685.appspot.com", // Corrected storageBucket
            messagingSenderId: "528610398062",
            appId: "1:528610398062:web:8fdb9cfd5ded8167613b7f"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        // Constantes e Vari√°veis Globais (adaptadas)
        const FICHA_MATRIZ_ID = "ficha-matriz-online"; // Use um ID diferente para a vers√£o online
        let currentFichaId = null;
        let globalFichasData = {}; // Para armazenar os dados de todas as fichas carregadas para as abas
        let activeFichaListener = null; // Para desativar o listener da ficha anterior

        // Vari√°veis de estado da ficha (como antes, mas ser√£o populadas pelo Firebase)
        let isFichaLocked = false, fichaPassword = null,
            isFichaUnlocked = false, senhaMatriz = "1040", vantagensSelecionadas = [],
            desvantagensSelecionadas = [], tempVantagensSelecionadas = [], tempDesvantagensSelecionadas = [],
            racaSelecionada = null, tempRacaSelecionada = null, vidaTotal, vidaAtual, magiaTotal, magiaAtual,
            vigorTotal, vigorAtual, previousValues = new Map();

        // Dados est√°ticos (vantagens, desvantagens, ra√ßas, n√≠veis) permanecem os mesmos
        const vantagensData = [
            { nome: "Maestria com Armas curtas (2)", custo: 2, descricao: "+1 em ataque, +1 em acerto com armas curtas." }, { nome: "Maestria com armas pesadas (2)", custo: 2, descricao: "+2 em ataque com armas pesadas." }, { nome: "Maestria com armas de longo alcance (2)", custo: 2, descricao: "+2 em acerto com armas de longo alcance." }, { nome: "Furtar (2)", custo: 2, descricao: "+4 em testes de furto." }, { nome: "L√°bia (2)", custo: 2, descricao: "+5 em testes de l√°bia." }, { nome: "Velejar (1)", custo: 1, descricao: "" }, { nome: "Beleza (1)", custo: 1, descricao: "+3 o teste em l√°bia, paquera e persuas√£o." }, { nome: "Boa Fama (2)", custo: 2, descricao: "+4 chance de descontos em armamentos, pousadas, alimentos, etc." }, { nome: "Arremedo (2)", custo: 2, descricao: "Capacidade de imitar qualquer som SIMPLES." }, { nome: "Destemor (1)", custo: 1, descricao: "Dificilmente √© assustado por algo." }, { nome: "Empatia (3)", custo: 3, descricao: "Sensibilidade extraordin√°ria em rela√ß√£o aos outras pessoas. Excelente para identificar impostores, possess√µes por espirito, etc." }, { nome: "Empatia com animais (1)", custo: 1, descricao: "Pode compreender as motiva√ß√µes dos animais." }, { nome: "Patrono (4)", custo: 4, descricao: "Possui um mentor/mestre/professor, at√© mesmo uma organiza√ß√£o/guilda que pode lhe oferecer ajuda." }, { nome: "Reconhecimento Social (2)", custo: 2, descricao: "Membro de um grupo respeitado/temido/venerado. +2 teste em l√°bia, paquera e persuas√£o." }, { nome: "Riqueza (2)", custo: 2, descricao: "Inicia com 20 moedas de ouro." }, { nome: "Aptid√£o para magia (4)", custo: 4, descricao: "+15% dano e -15% custo de magia para a magia que tem aptid√£o." }, { nome: "Combo F√≠sico (4)", custo: 4, descricao: "Inicia com 50km velocidade corrida, pulo de 3m altura e 9m dist√¢ncia.", restricao: "inicio" }, { nome: "Nadar (1)", custo: 1, descricao: "" }, { nome: "Escalar (2)", custo: 2, descricao: "" }, { nome: "Segunda l√≠ngua (1)", custo: 1, descricao: "Fala mais um idioma." }, { nome: "Paquerador (2)", custo: 2, descricao: "+4 em teste para paquera e persuas√£o envolvendo flerte." }, { nome: "Senso de perigo (5)", custo: 5, descricao: "Quando algo grave ocorrer o mestre pedir√° pra voc√™ jogar um dado para reagir." }, { nome: "Acrobata (3)", custo: 3, descricao: "+ fama ao lutar em p√∫blico." }, { nome: "Equil√≠brio Perfeito (3)", custo: 3, descricao: "+8 em testes de equil√≠brio." }, { nome: "Tecnologia (2)", custo: 2, descricao: "Engenhoso, pode inventar coisas, criar objetos improvisados." }, { nome: "Poder Oculto (7)", custo: 7, descricao: "Com 10% vida, ativa +50% em todos atributos. Volta ao normal acima de 10% vida." }, { nome: "Sobreviv√™ncia em floresta (2)", custo: 2, descricao: "Facilidade para achar cavernas, criar assentamentos, achar comida, gravar caminhos, achar √°gua, etc." }
        ];
        const desvantagensData = [
            { nome: "Fobia (+2)", ganho: 2, descricao: "Medo irracional de algo espec√≠fico." }, { nome: "M√° Fama (+2)", ganho: 2, descricao: "Mal visto pela sociedade, dificultando intera√ß√µes sociais." }, { nome: "Alcoolismo (+2)", ganho: 2, descricao: "Depend√™ncia de √°lcool que afeta suas decis√µes." }, { nome: "Altru√≠smo (+2)", ganho: 2, descricao: "Se sacrifica por outras pessoas, pouco se importa com fama ou riqueza." }, { nome: "Avareza (+2)", ganho: 2, descricao: "Preocupa√ß√£o permanente na conserva√ß√£o de riquezas." }, { nome: "Bullying (+3)", ganho: 3, descricao: "Gosta de ca√ßoar, agredir, denegrir, difamar e apontar defeitos." }, { nome: "Circunspe√ß√£o (+2)", ganho: 2, descricao: "N√£o entende piadas, entende tudo literal e acredita que todos est√£o s√©rios." }, { nome: "Compuls√µes (+3)", ganho: 3, descricao: "H√°bito ou v√≠cio que toma boa parte dos seus recursos e tempo." }, { nome: "Covardia (+2)", ganho: 2, descricao: "Extremo cuidado com bem-estar f√≠sico e dificuldade em assumir riscos." }, { nome: "Dependentes (+4)", ganho: 4, descricao: "Algu√©m depende de voc√™ a todo momento (filhos, parentes, etc.)." }, { nome: "F√∫ria (+2)", ganho: 2, descricao: "Tend√™ncia a perder o controle e atacar freneticamente (ativado por dano, insulto ou aleat√≥rio)." }, { nome: "Honestidade (+3)", ganho: 3, descricao: "N√£o consegue mentir ou omitir, sempre fala a verdade e desmascara mentiras." }, { nome: "Impulsividade (+2)", ganho: 2, descricao: "Sempre age sem pensar." }, { nome: "Lux√∫ria (+2)", ganho: 2, descricao: "Desejo incontrol√°vel por romance." }, { nome: "Magnetismo Sobrenatural (+2)", ganho: 2, descricao: "Coisas estranhas acontecem com seu personagem em n√≠vel alarmante." }, { nome: "No Limite (+4)", ganho: 4, descricao: "Assume riscos extremamente irracionais diante de perigo mortal." }, { nome: "Teimosia (+1)", ganho: 1, descricao: "Quer sempre fazer as coisas do seu modo, n√£o segue planos que n√£o sejam seus." }, { nome: "Amn√©sia (+2)", ganho: 2, descricao: "Em certos momentos, n√£o consegue lembrar de coisas importantes." }
        ];
        let racasData = [
            { nome: "Humano (3)", custo: 3, descricao: "Vers√°teis, ambiciosos, mestres em adapta√ß√£o.", vantagens: ["Explorador Nato: Cavalo superior, equipamentos, mapa detalhado.", "Mestre das Profiss√µes: Escolha (Ferreiro Lend√°rio, Costureiro Arcano, Arquiteto Vision√°rio) com benef√≠cios √∫nicos.", "Rede de Influ√™ncia: Aliado influente (guildas, mercadores, l√≠deres) com acesso a informa√ß√µes ou ajuda.", "Determina√ß√£o Inabal√°vel: Uma vez/dia, ignore uma desvantagem (exaust√£o, ferimento, magia) por um curto per√≠odo."] }, { nome: "Elfo (4)", custo: 4, descricao: "S√°bios, m√°gicos, conectados √† natureza.", vantagens: ["Sabedoria Ancestral: Domina √°rea (arcana, hist√≥ria, natureza), decifra itens antigos, aprende 1 l√≠ngua extra.", "Vis√£o √âlfica Suprema: Enxerga 10m escuro, detecta magias fracas 20m, percebe inten√ß√µes hostis (teste 19+).", "Escudo M√°gico: Resist√™ncia inata a um tipo de efeito m√°gico hostil (dano ou dura√ß√£o -50%)."] }, { nome: "An√£o (4)", custo: 4, descricao: "Resilientes, habilidosos, ligados √† terra.", vantagens: ["Fortitude Indom√°vel: Trabalha 3 dias sem descanso, recupera vida/energia 2x mais r√°pido em rocha/subterr√¢neo.", "Artes√£o: Escolha (Mestre Minerador, Forjador de Lendas, Joalheiro Divino) com impacto massivo.", "Senhor das Profundezas: Nunca se perde subterr√¢neo, detecta armadilhas, sente vibra√ß√µes (prever emboscada/colapso)."] }, { nome: "Orc (3)", custo: 3, descricao: "Guerreiros ferozes, l√≠deres pela for√ßa.", vantagens: ["Lenda entre Guerreiros: Inspira temor/respeito, alian√ßas marciais, acesso miss√µes √©picas; inimigos menores fogem (teste 16+).", "Resili√™ncia Brutal: Luta sem penalidades com ferimentos graves, s√≥ cai com PV 0, regenera ferimentos leves fora de combate.", "Dom√≠nio da Intimida√ß√£o: For√ßa inimigos a render/recuar com grito (1x/encontro, afeta grupos), b√¥nus massivo negocia√ß√µes (for√ßa/medo).", "F√∫ria Ancestral: F√∫ria 2x/dia (dobra for√ßa/resist√™ncia por curto per√≠odo)."] }, { nome: "Meio Animal (Selvagem) (4)", custo: 4, descricao: "Instinto primal com ast√∫cia.", vantagens: ["Sentidos Predat√≥rios: Escolha (vis√£o, olfato, audi√ß√£o) agu√ßado; rastreia km, detecta invis√≠veis, evita surpresa (teste 12+).", "Senhor dos Terrenos: Adapta-se a 1 ambiente (floresta, deserto, p√¢ntano), ignora efeitos negativos, b√¥nus movimento/furtividade (+1).", "Frenesi Instintivo: 1x/dia, velocidade sobrenatural (2x movimento), ataques adicionais, percep√ß√£o pr√©-monit√≥ria (10 min)."] }
        ];
        const nivelData = [
            { nivel: 0, xp: 0, pd: 25, ph: 8 }, { nivel: 1, xp: 10, pd: 31, ph: 9 }, { nivel: 2, xp: 30, pd: 37, ph: 10 }, { nivel: 3, xp: 60, pd: 43, ph: 11 }, { nivel: 4, xp: 100, pd: 49, ph: 12 }, { nivel: 5, xp: 150, pd: 55, ph: 13 }, { nivel: 6, xp: 210, pd: 61, ph: 14 }, { nivel: 7, xp: 280, pd: 67, ph: 15 }, { nivel: 8, xp: 360, pd: 73, ph: 16 }, { nivel: 9, xp: 450, pd: 79, ph: 17 }, { nivel: 10, xp: 550, pd: 85, ph: 18 }, { nivel: 11, xp: 670, pd: 91, ph: 19 }, { nivel: 12, xp: 810, pd: 97, ph: 20 }, { nivel: 13, xp: 970, pd: 103, ph: 21 }, { nivel: 14, xp: 1150, pd: 109, ph: 22 }, { nivel: 15, xp: 1350, pd: 115, ph: 23 }, { nivel: 16, xp: 1570, pd: 121, ph: 24 }, { nivel: 17, xp: 1810, pd: 127, ph: 25 }, { nivel: 18, xp: 2070, pd: 133, ph: 26 }, { nivel: 19, xp: 2350, pd: 139, ph: 27 }, { nivel: 20, xp: 2650, pd: 145, ph: 28 }, { nivel: 21, xp: 2980, pd: 148, ph: 29 }, { nivel: 22, xp: 3340, pd: 151, ph: 30 }, { nivel: 23, xp: 3730, pd: 154, ph: 31 }, { nivel: 24, xp: 4150, pd: 157, ph: 32 }, { nivel: 25, xp: 4600, pd: 160, ph: 33 }, { nivel: 26, xp: 5080, pd: 163, ph: 34 }, { nivel: 27, xp: 5590, pd: 166, ph: 35 }, { nivel: 28, xp: 6130, pd: 169, ph: 36 }, { nivel: 29, xp: 8000, pd: 219, ph: 37 }, { nivel: 30, xp: 10000, pd: 319, ph: 38 }
        ];

        // Cache DOM Elements (como antes)
        const nomePersonagemInput = document.getElementById("nome-personagem"), descricaoPersonagemInput = document.getElementById("descricao-personagem"),
            forcaInput = document.getElementById("forca"), destrezaInput = document.getElementById("destreza"), agilidadeInput = document.getElementById("agilidade"),
            inteligenciaInput = document.getElementById("inteligencia"), constituicaoInput = document.getElementById("constituicao"),
            ataqueSpan = document.getElementById("ataque"), ataqueMagicoSpan = document.getElementById("ataque-magico"), acertoSpan = document.getElementById("acerto"),
            esquivaSpan = document.getElementById("esquiva"), rdfSpan = document.getElementById("rdf"), rdmSpan = document.getElementById("rdm"),
            armaDireitaNomeInput = document.getElementById("arma-direita-nome"), armaDireitaAtaqueInput = document.getElementById("arma-direita-ataque"),
            armaDireitaAtaqueMagicoInput = document.getElementById("arma-direita-ataque-magico"), armaEsquerdaNomeInput = document.getElementById("arma-esquerda-nome"),
            armaEsquerdaAtaqueInput = document.getElementById("arma-esquerda-ataque"), armaEsquerdaAtaqueMagicoInput = document.getElementById("arma-esquerda-ataque-magico"),
            resetPontosButton = document.getElementById("reset-pontos"), recomecarButton = document.getElementById("recomecar"),
            bloquearFichaButton = document.getElementById("bloquear-ficha"), experienciaInput = document.getElementById("experiencia"),
            nivelSpan = document.getElementById("nivel"), pontosHabilidadeSpan = document.getElementById("pontos-habilidade"),
            pontosVantagemSpan = document.getElementById("pontos-vantagem"), velocidadeCorridaSpan = document.getElementById("velocidade-corrida"),
            alturaPuloSpan = document.getElementById("altura-pulo"), distanciaPuloSpan = document.getElementById("distancia-pulo"),
            nomePersonagemTitulo = document.getElementById("nome-personagem-titulo"), gameMasterMessage = document.getElementById("game-master-message"),
            vantagensListDisplay = document.getElementById("vantagens-list-display"), desvantagensListDisplay = document.getElementById("desvantagens-list-display"),
            inventarioSlots = document.getElementById("inventario-slots"), pesoTotalSpan = document.getElementById("peso-total"),
            capacidadeCargaSpan = document.getElementById("capacidade-carga"), 
            diceContainer = document.getElementById("dice-container"), diceRoll = document.getElementById("dice-roll"), diceResult = document.getElementById("dice-result"),
            notification = document.getElementById("notification"), characterImageInput = document.getElementById("character-image-input"),
            characterImage = document.getElementById("character-image"), vantagensDesvantagensBtn = document.getElementById("vantagens-desvantagens-btn"),
            vantagensDesvantagensPanel = document.getElementById("vantagens-desvantagens-panel"), vantagensList = document.getElementById("vantagens-list"),
            desvantagensList = document.getElementById("desvantagens-list"), salvarVantagensBtn = document.getElementById("salvar-vantagens-btn"),
            fecharPaginaBtn = document.getElementById("fechar-pagina-btn"), fichaContainer = document.getElementById("ficha-container"),
            magiasList = document.getElementById("magias-list"), adicionarMagiaBtn = document.getElementById("adicionar-magia-btn"),
            anotacoesBtn = document.getElementById("anotacoes-btn"), anotacoesTextarea = document.getElementById("anotacoes-textarea"),
            racasBtn = document.getElementById("racas-btn"), classesBtn = document.getElementById("classes-btn"), racasPanel = document.getElementById("racas-panel"),
            classesPanel = document.getElementById("classes-panel"), fecharRacasBtn = document.getElementById("fechar-racas-btn"),
            fecharClassesBtn = document.getElementById("fechar-classes-btn"), classeNomeInput = document.getElementById("classe-nome"),
            classeDescricaoInput = document.getElementById("classe-descricao"), racaNomeSpan = document.getElementById("raca-nome"),
            racaDescricaoInput = document.getElementById("raca-descricao"), luaBtn = document.getElementById("lua-btn"), solBtn = document.getElementById("sol-btn"),
            salvarRacasBtn = document.getElementById("salvar-racas-btn"), racasList = document.getElementById("racas-list"),
            atributosInputs = [forcaInput, destrezaInput, agilidadeInput, inteligenciaInput, constituicaoInput],
            planoFundoBtn = document.getElementById("plano-fundo-btn"),
            backgroundImageInput = document.getElementById("background-image-input"), backgroundModal = document.getElementById("background-modal"),
            backgroundColorInput = document.getElementById('background-color-input'), 
            backgroundColorButtonVisual = document.getElementById('cor-fundo-visual-btn'), 
            fontSelector = document.getElementById('font-selector'), 
            confirmarSalvarBtn = document.getElementById("confirmar-salvar-btn"),
            phTempRacaSpan = document.getElementById("ph-temp-raca"),
            senhaGmTitulo = document.getElementById("senha-gm-titulo"),
            addFichaBtn = document.getElementById("add-ficha-btn"),
            fichasSidebar = document.getElementById("fichas-sidebar"),
            confirmarCriarFichaBtn = document.getElementById("confirmar-criar-ficha-btn"),
            confirmarBloquearFichaBtn = document.getElementById("confirmar-bloquear-ficha-btn"),
            confirmarDesbloquearFichaBtn = document.getElementById("confirmar-desbloquear-ficha-btn"),
            excluirRacaModalBtn = document.getElementById("excluir-raca-modal-btn"),
            editarRacaModalBtn = document.getElementById("editar-raca-modal-btn"),
            salvarEdicaoRacaBtn = document.getElementById("salvar-edicao-raca-btn"),
            aplicarPlanoDeFundoBtn = document.getElementById("aplicar-plano-de-fundo-btn"),
            excluirPlanoDeFundoBtn = document.getElementById("excluir-plano-de-fundo-btn"),
            excluirFichaBtn = document.getElementById("excluir-ficha");


        let nivel = 0, nivelAnterior = 0, pontosHabilidadeTotal = 25, pontosHabilidadeUsados = 0, experiencia = 0, vidaBase = 50;
        let currentActionIntervalId = null; 
        const REPEAT_DELAY_MS = 75; 
        let xpUnlockTimerId = null;
        let isXpUnlocked = false; 
        const XP_UNLOCK_DURATION_MS = 20000;

        // --- Fun√ß√µes Firebase ---
        function getFichaRef(fichaId) {
            return ref(database, 'fichas/' + fichaId);
        }
        
        function getTodasFichasRef() {
            return ref(database, 'fichas');
        }

        async function criarFichaMatrizIfNeeded() {
            const matrizRef = getFichaRef(FICHA_MATRIZ_ID);
            onValue(matrizRef, (snapshot) => {
                if (!snapshot.exists()) {
                    const fichaMatrizData = {
                        nomeFicha: "Ficha Matriz (Modelo)",
                        nomePersonagem: "Personagem Modelo",
                        descricaoPersonagem: "Esta √© uma ficha modelo. Crie uma nova para come√ßar!",
                        forca: "0", destreza: "0", agilidade: "0", inteligencia: "0", constituicao: "0", experiencia: "0",
                        armaDireitaNome: "", armaDireitaAtaque: "0", armaDireitaAtaqueMagico: "0",
                        armaEsquerdaNome: "", armaEsquerdaAtaque: "0", armaEsquerdaAtaqueMagico: "0",
                        vantagens: "", magiasHabilidades: Array(10).fill("").join("\n"), desvantagens: "",
                        inventario: Array(10).fill({ item: "", peso: "0" }),
                        velocidadeCorrida: "25", alturaPulo: "1", distanciaPulo: "3",
                        isLocked: true, password: senhaMatriz, imagem: null, anotacoes: "",
                        classeNome: "", classeDescricao: "", racaNome: "", racaDescricao: "", racaSelecionada: "",
                        backgroundImage: null, backgroundSize: 'cover', backgroundColor: '#f0e6d2', 
                        fontFamily: "'Inter', sans-serif",
                        vidaAtual: 50, magiaAtual: 20, vigorAtual: 10
                    };
                    set(matrizRef, fichaMatrizData)
                        .then(() => console.log("Ficha Matriz criada no Firebase."))
                        .catch(err => console.error("Erro ao criar Ficha Matriz:", err));
                }
            }, { onlyOnce: true }); // onlyOnce para n√£o ficar recriando
        }


        function carregarAbasFichas() {
            const todasFichasRef = getTodasFichasRef();
            onValue(todasFichasRef, (snapshot) => {
                globalFichasData = snapshot.val() || {};
                atualizarAbasFichasUI();
                // Se currentFichaId n√£o estiver definido ou n√£o existir mais, carrega a matriz ou a primeira ficha
                if (!currentFichaId || !globalFichasData[currentFichaId]) {
                    const idsDisponiveis = Object.keys(globalFichasData).filter(id => id !== FICHA_MATRIZ_ID);
                    if (idsDisponiveis.length > 0) {
                        selecionarFicha(idsDisponiveis[0]);
                    } else {
                        selecionarFicha(FICHA_MATRIZ_ID);
                    }
                } else {
                     // For√ßa recarregamento da ficha atual se ela ainda for a mesma,
                     // para garantir que o listener est√° ativo para ela.
                     // Isso pode ser redundante se o listener j√° estiver ativo, mas garante.
                     selecionarFicha(currentFichaId);
                }
            });
        }
        
        function atualizarAbasFichasUI() {
            while (fichasSidebar.children.length > 1 && fichasSidebar.firstChild !== addFichaBtn) {
                 fichasSidebar.removeChild(fichasSidebar.firstChild);
            }

            // Adiciona a Ficha Matriz primeiro se existir
            if (globalFichasData[FICHA_MATRIZ_ID]) {
                const tabMatriz = criarElementoAba(FICHA_MATRIZ_ID, globalFichasData[FICHA_MATRIZ_ID].nomeFicha || "Matriz");
                fichasSidebar.insertBefore(tabMatriz, addFichaBtn);
            }

            for (let fichaId in globalFichasData) {
                if (fichaId !== FICHA_MATRIZ_ID) { 
                    const tab = criarElementoAba(fichaId, globalFichasData[fichaId].nomeFicha || "Sem Nome");
                    fichasSidebar.insertBefore(tab, addFichaBtn);
                }
            }
        }

        function criarElementoAba(fichaId, nome) {
            const tab = document.createElement("div"); 
            tab.className = "ficha-tab";
            const span = document.createElement("span"); 
            span.textContent = nome;
            tab.appendChild(span); 
            tab.dataset.fichaId = fichaId;
            if (fichaId === currentFichaId) tab.classList.add("active");
            
            tab.onclick = () => selecionarFicha(fichaId);
            return tab;
        }

        function selecionarFicha(fichaId) {
            if (activeFichaListener && currentFichaId) {
                const previousFichaRef = getFichaRef(currentFichaId);
                off(previousFichaRef, 'value', activeFichaListener); // Remove o listener antigo
                activeFichaListener = null;
            }

            currentFichaId = fichaId;
            // Atualiza a classe 'active' nas abas
            Array.from(fichasSidebar.querySelectorAll('.ficha-tab')).forEach(t => {
                t.classList.toggle('active', t.dataset.fichaId === currentFichaId);
            });
            carregarDadosFichaAtual();
        }

        function carregarDadosFichaAtual() {
            if (!currentFichaId) {
                console.log("Nenhuma ficha selecionada para carregar.");
                // Poderia limpar a UI ou carregar um estado padr√£o
                limparCamposFicha(); // Fun√ß√£o para limpar a UI
                return;
            }

            const fichaRef = getFichaRef(currentFichaId);
            // Remove listener anterior antes de adicionar um novo
            if (activeFichaListener) {
                 off(fichaRef, 'value', activeFichaListener);
            }

            activeFichaListener = onValue(fichaRef, (snapshot) => {
                const ficha = snapshot.val();
                if (ficha) {
                    popularCamposFicha(ficha);
                } else {
                    console.warn(`Ficha ${currentFichaId} n√£o encontrada no Firebase ou dados vazios.`);
                    if (currentFichaId !== FICHA_MATRIZ_ID) { // N√£o limpa se for a matriz e ela n√£o existir (deve ser criada)
                        limparCamposFicha();
                        showNotification(`Ficha "${currentFichaId}" n√£o encontrada.`, "critical-failure");
                    } else {
                        // Se for a matriz e n√£o existir, tentamos criar e recarregar
                        criarFichaMatrizIfNeeded().then(() => {
                            if(currentFichaId === FICHA_MATRIZ_ID) carregarDadosFichaAtual(); // Tenta recarregar a matriz
                        });
                    }
                }
            }, (error) => {
                console.error("Erro ao carregar dados da ficha do Firebase:", error);
                showNotification("Erro ao carregar ficha.", "critical-failure");
            });
        }
        
        function limparCamposFicha() {
            // Define todos os campos para valores padr√£o ou vazios
            nomePersonagemInput.value = ""; 
            descricaoPersonagemInput.value = "";
            forcaInput.value = "0"; destrezaInput.value = "0"; agilidadeInput.value = "0";
            inteligenciaInput.value = "0"; constituicaoInput.value = "0"; experienciaInput.value = "0";
            // ... e assim por diante para todos os campos.
            // Esta fun√ß√£o precisa ser completa para resetar a UI.
            // Por simplicidade, vou focar em popular quando os dados existem.
            // A l√≥gica de 'recomecarFicha' pode ser adaptada aqui.
            console.log("Limpando campos da ficha na UI.");
            // Basic reset:
            document.getElementById('ficha-content').querySelectorAll('input[type="text"], input[type="number"], textarea').forEach(el => {
                if(el.type === "number") el.value = "0"; else el.value = "";
            });
            vantagensSelecionadas = []; desvantagensSelecionadas = []; racaSelecionada = null;
            vantagensListDisplay.innerHTML = ""; desvantagensListDisplay.innerHTML = "";
            racaNomeSpan.textContent = "Clique para selecionar/editar Ra√ßa";
            racaDescricaoInput.value = "";
            // Resetar outros spans e elementos visuais
            vidaAtual = 50; magiaAtual = 20; vigorAtual = 10;
            // Chamar calcularAtributos para resetar os derivados
            calcularAtributos(); 
            atualizarBotaoBloquear();
        }


        function popularCamposFicha(ficha) {
            if (!ficha) return; // Seguran√ßa extra

            nomePersonagemInput.value = ficha.nomePersonagem || ""; 
            descricaoPersonagemInput.value = ficha.descricaoPersonagem || "";
            forcaInput.value = ficha.forca || "0"; 
            destrezaInput.value = ficha.destreza || "0"; 
            agilidadeInput.value = ficha.agilidade || "0";
            inteligenciaInput.value = ficha.inteligencia || "0"; 
            constituicaoInput.value = ficha.constituicao || "0"; 
            experienciaInput.value = ficha.experiencia || "0";
            armaDireitaNomeInput.value = ficha.armaDireitaNome || ""; 
            armaDireitaAtaqueInput.value = ficha.armaDireitaAtaque || "0"; 
            armaDireitaAtaqueMagicoInput.value = ficha.armaDireitaAtaqueMagico || "0";
            armaEsquerdaNomeInput.value = ficha.armaEsquerdaNome || ""; 
            armaEsquerdaAtaqueInput.value = ficha.armaEsquerdaAtaque || "0"; 
            armaEsquerdaAtaqueMagicoInput.value = ficha.armaEsquerdaAtaqueMagico || "0";
            velocidadeCorridaSpan.textContent = ficha.velocidadeCorrida || "25"; 
            alturaPuloSpan.textContent = ficha.alturaPulo || "1"; 
            distanciaPuloSpan.textContent = ficha.distanciaPulo || "3";
            
            isFichaLocked = ficha.isLocked || false; 
            fichaPassword = ficha.password || null; 
            isFichaUnlocked = false; // Sempre come√ßa bloqueada se a ficha estiver travada

            vantagensSelecionadas = ficha.vantagens ? ficha.vantagens.split("\n").filter(v => v.trim()) : [];
            desvantagensSelecionadas = ficha.desvantagens ? ficha.desvantagens.split("\n").filter(d => d.trim()) : [];
            racaSelecionada = ficha.racaSelecionada || null; // Usar null se n√£o houver
            
            racaNomeSpan.textContent = racaSelecionada ? racaSelecionada.split(" (")[0] : "Clique para selecionar/editar Ra√ßa";
            const racaDataAtual = racasData.find(r => r.nome === racaSelecionada);
            racaDescricaoInput.value = racaDataAtual ? (racaDataAtual.vantagens || []).join("\n\n") : "";

            vantagensListDisplay.innerHTML = ""; 
            desvantagensListDisplay.innerHTML = "";
            vantagensSelecionadas.forEach(v => { const div = document.createElement("div"); div.textContent = v; div.className = "list-item"; div.onclick = () => removerVantagem(v); vantagensListDisplay.appendChild(div); });
            desvantagensSelecionadas.forEach(d => { const div = document.createElement("div"); div.textContent = d; div.className = "list-item"; div.onclick = () => removerDesvantagem(d); desvantagensListDisplay.appendChild(div); });

            const inventario = Array.isArray(ficha.inventario) ? ficha.inventario : Array(10).fill({ item: "", peso: "0" });
            const slots = inventarioSlots.querySelectorAll(".inventory-slot");
            slots.forEach((slot, i) => { 
                slot.querySelector(".inventory-item").value = inventario[i]?.item || ""; 
                slot.querySelector(".inventory-weight").value = inventario[i]?.peso || "0"; 
            });
            calcularPesoTotal();

            const magias = ficha.magiasHabilidades ? ficha.magiasHabilidades.split("\n") : Array(10).fill("");
            magiasList.innerHTML = ""; // Limpa antes de adicionar
            const numMagiasAS Criar = Math.max(10, magias.length); // Garante pelo menos 10 campos
            for (let i = 0; i < numMagiasAS Criar; i++) {
                const input = document.createElement("input"); 
                input.type = "text"; 
                input.className = "magia-nome"; 
                input.placeholder = `Magia/Habilidade ${i + 1}`; 
                input.value = magias[i] || ""; 
                input.addEventListener('input', salvarDadosFichaAtual); 
                magiasList.appendChild(input);
            }
            
            anotacoesTextarea.value = ficha.anotacoes || ""; 
            classeNomeInput.value = ficha.classeNome || ""; 
            classeDescricaoInput.value = ficha.classeDescricao || "";
            
            if (ficha.imagem && ficha.imagem.startsWith('data:image')) { 
                characterImage.src = ficha.imagem; 
                characterImage.style.display = "block"; 
            } else { 
                characterImage.src = ''; 
                characterImage.style.display = "none"; 
            }

            atualizarBotaoBloquear(); 
            atualizarVantagensDesvantagensPanel(); // Precisa ser chamado para refletir estado atual
            atualizarRacasPanel(); // Precisa ser chamado para refletir estado atual
            
            experiencia = parseInt(ficha.experiencia) || 0;
            experienciaInput.readOnly = true; 
            isXpUnlocked = false; 
            if (xpUnlockTimerId) clearTimeout(xpUnlockTimerId); 

            vidaAtual = ficha.vidaAtual !== undefined ? ficha.vidaAtual : (parseInt(document.getElementById("vida-total").textContent) || 50);
            magiaAtual = ficha.magiaAtual !== undefined ? ficha.magiaAtual : (parseInt(document.getElementById("magia-total").textContent) || 20);
            vigorAtual = ficha.vigorAtual !== undefined ? parseFloat(ficha.vigorAtual) : (parseFloat(document.getElementById("vigor-total").textContent) || 10);


            atualizarNivel(); // Isso chama calcularAtributos

            document.getElementById("vida-atual").textContent = Math.min(vidaAtual, vidaTotal);
            document.getElementById("magia-atual").textContent = Math.min(magiaAtual, magiaTotal);
            document.getElementById("vigor-atual").textContent = Math.min(vigorAtual, vigorTotal).toFixed(1);
            
            // Garante que os valores atuais n√£o excedam os totais ap√≥s carregar
            vidaAtual = Math.min(vidaAtual, vidaTotal);
            magiaAtual = Math.min(magiaAtual, magiaTotal);
            vigorAtual = Math.min(vigorAtual, vigorTotal);

            pontosVantagemSpan.textContent = getPontosVantagem(); // Recalcula PH com base nos dados carregados
            
            previousValues.clear(); 
            document.querySelectorAll('input[type="text"],input[type="number"],textarea').forEach(input => {
                previousValues.set(input, input.value);
            });
            
            aplicarPlanoDeFundoInicial(ficha); 
            aplicarCorDeFundoInicial(ficha);   
            aplicarFonteInicial(ficha);
            document.body.classList.toggle("dark-mode", ficha.darkMode === true);
            nomePersonagemTitulo.textContent = ficha.nomeFicha || "Ficha de Personagem";
        }


        confirmarCriarFichaBtn.onclick = () => {
            const nomeFicha = document.getElementById("nome-ficha-input").value.trim();
            if (!nomeFicha) {
                alert("Por favor, d√™ um nome √† ficha!");
                return;
            }

            const novaFichaRef = push(getTodasFichasRef()); // Gera um ID √∫nico no Firebase
            const novaFichaId = novaFichaRef.key;

            const novaFichaData = {
                nomeFicha: nomeFicha,
                nomePersonagem: "", descricaoPersonagem: "", forca: "0", destreza: "0", agilidade: "0",
                inteligencia: "0", constituicao: "0", experiencia: "0", armaDireitaNome: "", armaDireitaAtaque: "0",
                armaDireitaAtaqueMagico: "0", armaEsquerdaNome: "", armaEsquerdaAtaque: "0", armaEsquerdaAtaqueMagico: "0",
                vantagens: "", magiasHabilidades: Array(10).fill("").join("\n"), desvantagens: "",
                inventario: Array(10).fill({ item: "", peso: "0" }),
                velocidadeCorrida: "25", alturaPulo: "1", distanciaPulo: "3",
                isLocked: false, password: null, imagem: null, anotacoes: "",
                classeNome: "", classeDescricao: "", racaNome: "", racaDescricao: "", racaSelecionada: null,
                backgroundImage: null, backgroundSize: 'cover', backgroundColor: '#f0e6d2',
                fontFamily: "'Inter', sans-serif",
                vidaAtual: 50, magiaAtual: 20, vigorAtual: 10
            };

            set(novaFichaRef, novaFichaData)
                .then(() => {
                    console.log("Nova ficha criada no Firebase com ID:", novaFichaId);
                    fecharModal("nome-ficha-modal");
                    selecionarFicha(novaFichaId); // Carrega e escuta a nova ficha
                    // atualizarAbasFichasUI() ser√° chamado pelo listener em 'fichas'
                })
                .catch(error => {
                    console.error("Erro ao criar nova ficha:", error);
                    alert("Erro ao criar ficha. Tente novamente.");
                });
        };

        function fecharModal(modalId) { document.getElementById(modalId).style.display = "none"; }

        function salvarDadosFichaAtual() {
            if (!currentFichaId || (isFichaLocked && !isFichaUnlocked)) {
                // N√£o salva se n√£o houver ficha atual ou se estiver bloqueada e n√£o desbloqueada
                // A verifica√ß√£o de bloqueio ao tentar editar campos j√° deve prevenir isso.
                return;
            }

            const inventario = Array.from(inventarioSlots.querySelectorAll(".inventory-slot")).map(slot => ({ 
                item: slot.querySelector(".inventory-item").value, 
                peso: slot.querySelector(".inventory-weight").value 
            }));
            const magias = Array.from(magiasList.querySelectorAll(".magia-nome")).map(input => input.value);
            
            const fichaDataParaSalvar = {
                nomeFicha: globalFichasData[currentFichaId]?.nomeFicha || "Sem Nome", // Mant√©m o nome da ficha
                nomePersonagem: nomePersonagemInput.value,
                descricaoPersonagem: descricaoPersonagemInput.value,
                forca: forcaInput.value,
                destreza: destrezaInput.value,
                agilidade: agilidadeInput.value,
                inteligencia: inteligenciaInput.value,
                constituicao: constituicaoInput.value,
                experiencia: experienciaInput.value,
                armaDireitaNome: armaDireitaNomeInput.value,
                armaDireitaAtaque: armaDireitaAtaqueInput.value,
                armaDireitaAtaqueMagico: armaDireitaAtaqueMagicoInput.value,
                armaEsquerdaNome: armaEsquerdaNomeInput.value,
                armaEsquerdaAtaque: armaEsquerdaAtaqueInput.value,
                armaEsquerdaAtaqueMagico: armaEsquerdaAtaqueMagicoInput.value,
                vantagens: vantagensSelecionadas.join("\n"),
                magiasHabilidades: magias.join("\n"),
                desvantagens: desvantagensSelecionadas.join("\n"),
                inventario: inventario,
                velocidadeCorrida: velocidadeCorridaSpan.textContent,
                alturaPulo: alturaPuloSpan.textContent,
                distanciaPulo: distanciaPuloSpan.textContent,
                isLocked: isFichaLocked,
                password: fichaPassword,
                imagem: characterImage.src.startsWith('data:image') ? characterImage.src : null,
                anotacoes: anotacoesTextarea.value,
                classeNome: classeNomeInput.value,
                classeDescricao: classeDescricaoInput.value,
                racaNome: racaNomeSpan.textContent, 
                racaDescricao: racaDescricaoInput.value,
                racaSelecionada: racaSelecionada,
                backgroundImage: document.body.style.backgroundImage === 'none' || document.body.style.backgroundImage === '' ? null : document.body.style.backgroundImage.slice(5, -2).replace(/"/g, "").replace(/'/g, ""),
                backgroundSize: document.body.style.backgroundSize || 'cover',
                backgroundColor: document.body.style.backgroundColor || '#f0e6d2',
                darkMode: document.body.classList.contains("dark-mode"),
                fontFamily: fontSelector ? fontSelector.value : "'Inter', sans-serif",
                vidaAtual: vidaAtual,
                magiaAtual: magiaAtual,
                vigorAtual: parseFloat(vigorAtual.toFixed(1))
            };
            
            // Atualiza o nome da ficha na lista global para as abas, se mudou no t√≠tulo
            // (Idealmente, o nome da ficha seria edit√°vel em um campo e salvo aqui tamb√©m)
            // Por ora, o nome da ficha √© definido na cria√ß√£o. Se precisar editar, seria uma nova feature.
            if (globalFichasData[currentFichaId] && nomePersonagemTitulo.textContent !== globalFichasData[currentFichaId].nomeFicha) {
                 // fichaDataParaSalvar.nomeFicha = nomePersonagemTitulo.textContent; // Se o t√≠tulo fosse edit√°vel para nome da ficha
            }


            set(getFichaRef(currentFichaId), fichaDataParaSalvar)
                .then(() => {
                    showNotification("Salvo no Firebase!", "save-success");
                })
                .catch(error => {
                    console.error("Erro ao salvar no Firebase:", error);
                    showNotification("Erro ao salvar!", "critical-failure");
                });
        }
        
        // --- Fun√ß√µes de c√°lculo e UI (a maioria permanece similar, mas 'salvarDados' agora √© 'salvarDadosFichaAtual') ---
        // Adapte chamadas de 'salvarDados()' para 'salvarDadosFichaAtual()' onde apropriado

        function calcularNivel(exp) { return nivelData.findLast(data => exp >= data.xp)?.nivel ?? 0; }

        function atualizarNivel() {
            nivelAnterior = nivel; 
            nivel = calcularNivel(experiencia); 
            nivelSpan.textContent = nivel;
            const nivelInfo = nivelData.find(data => data.nivel === nivel) || nivelData[0];
            pontosHabilidadeTotal = nivelInfo.pd;
            // getPontosVantagem() ser√° chamado em popularCamposFicha ou quando vantagens/ra√ßa mudam
            if (nivel > nivelAnterior) { 
                nivelSpan.classList.add("aura-azul"); 
                setTimeout(() => nivelSpan.classList.remove("aura-azul"), 20000); 
            }
            gameMasterMessage.style.display = nivel >= 30 ? "block" : "none"; 
            fichaContainer.classList.toggle("aura-azul", nivel >= 30);
            calcularAtributos(); // Importante chamar ap√≥s atualizar n√≠vel e PH
        }

        function getPontosVantagem() {
            let ph = (nivelData.find(data => data.nivel === nivel) || nivelData[0]).ph;
            vantagensSelecionadas.forEach(vNome => { 
                const vantagem = vantagensData.find(d => d.nome === vNome); 
                if (vantagem) ph -= vantagem.custo; 
            });
            desvantagensSelecionadas.forEach(dNome => { 
                const desvantagem = desvantagensData.find(desv => desv.nome === dNome); 
                if (desvantagem) ph += desvantagem.ganho; 
            });
            if (racaSelecionada) { 
                const raca = racasData.find(r => r.nome === racaSelecionada); 
                if (raca) ph -= raca.custo; 
            }
            return ph;
        }

        function calcularPontosVantagemTemp() { // Usado nos pain√©is de sele√ß√£o
            let ph = (nivelData.find(data => data.nivel === nivel) || nivelData[0]).ph;
            tempVantagensSelecionadas.forEach(vNome => { 
                const vantagem = vantagensData.find(d => d.nome === vNome); 
                if (vantagem) ph -= vantagem.custo; 
            });
            tempDesvantagensSelecionadas.forEach(dNome => { 
                const desvantagem = desvantagensData.find(desv => desv.nome === dNome); 
                if (desvantagem) ph += desvantagem.ganho; 
            });
            if (tempRacaSelecionada) { 
                const raca = racasData.find(r => r.nome === tempRacaSelecionada); 
                if (raca) ph -= raca.custo; 
            }
            return ph;
        }

        function aumentarVida() { if (vidaAtual < vidaTotal) { vidaAtual++; document.getElementById("vida-atual").textContent = vidaAtual; salvarDadosFichaAtual(); } }
        function diminuirVida() { if (vidaAtual > 0) { vidaAtual--; document.getElementById("vida-atual").textContent = vidaAtual; salvarDadosFichaAtual(); } }
        function aumentarMagia() { if (magiaAtual < magiaTotal) { magiaAtual++; document.getElementById("magia-atual").textContent = magiaAtual; salvarDadosFichaAtual(); } }
        function diminuirMagia() { if (magiaAtual > 0) { magiaAtual--; document.getElementById("magia-atual").textContent = magiaAtual; salvarDadosFichaAtual(); } }
        function aumentarVigor() { if (vigorAtual < vigorTotal) { vigorAtual = Math.min(vigorAtual + 0.1, vigorTotal); document.getElementById("vigor-atual").textContent = vigorAtual.toFixed(1); salvarDadosFichaAtual(); } }
        function diminuirVigor() { if (vigorAtual > 0) { vigorAtual = Math.max(vigorAtual - 0.1, 0); document.getElementById("vigor-atual").textContent = vigorAtual.toFixed(1); salvarDadosFichaAtual(); } }

        function calcularAtributos() {
            let currentForca = parseInt(forcaInput.value) || 0;
            let currentDestreza = parseInt(destrezaInput.value) || 0;
            let currentAgilidade = parseInt(agilidadeInput.value) || 0;
            let currentInteligencia = parseInt(inteligenciaInput.value) || 0;
            let currentConstituicao = parseInt(constituicaoInput.value) || 0;

            let totalPontosAtuais = currentForca + currentDestreza + currentAgilidade + currentInteligencia + currentConstituicao;

            if (totalPontosAtuais > pontosHabilidadeTotal) {
                alert("Pontos de habilidade ("+pontosHabilidadeTotal+") insuficientes! Os valores dos atributos ser√£o revertidos para o estado anterior v√°lido.");
                
                forcaInput.value = previousValues.get(forcaInput) || "0";
                destrezaInput.value = previousValues.get(destrezaInput) || "0";
                agilidadeInput.value = previousValues.get(agilidadeInput) || "0";
                inteligenciaInput.value = previousValues.get(inteligenciaInput) || "0";
                constituicaoInput.value = previousValues.get(constituicaoInput) || "0";

                currentForca = parseInt(forcaInput.value) || 0;
                currentDestreza = parseInt(destrezaInput.value) || 0;
                currentAgilidade = parseInt(agilidadeInput.value) || 0;
                currentInteligencia = parseInt(inteligenciaInput.value) || 0;
                currentConstituicao = parseInt(constituicaoInput.value) || 0;
            }
            
            previousValues.set(forcaInput, forcaInput.value);
            previousValues.set(destrezaInput, destrezaInput.value);
            previousValues.set(agilidadeInput, agilidadeInput.value);
            previousValues.set(inteligenciaInput, inteligenciaInput.value);
            previousValues.set(constituicaoInput, constituicaoInput.value);

            pontosHabilidadeUsados = currentForca + currentDestreza + currentAgilidade + currentInteligencia + currentConstituicao;
            pontosHabilidadeSpan.textContent = pontosHabilidadeTotal - pontosHabilidadeUsados;

            let ataque = currentForca + Math.floor(currentDestreza / 5);
            let acerto = Math.floor(currentDestreza / 3) + Math.floor(currentAgilidade / 10);
            let esquiva = Math.floor(currentAgilidade / 3);
            let rdf = Math.floor(currentForca / 5);
            let rdm = Math.floor(currentInteligencia / 5);
            let ataqueMagico = currentInteligencia;
            let magiaBase = 20 + 3 * currentConstituicao;
            let vigorBase = 10 + 0.4 * currentConstituicao;
            vidaBase = 50 + (currentConstituicao * (3 + Math.floor(currentForca / 10))) + 10 * nivel;
            if (currentInteligencia >= 10) magiaBase += currentConstituicao * Math.floor(currentInteligencia / 10);

            ataque += (parseInt(armaDireitaAtaqueInput.value) || 0) + (parseInt(armaEsquerdaAtaqueInput.value) || 0);
            ataqueMagico += (parseInt(armaDireitaAtaqueMagicoInput.value) || 0) + (parseInt(armaEsquerdaAtaqueMagicoInput.value) || 0);

            const capacidadeBase = 5;
            const bonusForcaCarga = Math.floor(currentForca / 5);
            const capacidadeCarga = capacidadeBase + bonusForcaCarga;
            if (capacidadeCargaSpan) capacidadeCargaSpan.textContent = capacidadeCarga;

            const pesoTotalAtual = parseFloat(pesoTotalSpan.textContent) || 0;
            let penalidadeEsquivaAcerto = 0;
            const sobrecarga = pesoTotalAtual - capacidadeCarga;

            if (sobrecarga > 0) {
                penalidadeEsquivaAcerto = -1; 
                const sobrecargaAdicional = sobrecarga - 3;
                if (sobrecargaAdicional > 0) {
                    penalidadeEsquivaAcerto -= Math.ceil(sobrecargaAdicional / 3);
                }
            }
            acerto += penalidadeEsquivaAcerto;
            esquiva += penalidadeEsquivaAcerto;

            if (pesoTotalSpan && capacidadeCargaSpan) {
                const eSobrecarregado = sobrecarga > 0;
                pesoTotalSpan.style.color = eSobrecarregado ? 'red' : ''; 
                capacidadeCargaSpan.style.color = eSobrecarregado ? 'red' : ''; 
            }

            const velocidadeBase = 25 + Math.floor(currentAgilidade / 3) * 3;
            const alturaPuloBase = 1 + Math.floor(currentForca / 10);
            const distanciaPuloBase = 3 + 3 * Math.min(Math.floor(currentForca / 5), Math.floor(currentAgilidade / 5));
            let bonusVelocidade = vantagensSelecionadas.includes("Combo F√≠sico (4)") ? 25 : 0;
            let bonusAlturaPulo = vantagensSelecionadas.includes("Combo F√≠sico (4)") ? 2 : 0;
            let bonusDistanciaPulo = vantagensSelecionadas.includes("Combo F√≠sico (4)") ? 6 : 0;

            velocidadeCorridaSpan.textContent = velocidadeBase + bonusVelocidade;
            alturaPuloSpan.textContent = alturaPuloBase + bonusAlturaPulo;
            distanciaPuloSpan.textContent = distanciaPuloBase + bonusDistanciaPulo;
            ataqueSpan.textContent = ataque;
            ataqueMagicoSpan.textContent = ataqueMagico;
            acertoSpan.textContent = acerto;
            esquivaSpan.textContent = esquiva;
            rdfSpan.textContent = rdf;
            rdmSpan.textContent = rdm;
            
            vidaTotal = Math.ceil(vidaBase);
            magiaTotal = Math.ceil(magiaBase);
            vigorTotal = parseFloat(vigorBase.toFixed(1));

            document.getElementById("vida-total").textContent = vidaTotal;
            document.getElementById("magia-total").textContent = magiaTotal;
            document.getElementById("vigor-total").textContent = vigorTotal.toFixed(1);

            // Ajusta vidaAtual, magiaAtual, vigorAtual se excederem os novos totais
            vidaAtual = Math.min(vidaAtual, vidaTotal);
            magiaAtual = Math.min(magiaAtual, magiaTotal);
            vigorAtual = Math.min(vigorAtual, vigorTotal);

            document.getElementById("vida-atual").textContent = vidaAtual;
            document.getElementById("magia-atual").textContent = magiaAtual;
            document.getElementById("vigor-atual").textContent = vigorAtual.toFixed(1);

            const regeneracaoVida = (0.2 * currentConstituicao).toFixed(1);
            const regeneracaoMagia = (0.8 * currentConstituicao).toFixed(1);
            const regeneracaoVigor = (0.4 * currentConstituicao).toFixed(1);
            document.getElementById("regeneracao-vida").textContent = regeneracaoVida;
            document.getElementById("regeneracao-magia").textContent = regeneracaoMagia;
            document.getElementById("regeneracao-vigor").textContent = regeneracaoVigor;

            const atributosSpans = [{ span: ataqueSpan, valor: ataque }, { span: ataqueMagicoSpan, valor: ataqueMagico }, { span: acertoSpan, valor: acerto }, { span: esquivaSpan, valor: esquiva }, { span: rdfSpan, valor: rdf }, { span: rdmSpan, valor: rdm }];
            atributosSpans.forEach(a => a.span.classList.remove("atributo-fogo"));
            if (atributosSpans.length > 0) {
                const maxAtributo = atributosSpans.reduce((prev, curr) => (prev.valor || 0) > (curr.valor || 0) ? prev : curr);
                if (maxAtributo && maxAtributo.valor > 0) maxAtributo.span.classList.add("atributo-fogo");
            }
            pontosVantagemSpan.textContent = getPontosVantagem(); // Atualiza PH ap√≥s recalcular atributos e n√≠vel
        }
        
        // --- Event Listeners e Inicializa√ß√£o ---
        // Adicionar listeners aos bot√µes e inputs, chamando salvarDadosFichaAtual()
        // (A l√≥gica de adicionar listeners aos inputs j√° est√° presente, s√≥ precisa garantir que chame salvarDadosFichaAtual)

        document.querySelectorAll('input[type="text"], input[type="number"]:not(#experiencia), textarea').forEach(input => {
            input.addEventListener("focus", (event) => {
                previousValues.set(event.target, event.target.value);
            });
            input.addEventListener("input", (event) => {
                const inputTarget = event.target;
                if (isFichaLocked && !isFichaUnlocked && currentFichaId !== FICHA_MATRIZ_ID) { 
                    inputTarget.value = previousValues.get(inputTarget) || "";
                    abrirModalSenha(inputTarget);
                    return; 
                }

                if (atributosInputs.includes(inputTarget)) {
                    calcularAtributos(); 
                } else if (inputTarget.id.includes("arma")) {
                    previousValues.set(inputTarget, inputTarget.value);
                    calcularAtributos(); 
                } else if (inputTarget.classList.contains('inventory-weight')) {
                    previousValues.set(inputTarget, inputTarget.value);
                    calcularPesoTotal(); 
                    calcularAtributos(); 
                } else {
                    previousValues.set(inputTarget, inputTarget.value);
                }
                salvarDadosFichaAtual(); // Salva no Firebase
            });
        });
        if(nomePersonagemInput) nomePersonagemInput.oninput = salvarDadosFichaAtual;
        if(descricaoPersonagemInput) descricaoPersonagemInput.oninput = salvarDadosFichaAtual;
        if(classeNomeInput) classeNomeInput.oninput = salvarDadosFichaAtual;
        if(classeDescricaoInput) classeDescricaoInput.oninput = salvarDadosFichaAtual;
        if(anotacoesTextarea) anotacoesTextarea.oninput = salvarDadosFichaAtual;


        if(experienciaInput) {
            experienciaInput.addEventListener('focus', (event) => {
                previousValues.set(event.target, event.target.value); 
                if (experienciaInput.readOnly && !isXpUnlocked) { 
                    event.preventDefault();
                    senhaGmTitulo.textContent = "Desbloquear Campo de Experi√™ncia";
                    document.getElementById("senha-gm-modal").style.display = "flex";
                    document.getElementById("senha-gm-input").value = "";
                    document.getElementById("senha-gm-input").focus();
                    if(document.getElementById("confirmar-senha-gm-btn")) {
                        document.getElementById("confirmar-senha-gm-btn").onclick = () => confirmarDesbloqueioExperiencia();
                    }
                }
            });

            experienciaInput.addEventListener('input', (event) => {
                if (!experienciaInput.readOnly) { 
                    experiencia = parseInt(event.target.value) || 0;
                    atualizarNivel(); 
                    salvarDadosFichaAtual(); 
                } else {
                    event.target.value = previousValues.get(event.target) || "0"; 
                }
            });
        }
        
        // Demais fun√ß√µes (resetarPontos, recomecarFicha, bloquearFicha, etc.)
        // precisam chamar salvarDadosFichaAtual() no final de suas opera√ß√µes se alterarem dados.
        // Exemplo para recomecarFicha:
        function recomecarFicha() {
            if (isFichaLocked && !isFichaUnlocked && currentFichaId !== FICHA_MATRIZ_ID) return abrirModalSenha(recomecarButton);
            if (confirm("Tem certeza que deseja recome√ßar a ficha? Todas as altera√ß√µes ser√£o salvas no Firebase como uma ficha 'resetada'.")) {
                // Coleta os dados da ficha matriz como base para o reset
                const matrizRef = getFichaRef(FICHA_MATRIZ_ID);
                onValue(matrizRef, (snapshot) => {
                    let fichaResetData;
                    if (snapshot.exists()) {
                        fichaResetData = { ...snapshot.val() }; // Copia dados da matriz
                        // Mant√©m o nome da ficha atual e ID, mas reseta o resto
                        fichaResetData.nomeFicha = globalFichasData[currentFichaId]?.nomeFicha || "Ficha Resetada"; 
                        fichaResetData.nomePersonagem = ""; // Limpa nome do personagem
                        fichaResetData.isLocked = false; // Desbloqueia por padr√£o
                        fichaResetData.password = null;
                    } else { // Fallback se a matriz n√£o existir (improv√°vel ap√≥s criarFichaMatrizIfNeeded)
                        fichaResetData = {
                            nomeFicha: globalFichasData[currentFichaId]?.nomeFicha || "Ficha Resetada",
                            nomePersonagem: "", descricaoPersonagem: "", forca: "0", destreza: "0", agilidade: "0",
                            inteligencia: "0", constituicao: "0", experiencia: "0",
                            // ... outros campos padr√£o ...
                            vidaAtual: 50, magiaAtual: 20, vigorAtual: 10, isLocked: false, password: null,
                            vantagens: "", desvantagens: "", racaSelecionada: null,
                            // ... etc
                        };
                    }
                    
                    // Zera campos espec√≠ficos que n√£o v√™m da matriz
                    fichaResetData.experiencia = "0";
                    fichaResetData.vantagens = "";
                    fichaResetData.desvantagens = "";
                    fichaResetData.racaSelecionada = null;
                    fichaResetData.classeNome = "";
                    fichaResetData.classeDescricao = "";
                    fichaResetData.inventario = Array(10).fill({ item: "", peso: "0" });
                    fichaResetData.magiasHabilidades = Array(10).fill("").join("\n");
                    fichaResetData.anotacoes = "";
                    fichaResetData.imagem = null;


                    set(getFichaRef(currentFichaId), fichaResetData).then(() => {
                        // popularCamposFicha(fichaResetData) ser√° chamado pelo listener onValue
                        showNotification("Ficha recome√ßada e salva!", "save-success");
                    }).catch(err => console.error("Erro ao recome√ßar ficha:", err));

                }, { onlyOnce: true });
            }
        }
        
        if(excluirFichaBtn) {
            excluirFichaBtn.onclick = () => {
                if (!currentFichaId || currentFichaId === FICHA_MATRIZ_ID) {
                    alert("A ficha matriz n√£o pode ser exclu√≠da! Selecione outra ficha.");
                    return;
                }
                if (isFichaLocked && !isFichaUnlocked) return abrirModalSenha(excluirFichaBtn);
                if (confirm(`Tem certeza que deseja excluir a ficha "${globalFichasData[currentFichaId]?.nomeFicha || currentFichaId}"? Esta a√ß√£o n√£o pode ser desfeita.`)) {
                    remove(getFichaRef(currentFichaId))
                        .then(() => {
                            showNotification("Ficha exclu√≠da!", "save-success");
                            // A atualiza√ß√£o das abas e sele√ß√£o de nova ficha ser√° tratada pelo listener em 'fichas'
                            // For√ßar sele√ß√£o da matriz se a ficha atual foi exclu√≠da
                            if (Object.keys(globalFichasData).length > 1) { // Se ainda houver outras fichas al√©m da matriz
                                selecionarFicha(FICHA_MATRIZ_ID);
                            } else {
                                currentFichaId = null; // Nenhuma ficha para selecionar
                                limparCamposFicha();
                            }
                        })
                        .catch(error => {
                            console.error("Erro ao excluir ficha:", error);
                            alert("Erro ao excluir ficha.");
                        });
                }
            };
        }

        // Adicionar listeners aos bot√µes dos modais que foram alterados de onclick para id
        if(addFichaBtn) addFichaBtn.onclick = () => {
            document.getElementById("nome-ficha-modal").style.display = "flex"; 
            const nomeInput = document.getElementById("nome-ficha-input");
            if(nomeInput) {
                nomeInput.value = ""; 
                nomeInput.focus();
            }
        };

        if(confirmarBloquearFichaBtn) confirmarBloquearFichaBtn.onclick = bloquearFicha; // Fun√ß√£o bloquearFicha j√° existe e foi adaptada
        if(confirmarDesbloquearFichaBtn) confirmarDesbloquearFichaBtn.onclick = desbloquearFicha; // Fun√ß√£o desbloquearFicha j√° existe
        if(excluirRacaModalBtn) excluirRacaModalBtn.onclick = excluirRacaSelecionadaModal;
        if(editarRacaModalBtn) editarRacaModalBtn.onclick = editarRacaSelecionadaModal;
        if(salvarEdicaoRacaBtn) salvarEdicaoRacaBtn.onclick = salvarEdicaoRaca;
        if(aplicarPlanoDeFundoBtn) aplicarPlanoDeFundoBtn.onclick = aplicarPlanoDeFundo;
        if(excluirPlanoDeFundoBtn) excluirPlanoDeFundoBtn.onclick = excluirPlanoDeFundo;
        
        // A fun√ß√£o bloquearFicha precisa salvar no Firebase
        function bloquearFicha() {
            const senhaInput = document.getElementById("senha-bloqueio-input");
            if (!senhaInput) return;
            const senha = senhaInput.value;
            if (senha.length !== 4 || !/^\d{4}$/.test(senha)) return alert("A senha deve ter exatamente 4 d√≠gitos num√©ricos!");
            
            isFichaLocked = true; 
            fichaPassword = senha;
            
            const updates = {};
            updates[`fichas/${currentFichaId}/isLocked`] = true;
            updates[`fichas/${currentFichaId}/password`] = senha;
            
            set(ref(database, `fichas/${currentFichaId}/isLocked`), true);
            set(ref(database, `fichas/${currentFichaId}/password`), senha)
            .then(() => {
                fecharModal("bloquear-ficha-modal"); 
                alert("Ficha bloqueada com sucesso!"); 
                atualizarBotaoBloquear();
                // N√£o precisa chamar salvarDadosFichaAtual() explicitamente aqui, 
                // pois o listener onValue vai pegar a mudan√ßa se a UI precisar ser atualizada por isso.
            }).catch(err => console.error("Erro ao bloquear ficha:", err));
        }
        
        // Desbloquear ficha tamb√©m precisa ser adaptado se for permanente
        function desbloquearFicha() {
            const senhaInput = document.getElementById("senha-desbloqueio-input");
            const modal = document.getElementById("password-modal");
            if (!senhaInput || !modal) return;

            const senha = senhaInput.value;
            const elementId = modal.dataset.elementId;
            const originalButton = elementId ? document.getElementById(elementId) : null;

            const fichaAtualDados = globalFichasData[currentFichaId];
            if (!fichaAtualDados) return alert("Ficha atual n√£o carregada.");

            if (senha !== senhaMatriz && senha !== fichaAtualDados.password) return alert("Senha incorreta!");
            
            isFichaUnlocked = true; 

            if (currentFichaId !== FICHA_MATRIZ_ID && senha !== senhaMatriz) {
                if(confirm("Senha correta! Deseja desbloquear a ficha permanentemente? (Cancelar para desbloqueio tempor√°rio)")) {
                     isFichaLocked = false; 
                     fichaPassword = null;
                     
                     set(ref(database, `fichas/${currentFichaId}/isLocked`), false);
                     set(ref(database, `fichas/${currentFichaId}/password`), null)
                     .then(() => {
                        fecharModal("password-modal"); 
                        alert("Ficha desbloqueada permanentemente!"); 
                        atualizarBotaoBloquear();
                        if (originalButton && typeof originalButton.onclick === 'function' && !originalButton.id.startsWith('btn-')) { 
                            originalButton.click();
                        }
                     }).catch(err => console.error("Erro ao desbloquear permanentemente:", err));
                } else {
                     fecharModal("password-modal"); 
                     alert("Ficha desbloqueada temporariamente!");
                     if (originalButton && typeof originalButton.onclick === 'function' && !originalButton.id.startsWith('btn-')) {
                        originalButton.click();
                     }
                }
            } else { // Desbloqueio tempor√°rio (matriz ou com senha matriz)
                fecharModal("password-modal"); 
                alert(`Ficha desbloqueada temporariamente ${senha === senhaMatriz ? 'com a senha matriz!' : ''}`);
                if (originalButton && typeof originalButton.onclick === 'function' && !originalButton.id.startsWith('btn-')) {
                   originalButton.click();
                }
            }
        }


        // Outras fun√ß√µes que modificam dados (resetarPontos, etc.) devem chamar salvarDadosFichaAtual()
        // ou diretamente interagir com o Firebase para salvar as mudan√ßas.
        // Exemplo: resetarPontos
        if(resetPontosButton) resetPontosButton.onclick = () => {
            if (isFichaLocked && !isFichaUnlocked && currentFichaId !== FICHA_MATRIZ_ID) return abrirModalSenha(resetPontosButton);
            senhaGmTitulo.textContent = "Pe√ßa permiss√£o ao GM para Resetar Pontos";
            document.getElementById("senha-gm-modal").style.display = "flex"; 
            const gmSenhaInput = document.getElementById("senha-gm-input");
            if(gmSenhaInput) gmSenhaInput.value = "";
            
            const confirmarGmBtn = document.getElementById("confirmar-senha-gm-btn");
            if(confirmarGmBtn) confirmarGmBtn.onclick = () => {
                if (gmSenhaInput && gmSenhaInput.value === senhaMatriz) {
                    atributosInputs.forEach(input => input.value = 0); 
                    pontosHabilidadeUsados = 0; 
                    // pontosHabilidadeSpan.textContent = pontosHabilidadeTotal; // Ser√° atualizado por calcularAtributos
                    // velocidadeCorridaSpan.textContent = "25"; // Ser√° atualizado por calcularAtributos
                    // alturaPuloSpan.textContent = "1"; 
                    // distanciaPuloSpan.textContent = "3";
                    calcularAtributos(); // Isso recalcula e atualiza os spans
                    // pontosVantagemSpan.textContent = getPontosVantagem(); // Tamb√©m atualizado por calcularAtributos
                    salvarDadosFichaAtual(); 
                    fecharModal("senha-gm-modal");
                } else { 
                    alert("Senha do GM incorreta!"); 
                    fecharModal("senha-gm-modal"); 
                }
            };
        };
        if(recomecarButton) recomecarButton.onclick = recomecarFicha; // recomecarFicha j√° foi adaptada para Firebase

        // L√≥gica de inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', () => {
            if (diceContainer) {
                currentX = diceContainer.offsetLeft;
                currentY = diceContainer.offsetTop;
            }
            
            criarFichaMatrizIfNeeded().then(() => {
                 carregarAbasFichas(); // Isso vai carregar as abas e a primeira ficha ou a matriz
            });

            // Configurar bot√µes de controle de Vida, Magia, Vigor
            const btnDiminuirVida = document.getElementById('btn-diminuir-vida');
            const btnAumentarVida = document.getElementById('btn-aumentar-vida');
            const btnDiminuirMagia = document.getElementById('btn-diminuir-magia');
            const btnAumentarMagia = document.getElementById('btn-aumentar-magia');
            const btnDiminuirVigor = document.getElementById('btn-diminuir-vigor');
            const btnAumentarVigor = document.getElementById('btn-aumentar-vigor');

            if(btnDiminuirVida) btnDiminuirVida.onclick = null; // Remove old onclick if any
            if(btnAumentarVida) btnAumentarVida.onclick = null;
            if(btnDiminuirMagia) btnDiminuirMagia.onclick = null;
            if(btnAumentarMagia) btnAumentarMagia.onclick = null;
            if(btnDiminuirVigor) btnDiminuirVigor.onclick = null;
            if(btnAumentarVigor) btnAumentarVigor.onclick = null;

            setupHoldButtonEvents(btnDiminuirVida, diminuirVida);
            setupHoldButtonEvents(btnAumentarVida, aumentarVida);
            setupHoldButtonEvents(btnDiminuirMagia, diminuirMagia);
            setupHoldButtonEvents(btnAumentarMagia, aumentarMagia);
            setupHoldButtonEvents(btnDiminuirVigor, diminuirVigor);
            setupHoldButtonEvents(btnAumentarVigor, aumentarVigor);

            // Demais listeners que j√° estavam no seu DOMContentLoaded
             if(vantagensDesvantagensBtn) vantagensDesvantagensBtn.onclick = () => {
                if (isFichaLocked && !isFichaUnlocked && currentFichaId !== FICHA_MATRIZ_ID) return abrirModalSenha(vantagensDesvantagensBtn);
                tempVantagensSelecionadas = [...vantagensSelecionadas]; 
                tempDesvantagensSelecionadas = [...desvantagensSelecionadas];
                vantagensDesvantagensPanel.style.display = "block"; 
                if(salvarVantagensBtn) salvarVantagensBtn.style.display = "none"; 
                atualizarVantagensDesvantagensPanel();
            };
            if(fecharPaginaBtn) fecharPaginaBtn.onclick = () => { if(vantagensDesvantagensPanel) vantagensDesvantagensPanel.style.display = "none"; };
            
            if(salvarVantagensBtn) salvarVantagensBtn.onclick = () => {
                document.getElementById("salvar-modal-texto").textContent = "Se salvar, as altera√ß√µes de Vantagens/Desvantagens n√£o poder√£o ser desfeitas.";
                document.getElementById("salvar-vantagens-modal").style.display = "flex";
            };
            if(salvarRacasBtn) salvarRacasBtn.onclick = () => {
                document.getElementById("salvar-modal-texto").textContent = "Se salvar, a altera√ß√£o de Ra√ßa n√£o poder√° ser desfeita.";
                document.getElementById("salvar-vantagens-modal").style.display = "flex";
            };
            if(confirmarSalvarBtn) confirmarSalvarBtn.onclick = () => { // Esta fun√ß√£o j√° foi adaptada
                if (racasPanel.style.display === "block") {
                    if (tempRacaSelecionada && tempRacaSelecionada !== racaSelecionada) {
                        const raca = racasData.find(r => r.nome === tempRacaSelecionada);
                        if (raca && calcularPontosVantagemTemp() >= 0) {
                            racaSelecionada = tempRacaSelecionada;
                            racaNomeSpan.textContent = racaSelecionada.split(" (")[0];
                            const racaDataAtual = racasData.find(r => r.nome === racaSelecionada);
                            racaDescricaoInput.value = racaDataAtual ? (racaDataAtual.vantagens || []).join("\n\n") : "";
                            // pontosVantagemSpan.textContent = getPontosVantagem(); // Ser√° atualizado por calcularAtributos
                            racasPanel.style.display = "none";
                            calcularAtributos(); // Chama para atualizar PH e outros stats
                            salvarDadosFichaAtual();
                        } else if (raca){
                            alert("Pontos de Vantagem insuficientes para confirmar esta ra√ßa!");
                        }
                    } else {
                        racasPanel.style.display = "none";
                    }
                } else if (vantagensDesvantagensPanel.style.display === "block") { 
                    if (tempDesvantagensSelecionadas.length > 3) {
                         alert("Voc√™ pode ter no m√°ximo 3 desvantagens!");
                         fecharModal("salvar-vantagens-modal");
                         return;
                    }
                    if (calcularPontosVantagemTemp() < 0) {
                         alert("Pontos de Vantagem insuficientes com as vantagens selecionadas!");
                         fecharModal("salvar-vantagens-modal");
                         return;
                    }

                    vantagensSelecionadas = [...tempVantagensSelecionadas];
                    desvantagensSelecionadas = [...tempDesvantagensSelecionadas];
                    vantagensListDisplay.innerHTML = ""; desvantagensListDisplay.innerHTML = "";
                    vantagensSelecionadas.forEach(v => { const div = document.createElement("div"); div.textContent = v; div.className = "list-item"; div.onclick = () => removerVantagem(v); vantagensListDisplay.appendChild(div); });
                    desvantagensSelecionadas.forEach(d => { const div = document.createElement("div"); div.textContent = d; div.className = "list-item"; div.onclick = () => removerDesvantagem(d); desvantagensListDisplay.appendChild(div); });
                    // pontosVantagemSpan.textContent = getPontosVantagem(); // Ser√° atualizado por calcularAtributos
                    vantagensDesvantagensPanel.style.display = "none";
                    calcularAtributos(); 
                    salvarDadosFichaAtual();
                }
                fecharModal("salvar-vantagens-modal");
            };

            if(characterImageInput) characterImageInput.onchange = e => {
                const file = e.target.files[0]; 
                if (file) { 
                    const reader = new FileReader(); 
                    reader.onload = e => { 
                        characterImage.src = e.target.result; 
                        characterImage.style.display = "block"; 
                        salvarDadosFichaAtual(); 
                    }; 
                    reader.readAsDataURL(file); 
                }
            };

            if(diceRoll) diceRoll.onclick = () => {
                if (isFichaLocked && !isFichaUnlocked && currentFichaId !== FICHA_MATRIZ_ID) return abrirModalSenha(diceRoll);
                diceRoll.textContent = "Rolling..."; 
                if(diceResult) diceResult.style.display = "none"; 
                diceRoll.classList.remove("critical-failure", "critical-success");
                setTimeout(() => {
                    const roll = Math.floor(Math.random() * 20) + 1;
                    const fichaNome = (globalFichasData[currentFichaId] ? globalFichasData[currentFichaId].nomeFicha : "Ficha") || "Ficha";
                    diceRoll.textContent = roll;
                    let notificationClass = "normal-result";
                    let notificationMsg = `${fichaNome} rolou: ${roll}`;
                    if (roll === 1) { diceRoll.classList.add("critical-failure"); notificationClass = "critical-failure"; notificationMsg = `${fichaNome} - FALHA CR√çTICA!`; }
                    else if (roll === 20) { diceRoll.classList.add("critical-success"); notificationClass = "critical-success"; notificationMsg = `${fichaNome} - SUCESSO CR√çTICO!`; }
                    else { if(diceResult) {diceResult.textContent = `Resultado: ${roll}`; diceResult.style.display = "block";} } 
                    showNotification(notificationMsg, notificationClass);
                }, 1000);
            };
            
            if(anotacoesBtn) anotacoesBtn.onclick = () => { if(anotacoesTextarea) anotacoesTextarea.style.display = anotacoesTextarea.style.display === "block" ? "none" : "block"; };
            document.addEventListener('click', (event) => { 
                if (anotacoesTextarea && anotacoesTextarea.style.display === "block" && !anotacoesTextarea.contains(event.target) && anotacoesBtn && !anotacoesBtn.contains(event.target)) {
                    anotacoesTextarea.style.display = 'none'; 
                }
            });
            
            if(adicionarMagiaBtn) adicionarMagiaBtn.onclick = () => {
                if (isFichaLocked && !isFichaUnlocked && currentFichaId !== FICHA_MATRIZ_ID) return abrirModalSenha(adicionarMagiaBtn);
                if (magiasList.children.length < 20) { 
                    const input = document.createElement("input"); 
                    input.type = "text"; 
                    input.className = "magia-nome"; 
                    input.placeholder = `Magia/Habilidade ${magiasList.children.length + 1}`; 
                    input.addEventListener('input', salvarDadosFichaAtual); 
                    magiasList.appendChild(input); 
                    salvarDadosFichaAtual(); 
                } else {
                    alert("Limite de 20 magias/habilidades!");
                }
            };

            if(racasBtn) racasBtn.onclick = () => { 
                if (isFichaLocked && !isFichaUnlocked && currentFichaId !== FICHA_MATRIZ_ID) return abrirModalSenha(racasBtn); 
                tempRacaSelecionada = racaSelecionada; 
                atualizarRacasPanel(); 
                if(racasPanel) racasPanel.style.display = "block"; 
                if(salvarRacasBtn) salvarRacasBtn.style.display = "none"; 
            };
            if(fecharRacasBtn) fecharRacasBtn.onclick = () => { if(racasPanel) racasPanel.style.display = "none"; };
            
            if(classesBtn) classesBtn.onclick = () => { if(classesPanel) classesPanel.style.display = "block"; };
            if(fecharClassesBtn) fecharClassesBtn.onclick = () => { if(classesPanel) classesPanel.style.display = "none"; };

            if(luaBtn) luaBtn.onclick = () => { document.body.classList.add("dark-mode"); salvarDadosFichaAtual(); };
            if(solBtn) solBtn.onclick = () => { document.body.classList.remove("dark-mode"); salvarDadosFichaAtual(); };
            
            if(planoFundoBtn) planoFundoBtn.onclick = () => { if(backgroundModal) backgroundModal.style.display = "flex"; };
            
            if (backgroundColorButtonVisual && backgroundColorInput) {
                backgroundColorButtonVisual.addEventListener('click', () => backgroundColorInput.click());
                backgroundColorInput.addEventListener('input', (event) => {
                    document.body.style.backgroundColor = event.target.value;
                    backgroundColorButtonVisual.style.backgroundColor = event.target.value; 
                    salvarDadosFichaAtual();
                });
            }
            if (fontSelector) {
                fontSelector.addEventListener('change', (event) => {
                    const selectedFont = event.target.value;
                    document.body.style.fontFamily = selectedFont;
                    if (fichaContainer) fichaContainer.style.fontFamily = selectedFont;
                    salvarDadosFichaAtual(); 
                });
            }
        });
        // Fun√ß√µes restantes (atualizarVantagensDesvantagensPanel, removerVantagem, etc.)
        // j√° est√£o definidas e devem funcionar com as vari√°veis globais adaptadas.
        // Certifique-se que elas chamem salvarDadosFichaAtual() quando necess√°rio.
        // A maioria j√° faz isso implicitamente ao modificar vantagensSelecionadas, etc., e ent√£o
        // o salvarDadosFichaAtual √© chamado ap√≥s fechar o painel ou confirmar.
        // ... (Restante das suas fun√ß√µes como showNotification, aplicarPlanoDeFundo, etc. podem permanecer como est√£o,
        // apenas garantindo que chamem salvarDadosFichaAtual() se modificarem dados persistentes da ficha)

        // Fun√ß√µes que precisam ser adaptadas ou verificadas para chamar salvarDadosFichaAtual()
        // ou interagir diretamente com Firebase para salvar:
        // - removerVantagem, removerDesvantagem (j√° chamam salvarDadosFichaAtual indiretamente ou precisam)
        // - excluirRacaSelecionadaModal, salvarEdicaoRaca (j√° chamam salvarDadosFichaAtual indiretamente ou precisam)
        // - aplicarPlanoDeFundo, excluirPlanoDeFundo (j√° chamam salvarDadosFichaAtual)
        // - aplicarCorDeFundoInicial, aplicarFonteInicial (s√£o para carregar, n√£o salvar)

        // Adapta√ß√µes finais para as fun√ß√µes que modificam e precisam salvar:
        function removerVantagem(v) {
            if (isFichaLocked && !isFichaUnlocked && currentFichaId !== FICHA_MATRIZ_ID) return abrirModalSenha();
            senhaGmTitulo.textContent = "Pe√ßa permiss√£o ao GM para Remover Vantagem";
            if (confirm(`Deseja remover a vantagem "${v}"?`)) {
                document.getElementById("senha-gm-modal").style.display = "flex"; 
                const gmSenhaInput = document.getElementById("senha-gm-input");
                if(gmSenhaInput) gmSenhaInput.value = "";
                const confirmarGmBtn = document.getElementById("confirmar-senha-gm-btn");
                if(confirmarGmBtn) confirmarGmBtn.onclick = () => {
                    if (gmSenhaInput && gmSenhaInput.value === senhaMatriz) {
                        vantagensSelecionadas = vantagensSelecionadas.filter(t => t !== v); 
                        const itemDisplay = Array.from(vantagensListDisplay.children).find(div => div.textContent === v);
                        if(itemDisplay) itemDisplay.remove();
                        // pontosVantagemSpan.textContent = getPontosVantagem(); // Atualizado por calcularAtributos
                        fecharModal("senha-gm-modal"); 
                        calcularAtributos(); 
                        salvarDadosFichaAtual();
                    } else { alert("Senha do GM incorreta!"); fecharModal("senha-gm-modal"); }
                };
            }
        }
        function removerDesvantagem(d) {
            if (isFichaLocked && !isFichaUnlocked && currentFichaId !== FICHA_MATRIZ_ID) return abrirModalSenha();
            senhaGmTitulo.textContent = "Pe√ßa permiss√£o ao GM para Remover Desvantagem";
            if (confirm(`Deseja remover a desvantagem "${d}"?`)) {
                document.getElementById("senha-gm-modal").style.display = "flex"; 
                const gmSenhaInput = document.getElementById("senha-gm-input");
                if(gmSenhaInput) gmSenhaInput.value = "";
                const confirmarGmBtn = document.getElementById("confirmar-senha-gm-btn");
                if(confirmarGmBtn) confirmarGmBtn.onclick = () => {
                    if (gmSenhaInput && gmSenhaInput.value === senhaMatriz) {
                        desvantagensSelecionadas = desvantagensSelecionadas.filter(t => t !== d); 
                        const itemDisplay = Array.from(desvantagensListDisplay.children).find(div => div.textContent === d);
                        if(itemDisplay) itemDisplay.remove();
                        // pontosVantagemSpan.textContent = getPontosVantagem(); // Atualizado por calcularAtributos
                        fecharModal("senha-gm-modal"); 
                        calcularAtributos(); 
                        salvarDadosFichaAtual();
                    } else { alert("Senha do GM incorreta!"); fecharModal("senha-gm-modal"); }
                };
            }
        }
         function excluirRacaSelecionadaModal() {
            fecharModal('raca-opcoes-modal'); 
            if (isFichaLocked && !isFichaUnlocked && currentFichaId !== FICHA_MATRIZ_ID) return abrirModalSenha();
            senhaGmTitulo.textContent = "Pe√ßa permiss√£o ao GM para Excluir Ra√ßa";
            if (confirm("Tem certeza que deseja excluir a ra√ßa selecionada?")) {
                document.getElementById("senha-gm-modal").style.display = "flex"; 
                const gmSenhaInput = document.getElementById("senha-gm-input");
                if(gmSenhaInput) gmSenhaInput.value = "";
                const confirmarGmBtn = document.getElementById("confirmar-senha-gm-btn");
                if(confirmarGmBtn) confirmarGmBtn.onclick = () => {
                    if (gmSenhaInput && gmSenhaInput.value === senhaMatriz) {
                        racaSelecionada = null; 
                        tempRacaSelecionada = null; 
                        racaNomeSpan.textContent = "Clique para selecionar/editar Ra√ßa"; 
                        racaDescricaoInput.value = "";
                        // pontosVantagemSpan.textContent = getPontosVantagem(); // Atualizado por calcularAtributos
                        fecharModal("senha-gm-modal"); 
                        calcularAtributos();
                        salvarDadosFichaAtual(); 
                    } else { alert("Senha do GM incorreta!"); fecharModal("senha-gm-modal"); }
                };
            }
        }
        function editarRacaSelecionadaModal() {
            if (isFichaLocked && !isFichaUnlocked && currentFichaId !== FICHA_MATRIZ_ID) return abrirModalSenha(); 
            fecharModal('raca-opcoes-modal');
            document.getElementById("editar-raca-modal").style.display = "flex"; 
            const editNome = document.getElementById("editar-raca-nome");
            const editDesc = document.getElementById("editar-raca-descricao");
            if(editNome) editNome.value = racaNomeSpan.textContent === "Clique para selecionar/editar Ra√ßa" ? "" : racaNomeSpan.textContent;
            if(editDesc) editDesc.value = racaDescricaoInput.value;
        }
        function salvarEdicaoRaca() {
            if (isFichaLocked && !isFichaUnlocked && currentFichaId !== FICHA_MATRIZ_ID) return abrirModalSenha();
            senhaGmTitulo.textContent = "Pe√ßa permiss√£o ao GM para Editar Ra√ßa";
            if (confirm("Tem certeza que deseja editar a ra√ßa selecionada? (Isso n√£o altera o custo em PH, apenas texto)")) {
                document.getElementById("senha-gm-modal").style.display = "flex"; 
                const gmSenhaInput = document.getElementById("senha-gm-input");
                if(gmSenhaInput) gmSenhaInput.value = "";
                const confirmarGmBtn = document.getElementById("confirmar-senha-gm-btn");

                if(confirmarGmBtn) confirmarGmBtn.onclick = () => {
                    if (gmSenhaInput && gmSenhaInput.value === senhaMatriz) {
                        const editNome = document.getElementById("editar-raca-nome");
                        const editDesc = document.getElementById("editar-raca-descricao");
                        if(editNome) racaNomeSpan.textContent = editNome.value || "Ra√ßa Editada"; // Atualiza o span principal
                        if(editDesc) racaDescricaoInput.value = editDesc.value; // Atualiza a descri√ß√£o principal
                        
                        // Se racaSelecionada tem um nome formal (ex: "Humano (3)"), atualizamos apenas a parte textual
                        // Esta l√≥gica pode precisar de ajuste se a edi√ß√£o for para criar uma ra√ßa customizada n√£o listada
                        // Por ora, assume-se que est√° editando a descri√ß√£o de uma ra√ßa j√° selecionada ou customizando.
                        // Se racaSelecionada for null, esta edi√ß√£o define uma ra√ßa customizada.
                        if (!racaSelecionada && editNome.value) { // Criando uma "ra√ßa customizada"
                            racaSelecionada = editNome.value + " (Custom)"; // Marcar como custom para n√£o buscar em racasData
                        } else if (racaSelecionada && editNome.value) {
                            // Se est√° editando uma ra√ßa existente, o nome da ra√ßa (com custo) n√£o deve mudar aqui,
                            // apenas a descri√ß√£o. O nome da ra√ßa √© o que linka com racasData.
                            // O span racaNomeSpan pode mostrar o nome customizado, mas racaSelecionada deve manter o original
                            // para c√°lculo de PH, a menos que seja uma ra√ßa totalmente customizada sem custo de PH.
                            // Esta parte √© complexa. Por simplicidade, a edi√ß√£o aqui √© mais cosm√©tica para a descri√ß√£o.
                        }

                        fecharModal('editar-raca-modal'); 
                        salvarDadosFichaAtual(); 
                        fecharModal("senha-gm-modal");
                    } else { alert("Senha do GM incorreta!"); fecharModal("senha-gm-modal"); }
                };
            }
        }
        // Fun√ß√µes de UI (atualizarBotaoBloquear, showNotification, etc.) permanecem as mesmas.
        // A fun√ß√£o calcularPesoTotal j√° chama calcularAtributos e salvarDadosFichaAtual.
        // As fun√ß√µes de abrir e fechar modais permanecem as mesmas.
        // A l√≥gica dos pain√©is de vantagens e ra√ßas (atualizarVantagensDesvantagensPanel, atualizarRacasPanel)
        // deve funcionar, pois manipulam tempVantagensSelecionadas e tempRacaSelecionada, e
        // a confirma√ß√£o (confirmarSalvarBtn) j√° chama salvarDadosFichaAtual.

        // Fun√ß√µes restantes do seu script original (j√° presentes no HTML)
        // ... (showNotification, aplicarPlanoDeFundo, excluirPlanoDeFundo, aplicarCorDeFundoInicial, aplicarFonteInicial, setupHoldButtonEvents)
        // Elas j√° est√£o no escopo global do m√≥dulo e devem funcionar se n√£o dependerem de vari√°veis que foram removidas (como `fichas` global do localStorage).
        // A maioria delas j√° chama `salvarDados` que agora √© `salvarDadosFichaAtual`.

        // Garantir que as fun√ß√µes globais chamadas por `onclick` nos modais ainda funcionem ou sejam substitu√≠das por event listeners.
        // Muitas j√° foram substitu√≠das por event listeners em `DOMContentLoaded`.
        // As que ainda s√£o `onclick`:
        // fecharModal -> OK
        // cancelarDesbloqueio -> OK
        // abrirModalRaca -> OK
        // O restante foi convertido para IDs e event listeners.

        // √öltima revis√£o das fun√ß√µes que precisam chamar salvarDadosFichaAtual:
        // - Todas as fun√ß√µes que alteram os dados que devem ser persistidos.
        // - Fun√ß√µes de aumento/diminui√ß√£o de vida/magia/vigor: OK
        // - Edi√ß√£o de inputs: OK
        // - Sele√ß√£o/remo√ß√£o de vantagens/desvantagens/ra√ßas (via confirmarSalvarBtn): OK
        // - Mudan√ßas de tema (dark mode, cor, fonte, imagem de fundo): OK
        // - Recome√ßar, Resetar Pontos: OK
        // - Bloquear/Desbloquear: OK (salvam o estado de bloqueio)
        // - Adicionar Magia: OK
        // - Edi√ß√£o de anota√ß√µes: OK
        // - Upload de imagem: OK

        // Fun√ß√µes que j√° est√£o no seu c√≥digo e n√£o precisam de grandes mudan√ßas al√©m de garantir que
        // chamem salvarDadosFichaAtual() se necess√°rio:
        // (Muitas j√° foram cobertas acima ao adicionar listeners)
        // showNotification, aplicarPlanoDeFundo, excluirPlanoDeFundo, aplicarCorDeFundoInicial, aplicarFonteInicial, setupHoldButtonEvents,
        // atualizarVantagensDesvantagensPanel, atualizarRacasPanel, etc.

        // √â importante que a vari√°vel `nivel` e `experiencia` sejam corretamente gerenciadas
        // e que `atualizarNivel()` e `calcularAtributos()` sejam chamados quando elas mudam,
        // e que `salvarDadosFichaAtual()` seja chamado depois. Isso parece estar coberto.

    </script>
</body>
</html>
