<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ficha de Personagem RPG</title>
    <link href="https://fonts.googleapis.com/css2?family=MedievalSharp&family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@tailwindcss/browser@4"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f5f5f5;
            color: #000000;
            display: flex;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            background-image: url('medieval_background.jpg');
            background-size: cover;
            background-position: center;
        }
        #fichas-sidebar {
            width: 100%;
            height: 60px;
            background-color: #ffffff;
            padding: 10px 0;
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: flex-start;
            position: fixed;
            top: 0;
            left: 0;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            overflow-x: auto;
        }
        .ficha-tab {
            width: 100px;
            height: 50px;
            background-color: #f0e6d2;
            border: 2px solid #b8860b;
            border-radius: 10px 10px 0 0;
            margin-right: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.2);
        }
        .ficha-tab:hover {
            background-color: #a0522d;
            transform: translateY(-5px);
        }
        .ficha-tab.active {
            background-color: #a0522d;
            transform: translateY(-5px);
        }
        .ficha-tab span {
            font-family: 'MedievalSharp', serif;
            color: #000000;
            font-size: 0.9rem;
            text-align: center;
            max-width: 90px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        #add-ficha-btn {
            width: 100px;
            height: 50px;
            background-color: #f0e6d2;
            border: 2px solid #b8860b;
            border-radius: 10px 10px 0 0;
            margin-right: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: transform 0.2s ease;
            box-shadow: 0 0 10px #ffd700, 0 0 20px #ffd700;
            z-index: 1001;
        }
        #add-ficha-btn span {
            font-family: 'MedievalSharp', serif;
            color: #000000;
            font-size: 0.9rem;
        }
        #add-ficha-btn:hover {
            background-color: #a0522d;
            transform: translateY(-5px);
        }
        #ficha-container {
            background-color: rgba(240, 230, 210, 0.95);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
            width: 95%;
            max-width: 1200px;
            margin: 80px auto 20px auto;
            border: 2px solid #b8860b;
            position: relative;
        }
        #ficha-container.aura-azul {
            box-shadow: 0 0 30px 15px #00BFFF;
            animation: pulsar-aura 2s infinite;
        }
        @keyframes pulsar-aura {
            0% { box-shadow: 0 0 20px #00BFFF, 0 0 30px #00BFFF, 0 0 40px #00BFFF; }
            50% { box-shadow: 0 0 30px #00BFFF, 0 0 50px #00BFFF, 0 0 60px #00BFFF; }
            100% { box-shadow: 0 0 20px #00BFFF, 0 0 30px #00BFFF, 0 0 40px #00BFFF; }
        }
        h1#nome-personagem-titulo {
            font-family: 'MedievalSharp', serif;
            color: #1C2526;
            font-size: 3rem;
            margin-bottom: 20px;
            text-align: center;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
            animation: raios 2s infinite linear;
        }
        @keyframes raios {
            0% { text-shadow: 0 0 5px #FFD700, 0 0 10px #FFD700, 0 0 15px #FFD700, 0 0 20px #FF4500; }
            50% { text-shadow: 0 0 10px #FFD700, 0 0 15px #FFD700, 0 0 20px #FF4500, 0 0 25px #FF4500; }
            100% { text-shadow: 0 0 5px #FFD700, 0 0 10px #FFD700, 0 0 15px #FFD700, 0 0 20px #FF4500; }
        }
        #game-master-message {
            display: none;
            color: blue;
            font-size: 1.5rem;
            text-align: center;
            font-family: 'MedievalSharp', serif;
            margin-bottom: 10px;
        }
        section {
            background-color: #f0e6d2;
            border: 2px solid #b8860b;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        section h2 {
            font-family: 'MedievalSharp', serif;
            color: #a0522d;
            font-size: 1.5rem;
            margin-bottom: 10px;
            text-align: center;
        }
        label {
            font-weight: 600;
            color: #000000;
            margin-bottom: 8px;
            display: block;
        }
        input[type="text"], input[type="number"], textarea {
            padding: 10px;
            border: 2px solid #b8860b;
            border-radius: 6px;
            width: calc(100% - 24px);
            margin-bottom: 15px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
            background-color: #fff;
            color: #000000;
        }
        input[type="text"]:focus, input[type="number"]:focus, textarea:focus {
            border-color: #a0522d;
            outline: none;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        input[readonly], span[readonly] {
            background-color: #e8e8e8;
            border: 1px solid #ccc;
            cursor: not-allowed;
        }
        textarea {
            resize: vertical;
            height: 100px;
        }
        .atributos-container {
            display: flex;
            justify-content: space-between;
            gap: 20px;
        }
        .atributos-coluna, .atributos-coluna-destaque {
            width: 48%;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        .atributos-coluna-destaque {
            background-color: #ffffff;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #b8860b;
        }
        .atributo-destaque {
            padding: 8px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
        }
        .atributo-destaque label {
            font-size: 1.1rem;
            font-weight: 700;
            color: #a0522d;
        }
        .atributo-destaque span {
            font-size: 1.2rem;
            font-family: 'MedievalSharp', serif;
            color: #000000;
        }
        .atributo-fogo {
            animation: fogo 1.5s infinite;
        }
        @keyframes fogo {
            0% { text-shadow: 0 0 5px #ff4500, 0 0 10px #ff4500; }
            50% { text-shadow: 0 0 10px #ff4500, 0 0 15px #ffd700; }
            100% { text-shadow: 0 0 5px #ff4500, 0 0 10px #ff4500; }
        }
        .vida-magia-vigor {
            display: flex;
            justify-content: space-around;
            gap: 15px;
            flex-wrap: wrap;
        }
        .atributo-container {
            background-color: rgba(255, 255, 255, 0.8);
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #b8860b;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            width: 30%;
            min-width: 200px;
            text-align: center;
        }
        .atributo-container::before {
            font-size: 1.5rem;
            margin-bottom: 5px;
            display: block;
        }
        .atributo-container.vida::before { content: "❤️"; }
        .atributo-container.magia::before { content: "✨"; }
        .atributo-container.vigor::before { content: "⚡"; }
        .medieval-box {
            background-color: #f0e6d2;
            border: 2px solid #b8860b;
            border-radius: 8px;
            padding: 10px;
            margin: 5px 0;
            text-align: center;
        }
        .regeneracao {
            font-size: 0.8rem;
            color: #555;
            margin-top: 5px;
        }
        button {
            background-color: #b8860b;
            color: white;
            border: none;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 1.2rem;
            border-radius: 4px;
            margin: 0 5px;
            transition: background-color 0.3s ease;
        }
        button:hover {
            background-color: #a0522d;
        }
        .botoes-container {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }
        .botao {
            padding: 12px 25px;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            font-family: 'MedievalSharp', serif;
            color: white;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
        }
        .botao-reset { background-color: #b8860b; }
        .botao-reset:hover { background-color: #a0522d; transform: translateY(-2px); }
        .botao-recomecar { background-color: #a52a2a; }
        .botao-recomecar:hover { background-color: #8b0000; transform: translateY(-2px); }
        .botao-bloquear, .botao-desbloquear { background-color: #4a4a4a; }
        .botao-bloquear:hover, .botao-desbloquear:hover { background-color: #2a2a2a; transform: translateY(-2px); }
        .botao-excluir { background-color: #a52a2a; position: absolute; bottom: 20px; left: 20px; }
        .botao-excluir:hover { background-color: #8b0000; transform: translateY(-2px); }
        .status-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 20px;
        }
        #nivel-container {
            font-family: 'MedievalSharp', serif;
            font-size: 2rem;
            color: #000000;
            text-align: center;
        }
        #nivel {
            padding: 10px;
            background-color: #f0e6d2;
            border: 3px solid #000000;
            border-radius: 50%;
            width: 100px;
            height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3.125rem;
            box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.5);
            margin: 0 auto;
        }
        #nivel.aura-azul {
            animation: pulsar-aura 2s 10;
        }
        .expandable-textarea {
            height: 100px;
            width: 100%;
            background-color: #fff;
            border: 2px solid #b8860b;
            border-radius: 6px;
            padding: 10px;
            font-size: 0.9rem;
            transition: height 0.3s ease;
        }
        .expandable-textarea:focus {
            height: 300px;
        }
        #dice-container {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 200px;
            text-align: center;
            font-family: 'MedievalSharp', serif;
            cursor: move;
            z-index: 10;
            user-select: none;
        }
        #dice-container label {
            font-size: 1.2rem;
            color: #000000;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 10px;
        }
        #dice-container label::before {
            content: "🎲";
            margin-right: 5px;
            font-size: 1.5rem;
        }
        #dice-roll {
            width: 100px;
            height: 100px;
            background-color: #f0e6d2;
            border: 2px solid #b8860b;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            cursor: pointer;
            margin: 0 auto;
            position: relative;
            transition: all 0.3s ease;
        }
        #dice-roll::before {
            content: "⚅";
            font-size: 1.5rem;
            position: absolute;
            top: 5px;
            right: 5px;
            color: #a0522d;
        }
        #dice-result {
            margin-top: 10px;
            font-size: 1rem;
            color: #000000;
            display: none;
            animation: blink 1s infinite;
        }
        @keyframes blink {
            50% { opacity: 0; }
        }
        #dice-roll.critical-failure {
            animation: aura-vermelha 2s infinite;
        }
        #dice-roll.critical-success {
            animation: aura-verde 2s infinite;
        }
        @keyframes aura-vermelha {
            0% { box-shadow: 0 0 5px #ff0000, 0 0 10px #ff0000; }
            50% { box-shadow: 0 0 15px #ff0000, 0 0 20px #ff0000; }
            100% { box-shadow: 0 0 5px #ff0000, 0 0 10px #ff0000; }
        }
        @keyframes aura-verde {
            0% { box-shadow: 0 0 5px #00ff00, 0 0 10px #00ff00; }
            50% { box-shadow: 0 0 15px #00ff00, 0 0 20px #00ff00; }
            100% { box-shadow: 0 0 5px #00ff00, 0 0 10px #00ff00; }
        }
        #notification {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 20px;
            border-radius: 8px;
            font-family: 'MedievalSharp', serif;
            font-size: 1.5rem;
            color: #ffffff;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
            display: none;
            z-index: 100;
            background-color: rgba(0, 0, 0, 0.7);
            transition: opacity 0.3s ease;
        }
        #notification.critical-failure {
            background-color: rgba(255, 0, 0, 0.8);
            animation: aura-vermelha 2s infinite;
        }
        #notification.critical-success {
            background-color: rgba(0, 255, 0, 0.8);
            animation: aura-verde 2s infinite;
        }
        #notification.normal-result, #notification.save-success {
            animation: blink 1s infinite;
        }
        #notification.save-success {
            background-color: rgba(0, 200, 0, 0.8);
        }
        #character-image-container {
            position: absolute;
            top: 10px;
            left: 10px;
            width: 100px;
            height: 100px;
            background-color: #f0e6d2;
            border: 2px solid #b8860b;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            overflow: hidden;
            z-index: 10;
        }
        #character-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: none;
        }
        #character-image-container:hover {
            box-shadow: 0 0 10px #ffd700;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: #f0e6d2;
            padding: 20px;
            border-radius: 8px;
            border: 2px solid #b8860b;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            width: 300px;
            text-align: center;
        }
        .modal-content h3 {
            font-family: 'MedievalSharp', serif;
            color: #000000;
            margin-bottom: 15px;
        }
        .modal-content input {
            width: calc(100% - 20px);
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #ccc;
            border-radius: 6px;
        }
        .modal-content button {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-family: 'MedievalSharp', serif;
            color: white;
            cursor: pointer;
            margin: 0 5px;
        }
        .modal-content .confirm-btn {
            background-color: #b8860b;
        }
        .modal-content .confirm-btn:hover {
            background-color: #a0522d;
        }
        .modal-content .cancel-btn {
            background-color: #a52a2a;
        }
        .modal-content .cancel-btn:hover {
            background-color: #8b0000;
        }
        #vantagens-desvantagens-btn {
            position: absolute;
            bottom: -50px;
            left: 50%;
            transform: translateX(-50%);
            padding: 10px 20px;
            background-color: #f0e6d2;
            border: 2px solid #b8860b;
            border-radius: 6px;
            font-family: 'MedievalSharp', serif;
            font-size: 1rem;
            color: #000000;
            cursor: pointer;
            transition: background-color 0.3s ease;
            z-index: 10;
        }
        #anotacoes-btn {
            position: absolute;
            left: -110px;
            top: 50%;
            transform: translateY(-50%);
            padding: 10px 20px;
            background-color: #f0e6d2;
            border: 2px solid #b8860b;
            border-radius: 6px;
            font-family: 'MedievalSharp', serif;
            font-size: 1rem;
            color: #000000;
            cursor: pointer;
            transition: background-color 0.3s ease;
            z-index: 10;
        }
        #anotacoes-btn:hover, #vantagens-desvantagens-btn:hover {
            background-color: #a0522d;
            color: #ffffff;
        }
        #anotacoes-panel {
            display: none;
            position: absolute;
            left: -110px;
            top: 50%;
            transform: translateY(-50%);
            width: 100px;
            height: 100px;
            background-color: #f0e6d2;
            border: 2px solid #b8860b;
            border-radius: 6px;
            padding: 10px;
            z-index: 11;
            transition: width 0.3s ease;
        }
        #anotacoes-panel.active {
            width: 100px;
        }
        #anotacoes-textarea {
            width: 100%;
            height: 100%;
            border: none;
            background: transparent;
            resize: none;
            font-family: 'Inter', sans-serif;
            font-size: 0.9rem;
            color: #000000;
        }
        #anotacoes-textarea:focus {
            outline: none;
        }
        #vantagens-desvantagens-panel {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(240, 230, 210, 0.95);
            padding: 20px;
            overflow-y: auto;
            z-index: 999;
            border: 2px solid #b8860b;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.3);
        }
        #vantagens-desvantagens-panel h2 {
            font-family: 'MedievalSharp', serif;
            font-size: 2rem;
            text-align: center;
            color: #a0522d;
            margin-bottom: 20px;
        }
        .vantagem-item, .desvantagem-item {
            padding: 10px;
            margin: 5px 0;
            background-color: #ffffff;
            border: 1px solid #ccc;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        .vantagem-item:hover, .desvantagem-item:hover {
            background-color: #f0e6d2;
        }
        .vantagem-item.comprada, .desvantagem-item.comprada {
            background-color: #e0e0e0;
            color: #555;
            cursor: not-allowed;
        }
        .vantagem-item.selecionada {
            background-color: #ffcccc;
            color: #ff0000;
        }
        .desvantagem-item.selecionada {
            background-color: #ccffcc;
            color: #008000;
        }
        #salvar-vantagens-btn, #fechar-pagina-btn {
            position: fixed;
            bottom: 20px;
            padding: 12px 25px;
            background-color: #000000;
            color: #ffffff;
            border: none;
            border-radius: 6px;
            font-family: 'MedievalSharp', serif;
            font-size: 1.2rem;
            cursor: pointer;
            transition: transform 0.2s ease;
        }
        #salvar-vantagens-btn {
            right: 250px;
            animation: aura-verde-btn 2s infinite;
            display: none;
        }
        #fechar-pagina-btn {
            right: 20px;
            background-color: #a52a2a;
        }
        #salvar-vantagens-btn:hover, #fechar-pagina-btn:hover {
            transform: translateY(-2px);
        }
        @keyframes aura-verde-btn {
            0% { box-shadow: 0 0 5px #00ff00, 0 0 10px #00ff00; }
            50% { box-shadow: 0 0 15px #00ff00, 0 0 20px #00ff00; }
            100% { box-shadow: 0 0 5px #00ff00, 0 0 10px #00ff00; }
        }
        .locomotion-container {
            background-color: #8B4513;
            border: 3px solid #FFD700;
            border-radius: 10px;
            padding: 15px;
            color: #FFD700;
            font-family: 'MedievalSharp', serif;
        }
        .locomotion-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        .locomotion-item label {
            font-weight: bold;
            color: #FFD700;
        }
        .locomotion-item span {
            font-size: 1.5rem;
            color: #000000;
            margin-left: 5px;
        }
        .list-display {
            background-color: #fff;
            border: 2px solid #b8860b;
            border-radius: 6px;
            padding: 10px;
            min-height: 100px;
            max-height: 200px;
            overflow-y: auto;
        }
        .list-item {
            cursor: pointer;
            margin-bottom: 5px;
            padding: 5px;
            border-bottom: 1px solid #ccc;
        }
        .list-item:hover {
            background-color: #e0e0e0;
        }
        .inventory-slot {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        .inventory-slot input[type="text"] {
            flex-grow: 1;
            margin-right: 10px;
        }
        .inventory-slot input[type="number"] {
            width: 60px;
        }
        @media (max-width: 768px) {
            body { padding: 10px; }
            #ficha-container { padding: 15px; }
            h1#nome-personagem-titulo { font-size: 2rem; }
            section h2 { font-size: 1.2rem; }
            input, textarea { font-size: 0.9rem; }
            .atributos-container, .vida-magia-vigor { flex-direction: column; }
            .atributos-coluna, .atributos-coluna-destaque, .atributo-container { width: 100%; }
            #anotacoes-btn { left: 10px; top: auto; bottom: 60px; }
            #anotacoes-panel { left: 10px; top: auto; bottom: 110px; }
        }
    </style>
</head>
<body>
    <div id="fichas-sidebar">
        <div id="add-ficha-btn"><span>+ Fichas</span></div>
    </div>

    <div id="ficha-container">
        <h1 id="nome-personagem-titulo">Ficha de Personagem</h1>
        <div id="game-master-message">Você virou o Game Master</div>
        <div id="character-image-container" onclick="document.getElementById('character-image-input').click()">
            <img id="character-image" alt="Imagem do Personagem">
            <input type="file" id="character-image-input" accept="image/*" style="display: none;">
        </div>
        <div id="dice-container">
            <label>Role seu dado:</label>
            <div id="dice-roll">-</div>
            <div id="dice-result"></div>
        </div>

        <div id="ficha-content">
            <!-- Informações Básicas -->
            <section id="informacoes-basicas">
                <h2>Informações Básicas</h2>
                <label for="nome-personagem">Nome do Personagem:</label>
                <input type="text" id="nome-personagem" placeholder="Digite o nome do seu personagem">
                <label for="descricao-personagem">Descrição do Personagem:</label>
                <textarea id="descricao-personagem" placeholder="Digite a descrição do seu personagem"></textarea>
            </section>

            <!-- Recursos -->
            <section id="recursos">
                <h2>Recursos</h2>
                <div class="vida-magia-vigor">
                    <div class="atributo-container vida">
                        <h3>Vida</h3>
                        <div class="valor-total medieval-box">
                            <span>Vida Total: </span><span id="vida-total" readonly>50</span>
                        </div>
                        <div class="valor-atual medieval-box">
                            <span>Vida Atual: </span>
                            <button onclick="diminuirVida()" title="Diminuir Vida">▼</button>
                            <span id="vida-atual">50</span>
                            <button onclick="aumentarVida()" title="Aumentar Vida">▲</button>
                        </div>
                        <div class="regeneracao">
                            <span>Regeneração por turno: <span id="regeneracao-vida">0</span> (parado)</span>
                        </div>
                    </div>
                    <div class="atributo-container magia">
                        <h3>Magia</h3>
                        <div class="valor-total medieval-box">
                            <span>Magia Total: </span><span id="magia-total" readonly>20</span>
                        </div>
                        <div class="valor-atual medieval-box">
                            <span>Magia Atual: </span>
                            <button onclick="diminuirMagia()" title="Diminuir Magia">▼</button>
                            <span id="magia-atual">20</span>
                            <button onclick="aumentarMagia()" title="Aumentar Magia">▲</button>
                        </div>
                        <div class="regeneracao">
                            <span>Regeneração por turno: <span id="regeneracao-magia">0</span></span>
                        </div>
                    </div>
                    <div class="atributo-container vigor">
                        <h3>Vigor</h3>
                        <div class="valor-total medieval-box">
                            <span>Vigor Total: </span><span id="vigor-total" readonly>10</span>
                        </div>
                        <div class="valor-atual medieval-box">
                            <span>Vigor Atual: </span>
                            <button onclick="diminuirVigor()" title="Diminuir Vigor">▼</button>
                            <span id="vigor-atual">10</span>
                            <button onclick="aumentarVigor()" title="Aumentar Vigor">▲</button>
                        </div>
                        <div class="regeneracao">
                            <span>Regeneração por turno: <span id="regeneracao-vigor">0</span> (parado)</span>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Atributos -->
            <section id="atributos">
                <h2>Atributos</h2>
                <div class="atributos-container">
                    <div class="atributos-coluna">
                        <div class="atributo"><label for="forca" title="Afeta ataque e RDF">Força:</label><input type="number" id="forca" value="0" min="0"></div>
                        <div class="atributo"><label for="destreza" title="Afeta ataque e acerto">Destreza:</label><input type="number" id="destreza" value="0" min="0"></div>
                        <div class="atributo"><label for="agilidade" title="Afeta esquiva e acerto">Agilidade:</label><input type="number" id="agilidade" value="0" min="0"></div>
                        <div class="atributo"><label for="constituicao" title="Afeta vida, magia e vigor">Constituição:</label><input type="number" id="constituicao" value="0" min="0"></div>
                        <div class="atributo"><label for="inteligencia" title="Afeta ataque mágico e RDM">Inteligência:</label><input type="number" id="inteligencia" value="0" min="0"></div>
                    </div>
                    <div class="atributos-coluna-destaque">
                        <div class="atributo-destaque"><label>Ataque:</label><span id="ataque" readonly>0</span></div>
                        <div class="atributo-destaque"><label>Ataque Mágico:</label><span id="ataque-magico" readonly>0</span></div>
                        <div class="atributo-destaque"><label>Acerto:</label><span id="acerto" readonly>0</span></div>
                        <div class="atributo-destaque"><label>Esquiva:</label><span id="esquiva" readonly>0</span></div>
                        <div class="atributo-destaque"><label>RDF:</label><span id="rdf" readonly>0</span></div>
                        <div class="atributo-destaque"><label>RDM:</label><span id="rdm" readonly>0</span></div>
                    </div>
                </div>
            </section>

            <!-- Combate -->
            <section id="combate">
                <h2>Combate</h2>
                <div class="armamento-container">
                    <div class="armamento-coluna">
                        <label>Armamento Mão Direita:</label>
                        <div class="flex items-center mb-2">
                            <input type="text" id="arma-direita-nome" placeholder="Nome da Arma" class="mr-2">
                            <span>Ataque </span><input type="number" id="arma-direita-ataque" value="0" class="w-20 mr-2">
                            <span>Ataque Mágico </span><input type="number" id="arma-direita-ataque-magico" value="0" class="w-20">
                        </div>
                    </div>
                    <div class="armamento-coluna">
                        <label>Armamento Mão Esquerda:</label>
                        <div class="flex items-center">
                            <input type="text" id="arma-esquerda-nome" placeholder="Nome da Arma" class="mr-2">
                            <span>Ataque </span><input type="number" id="arma-esquerda-ataque" value="0" class="w-20 mr-2">
                            <span>Ataque Mágico </span><input type="number" id="arma-esquerda-ataque-magico" value="0" class="w-20">
                        </div>
                    </div>
                </div>
            </section>

            <!-- Inventário e Habilidades -->
            <section id="inventario-habilidades">
                <h2>Inventário e Habilidades</h2>
                <div class="flex gap-20">
                    <div style="width: 50%;">
                        <label>Inventário (Peso Total: <span id="peso-total">0</span> kg):</label>
                        <div id="inventario-slots">
                            <div class="inventory-slot"><input type="text" placeholder="Item 1" class="inventory-item"><input type="number" min="0" value="0" class="inventory-weight" title="Peso em kg"></div>
                            <div class="inventory-slot"><input type="text" placeholder="Item 2" class="inventory-item"><input type="number" min="0" value="0" class="inventory-weight"></div>
                            <div class="inventory-slot"><input type="text" placeholder="Item 3" class="inventory-item"><input type="number" min="0" value="0" class="inventory-weight"></div>
                            <div class="inventory-slot"><input type="text" placeholder="Item 4" class="inventory-item"><input type="number" min="0" value="0" class="inventory-weight"></div>
                            <div class="inventory-slot"><input type="text" placeholder="Item 5" class="inventory-item"><input type="number" min="0" value="0" class="inventory-weight"></div>
                            <div class="inventory-slot"><input type="text" placeholder="Item 6" class="inventory-item"><input type="number" min="0" value="0" class="inventory-weight"></div>
                            <div class="inventory-slot"><input type="text" placeholder="Item 7" class="inventory-item"><input type="number" min="0" value="0" class="inventory-weight"></div>
                            <div class="inventory-slot"><input type="text" placeholder="Item 8" class="inventory-item"><input type="number" min="0" value="0" class="inventory-weight"></div>
                            <div class="inventory-slot"><input type="text" placeholder="Item 9" class="inventory-item"><input type="number" min="0" value="0" class="inventory-weight"></div>
                            <div class="inventory-slot"><input type="text" placeholder="Item 10" class="inventory-item"><input type="number" min="0" value="0" class="inventory-weight"></div>
                        </div>
                    </div>
                    <div style="width: 50%;">
                        <label>Magias e Habilidades:</label>
                        <div id="magias-list">
                            <div class="inventory-slot"><input type="text" placeholder="Nome da Magia" class="magia-nome"><input type="number" min="0" value="0" class="magia-custo" title="Custo de Mana"></div>
                            <button class="mt-2">+ Adicionar Magia</button>
                        </div>
                    </div>
                </div>
                <div class="mt-4">
                    <label>Vantagens:</label>
                    <div id="vantagens-list-display" class="list-display"></div>
                    <label>Desvantagens:</label>
                    <div id="desvantagens-list-display" class="list-display"></div>
                </div>
            </section>

            <!-- Locomoção -->
            <section id="locomocao">
                <h2>Locomoção</h2>
                <div class="locomotion-container">
                    <div class="locomotion-item">
                        <label>Velocidade de Corrida (km/h):</label>
                        <span>🏃‍♂️</span><span id="velocidade-corrida" readonly>25</span>
                    </div>
                    <div class="locomotion-item">
                        <label>Altura do Pulo (m):</label>
                        <span>⬆️</span><span id="altura-pulo" readonly>1</span>
                    </div>
                    <div class="locomotion-item">
                        <label>Distância do Pulo (m):</label>
                        <span>➡️</span><span id="distancia-pulo" readonly>3</span>
                    </div>
                </div>
            </section>

            <!-- Status -->
            <section id="status">
                <h2>Status</h2>
                <div class="status-container">
                    <div class="flex gap-20">
                        <div>
                            <label>Experiência:</label>
                            <input type="number" id="experiencia" value="0" min="0">
                            <label>Pontos de Habilidade (PD):</label>
                            <span id="pontos-habilidade" readonly>25</span>
                            <label>Pontos de Vantagem (PH):</label>
                            <span id="pontos-vantagem" readonly>5</span>
                        </div>
                        <div>
                            <label>Classe:</label>
                            <span id="classe"></span>
                            <label>Raça:</label>
                            <span id="raca"></span>
                        </div>
                    </div>
                    <div id="nivel-container">
                        <label>Nível:</label>
                        <span id="nivel">0</span>
                    </div>
                </div>
            </section>

            <div class="botoes-container">
                <button id="reset-pontos" class="botao botao-reset">Reiniciar Pontos</button>
                <button id="recomecar" class="botao botao-recomecar">Recomeçar</button>
                <button id="bloquear-ficha" class="botao botao-bloquear">Bloquear Ficha</button>
                <button id="lua-btn" class="botao">🌙</button>
                <button id="sol-btn" class="botao">☀️</button>
            </div>

            <button id="excluir-ficha" class="botao botao-excluir">Excluir Ficha</button>
            <button id="vantagens-desvantagens-btn">Vantagens e Desvantagens</button>
            <button id="anotacoes-btn">Anotações</button>
            <div id="anotacoes-panel">
                <textarea id="anotacoes-textarea" placeholder="Digite suas anotações aqui..."></textarea>
            </div>
        </div>
    </div>

    <div id="vantagens-desvantagens-panel">
        <h2>Vantagens e Desvantagens</h2>
        <div id="vantagens-list"></div>
        <div id="desvantagens-list"></div>
        <button id="salvar-vantagens-btn">SALVAR</button>
        <button id="fechar-pagina-btn">Fechar Página</button>
    </div>

    <div id="nome-ficha-modal" class="modal">
        <div class="modal-content">
            <h3>Dê um Nome à Ficha</h3>
            <input type="text" id="nome-ficha-input" placeholder="Nome da ficha" maxlength="20">
            <button class="confirm-btn" onclick="criarNovaFicha()">Confirmar</button>
            <button class="cancel-btn" onclick="fecharModal('nome-ficha-modal')">Cancelar</button>
        </div>
    </div>

    <div id="bloquear-ficha-modal" class="modal">
        <div class="modal-content">
            <h3>Ponha sua Senha de 4 Dígitos</h3>
            <input type="password" id="senha-bloqueio-input" placeholder="Senha (4 dígitos)" maxlength="4">
            <button class="confirm-btn" onclick="bloquearFicha()">Confirmar</button>
            <button class="cancel-btn" onclick="fecharModal('bloquear-ficha-modal')">Cancelar</button>
        </div>
    </div>

    <div id="password-modal" class="modal">
        <div class="modal-content">
            <h3>Digite sua Senha</h3>
            <input type="password" id="senha-desbloqueio-input" placeholder="Senha (4 dígitos)" maxlength="4">
            <button class="confirm-btn" onclick="desbloquearFicha()">Confirmar</button>
            <button class="cancel-btn" onclick="fecharModal('password-modal')">Cancelar</button>
        </div>
    </div>

    <div id="confirmar-compra-modal" class="modal">
        <div class="modal-content">
            <h3>Tem certeza que quer comprar isso?</h3>
            <button class="confirm-btn" id="confirmar-compra-btn">Sim</button>
            <button class="cancel-btn" onclick="fecharModal('confirmar-compra-modal')">Não</button>
        </div>
    </div>

    <div id="salvar-vantagens-modal" class="modal">
        <div class="modal-content">
            <h3>Se salvar, as alterações não poderão ser desfeitas.</h3>
            <button class="confirm-btn" id="confirmar-salvar-vantagens-btn">OK</button>
            <button class="cancel-btn" onclick="fecharModal('salvar-vantagens-modal')">Cancelar</button>
        </div>
    </div>

    <div id="senha-gm-modal" class="modal">
        <div class="modal-content">
            <h3>Peça permissão ao GM</h3>
            <input type="password" id="senha-gm-input" placeholder="Senha GM">
            <button class="confirm-btn" id="confirmar-senha-gm-btn">Confirmar</button>
            <button class="cancel-btn" onclick="fecharModal('senha-gm-modal')">Cancelar</button>
        </div>
    </div>

    <div id="notification"></div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBbbwbwPXv6gztkyP3TXK-DtooEI7FcClI",
            authDomain: "ficha-de-rpg-b9685.firebaseapp.com",
            databaseURL: "https://ficha-de-rpg-b9685-default-rtdb.firebaseio.com",
            projectId: "ficha-de-rpg-b9685",
            storageBucket: "ficha-de-rpg-b9685.firebasestorage.app",
            messagingSenderId: "528610398062",
            appId: "1:528610398062:web:8fdb9cfd5ded8167613b7f"
        };

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        let fichas = {};
        let currentFichaId = null;
        let isFichaLocked = false;
        let fichaPassword = null;
        let isFichaUnlocked = false;
        const senhaMatriz = "777";
        let vantagensSelecionadas = [];
        let desvantagensSelecionadas = [];
        let tempVantagensSelecionadas = [];
        let tempDesvantagensSelecionadas = [];
        let vidaTotal = 50, vidaAtual = 50, magiaTotal = 20, magiaAtual = 20, vigorTotal = 10, vigorAtual = 10;

        const vantagensData = [
            { nome: "Maestria com Armas curtas (2)", custo: 2, descricao: "Adiciona +1 em ataque, +1 em acerto com armas curtas." },
            { nome: "Maestria com armas pesadas (2)", custo: 2, descricao: "Adiciona +2 em ataque com armas pesadas." },
            { nome: "Maestria com armas de longo alcance (2)", custo: 2, descricao: "Adiciona +2 em acerto com armas de longo alcance." },
            { nome: "Furtar (2)", custo: 2, descricao: "+4 em testes de furto." },
            { nome: "Lábia (2)", custo: 2, descricao: "+5 em testes de lábia." },
            { nome: "Velejar (1)", custo: 1, descricao: "" },
            { nome: "Beleza (1)", custo: 1, descricao: "Aumenta em +3 o teste em lábia, paquera e persuasão." },
            { nome: "Boa Fama (2)", custo: 2, descricao: "Aumenta em +4 chance de descontos em armamentos, pousadas, alimentos, etc." },
            { nome: "Arremedo (2)", custo: 2, descricao: "Capacidade de imitar qualquer som SIMPLES." },
            { nome: "Destemor (1)", custo: 1, descricao: "Dificilmente é assustado por algo." },
            { nome: "Empatia (3)", custo: 3, descricao: "Sensibilidade extraordinária em relação aos outras pessoas. É um talento excelente para identificar impostores, possessões por espirito, etc." },
            { nome: "Empatia com animais (1)", custo: 1, descricao: "Pode compreender as motivações dos animais." },
            { nome: "Patrono (4)", custo: 4, descricao: "Possui um mentor/mestre/professor, até mesmo uma organização/guilda que pode lhe oferecer ajuda." },
            { nome: "Reconhecimento Social (2)", custo: 2, descricao: "É membro de uma raça, classe, sexo ou grupo muito respeitado, temido ou venerado pela sociedade. Adiciona +2 pontos o teste em lábia, paquera e persuasão." },
            { nome: "Riqueza (2)", custo: 2, descricao: "Inicia com 20 moedas de ouro." },
            { nome: "Aptidão para magia (4)", custo: 4, descricao: "Adiciona 15% a mais de dano e gasta 15% a menos de magia para toda vez que usa a magia que você tem aptidão." },
            { nome: "Combo Físico (4)", custo: 4, descricao: "Essa vantagem lhe concede começar sua locomoção com 50km velocidade corrida, pulo de 3 metros de altura e 9 metros de distância.", restricao: "inicio" },
            { nome: "Nadar (1)", custo: 1, descricao: "" },
            { nome: "Escalar (2)", custo: 2, descricao: "" },
            { nome: "Segunda língua (1)", custo: 1, descricao: "Fala mais um idioma." },
            { nome: "Paquerador (2)", custo: 2, descricao: "Adiciona +4 em teste para paquera e persuasão envolvendo flerte." },
            { nome: "Senso de perigo (5)", custo: 5, descricao: "Sempre que houver algo grave para ocorrer o mestre do RPG pedirá pra você jogar um dado para reagir." },
            { nome: "Acrobata (3)", custo: 3, descricao: "Adiciona + fama ao lutar em público." },
            { nome: "Equilíbrio Perfeito (3)", custo: 3, descricao: "Adiciona +8 em testes de equilíbrio." },
            { nome: "Tecnologia (2)", custo: 2, descricao: "Você é engenhoso, pode inventar coisas, criar objetos improvisados." },
            { nome: "Poder Oculto (7)", custo: 7, descricao: "Quando sua vida estiver em 10%, você ativa o poder oculto aumentando todos seus atributos em 50%. Mas a partir do momento em que sua vida sai dos 10%, os atributos voltam ao normal." },
            { nome: "Sobrevivência em floresta (2)", custo: 2, descricao: "Tem facilidade para achar cavernas, criar assentamentos, barracas, achar comida e gravar caminhos no meio da floresta. Facilidade para achar água, etc." }
        ];

        const desvantagensData = [
            { nome: "Fobia (+2)", ganho: 2, descricao: "Você tem um medo irracional de algo específico." },
            { nome: "Má Fama (+2)", ganho: 2, descricao: "Você é mal visto pela sociedade, dificultando interações sociais." },
            { nome: "Alcoolismo (+2)", ganho: 2, descricao: "Você tem uma dependência de álcool que afeta suas decisões." },
            { nome: "Altruísmo (+2)", ganho: 2, descricao: "Se sacrifica por outras pessoas e pouco se importa com fama ou riqueza." },
            { nome: "Avareza (+2)", ganho: 2, descricao: "Preocupação permanente na conservação de riquezas." },
            { nome: "Bullying (+3)", ganho: 3, descricao: "Gosta de caçoar, agredir, denegrir, difamar e apontar defeitos tanto em amigos quanto inimigos." },
            { nome: "Circunspeção (+2)", ganho: 2, descricao: "Não entende piadas, entende tudo de forma literal e acredita que todos estão sempre falando sério." },
            { nome: "Compulsões (+3)", ganho: 3, descricao: "Hábito ou vício que toma boa parte dos seus recursos e tempo." },
            { nome: "Covardia (+2)", ganho: 2, descricao: "Tem extremo cuidado com seu bem-estar físico e dificuldade em assumir riscos." },
            { nome: "Dependentes (+4)", ganho: 4, descricao: "Possui alguém que depende de você a todo momento (filhos, parentes, entes queridos, etc.)." },
            { nome: "Fúria (+2)", ganho: 2, descricao: "Tendência a perder o controle e partir para um ataque frenético, ativado por dano, insulto ou aleatoriamente." },
            { nome: "Honestidade (+3)", ganho: 3, descricao: "Não consegue mentir ou omitir, sempre fala a verdade e desmascara mentiras." },
            { nome: "Impulsividade (+2)", ganho: 2, descricao: "Sempre age sem pensar." },
            { nome: "Luxúria (+2)", ganho: 2, descricao: "Desejo incontrolável por romance." },
            { nome: "Magnetismo Sobrenatural (+2)", ganho: 2, descricao: "Coisas estranhas acontecem com seu personagem em um nível alarmante." },
            { nome: "No Limite (+4)", ganho: 4, descricao: "Assume riscos extremamente irracionais diante de perigo mortal (ex.: enfrentar um boss sozinho)." },
            { nome: "Teimosia (+1)", ganho: 1, descricao: "Quer sempre fazer as coisas do seu modo e não segue planos que não sejam seus." },
            { nome: "Amnésia (+2)", ganho: 2, descricao: "Em certos momentos, não consegue lembrar de coisas importantes." }
        ];

        const nomePersonagemInput = document.getElementById('nome-personagem');
        const descricaoPersonagemInput = document.getElementById('descricao-personagem');
        const forcaInput = document.getElementById('forca');
        const destrezaInput = document.getElementById('destreza');
        const agilidadeInput = document.getElementById('agilidade');
        const inteligenciaInput = document.getElementById('inteligencia');
        const constituicaoInput = document.getElementById('constituicao');
        const ataqueSpan = document.getElementById('ataque');
        const ataqueMagicoSpan = document.getElementById('ataque-magico');
        const acertoSpan = document.getElementById('acerto');
        const esquivaSpan = document.getElementById('esquiva');
        const rdfSpan = document.getElementById('rdf');
        const rdmSpan = document.getElementById('rdm');
        const armaDireitaNomeInput = document.getElementById('arma-direita-nome');
        const armaDireitaAtaqueInput = document.getElementById('arma-direita-ataque');
        const armaDireitaAtaqueMagicoInput = document.getElementById('arma-direita-ataque-magico');
        const armaEsquerdaNomeInput = document.getElementById('arma-esquerda-nome');
        const armaEsquerdaAtaqueInput = document.getElementById('arma-esquerda-ataque');
        const armaEsquerdaAtaqueMagicoInput = document.getElementById('arma-esquerda-ataque-magico');
        const resetPontosButton = document.getElementById('reset-pontos');
        const recomecarButton = document.getElementById('recomecar');
        const bloquearFichaButton = document.getElementById('bloquear-ficha');
        const experienciaInput = document.getElementById('experiencia');
        const nivelSpan = document.getElementById('nivel');
        const pontosHabilidadeSpan = document.getElementById('pontos-habilidade');
        const pontosVantagemSpan = document.getElementById('pontos-vantagem');
        const velocidadeCorridaSpan = document.getElementById('velocidade-corrida');
        const alturaPuloSpan = document.getElementById('altura-pulo');
        const distanciaPuloSpan = document.getElementById('distancia-pulo');
        const nomePersonagemTitulo = document.getElementById('nome-personagem-titulo');
        const gameMasterMessage = document.getElementById('game-master-message');
        const vantagensListDisplay = document.getElementById('vantagens-list-display');
        const desvantagensListDisplay = document.getElementById('desvantagens-list-display');
        const inventarioSlots = document.getElementById('inventario-slots');
        const pesoTotalSpan = document.getElementById('peso-total');
        const diceContainer = document.getElementById('dice-container');
        const diceRoll = document.getElementById('dice-roll');
        const diceResult = document.getElementById('dice-result');
        const notification = document.getElementById('notification');
        const characterImageInput = document.getElementById('character-image-input');
        const characterImage = document.getElementById('character-image');
        const vantagensDesvantagensBtn = document.getElementById('vantagens-desvantagens-btn');
        const vantagensDesvantagensPanel = document.getElementById('vantagens-desvantagens-panel');
        const vantagensList = document.getElementById('vantagens-list');
        const desvantagensList = document.getElementById('desvantagens-list');
        const salvarVantagensBtn = document.getElementById('salvar-vantagens-btn');
        const fecharPaginaBtn = document.getElementById('fechar-pagina-btn');
        const fichaContainer = document.getElementById('ficha-container');
        const magiasList = document.getElementById('magias-list');
        const anotacoesBtn = document.getElementById('anotacoes-btn');
        const anotacoesPanel = document.getElementById('anotacoes-panel');
        const anotacoesTextarea = document.getElementById('anotacoes-textarea');

        const atributosInputs = [forcaInput, destrezaInput, agilidadeInput, inteligenciaInput, constituicaoInput];

        let nivel = 0;
        let nivelAnterior = 0;
        let pontosHabilidadeTotal = 25;
        let pontosHabilidadeUsados = 0;
        let experiencia = 0;
        let vidaBase = 50;

        const nivelData = [
            { nivel: 0, xp: 0, pd: 25, ph: 5 },
            { nivel: 1, xp: 10, pd: 31, ph: 6 },
            { nivel: 2, xp: 30, pd: 37, ph: 7 },
            { nivel: 3, xp: 60, pd: 43, ph: 8 },
            { nivel: 4, xp: 100, pd: 49, ph: 9 },
            { nivel: 5, xp: 150, pd: 55, ph: 10 },
            { nivel: 6, xp: 210, pd: 61, ph: 11 },
            { nivel: 7, xp: 280, pd: 67, ph: 12 },
            { nivel: 8, xp: 360, pd: 73, ph: 13 },
            { nivel: 9, xp: 450, pd: 79, ph: 14 },
            { nivel: 10, xp: 550, pd: 85, ph: 15 },
            { nivel: 11, xp: 670, pd: 91, ph: 16 },
            { nivel: 12, xp: 810, pd: 97, ph: 17 },
            { nivel: 13, xp: 970, pd: 103, ph: 18 },
            { nivel: 14, xp: 1150, pd: 109, ph: 19 },
            { nivel: 15, xp: 1350, pd: 115, ph: 20 },
            { nivel: 16, xp: 1570, pd: 121, ph: 21 },
            { nivel: 17, xp: 1810, pd: 127, ph: 22 },
            { nivel: 18, xp: 2070, pd: 133, ph: 23 },
            { nivel: 19, xp: 2350, pd: 139, ph: 24 },
            { nivel: 20, xp: 2650, pd: 145, ph: 25 },
            { nivel: 21, xp: 2980, pd: 148, ph: 26 },
            { nivel: 22, xp: 3340, pd: 151, ph: 27 },
            { nivel: 23, xp: 3730, pd: 154, ph: 28 },
            { nivel: 24, xp: 4150, pd: 157, ph: 29 },
            { nivel: 25, xp: 4600, pd: 160, ph: 30 },
            { nivel: 26, xp: 5080, pd: 163, ph: 31 },
            { nivel: 27, xp: 5590, pd: 166, ph: 32 },
            { nivel: 28, xp: 6130, pd: 169, ph: 33 },
            { nivel: 29, xp: 8000, pd: 219, ph: 34 },
            { nivel: 30, xp: 10000, pd: 319, ph: 35 }
        ];

        function criarFichaMatriz() {
            const fichaMatrizId = 'ficha-matriz';
            const fichaMatriz = {
                nomeFicha: 'Matriz',
                nomePersonagem: 'Personagem Matriz',
                descricaoPersonagem: 'Ficha original do sistema',
                forca: '0',
                destreza: '0',
                agilidade: '0',
                inteligencia: '0',
                constituicao: '0',
                experiencia: '0',
                armaDireitaNome: '',
                armaDireitaAtaque: '0',
                armaDireitaAtaqueMagico: '0',
                armaEsquerdaNome: '',
                armaEsquerdaAtaque: '0',
                armaEsquerdaAtaqueMagico: '0',
                vantagens: '',
                magiasHabilidades: '',
                desvantagens: '',
                inventario: Array(10).fill({ item: '', peso: '0' }),
                velocidadeCorrida: '25',
                alturaPulo: '1',
                distanciaPulo: '3',
                anotacoes: '',
                isLocked: true,
                password: senhaMatriz,
                imagem: null,
                vidaTotal: '50',
                vidaAtual: '50',
                magiaTotal: '20',
                magiaAtual: '20',
                vigorTotal: '10',
                vigorAtual: '10'
            };

            database.ref('fichas/ficha-matriz').once('value', (snapshot) => {
                if (!snapshot.exists()) {
                    database.ref(`fichas/${fichaMatrizId}`).set(fichaMatriz).then(() => {
                        currentFichaId = fichaMatrizId;
                        carregarFicha(fichaMatrizId);
                    }).catch(error => console.error('Erro ao criar matriz:', error));
                } else {
                    currentFichaId = fichaMatrizId;
                    carregarFicha(fichaMatrizId);
                    carregarFichas();
                }
            });
        }

        function carregarFichas() {
            database.ref('fichas').on('value', (snapshot) => {
                fichas = snapshot.val() || {};
                if (!fichas['ficha-matriz']) {
                    criarFichaMatriz();
                } else {
                    atualizarAbasFichas();
                }
            }, (error) => {
                console.error('Erro ao carregar fichas:', error);
            });
        }

        function atualizarAbasFichas() {
            const fichasSidebar = document.getElementById('fichas-sidebar');
            const addFichaBtn = document.getElementById('add-ficha-btn');
            while (fichasSidebar.children.length > 1) {
                fichasSidebar.removeChild(fichasSidebar.children[1]);
            }
            for (let fichaId in fichas) {
                if (fichaId !== 'ficha-matriz') {
                    const tab = document.createElement('div');
                    tab.className = 'ficha-tab';
                    const span = document.createElement('span');
                    span.textContent = fichas[fichaId].nomeFicha || 'Sem Nome';
                    tab.appendChild(span);
                    tab.dataset.fichaId = fichaId;
                    if (fichaId === currentFichaId) {
                        tab.classList.add('active');
                    }
                    tab.onclick = () => {
                        currentFichaId = fichaId;
                        carregarFicha(fichaId);
                        atualizarAbasFichas();
                    };
                    fichasSidebar.appendChild(tab);
                }
            }
            fichasSidebar.insertBefore(addFichaBtn, fichasSidebar.firstChild);
        }

        function criarNovaFicha() {
            const nomeFicha = document.getElementById('nome-ficha-input').value.trim();
            if (!nomeFicha) {
                alert('Por favor, dê um nome à ficha!');
                return;
            }

            const fichaId = database.ref('fichas').push().key;
            const novaFicha = {
                nomeFicha: nomeFicha,
                nomePersonagem: '',
                descricaoPersonagem: '',
                forca: '0',
                destreza: '0',
                agilidade: '0',
                inteligencia: '0',
                constituicao: '0',
                experiencia: '0',
                armaDireitaNome: '',
                armaDireitaAtaque: '0',
                armaDireitaAtaqueMagico: '0',
                armaEsquerdaNome: '',
                armaEsquerdaAtaque: '0',
                armaEsquerdaAtaqueMagico: '0',
                vantagens: '',
                magiasHabilidades: '',
                desvantagens: '',
                inventario: Array(10).fill({ item: '', peso: '0' }),
                velocidadeCorrida: '25',
                alturaPulo: '1',
                distanciaPulo: '3',
                anotacoes: '',
                isLocked: false,
                password: null,
                imagem: null,
                vidaTotal: '50',
                vidaAtual: '50',
                magiaTotal: '20',
                magiaAtual: '20',
                vigorTotal: '10',
                vigorAtual: '10'
            };

            database.ref(`fichas/${fichaId}`).set(novaFicha).then(() => {
                currentFichaId = fichaId;
                carregarFicha(fichaId);
                fecharModal('nome-ficha-modal');
                atualizarAbasFichas();
            }).catch((error) => {
                console.error('Erro ao criar nova ficha:', error);
                alert('Ocorreu um erro ao criar a ficha. Tente novamente.');
            });
        }

        function fecharModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function carregarFicha(fichaId) {
            if (!fichas[fichaId]) return;

            const ficha = fichas[fichaId];
            nomePersonagemInput.value = ficha.nomePersonagem || '';
            descricaoPersonagemInput.value = ficha.descricaoPersonagem || '';
            forcaInput.value = ficha.forca || '0';
            destrezaInput.value = ficha.destreza || '0';
            agilidadeInput.value = ficha.agilidade || '0';
            inteligenciaInput.value = ficha.inteligencia || '0';
            constituicaoInput.value = ficha.constituicao || '0';
            experienciaInput.value = ficha.experiencia || '0';
            armaDireitaNomeInput.value = ficha.armaDireitaNome || '';
            armaDireitaAtaqueInput.value = ficha.armaDireitaAtaque || '0';
            armaDireitaAtaqueMagicoInput.value = ficha.armaDireitaAtaqueMagico || '0';
            armaEsquerdaNomeInput.value = ficha.armaEsquerdaNome || '';
            armaEsquerdaAtaqueInput.value = ficha.armaEsquerdaAtaque || '0';
            armaEsquerdaAtaqueMagicoInput.value = ficha.armaEsquerdaAtaqueMagico || '0';
            velocidadeCorridaSpan.textContent = ficha.velocidadeCorrida || '25';
            alturaPuloSpan.textContent = ficha.alturaPulo || '1';
            distanciaPuloSpan.textContent = ficha.distanciaPulo || '3';
            anotacoesTextarea.value = ficha.anotacoes || '';
            isFichaLocked = ficha.isLocked || false;
            fichaPassword = ficha.password || null;
            isFichaUnlocked = false;

            vidaTotal = parseInt(ficha.vidaTotal) || 50;
            vidaAtual = parseInt(ficha.vidaAtual) || 50;
            magiaTotal = parseInt(ficha.magiaTotal) || 20;
            magiaAtual = parseInt(ficha.magiaAtual) || 20;
            vigorTotal = parseInt(ficha.vigorTotal) || 10;
            vigorAtual = parseInt(ficha.vigorAtual) || 10;

            document.getElementById('vida-total').textContent = vidaTotal;
            document.getElementById('vida-atual').textContent = vidaAtual;
            document.getElementById('magia-total').textContent = magiaTotal;
            document.getElementById('magia-atual').textContent = magiaAtual;
            document.getElementById('vigor-total').textContent = vigorTotal;
            document.getElementById('vigor-atual').textContent = vigorAtual;

            vantagensSelecionadas = ficha.vantagens ? ficha.vantagens.split('\n').filter(v => v.trim()) : [];
            desvantagensSelecionadas = ficha.desvantagens ? ficha.desvantagens.split('\n').filter(d => d.trim()) : [];

            vantagensListDisplay.innerHTML = '';
            desvantagensListDisplay.innerHTML = '';
            vantagensSelecionadas.forEach(vantagem => {
                const item = document.createElement('div');
                item.textContent = vantagem;
                item.className = 'list-item';
                item.onclick = () => removerVantagem(vantagem);
                vantagensListDisplay.appendChild(item);
            });
            desvantagensSelecionadas.forEach(desvantagem => {
                const item = document.createElement('div');
                item.textContent = desvantagem;
                item.className = 'list-item';
                item.onclick = () => removerDesvantagem(desvantagem);
                desvantagensListDisplay.appendChild(item);
            });

            const inventario = Array.isArray(ficha.inventario) ? ficha.inventario : Array(10).fill({ item: '', peso: '0' });
            const slots = inventarioSlots.querySelectorAll('.inventory-slot');
            slots.forEach((slot, index) => {
                const itemInput = slot.querySelector('.inventory-item');
                const weightInput = slot.querySelector('.inventory-weight');
                itemInput.value = inventario[index]?.item || '';
                weightInput.value = inventario[index]?.peso || '0';
            });
            calcularPesoTotal();

            magiasList.innerHTML = '<div class="inventory-slot"><input type="text" placeholder="Nome da Magia" class="magia-nome"><input type="number" min="0" value="0" class="magia-custo" title="Custo de Mana"></div><button class="mt-2">+ Adicionar Magia</button>';
            const magias = ficha.magiasHabilidades ? ficha.magiasHabilidades.split('\n').filter(m => m.trim()) : [];
            magias.forEach(magia => {
                const [nome, custo] = magia.split(';');
                const slot = document.createElement('div');
                slot.className = 'inventory-slot';
                slot.innerHTML = `<input type="text" value="${nome || ''}" class="magia-nome"><input type="number" min="0" value="${custo || '0'}" class="magia-custo" title="Custo de Mana">`;
                magiasList.insertBefore(slot, magiasList.lastChild);
            });

            atualizarAtributos();
        }

        function salvarFicha() {
            if (!currentFichaId) return;

            const ficha = {
                nomeFicha: fichas[currentFichaId].nomeFicha,
                nomePersonagem: nomePersonagemInput.value,
                descricaoPersonagem: descricaoPersonagemInput.value,
                forca: forcaInput.value,
                destreza: destrezaInput.value,
                agilidade: agilidadeInput.value,
                inteligencia: inteligenciaInput.value,
                constituicao: constituicaoInput.value,
                experiencia: experienciaInput.value,
                armaDireitaNome: armaDireitaNomeInput.value,
                armaDireitaAtaque: armaDireitaAtaqueInput.value,
                armaDireitaAtaqueMagico: armaDireitaAtaqueMagicoInput.value,
                armaEsquerdaNome: armaEsquerdaNomeInput.value,
                armaEsquerdaAtaque: armaEsquerdaAtaqueInput.value,
                armaEsquerdaAtaqueMagico: armaEsquerdaAtaqueMagicoInput.value,
                vantagens: vantagensSelecionadas.join('\n'),
                magiasHabilidades: fichas[currentFichaId].magiasHabilidades || '',
                desvantagens: desvantagensSelecionadas.join('\n'),
                inventario: Array.from(inventarioSlots.querySelectorAll('.inventory-slot')).map(slot => ({
                    item: slot.querySelector('.inventory-item').value,
                    peso: slot.querySelector('.inventory-weight').value
                })),
                velocidadeCorrida: velocidadeCorridaSpan.textContent,
                alturaPulo: alturaPuloSpan.textContent,
                distanciaPulo: distanciaPuloSpan.textContent,
                anotacoes: anotacoesTextarea.value,
                isLocked: isFichaLocked,
                password: fichaPassword,
                imagem: fichas[currentFichaId].imagem,
                vidaTotal: vidaTotal.toString(),
                vidaAtual: vidaAtual.toString(),
                magiaTotal: magiaTotal.toString(),
                magiaAtual: magiaAtual.toString(),
                vigorTotal: vigorTotal.toString(),
                vigorAtual: vigorAtual.toString()
            };

            database.ref(`fichas/${currentFichaId}`).set(ficha).then(() => {
                mostrarNotificacao('Ficha salva com sucesso!', 'save-success');
            }).catch(error => console.error('Erro ao salvar ficha:', error));
        }

        function atualizarAtributos() {
            const forca = parseInt(forcaInput.value) || 0;
            const destreza = parseInt(destrezaInput.value) || 0;
            const agilidade = parseInt(agilidadeInput.value) || 0;
            const inteligencia = parseInt(inteligenciaInput.value) || 0;
            const constituicao = parseInt(constituicaoInput.value) || 0;

            ataqueSpan.textContent = forca + destreza;
            ataqueMagicoSpan.textContent = inteligencia;
            acertoSpan.textContent = destreza + agilidade;
            esquivaSpan.textContent = agilidade;
            rdfSpan.textContent = forca;
            rdmSpan.textContent = inteligencia;
        }

        function calcularPesoTotal() {
            const slots = inventarioSlots.querySelectorAll('.inventory-slot');
            let pesoTotal = 0;
            slots.forEach(slot => {
                const peso = parseFloat(slot.querySelector('.inventory-weight').value) || 0;
                pesoTotal += peso;
            });
            pesoTotalSpan.textContent = pesoTotal.toFixed(2);
        }

        function aumentarVida() {
            if (vidaAtual < vidaTotal) {
                vidaAtual++;
                document.getElementById('vida-atual').textContent = vidaAtual;
                salvarFicha();
            }
        }

        function diminuirVida() {
            if (vidaAtual > 0) {
                vidaAtual--;
                document.getElementById('vida-atual').textContent = vidaAtual;
                salvarFicha();
            }
        }

        function aumentarMagia() {
            if (magiaAtual < magiaTotal) {
                magiaAtual++;
                document.getElementById('magia-atual').textContent = magiaAtual;
                salvarFicha();
            }
        }

        function diminuirMagia() {
            if (magiaAtual > 0) {
                magiaAtual--;
                document.getElementById('magia-atual').textContent = magiaAtual;
                salvarFicha();
            }
        }

        function aumentarVigor() {
            if (vigorAtual < vigorTotal) {
                vigorAtual++;
                document.getElementById('vigor-atual').textContent = vigorAtual;
                salvarFicha();
            }
        }

        function diminuirVigor() {
            if (vigorAtual > 0) {
                vigorAtual--;
                document.getElementById('vigor-atual').textContent = vigorAtual;
                salvarFicha();
            }
        }

        function addMagiaSlot() {
            const slot = document.createElement('div');
            slot.className = 'inventory-slot';
            slot.innerHTML = `<input type="text" placeholder="Nome da Magia" class="magia-nome"><input type="number" min="0" value="0" class="magia-custo" title="Custo de Mana">`;
            magiasList.insertBefore(slot, magiasList.lastChild);
            salvarMagias();
        }

        function salvarMagias() {
            const magiasSlots = magiasList.querySelectorAll('.inventory-slot');
            const magias = Array.from(magiasSlots).map(slot => {
                const nome = slot.querySelector('.magia-nome').value;
                const custo = slot.querySelector('.magia-custo').value;
                return `${nome};${custo}`;
            }).filter(magia => magia.trim() !== ';').join('\n');
            database.ref(`fichas/${currentFichaId}/magiasHabilidades`).set(magias).catch(error => console.error('Erro ao salvar magias:', error));
        }

        function removerVantagem(vantagem) {
            if (!isFichaLocked || isFichaUnlocked) {
                vantagensSelecionadas = vantagensSelecionadas.filter(v => v !== vantagem);
                carregarFicha(currentFichaId);
                salvarFicha();
            }
        }

        function removerDesvantagem(desvantagem) {
            if (!isFichaLocked || isFichaUnlocked) {
                desvantagensSelecionadas = desvantagensSelecionadas.filter(d => d !== desvantagem);
                carregarFicha(currentFichaId);
                salvarFicha();
            }
        }

        function bloquearFicha() {
            const senha = document.getElementById('senha-bloqueio-input').value;
            if (senha.length === 4) {
                isFichaLocked = true;
                fichaPassword = senha;
                salvarFicha();
                fecharModal('bloquear-ficha-modal');
                mostrarNotificacao('Ficha bloqueada com sucesso!', 'save-success');
            } else {
                alert('A senha deve ter 4 dígitos!');
            }
        }

        function desbloquearFicha() {
            const senha = document.getElementById('senha-desbloqueio-input').value;
            if (senha === fichaPassword) {
                isFichaUnlocked = true;
                fecharModal('password-modal');
                mostrarNotificacao('Ficha desbloqueada!', 'save-success');
            } else {
                alert('Senha incorreta!');
            }
        }

        function mostrarNotificacao(mensagem, tipo) {
            notification.textContent = mensagem;
            notification.className = tipo;
            notification.style.display = 'block';
            setTimeout(() => {
                notification.style.display = 'none';
            }, 2000);
        }

        function rolarDado() {
            const resultado = Math.floor(Math.random() * 20) + 1;
            diceRoll.textContent = resultado;
            diceResult.textContent = `Resultado: ${resultado}`;
            diceResult.style.display = 'block';
            if (resultado === 1) {
                diceRoll.className = 'critical-failure';
                mostrarNotificacao('Falha Crítica!', 'critical-failure');
            } else if (resultado === 20) {
                diceRoll.className = 'critical-success';
                mostrarNotificacao('Sucesso Crítico!', 'critical-success');
            } else {
                diceRoll.className = '';
                mostrarNotificacao(`Rolagem: ${resultado}`, 'normal-result');
            }
        }

        function carregarVantagensDesvantagens() {
            vantagensList.innerHTML = '';
            desvantagensList.innerHTML = '';
            vantagensData.forEach(vantagem => {
                const item = document.createElement('div');
                item.className = 'vantagem-item';
                item.textContent = `${vantagem.nome} - ${vantagem.descricao}`;
                if (vantagensSelecionadas.includes(vantagem.nome)) {
                    item.classList.add('comprada');
                }
                item.onclick = () => {
                    if (!item.classList.contains('comprada') && !isFichaLocked) {
                        item.classList.toggle('selecionada');
                        if (item.classList.contains('selecionada')) {
                            tempVantagensSelecionadas.push(vantagem.nome);
                        } else {
                            tempVantagensSelecionadas = tempVantagensSelecionadas.filter(v => v !== vantagem.nome);
                        }
                    }
                };
                vantagensList.appendChild(item);
            });
            desvantagensData.forEach(desvantagem => {
                const item = document.createElement('div');
                item.className = 'desvantagem-item';
                item.textContent = `${desvantagem.nome} - ${desvantagem.descricao}`;
                if (desvantagensSelecionadas.includes(desvantagem.nome)) {
                    item.classList.add('comprada');
                }
                item.onclick = () => {
                    if (!item.classList.contains('comprada') && !isFichaLocked) {
                        item.classList.toggle('selecionada');
                        if (item.classList.contains('selecionada')) {
                            tempDesvantagensSelecionadas.push(desvantagem.nome);
                        } else {
                            tempDesvantagensSelecionadas = tempDesvantagensSelecionadas.filter(d => d !== desvantagem.nome);
                        }
                    }
                };
                desvantagensList.appendChild(item);
            });
            salvarVantagensBtn.style.display = 'block';
        }

        function salvarVantagens() {
            vantagensSelecionadas = [...new Set([...vantagensSelecionadas, ...tempVantagensSelecionadas])];
            desvantagensSelecionadas = [...new Set([...desvantagensSelecionadas, ...tempDesvantagensSelecionadas])];
            tempVantagensSelecionadas = [];
            tempDesvantagensSelecionadas = [];
            salvarFicha();
            carregarFicha(currentFichaId);
            carregarVantagensDesvantagens();
            fecharModal('salvar-vantagens-modal');
        }

        function iniciarApp() {
            document.getElementById('add-ficha-btn').onclick = () => {
                document.getElementById('nome-ficha-modal').style.display = 'flex';
                document.getElementById('nome-ficha-input').value = '';
                document.getElementById('nome-ficha-input').focus();
            };

            bloquearFichaButton.onclick = () => {
                if (!isFichaLocked) {
                    document.getElementById('bloquear-ficha-modal').style.display = 'flex';
                } else if (!isFichaUnlocked) {
                    document.getElementById('password-modal').style.display = 'flex';
                }
            };

            resetPontosButton.onclick = () => {
                if (!isFichaLocked || isFichaUnlocked) {
                    atributosInputs.forEach(input => input.value = '0');
                    atualizarAtributos();
                    salvarFicha();
                }
            };

            recomecarButton.onclick = () => {
                if (!isFichaLocked || isFichaUnlocked) {
                    carregarFicha(currentFichaId);
                }
            };

            experienciaInput.onchange = () => {
                experiencia = parseInt(experienciaInput.value) || 0;
                nivel = nivelData.find(n => experiencia < n.xp)?.nivel || 0;
                nivelSpan.textContent = nivel;
                pontosHabilidadeTotal = nivelData[nivel].pd;
                pontosHabilidadeSpan.textContent = pontosHabilidadeTotal;
                pontosVantagemSpan.textContent = nivelData[nivel].ph;
                salvarFicha();
            };

            atributosInputs.forEach(input => {
                input.onchange = () => {
                    if (!isFichaLocked || isFichaUnlocked) {
                        atualizarAtributos();
                        salvarFicha();
                    }
                };
            });

            inventarioSlots.addEventListener('change', (e) => {
                if (e.target.classList.contains('inventory-item') || e.target.classList.contains('inventory-weight')) {
                    calcularPesoTotal();
                    salvarFicha();
                }
            });

            magiasList.addEventListener('change', (e) => {
                if (e.target.classList.contains('magia-nome') || e.target.classList.contains('magia-custo')) {
                    salvarMagias();
                }
            });

            document.querySelector('#magias-list button').onclick = addMagiaSlot;

            nomePersonagemInput.onchange = salvarFicha;
            descricaoPersonagemInput.onchange = salvarFicha;
            armaDireitaNomeInput.onchange = salvarFicha;
            armaDireitaAtaqueInput.onchange = salvarFicha;
            armaDireitaAtaqueMagicoInput.onchange = salvarFicha;
            armaEsquerdaNomeInput.onchange = salvarFicha;
            armaEsquerdaAtaqueInput.onchange = salvarFicha;
            armaEsquerdaAtaqueMagicoInput.onchange = salvarFicha;
            anotacoesTextarea.onchange = salvarFicha;

            diceRoll.onclick = rolarDado;

            vantagensDesvantagensBtn.onclick = () => {
                vantagensDesvantagensPanel.style.display = 'block';
                carregarVantagensDesvantagens();
            };

            fecharPaginaBtn.onclick = () => {
                vantagensDesvantagensPanel.style.display = 'none';
            };

            salvarVantagensBtn.onclick = () => {
                document.getElementById('salvar-vantagens-modal').style.display = 'flex';
            };

            document.getElementById('confirmar-salvar-vantagens-btn').onclick = salvarVantagens;

            anotacoesBtn.onclick = () => {
                anotacoesPanel.style.display = anotacoesPanel.style.display === 'block' ? 'none' : 'block';
            };

            carregarFichas();
        }

        window.onload = iniciarApp;
    </script>
</body>
</html>
