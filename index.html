<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ficha de Personagem RPG</title>
    <link href="https://fonts.googleapis.com/css2?family=MedievalSharp&family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@tailwindcss/browser@4"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f5f5f5;
            color: #000000;
            display: flex;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            background-image: url('medieval_background.jpg');
            background-size: cover;
            background-position: center;
        }

        #fichas-sidebar {
            width: 60px;
            background-color: #ffffff;
            padding: 10px 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.3);
            z-index: 1000;
        }

        .ficha-tab {
            width: 50px;
            height: 80px;
            background-color: #f0e6d2;
            border: 2px solid #b8860b;
            border-radius: 0 10px 10px 0;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            position: relative;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.2);
        }

        .ficha-tab:hover {
            background-color: #a0522d;
            transform: translateX(5px);
        }

        .ficha-tab.active {
            background-color: #a0522d;
            transform: translateX(5px);
        }

        .ficha-tab span {
            font-family: 'MedievalSharp', serif;
            color: #000000;
            font-size: 0.9rem;
            text-align: center;
            writing-mode: vertical-rl;
            transform: rotate(180deg);
            max-height: 60px;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        #add-ficha-btn {
            width: 50px;
            height: 80px;
            background-color: #f0e6d2;
            border: 2px solid #b8860b;
            border-radius: 0 10px 10px 0;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            position: fixed;
            top: 10px;
            left: 0;
            transition: transform 0.2s ease;
            box-shadow: 0 0 10px #ffd700, 0 0 20px #ffd700;
            z-index: 1001;
        }

        #add-ficha-btn span {
            font-family: 'MedievalSharp', serif;
            color: #000000;
            font-size: 0.9rem;
            text-align: center;
            writing-mode: vertical-rl;
            transform: rotate(180deg);
            max-height: 60px;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        #add-ficha-btn:hover {
            background-color: #a0522d;
            transform: translateX(5px);
        }

        #ficha-container {
            background-color: rgba(240, 230, 210, 0.95);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
            width: 95%;
            max-width: 1200px;
            margin: 0 auto;
            margin-bottom: 20px;
            border: 2px solid #b8860b;
            position: relative;
        }

        h1#nome-personagem-titulo {
            font-family: 'MedievalSharp', serif;
            color: #1C2526;
            font-size: 3rem;
            margin-bottom: 20px;
            text-align: center;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
            animation: raios 2s infinite linear;
        }

        @keyframes raios {
            0% { text-shadow: 0 0 5px #FFD700, 0 0 10px #FFD700, 0 0 15px #FFD700, 0 0 20px #FF4500; }
            50% { text-shadow: 0 0 10px #FFD700, 0 0 15px #FFD700, 0 0 20px #FF4500, 0 0 25px #FF4500; }
            100% { text-shadow: 0 0 5px #FFD700, 0 0 10px #FFD700, 0 0 15px #FFD700, 0 0 20px #FF4500; }
        }

        h2 {
            font-family: 'MedievalSharp', serif;
            color: #000000;
            font-size: 1.5rem;
            margin-bottom: 20px;
            text-align: center;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
        }

        label {
            font-weight: 600;
            color: #000000;
            margin-bottom: 8px;
            display: block;
        }

        input[type="text"], input[type="number"], textarea {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 6px;
            width: calc(100% - 20px);
            margin-bottom: 15px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
            background-color: #f8f8f8;
            color: #000000;
        }

        input[type="text"]:focus, input[type="number"]:focus, textarea:focus {
            border-color: #a0522d;
            outline: none;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        textarea {
            resize: none;
            height: 100px;
            transition: all 0.3s ease;
        }

        .atributos-container {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .atributos-coluna {
            width: 48%;
        }

        .vida-magia-vigor {
            display: flex;
            justify-content: space-around;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .vida-magia-vigor div {
            background-color: rgba(255, 255, 255, 0.8);
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #ccc;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            width: 30%;
            min-width: 200px;
            margin-bottom: 10px;
            text-align: center;
        }

        .botoes-container {
            display: flex;
            justify-content: center;
            margin-top: 20px;
        }

        .botao {
            padding: 12px 25px;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            cursor: pointer;
            margin: 0 10px;
            transition: background-color 0.3s ease, transform 0.2s ease;
            font-family: 'MedievalSharp', serif;
            color: white;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
        }

        .botao-reset {
            background-color: #b8860b;
        }

        .botao-reset:hover {
            background-color: #a0522d;
            transform: translateY(-2px);
        }

        .botao-recomecar {
            background-color: #a52a2a;
        }

        .botao-recomecar:hover {
            background-color: #8b0000;
            transform: translateY(-2px);
        }

        .botao-bloquear, .botao-desbloquear {
            background-color: #4a4a4a;
        }

        .botao-bloquear:hover, .botao-desbloquear:hover {
            background-color: #2a2a2a;
            transform: translateY(-2px);
        }

        .botao-excluir {
            background-color: #a52a2a;
            position: absolute;
            bottom: 20px;
            left: 20px;
        }

        .botao-excluir:hover {
            background-color: #8b0000;
            transform: translateY(-2px);
        }

        #nivel-container {
            text-align: center;
            margin: 20px 0;
        }

        #nivel {
            padding: 20px;
            background-color: #f0e6d2;
            border: 3px solid #000000;
            border-radius: 50%;
            width: 80px;
            height: 80px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.5);
        }

        #nivel.aura-azul {
            animation: pulsar-aura 2s infinite;
        }

        @keyframes pulsar-aura {
            0% { box-shadow: 0 0 5px #00BFFF, 0 0 10px #00BFFF, 0 0 15px #00BFFF; }
            50% { box-shadow: 0 0 10px #00BFFF, 0 0 20px #00BFFF, 0 0 30px #00BFFF; }
            100% { box-shadow: 0 0 5px #00BFFF, 0 0 10px #00BFFF, 0 0 15px #00BFFF; }
        }

        #status-container {
            display: flex;
            flex-direction: column;
            width: 300px;
            margin-right: 20px;
        }

        #right-container {
            display: flex;
            flex-direction: column;
            width: 300px;
        }

        .expandable-textarea {
            height: 100px;
            width: 100%;
            background-color: #f8f8f8;
            border: 1px solid #b8860b;
            border-radius: 6px;
            padding: 10px;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .expandable-textarea:focus {
            height: 300px;
            width: 100%;
            background-color: rgba(240, 230, 210, 0.95);
            border: 2px solid #b8860b;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }

        #dice-container {
            margin-top: 20px;
            text-align: center;
        }

        #dice-roll {
            width: 120px;
            height: 120px;
            background-color: #f0e6d2;
            border: 2px solid #b8860b;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            cursor: pointer;
            margin: 0 auto;
            position: relative;
        }

        #dice-result {
            margin-top: 10px;
            font-size: 1rem;
            color: #000000;
            display: none;
            animation: blink 1s infinite;
        }

        #dice-player {
            font-size: 1rem;
            color: #000000;
            margin-bottom: 5px;
        }

        @keyframes blink {
            50% { opacity: 0; }
        }

        #dice-roll.critical-failure {
            animation: aura-vermelha 2s infinite;
        }

        #dice-roll.critical-success {
            animation: aura-verde 2s infinite;
        }

        @keyframes aura-vermelha {
            0% { box-shadow: 0 0 5px #ff0000, 0 0 10px #ff0000; }
            50% { box-shadow: 0 0 15px #ff0000, 0 0 20px #ff0000; }
            100% { box-shadow: 0 0 5px #ff0000, 0 0 10px #ff0000; }
        }

        @keyframes aura-verde {
            0% { box-shadow: 0 0 5px #00ff00, 0 0 10px #00ff00; }
            50% { box-shadow: 0 0 15px #00ff00, 0 0 20px #00ff00; }
            100% { box-shadow: 0 0 5px #00ff00, 0 0 10px #00ff00; }
        }

        #dice-history-btn {
            position: fixed;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background-color: #f0e6d2;
            border: 2px solid #b8860b;
            border-radius: 10px 0 0 10px;
            padding: 15px;
            cursor: pointer;
            font-family: 'MedievalSharp', serif;
            writing-mode: vertical-rl;
            text-align: center;
        }

        #dice-history-panel {
            position: fixed;
            right: -300px;
            top: 0;
            width: 300px;
            height: 100%;
            background-color: rgba(240, 230, 210, 0.95);
            border-left: 2px solid #b8860b;
            padding: 20px;
            transition: right 0.3s ease;
            overflow-y: auto;
        }

        #dice-history-panel.active {
            right: 0;
        }

        .dice-history-entry {
            margin-bottom: 10px;
            padding: 5px;
            border-bottom: 1px solid #b8860b;
        }

        /* Outros estilos mantidos iguais */
    </style>
</head>
<body>
    <div id="fichas-sidebar">
        <div id="add-ficha-btn"><span>+ Fichas</span></div>
    </div>

    <div id="ficha-container">
        <h1 id="nome-personagem-titulo">Ficha de Personagem</h1>
        <div id="titulo-mestre" style="display: none;">Você virou o Game Master</div>

        <div id="ficha-content">
            <div class="text-center mb-4">
                <label for="nome-personagem">Nome do Personagem:</label>
                <input type="text" id="nome-personagem" placeholder="Digite o nome do seu personagem">
            </div>

            <div class="text-center mb-6">
                <label for="descricao-personagem">Descrição do Personagem:</label>
                <textarea id="descricao-personagem" placeholder="Digite a descrição do seu personagem"></textarea>
            </div>

            <div class="vida-magia-vigor">
                <div><label>Pontos de Vida:</label><span id="vida">50</span></div>
                <div><label>Pontos de Magia:</label><span id="magia">20</span></div>
                <div><label>Pontos de Vigor:</label><span id="vigor">10</span></div>
            </div>

            <div class="atributos-container">
                <div class="atributos-coluna">
                    <div><label>Força:</label><input type="number" id="forca" value="0" min="0"></div>
                    <div><label>Destreza:</label><input type="number" id="destreza" value="0" min="0"></div>
                    <div><label>Agilidade:</label><input type="number" id="agilidade" value="0" min="0"></div>
                    <div><label>Constituição:</label><input type="number" id="constituicao" value="0" min="0"></div>
                    <div><label>Inteligência:</label><input type="number" id="inteligencia" value="0" min="0"></div>
                </div>
                <div class="atributos-coluna">
                    <div><label>Ataque:</label><span id="ataque">0</span></div>
                    <div><label>Ataque Mágico:</label><span id="ataque-magico">0</span></div>
                    <div><label>Acerto:</label><span id="acerto">0</span></div>
                    <div><label>Esquiva:</label><span id="esquiva">0</span></div>
                    <div><label>RDF:</label><span id="rdf">0</span></div>
                    <div><label>RDM:</label><span id="rdm">0</span></div>
                </div>
            </div>

            <div class="armamento-container">
                <div class="armamento-coluna">
                    <label>Armamento Mão Direita:</label>
                    <div class="flex items-center mb-2">
                        <input type="text" id="arma-direita-nome" placeholder="Nome da Arma">
                        <span>Ataque </span><input type="number" id="arma-direita-ataque" value="0">
                        <span>Ataque Mágico </span><input type="number" id="arma-direita-ataque-magico" value="0">
                    </div>
                </div>
                <div class="armamento-coluna">
                    <label>Armamento Mão Esquerda:</label>
                    <div class="flex items-center">
                        <input type="text" id="arma-esquerda-nome" placeholder="Nome da Arma">
                        <span>Ataque </span><input type="number" id="arma-esquerda-ataque" value="0">
                        <span>Ataque Mágico </span><input type="number" id="arma-esquerda-ataque-magico" value="0">
                    </div>
                </div>
            </div>

            <div style="display: flex; justify-content: space-between;">
                <div id="status-container">
                    <div><label>Experiência:</label><input type="number" id="experiencia" value="0" min="0"></div>
                    <div><label>Pontos de Habilidade (PD):</label><span id="pontos-habilidade">25</span></div>
                    <div><label>Pontos de Vantagem (PH):</label><span id="pontos-vantagem">5</span></div>
                    <div><label>Inventário:</label><textarea id="inventario" class="expandable-textarea" placeholder="Slots 1-10"></textarea></div>
                </div>

                <div id="right-container">
                    <div><label>Vantagens:</label><textarea id="vantagens" class="expandable-textarea" placeholder="Digite suas vantagens"></textarea></div>
                    <div><label>Desvantagens:</label><textarea id="desvantagens" class="expandable-textarea" placeholder="Digite suas desvantagens"></textarea></div>
                    <div><label>Magias e Habilidades:</label><textarea id="magias-habilidades" class="expandable-textarea" placeholder="Digite as magias e habilidades"></textarea></div>
                    <div id="dice-container">
                        <div id="dice-player"></div>
                        <div id="dice-roll">-</div>
                        <div id="dice-result"></div>
                    </div>
                </div>
            </div>

            <div id="nivel-container">
                <label>Nível:</label>
                <span id="nivel">0</span>
            </div>

            <div class="botoes-container">
                <button id="reset-pontos" class="botao botao-reset">Reiniciar Pontos</button>
                <button id="recomecar" class="botao botao-recomecar">Recomeçar</button>
                <button id="bloquear-ficha" class="botao botao-bloquear">Bloquear Ficha</button>
            </div>

            <button id="excluir-ficha" class="botao botao-excluir">Excluir Ficha</button>
        </div>
    </div>

    <div id="dice-history-btn">Histórico de Dados</div>
    <div id="dice-history-panel">
        <h2>Histórico de Dados</h2>
        <div id="dice-history-content"></div>
    </div>

    <!-- Modals mantidos iguais -->
    <div id="nome-ficha-modal" class="modal">
        <div class="modal-content">
            <h3>Dê um Nome à Ficha</h3>
            <input type="text" id="nome-ficha-input" placeholder="Nome da ficha" maxlength="20">
            <button class="confirm-btn" onclick="criarNovaFicha()">Confirmar</button>
            <button class="cancel-btn" onclick="fecharModal('nome-ficha-modal')">Cancelar</button>
        </div>
    </div>

    <div id="bloquear-ficha-modal" class="modal">
        <div class="modal-content">
            <h3>Ponha sua Senha de 4 Dígitos</h3>
            <input type="password" id="senha-bloqueio-input" placeholder="Senha (4 dígitos)" maxlength="4">
            <button class="confirm-btn" onclick="bloquearFicha()">Confirmar</button>
            <button class="cancel-btn" onclick="fecharModal('bloquear-ficha-modal')">Cancelar</button>
        </div>
    </div>

    <div id="password-modal" class="modal">
        <div class="modal-content">
            <h3>Digite sua Senha</h3>
            <input type="password" id="senha-desbloqueio-input" placeholder="Senha (4 dígitos)" maxlength="4">
            <button class="confirm-btn" onclick="desbloquearFicha()">Confirmar</button>
            <button class="cancel-btn" onclick="fecharModal('password-modal')">Cancelar</button>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "Sua_API_Key",
            authDomain: "Seu_Domain",
            databaseURL: "Seu_Database_URL",
            projectId: "Seu_Project_Id",
            storageBucket: "Seu_Storage_Bucket",
            messagingSenderId: "Seu_Sender_Id",
            appId: "Seu_App_Id"
        };

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        let fichas = {};
        let currentFichaId = null;
        let isFichaLocked = false;
        let fichaPassword = null;
        let isFichaUnlocked = false;
        const senhaMatriz = "777";

        // Elementos DOM
        const nomePersonagemInput = document.getElementById('nome-personagem');
        const descricaoPersonagemInput = document.getElementById('descricao-personagem');
        const forcaInput = document.getElementById('forca');
        const destrezaInput = document.getElementById('destreza');
        const agilidadeInput = document.getElementById('agilidade');
        const inteligenciaInput = document.getElementById('inteligencia');
        const constituicaoInput = document.getElementById('constituicao');
        const ataqueSpan = document.getElementById('ataque');
        const ataqueMagicoSpan = document.getElementById('ataque-magico');
        const acertoSpan = document.getElementById('acerto');
        const esquivaSpan = document.getElementById('esquiva');
        const rdfSpan = document.getElementById('rdf');
        const rdmSpan = document.getElementById('rdm');
        const vidaSpan = document.getElementById('vida');
        const magiaSpan = document.getElementById('magia');
        const vigorSpan = document.getElementById('vigor');
        const armaDireitaNomeInput = document.getElementById('arma-direita-nome');
        const armaDireitaAtaqueInput = document.getElementById('arma-direita-ataque');
        const armaDireitaAtaqueMagicoInput = document.getElementById('arma-direita-ataque-magico');
        const armaEsquerdaNomeInput = document.getElementById('arma-esquerda-nome');
        const armaEsquerdaAtaqueInput = document.getElementById('arma-esquerda-ataque');
        const armaEsquerdaAtaqueMagicoInput = document.getElementById('arma-esquerda-ataque-magico');
        const experienciaInput = document.getElementById('experiencia');
        const nivelSpan = document.getElementById('nivel');
        const pontosHabilidadeSpan = document.getElementById('pontos-habilidade');
        const pontosVantagemSpan = document.getElementById('pontos-vantagem');
        const vantagensInput = document.getElementById('vantagens');
        const desvantagensInput = document.getElementById('desvantagens');
        const magiasHabilidadesInput = document.getElementById('magias-habilidades');
        const inventarioInput = document.getElementById('inventario');
        const diceRoll = document.getElementById('dice-roll');
        const diceResult = document.getElementById('dice-result');
        const dicePlayer = document.getElementById('dice-player');
        const diceHistoryBtn = document.getElementById('dice-history-btn');
        const diceHistoryPanel = document.getElementById('dice-history-panel');
        const diceHistoryContent = document.getElementById('dice-history-content');

        let nivel = 0;
        let nivelAnterior = 0;
        let pontosHabilidadeTotal = 25;
        let pontosHabilidadeUsados = 0;
        let pontosVantagem = 5;
        let experiencia = 0;
        let vidaBase = 50;

        const nivelData = [
            { nivel: 0, xp: 0, pd: 25, ph: 5 },
            { nivel: 1, xp: 10, pd: 31, ph: 6 },
            // ... resto da tabela mantida igual
        ];

        function criarFichaMatriz() {
            const fichaMatrizId = 'ficha-matriz';
            const fichaMatriz = {
                nomeFicha: 'Matriz',
                nomePersonagem: 'Personagem Matriz',
                descricaoPersonagem: 'Ficha original do sistema',
                forca: '0',
                destreza: '0',
                agilidade: '0',
                inteligencia: '0',
                constituicao: '0',
                experiencia: '0',
                armaDireitaNome: '',
                armaDireitaAtaque: '0',
                armaDireitaAtaqueMagico: '0',
                armaEsquerdaNome: '',
                armaEsquerdaAtaque: '0',
                armaEsquerdaAtaqueMagico: '0',
                vantagens: '',
                magiasHabilidades: '',
                desvantagens: '',
                inventario: 'Slots\n1 - \n\n\n2 - \n\n\n3 - \n\n\n4 - \n\n\n5 - \n\n\n6 - \n\n\n7 - \n\n\n8 - \n\n\n9 - \n\n\n10 - \n\n',
                isLocked: true,
                password: senhaMatriz
            };

            database.ref('fichas/ficha-matriz').once('value', (snapshot) => {
                if (!snapshot.exists()) {
                    database.ref(`fichas/${fichaMatrizId}`).set(fichaMatriz).then(() => {
                        currentFichaId = fichaMatrizId;
                        carregarFicha(fichaMatrizId);
                    });
                } else {
                    currentFichaId = fichaMatrizId;
                    carregarFicha(fichaMatrizId);
                    carregarFichas();
                }
            });
        }

        function carregarFichas() {
            database.ref('fichas').on('value', (snapshot) => {
                fichas = snapshot.val() || {};
                if (!fichas['ficha-matriz']) {
                    criarFichaMatriz();
                } else {
                    atualizarAbasFichas();
                }
            });
        }

        function atualizarAbasFichas() {
            // Mantido igual
        }

        function carregarFicha(fichaId) {
            if (!fichas[fichaId]) return;

            const ficha = fichas[fichaId];
            nomePersonagemInput.value = ficha.nomePersonagem || '';
            descricaoPersonagemInput.value = ficha.descricaoPersonagem || '';
            forcaInput.value = ficha.forca || '0';
            destrezaInput.value = ficha.destreza || '0';
            agilidadeInput.value = ficha.agilidade || '0';
            inteligenciaInput.value = ficha.inteligencia || '0';
            constituicaoInput.value = ficha.constituicao || '0';
            experienciaInput.value = ficha.experiencia || '0';
            armaDireitaNomeInput.value = ficha.armaDireitaNome || '';
            armaDireitaAtaqueInput.value = ficha.armaDireitaAtaque || '0';
            armaDireitaAtaqueMagicoInput.value = ficha.armaDireitaAtaqueMagico || '0';
            armaEsquerdaNomeInput.value = ficha.armaEsquerdaNome || '';
            armaEsquerdaAtaqueInput.value = ficha.armaEsquerdaAtaque || '0';
            armaEsquerdaAtaqueMagicoInput.value = ficha.armaEsquerdaAtaqueMagico || '0';
            vantagensInput.value = ficha.vantagens || '';
            magiasHabilidadesInput.value = ficha.magiasHabilidades || '';
            desvantagensInput.value = ficha.desvantagens || '';
            inventarioInput.value = ficha.inventario || 'Slots\n1 - \n\n\n2 - \n\n\n3 - \n\n\n4 - \n\n\n5 - \n\n\n6 - \n\n\n7 - \n\n\n8 - \n\n\n9 - \n\n\n10 - \n\n';
            isFichaLocked = ficha.isLocked || false;
            fichaPassword = ficha.password || null;
            isFichaUnlocked = false;

            atualizarBotaoBloquear();
            experiencia = parseInt(experienciaInput.value) || 0;
            atualizarNivel();
            calcularAtributos();
        }

        function salvarDados() {
            // Mantido igual
        }

        function calcularNivel(xp) {
            // Mantido igual
        }

        function atualizarNivel() {
            nivelAnterior = nivel;
            nivel = calcularNivel(experiencia);
            nivelSpan.textContent = nivel;
            pontosHabilidadeTotal = nivelData[nivel].pd;
            pontosVantagem = nivelData[nivel].ph;
            pontosVantagemSpan.textContent = pontosVantagem;

            if (nivel > nivelAnterior) {
                nivelSpan.classList.add('aura-azul');
            }

            calcularAtributos();
            // Mantido igual para título mestre
        }

        function calcularAtributos() {
            // Mantido igual
        }

        function rollDice() {
            const result = Math.floor(Math.random() * 20) + 1;
            const playerName = fichas[currentFichaId].nomeFicha || 'Desconhecido';
            dicePlayer.textContent = `${playerName} rolou:`;
            diceRoll.textContent = result;
            diceRoll.classList.remove('critical-failure', 'critical-success');
            diceResult.style.display = 'none';

            const diceData = {
                player: playerName,
                result: result,
                timestamp: Date.now()
            };

            database.ref('dice_rolls').push(diceData);

            if (result === 1) {
                diceRoll.classList.add('critical-failure');
                diceResult.textContent = 'FALHA CRÍTICA!';
                diceResult.style.display = 'block';
                setTimeout(() => {
                    diceRoll.classList.remove('critical-failure');
                    diceResult.style.display = 'none';
                    dicePlayer.textContent = '';
                    diceRoll.textContent = '-';
                }, 5000);
            } else if (result === 20) {
                diceRoll.classList.add('critical-success');
                diceResult.textContent = 'ACERTO CRÍTICO!';
                diceResult.style.display = 'block';
                setTimeout(() => {
                    diceRoll.classList.remove('critical-success');
                    diceResult.style.display = 'none';
                    dicePlayer.textContent = '';
                    diceRoll.textContent = '-';
                }, 5000);
            } else {
                setTimeout(() => {
                    dicePlayer.textContent = '';
                    diceRoll.textContent = '-';
                }, 3000);
            }

            updateDiceHistory(diceData);
        }

        database.ref('dice_rolls').on('child_added', (snapshot) => {
            const diceData = snapshot.val();
            const currentTime = Date.now();
            if (currentTime - diceData.timestamp < 5000) {
                dicePlayer.textContent = `${diceData.player} rolou:`;
                diceRoll.textContent = diceData.result;
                diceRoll.classList.remove('critical-failure', 'critical-success');
                diceResult.style.display = 'none';

                if (diceData.result === 1) {
                    diceRoll.classList.add('critical-failure');
                    diceResult.textContent = 'FALHA CRÍTICA!';
                    diceResult.style.display = 'block';
                    setTimeout(() => {
                        diceRoll.classList.remove('critical-failure');
                        diceResult.style.display = 'none';
                        dicePlayer.textContent = '';
                        diceRoll.textContent = '-';
                    }, 5000);
                } else if (diceData.result === 20) {
                    diceRoll.classList.add('critical-success');
                    diceResult.textContent = 'ACERTO CRÍTICO!';
                    diceResult.style.display = 'block';
                    setTimeout(() => {
                        diceRoll.classList.remove('critical-success');
                        diceResult.style.display = 'none';
                        dicePlayer.textContent = '';
                        diceRoll.textContent = '-';
                    }, 5000);
                } else {
                    setTimeout(() => {
                        dicePlayer.textContent = '';
                        diceRoll.textContent = '-';
                    }, 3000);
                }
            }
            updateDiceHistory(diceData);
        });

        function updateDiceHistory(diceData) {
            const entry = document.createElement('div');
            entry.className = 'dice-history-entry';
            entry.textContent = `${diceData.player}: ${diceData.result} (${new Date(diceData.timestamp).toLocaleTimeString()})`;
            diceHistoryContent.insertBefore(entry, diceHistoryContent.firstChild);
        }

        diceHistoryBtn.addEventListener('click', () => {
            diceHistoryPanel.classList.toggle('active');
        });

        // Eventos mantidos iguais
        nomePersonagemInput.addEventListener('input', salvarDados);
        descricaoPersonagemInput.addEventListener('input', salvarDados);
        forcaInput.addEventListener('input', () => { calcularAtributos(); salvarDados(); });
        destrezaInput.addEventListener('input', () => { calcularAtributos(); salvarDados(); });
        agilidadeInput.addEventListener('input', () => { calcularAtributos(); salvarDados(); });
        inteligenciaInput.addEventListener('input', () => { calcularAtributos(); salvarDados(); });
        constituicaoInput.addEventListener('input', () => { calcularAtributos(); salvarDados(); });
        experienciaInput.addEventListener('input', () => {
            experiencia = parseInt(experienciaInput.value) || 0;
            atualizarNivel();
            calcularAtributos();
            salvarDados();
        });
        armaDireitaNomeInput.addEventListener('input', salvarDados);
        armaDireitaAtaqueInput.addEventListener('input', () => { calcularAtributos(); salvarDados(); });
        armaDireitaAtaqueMagicoInput.addEventListener('input', () => { calcularAtributos(); salvarDados(); });
        armaEsquerdaNomeInput.addEventListener('input', salvarDados);
        armaEsquerdaAtaqueInput.addEventListener('input', () => { calcularAtributos(); salvarDados(); });
        armaEsquerdaAtaqueMagicoInput.addEventListener('input', () => { calcularAtributos(); salvarDados(); });
        vantagensInput.addEventListener('input', salvarDados);
        desvantagensInput.addEventListener('input', salvarDados);
        magiasHabilidadesInput.addEventListener('input', salvarDados);
        inventarioInput.addEventListener('input', salvarDados);
        diceRoll.addEventListener('click', rollDice);

        criarFichaMatriz();
    </script>
</body>
</html>
