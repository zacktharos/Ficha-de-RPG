    // Alteração: senha matriz atualizada para "1040"
    let fichas = {}, currentFichaId = null, isFichaLocked = false, fichaPassword = null, isFichaUnlocked = false, senhaMatriz = "1040",
        vantagensSelecionadas = [], desvantagensSelecionadas = [], tempVantagensSelecionadas = [], tempDesvantagensSelecionadas = [];

    // Dados para vantagens e desvantagens (mantidos do código original)
    const vantagensData = [
        { nome: "Maestria com Armas curtas (2)", custo: 2, descricao: "Adiciona +1 em ataque, +1 em acerto com armas curtas." },
        // ... demais vantagens ...
    ], 
    desvantagensData = [
        { nome: "Fobia (+2)", ganho: 2, descricao: "Você tem um medo irracional de algo específico." },
        // ... demais desvantagens ...
    ];

    // Função para criar a ficha matriz
    function criarFichaMatriz() {
        const fichaId = "ficha-matriz";
        const fichaMatriz = { 
            nomeFicha: "Matriz", 
            nomePersonagem: "Personagem Matriz", 
            descricaoPersonagem: "Ficha original do sistema", 
            forca: "0", 
            destreza: "0", 
            agilidade: "0", 
            inteligencia: "0", 
            constituicao: "0", 
            experiencia: "0", 
            armaDireitaNome: "", 
            armaDireitaAtaque: "0", 
            armaDireitaAtaqueMagico: "0", 
            armaEsquerdaNome: "", 
            armaEsquerdaAtaque: "0", 
            armaEsquerdaAtaqueMagico: "0", 
            vantagens: "", 
            magiasHabilidades: "", 
            desvantagens: "", 
            inventario: Array(10).fill({ item: "", peso: "0" }), 
            velocidadeCorrida: "25", 
            alturaPulo: "1", 
            distanciaPulo: "3", 
            isLocked: true, 
            password: senhaMatriz, 
            imagem: null, 
            anotacoes: "", 
            classeNome: "", 
            classeDescricao: "", 
            racaNome: "", 
            racaDescricao: "" 
        };
        database.ref("fichas/ficha-matriz").once("value", snapshot => {
            if (snapshot.exists()) { 
                currentFichaId = fichaId; 
                carregarFicha(fichaId); 
                carregarFichas(); 
            } else { 
                database.ref(`fichas/${fichaId}`).set(fichaMatriz).then(() => { 
                    currentFichaId = fichaId; 
                    carregarFicha(fichaId); 
                });
            }
        });
    }

    // Função para carregar todas as fichas
    function carregarFichas() { 
        database.ref("fichas").on("value", snapshot => { 
            fichas = snapshot.val() || {}; 
            if (fichas["ficha-matriz"]) { 
                atualizarAbasFichas(); 
            } else { 
                criarFichaMatriz(); 
            } 
        });
    }

    // Atualiza as abas (tabs) de fichas na barra lateral
    function atualizarAbasFichas() {
        const sidebar = document.getElementById("fichas-sidebar");
        const addBtn = document.getElementById("add-ficha-btn");
        while (sidebar.children.length > 1) { 
            sidebar.removeChild(sidebar.children[0]); 
        }
        for (let fichaId in fichas) {
            if (fichaId !== "ficha-matriz") {
                const tab = document.createElement("div"); 
                tab.className = "ficha-tab";
                const span = document.createElement("span"); 
                span.textContent = fichas[fichaId].nomeFicha || "Sem Nome"; 
                tab.appendChild(span);
                tab.dataset.fichaId = fichaId; 
                if (fichaId === currentFichaId) tab.classList.add("active");
                tab.onclick = () => { 
                    currentFichaId = fichaId; 
                    carregarFicha(fichaId); 
                    atualizarAbasFichas(); 
                };
                sidebar.insertBefore(tab, addBtn);
            }
        }
    }

    document.getElementById("add-ficha-btn").onclick = () => { 
        document.getElementById("nome-ficha-modal").style.display = "flex"; 
        document.getElementById("nome-ficha-input").value = ""; 
        document.getElementById("nome-ficha-input").focus(); 
    };

    function criarNovaFicha() {
        const nomeFicha = document.getElementById("nome-ficha-input").value.trim();
        if (!nomeFicha) return alert("Por favor, dê um nome à ficha!");
        const novaFichaId = database.ref("fichas").push().key;
        const novaFicha = { 
            nomeFicha, 
            nomePersonagem: "", 
            descricaoPersonagem: "", 
            forca: "0", 
            destreza: "0", 
            agilidade: "0", 
            inteligencia: "0", 
            constituicao: "0", 
            experiencia: "0", 
            armaDireitaNome: "", 
            armaDireitaAtaque: "0", 
            armaDireitaAtaqueMagico: "0", 
            armaEsquerdaNome: "", 
            armaEsquerdaAtaque: "0", 
            armaEsquerdaAtaqueMagico: "0", 
            vantagens: "", 
            magiasHabilidades: Array(10).fill("").join("\n"), 
            desvantagens: "", 
            inventario: Array(10).fill({ item: "", peso: "0" }), 
            velocidadeCorrida: "25", 
            alturaPulo: "1", 
            distanciaPulo: "3", 
            isLocked: false, 
            password: null, 
            imagem: null, 
            anotacoes: "", 
            classeNome: "", 
            classeDescricao: "", 
            racaNome: "", 
            racaDescricao: "" 
        };
        database.ref(`fichas/${novaFichaId}`).set(novaFicha).then(() => { 
            currentFichaId = novaFichaId; 
            carregarFicha(novaFichaId); 
            fecharModal("nome-ficha-modal"); 
            atualizarAbasFichas(); 
        }).catch(error => console.error("Erro ao criar nova ficha:", error));
    }

    function fecharModal(modalId) { 
        document.getElementById(modalId).style.display = "none"; 
    }

    // Função para carregar os dados de uma ficha
    function carregarFicha(fichaId) {
        if (!fichas[fichaId]) return;
        const ficha = fichas[fichaId];
        // Atualiza os inputs e campos da ficha com os dados do Firebase
        document.getElementById("nome-personagem").value = ficha.nomePersonagem || "";
        document.getElementById("descricao-personagem").value = ficha.descricaoPersonagem || "";
        // (Atualize os demais campos conforme necessário...)
        // Exemplo: atualizar atributos, inventário, magias, anotações, imagem, etc.
    }

    // EVENTOS DO DADO
    const diceRollElement = document.getElementById("dice-roll"),
          diceResultElement = document.getElementById("dice-result"),
          notificationElement = document.getElementById("notification");

    // Quando o dado for clicado, gera um número aleatório e atualiza o Firebase
    diceRollElement.addEventListener("click", function(){
        const roll = Math.floor(Math.random() * 6) + 1;
        // Obtém o nome da ficha atual (ou utiliza o ID se não houver nome definido)
        const fichaNome = (fichas[currentFichaId] && fichas[currentFichaId].nomeFicha) || currentFichaId;
        // Atualiza o nó "diceRoll" no Firebase com o resultado e o nome da ficha que rolou o dado
        database.ref("diceRoll").set({ ficha: fichaNome, roll: roll, timestamp: Date.now() });
        // Exibe o resultado localmente na ficha atual (opcional)
        diceResultElement.textContent = roll;
        diceResultElement.style.display = "block";
        setTimeout(() => { 
            diceResultElement.style.display = "none"; 
        }, 2000);
    });

    // Listener para mostrar o resultado do dado em tempo real em todas as fichas
    database.ref("diceRoll").on("value", snapshot => {
        const data = snapshot.val();
        if (data) {
            notificationElement.textContent = data.ficha + " rolou: " + data.roll;
            notificationElement.style.display = "block";
            setTimeout(() => { 
                notificationElement.style.display = "none"; 
            }, 3000);
        }
    });

    // (Demais funções para atualizar atributos, inventário, magias, etc., permanecem conforme o código original)
    
    // Inicializa o carregamento das fichas
    carregarFichas();
</script>
