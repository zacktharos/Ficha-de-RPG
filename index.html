<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ficha de Personagem RPG</title>
    <link href="https://fonts.googleapis.com/css2?family=MedievalSharp&family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@tailwindcss/browser@4"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0e6d2; /* Cor de pergaminho padrão */
            color: #000;
            display: flex;
            flex-direction: column; /* Ensure content flows correctly */
            align-items: center; /* Center content horizontally */
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box; /* Include padding in width/height */
            background-image: none;
            background-size: cover;
            background-position: center;
            transition: background 0.3s, color 0.3s;
        }
        body.dark-mode {
            background-color: #121212 !important; /* Garante que o fundo seja sempre escuro */
            color: #e0e0e0;
        }
        #chat-btn-container { position: fixed; left: 10px; top: calc(50% - 120px); z-index: 1000; }
        #chat-btn {
            padding: 15px; background: #f0e6d2; border: 2px solid #b8860b; border-radius: 8px;
            font-family: 'MedievalSharp', serif; font-size: 1.2rem; color: #000; cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 3px 3px 7px rgba(0, 0, 0, 0.3); z-index: 1000;
        }
        #chat-btn:hover { background: #a0522d; transform: translateY(-3px); }
        #chat-btn::after {
            content: attr(data-unread); position: absolute; top: -10px; right: -10px;
            background-color: red; color: white; border-radius: 50%; padding: 5px;
            font-size: 0.8rem; min-width: 20px; text-align: center; display: none;
        }
        #chat-btn[data-unread]:after { display: block; }
        body.dark-mode #chat-btn { background: #1e1e1e; color: #e0e0e0; border-color: #444; }
        body.dark-mode #chat-btn:hover { background: #333; }
        #fichas-sidebar {
            width: 100%; height: 60px; padding: 0 10px; box-sizing: border-box; /* Add padding */
            display: flex; flex-direction: row; align-items: center; justify-content: flex-start;
            position: fixed; top: 0; left: 0; z-index: 1000; overflow-x: auto; background: transparent;
            /* Add subtle shadow to indicate scrollable */
             box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
         /* Scrollbar styling (optional) */
        #fichas-sidebar::-webkit-scrollbar { height: 6px; }
        #fichas-sidebar::-webkit-scrollbar-thumb { background: #b8860b; border-radius: 3px; }
        #fichas-sidebar::-webkit-scrollbar-track { background: rgba(0,0,0,0.05); }

        .ficha-tab {
            visibility: visible; width: 100px; height: 50px; background: #f0e6d2; flex-shrink: 0; /* Prevent shrinking */
            border: 2px solid #b8860b; border-radius: 10px 10px 0 0; margin-right: 10px;
            display: flex; align-items: center; justify-content: center; cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.2);
        }
        .ficha-tab:hover, .ficha-tab.active { background: #a0522d; transform: translateY(-5px); }
        .ficha-tab span {
            font-family: 'MedievalSharp', serif; color: #000; font-size: 0.9rem; text-align: center;
            max-width: 90px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
        }
        #add-ficha-btn {
            width: 100px; height: 50px; background: #f0e6d2; border: 2px solid #b8860b; flex-shrink: 0;
            border-radius: 10px 10px 0 0; margin-right: 10px; display: flex; align-items: center;
            justify-content: center; cursor: pointer; transition: transform 0.2s ease;
            box-shadow: 0 0 10px #ffd700, 0 0 20px #ffd700; z-index: 1001;
        }
        #add-ficha-btn span { font-family: 'MedievalSharp', serif; color: #000; font-size: 0.9rem; }
        #add-ficha-btn:hover { background: #a0522d; transform: translateY(-5px); }
        #ficha-container {
            background: rgba(240, 230, 210, 0.95); padding: 30px; border-radius: 12px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2); width: 95%; max-width: 1200px;
            margin: 80px auto 20px; border: 2px solid #b8860b; position: relative; z-index: 1; box-sizing: border-box;
        }
        body.dark-mode #ficha-container { background: rgba(30, 30, 30, 0.95); color: #e0e0e0; }
        #ficha-container.aura-azul { box-shadow: 0 0 30px 15px #00BFFF; animation: pulsar-aura 2s infinite; }
        @keyframes pulsar-aura { 0% { box-shadow: 0 0 20px #00BFFF, 0 0 30px #00BFFF, 0 0 40px #00BFFF; } 50% { box-shadow: 0 0 30px #00BFFF, 0 0 50px #00BFFF, 0 0 60px #00BFFF; } 100% { box-shadow: 0 0 20px #00BFFF, 0 0 30px #00BFFF, 0 0 40px #00BFFF; } }
        h1#nome-personagem-titulo {
            font-family: 'MedievalSharp', serif; color: #1C2526; font-size: 3rem; margin-bottom: 20px;
            text-align: center; text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1); animation: raios 2s infinite linear;
        }
        @keyframes raios { 0% { text-shadow: 0 0 5px #FFD700, 0 0 10px #FFD700, 0 0 15px #FFD700, 0 0 20px #FF4500; } 50% { text-shadow: 0 0 10px #FFD700, 0 0 15px #FFD700, 0 0 20px #FF4500, 0 0 25px #FF4500; } 100% { text-shadow: 0 0 5px #FFD700, 0 0 10px #FFD700, 0 0 15px #FFD700, 0 0 20px #FF4500; } }
        #game-master-message { display: none; color: blue; font-size: 1.5rem; text-align: center; font-family: 'MedievalSharp', serif; margin-bottom: 10px; }
        section { background: #f0e6d2; border: 2px solid #b8860b; border-radius: 8px; padding: 15px; margin-bottom: 20px; }
        section h2 { text-align: center; }
        body.dark-mode section { background: #1e1e1e; border-color: #444; }
        label { font-weight: 600; color: #000; margin-bottom: 8px; display: block; }
        body.dark-mode label { color: #e0e0e0; }
        input[type="text"], input[type="number"], textarea {
            padding: 10px; border: 2px solid #b8860b; border-radius: 6px; width: 100%; /* Use full width */
            box-sizing: border-box; /* Include padding/border in width */
            margin-bottom: 15px; font-size: 1rem; transition: border-color 0.3s ease;
            background: #fff; color: #000;
        }
        body.dark-mode input[type="text"], body.dark-mode input[type="number"], body.dark-mode textarea { background: #333; color: #e0e0e0; border-color: #555; }
        input[type="text"]:focus, input[type="number"]:focus, textarea:focus { border-color: #a0522d; outline: none; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1); }
        input[readonly], span[readonly] { background: #e8e8e8; border: 1px solid #ccc; cursor: not-allowed; }
        body.dark-mode input[readonly], body.dark-mode span[readonly] { background: #444; border-color: #666; }
        textarea { resize: vertical; }
        .atributos-container { display: flex; justify-content: space-between; gap: 20px; flex-wrap: wrap; /* Allow wrapping on small screens */ }
        .atributos-coluna, .atributos-coluna-destaque { width: 100%; /* Default full width for mobile */ display: flex; flex-direction: column; align-items: flex-start; }
        @media (min-width: 769px) { /* Apply side-by-side only on larger screens */
             .atributos-coluna, .atributos-coluna-destaque { width: 48%; }
        }
        .atributos-coluna-destaque { background: #fff; padding: 10px; border-radius: 6px; border: 1px solid #b8860b; margin-top: 10px; } /* Add margin-top for spacing when stacked */
         @media (min-width: 769px) { .atributos-coluna-destaque { margin-top: 0; } } /* Remove margin on larger screens */
        body.dark-mode .atributos-coluna-destaque { background: #333; border-color: #555; }
        .atributo-destaque { padding: 8px; margin-bottom: 10px; display: flex; align-items: center; justify-content: space-between; width: 100%; }
        .atributo-destaque label { font-size: 1.1rem; font-weight: 700; color: #a0522d; margin-bottom: 0; } /* Remove bottom margin for label */
        .atributo-destaque span { font-size: 1.2rem; font-family: 'MedievalSharp', serif; color: #000; margin-left: 10px; } /* Add margin to separate from label */
        body.dark-mode .atributo-destaque span { color: #e0e0e0; }
        .atributo-fogo { animation: fogo 1.5s infinite; }
        @keyframes fogo { 0% { text-shadow: 0 0 5px #ff4500, 0 0 10px #ff4500; } 50% { text-shadow: 0 0 10px #ff4500, 0 0 15px #ffd700; } 100% { text-shadow: 0 0 5px #ff4500, 0 0 10px #ff4500; } }
        .vida-magia-vigor { display: flex; justify-content: space-around; gap: 15px; flex-wrap: wrap; }
        .atributo-container {
            background: rgba(255, 255, 255, 0.8); padding: 12px; border-radius: 8px; border: 1px solid #b8860b;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); width: 100%; /* Mobile first: full width */ min-width: 180px; text-align: center; flex-grow: 1; /* Allow growing */
        }
        @media (min-width: 600px) { .atributo-container { width: 45%; /* Two columns on medium screens */ } }
        @media (min-width: 900px) { .atributo-container { width: 30%; /* Three columns on larger screens */ } }
        body.dark-mode .atributo-container { background: rgba(50, 50, 50, 0.8); }
        .atributo-container::before { font-size: 1.5rem; margin-bottom: 5px; display: block; }
        .atributo-container.vida::before { content: "❤️"; } .atributo-container.magia::before { content: "✨"; } .atributo-container.vigor::before { content: "⚡"; }
        .medieval-box { background: #f0e6d2; border: 2px solid #b8860b; border-radius: 8px; padding: 10px; margin: 5px 0; text-align: center; }
        body.dark-mode .medieval-box { background: #1e1e1e; border-color: #444; }
        .regeneracao { font-size: 0.8rem; color: #555; margin-top: 5px; }
        body.dark-mode .regeneracao { color: #aaa; }
        button {
            background: #b8860b; color: #fff; border: none; padding: 5px 10px;
            cursor: pointer; font-size: 1.2rem; border-radius: 4px; margin: 0 5px;
            transition: background-color 0.3s ease;
        }
        body.dark-mode button { background: #555; }
        button:hover { background: #a0522d; }
        body.dark-mode button:hover { background: #777; }
        .botoes-container { display: flex; justify-content: center; gap: 10px; margin-top: 20px; margin-bottom: 10px; flex-wrap: wrap; /* Allow wrapping */ }
        .theme-color-container { display: flex; justify-content: center; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .botao {
            padding: 12px 25px; border: none; border-radius: 6px; font-size: 1rem; cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease; font-family: 'MedievalSharp', serif;
            color: #fff; text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3); flex-shrink: 0; /* Prevent shrinking */
        }
        body.dark-mode .botao { background: #555; }
        body.dark-mode .botao:hover { background: #777; }
        #reset-pontos, #recomecar, #bloquear-ficha, #plano-fundo-btn, #excluir-ficha { background-color: #800000; }
        .botao-reset:hover, .botao-recomecar:hover, .botao-bloquear:hover, .botao-desbloquear:hover, #excluir-ficha:hover { background: #a0522d; transform: translateY(-2px); }
        .icon-btn { padding: 10px; width: 44px; height: 44px; font-size: 1.2rem; line-height: 1; text-align: center; }
        #lua-btn { background-color: #333; color: #eee; }
        #sol-btn { background-color: #ffdd00; color: #333; }
        #cor-fundo-btn { background-color: #800000; }
        #cor-fundo-btn-wrapper { line-height: 1; vertical-align: middle; position: relative; } /* Added position relative */
        #nivel-container { text-align: center; margin-top: 10px; }
        #nivel { padding: 10px; background: #f0e6d2; border: 3px solid #000; border-radius: 50%; width: 100px; height: 100px; display: flex; align-items: center; justify-content: center; font-size: 3.125rem; box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.5); margin: 0 auto; }
        body.dark-mode #nivel { background: #1e1e1e; border-color: #444; }
        #nivel.aura-azul { animation: pulsar-aura 2s 10; }
        .expandable-textarea { height: 100px; width: 100%; background: #fff; border: 2px solid #b8860b; border-radius: 6px; padding: 10px; font-size: 0.9rem; transition: height 0.3s ease; box-sizing: border-box; }
        body.dark-mode .expandable-textarea { background: #333; }
        .expandable-textarea:focus { height: 15cm; }
        #dice-container { position: absolute; top: 20px; right: 20px; width: 200px; text-align: center; font-family: 'MedievalSharp', serif; cursor: move; z-index: 10; user-select: none; }
        #dice-container label { font-size: 1.2rem; color: #000; display: flex; align-items: center; justify-content: center; margin-bottom: 10px; }
        body.dark-mode #dice-container label { color: #e0e0e0; }
        #dice-container label::before { content: "🎲"; margin-right: 5px; font-size: 1.5rem; }
        #dice-roll { width: 100px; height: 100px; background: #f0e6d2; border: 2px solid #b8860b; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 2rem; cursor: pointer; margin: 0 auto; position: relative; transition: all 0.3s ease; }
        body.dark-mode #dice-roll { background: #1e1e1e; border-color: #444; }
        #dice-roll::before { content: "⚅"; font-size: 1.5rem; position: absolute; top: 5px; right: 5px; color: #a0522d; }
        #dice-result { margin-top: 10px; font-size: 1rem; color: #000; display: none; animation: blink 1s infinite; }
        body.dark-mode #dice-result { color: #e0e0e0; }
        @keyframes blink { 50% { opacity: 0; } }
        #dice-roll.critical-failure { animation: aura-vermelha 2s infinite; }
        #dice-roll.critical-success { animation: aura-verde 2s infinite; }
        @keyframes aura-vermelha { 0% { box-shadow: 0 0 5px #ff0000, 0 0 10px #ff0000; } 50% { box-shadow: 0 0 15px #ff0000, 0 0 20px #ff0000; } 100% { box-shadow: 0 0 5px #ff0000, 0 0 10px #ff0000; } }
        @keyframes aura-verde { 0% { box-shadow: 0 0 5px #00ff00, 0 0 10px #00ff00; } 50% { box-shadow: 0 0 15px #00ff00, 0 0 20px #00ff00; } 100% { box-shadow: 0 0 5px #00ff00, 0 0 10px #00ff00; } }
        #notification { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); padding: 20px; border-radius: 8px; font-family: 'MedievalSharp', serif; font-size: 1.5rem; color: #fff; text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5); display: none; z-index: 100; background: rgba(0, 0, 0, 0.7); transition: opacity 0.3s ease; }
        #notification.critical-failure { background: rgba(255, 0, 0, 0.8); animation: aura-vermelha 2s infinite; }
        #notification.critical-success { background: rgba(0, 255, 0, 0.8); animation: aura-verde 2s infinite; }
        #notification.normal-result, #notification.save-success { animation: blink 1s infinite; }
        #notification.save-success { background: rgba(0, 200, 0, 0.8); }
        #character-image-container { position: absolute; top: 10px; left: 10px; width: 100px; height: 100px; background: #f0e6d2; border: 2px solid #b8860b; border-radius: 8px; display: flex; align-items: center; justify-content: center; cursor: pointer; overflow: hidden; z-index: 10; }
        body.dark-mode #character-image-container { background: #1e1e1e; }
        #character-image { width: 100%; height: 100%; object-fit: cover; display: none; }
        #character-image-container:hover { box-shadow: 0 0 10px #ffd700; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: #f0e6d2; padding: 20px; border-radius: 8px; border: 2px solid #b8860b; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3); width: 300px; text-align: center; box-sizing: border-box; }
        body.dark-mode .modal-content { background: #1e1e1e; border-color: #444; }
        .modal-content h3 { font-family: 'MedievalSharp', serif; color: #000; margin-bottom: 15px; }
        body.dark-mode .modal-content h3 { color: #e0e0e0; }
        .modal-content input { width: calc(100% - 20px); padding: 10px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 6px; }
        body.dark-mode .modal-content input { background: #333; color: #e0e0e0; border-color: #555; }
        .modal-content button { padding: 10px 20px; border: none; border-radius: 6px; font-family: 'MedievalSharp', serif; color: #fff; cursor: pointer; margin: 0 5px; }
        .modal-content .confirm-btn { background: #b8860b; } .modal-content .confirm-btn:hover { background: #a0522d; }
        .modal-content .cancel-btn { background: #a52a2a; } .modal-content .cancel-btn:hover { background: #8b0000; }
        #vantagens-desvantagens-btn, #racas-btn, #classes-btn { padding: 10px 20px; background: #f0e6d2; border: 2px solid #b8860b; border-radius: 6px; font-family: 'MedievalSharp', serif; font-size: 1rem; color: #000; cursor: pointer; transition: background-color 0.3s ease; z-index: 10; }
        body.dark-mode #vantagens-desvantagens-btn, body.dark-mode #racas-btn, body.dark-mode #classes-btn { background: #1e1e1e; color: #e0e0e0; }
        #vantagens-desvantagens-btn:hover, #racas-btn:hover, #classes-btn:hover { background: #a0522d; color: #fff; }
        #vantagens-desvantagens-panel, #racas-panel, #classes-panel { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(240, 230, 210, 0.95); padding: 20px; box-sizing: border-box; overflow-y: auto; z-index: 999; border: 2px solid #b8860b; box-shadow: 0 0 20px rgba(0, 0, 0, 0.3); }
        body.dark-mode #vantagens-desvantagens-panel, body.dark-mode #racas-panel, body.dark-mode #classes-panel { background: rgba(30, 30, 30, 0.95); }
        #vantagens-desvantagens-panel h2, #racas-panel h2, #classes-panel h2 { font-family: 'MedievalSharp', serif; font-size: 2rem; text-align: center; color: #a0522d; margin-bottom: 20px; }
        #racas-panel h2 { font-size: 3rem; }
        .vantagem-item, .desvantagem-item, .raca-item { padding: 10px; margin: 5px 0; background: #fff; border: 1px solid #ccc; border-radius: 6px; cursor: pointer; transition: background-color 0.3s ease; }
        body.dark-mode .vantagem-item, body.dark-mode .desvantagem-item, body.dark-mode .raca-item { background: #333; border-color: #555; }
        .vantagem-item:hover, .desvantagem-item:hover, .raca-item:hover { background: #f0e6d2; }
        body.dark-mode .vantagem-item:hover, body.dark-mode .desvantagem-item:hover, body.dark-mode .raca-item:hover { background: #444; }
        .vantagem-item.comprada, .raca-item.comprada { background: #ffcccc; color: #f00; cursor: default; }
        .desvantagem-item.comprada { background: #ccffcc; color: #080; cursor: default; }
        #salvar-vantagens-btn, #salvar-racas-btn, #fechar-pagina-btn, #fechar-racas-btn, #fechar-classes-btn { position: fixed; bottom: 20px; padding: 12px 25px; background: #a52a2a; color: #fff; border: none; border-radius: 6px; font-family: 'MedievalSharp', serif; font-size: 1.2rem; cursor: pointer; transition: transform 0.2s ease; }
        #salvar-vantagens-btn, #salvar-racas-btn { right: 250px; animation: aura-verde-btn 2s infinite; display: none; background: #000; }
        #fechar-pagina-btn, #fechar-racas-btn, #fechar-classes-btn { right: 20px; }
        #salvar-vantagens-btn:hover, #salvar-racas-btn:hover, #fechar-pagina-btn:hover, #fechar-racas-btn:hover, #fechar-classes-btn:hover { transform: translateY(-2px); }
        @keyframes aura-verde-btn { 0% { box-shadow: 0 0 5px #00ff00, 0 0 10px #00ff00; } 50% { box-shadow: 0 0 15px #00ff00, 0 0 20px #00ff00; } 100% { box-shadow: 0 0 5px #00ff00, 0 0 10px #00ff00; } }
        .locomotion-container { background: #8B4513; border: 3px solid #FFD700; border-radius: 10px; padding: 15px; color: #FFD700; font-family: 'MedievalSharp', serif; }
        .locomotion-item { display: flex; align-items: center; margin-bottom: 10px; flex-wrap: wrap; } /* Allow wrap */
        .locomotion-item label { font-weight: bold; color: #FFD700; margin-right: 5px;}
        .locomotion-item span { font-size: 1.2rem; color: #FFF; text-shadow: 1px 1px 2px #000; margin-left: 5px; font-weight: bold; }
        #distancia-pulo, #altura-pulo, #velocidade-corrida { background-color: #8B4513; border-color: #8B4513; }
        .list-display { background: #fff; border: 2px solid #b8860b; border-radius: 6px; padding: 10px; min-height: 100px; max-height: 200px; overflow-y: auto; }
        body.dark-mode .list-display { background: #333; border-color: #555; }
        .list-item { cursor: pointer; margin-bottom: 5px; padding: 5px; border-bottom: 1px solid #ccc; }
        body.dark-mode .list-item { border-color: #555; }
        .list-item:hover { background: #e0e0e0; }
        body.dark-mode .list-item:hover { background: #444; }
        .inventory-slot { display: flex; align-items: center; margin-bottom: 10px; flex-wrap: wrap; } /* Allow wrap */
        .inventory-slot input[type="text"] { flex-grow: 1; margin-right: 10px; min-width: 150px; } /* Ensure minimum width */
        .inventory-slot input[type="number"] { width: 60px; flex-shrink: 0; }
        #anotacoes-btn { position: fixed; left: 10px; top: calc(50% + 40px); /* Adjust position */ transform: translateY(-50%); padding: 10px 20px; background: #f0e6d2; border: 2px solid #b8860b; border-radius: 6px; font-family: 'MedievalSharp', serif; font-size: 1rem; color: #000; cursor: pointer; transition: background-color 0.3s ease; z-index: 1000; }
        body.dark-mode #anotacoes-btn { background: #1e1e1e; color: #e0e0e0; }
        #anotacoes-btn:hover, #historico-dados-btn:hover { background: #a0522d; color: #fff; }
        #anotacoes-textarea { display: none; position: fixed; left: 60px; top: 50%; transform: translateY(-50%); width: 400px; height: 400px; background: #fff; border: 2px solid #b8860b; border-radius: 6px; padding: 10px; font-size: 0.9rem; resize: none; z-index: 1001; }
        body.dark-mode #anotacoes-textarea { background: #333; color: #e0e0e0; }
        #historico-dados-btn { position: fixed; right: 10px; top: calc(50% + 40px); /* Adjust position */ transform: translateY(-50%); padding: 10px 20px; background: #f0e6d2; border: 2px solid #b8860b; border-radius: 6px; font-family: 'MedievalSharp', serif; font-size: 1rem; color: #000; cursor: pointer; transition: background-color 0.3s ease; }
        body.dark-mode #historico-dados-btn { background: #1e1e1e; color: #e0e0e0; }
        #historico-dados-panel { display: none; position: fixed; right: 10px; top: 50%; transform: translateY(-50%); width: 300px; background: #fff; border: 2px solid #b8860b; border-radius: 6px; padding: 10px; max-height: 400px; overflow-y: auto; z-index: 1001; }
        body.dark-mode #historico-dados-panel { background: #333; border-color: #555; }
        #historico-dados-panel h3 { font-family: 'MedievalSharp', serif; color: #000; margin-bottom: 10px; }
        body.dark-mode #historico-dados-panel h3 { color: #e0e0e0; }
        #historico-lista div { padding: 5px; border-bottom: 1px solid #ccc; }
        body.dark-mode #historico-lista div { border-color: #555; }
        #excluir-historico-btn { background: #a52a2a; color: #fff; padding: 8px 16px; border-radius: 6px; cursor: pointer; margin-top: 10px; }
        #excluir-historico-btn:hover { background: #8b0000; }
        .magias-container { max-height: 300px; overflow-y: auto; border: 2px solid #b8860b; border-radius: 6px; padding: 10px; background: #fff; }
        body.dark-mode .magias-container { background: #333; border-color: #555; }
        .magias-container input { margin-bottom: 10px; }
        #adicionar-magia-btn { background: #b8860b; color: #fff; padding: 8px 16px; border-radius: 6px; cursor: pointer; display: block; margin-top: 10px; }
        #adicionar-magia-btn:hover { background: #a0522d; }
        .classe-raca-container { background: #f0e6d2; border: 2px solid #b8860b; padding: 10px; border-radius: 6px; margin-top: 10px; }
        body.dark-mode .classe-raca-container { background: #1e1e1e; border-color: #444; }
        .classe-raca-container label { font-family: 'MedievalSharp', serif; color: #a0522d; font-size: 1.2rem; }
        .classe-raca-container span[onclick] { background: #fff; border: 2px solid #b8860b; padding: 10px; cursor: pointer; display: block; }
        body.dark-mode .classe-raca-container span[onclick] { background: #333; color: #e0e0e0; }
        .classe-raca-container textarea { width: 100%; background: #fff; border: 2px solid #b8860b; box-sizing: border-box; }
        body.dark-mode .classe-raca-container textarea { background: #333; color: #e0e0e0; }
        .raca-item { margin-bottom: 20px; padding: 10px; background: #fff; border: 2px solid #b8860b; border-radius: 6px; }
        .raca-item h3 { font-family: 'MedievalSharp', serif; font-size: 1.5rem; color: #a0522d; }
        .raca-item p { font-size: 1rem; color: #000; }
        body.dark-mode .raca-item { background: #333; border-color: #555; }
        body.dark-mode .raca-item p { color: #e0e0e0; }
        /* Container for theme/color buttons */
        .theme-color-container { display: flex; justify-content: center; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        #background-color-selector { bottom: 100%; left: 50%; transform: translateX(-50%); margin-bottom: 5px; margin-top: 0; display: none; position: absolute; background-color: #fff; border: 1px solid #ccc; padding: 10px; border-radius: 5px; z-index: 1002; display: flex; gap: 10px; }
         /* Ensure popup display logic works */
        #background-color-selector { display: none; }

        /* Mobile Responsiveness */
        @media (max-width: 768px) {
            body { padding: 10px; }
            #ficha-container { padding: 15px; margin-top: 70px; /* Add margin to avoid overlap with fixed sidebar */ }
            h1#nome-personagem-titulo { font-size: 2rem; }
            section h2 { font-size: 1.2rem; }
            input, textarea { font-size: 0.9rem; }
            .botoes-container, .theme-color-container { flex-direction: row; flex-wrap: wrap; justify-content: center; } /* Ensure wrapping on small screens */

             /* Adjust absolute/fixed elements for mobile */
            #dice-container {
                position: relative; /* Place in normal flow */
                width: 150px; margin: 15px auto; /* Center */
                top: auto; right: auto; left: auto; /* Reset positioning */
                 z-index: 1;
            }
            #character-image-container {
                position: relative; width: 80px; height: 80px;
                margin: 10px auto; /* Center below title */
                top: auto; left: auto; /* Reset positioning */
                 z-index: 1;
            }
            #chat-btn-container { top: calc(100% - 50px); left: 10px; transform: none; /* Bottom left */ }
            #anotacoes-btn { top: calc(100% - 50px); left: calc(50% - 60px); transform: translateX(-50%); /* Bottom center-left */ }
             #historico-dados-btn { top: calc(100% - 50px); right: 10px; left: auto; transform: none; /* Bottom right */ }
             #chat-btn, #anotacoes-btn, #historico-dados-btn { padding: 8px 12px; font-size: 0.9rem; }

            .modal-content {
                 width: 90%; max-width: 500px; /* Limit width */
                 max-height: 85vh; overflow-y: auto; /* Enable scroll */
            }
             #chat-modal .modal-content { width: 95%; max-height: 80vh; /* Adjust chat modal too */ }
             #chat-modal .user-list { width: 100px; /* Slightly smaller user list */ }

             #anotacoes-textarea, #historico-dados-panel { width: calc(100% - 40px); /* Adjust panel widths */ left: 20px; right: 20px; top: 10%; max-height: 70vh; transform: none; }
        }

        @media (max-width: 480px) { /* Even smaller screens */
             h1#nome-personagem-titulo { font-size: 1.8rem; }
             .botao { padding: 10px 15px; font-size: 0.9rem; } /* Smaller main buttons */
             .icon-btn { width: 40px; height: 40px; font-size: 1rem;} /* Smaller icon buttons */
             .ficha-tab { width: 80px; height: 45px; } /* Smaller tabs */
             #add-ficha-btn { width: 80px; height: 45px; }
             #fichas-sidebar { height: 55px; }
        }

        /* Chat Modal Styles (Keep as before) */
        #chat-modal { display: none; }
        #chat-modal .modal-content { /* width/max-height adjusted in media query */ display: flex; flex-direction: column; }
        #chat-modal .chat-header { padding: 10px; border-bottom: 1px solid #ccc; font-family: 'MedievalSharp', serif; font-size: 1.5rem; text-align: center; }
        #chat-modal .chat-body { flex-grow: 1; display: flex; overflow: hidden; }
        #chat-modal .user-list { /* width adjusted in media query */ border-right: 1px solid #ccc; overflow-y: auto; padding: 10px; flex-shrink: 0; }
        #chat-modal .user-list h4 { font-family: 'MedievalSharp', serif; margin-bottom: 5px; }
        #chat-modal .user-list .user-item { padding: 8px; cursor: pointer; border-bottom: 1px solid #eee; }
        #chat-modal .user-list .user-item:hover { background-color: #f0e6d2; }
        body.dark-mode #chat-modal .user-list .user-item:hover { background-color: #333; }
        #chat-modal .conversation { flex-grow: 1; padding: 10px; overflow-y: auto; display: flex; flex-direction: column-reverse; /* Changed for bottom alignment */ }
        #chat-modal .message-container { display: flex; flex-direction: column; margin-bottom: 8px; }
        #chat-modal .message { padding: 8px; border-radius: 5px; background-color: #e0e0e0; color: #000; width: fit-content; max-width: 80%; }
        body.dark-mode #chat-modal .message { background-color: #444; color: #e0e0e0; }
        #chat-modal .message.sent { background-color: #cce5ff; align-self: flex-end; }
        body.dark-mode #chat-modal .message.sent { background-color: #6699cc; color: #e0e0e0; }
        #chat-modal .sender-name { font-size: 0.8rem; color: #777; margin-bottom: 2px; }
        body.dark-mode #chat-modal .sender-name { color: #aaa; }
        #chat-modal .message.sent + .sender-name { align-self: flex-end; } /* Align sender name for sent messages */
        #chat-modal .message.received + .sender-name { align-self: flex-start; } /* Align sender name for received */
        #chat-modal .chat-input { padding: 10px; border-top: 1px solid #ccc; display: flex; flex-shrink: 0; }
        #chat-modal .chat-input input[type="text"] { flex-grow: 1; padding: 8px; border-radius: 5px; border: 1px solid #ccc; margin-right: 10px; }
        body.dark-mode #chat-modal .chat-input input[type="text"] { background-color: #333; color: #e0e0e0; border-color: #555; }
        #chat-modal .chat-input button { padding: 8px 15px; border-radius: 5px; flex-shrink: 0; }

        /* Other Modal Styles (Keep as before, width adjusted in media query) */
        #chat-password-modal .modal-content, #open-chat-modal .modal-content { width: 350px; }
        #raca-opcoes-modal .modal-content button:nth-child(2) { margin-top: 10px; }
        #background-modal { display: none; }
        #background-modal .modal-content { width: 400px; text-align: left; }
        #background-modal .modal-content label { display: block; margin-bottom: 5px; }
        #background-modal .modal-content input[type="file"] { margin-bottom: 10px; }
        #background-modal .modal-content .radio-group { margin-bottom: 15px; }
        #background-modal .modal-content .radio-group label { display: inline-block; margin-right: 10px; }
        .color-option { width: 24px; height: 24px; border-radius: 50%; cursor: pointer; border: 1px solid #ccc; }
    </style>
</head>
<body>
    <div id="chat-btn-container">
        <button id="chat-btn" data-unread="0">💬 Chat</button>
    </div>
    <div id="fichas-sidebar">
        <div id="add-ficha-btn"><span>+ Fichas</span></div>
    </div>
    <div id="ficha-container">
        <h1 id="nome-personagem-titulo">Ficha de Personagem</h1>
         <div id="character-image-container" onclick="document.getElementById('character-image-input').click()">
            <img id="character-image" alt="Imagem do Personagem">
            <input type="file" id="character-image-input" accept="image/*" style="display:none">
        </div>
         <div id="dice-container">
            <label>Role seu dado:</label>
            <div id="dice-roll">-</div>
            <div id="dice-result"></div>
        </div>
        <div id="game-master-message">Você virou o Game Master</div>

        <div id="ficha-content">
            <section id="informacoes-basicas">
                <h2>Informações Básicas</h2>
                <label for="nome-personagem">Nome do Personagem:</label>
                <input type="text" id="nome-personagem" placeholder="Digite o nome do seu personagem">
                <label for="descricao-personagem">Descrição do Personagem:</label>
                <textarea id="descricao-personagem" placeholder="Digite a descrição do seu personagem"></textarea>
            </section>
            <section id="recursos">
                <h2>Recursos</h2>
                <div class="vida-magia-vigor">
                    <div class="atributo-container vida">
                        <h3>Vida</h3>
                        <div class="valor-total medieval-box"> <span>Vida Total: </span> <span id="vida-total" readonly>50</span> </div>
                        <div class="valor-atual medieval-box"> <span>Vida Atual: </span> <button onclick="diminuirVida()" title="Diminuir Vida">▼</button> <span id="vida-atual">50</span> <button onclick="aumentarVida()" title="Aumentar Vida">▲</button> </div>
                        <div class="regeneracao"> <span>Regeneração por turno: <span id="regeneracao-vida">0</span> (parado)</span> </div>
                    </div>
                    <div class="atributo-container magia">
                        <h3>Magia</h3>
                        <div class="valor-total medieval-box"> <span>Magia Total: </span> <span id="magia-total" readonly>20</span> </div>
                        <div class="valor-atual medieval-box"> <span>Magia Atual: </span> <button onclick="diminuirMagia()" title="Diminuir Magia">▼</button> <span id="magia-atual">20</span> <button onclick="aumentarMagia()" title="Aumentar Magia">▲</button> </div>
                        <div class="regeneracao"> <span>Regeneração por turno: <span id="regeneracao-magia">0</span></span> </div>
                    </div>
                    <div class="atributo-container vigor">
                        <h3>Vigor</h3>
                        <div class="valor-total medieval-box"> <span>Vigor Total: </span> <span id="vigor-total" readonly>10</span> </div>
                        <div class="valor-atual medieval-box"> <span>Vigor Atual: </span> <button onclick="diminuirVigor()" title="Diminuir Vigor">▼</button> <span id="vigor-atual">10</span> <button onclick="aumentarVigor()" title="Aumentar Vigor">▲</button> </div>
                        <div class="regeneracao"> <span>Regeneração por turno: <span id="regeneracao-vigor">0</span> (parado)</span> </div>
                    </div>
                </div>
            </section>
            <section id="atributos">
                <h2>Atributos</h2>
                <div class="atributos-container">
                    <div class="atributos-coluna">
                        <div class="atributo"> <label for="forca" title="Afeta ataque e RDF">Força:</label> <input type="number" id="forca" value="0" min="0"> </div>
                        <div class="atributo"> <label for="destreza" title="Afeta ataque e acerto">Destreza:</label> <input type="number" id="destreza" value="0" min="0"> </div>
                        <div class="atributo"> <label for="agilidade" title="Afeta esquiva e acerto">Agilidade:</label> <input type="number" id="agilidade" value="0" min="0"> </div>
                        <div class="atributo"> <label for="constituicao" title="Afeta vida, magia e vigor">Constituição:</label> <input type="number" id="constituicao" value="0" min="0"> </div>
                        <div class="atributo"> <label for="inteligencia" title="Afeta ataque mágico e RDM">Inteligência:</label> <input type="number" id="inteligencia" value="0" min="0"> </div>
                    </div>
                    <div class="atributos-coluna-destaque">
                        <div class="atributo-destaque"> <label>Ataque:</label> <span id="ataque" readonly>0</span> </div>
                        <div class="atributo-destaque"> <label>Ataque Mágico:</label> <span id="ataque-magico" readonly>0</span> </div>
                        <div class="atributo-destaque"> <label>Acerto:</label> <span id="acerto" readonly>0</span> </div>
                        <div class="atributo-destaque"> <label>Esquiva:</label> <span id="esquiva" readonly>0</span> </div>
                        <div class="atributo-destaque"> <label>RDF:</label> <span id="rdf" readonly>0</span> </div>
                        <div class="atributo-destaque"> <label>RDM:</label> <span id="rdm" readonly>0</span> </div>
                    </div>
                </div>
            </section>
            <section id="combate">
                <h2>Combate</h2>
                <div class="armamento-container">
                    <div class="armamento-coluna">
                        <label>Armamento Mão Direita:</label>
                        <div class="flex items-center mb-2"> <input type="text" id="arma-direita-nome" placeholder="Nome da Arma" class="mr-2"> <span>Ataque </span> <input type="number" id="arma-direita-ataque" value="0" class="w-20 mr-2"> <span>Ataque Mágico </span> <input type="number" id="arma-direita-ataque-magico" value="0" class="w-20"> </div>
                    </div>
                    <div class="armamento-coluna">
                        <label>Armamento Mão Esquerda:</label>
                        <div class="flex items-center"> <input type="text" id="arma-esquerda-nome" placeholder="Nome da Arma" class="mr-2"> <span>Ataque </span> <input type="number" id="arma-esquerda-ataque" value="0" class="w-20 mr-2"> <span>Ataque Mágico </span> <input type="number" id="arma-esquerda-ataque-magico" value="0" class="w-20"> </div>
                    </div>
                </div>
            </section>
            <section id="inventario-habilidades">
                <h2>Inventário e Habilidades</h2>
                <div class="flex flex-wrap gap-10 md:flex-nowrap md:gap-20"> <div class="w-full md:w-1/2">
                        <label>Inventário (Peso Total: <span id="peso-total">0</span> kg):</label>
                        <div id="inventario-slots">
                            <div class="inventory-slot"><input type="text" placeholder="Item 1" class="inventory-item"><input type="number" min="0" value="0" class="inventory-weight" title="Peso em kg"></div>
                            <div class="inventory-slot"><input type="text" placeholder="Item 2" class="inventory-item"><input type="number" min="0" value="0" class="inventory-weight"></div>
                            <div class="inventory-slot"><input type="text" placeholder="Item 3" class="inventory-item"><input type="number" min="0" value="0" class="inventory-weight"></div>
                            <div class="inventory-slot"><input type="text" placeholder="Item 4" class="inventory-item"><input type="number" min="0" value="0" class="inventory-weight"></div>
                            <div class="inventory-slot"><input type="text" placeholder="Item 5" class="inventory-item"><input type="number" min="0" value="0" class="inventory-weight"></div>
                            <div class="inventory-slot"><input type="text" placeholder="Item 6" class="inventory-item"><input type="number" min="0" value="0" class="inventory-weight"></div>
                            <div class="inventory-slot"><input type="text" placeholder="Item 7" class="inventory-item"><input type="number" min="0" value="0" class="inventory-weight"></div>
                            <div class="inventory-slot"><input type="text" placeholder="Item 8" class="inventory-item"><input type="number" min="0" value="0" class="inventory-weight"></div>
                            <div class="inventory-slot"><input type="text" placeholder="Item 9" class="inventory-item"><input type="number" min="0" value="0" class="inventory-weight"></div>
                            <div class="inventory-slot"><input type="text" placeholder="Item 10" class="inventory-item"><input type="number" min="0" value="0" class="inventory-weight"></div>
                        </div>
                    </div>
                    <div class="w-full md:w-1/2">
                        <label>Magias e Habilidades:</label>
                        <div id="magias-list" class="magias-container">
                            </div>
                        <button id="adicionar-magia-btn">Adicionar Magia</button>
                    </div>
                </div>
                <div class="mt-4">
                    <label>Vantagens:</label> <div id="vantagens-list-display" class="list-display"></div>
                    <label>Desvantagens:</label> <div id="desvantagens-list-display" class="list-display"></div>
                </div>
                <div class="classe-raca-container">
                    <label>Classe:</label> <input type="text" id="classe-nome" placeholder="Nome da Classe"> <textarea id="classe-descricao" placeholder="Descrição da Classe" class="expandable-textarea"></textarea>
                    <label>Raça:</label> <span id="raca-nome" onclick="abrirModalRaca()"></span> <textarea id="raca-descricao" placeholder="Descrição da Raça" class="expandable-textarea" readonly></textarea>
                </div>
            </section>
            <section id="locomocao">
                <h2>Locomoção</h2>
                <div class="locomotion-container">
                    <div class="locomotion-item"> <label>Velocidade de Corrida (km/h):</label><span>🏃‍♂️</span><span id="velocidade-corrida" readonly>25</span> </div>
                    <div class="locomotion-item"> <label>Altura do Pulo (m):</label><span>⬆️</span><span id="altura-pulo" readonly>1</span> </div>
                    <div class="locomotion-item"> <label>Distância do Pulo (m):</label><span>➡️</span><span id="distancia-pulo" readonly>3</span> </div>
                </div>
            </section>
            <section id="status">
                <h2>Status</h2>
                <div class="flex gap-20">
                    <div> <label>Experiência:</label> <input type="number" id="experiencia" value="0" min="0"> <label>Pontos de Habilidade (PD):</label> <span id="pontos-habilidade" readonly>25</span> <label>Pontos de Vantagem (PH):</label> <span id="pontos-vantagem" readonly>8</span> </div>
                    <div></div>
                </div>
                <div id="nivel-container"> <label>Nível:</label> <span id="nivel">0</span> </div>
            </section>

            <div style="display:flex;justify-content:center;gap:20px;margin-bottom:20px; flex-wrap: wrap;">
                <button id="vantagens-desvantagens-btn" class="botao">Vantagens e Desvantagens</button>
                <button id="racas-btn" class="botao">Raças 🏰</button>
                <button id="classes-btn" class="botao">Classes ⚔️</button>
            </div>

            <div class="botoes-container">
                <button id="reset-pontos" class="botao botao-reset">Reiniciar Pontos</button>
                <button id="recomecar" class="botao botao-recomecar">Recomeçar</button>
                <button id="bloquear-ficha" class="botao botao-bloquear">Bloquear Ficha</button>
                <button id="plano-fundo-btn" class="botao">Plano de fundo</button>
                <button id="excluir-ficha" class="botao botao-excluir">Excluir Ficha</button>
            </div>

            <div class="theme-color-container">
                <button id="lua-btn" class="botao icon-btn">🌙</button>
                <button id="sol-btn" class="botao icon-btn">☀️</button>
                <div id="cor-fundo-btn-wrapper">
                     <button id="cor-fundo-btn" class="botao icon-btn">🎨</button>
                     <div id="background-color-selector">
                          <div class="color-option" style="background-color: #800000;" data-color="#800000"></div> <div class="color-option" style="background-color: #000080;" data-color="#000080"></div> <div class="color-option" style="background-color: #ffffff;" data-color="#ffffff"></div> <div class="color-option" style="background-color: #f0e6d2;" data-color="#f0e6d2"></div> <div class="color-option" style="background-color: #ffc0cb;" data-color="#ffc0cb"></div> <div class="color-option" style="background-color: #006400;" data-color="#006400"></div> <div class="color-option" style="background-color: #ff0000;" data-color="#ff0000"></div> <div class="color-option" style="background-color: #808080;" data-color="#808080"></div>
                     </div>
                </div>
            </div>
        </div> </div> <button id="anotacoes-btn">Anotações</button>
    <textarea id="anotacoes-textarea" placeholder="Suas anotações aqui..."></textarea>
    <button id="historico-dados-btn">Histórico</button> <div id="historico-dados-panel">
        <h3>Histórico de Dados</h3>
        <div id="historico-lista"></div>
        <button id="excluir-historico-btn">Excluir histórico</button>
    </div>
    <div id="vantagens-desvantagens-panel">
        <h2>Vantagens e Desvantagens</h2>
        <div>Pontos de Vantagem Temporários: <span id="ph-temp">0</span></div>
        <div id="vantagens-list"></div> <div id="desvantagens-list"></div>
        <button id="salvar-vantagens-btn">SALVAR</button> <button id="fechar-pagina-btn">Fechar Página</button>
    </div>
    <div id="racas-panel">
        <h2>Raças</h2>
        <div id="ph-temp-raca-container" style="text-align: center; margin-bottom: 10px;">Pontos de Vantagem Temporários: <span id="ph-temp-raca">0</span></div> <div id="racas-list"></div>
        <button id="salvar-racas-btn">SALVAR</button> <button id="fechar-racas-btn">Fechar Página</button>
    </div>
    <div id="classes-panel"> <h2>Classes</h2> <button id="fechar-classes-btn">Fechar Página</button> </div>
    <div id="nome-ficha-modal" class="modal"> <div class="modal-content"> <h3>Dê um Nome à Ficha</h3> <input type="text" id="nome-ficha-input" placeholder="Nome da ficha" maxlength="20"> <button class="confirm-btn" onclick="criarNovaFicha()">Confirmar</button> <button class="cancel-btn" onclick="fecharModal('nome-ficha-modal')">Cancelar</button> </div> </div>
    <div id="bloquear-ficha-modal" class="modal"> <div class="modal-content"> <h3>Ponha sua Senha de 4 Dígitos</h3> <input type="password" id="senha-bloqueio-input" placeholder="Senha (4 dígitos)" maxlength="4"> <button class="confirm-btn" onclick="bloquearFicha()">Confirmar</button> <button class="cancel-btn" onclick="fecharModal('bloquear-ficha-modal')">Cancelar</button> </div> </div>
    <div id="password-modal" class="modal"> <div class="modal-content"> <h3>Digite sua Senha</h3> <input type="password" id="senha-desbloqueio-input" placeholder="Senha (4 dígitos)" maxlength="4"> <button class="confirm-btn" onclick="desbloquearFicha()">Confirmar</button> <button class="cancel-btn" onclick="cancelarDesbloqueio()">Cancelar</button> </div> </div>
    <div id="confirmar-compra-modal" class="modal"> <div class="modal-content"> <h3>Tem certeza que quer comprar isso?</h3> <button class="confirm-btn" id="confirmar-compra-btn">Sim</button> <button class="cancel-btn" onclick="fecharModal('confirmar-compra-modal')">Não</button> </div> </div>
    <div id="salvar-vantagens-modal" class="modal"> <div class="modal-content"> <h3 id="salvar-modal-texto">Se salvar, as alterações não poderão ser desfeitas.</h3> <button class="confirm-btn" id="confirmar-salvar-btn">OK</button> <button class="cancel-btn" onclick="fecharModal('salvar-vantagens-modal')">Cancelar</button> </div> </div>
    <div id="senha-gm-modal" class="modal"> <div class="modal-content"> <h3>Peça permissão ao GM</h3> <input type="password" id="senha-gm-input" placeholder="Senha GM"> <button class="confirm-btn" id="confirmar-senha-gm-btn">Confirmar</button> <button class="cancel-btn" onclick="fecharModal('senha-gm-modal')">Cancelar</button> </div> </div>
    <div id="raca-opcoes-modal" class="modal"> <div class="modal-content"> <h3>O que você deseja fazer?</h3> <button class="confirm-btn" onclick="excluirRacaSelecionadaModal()">Excluir Raça</button> <button class="confirm-btn" onclick="editarRacaSelecionadaModal()" style="margin-top: 10px;">Editar Raça</button> <button class="cancel-btn" onclick="fecharModal('raca-opcoes-modal')">Cancelar</button> </div> </div>
    <div id="editar-raca-modal" class="modal"> <div class="modal-content"> <h3>Editar Raça</h3> <label for="editar-raca-nome">Nome:</label> <input type="text" id="editar-raca-nome"> <label for="editar-raca-descricao">Descrição:</label> <textarea id="editar-raca-descricao"></textarea> <button class="confirm-btn" onclick="salvarEdicaoRaca()">Salvar</button> <button class="cancel-btn" onclick="fecharModal('editar-raca-modal')">Cancelar</button> </div> </div>
    <div id="chat-password-modal" class="modal"> <div class="modal-content"> <h3>Definir Senha do Chat</h3> <input type="password" id="chat-senha-input" placeholder="Senha do Chat"> <input type="password" id="chat-confirmar-senha-input" placeholder="Confirmar Senha"> <button class="confirm-btn" onclick="definirSenhaChat()">Confirmar</button> <button class="cancel-btn" onclick="fecharModal('chat-password-modal')">Cancelar</button> </div> </div>
    <div id="open-chat-modal" class="modal"> <div class="modal-content"> <h3>Digite a Senha do Chat</h3> <input type="password" id="abrir-chat-senha-input" placeholder="Senha do Chat"> <button class="confirm-btn" onclick="abrirChat()">Confirmar</button> <button class="cancel-btn" onclick="fecharModal('open-chat-modal')">Cancelar</button> </div> </div>
    <div id="chat-modal" class="modal"> <div class="modal-content"> <div class="chat-header">Chat Privado</div> <div class="chat-body"> <div class="user-list"> <h4>Fichas Online</h4> <div id="available-fichas"></div> </div> <div class="conversation" id="conversation-area"></div> </div> <div class="chat-input"> <input type="text" id="mensagem-input" placeholder="Digite sua mensagem..."> <button onclick="enviarMensagem()">Enviar</button> </div> <button class="cancel-btn" onclick="fecharModal('chat-modal')">Fechar Chat</button> </div> </div>
    <div id="notification"></div>
    <audio id="new-message-sound" preload="auto"> <source src="notification_sound.mp3" type="audio/mpeg"> </audio>
    <div id="background-modal" class="modal"> <div class="modal-content"> <h3>Plano de Fundo</h3> <label for="background-image-input">Selecionar Imagem:</label> <input type="file" id="background-image-input" accept="image/*"> <div class="radio-group"> <label><input type="radio" name="background-size" value="cover" checked>Preencher Tela</label> <label><input type="radio" name="background-size" value="100% 100%">Estender</label> <label><input type="radio" name="background-size" value="auto">Tamanho Normal</label> </div> <button class="confirm-btn" onclick="aplicarPlanoDeFundo()">Aplicar</button> <button class="cancel-btn" onclick="fecharModal('background-modal')">Cancelar</button> <button class="cancel-btn" onclick="excluirPlanoDeFundo()">Excluir Imagem</button> </div> </div>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyBbbwbwPXv6gztkyP3TXK-DtooEI7FcClI", authDomain: "ficha-de-rpg-b9685.firebaseapp.com", databaseURL: "https://ficha-de-rpg-b9685-default-rtdb.firebaseio.com", projectId: "ficha-de-rpg-b9685", storageBucket: "ficha-de-rpg-b9685.firebasestorage.app", messagingSenderId: "528610398062", appId: "1:528610398062:web:8fdb9cfd5ded8167613b7f" };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        let fichas = {}, currentFichaId = null, isFichaLocked = false, fichaPassword = null, isFichaUnlocked = false, senhaMatriz = "1040", vantagensSelecionadas = [], desvantagensSelecionadas = [], tempVantagensSelecionadas = [], tempDesvantagensSelecionadas = [], racaSelecionada = null, tempRacaSelecionada = null, vidaTotal, vidaAtual, magiaTotal, magiaAtual, vigorTotal, vigorAtual, previousValues = new Map(), chatPassword = null, isChatOpen = false, selectedChatUser = null;

        const vantagensData = [ { nome: "Maestria com Armas curtas (2)", custo: 2, descricao: "+1 em ataque, +1 em acerto com armas curtas." }, { nome: "Maestria com armas pesadas (2)", custo: 2, descricao: "+2 em ataque com armas pesadas." }, { nome: "Maestria com armas de longo alcance (2)", custo: 2, descricao: "+2 em acerto com armas de longo alcance." }, { nome: "Furtar (2)", custo: 2, descricao: "+4 em testes de furto." }, { nome: "Lábia (2)", custo: 2, descricao: "+5 em testes de lábia." }, { nome: "Velejar (1)", custo: 1, descricao: "" }, { nome: "Beleza (1)", custo: 1, descricao: "+3 o teste em lábia, paquera e persuasão." }, { nome: "Boa Fama (2)", custo: 2, descricao: "+4 chance de descontos em armamentos, pousadas, alimentos, etc." }, { nome: "Arremedo (2)", custo: 2, descricao: "Capacidade de imitar qualquer som SIMPLES." }, { nome: "Destemor (1)", custo: 1, descricao: "Dificilmente é assustado por algo." }, { nome: "Empatia (3)", custo: 3, descricao: "Sensibilidade extraordinária em relação aos outras pessoas. Excelente para identificar impostores, possessões por espirito, etc." }, { nome: "Empatia com animais (1)", custo: 1, descricao: "Pode compreender as motivações dos animais." }, { nome: "Patrono (4)", custo: 4, descricao: "Possui um mentor/mestre/professor, até mesmo uma organização/guilda que pode lhe oferecer ajuda." }, { nome: "Reconhecimento Social (2)", custo: 2, descricao: "Membro de um grupo respeitado/temido/venerado. +2 teste em lábia, paquera e persuasão." }, { nome: "Riqueza (2)", custo: 2, descricao: "Inicia com 20 moedas de ouro." }, { nome: "Aptidão para magia (4)", custo: 4, descricao: "+15% dano e -15% custo de magia para a magia que tem aptidão." }, { nome: "Combo Físico (4)", custo: 4, descricao: "Inicia com 50km velocidade corrida, pulo de 3m altura e 9m distância.", restricao: "inicio" }, { nome: "Nadar (1)", custo: 1, descricao: "" }, { nome: "Escalar (2)", custo: 2, descricao: "" }, { nome: "Segunda língua (1)", custo: 1, descricao: "Fala mais um idioma." }, { nome: "Paquerador (2)", custo: 2, descricao: "+4 em teste para paquera e persuasão envolvendo flerte." }, { nome: "Senso de perigo (5)", custo: 5, descricao: "Quando algo grave ocorrer o mestre pedirá pra você jogar um dado para reagir." }, { nome: "Acrobata (3)", custo: 3, descricao: "+ fama ao lutar em público." }, { nome: "Equilíbrio Perfeito (3)", custo: 3, descricao: "+8 em testes de equilíbrio." }, { nome: "Tecnologia (2)", custo: 2, descricao: "Engenhoso, pode inventar coisas, criar objetos improvisados." }, { nome: "Poder Oculto (7)", custo: 7, descricao: "Com 10% vida, ativa +50% em todos atributos. Volta ao normal acima de 10% vida." }, { nome: "Sobrevivência em floresta (2)", custo: 2, descricao: "Facilidade para achar cavernas, criar assentamentos, achar comida, gravar caminhos, achar água, etc." } ];
        const desvantagensData = [ { nome: "Fobia (+2)", ganho: 2, descricao: "Medo irracional de algo específico." }, { nome: "Má Fama (+2)", ganho: 2, descricao: "Mal visto pela sociedade, dificultando interações sociais." }, { nome: "Alcoolismo (+2)", ganho: 2, descricao: "Dependência de álcool que afeta suas decisões." }, { nome: "Altruísmo (+2)", ganho: 2, descricao: "Se sacrifica por outras pessoas, pouco se importa com fama ou riqueza." }, { nome: "Avareza (+2)", ganho: 2, descricao: "Preocupação permanente na conservação de riquezas." }, { nome: "Bullying (+3)", ganho: 3, descricao: "Gosta de caçoar, agredir, denegrir, difamar e apontar defeitos." }, { nome: "Circunspeção (+2)", ganho: 2, descricao: "Não entende piadas, entende tudo literal e acredita que todos estão sérios." }, { nome: "Compulsões (+3)", ganho: 3, descricao: "Hábito ou vício que toma boa parte dos seus recursos e tempo." }, { nome: "Covardia (+2)", ganho: 2, descricao: "Extremo cuidado com bem-estar físico e dificuldade em assumir riscos." }, { nome: "Dependentes (+4)", ganho: 4, descricao: "Alguém depende de você a todo momento (filhos, parentes, etc.)." }, { nome: "Fúria (+2)", ganho: 2, descricao: "Tendência a perder o controle e atacar freneticamente (ativado por dano, insulto ou aleatório)." }, { nome: "Honestidade (+3)", ganho: 3, descricao: "Não consegue mentir ou omitir, sempre fala a verdade e desmascara mentiras." }, { nome: "Impulsividade (+2)", ganho: 2, descricao: "Sempre age sem pensar." }, { nome: "Luxúria (+2)", ganho: 2, descricao: "Desejo incontrolável por romance." }, { nome: "Magnetismo Sobrenatural (+2)", ganho: 2, descricao: "Coisas estranhas acontecem com seu personagem em nível alarmante." }, { nome: "No Limite (+4)", ganho: 4, descricao: "Assume riscos extremamente irracionais diante de perigo mortal." }, { nome: "Teimosia (+1)", ganho: 1, descricao: "Quer sempre fazer as coisas do seu modo, não segue planos que não sejam seus." }, { nome: "Amnésia (+2)", ganho: 2, descricao: "Em certos momentos, não consegue lembrar de coisas importantes." } ];
        let racasData = [ { nome: "Humano (3)", custo: 3, descricao: "Versáteis, ambiciosos, mestres em adaptação.", vantagens: ["Explorador Nato: Cavalo superior, equipamentos, mapa detalhado.", "Mestre das Profissões: Escolha (Ferreiro Lendário, Costureiro Arcano, Arquiteto Visionário) com benefícios únicos.", "Rede de Influência: Aliado influente (guildas, mercadores, líderes) com acesso a informações ou ajuda.", "Determinação Inabalável: Uma vez/dia, ignore uma desvantagem (exaustão, ferimento, magia) por um curto período."] }, { nome: "Elfo (4)", custo: 4, descricao: "Sábios, mágicos, conectados à natureza.", vantagens: ["Sabedoria Ancestral: Domina área (arcana, história, natureza), decifra itens antigos, aprende 1 língua extra.", "Visão Élfica Suprema: Enxerga 10m escuro, detecta magias fracas 20m, percebe intenções hostis (teste 19+).", "Escudo Mágico: Resistência inata a um tipo de efeito mágico hostil (dano ou duração -50%)."] }, { nome: "Anão (4)", custo: 4, descricao: "Resilientes, habilidosos, ligados à terra.", vantagens: ["Fortitude Indomável: Trabalha 3 dias sem descanso, recupera vida/energia 2x mais rápido em rocha/subterrâneo.", "Artesão: Escolha (Mestre Minerador, Forjador de Lendas, Joalheiro Divino) com impacto massivo.", "Senhor das Profundezas: Nunca se perde subterrâneo, detecta armadilhas, sente vibrações (prever emboscada/colapso)."] }, { nome: "Orc (3)", custo: 3, descricao: "Guerreiros ferozes, líderes pela força.", vantagens: ["Lenda entre Guerreiros: Inspira temor/respeito, alianças marciais, acesso missões épicas; inimigos menores fogem (teste 16+).", "Resiliência Brutal: Luta sem penalidades com ferimentos graves, só cai com PV 0, regenera ferimentos leves fora de combate.", "Domínio da Intimidação: Força inimigos a render/recuar com grito (1x/encontro, afeta grupos), bônus massivo negociações (força/medo).", "Fúria Ancestral: Fúria 2x/dia (dobra força/resistência por curto período)."] }, { nome: "Meio Animal (Selvagem) (4)", custo: 4, descricao: "Instinto primal com astúcia.", vantagens: ["Sentidos Predatórios: Escolha (visão, olfato, audição) aguçado; rastreia km, detecta invisíveis, evita surpresa (teste 12+).", "Senhor dos Terrenos: Adapta-se a 1 ambiente (floresta, deserto, pântano), ignora efeitos negativos, bônus movimento/furtividade (+1).", "Frenesi Instintivo: 1x/dia, velocidade sobrenatural (2x movimento), ataques adicionais, percepção pré-monitória (10 min)."] } ];
        const nivelData = [ { nivel: 0, xp: 0, pd: 25, ph: 8 }, { nivel: 1, xp: 10, pd: 31, ph: 9 }, { nivel: 2, xp: 30, pd: 37, ph: 10 }, { nivel: 3, xp: 60, pd: 43, ph: 11 }, { nivel: 4, xp: 100, pd: 49, ph: 12 }, { nivel: 5, xp: 150, pd: 55, ph: 13 }, { nivel: 6, xp: 210, pd: 61, ph: 14 }, { nivel: 7, xp: 280, pd: 67, ph: 15 }, { nivel: 8, xp: 360, pd: 73, ph: 16 }, { nivel: 9, xp: 450, pd: 79, ph: 17 }, { nivel: 10, xp: 550, pd: 85, ph: 18 }, { nivel: 11, xp: 670, pd: 91, ph: 19 }, { nivel: 12, xp: 810, pd: 97, ph: 20 }, { nivel: 13, xp: 970, pd: 103, ph: 21 }, { nivel: 14, xp: 1150, pd: 109, ph: 22 }, { nivel: 15, xp: 1350, pd: 115, ph: 23 }, { nivel: 16, xp: 1570, pd: 121, ph: 24 }, { nivel: 17, xp: 1810, pd: 127, ph: 25 }, { nivel: 18, xp: 2070, pd: 133, ph: 26 }, { nivel: 19, xp: 2350, pd: 139, ph: 27 }, { nivel: 20, xp: 2650, pd: 145, ph: 28 }, { nivel: 21, xp: 2980, pd: 148, ph: 29 }, { nivel: 22, xp: 3340, pd: 151, ph: 30 }, { nivel: 23, xp: 3730, pd: 154, ph: 31 }, { nivel: 24, xp: 4150, pd: 157, ph: 32 }, { nivel: 25, xp: 4600, pd: 160, ph: 33 }, { nivel: 26, xp: 5080, pd: 163, ph: 34 }, { nivel: 27, xp: 5590, pd: 166, ph: 35 }, { nivel: 28, xp: 6130, pd: 169, ph: 36 }, { nivel: 29, xp: 8000, pd: 219, ph: 37 }, { nivel: 30, xp: 10000, pd: 319, ph: 38 } ];

        // Cache DOM Elements (IDs assumed to exist)
        const getElem = id => document.getElementById(id);
        const nomePersonagemInput = getElem("nome-personagem"), descricaoPersonagemInput = getElem("descricao-personagem"),
            forcaInput = getElem("forca"), destrezaInput = getElem("destreza"), agilidadeInput = getElem("agilidade"),
            inteligenciaInput = getElem("inteligencia"), constituicaoInput = getElem("constituicao"),
            ataqueSpan = getElem("ataque"), ataqueMagicoSpan = getElem("ataque-magico"), acertoSpan = getElem("acerto"),
            esquivaSpan = getElem("esquiva"), rdfSpan = getElem("rdf"), rdmSpan = getElem("rdm"),
            armaDireitaNomeInput = getElem("arma-direita-nome"), armaDireitaAtaqueInput = getElem("arma-direita-ataque"),
            armaDireitaAtaqueMagicoInput = getElem("arma-direita-ataque-magico"), armaEsquerdaNomeInput = getElem("arma-esquerda-nome"),
            armaEsquerdaAtaqueInput = getElem("arma-esquerda-ataque"), armaEsquerdaAtaqueMagicoInput = getElem("arma-esquerda-ataque-magico"),
            resetPontosButton = getElem("reset-pontos"), recomecarButton = getElem("recomecar"),
            bloquearFichaButton = getElem("bloquear-ficha"), experienciaInput = getElem("experiencia"),
            nivelSpan = getElem("nivel"), pontosHabilidadeSpan = getElem("pontos-habilidade"),
            pontosVantagemSpan = getElem("pontos-vantagem"), velocidadeCorridaSpan = getElem("velocidade-corrida"),
            alturaPuloSpan = getElem("altura-pulo"), distanciaPuloSpan = getElem("distancia-pulo"),
            nomePersonagemTitulo = getElem("nome-personagem-titulo"), gameMasterMessage = getElem("game-master-message"),
            vantagensListDisplay = getElem("vantagens-list-display"), desvantagensListDisplay = getElem("desvantagens-list-display"),
            inventarioSlots = getElem("inventario-slots"), pesoTotalSpan = getElem("peso-total"),
            diceContainer = getElem("dice-container"), diceRoll = getElem("dice-roll"), diceResult = getElem("dice-result"),
            notification = getElem("notification"), characterImageInput = getElem("character-image-input"),
            characterImage = getElem("character-image"), vantagensDesvantagensBtn = getElem("vantagens-desvantagens-btn"),
            vantagensDesvantagensPanel = getElem("vantagens-desvantagens-panel"), vantagensList = getElem("vantagens-list"),
            desvantagensList = getElem("desvantagens-list"), salvarVantagensBtn = getElem("salvar-vantagens-btn"),
            fecharPaginaBtn = getElem("fechar-pagina-btn"), fichaContainer = getElem("ficha-container"),
            magiasList = getElem("magias-list"), adicionarMagiaBtn = getElem("adicionar-magia-btn"),
            anotacoesBtn = getElem("anotacoes-btn"), anotacoesTextarea = getElem("anotacoes-textarea"),
            racasBtn = getElem("racas-btn"), classesBtn = getElem("classes-btn"), racasPanel = getElem("racas-panel"),
            classesPanel = getElem("classes-panel"), fecharRacasBtn = getElem("fechar-racas-btn"),
            fecharClassesBtn = getElem("fechar-classes-btn"), classeNomeInput = getElem("classe-nome"),
            classeDescricaoInput = getElem("classe-descricao"), racaNomeSpan = getElem("raca-nome"),
            racaDescricaoInput = getElem("raca-descricao"), luaBtn = getElem("lua-btn"), solBtn = getElem("sol-btn"),
            salvarRacasBtn = getElem("salvar-racas-btn"), racasList = getElem("racas-list"),
            atributosInputs = [forcaInput, destrezaInput, agilidadeInput, inteligenciaInput, constituicaoInput],
            chatBtn = getElem("chat-btn"), availableFichasDiv = getElem("available-fichas"),
            conversationAreaDiv = getElem("conversation-area"), mensagemInput = getElem("mensagem-input"),
            newMessageSound = getElem("new-message-sound"), planoFundoBtn = getElem("plano-fundo-btn"),
            backgroundImageInput = getElem("background-image-input"), backgroundModal = getElem("background-modal"),
            corFundoBtn = getElem("cor-fundo-btn"), backgroundColorSelector = getElem("background-color-selector"),
            confirmarSalvarBtn = getElem("confirmar-salvar-btn"), phTempRacaSpan = getElem("ph-temp-raca");

        let nivel = 0, nivelAnterior = 0, pontosHabilidadeTotal = 25, pontosHabilidadeUsados = 0, experiencia = 0, vidaBase = 50;

        // --- Initialization ---
        function criarFichaMatriz() {
            const fichaId = "ficha-matriz";
            const fichaMatriz = { nomeFicha: "Matriz", nomePersonagem: "Personagem Matriz", descricaoPersonagem: "Ficha original do sistema", forca: "0", destreza: "0", agilidade: "0", inteligencia: "0", constituicao: "0", experiencia: "0", armaDireitaNome: "", armaDireitaAtaque: "0", armaDireitaAtaqueMagico: "0", armaEsquerdaNome: "", armaEsquerdaAtaque: "0", armaEsquerdaAtaqueMagico: "0", vantagens: "", magiasHabilidades: Array(10).fill("").join("\n"), desvantagens: "", inventario: Array(10).fill({ item: "", peso: "0" }), velocidadeCorrida: "25", alturaPulo: "1", distanciaPulo: "3", isLocked: true, password: senhaMatriz, imagem: null, anotacoes: "", classeNome: "", classeDescricao: "", racaNome: "", racaDescricao: "", racaSelecionada: "", chatPassword: null, backgroundImage: null, backgroundSize: 'cover', backgroundColor: '#f0e6d2', vidaAtual: 50, magiaAtual: 20, vigorAtual: 10 };
            database.ref("fichas/ficha-matriz").once("value", snapshot => {
                if (!snapshot.exists()) {
                    database.ref(`fichas/${fichaId}`).set(fichaMatriz).then(() => { if (!currentFichaId) { currentFichaId = fichaId; carregarFicha(fichaId); } carregarFichas(); });
                } else { if (!currentFichaId) { currentFichaId = fichaId; carregarFicha(fichaId); } carregarFichas(); } // Load matrix if it exists and nothing else selected
            });
        }

        function carregarFichas() {
            database.ref("fichas").on("value", snapshot => {
                fichas = snapshot.val() || {};
                if (!fichas["ficha-matriz"]) { criarFichaMatriz(); } // Create matrix if missing
                else if (!currentFichaId || !fichas[currentFichaId]) { // If no current or current deleted, load matrix
                     currentFichaId = "ficha-matriz";
                     carregarFicha(currentFichaId);
                }
                 atualizarAbasFichas();
                 atualizarListaFichasChat();
                 verificarNovasMensagens();
            });
        }

        function atualizarAbasFichas() {
            const sidebar = getElem("fichas-sidebar"), addBtn = getElem("add-ficha-btn");
            // Clear existing tabs except add button
            Array.from(sidebar.children).forEach(child => { if (child.id !== 'add-ficha-btn') child.remove(); });
            // Add tabs from loaded fichas
            Object.keys(fichas).sort((a, b) => (fichas[a].nomeFicha || '').localeCompare(fichas[b].nomeFicha || '')).forEach(fichaId => { // Sort alphabetically
                if (fichaId !== "ficha-matriz") {
                    const tab = document.createElement("div"); tab.className = "ficha-tab";
                    const span = document.createElement("span"); span.textContent = fichas[fichaId].nomeFicha || "Sem Nome";
                    tab.appendChild(span); tab.dataset.fichaId = fichaId;
                    if (fichaId === currentFichaId) tab.classList.add("active");
                    tab.onclick = () => { if (currentFichaId !== fichaId) { currentFichaId = fichaId; carregarFicha(fichaId); /* No need to call atualizarAbas again */ } };
                    sidebar.insertBefore(tab, addBtn);
                }
            });
             // Ensure current active tab is highlighted correctly after reload
            Array.from(sidebar.querySelectorAll('.ficha-tab')).forEach(tab => tab.classList.toggle('active', tab.dataset.fichaId === currentFichaId));
        }

        addBtn.onclick = () => { getElem("nome-ficha-modal").style.display = "flex"; getElem("nome-ficha-input").value = ""; getElem("nome-ficha-input").focus(); };

        function criarNovaFicha() {
            const nomeFicha = getElem("nome-ficha-input").value.trim();
            if (!nomeFicha) return alert("Por favor, dê um nome à ficha!");
            const novaFichaId = database.ref("fichas").push().key;
            const novaFicha = { nomeFicha, nomePersonagem: "", descricaoPersonagem: "", forca: "0", destreza: "0", agilidade: "0", inteligencia: "0", constituicao: "0", experiencia: "0", armaDireitaNome: "", armaDireitaAtaque: "0", armaDireitaAtaqueMagico: "0", armaEsquerdaNome: "", armaEsquerdaAtaque: "0", armaEsquerdaAtaqueMagico: "0", vantagens: "", magiasHabilidades: Array(10).fill("").join("\n"), desvantagens: "", inventario: Array(10).fill({ item: "", peso: "0" }), velocidadeCorrida: "25", alturaPulo: "1", distanciaPulo: "3", isLocked: false, password: null, imagem: null, anotacoes: "", classeNome: "", classeDescricao: "", racaNome: "", racaDescricao: "", racaSelecionada: "", chatPassword: null, backgroundImage: null, backgroundSize: 'cover', backgroundColor: '#f0e6d2', vidaAtual: 50, magiaAtual: 20, vigorAtual: 10 }; // Add default resources
            database.ref(`fichas/${novaFichaId}`).set(novaFicha).then(() => {
                currentFichaId = novaFichaId; carregarFicha(novaFichaId); fecharModal("nome-ficha-modal"); // No need to call atualizarAbas here, 'on value' will trigger it.
            }).catch(error => console.error("Erro ao criar nova ficha:", error));
        }

        function fecharModal(modalId) { getElem(modalId).style.display = "none"; }

        function carregarFicha(fichaId) {
            if (!fichas[fichaId]) return; const ficha = fichas[fichaId];
            nomePersonagemInput.value = ficha.nomePersonagem || ""; descricaoPersonagemInput.value = ficha.descricaoPersonagem || "";
            forcaInput.value = ficha.forca || "0"; destrezaInput.value = ficha.destreza || "0"; agilidadeInput.value = ficha.agilidade || "0";
            inteligenciaInput.value = ficha.inteligencia || "0"; constituicaoInput.value = ficha.constituicao || "0"; experienciaInput.value = ficha.experiencia || "0";
            armaDireitaNomeInput.value = ficha.armaDireitaNome || ""; armaDireitaAtaqueInput.value = ficha.armaDireitaAtaque || "0"; armaDireitaAtaqueMagicoInput.value = ficha.armaDireitaAtaqueMagico || "0";
            armaEsquerdaNomeInput.value = ficha.armaEsquerdaNome || ""; armaEsquerdaAtaqueInput.value = ficha.armaEsquerdaAtaque || "0"; armaEsquerdaAtaqueMagicoInput.value = ficha.armaEsquerdaAtaqueMagico || "0";
            velocidadeCorridaSpan.textContent = ficha.velocidadeCorrida || "25"; alturaPuloSpan.textContent = ficha.alturaPulo || "1"; distanciaPuloSpan.textContent = ficha.distanciaPulo || "3";
            isFichaLocked = ficha.isLocked || false; fichaPassword = ficha.password || null; isFichaUnlocked = false;
            vantagensSelecionadas = ficha.vantagens ? ficha.vantagens.split("\n").filter(v => v.trim()) : [];
            desvantagensSelecionadas = ficha.desvantagens ? ficha.desvantagens.split("\n").filter(d => d.trim()) : [];
            racaSelecionada = ficha.racaSelecionada || "";
            racaNomeSpan.textContent = racaSelecionada ? racaSelecionada.split(" (")[0] : "";
            racaDescricaoInput.value = racasData.find(r => r.nome === racaSelecionada)?.vantagens.join("\n\n") || "";

            vantagensListDisplay.innerHTML = ""; desvantagensListDisplay.innerHTML = "";
            vantagensSelecionadas.forEach(v => { const div = document.createElement("div"); div.textContent = v; div.className = "list-item"; div.onclick = () => removerVantagem(v); vantagensListDisplay.appendChild(div); });
            desvantagensSelecionadas.forEach(d => { const div = document.createElement("div"); div.textContent = d; div.className = "list-item"; div.onclick = () => removerDesvantagem(d); desvantagensListDisplay.appendChild(div); });

            const inventario = Array.isArray(ficha.inventario) ? ficha.inventario : Array(10).fill({ item: "", peso: "0" });
            const slots = inventarioSlots.querySelectorAll(".inventory-slot");
            slots.forEach((slot, i) => { slot.querySelector(".inventory-item").value = inventario[i]?.item || ""; slot.querySelector(".inventory-weight").value = inventario[i]?.peso || "0"; });
            calcularPesoTotal();

            const magias = ficha.magiasHabilidades ? ficha.magiasHabilidades.split("\n") : Array(10).fill("");
            magiasList.innerHTML = ""; // Clear previous inputs
            for (let i = 0; i < Math.max(magias.length, 10); i++) { // Ensure at least 10 slots
                 const input = document.createElement("input"); input.type = "text"; input.className = "magia-nome"; input.placeholder = `Magia/Habilidade ${i + 1}`; input.value = magias[i] || "";
                 input.addEventListener('input', salvarDados); // Add listener here
                 magiasList.appendChild(input);
            }

            anotacoesTextarea.value = ficha.anotacoes || ""; classeNomeInput.value = ficha.classeNome || ""; classeDescricaoInput.value = ficha.classeDescricao || "";
            if (ficha.imagem && ficha.imagem.startsWith('data:image')) { characterImage.src = ficha.imagem; characterImage.style.display = "block"; } else { characterImage.src = ''; characterImage.style.display = "none"; }

            // Load current resource values from DB, default to totals if not present
            vidaAtual = typeof ficha.vidaAtual === 'number' ? ficha.vidaAtual : vidaTotal; // Default to total calculated below
            magiaAtual = typeof ficha.magiaAtual === 'number' ? ficha.magiaAtual : magiaTotal;
            vigorAtual = typeof ficha.vigorAtual === 'number' ? ficha.vigorAtual : vigorTotal;

            atualizarBotaoBloquear();
            // Only update panel displays, don't reset temp selections
             atualizarVantagensDesvantagensPanelDisplay();
             atualizarRacasPanelDisplay();

            experiencia = parseInt(experienciaInput.value) || 0; atualizarNivel(); calcularAtributos(); // Calculate totals

             // Now set current values, ensuring they don't exceed new totals
            vidaAtual = Math.min(vidaAtual, vidaTotal);
            magiaAtual = Math.min(magiaAtual, magiaTotal);
            vigorAtual = Math.min(vigorAtual, vigorTotal);
            getElem("vida-atual").textContent = vidaAtual; getElem("magia-atual").textContent = magiaAtual; getElem("vigor-atual").textContent = vigorAtual.toFixed(1);


            pontosVantagemSpan.textContent = getPontosVantagem();
            previousValues.clear(); document.querySelectorAll('input[type="text"],input[type="number"],textarea').forEach(input => previousValues.set(input, input.value));
            chatPassword = ficha.chatPassword; atualizarEstadoChatBotao();
            aplicarPlanoDeFundoInicial(); aplicarCorDeFundoInicial();

            // Highlight current tab
            Array.from(getElem("fichas-sidebar").querySelectorAll('.ficha-tab')).forEach(tab => tab.classList.toggle('active', tab.dataset.fichaId === fichaId));

            // Reset temporary selections when loading a new sheet
            tempVantagensSelecionadas = [...vantagensSelecionadas];
            tempDesvantagensSelecionadas = [...desvantagensSelecionadas];
            tempRacaSelecionada = racaSelecionada;

        }

        function atualizarBotaoBloquear() { bloquearFichaButton.textContent = isFichaLocked ? "Desbloquear Ficha" : "Bloquear Ficha"; bloquearFichaButton.classList.toggle("botao-bloquear", !isFichaLocked); bloquearFichaButton.classList.toggle("botao-desbloquear", isFichaLocked); }

        function salvarDados() {
            // Debounce save slightly to avoid hammering DB on rapid input
            clearTimeout(window.saveTimeout);
            window.saveTimeout = setTimeout(() => {
                if (!currentFichaId || (isFichaLocked && !isFichaUnlocked && currentFichaId !== 'ficha-matriz' )) return; // Allow saving matrix even if locked conceptually
                const inventario = Array.from(inventarioSlots.querySelectorAll(".inventory-slot")).map(slot => ({ item: slot.querySelector(".inventory-item").value, peso: slot.querySelector(".inventory-weight").value }));
                const magias = Array.from(magiasList.querySelectorAll(".magia-nome")).map(input => input.value);
                const dados = { nomePersonagem: nomePersonagemInput.value, descricaoPersonagem: descricaoPersonagemInput.value, forca: forcaInput.value, destreza: destrezaInput.value, agilidade: agilidadeInput.value, inteligencia: inteligenciaInput.value, constituicao: constituicaoInput.value, experiencia: experienciaInput.value, armaDireitaNome: armaDireitaNomeInput.value, armaDireitaAtaque: armaDireitaAtaqueInput.value, armaDireitaAtaqueMagico: armaDireitaAtaqueMagicoInput.value, armaEsquerdaNome: armaEsquerdaNomeInput.value, armaEsquerdaAtaque: armaEsquerdaAtaqueInput.value, armaEsquerdaAtaqueMagico: armaEsquerdaAtaqueMagicoInput.value, vantagens: vantagensSelecionadas.join("\n"), magiasHabilidades: magias.join("\n"), desvantagens: desvantagensSelecionadas.join("\n"), inventario, velocidadeCorrida: velocidadeCorridaSpan.textContent, alturaPulo: alturaPuloSpan.textContent, distanciaPulo: distanciaPuloSpan.textContent, isLocked: isFichaLocked, password: fichaPassword, imagem: characterImage.src.startsWith('data:image') ? characterImage.src : null, anotacoes: anotacoesTextarea.value, classeNome: classeNomeInput.value, classeDescricao: classeDescricaoInput.value, racaNome: racaNomeSpan.textContent, racaDescricao: racaDescricaoInput.value, racaSelecionada: racaSelecionada, chatPassword: chatPassword, backgroundImage: document.body.style.backgroundImage === 'none' ? null : document.body.style.backgroundImage.slice(5, -2), backgroundSize: document.body.style.backgroundSize, backgroundColor: document.body.style.backgroundColor, vidaAtual: vidaAtual, magiaAtual: magiaAtual, vigorAtual: vigorAtual };

                // Only save if data has actually changed (simple check for now)
                const currentDataString = JSON.stringify(dados);
                if (window.lastSavedDataString !== currentDataString) {
                     database.ref(`fichas/${currentFichaId}`).update(dados).then(() => {
                         showNotification("Salvo!", "save-success");
                         window.lastSavedDataString = currentDataString; // Store last saved state
                         previousValues.clear(); document.querySelectorAll('input[type="text"],input[type="number"],textarea').forEach(input => previousValues.set(input, input.value));
                     }).catch(error => console.error("Erro ao salvar dados:", error));
                }
            }, 500); // Debounce time in ms
        }


        function calcularNivel(exp) { return nivelData.findLast(data => exp >= data.xp)?.nivel ?? 0; }

        function atualizarNivel() {
            nivelAnterior = nivel; nivel = calcularNivel(experiencia); nivelSpan.textContent = nivel;
            pontosHabilidadeTotal = nivelData[nivel]?.pd ?? nivelData[0].pd;
            // Don't directly update pontosVantagemSpan here, getPontosVantagem() is called in carregarFicha and after saves
            if (nivel > nivelAnterior) { nivelSpan.classList.add("aura-azul"); setTimeout(() => nivelSpan.classList.remove("aura-azul"), 20000); }
            gameMasterMessage.style.display = nivel >= 30 ? "block" : "none"; fichaContainer.classList.toggle("aura-azul", nivel >= 30);
            calcularAtributos();
        }

        function getPontosVantagem() {
            let ph = nivelData.find(data => data.nivel === nivel)?.ph ?? nivelData[0].ph;
            vantagensSelecionadas.forEach(v => { const vantagem = vantagensData.find(d => d.nome === v); if (vantagem) ph -= vantagem.custo; });
            desvantagensSelecionadas.forEach(d => { const desvantagem = desvantagensData.find(desv => desv.nome === d); if (desvantagem) ph += desvantagem.ganho; });
            if (racaSelecionada) { const raca = racasData.find(r => r.nome === racaSelecionada); if (raca) ph -= raca.custo; }
            return ph;
        }

        function calcularPontosVantagemTemp() {
            let ph = nivelData.find(data => data.nivel === nivel)?.ph ?? nivelData[0].ph;
            tempVantagensSelecionadas.forEach(v => { const vantagem = vantagensData.find(d => d.nome === v); if (vantagem) ph -= vantagem.custo; });
            tempDesvantagensSelecionadas.forEach(d => { const desvantagem = desvantagensData.find(desv => desv.nome === d); if (desvantagem) ph += desvantagem.ganho; });
            if (tempRacaSelecionada) { const raca = racasData.find(r => r.nome === tempRacaSelecionada); if (raca) ph -= raca.custo; }
            return ph;
        }

        function updateResource(type, delta) {
             if (isFichaLocked && !isFichaUnlocked) return abrirModalSenha(getElem(`${type}-atual`)); // Pass span for context? Or button?
             const currentSpan = getElem(`${type}-atual`);
             const totalValue = (type === 'vigor') ? vigorTotal : (type === 'magia' ? magiaTotal : vidaTotal);
             let currentValue = (type === 'vigor') ? vigorAtual : (type === 'magia' ? magiaAtual : vidaAtual);
             const step = (type === 'vigor') ? 0.1 : 1;

             currentValue += (delta * step);
             currentValue = Math.max(0, Math.min(currentValue, totalValue)); // Clamp between 0 and total

             if (type === 'vigor') { vigorAtual = currentValue; currentSpan.textContent = currentValue.toFixed(1); }
             else if (type === 'magia') { magiaAtual = currentValue; currentSpan.textContent = currentValue; }
             else { vidaAtual = currentValue; currentSpan.textContent = currentValue; }

             salvarDados();
        }

        function aumentarVida() { updateResource('vida', 1); } function diminuirVida() { updateResource('vida', -1); }
        function aumentarMagia() { updateResource('magia', 1); } function diminuirMagia() { updateResource('magia', -1); }
        function aumentarVigor() { updateResource('vigor', 1); } function diminuirVigor() { updateResource('vigor', -1); }


        function calcularAtributos() {
            const forca = parseInt(forcaInput.value) || 0, destreza = parseInt(destrezaInput.value) || 0, agilidade = parseInt(agilidadeInput.value) || 0, inteligencia = parseInt(inteligenciaInput.value) || 0, constituicao = parseInt(constituicaoInput.value) || 0;
            let totalPontos = forca + destreza + agilidade + inteligencia + constituicao;

            // Check if points exceed available *before* reverting values in UI
            if (totalPontos > pontosHabilidadeTotal) {
                 alert("Pontos de habilidade insuficientes!");
                 // Find which input caused the overflow (difficult with direct calculation)
                 // Simple approach: just don't update calculated values, user needs to correct input
                 // Or revert last changed input (requires tracking) - Let's stick to not updating derived stats
                 return;
            }

            pontosHabilidadeUsados = totalPontos; pontosHabilidadeSpan.textContent = pontosHabilidadeTotal - pontosHabilidadeUsados;

            let ataque = forca + Math.floor(destreza / 5), acerto = Math.floor(destreza / 3) + Math.floor(agilidade / 10), esquiva = Math.floor(agilidade / 3), rdf = Math.floor(forca / 5), rdm = Math.floor(inteligencia / 5), ataqueMagico = inteligencia, magiaBase = 20 + 3 * constituicao, vigorBase = 10 + 0.4 * constituicao;
            vidaBase = 50 + (constituicao * (3 + Math.floor(forca / 10))) + 10 * nivel;
            if (inteligencia >= 10) magiaBase += constituicao * Math.floor(inteligencia / 10);

            ataque += (parseInt(armaDireitaAtaqueInput.value) || 0) + (parseInt(armaEsquerdaAtaqueInput.value) || 0);
            ataqueMagico += (parseInt(armaDireitaAtaqueMagicoInput.value) || 0) + (parseInt(armaEsquerdaAtaqueMagicoInput.value) || 0);

            const velocidadeBase = 25 + Math.floor(agilidade / 3) * 3, alturaPuloBase = 1 + Math.floor(forca / 10), distanciaPuloBase = 3 + 3 * Math.min(Math.floor(forca / 5), Math.floor(agilidade / 5));
            let bonusVelocidade = vantagensSelecionadas.includes("Combo Físico (4)") ? 25 : 0, bonusAlturaPulo = vantagensSelecionadas.includes("Combo Físico (4)") ? 2 : 0, bonusDistanciaPulo = vantagensSelecionadas.includes("Combo Físico (4)") ? 6 : 0;

            velocidadeCorridaSpan.textContent = velocidadeBase + bonusVelocidade; alturaPuloSpan.textContent = alturaPuloBase + bonusAlturaPulo; distanciaPuloSpan.textContent = distanciaPuloBase + bonusDistanciaPulo;
            ataqueSpan.textContent = ataque; ataqueMagicoSpan.textContent = ataqueMagico; acertoSpan.textContent = acerto; esquivaSpan.textContent = esquiva; rdfSpan.textContent = rdf; rdmSpan.textContent = rdm;
            vidaTotal = Math.ceil(vidaBase); magiaTotal = Math.ceil(magiaBase); vigorTotal = parseFloat(vigorBase.toFixed(1));

            getElem("vida-total").textContent = vidaTotal; getElem("magia-total").textContent = magiaTotal; getElem("vigor-total").textContent = vigorTotal.toFixed(1);
            // Clamp current values if totals decreased
            vidaAtual = Math.min(vidaAtual, vidaTotal); magiaAtual = Math.min(magiaAtual, magiaTotal); vigorAtual = Math.min(vigorAtual, vigorTotal);
            getElem("vida-atual").textContent = vidaAtual; getElem("magia-atual").textContent = magiaAtual; getElem("vigor-atual").textContent = vigorAtual.toFixed(1);

            const regeneracaoVida = (0.2 * constituicao).toFixed(1), regeneracaoMagia = (0.8 * constituicao).toFixed(1), regeneracaoVigor = (0.4 * constituicao).toFixed(1);
            getElem("regeneracao-vida").textContent = regeneracaoVida; getElem("regeneracao-magia").textContent = regeneracaoMagia; getElem("regeneracao-vigor").textContent = regeneracaoVigor;

            const atributos = [{ span: ataqueSpan, valor: ataque }, { span: ataqueMagicoSpan, valor: ataqueMagico }, { span: acertoSpan, valor: acerto }, { span: esquivaSpan, valor: esquiva }, { span: rdfSpan, valor: rdf }, { span: rdmSpan, valor: rdm }];
            atributos.forEach(a => a.span.classList.remove("atributo-fogo"));
            const maxAtributo = atributos.reduce((prev, curr) => prev.valor > curr.valor ? prev : curr, { valor: 0 });
            if (maxAtributo.valor > 0 && maxAtributo.span) maxAtributo.span.classList.add("atributo-fogo"); // Add null check for span
        }


        // --- Event Listeners ---
        resetPontosButton.onclick = resetarPontos;
        recomecarButton.onclick = recomecarFicha;
        bloquearFichaButton.onclick = () => { if (isFichaLocked) abrirModalSenha(); else { getElem("bloquear-ficha-modal").style.display = "flex"; getElem("senha-bloqueio-input").value = ""; getElem("senha-bloqueio-input").focus(); } };
        document.querySelectorAll('input[type="text"],input[type="number"],textarea').forEach(input => {
             input.addEventListener("focus", (event) => { previousValues.set(event.target, event.target.value); });
             input.addEventListener("input", (event) => {
                 const inputTarget = event.target;
                 if (isFichaLocked && !isFichaUnlocked && currentFichaId !== 'ficha-matriz') { // Allow editing matrix
                     inputTarget.value = previousValues.get(inputTarget) || ""; abrirModalSenha(inputTarget);
                 } else {
                     previousValues.set(inputTarget, inputTarget.value); // Update prev value on allowed change
                     if (inputTarget.id === "experiencia") { experiencia = parseInt(inputTarget.value) || 0; atualizarNivel(); }
                     else if (atributosInputs.includes(inputTarget)) { calcularAtributos(); }
                     else if (inputTarget.id.includes("arma")) { calcularAtributos(); }
                     else if (inputTarget.classList.contains('inventory-weight')) { calcularPesoTotal(); }
                     salvarDados();
                 }
             });
        });
         nomePersonagemInput.addEventListener('input', salvarDados); // Ensure name saves too

        characterImageInput.onchange = e => { const file = e.target.files[0]; if (file) { const reader = new FileReader(); reader.onload = e => { characterImage.src = e.target.result; characterImage.style.display = "block"; salvarDados(); }; reader.readAsDataURL(file); } };
        getElem("excluir-ficha").onclick = () => { if (currentFichaId === "ficha-matriz") return alert("A ficha matriz não pode ser excluída!"); if (isFichaLocked && !isFichaUnlocked) return abrirModalSenha(getElem("excluir-ficha")); if (confirm("Tem certeza que deseja excluir esta ficha?")) database.ref(`fichas/${currentFichaId}`).remove().then(() => { currentFichaId = "ficha-matriz"; carregarFicha(currentFichaId); /* onValue handles tab update */ }); };

        // Dice Dragging
         let isDragging = false, currentX = 0, currentY = 0, initialX, initialY;
         document.addEventListener('DOMContentLoaded', () => { currentX = diceContainer.offsetLeft; currentY = diceContainer.offsetTop; });
         diceContainer.onmousedown = e => { if (e.target === diceContainer || e.target === diceContainer.querySelector('label')) { isDragging = true; initialX = e.clientX - currentX; initialY = e.clientY - currentY; diceContainer.style.cursor = "grabbing"; } }; // Only drag container/label
         document.onmousemove = e => { if (isDragging) { e.preventDefault(); currentX = e.clientX - initialX; currentY = e.clientY - initialY; diceContainer.style.left = `${currentX}px`; diceContainer.style.top = `${currentY}px`; diceContainer.style.right = "auto"; } };
         document.onmouseup = () => { if(isDragging) {isDragging = false; diceContainer.style.cursor = "move";} };

        // Dice Roll
         database.ref('dadosRolados').on('child_added', snapshot => { const dado = snapshot.val(); if (dado.fichaId !== currentFichaId) showNotification(`${dado.nomeFicha} rolou: ${dado.resultado}`, "normal-result"); });
         diceRoll.onclick = () => { if (isFichaLocked && !isFichaUnlocked) return abrirModalSenha(diceRoll); diceRoll.textContent = "Rolling..."; diceResult.style.display = "none"; diceRoll.classList.remove("critical-failure", "critical-success"); setTimeout(() => { const roll = Math.floor(Math.random() * 20) + 1, fichaNome = fichas[currentFichaId]?.nomeFicha || "Sem Nome"; diceRoll.textContent = roll; let notificationClass = "normal-result", notificationMsg = `${fichaNome} rolou: ${roll}`; if (roll === 1) { diceRoll.classList.add("critical-failure"); notificationClass = "critical-failure"; notificationMsg = `${fichaNome} - FALHA CRÍTICA!`; } else if (roll === 20) { diceRoll.classList.add("critical-success"); notificationClass = "critical-success"; notificationMsg = `${fichaNome} - SUCESSO CRÍTICO!`; } else { diceResult.textContent = notificationMsg; diceResult.style.display = "block"; } showNotification(notificationMsg, notificationClass); const dadoRef = database.ref('dadosRolados').push(); dadoRef.set({ fichaId: currentFichaId, nomeFicha: fichaNome, resultado: roll }); }, 1000); };

        // Vantagens/Desvantagens Panel Logic
        vantagensDesvantagensBtn.onclick = () => { if (isFichaLocked && !isFichaUnlocked) return abrirModalSenha(vantagensDesvantagensBtn); tempVantagensSelecionadas = [...vantagensSelecionadas]; tempDesvantagensSelecionadas = [...desvantagensSelecionadas]; vantagensDesvantagensPanel.style.display = "block"; getElem("salvar-vantagens-btn").style.display = "none"; atualizarVantagensDesvantagensPanelDisplay(); }; // Changed name
        fecharPaginaBtn.onclick = () => { vantagensDesvantagensPanel.style.display = "none"; };
        salvarVantagensBtn.onclick = () => { getElem("salvar-modal-texto").textContent = "Se salvar, as alterações de Vantagens/Desvantagens não poderão ser desfeitas."; getElem("salvar-vantagens-modal").style.display = "flex"; };

         // Function to update only the display of advantages/disadvantages panel
         function atualizarVantagensDesvantagensPanelDisplay() {
             vantagensList.innerHTML = "<h3>Vantagens</h3>"; desvantagensList.innerHTML = "<h3>Desvantagens</h3>";
             vantagensData.forEach(v => { const div = document.createElement("div"); div.className = "vantagem-item"; div.textContent = `${v.nome} - Custo: ${v.custo} PH - ${v.descricao}`; if (tempVantagensSelecionadas.includes(v.nome)) div.classList.add("comprada"); div.onclick = () => { if (vantagensSelecionadas.includes(v.nome)) alert("Vantagem salva só pode ser removida com permissão do GM."); else if (tempVantagensSelecionadas.includes(v.nome)) tempVantagensSelecionadas = tempVantagensSelecionadas.filter(t => t !== v.nome); else { if (v.restricao === "inicio" && nivel > 0) return alert("Compra dessa vantagem é somente no nível 0."); if ((calcularPontosVantagemTemp() - v.custo) >= 0) tempVantagensSelecionadas.push(v.nome); else alert("PH insuficientes!"); } atualizarVantagensDesvantagensPanelDisplay(); getElem("salvar-vantagens-btn").style.display = JSON.stringify(tempVantagensSelecionadas.sort()) !== JSON.stringify(vantagensSelecionadas.sort()) || JSON.stringify(tempDesvantagensSelecionadas.sort()) !== JSON.stringify(desvantagensSelecionadas.sort()) ? 'block' : 'none'; }; vantagensList.appendChild(div); }); // Compare sorted arrays for change detection
             desvantagensData.forEach(d => { const div = document.createElement("div"); div.className = "desvantagem-item"; div.textContent = `${d.nome} - Ganho: ${d.ganho} PH - ${d.descricao}`; if (tempDesvantagensSelecionadas.includes(d.nome)) div.classList.add("comprada"); div.onclick = () => { if (desvantagensSelecionadas.includes(d.nome)) alert("Desvantagem salva só pode ser removida com permissão do GM."); else if (tempDesvantagensSelecionadas.includes(d.nome)) tempDesvantagensSelecionadas = tempDesvantagensSelecionadas.filter(t => t !== d.nome); else { if (tempDesvantagensSelecionadas.length < 3) tempDesvantagensSelecionadas.push(d.nome); else alert("Limite de 3 desvantagens!"); } atualizarVantagensDesvantagensPanelDisplay(); getElem("salvar-vantagens-btn").style.display = JSON.stringify(tempVantagensSelecionadas.sort()) !== JSON.stringify(vantagensSelecionadas.sort()) || JSON.stringify(tempDesvantagensSelecionadas.sort()) !== JSON.stringify(desvantagensSelecionadas.sort()) ? 'block' : 'none'; }; desvantagensList.appendChild(div); }); // Compare sorted arrays
             getElem("ph-temp").textContent = calcularPontosVantagemTemp();
         }


        // Raças Panel Logic
        racasBtn.onclick = () => { if (isFichaLocked && !isFichaUnlocked) return abrirModalSenha(racasBtn); tempRacaSelecionada = racaSelecionada; atualizarRacasPanelDisplay(); racasPanel.style.display = "block"; getElem("salvar-racas-btn").style.display = "none"; };
        fecharRacasBtn.onclick = () => { racasPanel.style.display = "none"; };
        salvarRacasBtn.onclick = () => { getElem("salvar-modal-texto").textContent = "Se salvar, a alteração de Raça não poderá ser desfeita."; getElem("salvar-vantagens-modal").style.display = "flex"; };

         // Function to update only the race panel display
         function atualizarRacasPanelDisplay() {
             racasList.innerHTML = ""; racasData.forEach(r => { const div = document.createElement("div"); div.className = "raca-item"; div.innerHTML = `<h3>${r.nome}</h3><p>${r.descricao}</p><p><strong>Vantagens:</strong></p><ul>${r.vantagens.map(v => `<li>${v}</li>`).join("")}</ul>`; if (tempRacaSelecionada === r.nome) div.classList.add("comprada");
                 div.onclick = () => {
                     if (racaSelecionada && racaSelecionada !== r.nome) alert("Raça salva só pode ser alterada com permissão do GM.");
                     else if (tempRacaSelecionada === r.nome) { tempRacaSelecionada = null; } // Desselect
                     else { // Try to select
                         let phAvailableForNewRace = calcularPontosVantagemTemp() + (tempRacaSelecionada ? (racasData.find(ra => ra.nome === tempRacaSelecionada)?.custo || 0) : 0); // Calculate PH without current temp race
                         if (phAvailableForNewRace >= r.custo) {
                             tempRacaSelecionada = r.nome;
                             getElem("confirmar-compra-modal").style.display = "flex";
                             getElem("confirmar-compra-btn").onclick = () => { // Confirmation needed
                                 atualizarRacasPanelDisplay(); // Update display immediately after confirm
                                 getElem("salvar-racas-btn").style.display = "block"; // Enable save
                                 fecharModal("confirmar-compra-modal");
                             };
                             return; // Don't update display yet, wait for confirmation
                         } else { alert("PH insuficientes!"); tempRacaSelecionada = null; }
                     }
                     atualizarRacasPanelDisplay(); // Update display on direct deselect or if selection fails PH check
                     getElem("salvar-racas-btn").style.display = tempRacaSelecionada && tempRacaSelecionada !== racaSelecionada ? "block" : "none";
                 }; racasList.appendChild(div);
             });
             phTempRacaSpan.textContent = calcularPontosVantagemTemp();
         }

         // Combined Save Logic (Handles both panels)
         confirmarSalvarBtn.onclick = () => {
             if (racasPanel.style.display === "block") { // Save from Races panel
                 if (tempRacaSelecionada !== racaSelecionada) { // Check if selection actually changed
                     const raca = racasData.find(r => r.nome === tempRacaSelecionada);
                      // Final PH check for the committed state
                     if (calcularPontosVantagemTemp() >= 0) {
                         racaSelecionada = tempRacaSelecionada;
                         racaNomeSpan.textContent = racaSelecionada ? racaSelecionada.split(" (")[0] : "";
                         racaDescricaoInput.value = raca ? raca.vantagens.join("\n\n") : "";
                         salvarDados();
                         pontosVantagemSpan.textContent = getPontosVantagem();
                         racasPanel.style.display = "none"; fecharModal("salvar-vantagens-modal"); calcularAtributos();
                     } else { alert("Pontos de Vantagem insuficientes para confirmar esta seleção!"); fecharModal("salvar-vantagens-modal"); }
                 } else { racasPanel.style.display = "none"; fecharModal("salvar-vantagens-modal"); } // No change, just close
             } else { // Save from Advantages/Disadvantages panel
                 if (tempDesvantagensSelecionadas.length > 3) { alert("Você pode ter no máximo 3 desvantagens!"); return fecharModal("salvar-vantagens-modal"); }
                 if (calcularPontosVantagemTemp() < 0) { alert("Pontos de Vantagem insuficientes com as vantagens selecionadas!"); return fecharModal("salvar-vantagens-modal"); }
                 vantagensSelecionadas = [...tempVantagensSelecionadas]; desvantagensSelecionadas = [...tempDesvantagensSelecionadas];
                 vantagensListDisplay.innerHTML = ""; desvantagensListDisplay.innerHTML = "";
                 vantagensSelecionadas.forEach(v => { const div = document.createElement("div"); div.textContent = v; div.className = "list-item"; div.onclick = () => removerVantagem(v); vantagensListDisplay.appendChild(div); });
                 desvantagensSelecionadas.forEach(d => { const div = document.createElement("div"); div.textContent = d; div.className = "list-item"; div.onclick = () => removerDesvantagem(d); desvantagensListDisplay.appendChild(div); });
                 pontosVantagemSpan.textContent = getPontosVantagem(); salvarDados(); vantagensDesvantagensPanel.style.display = "none"; fecharModal("salvar-vantagens-modal"); calcularAtributos();
             }
         };


        // Other Functions (Removals, Edits, etc. - keep as before, ensuring modals are called)
        function removerVantagem(v) { if (isFichaLocked && !isFichaUnlocked) return abrirModalSenha(); if (confirm(`Deseja remover a vantagem "${v}"?`)) { getElem("senha-gm-modal").style.display = "flex"; getElem("senha-gm-input").value = ""; getElem("confirmar-senha-gm-btn").onclick = () => { if (getElem("senha-gm-input").value === senhaMatriz) { vantagensSelecionadas = vantagensSelecionadas.filter(t => t !== v); Array.from(vantagensListDisplay.children).find(div => div.textContent === v)?.remove(); pontosVantagemSpan.textContent = getPontosVantagem(); database.ref(`fichas/${currentFichaId}/vantagens`).set(vantagensSelecionadas.join("\n")); fecharModal("senha-gm-modal"); calcularAtributos(); } else { alert("Senha do GM incorreta!"); fecharModal("senha-gm-modal"); } }; } }
        function removerDesvantagem(d) { if (isFichaLocked && !isFichaUnlocked) return abrirModalSenha(); if (confirm(`Deseja remover a desvantagem "${d}"?`)) { getElem("senha-gm-modal").style.display = "flex"; getElem("senha-gm-input").value = ""; getElem("confirmar-senha-gm-btn").onclick = () => { if (getElem("senha-gm-input").value === senhaMatriz) { desvantagensSelecionadas = desvantagensSelecionadas.filter(t => t !== d); Array.from(desvantagensListDisplay.children).find(div => div.textContent === d)?.remove(); pontosVantagemSpan.textContent = getPontosVantagem(); database.ref(`fichas/${currentFichaId}/desvantagens`).set(desvantagensSelecionadas.join("\n")); fecharModal("senha-gm-modal"); calcularAtributos(); } else { alert("Senha do GM incorreta!"); fecharModal("senha-gm-modal"); } }; } }
        function abrirModalRaca() { getElem("raca-opcoes-modal").style.display = "flex"; }
        function excluirRacaSelecionadaModal() { fecharModal('raca-opcoes-modal'); if (isFichaLocked && !isFichaUnlocked) return abrirModalSenha(); if (confirm("Tem certeza que deseja excluir a raça selecionada?")) { getElem("senha-gm-modal").style.display = "flex"; getElem("senha-gm-input").value = ""; getElem("confirmar-senha-gm-btn").onclick = () => { if (getElem("senha-gm-input").value === senhaMatriz) { racaSelecionada = null; tempRacaSelecionada = null; racaNomeSpan.textContent = ""; racaDescricaoInput.value = ""; pontosVantagemSpan.textContent = getPontosVantagem(); salvarDados(); fecharModal("senha-gm-modal"); calcularAtributos(); } else { alert("Senha do GM incorreta!"); fecharModal("senha-gm-modal"); } }; } }
        function editarRacaSelecionadaModal() { if (isFichaLocked && !isFichaUnlocked) return abrirModalSenha(); fecharModal('raca-opcoes-modal'); getElem("editar-raca-modal").style.display = "flex"; getElem("editar-raca-nome").value = racaNomeSpan.textContent; getElem("editar-raca-descricao").value = racaDescricaoInput.value; }
        function salvarEdicaoRaca() { if (isFichaLocked && !isFichaUnlocked) return abrirModalSenha(); if (confirm("Tem certeza que deseja editar a raça selecionada?")) { getElem("senha-gm-modal").style.display = "flex"; getElem("senha-gm-input").value = ""; getElem("confirmar-senha-gm-btn").onclick = () => { if (getElem("senha-gm-input").value === senhaMatriz) { racaNomeSpan.textContent = getElem("editar-raca-nome").value; racaDescricaoInput.value = getElem("editar-raca-descricao").value; fecharModal('editar-raca-modal'); salvarDados(); fecharModal("senha-gm-modal"); } else { alert("Senha do GM incorreta!"); fecharModal("senha-gm-modal"); } }; } }
        classesBtn.onclick = () => { classesPanel.style.display = "block"; }; fecharClassesBtn.onclick = () => { classesPanel.style.display = "none"; };
        luaBtn.onclick = () => { document.body.classList.add("dark-mode"); salvarDados(); }; solBtn.onclick = () => { document.body.classList.remove("dark-mode"); salvarDados(); };

        // Other utility functions (notifications, history, chat, background) - Keep as before
         function showNotification(message, type) { notification.textContent = message; notification.className = type; notification.style.display = "block"; setTimeout(() => { notification.style.display = "none"; notification.className = ""; }, 2000); }
         getElem("historico-dados-btn").onclick = () => { getElem("historico-dados-panel").style.display = "block"; }; document.addEventListener('click', (event) => { const panel = getElem("historico-dados-panel"); if (panel.style.display === "block" && !panel.contains(event.target) && !getElem("historico-dados-btn").contains(event.target)) panel.style.display = "none"; }); database.ref('dadosRolados').on('value', snapshot => { const dados = snapshot.val(), lista = getElem("historico-lista"); lista.innerHTML = ""; if (dados) { const keys = Object.keys(dados).reverse(); keys.forEach(key => { const dado = dados[key], div = document.createElement("div"); div.textContent = `${dado.nomeFicha} rolou: ${dado.resultado}`; lista.appendChild(div); });} }); getElem("excluir-historico-btn").onclick = () => { getElem("senha-gm-modal").style.display = "flex"; getElem("senha-gm-input").value = ""; getElem("confirmar-senha-gm-btn").onclick = () => { if (getElem("senha-gm-input").value === senhaMatriz) { database.ref('dadosRolados').remove().then(() => { alert("Histórico de dados excluído!"); fecharModal("senha-gm-modal"); }); } else { alert("Senha do GM incorreta!"); fecharModal("senha-gm-modal"); } }; };
         chatBtn.onclick = () => { if (!chatPassword) { getElem("chat-password-modal").style.display = "flex"; } else { getElem("open-chat-modal").style.display = "flex"; } }; function definirSenhaChat() { const senha = getElem("chat-senha-input").value, confirmarSenha = getElem("chat-confirmar-senha-input").value; if (senha !== confirmarSenha) return alert("As senhas não coincidem."); if (senha.length < 4) return alert("A senha deve ter pelo menos 4 caracteres."); chatPassword = senha; database.ref(`fichas/${currentFichaId}`).update({ chatPassword: senha }).then(() => { fecharModal("chat-password-modal"); alert("Senha do chat definida!"); atualizarEstadoChatBotao(); }).catch(error => console.error("Erro ao definir senha do chat:", error)); } function abrirChat() { const senhaDigitada = getElem("abrir-chat-senha-input").value; if (senhaDigitada === chatPassword) { fecharModal("open-chat-modal"); getElem("chat-modal").style.display = "flex"; isChatOpen = true; selectedChatUser = null; getElem("conversation-area").innerHTML = ""; marcarMensagensComoLidas(); } else { alert("Senha do chat incorreta."); } } function atualizarEstadoChatBotao() { chatBtn.textContent = chatPassword ? "💬 Chat" : "💬 Definir Chat"; } function atualizarListaFichasChat() { availableFichasDiv.innerHTML = ""; for (const fichaId in fichas) { if (fichaId !== "ficha-matriz" && fichaId !== currentFichaId) { const ficha = fichas[fichaId], userDiv = document.createElement("div"); userDiv.className = "user-item"; userDiv.textContent = ficha.nomeFicha || "Sem Nome"; userDiv.dataset.fichaId = fichaId; userDiv.onclick = () => iniciarConversa(fichaId, ficha.nomeFicha || "Sem Nome"); availableFichasDiv.appendChild(userDiv); } } } function iniciarConversa(otherFichaId, otherFichaNome) { selectedChatUser = otherFichaId; getElem("conversation-area").innerHTML = `<h3 style='text-align: center; font-family: MedievalSharp, serif;'>Conversa com ${otherFichaNome}</h3><div id="mensagens" style="flex-grow: 1; overflow-y: auto; display: flex; flex-direction: column-reverse;"></div>`; carregarMensagens(otherFichaId); marcarMensagensComoLidas(otherFichaId); } function enviarMensagem() { if (!selectedChatUser) return alert("Selecione uma ficha para enviar a mensagem."); const mensagem = mensagemInput.value.trim(); if (mensagem) { const chatRef = database.ref('mensagens').child(getChatId(currentFichaId, selectedChatUser)).push(); chatRef.set({ senderId: currentFichaId, receiverId: selectedChatUser, content: mensagem, timestamp: firebase.database.ServerValue.TIMESTAMP, read: false }); mensagemInput.value = ""; } } function carregarMensagens(otherFichaId) { const mensagensDiv = getElem("mensagens"); mensagensDiv.innerHTML = ''; database.ref('mensagens').child(getChatId(currentFichaId, otherFichaId)).orderByChild('timestamp').on('child_added', snapshot => { const msgData = snapshot.val(), msgContainer = document.createElement("div"); msgContainer.className = "message-container"; const senderName = document.createElement("div"); senderName.className = "sender-name"; senderName.textContent = fichas[msgData.senderId]?.nomeFicha || 'Desconhecido'; const msgDiv = document.createElement("div"); msgDiv.className = `message ${msgData.senderId === currentFichaId ? 'sent' : 'received'}`; msgDiv.textContent = msgData.content; msgContainer.appendChild(senderName); msgContainer.appendChild(msgDiv); mensagensDiv.insertBefore(msgContainer, mensagensDiv.firstChild); }); } function getChatId(id1, id2) { return id1 < id2 ? `${id1}_${id2}` : `${id2}_${id1}`; } function marcarMensagensComoLidas(otherUserId = null) { if (!currentFichaId) return; database.ref('mensagens').once('value', (snapshot) => { const updates = {}; snapshot.forEach((chat) => { const chatId = chat.key; if (chatId.includes(currentFichaId)) { const otherId = chatId.replace(currentFichaId, '').replace('_', ''); if (!otherUserId || otherId === otherUserId) { chat.forEach((msgSnapshot) => { const msg = msgSnapshot.val(); if (msg.receiverId === currentFichaId && msg.senderId !== currentFichaId && !msg.read) { updates[`${chatId}/${msgSnapshot.key}/read`] = true; } }); } } }); if (Object.keys(updates).length > 0) database.ref('mensagens').update(updates); }); } function verificarNovasMensagens() { if (!currentFichaId) return; database.ref('mensagens').on('value', (snapshot) => { let unreadCount = 0; let shouldPlaySound = false; snapshot.forEach((chat) => { const chatId = chat.key; if (chatId.includes(currentFichaId)) { chat.forEach((msgSnapshot) => { const msg = msgSnapshot.val(); if (msg.receiverId === currentFichaId && msg.senderId !== currentFichaId && !msg.read) { unreadCount++; if (!isChatOpen || (isChatOpen && selectedChatUser !== msg.senderId)) { shouldPlaySound = true; } } }); } }); chatBtn.dataset.unread = unreadCount > 0 ? unreadCount : 0; chatBtn.style.setProperty('--unread-count', `"${unreadCount}"`); if (shouldPlaySound && getElem("new-message-sound")) { newMessageSound.play().catch(e => console.log("Erro ao tocar som:", e)); } }); }
         planoFundoBtn.onclick = () => { backgroundModal.style.display = "flex"; }; function aplicarPlanoDeFundo() { const file = backgroundImageInput.files[0]; if (file) { const reader = new FileReader(); reader.onload = e => { const imageUrl = e.target.result; document.body.style.backgroundImage = `url('${imageUrl}')`; const selectedSize = document.querySelector('input[name="background-size"]:checked').value; document.body.style.backgroundSize = selectedSize; salvarDados(); fecharModal('background-modal'); }; reader.readAsDataURL(file); } else if (document.body.style.backgroundImage !== 'none') { const selectedSize = document.querySelector('input[name="background-size"]:checked').value; document.body.style.backgroundSize = selectedSize; salvarDados(); fecharModal('background-modal'); } else { alert("Nenhuma imagem selecionada."); } } function excluirPlanoDeFundo() { if (confirm("Remover imagem de fundo?")) { document.body.style.backgroundImage = 'none'; salvarDados(); fecharModal('background-modal'); } } function aplicarPlanoDeFundoInicial() { const bgImage = fichas[currentFichaId]?.backgroundImage; const bgSize = fichas[currentFichaId]?.backgroundSize || 'cover'; if (currentFichaId && fichas[currentFichaId] && bgImage) { document.body.style.backgroundImage = `url('${bgImage}')`; document.body.style.backgroundSize = bgSize; } else { document.body.style.backgroundImage = 'none'; } }
         corFundoBtn.onclick = () => { backgroundColorSelector.style.display = backgroundColorSelector.style.display === 'none' || backgroundColorSelector.style.display === '' ? 'flex' : 'none'; }; backgroundColorSelector.addEventListener('click', (event) => { if (event.target.classList.contains('color-option')) { const color = event.target.dataset.color; document.body.style.backgroundColor = color; salvarDados(); backgroundColorSelector.style.display = 'none'; document.querySelectorAll('#background-color-selector .color-option').forEach(option => option.classList.remove('active')); event.target.classList.add('active'); } }); function aplicarCorDeFundoInicial() { const bgColor = fichas[currentFichaId]?.backgroundColor; if (currentFichaId && fichas[currentFichaId] && bgColor) { document.body.style.backgroundColor = bgColor; document.querySelectorAll('#background-color-selector .color-option').forEach(option => { option.classList.toggle('active', option.dataset.color === bgColor); }); } else { document.body.style.backgroundColor = '#f0e6d2'; } } document.addEventListener('click', function(event) { if (!backgroundColorSelector.contains(event.target) && !corFundoBtn.contains(event.target)) { backgroundColorSelector.style.display = 'none'; } });

        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
             criarFichaMatriz(); // This will load data or create matrix
        });

    </script>
</body>
</html>
