html
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ficha de Personagem RPG</title>
    <link href="https://fonts.googleapis.com/css2?family=MedievalSharp&family=Inter:wght@400;600&family=Times+New+Roman&family=Arial&family=Courier+New&family=Georgia&family=Verdana&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --flash-color: rgba(255, 215, 0, 0.5); /* Dourado para o flash */
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0e6d2;
            color: #000;
            display: flex;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            background-image: none;
            background-size: cover;
            background-position: center;
            transition: background 0.3s, color 0.3s, font-family 0.3s;
        }
        body.dark-mode {
            background-color: #121212 !important;
            color: #e0e0e0;
        }
        #fichas-sidebar {
            width: 100%; height: 60px; padding: 0; display: flex; flex-direction: row;
            align-items: center; justify-content: flex-start; position: fixed;
            top: 0; left: 0; z-index: 1050; 
            overflow-x: auto; background: transparent;
        }
        .ficha-tab {
            visibility: visible; width: 100px; height: 50px; background: #f0e6d2;
            border: 2px solid #b8860b; border-radius: 10px 10px 0 0; margin-right: 10px;
            display: flex; align-items: center; justify-content: center; cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.2);
        }
        .ficha-tab:hover, .ficha-tab.active { background: #a0522d; transform: translateY(-5px); }
        .ficha-tab span {
            font-family: 'MedievalSharp', serif; color: #000; font-size: 0.9rem; text-align: center;
            max-width: 90px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
        }
        #add-ficha-btn {
            width: 100px; height: 50px; background: #f0e6d2; border: 2px solid #b8860b;
            border-radius: 10px 10px 0 0; margin-right: 10px; display: flex; align-items: center;
            justify-content: center; cursor: pointer; transition: transform 0.2s ease;
            box-shadow: 0 0 10px #ffd700, 0 0 20px #ffd700; z-index: 1051;
        }
        #add-ficha-btn span { font-family: 'MedievalSharp', serif; color: #000; font-size: 0.9rem; }
        #add-ficha-btn:hover { background: #a0522d; transform: translateY(-5px); }
        #ficha-container {
            background: rgba(240, 230, 210, 0.95); padding: 30px; border-radius: 12px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2); width: 95%; max-width: 1200px;
            margin: 80px auto 20px; border: 2px solid #b8860b; position: relative; z-index: 1;
            transition: font-family 0.3s;
        }
        body.dark-mode #ficha-container { background: rgba(30, 30, 30, 0.95); color: #e0e0e0; }
        #ficha-container.aura-azul { box-shadow: 0 0 30px 15px #00BFFF; animation: pulsar-aura 2s infinite; }
        @keyframes pulsar-aura {
            0% { box-shadow: 0 0 20px #00BFFF, 0 0 30px #00BFFF, 0 0 40px #00BFFF; }
            50% { box-shadow: 0 0 30px #00BFFF, 0 0 50px #00BFFF, 0 0 60px #00BFFF; }
            100% { box-shadow: 0 0 20px #00BFFF, 0 0 30px #00BFFF, 0 0 40px #00BFFF; }
        }
        h1#nome-personagem-titulo {
            font-family: 'MedievalSharp', serif; color: #1C2526; font-size: 3rem; margin-bottom: 20px;
            text-align: center; text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1); animation: raios 2s infinite linear;
        }
        body.dark-mode h1#nome-personagem-titulo { color: #e0e0e0; }
        @keyframes raios {
            0% { text-shadow: 0 0 5px #FFD700, 0 0 10px #FFD700, 0 0 15px #FFD700, 0 0 20px #FF4500; }
            50% { text-shadow: 0 0 10px #FFD700, 0 0 15px #FFD700, 0 0 20px #FF4500, 0 0 25px #FF4500; }
            100% { text-shadow: 0 0 5px #FFD700, 0 0 10px #FFD700, 0 0 15px #FFD700, 0 0 20px #FF4500; }
        }
        #game-master-message { display: none; color: blue; font-size: 1.5rem; text-align: center; font-family: 'MedievalSharp', serif; margin-bottom: 10px; }
        
        section { background: #f0e6d2; border: 2px solid #b8860b; border-radius: 8px; padding: 15px; margin-bottom: 20px; }
        section h2 { 
            text-align: center; font-family: 'MedievalSharp', serif; cursor: pointer; 
            display: flex; align-items: center; justify-content: center;
            position: relative;
        }
        section h2 .collapse-icon { margin-left: 10px; font-size: 1.2rem; transition: transform 0.2s; }
        section h2 .section-order-buttons { margin-left: auto; display: flex; gap: 5px;}
        section h2 .order-btn { font-size: 1rem; padding: 2px 5px; background: #c8a076; border-radius: 3px; line-height: 1; }
        section h2 .order-btn:hover { background: #b8860b; }
        body.dark-mode section h2 .order-btn { background: #554433; }
        body.dark-mode section h2 .order-btn:hover { background: #6b5230; }

        section .section-content.collapsed { display: none; }
        section h2 .collapse-icon.collapsed { transform: rotate(-90deg); }

        body.dark-mode section { background: #1e1e1e; border-color: #444; }
        label { font-weight: 600; color: #000; margin-bottom: 8px; display: block; }
        body.dark-mode label { color: #e0e0e0; }
        input[type="text"], input[type="number"], textarea {
            padding: 10px; border: 2px solid #b8860b; border-radius: 6px; width: calc(100% - 24px);
            margin-bottom: 15px; font-size: 1rem; transition: border-color 0.3s ease;
            background: #fff; color: #000;
        }
        body.dark-mode input[type="text"], body.dark-mode input[type="number"], body.dark-mode textarea {
            background: #333; color: #e0e0e0; border-color: #555;
        }
        input[type="text"]:focus, input[type="number"]:focus, textarea:focus {
            border-color: #a0522d; outline: none; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        input[readonly], span[readonly] { background: #e8e8e8; border: 1px solid #ccc; cursor: not-allowed; }
        body.dark-mode input[readonly], body.dark-mode span[readonly] { background: #444; border-color: #666; }
        textarea { resize: vertical; }
        .atributos-container { display: flex; justify-content: space-between; gap: 20px; }
        .atributos-coluna, .atributos-coluna-destaque {
            width: 48%; display: flex; flex-direction: column; align-items: flex-start;
        }
        .atributos-coluna-destaque { background: #fff; padding: 10px; border-radius: 6px; border: 1px solid #b8860b; }
        body.dark-mode .atributos-coluna-destaque { background: #333; border-color: #555; }
        .atributo-destaque { padding: 8px; margin-bottom: 10px; display: flex; align-items: center; justify-content: space-between; width: 100%; }
        .atributo-destaque label { font-size: 1.1rem; font-weight: 700; color: #a0522d; cursor: help; }
        .atributo-destaque span { font-size: 1.2rem; font-family: 'MedievalSharp', serif; color: #000; }
        body.dark-mode .atributo-destaque span { color: #e0e0e0; }
        .atributo-fogo { animation: fogo 1.5s infinite; }
        @keyframes fogo {
            0% { text-shadow: 0 0 5px #ff4500, 0 0 10px #ff4500; }
            50% { text-shadow: 0 0 10px #ff4500, 0 0 15px #ffd700; }
            100% { text-shadow: 0 0 5px #ff4500, 0 0 10px #ff4500; }
        }
        .vida-magia-vigor { display: flex; justify-content: space-around; gap: 15px; flex-wrap: wrap; }
        .atributo-container {
            background: rgba(255, 255, 255, 0.8); padding: 12px; border-radius: 8px; border: 1px solid #b8860b;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); width: 30%; min-width: 200px; text-align: center;
        }
        body.dark-mode .atributo-container { background: rgba(50, 50, 50, 0.8); }
        .atributo-container::before { font-size: 1.5rem; margin-bottom: 5px; display: block; }
        .atributo-container.vida::before { content: "‚ù§Ô∏è"; }
        .atributo-container.magia::before { content: "‚ú®"; }
        .atributo-container.vigor::before { content: "‚ö°"; }
        .medieval-box { background: #f0e6d2; border: 2px solid #b8860b; border-radius: 8px; padding: 10px; margin: 5px 0; text-align: center; }
        body.dark-mode .medieval-box { background: #1e1e1e; border-color: #444; }
        .regeneracao { font-size: 0.8rem; color: #555; margin-top: 5px; }
        body.dark-mode .regeneracao { color: #aaa; }
        button {
            background: #b8860b; color: #fff; border: none; padding: 5px 10px;
            cursor: pointer; font-size: 1.2rem; border-radius: 4px; margin: 0 5px;
            transition: background-color 0.3s ease, transform 0.1s ease, box-shadow 0.1s ease;
        }
        body.dark-mode button { background: #555; }
        button:hover { background: #a0522d; }
        body.dark-mode button:hover { background: #777; }
        
        .button-clicked {
            transform: scale(0.97);
            box-shadow: inset 1px 1px 3px rgba(0,0,0,0.3) !important;
        }

        .botoes-container { display: flex; justify-content: center; gap: 10px; margin-top: 20px; margin-bottom: 20px; flex-wrap: wrap; }
        .botao {
            padding: 12px 25px; border: none; border-radius: 6px; font-size: 1rem; cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.1s ease; 
            font-family: 'MedievalSharp', serif;
            color: #fff; text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
        }
        body.dark-mode .botao { background: #555; }
        body.dark-mode .botao:hover { background: #777; }
        #reset-pontos, #recomecar, #bloquear-ficha, #plano-fundo-btn, #excluir-ficha { background-color: #800000; }
        .botao-reset:hover, .botao-recomecar:hover, .botao-bloquear:hover, .botao-desbloquear:hover, #excluir-ficha:hover {
            background: #a0522d; transform: translateY(-2px);
        }
        .icon-btn {
            padding: 10px; width: 44px; height: 44px;
            font-size: 1.2rem; line-height: 1; text-align: center;
        }
        #lua-btn { background-color: #333; color: #eee; }
        #sol-btn { background-color: #ffdd00; color: #333; }
        #cor-fundo-visual-btn { /* Will be styled dynamically by JS */ }
        #nivel-container { text-align: center; margin-top: 10px; }
        #nivel {
            padding: 10px; background: #f0e6d2; border: 3px solid #000; border-radius: 50%;
            width: 100px; height: 100px; display: flex; align-items: center; justify-content: center;
            font-size: 3.125rem; box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.5); margin: 0 auto;
            font-family: 'MedievalSharp', serif; 
        }
        body.dark-mode #nivel { background: #1e1e1e; border-color: #444; }
        #nivel.aura-azul { animation: pulsar-aura 5s 1; } 
        .expandable-textarea {
            height: 100px; width: 100%; background: #fff; border: 2px solid #b8860b;
            border-radius: 6px; padding: 10px; font-size: 0.9rem; transition: height 0.3s ease;
        }
        body.dark-mode .expandable-textarea { background: #333; }
        .expandable-textarea:focus { height: 15cm; }
        
        #dice-container {
            position: absolute; top: 20px; right: 20px; width: auto; 
            text-align: center;
            font-family: 'MedievalSharp', serif; cursor: move; z-index: 10; user-select: none;
            perspective: 800px; 
        }
        #dice-container label { font-size: 1.2rem; color: #000; display: flex; align-items: center; justify-content: center; margin-bottom: 10px; }
        body.dark-mode #dice-container label { color: #e0e0e0; }
        #dice-container label::before { content: "üé≤"; margin-right: 5px; font-size: 1.5rem; }
        
        .dice-roll-area { display: flex; align-items: center; justify-content: center; gap: 10px; position: relative;}

        #dice-roll {
            width: 100px; height: 100px;
            background-color: var(--dice-bg-color, #f0e6d2); 
            color: var(--dice-number-color, #000000); 
            border: 2px solid #b8860b; 
            border-radius: 10px;
            display: flex; align-items: center; justify-content: center; 
            font-size: 2.5rem; 
            cursor: pointer;
            margin: 0; 
            position: relative; 
            transition: transform 0.3s ease, box-shadow 0.3s ease, background-color 0.3s, color 0.3s;
            font-family: 'MedievalSharp', serif;
            transform-style: preserve-3d; 
        }
        body.dark-mode #dice-roll { border-color: #444; }
        #dice-roll.is-rolling { animation: rollTheDie 1s ease-out forwards; }
        @keyframes rollTheDie {
            0% { transform: rotateX(0deg) rotateY(0deg) rotateZ(0deg) scale(1); box-shadow: 0 0 5px #b8860b; }
            25% { transform: rotateX(360deg) rotateY(-270deg) rotateZ(180deg) scale(1.1) translateX(-10px) translateY(5px); box-shadow: 0 0 10px #a0522d, 0 0 15px #FFD700; }
            50% { transform: rotateX(-180deg) rotateY(360deg) rotateZ(-360deg) scale(0.9) translateX(10px) translateY(-10px); box-shadow: 0 0 15px #b8860b, 0 0 20px #a0522d; }
            75% { transform: rotateX(270deg) rotateY(-180deg) rotateZ(270deg) scale(1.05) translateX(-5px) translateY(8px); box-shadow: 0 0 10px #FFD700, 0 0 15px #a0522d; }
            100% { transform: rotateX(0deg) rotateY(0deg) rotateZ(0deg) scale(1); box-shadow: 0 0 5px #b8860b; }
        }
        #dice-result { margin-top: 10px; font-size: 1rem; color: #000; display: none; animation: blink 1s infinite; }
        body.dark-mode #dice-result { color: #e0e0e0; }
        @keyframes blink { 50% { opacity: 0; } }

        #dice-roll.critical-failure { animation: aura-vermelha 0.5s 4; } 
        #dice-roll.critical-success { animation: aura-verde 0.5s 4; } 
        @keyframes aura-vermelha {
            0%, 100% { box-shadow: 0 0 5px #ff0000, 0 0 10px #ff0000, 0 0 15px #ff0000 !important; }
            50% { box-shadow: 0 0 20px #ff0000, 0 0 30px #ff0000, 0 0 40px #ff0000 !important; }
        }
        @keyframes aura-verde {
            0%, 100% { box-shadow: 0 0 5px #00ff00, 0 0 10px #00ff00, 0 0 15px #00ff00 !important; }
            50% { box-shadow: 0 0 20px #00ff00, 0 0 30px #00ff00, 0 0 40px #00ff00 !important; }
        }
        
        #change-dice-type-btn {
            background-color: #d2b48c; color: #3a2800; border: 1px solid #b8860b;
            width: 55px; height: 36px; font-size: 0.9rem; padding: 5px;
            box-sizing: border-box;
        }
        body.dark-mode #change-dice-type-btn { background-color: #4a3c2a; color: #f0e6d2; border-color: #6b5230; }
        
        #dice-options-menu {
            display: none;
            position: absolute;
            top: 40px; 
            right: 0; 
            background-color: #f0e6d2;
            border: 1px solid #b8860b;
            border-radius: 4px;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.2);
            z-index: 110; 
            padding: 5px;
            flex-direction: column; 
            gap: 5px;
        }
        body.dark-mode #dice-options-menu { background-color: #1e1e1e; border-color: #444; }
        .dice-option-btn {
            width: 100%;
            padding: 8px 10px;
            font-size: 0.9rem;
            background-color: #e6cca7; color: #3a2800;
            border: 1px solid #b8860b; border-radius: 3px;
            text-align: center;
            margin:0; 
        }
        .dice-option-btn:hover { background-color: #d2b48c; }
        body.dark-mode .dice-option-btn { background-color: #3a2f1e; color: #f0e6d2; border-color: #5c4b35; }
        body.dark-mode .dice-option-btn:hover { background-color: #4a3c2a; }

        #fireworks-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 0; pointer-events: none; overflow: hidden;
        }
        .firework-particle {
            position: absolute; border-radius: 50%; opacity: 1;
        }
        @keyframes particle-trail {
            0% { opacity: 1; transform: scale(1) translateY(0px); }
            50% { opacity: 0.7; }
            100% { opacity: 0; transform: scale(0.3) translateY(40px); } 
        }

        #dice-history-trigger {
            position: fixed;
            top: calc(50% + 70px); 
            right: 10px;
            transform: translateY(-50%);
            padding: 10px 15px;
            background: #a0522d;
            color: white;
            border: 2px solid #b8860b;
            border-right: none; 
            border-radius: 6px 0 0 6px; 
            font-family: 'MedievalSharp', serif;
            font-size: 1rem;
            cursor: pointer;
            z-index: 1000; 
            writing-mode: vertical-rl; 
            text-orientation: mixed;
        }
        body.dark-mode #dice-history-trigger { background-color: #555; border-color: #444;}

        #dice-history-panel {
            display: none; 
            position: fixed; 
            right: 50px; 
            top: calc(50% + 70px); 
            transform: translateY(-50%);
            width: 400px; 
            height: 400px; 
            background: #fff; 
            border: 2px solid #b8860b;
            border-radius: 6px; 
            padding: 15px; 
            font-size: 0.9rem; 
            z-index: 1001; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            flex-direction: column; /* J√° estava, mas confirmando */
        }
        body.dark-mode #dice-history-panel { background: #333; color: #e0e0e0; border-color: #555;}

        #dice-history-panel h2 {
            font-family: 'MedievalSharp', serif; font-size: 1.5rem; text-align: center;
            color: #a0522d; margin-bottom: 10px;
        }
        body.dark-mode #dice-history-panel h2 { color: #c58c5a;}

        #dice-history-list {
            flex-grow: 1; 
            overflow-y: auto;
            background: #f9f2e7;
            border: 1px solid #b8860b;
            border-radius: 4px;
            padding: 8px;
            margin-bottom: 10px;
        }
        body.dark-mode #dice-history-list { background: #2a2a2a; border-color: #555; }
        .dice-history-item {
            padding: 6px 4px;
            border-bottom: 1px dashed #d2b48c;
            font-size: 0.9rem;
        }
        body.dark-mode .dice-history-item { border-bottom-color: #4a3c2a; }
        .dice-history-item:last-child { border-bottom: none; }
        .dice-history-item .timestamp { font-size: 0.7rem; color: #777; margin-left: 8px; float: right; }
        body.dark-mode .dice-history-item .timestamp { color: #aaa; }

        .dice-history-buttons { display: flex; justify-content: space-between; margin-top: auto;}
        #fechar-historico-btn, #limpar-historico-btn {
            padding: 8px 15px; font-size: 0.9rem; flex-basis: 48%;
        }
        #limpar-historico-btn { background-color: #800000; }
        #limpar-historico-btn:hover { background-color: #a00000; }
        body.dark-mode #limpar-historico-btn { background-color: #400000;}
        body.dark-mode #limpar-historico-btn:hover { background-color: #600000;}

        #notification {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); padding: 20px;
            border-radius: 8px; font-family: 'MedievalSharp', serif; font-size: 1.5rem; color: #fff;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5); display: none; z-index: 2000; 
            background: rgba(0, 0, 0, 0.7); transition: opacity 0.3s ease;
        }
        #notification.critical-failure { background: rgba(255, 0, 0, 0.8); animation: aura-vermelha 2s infinite; }
        #notification.critical-success { background: rgba(0, 255, 0, 0.8); animation: aura-verde 2s infinite; }
        #notification.normal-result, #notification.save-success { animation: blink 1s infinite; }
        #notification.save-success { background: rgba(0, 200, 0, 0.8); }
        #character-image-container {
            position: absolute; top: 10px; left: 10px; width: 100px; height: 100px; background: #f0e6d2;
            border: 2px solid #b8860b; border-radius: 8px; display: flex; align-items: center;
            justify-content: center; cursor: pointer; overflow: hidden; z-index: 10;
        }
        body.dark-mode #character-image-container { background: #1e1e1e; }
        #character-image { width: 100%; height: 100%; object-fit: cover; display: none; }
        #character-image-container:hover { box-shadow: 0 0 10px #ffd700; }
        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.5); justify-content: center; align-items: center; z-index: 1000;
        }
        .modal-content {
            background: #f0e6d2; padding: 20px; border-radius: 8px; border: 2px solid #b8860b;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3); width: 300px; text-align: center;
        }
        body.dark-mode .modal-content { background: #1e1e1e; border-color: #444; }
        .modal-content h3 { font-family: 'MedievalSharp', serif; color: #000; margin-bottom: 15px; }
        body.dark-mode .modal-content h3 { color: #e0e0e0; }
        .modal-content input { width: calc(100% - 20px); padding: 10px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 6px; }
        body.dark-mode .modal-content input { background: #333; color: #e0e0e0; border-color: #555; }
        .modal-content button {
            padding: 10px 20px; border: none; border-radius: 6px; font-family: 'MedievalSharp', serif;
            color: #fff; cursor: pointer; margin: 0 5px;
        }
        .modal-content .confirm-btn { background: #b8860b; }
        .modal-content .confirm-btn:hover { background: #a0522d; }
        .modal-content .cancel-btn { background: #a52a2a; }
        .modal-content .cancel-btn:hover { background: #8b0000; }
        #vantagens-desvantagens-btn, #racas-btn, #classes-btn {
            padding: 10px 20px; background: #f0e6d2; border: 2px solid #b8860b; border-radius: 6px;
            font-family: 'MedievalSharp', serif; font-size: 1rem; color: #000; cursor: pointer;
            transition: background-color 0.3s ease; z-index: 10;
        }
        body.dark-mode #vantagens-desvantagens-btn, body.dark-mode #racas-btn, body.dark-mode #classes-btn {
            background: #1e1e1e; color: #e0e0e0;
        }
        #vantagens-desvantagens-btn:hover, #racas-btn:hover, #classes-btn:hover { background: #a0522d; color: #fff; }
        #vantagens-desvantagens-panel, #racas-panel, #classes-panel {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(240, 230, 210, 0.95); padding: 20px; overflow-y: auto; z-index: 999;
            border: 2px solid #b8860b; box-shadow: 0 0 20px rgba(0, 0, 0, 0.3);
        }
        body.dark-mode #vantagens-desvantagens-panel, body.dark-mode #racas-panel, body.dark-mode #classes-panel {
            background: rgba(30, 30, 30, 0.95);
        }
        #vantagens-desvantagens-panel h2, #racas-panel h2, #classes-panel h2 {
            font-family: 'MedievalSharp', serif; font-size: 2rem; text-align: center;
            color: #a0522d; margin-bottom: 20px;
        }
        body.dark-mode #vantagens-desvantagens-panel h2, body.dark-mode #racas-panel h2, body.dark-mode #classes-panel h2 { color: #c58c5a; }
        #racas-panel h2 { font-size: 3rem; }
        .vantagem-item, .desvantagem-item, .raca-item {
            padding: 10px; margin: 5px 0; background: #fff; border: 1px solid #ccc;
            border-radius: 6px; cursor: pointer; transition: background-color 0.3s ease;
        }
        body.dark-mode .vantagem-item, body.dark-mode .desvantagem-item, body.dark-mode .raca-item {
            background: #333; border-color: #555;
        }
        .vantagem-item:hover, .desvantagem-item:hover, .raca-item:hover { background: #f0e6d2; }
        body.dark-mode .vantagem-item:hover, body.dark-mode .desvantagem-item:hover, body.dark-mode .raca-item:hover { background: #444; }
        .vantagem-item.comprada, .raca-item.comprada { background: #ffcccc; color: #f00; cursor: default; }
        .desvantagem-item.comprada { background: #ccffcc; color: #080; cursor: default; }
        #salvar-vantagens-btn, #salvar-racas-btn, #fechar-pagina-btn, #fechar-racas-btn, #fechar-classes-btn {
            position: fixed; bottom: 20px; padding: 12px 25px; background: #a52a2a; color: #fff;
            border: none; border-radius: 6px; font-family: 'MedievalSharp', serif; font-size: 1.2rem;
            cursor: pointer; transition: transform 0.2s ease;
        }
        #salvar-vantagens-btn, #salvar-racas-btn { right: 250px; animation: aura-verde-btn 2s infinite; display: none; background: #000; }
        #fechar-pagina-btn, #fechar-racas-btn, #fechar-classes-btn { right: 20px; }
        #salvar-vantagens-btn:hover, #salvar-racas-btn:hover, #fechar-pagina-btn:hover, #fechar-racas-btn:hover, #fechar-classes-btn:hover {
            transform: translateY(-2px);
        }
        @keyframes aura-verde-btn {
            0% { box-shadow: 0 0 5px #00ff00, 0 0 10px #00ff00; }
            50% { box-shadow: 0 0 15px #00ff00, 0 0 20px #00ff00; }
            100% { box-shadow: 0 0 5px #00ff00, 0 0 10px #00ff00; }
        }
        .locomotion-container { background: #8B4513; border: 3px solid #FFD700; border-radius: 10px; padding: 15px; color: #FFD700; font-family: 'MedievalSharp', serif; }
        .locomotion-item { display: flex; align-items: center; margin-bottom: 10px; }
        .locomotion-item label { font-weight: bold; color: #FFD700; }
        .locomotion-item span { font-size: 1.2rem; color: #FFF; text-shadow: 1px 1px 2px #000; margin-left: 5px; font-weight: bold; }
        #distancia-pulo, #altura-pulo, #velocidade-corrida { background-color: #8B4513; border-color: #8B4513; }
        .list-display { background: #fff; border: 2px solid #b8860b; border-radius: 6px; padding: 10px; min-height: 100px; max-height: 200px; overflow-y: auto; }
        body.dark-mode .list-display { background: #333; border-color: #555; }
        .list-item { cursor: pointer; margin-bottom: 5px; padding: 5px; border-bottom: 1px solid #ccc; }
        body.dark-mode .list-item { border-color: #555; }
        .list-item:hover { background: #e0e0e0; }
        body.dark-mode .list-item:hover { background: #444; }
        .inventory-slot { display: flex; align-items: center; margin-bottom: 10px; }
        .inventory-slot input[type="text"] { flex-grow: 1; margin-right: 10px; }
        .inventory-slot input[type="number"] { width: 60px; }
        #anotacoes-btn {
            position: fixed; left: 10px; top: 50%; transform: translateY(-50%); padding: 10px 15px; 
            background: #f0e6d2; border: 2px solid #b8860b; border-left: none; 
            border-radius: 0 6px 6px 0; 
            font-family: 'MedievalSharp', serif; font-size: 1rem; color: #000; cursor: pointer;
            transition: background-color 0.3s ease; z-index: 1000;
            writing-mode: vertical-rl; text-orientation: mixed;
        }
        body.dark-mode #anotacoes-btn { background: #1e1e1e; color: #e0e0e0; border-color: #444;}
        #anotacoes-btn:hover { background: #a0522d; color: #fff; }
        #anotacoes-textarea {
            display: none; position: fixed; left: 50px; 
            top: 50%; transform: translateY(-50%);
            width: 400px; height: 400px; background: #fff; border: 2px solid #b8860b;
            border-radius: 6px; padding: 10px; font-size: 0.9rem; resize: none; z-index: 1001;
        }
        body.dark-mode #anotacoes-textarea { background: #333; color: #e0e0e0; }
        .magias-container { max-height: 300px; overflow-y: auto; border: 2px solid #b8860b; border-radius: 6px; padding: 10px; background: #fff; }
        body.dark-mode .magias-container { background: #333; border-color: #555; }
        .magias-container input { margin-bottom: 10px; }
        #adicionar-magia-btn { background: #b8860b; color: #fff; padding: 8px 16px; border-radius: 6px; cursor: pointer; display: block; margin-top: 10px; }
        #adicionar-magia-btn:hover { background: #a0522d; }
        .classe-raca-container { background: #f0e6d2; border: 2px solid #b8860b; padding: 10px; border-radius: 6px; margin-top: 10px; }
        body.dark-mode .classe-raca-container { background: #1e1e1e; border-color: #444; }
        .classe-raca-container label { font-family: 'MedievalSharp', serif; color: #a0522d; font-size: 1.2rem; }
        .classe-raca-container span[onclick] { background: #fff; border: 2px solid #b8860b; padding: 10px; cursor: pointer; display: block; }
        body.dark-mode .classe-raca-container span[onclick] { background: #333; color: #e0e0e0; }
        .classe-raca-container textarea { width: 100%; background: #fff; border: 2px solid #b8860b; }
        body.dark-mode .classe-raca-container textarea { background: #333; color: #e0e0e0; }
        .raca-item { margin-bottom: 20px; padding: 10px; background: #fff; border: 2px solid #b8860b; border-radius: 6px; }
        .raca-item h3 { font-family: 'MedievalSharp', serif; font-size: 1.5rem; color: #a0522d; }
        .raca-item p { font-size: 1rem; color: #000; }
        body.dark-mode .raca-item { background: #333; border-color: #555; }
        body.dark-mode .raca-item p { color: #e0e0e0; }
        .theme-color-container { display: flex; justify-content: center; align-items:center; gap: 10px; margin-top: -10px; margin-bottom: 20px; }
        .theme-option { position: relative; }
        #cor-fundo-visual-btn { cursor: pointer; }

        .lock-icon { margin-left: 5px; cursor: help; }
        
        /* Estilo para Riqueza */
        #riqueza .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; }
        #riqueza label { margin-bottom: 5px; }
        #riqueza input[type="number"] { width: 100%; box-sizing: border-box; margin-bottom: 0; }


        @media (max-width: 768px) {
            body { padding: 10px; }
            #ficha-container { padding: 15px; }
            h1#nome-personagem-titulo { font-size: 2rem; }
            section h2 { font-size: 1.2rem; }
            input, textarea { font-size: 0.9rem; }
            .atributos-container, .vida-magia-vigor { flex-direction: column; }
            .atributos-coluna, .atributos-coluna-destaque, .atributo-container { width: 100%; }
            .botoes-container, .theme-color-container { flex-direction: row; flex-wrap: wrap; }
             #dice-container { width: auto; }
            #dice-roll { width: 80px; height: 80px; font-size: 2rem; }
            #change-dice-type-btn {width: 45px; font-size: 0.8rem;}
            #dice-options-menu { top: 35px; }

            #anotacoes-btn { padding: 8px 10px; font-size: 0.9rem;}
            #anotacoes-textarea { left: 40px; width: calc(100vw - 60px); height: 300px; }

            #dice-history-trigger {
                padding: 8px 10px; font-size: 0.9rem;
                top: calc(50% + 120px); 
            }
            #dice-history-panel { 
                right: 40px; width: calc(100vw - 60px); height: 300px;
                top: calc(50% + 120px);
            }
            #dice-history-list { max-height: calc(300px - 90px); } 
            #riqueza .grid { grid-template-columns: 1fr; } /* Moedas em uma coluna */
        }
        #raca-opcoes-modal .modal-content button:nth-child(2) { margin-top: 10px; }
        #background-modal { display: none; }
        #background-modal .modal-content { width: 400px; text-align: left; }
        #background-modal .modal-content label { display: block; margin-bottom: 5px; }
        #background-modal .modal-content input[type="file"] { margin-bottom: 10px; }
        #background-modal .modal-content .radio-group { margin-bottom: 15px; }
        #background-modal .modal-content .radio-group label { display: inline-block; margin-right: 10px; }
        .color-option { width: 24px; height: 24px; border-radius: 50%; cursor: pointer; border: 1px solid #ccc; }
    </style>
</head>
<body>
    <div id="fichas-sidebar">
        <div id="add-ficha-btn"><span>+ Fichas</span></div>
    </div>
    <div id="ficha-container">
        <h1 id="nome-personagem-titulo">Ficha de Personagem</h1>
        <div id="game-master-message">Voc√™ virou o Game Master</div>
        <div id="character-image-container" onclick="document.getElementById('character-image-input').click()">
            <img id="character-image" alt="Imagem do Personagem">
            <input type="file" id="character-image-input" accept="image/*" style="display:none">
        </div>
        <div id="dice-container">
            <label>Role seu dado:</label>
            <div class="dice-roll-area">
                <div id="dice-roll">-</div>
                <button id="change-dice-type-btn" class="botao icon-btn" title="Mudar Tipo de Dado">D20</button>
            </div>
            <div id="dice-options-menu">
                <button class="dice-option-btn" data-dice-max="20">D20</button>
                <button class="dice-option-btn" data-dice-max="12">D12</button>
                <button class="dice-option-btn" data-dice-max="6">D6</button>
                <button class="dice-option-btn" data-dice-max="4">D4</button>
                <button class="dice-option-btn" data-dice-max="3">D3</button>
            </div>
            <div id="dice-result"></div>
        </div>
        <div id="ficha-content">
            <!-- As se√ß√µes ser√£o inseridas aqui pelo JavaScript na ordem correta -->
        </div>
    </div>
    <button id="anotacoes-btn">Anota√ß√µes</button>
    <textarea id="anotacoes-textarea" placeholder="Suas anota√ß√µes aqui..."></textarea>

    <div id="vantagens-desvantagens-panel">
        <h2>Vantagens e Desvantagens</h2>
        <div>Pontos de Vantagem Tempor√°rios: <span id="ph-temp">0</span></div>
        <div id="vantagens-list"></div>
        <div id="desvantagens-list"></div>
        <button id="salvar-vantagens-btn">SALVAR</button>
        <button id="fechar-pagina-btn">Fechar P√°gina</button>
    </div>
    <div id="racas-panel">
        <h2>Ra√ßas</h2>
        <div id="ph-temp-raca-container" style="text-align: center; margin-bottom: 10px;">Pontos de Vantagem Tempor√°rios: <span id="ph-temp-raca">0</span></div> <div id="racas-list"></div>
        <button id="salvar-racas-btn">SALVAR</button>
        <button id="fechar-racas-btn">Fechar P√°gina</button>
    </div>
    <div id="classes-panel">
        <h2>Classes</h2>
        <button id="fechar-classes-btn">Fechar P√°gina</button>
    </div>
    <div id="nome-ficha-modal" class="modal">
        <div class="modal-content">
            <h3>D√™ um Nome √† Ficha</h3>
            <input type="text" id="nome-ficha-input" placeholder="Nome da ficha" maxlength="20">
            <button class="confirm-btn" onclick="criarNovaFicha()">Confirmar</button>
            <button class="cancel-btn" onclick="fecharModal('nome-ficha-modal')">Cancelar</button>
        </div>
    </div>
    <div id="bloquear-ficha-modal" class="modal">
        <div class="modal-content">
            <h3>Ponha sua Senha de 4 D√≠gitos</h3>
            <input type="password" id="senha-bloqueio-input" placeholder="Senha (4 d√≠gitos)" maxlength="4">
            <button class="confirm-btn" onclick="bloquearFicha()">Confirmar</button>
            <button class="cancel-btn" onclick="fecharModal('bloquear-ficha-modal')">Cancelar</button>
        </div>
    </div>
    <div id="password-modal" class="modal">
        <div class="modal-content">
            <h3>Digite sua Senha</h3>
            <input type="password" id="senha-desbloqueio-input" placeholder="Senha (4 d√≠gitos)" maxlength="4">
            <button class="confirm-btn" onclick="desbloquearFicha()">Confirmar</button>
            <button class="cancel-btn" onclick="cancelarDesbloqueio()">Cancelar</button>
        </div>
    </div>
    <div id="confirmar-compra-modal" class="modal">
        <div class="modal-content">
            <h3>Tem certeza que quer comprar isso?</h3>
            <button class="confirm-btn" id="confirmar-compra-btn">Sim</button>
            <button class="cancel-btn" onclick="fecharModal('confirmar-compra-modal')">N√£o</button>
        </div>
    </div>
    <div id="salvar-vantagens-modal" class="modal"> <div class="modal-content">
            <h3 id="salvar-modal-texto">Se salvar, as altera√ß√µes n√£o poder√£o ser desfeitas.</h3>
            <button class="confirm-btn" id="confirmar-salvar-btn">OK</button> <button class="cancel-btn" onclick="fecharModal('salvar-vantagens-modal')">Cancelar</button>
        </div>
    </div>
    <div id="senha-gm-modal" class="modal">
        <div class="modal-content">
            <h3 id="senha-gm-titulo">Pe√ßa permiss√£o ao GM</h3>
            <input type="password" id="senha-gm-input" placeholder="Senha GM">
            <button class="confirm-btn" id="confirmar-senha-gm-btn">Confirmar</button>
            <button class="cancel-btn" onclick="fecharModal('senha-gm-modal')">Cancelar</button>
        </div>
    </div>
    <div id="raca-opcoes-modal" class="modal">
        <div class="modal-content">
            <h3>O que voc√™ deseja fazer?</h3>
            <button class="confirm-btn" onclick="excluirRacaSelecionadaModal()">Excluir Ra√ßa</button>
            <button class="confirm-btn" onclick="editarRacaSelecionadaModal()" style="margin-top: 10px;">Editar Ra√ßa</button>
            <button class="cancel-btn" onclick="fecharModal('raca-opcoes-modal')">Cancelar</button>
        </div>
    </div>
    <div id="editar-raca-modal" class="modal">
        <div class="modal-content">
            <h3>Editar Ra√ßa</h3>
            <label for="editar-raca-nome">Nome:</label>
            <input type="text" id="editar-raca-nome">
            <label for="editar-raca-descricao">Descri√ß√£o:</label>
            <textarea id="editar-raca-descricao"></textarea>
            <button class="confirm-btn" onclick="salvarEdicaoRaca()">Salvar</button>
            <button class="cancel-btn" onclick="fecharModal('editar-raca-modal')">Cancelar</button>
        </div>
    </div>
    <div id="notification"></div>
    <div id="background-modal" class="modal">
        <div class="modal-content">
            <h3>Plano de Fundo</h3>
            <label for="background-image-input">Selecionar Imagem:</label>
            <input type="file" id="background-image-input" accept="image/*">
            <div class="radio-group">
                <label><input type="radio" name="background-size" value="cover" checked>Preencher Tela</label>
                <label><input type="radio" name="background-size" value="100% 100%">Estender</label>
                <label><input type="radio" name="background-size" value="auto">Tamanho Normal</label>
            </div>
            <button class="confirm-btn" onclick="aplicarPlanoDeFundo()">Aplicar</button>
            <button class="cancel-btn" onclick="fecharModal('background-modal')">Cancelar</button>
            <button class="cancel-btn" onclick="excluirPlanoDeFundo()">Excluir Imagem</button>
        </div>
    </div>
    <!-- Cont√™iner para os Fogos de Artif√≠cio -->
    <div id="fireworks-container"></div>
    <!-- Gatilho e Painel para Hist√≥rico de Dados -->
    <div id="dice-history-trigger">Hist√≥rico de Dados</div>
    <div id="dice-history-panel" style="display:none;"> 
        <h2>Hist√≥rico de Rolagens</h2>
        <div id="dice-history-list">
        </div>
        <div class="dice-history-buttons">
            <button id="limpar-historico-btn" class="botao">Limpar Hist√≥rico</button>
            <button id="fechar-historico-btn" class="botao">Fechar Caixa</button>
        </div>
    </div>
    <script>
        const RGP_FICHAS_KEY = 'rpgFichas';
        const RPG_CURRENT_FICHA_ID_KEY = 'rpgCurrentFichaId';
        const FICHA_MATRIZ_ID = "ficha-matriz";

        let fichas = {}, currentFichaId = null, isFichaLocked = false, fichaPassword = null,
            isFichaUnlocked = false, senhaMatriz = "1040", vantagensSelecionadas = [],
            desvantagensSelecionadas = [], tempVantagensSelecionadas = [], tempDesvantagensSelecionadas = [],
            racaSelecionada = null, tempRacaSelecionada = null, vidaTotal, vidaAtual, magiaTotal, magiaAtual,
            vigorTotal, vigorAtual, previousValues = new Map();

        const vantagensData = [
            { nome: "Maestria com Armas curtas (2)", custo: 2, descricao: "+1 em ataque, +1 em acerto com armas curtas." }, { nome: "Maestria com armas pesadas (2)", custo: 2, descricao: "+2 em ataque com armas pesadas." }, { nome: "Maestria com armas de longo alcance (2)", custo: 2, descricao: "+2 em acerto com armas de longo alcance." }, { nome: "Furtar (2)", custo: 2, descricao: "+4 em testes de furto." }, { nome: "L√°bia (2)", custo: 2, descricao: "+5 em testes de l√°bia." }, { nome: "Velejar (1)", custo: 1, descricao: "" }, { nome: "Beleza (1)", custo: 1, descricao: "+3 o teste em l√°bia, paquera e persuas√£o." }, { nome: "Boa Fama (2)", custo: 2, descricao: "+4 chance de descontos em armamentos, pousadas, alimentos, etc." }, { nome: "Arremedo (2)", custo: 2, descricao: "Capacidade de imitar qualquer som SIMPLES." }, { nome: "Destemor (1)", custo: 1, descricao: "Dificilmente √© assustado por algo." }, { nome: "Empatia (3)", custo: 3, descricao: "Sensibilidade extraordin√°ria em rela√ß√£o aos outras pessoas. Excelente para identificar impostores, possess√µes por espirito, etc." }, { nome: "Empatia com animais (1)", custo: 1, descricao: "Pode compreender as motiva√ß√µes dos animais." }, { nome: "Patrono (4)", custo: 4, descricao: "Possui um mentor/mestre/professor, at√© mesmo uma organiza√ß√£o/guilda que pode lhe oferecer ajuda." }, { nome: "Reconhecimento Social (2)", custo: 2, descricao: "Membro de um grupo respeitado/temido/venerado. +2 teste em l√°bia, paquera e persuas√£o." }, { nome: "Riqueza (2)", custo: 2, descricao: "Inicia com 20 moedas de ouro." }, { nome: "Aptid√£o para magia (4)", custo: 4, descricao: "+15% dano e -15% custo de magia para a magia que tem aptid√£o." }, { nome: "Combo F√≠sico (4)", custo: 4, descricao: "Inicia com 50km velocidade corrida, pulo de 3m altura e 9m dist√¢ncia.", restricao: "inicio" }, { nome: "Nadar (1)", custo: 1, descricao: "" }, { nome: "Escalar (2)", custo: 2, descricao: "" }, { nome: "Segunda l√≠ngua (1)", custo: 1, descricao: "Fala mais um idioma." }, { nome: "Paquerador (2)", custo: 2, descricao: "+4 em teste para paquera e persuas√£o envolvendo flerte." }, { nome: "Senso de perigo (5)", custo: 5, descricao: "Quando algo grave ocorrer o mestre pedir√° pra voc√™ jogar um dado para reagir." }, { nome: "Acrobata (3)", custo: 3, descricao: "+ fama ao lutar em p√∫blico." }, { nome: "Equil√≠brio Perfeito (3)", custo: 3, descricao: "+8 em testes de equil√≠brio." }, { nome: "Tecnologia (2)", custo: 2, descricao: "Engenhoso, pode inventar coisas, criar objetos improvisados." }, { nome: "Poder Oculto (7)", custo: 7, descricao: "Com 10% vida, ativa +50% em todos atributos. Volta ao normal acima de 10% vida." }, { nome: "Sobreviv√™ncia em floresta (2)", custo: 2, descricao: "Facilidade para achar cavernas, criar assentamentos, achar comida, gravar caminhos, achar √°gua, etc." }
        ];
        const desvantagensData = [
            { nome: "Fobia (+2)", ganho: 2, descricao: "Medo irracional de algo espec√≠fico." }, { nome: "M√° Fama (+2)", ganho: 2, descricao: "Mal visto pela sociedade, dificultando intera√ß√µes sociais." }, { nome: "Alcoolismo (+2)", ganho: 2, descricao: "Depend√™ncia de √°lcool que afeta suas decis√µes." }, { nome: "Altru√≠smo (+2)", ganho: 2, descricao: "Se sacrifica por outras pessoas, pouco se importa com fama ou riqueza." }, { nome: "Avareza (+2)", ganho: 2, descricao: "Preocupa√ß√£o permanente na conserva√ß√£o de riquezas." }, { nome: "Bullying (+3)", ganho: 3, descricao: "Gosta de ca√ßoar, agredir, denegrir, difamar e apontar defeitos." }, { nome: "Circunspe√ß√£o (+2)", ganho: 2, descricao: "N√£o entende piadas, entende tudo literal e acredita que todos est√£o s√©rios." }, { nome: "Compuls√µes (+3)", ganho: 3, descricao: "H√°bito ou v√≠cio que toma boa parte dos seus recursos e tempo." }, { nome: "Covardia (+2)", ganho: 2, descricao: "Extremo cuidado com bem-estar f√≠sico e dificuldade em assumir riscos." }, { nome: "Dependentes (+4)", ganho: 4, descricao: "Algu√©m depende de voc√™ a todo momento (filhos, parentes, etc.)." }, { nome: "F√∫ria (+2)", ganho: 2, descricao: "Tend√™ncia a perder o controle e atacar freneticamente (ativado por dano, insulto ou aleat√≥rio)." }, { nome: "Honestidade (+3)", ganho: 3, descricao: "N√£o consegue mentir ou omitir, sempre fala a verdade e desmascara mentiras." }, { nome: "Impulsividade (+2)", ganho: 2, descricao: "Sempre age sem pensar." }, { nome: "Lux√∫ria (+2)", ganho: 2, descricao: "Desejo incontrol√°vel por romance." }, { nome: "Magnetismo Sobrenatural (+2)", ganho: 2, descricao: "Coisas estranhas acontecem com seu personagem em n√≠vel alarmante." }, { nome: "No Limite (+4)", ganho: 4, descricao: "Assume riscos extremamente irracionais diante de perigo mortal." }, { nome: "Teimosia (+1)", ganho: 1, descricao: "Quer sempre fazer as coisas do seu modo, n√£o segue planos que n√£o sejam seus." }, { nome: "Amn√©sia (+2)", ganho: 2, descricao: "Em certos momentos, n√£o consegue lembrar de coisas importantes." }
        ];
        let racasData = [
            { nome: "Humano (3)", custo: 3, descricao: "Vers√°teis, ambiciosos, mestres em adapta√ß√£o.", vantagens: ["Explorador Nato: Cavalo superior, equipamentos, mapa detalhado.", "Mestre das Profiss√µes: Escolha (Ferreiro Lend√°rio, Costureiro Arcano, Arquiteto Vision√°rio) com benef√≠cios √∫nicos.", "Rede de Influ√™ncia: Aliado influente (guildas, mercadores, l√≠deres) com acesso a informa√ß√µes ou ajuda.", "Determina√ß√£o Inabal√°vel: Uma vez/dia, ignore uma desvantagem (exaust√£o, ferimento, magia) por um curto per√≠odo."] }, { nome: "Elfo (4)", custo: 4, descricao: "S√°bios, m√°gicos, conectados √† natureza.", vantagens: ["Sabedoria Ancestral: Domina √°rea (arcana, hist√≥ria, natureza), decifra itens antigos, aprende 1 l√≠ngua extra.", "Vis√£o √âlfica Suprema: Enxerga 10m escuro, detecta magias fracas 20m, percebe inten√ß√µes hostis (teste 19+).", "Escudo M√°gico: Resist√™ncia inata a um tipo de efeito m√°gico hostil (dano ou dura√ß√£o -50%)."] }, { nome: "An√£o (4)", custo: 4, descricao: "Resilientes, habilidosos, ligados √† terra.", vantagens: ["Fortitude Indom√°vel: Trabalha 3 dias sem descanso, recupera vida/energia 2x mais r√°pido em rocha/subterr√¢neo.", "Artes√£o: Escolha (Mestre Minerador, Forjador de Lendas, Joalheiro Divino) com impacto massivo.", "Senhor das Profundezas: Nunca se perde subterr√¢neo, detecta armadilhas, sente vibra√ß√µes (prever emboscada/colapso)."] }, { nome: "Orc (3)", custo: 3, descricao: "Guerreiros ferozes, l√≠deres pela for√ßa.", vantagens: ["Lenda entre Guerreiros: Inspira temor/respeito, alian√ßas marciais, acesso miss√µes √©picas; inimigos menores fogem (teste 16+).", "Resili√™ncia Brutal: Luta sem penalidades com ferimentos graves, s√≥ cai com PV 0, regenera ferimentos leves fora de combate.", "Dom√≠nio da Intimida√ß√£o: For√ßa inimigos a render/recuar com grito (1x/encontro, afeta grupos), b√¥nus massivo negocia√ß√µes (for√ßa/medo).", "F√∫ria Ancestral: F√∫ria 2x/dia (dobra for√ßa/resist√™ncia por curto per√≠odo)."] }, { nome: "Meio Animal (Selvagem) (4)", custo: 4, descricao: "Instinto primal com ast√∫cia.", vantagens: ["Sentidos Predat√≥rios: Escolha (vis√£o, olfato, audi√ß√£o) agu√ßado; rastreia km, detecta invis√≠veis, evita surpresa (teste 12+).", "Senhor dos Terrenos: Adapta-se a 1 ambiente (floresta, deserto, p√¢ntano), ignora efeitos negativos, b√¥nus movimento/furtividade (+1).", "Frenesi Instintivo: 1x/dia, velocidade sobrenatural (2x movimento), ataques adicionais, percep√ß√£o pr√©-monit√≥ria (10 min)."] }
        ];
        const nivelData = [
            { nivel: 0, xp: 0, pd: 25, ph: 8 }, { nivel: 1, xp: 10, pd: 31, ph: 9 }, { nivel: 2, xp: 30, pd: 37, ph: 10 }, { nivel: 3, xp: 60, pd: 43, ph: 11 }, { nivel: 4, xp: 100, pd: 49, ph: 12 }, { nivel: 5, xp: 150, pd: 55, ph: 13 }, { nivel: 6, xp: 210, pd: 61, ph: 14 }, { nivel: 7, xp: 280, pd: 67, ph: 15 }, { nivel: 8, xp: 360, pd: 73, ph: 16 }, { nivel: 9, xp: 450, pd: 79, ph: 17 }, { nivel: 10, xp: 550, pd: 85, ph: 18 }, { nivel: 11, xp: 670, pd: 91, ph: 19 }, { nivel: 12, xp: 810, pd: 97, ph: 20 }, { nivel: 13, xp: 970, pd: 103, ph: 21 }, { nivel: 14, xp: 1150, pd: 109, ph: 22 }, { nivel: 15, xp: 1350, pd: 115, ph: 23 }, { nivel: 16, xp: 1570, pd: 121, ph: 24 }, { nivel: 17, xp: 1810, pd: 127, ph: 25 }, { nivel: 18, xp: 2070, pd: 133, ph: 26 }, { nivel: 19, xp: 2350, pd: 139, ph: 27 }, { nivel: 20, xp: 2650, pd: 145, ph: 28 }, { nivel: 21, xp: 2980, pd: 148, ph: 29 }, { nivel: 22, xp: 3340, pd: 151, ph: 30 }, { nivel: 23, xp: 3730, pd: 154, ph: 31 }, { nivel: 24, xp: 4150, pd: 157, ph: 32 }, { nivel: 25, xp: 4600, pd: 160, ph: 33 }, { nivel: 26, xp: 5080, pd: 163, ph: 34 }, { nivel: 27, xp: 5590, pd: 166, ph: 35 }, { nivel: 28, xp: 6130, pd: 169, ph: 36 }, { nivel: 29, xp: 8000, pd: 219, ph: 37 }, { nivel: 30, xp: 10000, pd: 319, ph: 38 }
        ];

        // Cache DOM Elements
        const nomePersonagemInput = document.getElementById("nome-personagem"), descricaoPersonagemInput = document.getElementById("descricao-personagem"),
            forcaInput = document.getElementById("forca"), destrezaInput = document.getElementById("destreza"), agilidadeInput = document.getElementById("agilidade"),
            inteligenciaInput = document.getElementById("inteligencia"), constituicaoInput = document.getElementById("constituicao"),
            ataqueSpan = document.getElementById("ataque"), ataqueMagicoSpan = document.getElementById("ataque-magico"), acertoSpan = document.getElementById("acerto"),
            esquivaSpan = document.getElementById("esquiva"), rdfSpan = document.getElementById("rdf"), rdmSpan = document.getElementById("rdm"),
            armaDireitaNomeInput = document.getElementById("arma-direita-nome"), armaDireitaAtaqueInput = document.getElementById("arma-direita-ataque"),
            armaDireitaAtaqueMagicoInput = document.getElementById("arma-direita-ataque-magico"), armaEsquerdaNomeInput = document.getElementById("arma-esquerda-nome"),
            armaEsquerdaAtaqueInput = document.getElementById("arma-esquerda-ataque"), armaEsquerdaAtaqueMagicoInput = document.getElementById("arma-esquerda-ataque-magico"),
            resetPontosButton = document.getElementById("reset-pontos"), recomecarButton = document.getElementById("recomecar"),
            bloquearFichaButton = document.getElementById("bloquear-ficha"), experienciaInput = document.getElementById("experiencia"),
            xpLockIcon = document.getElementById("xp-lock-icon"), 
            nivelSpan = document.getElementById("nivel"), pontosHabilidadeSpan = document.getElementById("pontos-habilidade"),
            pontosVantagemSpan = document.getElementById("pontos-vantagem"), velocidadeCorridaSpan = document.getElementById("velocidade-corrida"),
            alturaPuloSpan = document.getElementById("altura-pulo"), distanciaPuloSpan = document.getElementById("distancia-pulo"),
            nomePersonagemTitulo = document.getElementById("nome-personagem-titulo"), gameMasterMessage = document.getElementById("game-master-message"),
            vantagensListDisplay = document.getElementById("vantagens-list-display"), desvantagensListDisplay = document.getElementById("desvantagens-list-display"),
            inventarioSlots = document.getElementById("inventario-slots"), pesoTotalSpan = document.getElementById("peso-total"),
            capacidadeCargaSpan = document.getElementById("capacidade-carga"),
            diceContainer = document.getElementById("dice-container"), diceRoll = document.getElementById("dice-roll"), diceResult = document.getElementById("dice-result"),
            changeDiceTypeBtn = document.getElementById('change-dice-type-btn'), 
            diceOptionsMenu = document.getElementById('dice-options-menu'), 
            notification = document.getElementById("notification"), characterImageInput = document.getElementById("character-image-input"),
            characterImage = document.getElementById("character-image"), vantagensDesvantagensBtn = document.getElementById("vantagens-desvantagens-btn"),
            vantagensDesvantagensPanel = document.getElementById("vantagens-desvantagens-panel"), vantagensList = document.getElementById("vantagens-list"),
            desvantagensList = document.getElementById("desvantagens-list"), salvarVantagensBtn = document.getElementById("salvar-vantagens-btn"),
            fecharPaginaBtn = document.getElementById("fechar-pagina-btn"), fichaContainer = document.getElementById("ficha-container"),
            magiasList = document.getElementById("magias-list"), adicionarMagiaBtn = document.getElementById("adicionar-magia-btn"),
            anotacoesBtn = document.getElementById("anotacoes-btn"), anotacoesTextarea = document.getElementById("anotacoes-textarea"),
            racasBtn = document.getElementById("racas-btn"), classesBtn = document.getElementById("classes-btn"), racasPanel = document.getElementById("racas-panel"),
            classesPanel = document.getElementById("classes-panel"), fecharRacasBtn = document.getElementById("fechar-racas-btn"),
            fecharClassesBtn = document.getElementById("fechar-classes-btn"), classeNomeInput = document.getElementById("classe-nome"),
            classeDescricaoInput = document.getElementById("classe-descricao"), racaNomeSpan = document.getElementById("raca-nome"),
            racaDescricaoInput = document.getElementById("raca-descricao"), luaBtn = document.getElementById("lua-btn"), solBtn = document.getElementById("sol-btn"),
            salvarRacasBtn = document.getElementById("salvar-racas-btn"), racasList = document.getElementById("racas-list"),
            atributosInputs = [forcaInput, destrezaInput, agilidadeInput, inteligenciaInput, constituicaoInput],
            planoFundoBtn = document.getElementById("plano-fundo-btn"),
            backgroundImageInput = document.getElementById("background-image-input"), backgroundModal = document.getElementById("background-modal"),
            backgroundColorInput = document.getElementById('background-color-input'), 
            backgroundColorButtonVisual = document.getElementById('cor-fundo-visual-btn'), 
            fontSelector = document.getElementById('font-selector'), 
            confirmarSalvarBtn = document.getElementById("confirmar-salvar-btn"),
            phTempRacaSpan = document.getElementById("ph-temp-raca"),
            senhaGmTitulo = document.getElementById("senha-gm-titulo"),
            diceColorInput = document.getElementById('dice-color-input'),
            diceColorVisualBtn = document.getElementById('dice-color-input-visual'), 
            diceNumberColorInput = document.getElementById('dice-number-color-input'),
            diceNumberColorVisualBtn = document.getElementById('dice-number-color-input-visual'),
            diceHistoryTrigger = document.getElementById('dice-history-trigger'), 
            diceHistoryPanel = document.getElementById('dice-history-panel'), 
            diceHistoryList = document.getElementById('dice-history-list'), 
            fecharHistoricoBtn = document.getElementById('fechar-historico-btn'),
            limparHistoricoBtn = document.getElementById('limpar-historico-btn'); 

        // Se√ß√£o de Riqueza (novos elementos)
        const ouroInput = document.getElementById('moeda-ouro');
        const prataInput = document.getElementById('moeda-prata');
        const cobreInput = document.getElementById('moeda-cobre');

        let nivel = 0, nivelAnterior = 0, pontosHabilidadeTotal = 25, pontosHabilidadeUsados = 0, experiencia = 0, vidaBase = 50;
        let currentActionIntervalId = null; 
        const REPEAT_DELAY_MS = 75; 
        let xpUnlockTimerId = null;
        let isXpUnlocked = false; 
        const XP_UNLOCK_DURATION_MS = 20000; 
        let isDiceRolling = false;
        let currentDiceMax = 20; 
        let fireworksContainerRef; 
        let sectionOrder = [ // Ordem padr√£o das se√ß√µes
            'informacoes-basicas', 'recursos', 'atributos', 'combate', 
            'inventario-habilidades', 'locomocao', 'status', 'riqueza' 
        ];

        // --- LocalStorage Helper Functions ---
        function getFichasFromStorage() {
            const fichasJSON = localStorage.getItem(RGP_FICHAS_KEY);
            return fichasJSON ? JSON.parse(fichasJSON) : {};
        }

        function saveFichasToStorage(fichasObj) {
            localStorage.setItem(RGP_FICHAS_KEY, JSON.stringify(fichasObj));
        }

        function getCurrentFichaIdFromStorage() {
            return localStorage.getItem(RPG_CURRENT_FICHA_ID_KEY);
        }

        function saveCurrentFichaIdToStorage(fichaId) {
            localStorage.setItem(RPG_CURRENT_FICHA_ID_KEY, fichaId);
        }

        function generateLocalId() {
            return `local_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
        }
        // --- End LocalStorage Helper Functions ---

        // --- CRIA√á√ÉO DIN√ÇMICA DO CONTE√öDO DA FICHA ---
        function criarEstruturaFicha() {
            const fichaContent = document.getElementById('ficha-content');
            fichaContent.innerHTML = ''; // Limpa o conte√∫do existente para reordenar

            sectionOrder.forEach(sectionId => {
                let sectionHTML = '';
                switch (sectionId) {
                    case 'informacoes-basicas':
                        sectionHTML = `
                            <section id="informacoes-basicas">
                                <h2>Informa√ß√µes B√°sicas <span class="collapse-icon">‚ñº</span>
                                    <div class="section-order-buttons">
                                        <button class="order-btn" data-direction="up" title="Mover para Cima">‚ñ≤</button>
                                        <button class="order-btn" data-direction="down" title="Mover para Baixo">‚ñº</button>
                                    </div>
                                </h2>
                                <div class="section-content">
                                    <label for="nome-personagem">Nome do Personagem:</label>
                                    <input type="text" id="nome-personagem" placeholder="Digite o nome do seu personagem">
                                    <label for="descricao-personagem">Descri√ß√£o do Personagem:</label>
                                    <textarea id="descricao-personagem" placeholder="Digite a descri√ß√£o do seu personagem"></textarea>
                                </div>
                            </section>`;
                        break;
                    case 'recursos':
                        sectionHTML = `
                            <section id="recursos">
                                <h2>Recursos <span class="collapse-icon">‚ñº</span>
                                    <div class="section-order-buttons">
                                        <button class="order-btn" data-direction="up" title="Mover para Cima">‚ñ≤</button>
                                        <button class="order-btn" data-direction="down" title="Mover para Baixo">‚ñº</button>
                                    </div>
                                </h2>
                                <div class="section-content">
                                    <div class="vida-magia-vigor">
                                        <div class="atributo-container vida">
                                            <h3>Vida</h3>
                                            <div class="valor-total medieval-box"><span>Vida Total: </span><span id="vida-total" readonly>50</span></div>
                                            <div class="valor-atual medieval-box"><span>Vida Atual: </span><button id="btn-diminuir-vida" title="Diminuir Vida">‚ñº</button><span id="vida-atual">50</span><button id="btn-aumentar-vida" title="Aumentar Vida">‚ñ≤</button></div>
                                            <div class="regeneracao"><span>Regenera√ß√£o por turno: <span id="regeneracao-vida">0</span> (parado)</span></div>
                                        </div>
                                        <div class="atributo-container magia">
                                            <h3>Magia</h3>
                                            <div class="valor-total medieval-box"><span>Magia Total: </span><span id="magia-total" readonly>20</span></div>
                                            <div class="valor-atual medieval-box"><span>Magia Atual: </span><button id="btn-diminuir-magia" title="Diminuir Magia">‚ñº</button><span id="magia-atual">20</span><button id="btn-aumentar-magia" title="Aumentar Magia">‚ñ≤</button></div>
                                            <div class="regeneracao"><span>Regenera√ß√£o por turno: <span id="regeneracao-magia">0</span></span></div>
                                        </div>
                                        <div class="atributo-container vigor">
                                            <h3>Vigor</h3>
                                            <div class="valor-total medieval-box"><span>Vigor Total: </span><span id="vigor-total" readonly>10</span></div>
                                            <div class="valor-atual medieval-box"><span>Vigor Atual: </span><button id="btn-diminuir-vigor" title="Diminuir Vigor">‚ñº</button><span id="vigor-atual">10</span><button id="btn-aumentar-vigor" title="Aumentar Vigor">‚ñ≤</button></div>
                                            <div class="regeneracao"><span>Regenera√ß√£o por turno: <span id="regeneracao-vigor">0</span> (parado)</span></div>
                                        </div>
                                    </div>
                                </div>
                            </section>`;
                        break;
                    case 'atributos':
                         sectionHTML = `
                            <section id="atributos">
                                <h2>Atributos <span class="collapse-icon">‚ñº</span>
                                    <div class="section-order-buttons">
                                        <button class="order-btn" data-direction="up" title="Mover para Cima">‚ñ≤</button>
                                        <button class="order-btn" data-direction="down" title="Mover para Baixo">‚ñº</button>
                                    </div>
                                </h2>
                                <div class="section-content">
                                    <div class="atributos-container">
                                        <div class="atributos-coluna">
                                            <div class="atributo"><label for="forca" title="For√ßa: Afeta o dano f√≠sico e a capacidade de carga.">For√ßa:</label><input type="number" id="forca" value="0" min="0"></div>
                                            <div class="atributo"><label for="destreza" title="Destreza: Influencia a precis√£o de ataques f√≠sicos e parte do c√°lculo de acerto.">Destreza:</label><input type="number" id="destreza" value="0" min="0"></div>
                                            <div class="atributo"><label for="agilidade" title="Agilidade: Afeta a capacidade de esquiva e uma pequena parte do acerto.">Agilidade:</label><input type="number" id="agilidade" value="0" min="0"></div>
                                            <div class="atributo"><label for="constituicao" title="Constitui√ß√£o: Determina os pontos de Vida, Magia e Vigor, e a regenera√ß√£o.">Constitui√ß√£o:</label><input type="number" id="constituicao" value="0" min="0"></div>
                                            <div class="atributo"><label for="inteligencia" title="Intelig√™ncia: Base para o dano m√°gico e a resist√™ncia a magia.">Intelig√™ncia:</label><input type="number" id="inteligencia" value="0" min="0"></div>
                                        </div>
                                        <div class="atributos-coluna-destaque">
                                            <div class="atributo-destaque"><label title="C√°lculo: For√ßa + (Destreza / 5) + B√¥nus de Armas. Representa o dano f√≠sico bruto.">Ataque:</label><span id="ataque" readonly>0</span></div>
                                            <div class="atributo-destaque"><label title="C√°lculo: Intelig√™ncia + B√¥nus de Armas M√°gicas. Representa o dano m√°gico bruto.">Ataque M√°gico:</label><span id="ataque-magico" readonly>0</span></div>
                                            <div class="atributo-destaque"><label title="C√°lculo: (Destreza / 3) + (Agilidade / 10). Sua chance de acertar um alvo com ataques.">Acerto:</label><span id="acerto" readonly>0</span></div>
                                            <div class="atributo-destaque"><label title="C√°lculo: (Agilidade / 3). Sua capacidade de evitar ataques inimigos.">Esquiva:</label><span id="esquiva" readonly>0</span></div>
                                            <div class="atributo-destaque"><label title="C√°lculo: (For√ßa / 5). Resist√™ncia a Dano F√≠sico. Reduz o dano f√≠sico recebido.">RDF:</label><span id="rdf" readonly>0</span></div>
                                            <div class="atributo-destaque"><label title="C√°lculo: (Intelig√™ncia / 5). Resist√™ncia a Dano M√°gico. Reduz o dano m√°gico recebido.">RDM:</label><span id="rdm" readonly>0</span></div>
                                        </div>
                                    </div>
                                </div>
                            </section>`;
                        break;
                    case 'combate':
                        sectionHTML = `
                            <section id="combate">
                                <h2>Combate <span class="collapse-icon">‚ñº</span>
                                    <div class="section-order-buttons">
                                        <button class="order-btn" data-direction="up" title="Mover para Cima">‚ñ≤</button>
                                        <button class="order-btn" data-direction="down" title="Mover para Baixo">‚ñº</button>
                                    </div>
                                </h2>
                                <div class="section-content">
                                    <div class="armamento-container">
                                        <div class="armamento-coluna">
                                            <label>Armamento M√£o Direita:</label>
                                            <div class="flex items-center mb-2"><input type="text" id="arma-direita-nome" placeholder="Nome da Arma" class="mr-2"><span>Ataque </span><input type="number" id="arma-direita-ataque" value="0" class="w-20 mr-2"><span>Ataque M√°gico </span><input type="number" id="arma-direita-ataque-magico" value="0" class="w-20"></div>
                                        </div>
                                        <div class="armamento-coluna">
                                            <label>Armamento M√£o Esquerda:</label>
                                            <div class="flex items-center"><input type="text" id="arma-esquerda-nome" placeholder="Nome da Arma" class="mr-2"><span>Ataque </span><input type="number" id="arma-esquerda-ataque" value="0" class="w-20 mr-2"><span>Ataque M√°gico </span><input type="number" id="arma-esquerda-ataque-magico" value="0" class="w-20"></div>
                                        </div>
                                    </div>
                                </div>
                            </section>`;
                        break;
                    case 'inventario-habilidades':
                        sectionHTML = `
                            <section id="inventario-habilidades">
                                <h2>Invent√°rio e Habilidades <span class="collapse-icon">‚ñº</span>
                                    <div class="section-order-buttons">
                                        <button class="order-btn" data-direction="up" title="Mover para Cima">‚ñ≤</button>
                                        <button class="order-btn" data-direction="down" title="Mover para Baixo">‚ñº</button>
                                    </div>
                                </h2>
                                <div class="section-content">
                                    <div class="flex gap-20">
                                        <div style="width:50%">
                                            <label>Invent√°rio (Peso Total: <span id="peso-total">0</span> kg / <span id="capacidade-carga">5</span> kg):</label>
                                            <div id="inventario-slots">
                                                ${Array(10).fill(0).map((_, i) => `<div class="inventory-slot"><input type="text" placeholder="Item ${i+1}" class="inventory-item"><input type="number" min="0" value="0" class="inventory-weight" title="Peso em kg"></div>`).join('')}
                                            </div>
                                        </div>
                                        <div style="width:50%">
                                            <label>Magias e Habilidades:</label>
                                            <div id="magias-list" class="magias-container">
                                                ${Array(10).fill(0).map((_, i) => `<input type="text" placeholder="Magia/Habilidade ${i+1}" class="magia-nome">`).join('')}
                                            </div>
                                            <button id="adicionar-magia-btn">Adicionar Magia</button>
                                        </div>
                                    </div>
                                    <div class="mt-4">
                                        <label>Vantagens:</label><div id="vantagens-list-display" class="list-display"></div>
                                        <label>Desvantagens:</label><div id="desvantagens-list-display" class="list-display"></div>
                                    </div>
                                    <div class="classe-raca-container">
                                        <label>Classe:</label><input type="text" id="classe-nome" placeholder="Nome da Classe"><textarea id="classe-descricao" placeholder="Descri√ß√£o da Classe" class="expandable-textarea"></textarea>
                                        <label>Ra√ßa:</label><span id="raca-nome" onclick="abrirModalRaca()"></span><textarea id="raca-descricao" placeholder="Descri√ß√£o da Ra√ßa" class="expandable-textarea" readonly></textarea>
                                    </div>
                                </div>
                            </section>`;
                        break;
                    case 'locomocao':
                         sectionHTML = `
                            <section id="locomocao">
                                <h2>Locomo√ß√£o <span class="collapse-icon">‚ñº</span>
                                    <div class="section-order-buttons">
                                        <button class="order-btn" data-direction="up" title="Mover para Cima">‚ñ≤</button>
                                        <button class="order-btn" data-direction="down" title="Mover para Baixo">‚ñº</button>
                                    </div>
                                </h2>
                                <div class="section-content">
                                    <div class="locomotion-container">
                                        <div class="locomotion-item"><label>Velocidade de Corrida (km/h):</label><span>üèÉ‚Äç‚ôÇÔ∏è</span><span id="velocidade-corrida" readonly>25</span></div>
                                        <div class="locomotion-item"><label>Altura do Pulo (m):</label><span>‚¨ÜÔ∏è</span><span id="altura-pulo" readonly>1</span></div>
                                        <div class="locomotion-item"><label>Dist√¢ncia do Pulo (m):</label><span>‚û°Ô∏è</span><span id="distancia-pulo" readonly>3</span></div>
                                    </div>
                                </div>
                            </section>`;
                        break;
                    case 'status':
                        sectionHTML = `
                            <section id="status">
                                <h2>Status <span class="collapse-icon">‚ñº</span>
                                    <div class="section-order-buttons">
                                        <button class="order-btn" data-direction="up" title="Mover para Cima">‚ñ≤</button>
                                        <button class="order-btn" data-direction="down" title="Mover para Baixo">‚ñº</button>
                                    </div>
                                </h2>
                                <div class="section-content">
                                    <div class="flex gap-20">
                                        <div>
                                            <label for="experiencia">Experi√™ncia: <span id="xp-lock-icon" class="lock-icon">üîí</span></label><input type="number" id="experiencia" value="0" min="0">
                                            <label>Pontos de Habilidade (PD):</label><span id="pontos-habilidade" readonly>25</span>
                                            <label>Pontos de Vantagem (PH):</label><span id="pontos-vantagem" readonly>8</span>
                                        </div>
                                        <div></div>
                                    </div>
                                    <div id="nivel-container"><label>N√≠vel:</label><span id="nivel">0</span></div>
                                </div>
                            </section>`;
                        break;
                     case 'riqueza':
                        sectionHTML = `
                            <section id="riqueza">
                                <h2>Riqueza <span class="collapse-icon">‚ñº</span>
                                    <div class="section-order-buttons">
                                        <button class="order-btn" data-direction="up" title="Mover para Cima">‚ñ≤</button>
                                        <button class="order-btn" data-direction="down" title="Mover para Baixo">‚ñº</button>
                                    </div>
                                </h2>
                                <div class="section-content">
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                        <div>
                                            <label for="moeda-ouro">Ouro (MO):</label>
                                            <input type="number" id="moeda-ouro" value="0" min="0">
                                        </div>
                                        <div>
                                            <label for="moeda-prata">Prata (MP):</label>
                                            <input type="number" id="moeda-prata" value="0" min="0">
                                        </div>
                                        <div>
                                            <label for="moeda-cobre">Cobre (MC):</label>
                                            <input type="number" id="moeda-cobre" value="0" min="0">
                                        </div>
                                    </div>
                                </div>
                            </section>`;
                        break;
                }
                if (sectionHTML) {
                    fichaContent.insertAdjacentHTML('beforeend', sectionHTML);
                }
            });

            // Adicionar os bot√µes de controle da ficha e tema no final
            fichaContent.insertAdjacentHTML('beforeend', `
                <div style="display:flex;justify-content:center;gap:20px;margin-bottom:20px">
                    <button id="vantagens-desvantagens-btn" class="botao">Vantagens e Desvantagens</button>
                    <button id="racas-btn" class="botao">Ra√ßas üè∞</button>
                    <button id="classes-btn" class="botao">Classes ‚öîÔ∏è</button>
                </div>
                <div class="botoes-container">
                    <button id="reset-pontos" class="botao botao-reset">Reiniciar Pontos</button>
                    <button id="recomecar" class="botao botao-recomecar">Recome√ßar</button>
                    <button id="bloquear-ficha" class="botao botao-bloquear">Bloquear Ficha</button>
                    <button id="plano-fundo-btn" class="botao">Plano de fundo</button>
                    <button id="excluir-ficha" class="botao botao-excluir">Excluir Ficha</button>
                </div>
                <div class="theme-color-container">
                    <button id="lua-btn" class="botao icon-btn">üåô</button>
                    <button id="sol-btn" class="botao icon-btn">‚òÄÔ∏è</button>
                    <div class="theme-option">
                        <label for="background-color-input" id="cor-fundo-visual-btn" class="botao icon-btn" title="Cor de Fundo" style="cursor: pointer;">üé®</label>
                        <input type="color" id="background-color-input" style="visibility: hidden; width: 0; height: 0; padding:0; margin:0; border:none;">
                    </div>
                    <div class="theme-option">
                        <select id="font-selector" class="botao" title="Fonte Principal" style="padding: 10px 15px; height: 44px; background-color: #800000; color:white; border:none; border-radius:6px; font-family:'MedievalSharp', serif;">
                            <option value="'Inter', sans-serif">Padr√£o (Inter)</option>
                            <option value="'MedievalSharp', cursive">Medieval</option>
                            <option value="'Times New Roman', Times, serif">Times New Roman</option>
                            <option value="'Arial', Helvetica, sans-serif">Arial</option>
                            <option value="'Courier New', Courier, monospace">Courier New</option>
                            <option value="'Georgia', serif">Georgia</option>
                            <option value="'Verdana', Geneva, sans-serif">Verdana</option>
                        </select>
                    </div>
                    <div class="theme-option">
                        <label for="dice-color-input" class="botao icon-btn" id="dice-color-input-visual" title="Cor do Dado" style="cursor: pointer;">üé≤</label>
                        <input type="color" id="dice-color-input" style="visibility: hidden; width: 0; height: 0;">
                    </div>
                    <div class="theme-option">
                        <label for="dice-number-color-input" class="botao icon-btn" id="dice-number-color-input-visual" title="Cor N√∫mero Dado" style="cursor: pointer;">#</label>
                        <input type="color" id="dice-number-color-input" style="visibility: hidden; width: 0; height: 0;">
                    </div>
                </div>
            `);
            
            // Reatribuir refer√™ncias aos elementos DOM ap√≥s a recria√ß√£o
            reasignarElementosDOM();
            // Reaplicar event listeners que foram perdidos
            adicionarEventListenersGlobais();
        }

        function reasignarElementosDOM() {
            // Cache DOM Elements
            Object.assign(window, { // Atribui ao escopo global para f√°cil acesso
                nomePersonagemInput: document.getElementById("nome-personagem"), 
                descricaoPersonagemInput: document.getElementById("descricao-personagem"),
                forcaInput: document.getElementById("forca"), 
                destrezaInput: document.getElementById("destreza"), 
                agilidadeInput: document.getElementById("agilidade"),
                inteligenciaInput: document.getElementById("inteligencia"), 
                constituicaoInput: document.getElementById("constituicao"),
                ataqueSpan: document.getElementById("ataque"), 
                ataqueMagicoSpan: document.getElementById("ataque-magico"), 
                acertoSpan: document.getElementById("acerto"),
                esquivaSpan: document.getElementById("esquiva"), 
                rdfSpan: document.getElementById("rdf"), 
                rdmSpan: document.getElementById("rdm"),
                armaDireitaNomeInput: document.getElementById("arma-direita-nome"), 
                armaDireitaAtaqueInput: document.getElementById("arma-direita-ataque"),
                armaDireitaAtaqueMagicoInput: document.getElementById("arma-direita-ataque-magico"), 
                armaEsquerdaNomeInput: document.getElementById("arma-esquerda-nome"),
                armaEsquerdaAtaqueInput: document.getElementById("arma-esquerda-ataque"), 
                armaEsquerdaAtaqueMagicoInput: document.getElementById("arma-esquerda-ataque-magico"),
                resetPontosButton: document.getElementById("reset-pontos"), 
                recomecarButton: document.getElementById("recomecar"),
                bloquearFichaButton: document.getElementById("bloquear-ficha"), 
                experienciaInput: document.getElementById("experiencia"),
                xpLockIcon: document.getElementById("xp-lock-icon"),
                nivelSpan: document.getElementById("nivel"), 
                pontosHabilidadeSpan: document.getElementById("pontos-habilidade"),
                pontosVantagemSpan: document.getElementById("pontos-vantagem"), 
                velocidadeCorridaSpan: document.getElementById("velocidade-corrida"),
                alturaPuloSpan: document.getElementById("altura-pulo"), 
                distanciaPuloSpan: document.getElementById("distancia-pulo"),
                // nomePersonagemTitulo j√° √© global
                // gameMasterMessage j√° √© global
                vantagensListDisplay: document.getElementById("vantagens-list-display"), 
                desvantagensListDisplay: document.getElementById("desvantagens-list-display"),
                inventarioSlots: document.getElementById("inventario-slots"), 
                pesoTotalSpan: document.getElementById("peso-total"),
                capacidadeCargaSpan: document.getElementById("capacidade-carga"),
                // diceContainer j√° √© global
                // diceRoll j√° √© global
                // diceResult j√° √© global
                changeDiceTypeBtn: document.getElementById('change-dice-type-btn'), 
                diceOptionsMenu: document.getElementById('dice-options-menu'), 
                // notification j√° √© global
                // characterImageInput j√° √© global
                // characterImage j√° √© global
                vantagensDesvantagensBtn: document.getElementById("vantagens-desvantagens-btn"),
                // vantagensDesvantagensPanel j√° √© global
                // vantagensList j√° √© global
                // desvantagensList j√° √© global
                salvarVantagensBtn: document.getElementById("salvar-vantagens-btn"),
                fecharPaginaBtn: document.getElementById("fechar-pagina-btn"), 
                // fichaContainer j√° √© global
                magiasList: document.getElementById("magias-list"), 
                adicionarMagiaBtn: document.getElementById("adicionar-magia-btn"),
                anotacoesBtn: document.getElementById("anotacoes-btn"), 
                anotacoesTextarea: document.getElementById("anotacoes-textarea"),
                racasBtn: document.getElementById("racas-btn"), 
                classesBtn: document.getElementById("classes-btn"), 
                // racasPanel j√° √© global
                // classesPanel j√° √© global
                fecharRacasBtn: document.getElementById("fechar-racas-btn"),
                fecharClassesBtn: document.getElementById("fechar-classes-btn"), 
                classeNomeInput: document.getElementById("classe-nome"),
                classeDescricaoInput: document.getElementById("classe-descricao"), 
                racaNomeSpan: document.getElementById("raca-nome"),
                racaDescricaoInput: document.getElementById("raca-descricao"), 
                luaBtn: document.getElementById("lua-btn"), 
                solBtn: document.getElementById("sol-btn"),
                salvarRacasBtn: document.getElementById("salvar-racas-btn"), 
                racasList: document.getElementById("racas-list"),
                planoFundoBtn: document.getElementById("plano-fundo-btn"),
                backgroundImageInput: document.getElementById("background-image-input"), 
                // backgroundModal j√° √© global
                backgroundColorInput: document.getElementById('background-color-input'), 
                backgroundColorButtonVisual: document.getElementById('cor-fundo-visual-btn'), 
                fontSelector: document.getElementById('font-selector'), 
                confirmarSalvarBtn: document.getElementById("confirmar-salvar-btn"),
                phTempRacaSpan: document.getElementById("ph-temp-raca"),
                // senhaGmTitulo j√° √© global
                diceColorInput: document.getElementById('dice-color-input'),
                diceColorVisualBtn: document.getElementById('dice-color-input-visual'), 
                diceNumberColorInput: document.getElementById('dice-number-color-input'),
                diceNumberColorVisualBtn: document.getElementById('dice-number-color-input-visual'),
                // diceHistoryTrigger j√° √© global
                // diceHistoryPanel j√° √© global
                // diceHistoryList j√° √© global
                // fecharHistoricoBtn j√° √© global
                limparHistoricoBtn: document.getElementById('limpar-historico-btn'),
                ouroInput: document.getElementById('moeda-ouro'),
                prataInput: document.getElementById('moeda-prata'),
                cobreInput: document.getElementById('moeda-cobre')
            });
            // Recriar a lista de atributosInputs
            window.atributosInputs = [forcaInput, destrezaInput, agilidadeInput, inteligenciaInput, constituicaoInput];
        }


        function criarFichaMatriz() {
            fichas = getFichasFromStorage(); 
            if (!fichas[FICHA_MATRIZ_ID]) {
                const fichaMatriz = {
                    nomeFicha: "Matriz", nomePersonagem: "Personagem Matriz", descricaoPersonagem: "Ficha original do sistema",
                    forca: "0", destreza: "0", agilidade: "0", inteligencia: "0", constituicao: "0", experiencia: "0",
                    armaDireitaNome: "", armaDireitaAtaque: "0", armaDireitaAtaqueMagico: "0",
                    armaEsquerdaNome: "", armaEsquerdaAtaque: "0", armaEsquerdaAtaqueMagico: "0",
                    vantagens: "", magiasHabilidades: Array(10).fill("").join("\n"), desvantagens: "",
                    inventario: Array(10).fill({ item: "", peso: "0" }),
                    moedas: { ouro: 0, prata: 0, cobre: 0 }, // Novo
                    velocidadeCorrida: "25", alturaPulo: "1", distanciaPulo: "3",
                    isLocked: true, password: senhaMatriz, imagem: null, anotacoes: "",
                    classeNome: "", classeDescricao: "", racaNome: "", racaDescricao: "", racaSelecionada: "",
                    backgroundImage: null, backgroundSize: 'cover', backgroundColor: '#f0e6d2', 
                    fontFamily: "'Inter', sans-serif",
                    vidaAtual: 50, magiaAtual: 20, vigorAtual: 10,
                    diceColor: '#f0e6d2', diceNumberColor: '#000000',
                    diceRolls: [],
                    collapsedSections: {},
                    sectionOrder: [...sectionOrder] // Salva a ordem padr√£o
                };
                fichas[FICHA_MATRIZ_ID] = fichaMatriz;
                saveFichasToStorage(fichas);
            }
        }
        
        function carregarFichas() {
            criarFichaMatriz();
            fichas = getFichasFromStorage();
            const storedCurrentFichaId = getCurrentFichaIdFromStorage();

            if (storedCurrentFichaId && fichas[storedCurrentFichaId]) {
                currentFichaId = storedCurrentFichaId;
            } else {
                currentFichaId = FICHA_MATRIZ_ID; // Fallback para a matriz
                saveCurrentFichaIdToStorage(currentFichaId);
            }
            
            // Define a ordem das se√ß√µes antes de carregar a ficha
            if (fichas[currentFichaId] && fichas[currentFichaId].sectionOrder) {
                sectionOrder = [...fichas[currentFichaId].sectionOrder];
            } else {
                 sectionOrder = [ // Ordem padr√£o se n√£o houver salva
                    'informacoes-basicas', 'recursos', 'atributos', 'combate', 
                    'inventario-habilidades', 'locomocao', 'status', 'riqueza' 
                ];
            }
            criarEstruturaFicha(); // Cria o HTML das se√ß√µes na ordem correta
            carregarFicha(currentFichaId);
            atualizarAbasFichas();
        }


        function atualizarAbasFichas() {
            const sidebar = document.getElementById("fichas-sidebar"), addBtn = document.getElementById("add-ficha-btn");
            // Limpa abas existentes, exceto o bot√£o de adicionar
            const abasExistentes = sidebar.querySelectorAll('.ficha-tab');
            abasExistentes.forEach(aba => sidebar.removeChild(aba));


            for (let fichaId in fichas) {
                // N√£o mostrar a ficha matriz como uma aba normal se n√£o for a √∫nica ou a atual
                 if (fichaId === FICHA_MATRIZ_ID && (Object.keys(fichas).length > 1 && currentFichaId !== FICHA_MATRIZ_ID) ) {
                    continue;
                }

                const tab = document.createElement("div"); tab.className = "ficha-tab";
                const span = document.createElement("span"); 
                span.textContent = fichas[fichaId].nomeFicha || (fichaId === FICHA_MATRIZ_ID ? "Matriz" : "Sem Nome");
                tab.appendChild(span); tab.dataset.fichaId = fichaId;
                if (fichaId === currentFichaId) tab.classList.add("active");
                
                tab.addEventListener('click', (e) => { // Adiciona listener aqui
                    aplicarFeedbackBotao(e.currentTarget);
                    if (currentFichaId === fichaId) return; // N√£o recarregar se j√° for a ativa

                    currentFichaId = fichaId;
                    saveCurrentFichaIdToStorage(currentFichaId);
                     // Reordenar e recarregar
                    if (fichas[currentFichaId] && fichas[currentFichaId].sectionOrder) {
                        sectionOrder = [...fichas[currentFichaId].sectionOrder];
                    } else {
                        sectionOrder = [ 
                            'informacoes-basicas', 'recursos', 'atributos', 'combate', 
                            'inventario-habilidades', 'locomocao', 'status', 'riqueza' 
                        ];
                    }
                    criarEstruturaFicha(); // Recria a estrutura HTML
                    carregarFicha(currentFichaId); // Carrega os dados na nova estrutura
                    atualizarAbasFichas(); // Atualiza qual aba est√° ativa
                });
                sidebar.insertBefore(tab, addBtn);
            }
        }


        document.getElementById("add-ficha-btn").onclick = (e) => {
            aplicarFeedbackBotao(e.currentTarget);
            document.getElementById("nome-ficha-modal").style.display = "flex"; 
            document.getElementById("nome-ficha-input").value = ""; 
            document.getElementById("nome-ficha-input").focus();
        };

        function criarNovaFicha() {
            aplicarFeedbackBotao(document.querySelector('#nome-ficha-modal .confirm-btn'));
            const nomeFicha = document.getElementById("nome-ficha-input").value.trim();
            if (!nomeFicha) return alert("Por favor, d√™ um nome √† ficha!");
            const novaFichaId = generateLocalId();
            const novaFicha = {
                nomeFicha, nomePersonagem: "", descricaoPersonagem: "", forca: "0", destreza: "0", agilidade: "0",
                inteligencia: "0", constituicao: "0", experiencia: "0", armaDireitaNome: "", armaDireitaAtaque: "0",
                armaDireitaAtaqueMagico: "0", armaEsquerdaNome: "", armaEsquerdaAtaque: "0", armaEsquerdaAtaqueMagico: "0",
                vantagens: "", magiasHabilidades: Array(10).fill("").join("\n"), desvantagens: "",
                inventario: Array(10).fill({ item: "", peso: "0" }),
                moedas: { ouro: 0, prata: 0, cobre: 0 },
                velocidadeCorrida: "25", alturaPulo: "1", distanciaPulo: "3",
                isLocked: false, password: null, imagem: null, anotacoes: "",
                classeNome: "", classeDescricao: "", racaNome: "", racaDescricao: "", racaSelecionada: "",
                backgroundImage: null, backgroundSize: 'cover', backgroundColor: '#f0e6d2',
                fontFamily: "'Inter', sans-serif", 
                vidaAtual: 50, magiaAtual: 20, vigorAtual: 10,
                diceColor: '#f0e6d2', diceNumberColor: '#000000',
                diceRolls: [],
                collapsedSections: {},
                sectionOrder: [ // Ordem padr√£o para novas fichas
                    'informacoes-basicas', 'recursos', 'atributos', 'combate', 
                    'inventario-habilidades', 'locomocao', 'status', 'riqueza' 
                ]
            };
            fichas[novaFichaId] = novaFicha;
            saveFichasToStorage(fichas);
            
            currentFichaId = novaFichaId; // Define a nova ficha como atual
            saveCurrentFichaIdToStorage(currentFichaId);
            
            // Recria a estrutura com a ordem da nova ficha e carrega os dados
            sectionOrder = [...novaFicha.sectionOrder]; 
            criarEstruturaFicha();
            carregarFicha(novaFichaId);
            
            fecharModal("nome-ficha-modal");
            atualizarAbasFichas();
        }

        function fecharModal(modalId) { 
            const modalElement = document.getElementById(modalId);
            if (modalElement) modalElement.style.display = "none"; 
        }


        function carregarFicha(fichaId) {
            if (!fichas[fichaId]) {
                console.error("Ficha n√£o encontrada:", fichaId);
                currentFichaId = FICHA_MATRIZ_ID; // Fallback para a ficha matriz
                saveCurrentFichaIdToStorage(currentFichaId);
                if (!fichas[currentFichaId]) criarFichaMatriz(); // Garante que a matriz exista
                fichaId = currentFichaId;
            }
            const ficha = fichas[fichaId];
            if (!ficha) {
                alert("Erro cr√≠tico: N√£o foi poss√≠vel carregar a ficha " + fichaId);
                return;
            }
            if (!ficha.diceRolls) ficha.diceRolls = [];
            if (!ficha.collapsedSections) ficha.collapsedSections = {};
            if (!ficha.moedas) ficha.moedas = { ouro: 0, prata: 0, cobre: 0 }; // Garante que moedas exista
            if (!ficha.sectionOrder) { // Se a ordem n√£o estiver salva, usa a padr√£o
                ficha.sectionOrder = [
                    'informacoes-basicas', 'recursos', 'atributos', 'combate', 
                    'inventario-habilidades', 'locomocao', 'status', 'riqueza'
                ];
            }
            // A estrutura HTML j√° foi criada por criarEstruturaFicha() antes de chamar carregarFicha()
            // Ent√£o, apenas populamos os campos.


            // Refer√™ncias aos elementos (alguns j√° s√£o globais, mas reafirmar para clareza)
            const nomePersonagemInput = document.getElementById("nome-personagem");
            const descricaoPersonagemInput = document.getElementById("descricao-personagem");
            const forcaInput = document.getElementById("forca");
            const destrezaInput = document.getElementById("destreza");
            const agilidadeInput = document.getElementById("agilidade");
            const inteligenciaInput = document.getElementById("inteligencia");
            const constituicaoInput = document.getElementById("constituicao");
            const experienciaInput = document.getElementById("experiencia");
            const xpLockIcon = document.getElementById("xp-lock-icon");
            const armaDireitaNomeInput = document.getElementById("arma-direita-nome");
            const armaDireitaAtaqueInput = document.getElementById("arma-direita-ataque");
            const armaDireitaAtaqueMagicoInput = document.getElementById("arma-direita-ataque-magico");
            const armaEsquerdaNomeInput = document.getElementById("arma-esquerda-nome");
            const armaEsquerdaAtaqueInput = document.getElementById("arma-esquerda-ataque");
            const armaEsquerdaAtaqueMagicoInput = document.getElementById("arma-esquerda-ataque-magico");
            const velocidadeCorridaSpan = document.getElementById("velocidade-corrida");
            const alturaPuloSpan = document.getElementById("altura-pulo");
            const distanciaPuloSpan = document.getElementById("distancia-pulo");
            const vantagensListDisplay = document.getElementById("vantagens-list-display");
            const desvantagensListDisplay = document.getElementById("desvantagens-list-display");
            const inventarioSlots = document.getElementById("inventario-slots");
            const magiasList = document.getElementById("magias-list");
            const anotacoesTextarea = document.getElementById("anotacoes-textarea");
            const classeNomeInput = document.getElementById("classe-nome");
            const classeDescricaoInput = document.getElementById("classe-descricao");
            const racaNomeSpan = document.getElementById("raca-nome");
            const racaDescricaoInput = document.getElementById("raca-descricao");
            const characterImage = document.getElementById("character-image");
            const ouroInput = document.getElementById('moeda-ouro');
            const prataInput = document.getElementById('moeda-prata');
            const cobreInput = document.getElementById('moeda-cobre');


            if (nomePersonagemInput) nomePersonagemInput.value = ficha.nomePersonagem || ""; 
            if (descricaoPersonagemInput) descricaoPersonagemInput.value = ficha.descricaoPersonagem || "";
            if (forcaInput) forcaInput.value = ficha.forca || "0"; 
            if (destrezaInput) destrezaInput.value = ficha.destreza || "0"; 
            if (agilidadeInput) agilidadeInput.value = ficha.agilidade || "0";
            if (inteligenciaInput) inteligenciaInput.value = ficha.inteligencia || "0"; 
            if (constituicaoInput) constituicaoInput.value = ficha.constituicao || "0"; 
            if (experienciaInput) experienciaInput.value = ficha.experiencia || "0";
            if (armaDireitaNomeInput) armaDireitaNomeInput.value = ficha.armaDireitaNome || ""; 
            if (armaDireitaAtaqueInput) armaDireitaAtaqueInput.value = ficha.armaDireitaAtaque || "0"; 
            if (armaDireitaAtaqueMagicoInput) armaDireitaAtaqueMagicoInput.value = ficha.armaDireitaAtaqueMagico || "0";
            if (armaEsquerdaNomeInput) armaEsquerdaNomeInput.value = ficha.armaEsquerdaNome || ""; 
            if (armaEsquerdaAtaqueInput) armaEsquerdaAtaqueInput.value = ficha.armaEsquerdaAtaque || "0"; 
            if (armaEsquerdaAtaqueMagicoInput) armaEsquerdaAtaqueMagicoInput.value = ficha.armaEsquerdaAtaqueMagico || "0";
            
            if (ouroInput) ouroInput.value = ficha.moedas.ouro || 0;
            if (prataInput) prataInput.value = ficha.moedas.prata || 0;
            if (cobreInput) cobreInput.value = ficha.moedas.cobre || 0;


            if (velocidadeCorridaSpan) velocidadeCorridaSpan.textContent = ficha.velocidadeCorrida || "25"; 
            if (alturaPuloSpan) alturaPuloSpan.textContent = ficha.alturaPulo || "1"; 
            if (distanciaPuloSpan) distanciaPuloSpan.textContent = ficha.distanciaPulo || "3";
            
            isFichaLocked = ficha.isLocked || false; 
            fichaPassword = ficha.password || null; 
            isFichaUnlocked = false;
            
            vantagensSelecionadas = ficha.vantagens ? ficha.vantagens.split("\n").filter(v => v.trim()) : [];
            desvantagensSelecionadas = ficha.desvantagens ? ficha.desvantagens.split("\n").filter(d => d.trim()) : [];
            racaSelecionada = ficha.racaSelecionada || "";
            
            if(racaNomeSpan) racaNomeSpan.textContent = racaSelecionada ? racaSelecionada.split(" (")[0] : "";
            if(racaDescricaoInput) racaDescricaoInput.value = racasData.find(r => r.nome === racaSelecionada)?.vantagens.join("\n\n") || "";

            if(vantagensListDisplay) vantagensListDisplay.innerHTML = ""; 
            if(desvantagensListDisplay) desvantagensListDisplay.innerHTML = "";
            vantagensSelecionadas.forEach(v => { const div = document.createElement("div"); div.textContent = v; div.className = "list-item"; div.onclick = () => removerVantagem(v); vantagensListDisplay.appendChild(div); });
            desvantagensSelecionadas.forEach(d => { const div = document.createElement("div"); div.textContent = d; div.className = "list-item"; div.onclick = () => removerDesvantagem(d); desvantagensListDisplay.appendChild(div); });

            const inventario = Array.isArray(ficha.inventario) ? ficha.inventario : Array(10).fill({ item: "", peso: "0" });
            const slots = inventarioSlots.querySelectorAll(".inventory-slot");
            slots.forEach((slot, i) => { slot.querySelector(".inventory-item").value = inventario[i]?.item || ""; slot.querySelector(".inventory-weight").value = inventario[i]?.peso || "0"; });
            calcularPesoTotal(); 

            const magias = ficha.magiasHabilidades ? ficha.magiasHabilidades.split("\n") : Array(10).fill("");
            magiasList.innerHTML = "";
            magias.forEach((m, i) => { const input = document.createElement("input"); input.type = "text"; input.className = "magia-nome"; input.placeholder = `Magia/Habilidade ${i + 1}`; input.value = m; input.addEventListener('input', salvarDados); magiasList.appendChild(input); });
            
            if (anotacoesTextarea) anotacoesTextarea.value = ficha.anotacoes || ""; 
            if (classeNomeInput) classeNomeInput.value = ficha.classeNome || ""; 
            if (classeDescricaoInput) classeDescricaoInput.value = ficha.classeDescricao || "";
            if (characterImage) {
                if (ficha.imagem && ficha.imagem.startsWith('data:image')) { 
                    characterImage.src = ficha.imagem; 
                    characterImage.style.display = "block"; 
                } else { 
                    characterImage.src = ''; 
                    characterImage.style.display = "none"; 
                }
            }

            atualizarBotaoBloquear(); 
            atualizarVantagensDesvantagensPanel();
            atualizarRacasPanel();
            
            experiencia = parseInt(experienciaInput.value) || 0;
            if (experienciaInput) experienciaInput.readOnly = true; 
            if (xpLockIcon) xpLockIcon.textContent = 'üîí'; 
            isXpUnlocked = false; 
            if (xpUnlockTimerId) clearTimeout(xpUnlockTimerId); 

            vidaAtual = ficha.vidaAtual !== undefined ? ficha.vidaAtual : (parseInt(document.getElementById("vida-total").textContent) || 50);
            magiaAtual = ficha.magiaAtual !== undefined ? ficha.magiaAtual : (parseInt(document.getElementById("magia-total").textContent) || 20);
            vigorAtual = ficha.vigorAtual !== undefined ? ficha.vigorAtual : (parseFloat(document.getElementById("vigor-total").textContent) || 10);

            atualizarNivel(); 
            
            document.getElementById("vida-atual").textContent = Math.min(vidaAtual, vidaTotal);
            document.getElementById("magia-atual").textContent = Math.min(magiaAtual, magiaTotal);
            document.getElementById("vigor-atual").textContent = Math.min(vigorAtual, vigorTotal).toFixed(1);
            
            vidaAtual = Math.min(vidaAtual, vidaTotal);
            magiaAtual = Math.min(magiaAtual, magiaTotal);
            vigorAtual = Math.min(vigorAtual, vigorTotal);

            if(pontosVantagemSpan) pontosVantagemSpan.textContent = getPontosVantagem();
            previousValues.clear(); 
            document.querySelectorAll('input[type="text"],input[type="number"],textarea').forEach(input => {
                previousValues.set(input, input.value); 
            });
            
            aplicarPlanoDeFundoInicial(ficha); 
            aplicarCorDeFundoInicial(ficha);   
            aplicarFonteInicial(ficha);
            aplicarCoresDadoInicial(ficha); 
            aplicarEstadoColapsoSecoes(ficha.collapsedSections);
            document.body.classList.toggle("dark-mode", ficha.darkMode === true);
        }

        function atualizarBotaoBloquear() {
            if (!bloquearFichaButton) return;
            bloquearFichaButton.textContent = isFichaLocked ? "Desbloquear Ficha" : "Bloquear Ficha";
            bloquearFichaButton.classList.toggle("botao-bloquear", !isFichaLocked); 
            bloquearFichaButton.classList.toggle("botao-desbloquear", isFichaLocked);
        }

        function salvarDados() {
            if (!currentFichaId || !fichas[currentFichaId] || (isFichaLocked && !isFichaUnlocked)) return;

            const inventario = Array.from(document.querySelectorAll("#inventario-slots .inventory-slot")).map(slot => ({ item: slot.querySelector(".inventory-item").value, peso: slot.querySelector(".inventory-weight").value }));
            const magias = Array.from(document.querySelectorAll("#magias-list .magia-nome")).map(input => input.value);
            
            const fichaAtual = fichas[currentFichaId];
            if (!fichaAtual) return;


            fichaAtual.nomePersonagem = document.getElementById("nome-personagem").value;
            fichaAtual.descricaoPersonagem = document.getElementById("descricao-personagem").value;
            fichaAtual.forca = document.getElementById("forca").value;
            fichaAtual.destreza = document.getElementById("destreza").value;
            fichaAtual.agilidade = document.getElementById("agilidade").value;
            fichaAtual.inteligencia = document.getElementById("inteligencia").value;
            fichaAtual.constituicao = document.getElementById("constituicao").value;
            fichaAtual.experiencia = document.getElementById("experiencia").value;
            fichaAtual.armaDireitaNome = document.getElementById("arma-direita-nome").value;
            fichaAtual.armaDireitaAtaque = document.getElementById("arma-direita-ataque").value;
            fichaAtual.armaDireitaAtaqueMagico = document.getElementById("arma-direita-ataque-magico").value;
            fichaAtual.armaEsquerdaNome = document.getElementById("arma-esquerda-nome").value;
            fichaAtual.armaEsquerdaAtaque = document.getElementById("arma-esquerda-ataque").value;
            fichaAtual.armaEsquerdaAtaqueMagico = document.getElementById("arma-esquerda-ataque-magico").value;
            
            fichaAtual.moedas = {
                ouro: parseInt(document.getElementById('moeda-ouro').value) || 0,
                prata: parseInt(document.getElementById('moeda-prata').value) || 0,
                cobre: parseInt(document.getElementById('moeda-cobre').value) || 0
            };

            fichaAtual.vantagens = vantagensSelecionadas.join("\n");
            fichaAtual.magiasHabilidades = magias.join("\n");
            fichaAtual.desvantagens = desvantagensSelecionadas.join("\n");
            fichaAtual.inventario = inventario;
            fichaAtual.velocidadeCorrida = document.getElementById("velocidade-corrida").textContent;
            fichaAtual.alturaPulo = document.getElementById("altura-pulo").textContent;
            fichaAtual.distanciaPulo = document.getElementById("distancia-pulo").textContent;
            fichaAtual.isLocked = isFichaLocked;
            fichaAtual.password = fichaPassword;
            fichaAtual.imagem = document.getElementById("character-image").src.startsWith('data:image') ? document.getElementById("character-image").src : null;
            fichaAtual.anotacoes = document.getElementById("anotacoes-textarea").value;
            fichaAtual.classeNome = document.getElementById("classe-nome").value;
            fichaAtual.classeDescricao = document.getElementById("classe-descricao").value;
            fichaAtual.racaNome = document.getElementById("raca-nome").textContent; 
            fichaAtual.racaDescricao = document.getElementById("raca-descricao").value;
            fichaAtual.racaSelecionada = racaSelecionada; 
            fichaAtual.diceRolls = fichaAtual.diceRolls || []; 
            
            fichaAtual.collapsedSections = {}; 
            document.querySelectorAll('#ficha-content section').forEach(section => {
                const content = section.querySelector('.section-content');
                if (content && section.id) {
                    fichaAtual.collapsedSections[section.id] = content.classList.contains('collapsed');
                }
            });
             fichaAtual.sectionOrder = [...sectionOrder];


            fichaAtual.backgroundImage = document.body.style.backgroundImage === 'none' || document.body.style.backgroundImage === '' ? null : document.body.style.backgroundImage.slice(5, -2).replace(/"/g, "").replace(/'/g, "");
            fichaAtual.backgroundSize = document.body.style.backgroundSize;
            fichaAtual.backgroundColor = document.body.style.backgroundColor;
            fichaAtual.darkMode = document.body.classList.contains("dark-mode");
            fichaAtual.fontFamily = document.getElementById('font-selector') ? document.getElementById('font-selector').value : "'Inter', sans-serif";
            
            fichaAtual.diceColor = document.getElementById('dice-color-input').value; 
            fichaAtual.diceNumberColor = document.getElementById('dice-number-color-input').value; 


            fichaAtual.vidaAtual = vidaAtual;
            fichaAtual.magiaAtual = magiaAtual;
            fichaAtual.vigorAtual = vigorAtual;

            saveFichasToStorage(fichas);
            showNotification("Salvo Localmente!", "save-success");
        }

        function calcularNivel(exp) { return nivelData.findLast(data => exp >= data.xp)?.nivel ?? 0; }

        // --- FUN√á√ïES DOS FOGOS DE ARTIF√çCIO ---
        function criarParticulaFogos(x, y, cor, tipo) {
            const particula = document.createElement('div');
            particula.className = 'firework-particle'; 
            particula.style.position = 'absolute';
            particula.style.left = x + 'px';
            particula.style.top = y + 'px';
            
            const tamanhoBase = tipo === 'foguete' ? 4 : (Math.random() * 4 + 2); 
            particula.style.width = tamanhoBase + 'px';
            particula.style.height = (tipo === 'foguete' ? tamanhoBase * 4 : tamanhoBase) + 'px';
            
            particula.style.backgroundColor = cor;
            particula.style.borderRadius = '50%';
            particula.style.opacity = '1';
            
            fireworksContainerRef.appendChild(particula);
            return particula;
        }

        function animarExplosaoFogos(particulaMae) {
            const numParticulasExplosao = 30 + Math.floor(Math.random() * 30); 
            const corBase = particulaMae.style.backgroundColor;
            const xBase = parseFloat(particulaMae.style.left);
            const yBase = parseFloat(particulaMae.style.top);

            particulaMae.remove(); 

            for (let i = 0; i < numParticulasExplosao; i++) {
                const p = criarParticulaFogos(xBase, yBase, corBase, 'explosao');
                const angulo = Math.random() * Math.PI * 2;
                const forca = Math.random() * 100 + 80; 
                const duracao = Math.random() * 1.0 + 0.8; 
                
                const targetX = xBase + Math.cos(angulo) * forca;
                const targetYFinal = yBase + Math.sin(angulo) * forca + (Math.random() * 100 + 50); 
                
                p.style.animation = `particle-trail ${duracao}s ease-out forwards`;
                p.style.transition = `transform ${duracao}s cubic-bezier(0.1, 0.7, 0.3, 1)`; 
                
                void p.offsetWidth;

                p.style.transform = `translate(${targetX - xBase}px, ${targetYFinal - yBase}px) scale(0.5)`;
                
                setTimeout(() => {
                    if (p && p.parentNode) p.remove(); 
                }, duracao * 1000 + 200); 
            }
        }

        function dispararFogoDeArtificioIndividual() {
            if (!fireworksContainerRef) return;
            const cores = ['#FF5252', '#FFC107', '#4CAF50', '#2196F3', '#9C27B0', '#FFEB3B', '#FF4081', '#00BCD4', '#FF9800'];
            const cor = cores[Math.floor(Math.random() * cores.length)];
            
            const startX = Math.random() * window.innerWidth;
            const startY = window.innerHeight;
            const endY = Math.random() * (window.innerHeight * 0.4) + (window.innerHeight * 0.1); 

            const foguete = criarParticulaFogos(startX, startY, cor, 'foguete');
            const duracaoSubida = Math.random() * 1.2 + 0.6; 

            foguete.style.transition = `transform ${duracaoSubida}s ease-out`; 
            void foguete.offsetWidth; 

            foguete.style.transform = `translateY(${endY - startY}px)`;

            setTimeout(() => {
                animarExplosaoFogos(foguete);
            }, duracaoSubida * 1000);
        }

        function dispararFogosDeArtificio(quantidade) {
            for (let i = 0; i < quantidade; i++) {
                setTimeout(dispararFogoDeArtificioIndividual, Math.random() * 1000 + (i * 150)); 
            }
        }
        // --- FIM FUN√á√ïES DOS FOGOS DE ARTIF√çCIO ---

        function atualizarNivel() {
            nivelAnterior = nivel; 
            nivel = calcularNivel(experiencia); 
            if(nivelSpan) nivelSpan.textContent = nivel;
            
            const nivelInfo = nivelData.find(data => data.nivel === nivel) || nivelData[0];
            pontosHabilidadeTotal = nivelInfo.pd;
            if(pontosVantagemSpan) pontosVantagemSpan.textContent = getPontosVantagem();

            if (nivel > nivelAnterior) { 
                if(nivelSpan) nivelSpan.classList.add("aura-azul"); 
                setTimeout(() => { if(nivelSpan) nivelSpan.classList.remove("aura-azul") }, 5000); 
                showNotification(`Parab√©ns! Voc√™ alcan√ßou o N√≠vel ${nivel}!`, "critical-success"); 
                dispararFogosDeArtificio(7 + Math.floor(Math.random() * 6)); 
            }
            if(gameMasterMessage) gameMasterMessage.style.display = nivel >= 30 ? "block" : "none"; 
            if(fichaContainer) fichaContainer.classList.toggle("aura-azul", nivel >= 30);
            calcularAtributos();
        }


        function getPontosVantagem() {
            let ph = (nivelData.find(data => data.nivel === nivel) || nivelData[0]).ph;
            vantagensSelecionadas.forEach(v => { const vantagem = vantagensData.find(d => d.nome === v); if (vantagem) ph -= vantagem.custo; });
            desvantagensSelecionadas.forEach(d => { const desvantagem = desvantagensData.find(desv => desv.nome === d); if (desvantagem) ph += desvantagem.ganho; });
            if (racaSelecionada) { const raca = racasData.find(r => r.nome === racaSelecionada); if (raca) ph -= raca.custo; }
            return ph;
        }

        function calcularPontosVantagemTemp() {
            let ph = (nivelData.find(data => data.nivel === nivel) || nivelData[0]).ph;
            tempVantagensSelecionadas.forEach(v => { const vantagem = vantagensData.find(d => d.nome === v); if (vantagem) ph -= vantagem.custo; });
            tempDesvantagensSelecionadas.forEach(d => { const desvantagem = desvantagensData.find(desv => desv.nome === d); if (desvantagem) ph += desvantagem.ganho; });
            if (tempRacaSelecionada) { const raca = racasData.find(r => r.nome === tempRacaSelecionada); if (raca) ph -= raca.custo; }
            return ph;
        }

        function aumentarVida() { if (vidaAtual < vidaTotal) { vidaAtual++; document.getElementById("vida-atual").textContent = vidaAtual; salvarDados(); } }
        function diminuirVida() { if (vidaAtual > 0) { vidaAtual--; document.getElementById("vida-atual").textContent = vidaAtual; salvarDados(); } }
        function aumentarMagia() { if (magiaAtual < magiaTotal) { magiaAtual++; document.getElementById("magia-atual").textContent = magiaAtual; salvarDados(); } }
        function diminuirMagia() { if (magiaAtual > 0) { magiaAtual--; document.getElementById("magia-atual").textContent = magiaAtual; salvarDados(); } }
        function aumentarVigor() { if (vigorAtual < vigorTotal) { vigorAtual = Math.min(vigorAtual + 0.1, vigorTotal); document.getElementById("vigor-atual").textContent = vigorAtual.toFixed(1); salvarDados(); } }
        function diminuirVigor() { if (vigorAtual > 0) { vigorAtual = Math.max(vigorAtual - 0.1, 0); document.getElementById("vigor-atual").textContent = vigorAtual.toFixed(1); salvarDados(); } }


        function calcularAtributos() {
            const currentForca = parseInt(document.getElementById("forca").value) || 0;
            const currentDestreza = parseInt(document.getElementById("destreza").value) || 0;
            const currentAgilidade = parseInt(document.getElementById("agilidade").value) || 0;
            const currentInteligencia = parseInt(document.getElementById("inteligencia").value) || 0;
            const currentConstituicao = parseInt(document.getElementById("constituicao").value) || 0;

            let totalPontosAtuais = currentForca + currentDestreza + currentAgilidade + currentInteligencia + currentConstituicao;
            const pontosHabilidadeDisponiveis = pontosHabilidadeTotal - pontosHabilidadeUsados;

            if (totalPontosAtuais > pontosHabilidadeTotal) {
                 alert("Pontos de habilidade insuficientes! Os valores dos atributos ser√£o revertidos para o estado anterior v√°lido.");
                document.getElementById("forca").value = previousValues.get(document.getElementById("forca")) || "0";
                document.getElementById("destreza").value = previousValues.get(document.getElementById("destreza")) || "0";
                document.getElementById("agilidade").value = previousValues.get(document.getElementById("agilidade")) || "0";
                document.getElementById("inteligencia").value = previousValues.get(document.getElementById("inteligencia")) || "0";
                document.getElementById("constituicao").value = previousValues.get(document.getElementById("constituicao")) || "0";
                // Recalcular com valores revertidos
                return calcularAtributos(); 
            }
            
            previousValues.set(document.getElementById("forca"), document.getElementById("forca").value);
            previousValues.set(document.getElementById("destreza"), document.getElementById("destreza").value);
            previousValues.set(document.getElementById("agilidade"), document.getElementById("agilidade").value);
            previousValues.set(document.getElementById("inteligencia"), document.getElementById("inteligencia").value);
            previousValues.set(document.getElementById("constituicao"), document.getElementById("constituicao").value);


            pontosHabilidadeUsados = totalPontosAtuais; 
            document.getElementById("pontos-habilidade").textContent = pontosHabilidadeTotal - pontosHabilidadeUsados;

            let ataque = currentForca + Math.floor(currentDestreza / 5);
            let acerto = Math.floor(currentDestreza / 3) + Math.floor(currentAgilidade / 10);
            let esquiva = Math.floor(currentAgilidade / 3);
            let rdf = Math.floor(currentForca / 5);
            let rdm = Math.floor(currentInteligencia / 5);
            let ataqueMagico = currentInteligencia;
            let magiaBase = 20 + 3 * currentConstituicao;
            let vigorBase = 10 + 0.4 * currentConstituicao;
            vidaBase = 50 + (currentConstituicao * (3 + Math.floor(currentForca / 10))) + 10 * nivel;
            if (currentInteligencia >= 10) magiaBase += currentConstituicao * Math.floor(currentInteligencia / 10);

            ataque += (parseInt(document.getElementById("arma-direita-ataque").value) || 0) + (parseInt(document.getElementById("arma-esquerda-ataque").value) || 0);
            ataqueMagico += (parseInt(document.getElementById("arma-direita-ataque-magico").value) || 0) + (parseInt(document.getElementById("arma-esquerda-ataque-magico").value) || 0);

            const capacidadeBase = 5;
            const bonusForcaCarga = Math.floor(currentForca / 5);
            const capacidadeCarga = capacidadeBase + bonusForcaCarga;
            if (document.getElementById("capacidade-carga")) document.getElementById("capacidade-carga").textContent = capacidadeCarga;

            const pesoTotalAtual = parseFloat(document.getElementById("peso-total").textContent) || 0;
            let penalidadeEsquivaAcerto = 0;
            const sobrecarga = pesoTotalAtual - capacidadeCarga;

            if (sobrecarga > 0) {
                penalidadeEsquivaAcerto = -1; 
                const sobrecargaAdicional = sobrecarga - 3;
                if (sobrecargaAdicional > 0) {
                    penalidadeEsquivaAcerto -= Math.ceil(sobrecargaAdicional / 3);
                }
            }

            acerto += penalidadeEsquivaAcerto;
            esquiva += penalidadeEsquivaAcerto;

            if (document.getElementById("peso-total") && document.getElementById("capacidade-carga")) {
                if (sobrecarga > 0) {
                    document.getElementById("peso-total").style.color = 'red';
                    document.getElementById("capacidade-carga").style.color = 'red';
                } else {
                    document.getElementById("peso-total").style.color = ''; 
                    document.getElementById("capacidade-carga").style.color = ''; 
                }
            }


            const velocidadeBase = 25 + Math.floor(currentAgilidade / 3) * 3;
            const alturaPuloBase = 1 + Math.floor(currentForca / 10);
            const distanciaPuloBase = 3 + 3 * Math.min(Math.floor(currentForca / 5), Math.floor(currentAgilidade / 5));
            let bonusVelocidade = vantagensSelecionadas.includes("Combo F√≠sico (4)") ? 25 : 0;
            let bonusAlturaPulo = vantagensSelecionadas.includes("Combo F√≠sico (4)") ? 2 : 0;
            let bonusDistanciaPulo = vantagensSelecionadas.includes("Combo F√≠sico (4)") ? 6 : 0;

            document.getElementById("velocidade-corrida").textContent = velocidadeBase + bonusVelocidade;
            document.getElementById("altura-pulo").textContent = alturaPuloBase + bonusAlturaPulo;
            document.getElementById("distancia-pulo").textContent = distanciaPuloBase + bonusDistanciaPulo;
            document.getElementById("ataque").textContent = ataque;
            document.getElementById("ataque-magico").textContent = ataqueMagico;
            document.getElementById("acerto").textContent = acerto;
            document.getElementById("esquiva").textContent = esquiva;
            document.getElementById("rdf").textContent = rdf;
            document.getElementById("rdm").textContent = rdm;
            
            vidaTotal = Math.ceil(vidaBase);
            magiaTotal = Math.ceil(magiaBase);
            vigorTotal = parseFloat(vigorBase.toFixed(1));

            document.getElementById("vida-total").textContent = vidaTotal;
            document.getElementById("magia-total").textContent = magiaTotal;
            document.getElementById("vigor-total").textContent = vigorTotal.toFixed(1);

            vidaAtual = Math.min(vidaAtual, vidaTotal);
            magiaAtual = Math.min(magiaAtual, magiaTotal);
            vigorAtual = Math.min(vigorAtual, vigorTotal);

            document.getElementById("vida-atual").textContent = vidaAtual;
            document.getElementById("magia-atual").textContent = magiaAtual;
            document.getElementById("vigor-atual").textContent = vigorAtual.toFixed(1);

            const regeneracaoVida = (0.2 * currentConstituicao).toFixed(1);
            const regeneracaoMagia = (0.8 * currentConstituicao).toFixed(1);
            const regeneracaoVigor = (0.4 * currentConstituicao).toFixed(1);
            document.getElementById("regeneracao-vida").textContent = regeneracaoVida;
            document.getElementById("regeneracao-magia").textContent = regeneracaoMagia;
            document.getElementById("regeneracao-vigor").textContent = regeneracaoVigor;

            const atributosSpans = [
                { span: document.getElementById("ataque"), valor: ataque }, 
                { span: document.getElementById("ataque-magico"), valor: ataqueMagico }, 
                { span: document.getElementById("acerto"), valor: acerto }, 
                { span: document.getElementById("esquiva"), valor: esquiva }, 
                { span: document.getElementById("rdf"), valor: rdf }, 
                { span: document.getElementById("rdm"), valor: rdm }
            ];
            atributosSpans.forEach(a => { if(a.span) a.span.classList.remove("atributo-fogo")});
            const maxAtributo = atributosSpans.reduce((prev, curr) => (curr.span && prev.valor > curr.valor) ? prev : curr, { valor: 0 });
            if (maxAtributo.valor > 0 && maxAtributo.span) maxAtributo.span.classList.add("atributo-fogo");
        }

        function resetarPontos() {
            if (isFichaLocked && !isFichaUnlocked) return abrirModalSenha(resetPontosButton);
            senhaGmTitulo.textContent = "Pe√ßa permiss√£o ao GM para Resetar Pontos";
            document.getElementById("senha-gm-modal").style.display = "flex"; 
            document.getElementById("senha-gm-input").value = "";
            document.getElementById("confirmar-senha-gm-btn").onclick = () => {
                if (document.getElementById("senha-gm-input").value === senhaMatriz) {
                    atributosInputs.forEach(input => input.value = 0); pontosHabilidadeUsados = 0; pontosHabilidadeSpan.textContent = pontosHabilidadeTotal;
                    velocidadeCorridaSpan.textContent = "25"; alturaPuloSpan.textContent = "1"; distanciaPuloSpan.textContent = "3";
                    calcularAtributos(); pontosVantagemSpan.textContent = getPontosVantagem(); salvarDados(); fecharModal("senha-gm-modal");
                } else { alert("Senha do GM incorreta!"); fecharModal("senha-gm-modal"); }
            };
        }

        function recomecarFicha() {
             if (isFichaLocked && !isFichaUnlocked) return abrirModalSenha(recomecarButton);
            if (confirm("Tem certeza que deseja recome√ßar a ficha? Todas as altera√ß√µes ser√£o perdidas.")) {
                atributosInputs.forEach(input => input.value = 0);
                experienciaInput.value = "0";
                experiencia = 0;
                nivel = 0;
                
                experienciaInput.readOnly = true; 
                xpLockIcon.textContent = 'üîí';
                isXpUnlocked = false;
                if (xpUnlockTimerId) clearTimeout(xpUnlockTimerId);
                
                const nivelInfo = nivelData.find(data => data.nivel === nivel) || nivelData[0];
                pontosHabilidadeTotal = nivelInfo.pd;
                pontosHabilidadeUsados = 0;
                nivelSpan.textContent = nivel;
                pontosHabilidadeSpan.textContent = pontosHabilidadeTotal;
                vidaBase = 50; 

                velocidadeCorridaSpan.textContent = "25"; alturaPuloSpan.textContent = "1"; distanciaPuloSpan.textContent = "3";
                nomePersonagemInput.value = ""; descricaoPersonagemInput.value = "";
                armaDireitaNomeInput.value = ""; armaDireitaAtaqueInput.value = "0"; armaDireitaAtaqueMagicoInput.value = "0";
                armaEsquerdaNomeInput.value = ""; armaEsquerdaAtaqueInput.value = "0"; armaEsquerdaAtaqueMagicoInput.value = "0";
                
                const magiaInputs = magiasList.querySelectorAll(".magia-nome");
                magiaInputs.forEach(input => input.value = ""); // Limpa magias existentes
                // Remove magias extras se houver mais de 10
                while (magiaInputs.length > 10 && magiasList.lastChild.tagName === 'INPUT') {
                    magiasList.removeChild(magiasList.lastChild);
                }
                // Adiciona inputs de magia se houver menos de 10
                for (let i = magiasList.children.length; i < 10; i++) {
                    const input = document.createElement("input"); 
                    input.type = "text"; 
                    input.className = "magia-nome"; 
                    input.placeholder = `Magia/Habilidade ${i + 1}`; 
                    input.addEventListener('input', salvarDados); 
                    magiasList.appendChild(input);
                }

                const slots = inventarioSlots.querySelectorAll(".inventory-slot"); 
                slots.forEach(slot => { slot.querySelector(".inventory-item").value = ""; slot.querySelector(".inventory-weight").value = "0"; });
                
                characterImage.style.display = "none"; characterImage.src = ""; 
                vantagensSelecionadas = []; desvantagensSelecionadas = []; racaSelecionada = null;
                vantagensListDisplay.innerHTML = ""; desvantagensListDisplay.innerHTML = ""; 
                anotacoesTextarea.value = "";
                classeNomeInput.value = ""; classeDescricaoInput.value = ""; 
                racaNomeSpan.textContent = ""; racaDescricaoInput.value = "";
                
                // Resetar moedas
                if (ouroInput) ouroInput.value = 0;
                if (prataInput) prataInput.value = 0;
                if (cobreInput) cobreInput.value = 0;
                
                if (fichas[currentFichaId]) { 
                    fichas[currentFichaId].diceRolls = [];
                    fichas[currentFichaId].collapsedSections = {}; 
                    fichas[currentFichaId].sectionOrder = [ // Resetar ordem das se√ß√µes
                        'informacoes-basicas', 'recursos', 'atributos', 'combate', 
                        'inventario-habilidades', 'locomocao', 'status', 'riqueza'
                    ];
                    sectionOrder = [...fichas[currentFichaId].sectionOrder]; // Atualizar a ordem global
                    criarEstruturaFicha(); // Recriar a estrutura HTML com a nova ordem
                    reasignarElementosDOM(); // Reatribuir refer√™ncias DOM
                    adicionarEventListenersGlobais(); // Reaplicar listeners
                }
                aplicarEstadoColapsoSecoes({}); 

                calcularAtributos(); 

                vidaAtual = vidaTotal;
                magiaAtual = magiaTotal;
                vigorAtual = vigorTotal;
                document.getElementById("vida-atual").textContent = vidaAtual;
                document.getElementById("magia-atual").textContent = magiaAtual;
                document.getElementById("vigor-atual").textContent = vigorAtual.toFixed(1);

                pontosVantagemSpan.textContent = getPontosVantagem();
                salvarDados();
            }
        }

        bloquearFichaButton.onclick = (e) => {
            aplicarFeedbackBotao(e.currentTarget);
            if (isFichaLocked) abrirModalSenha();
            else { document.getElementById("bloquear-ficha-modal").style.display = "flex"; document.getElementById("senha-bloqueio-input").value = ""; document.getElementById("senha-bloqueio-input").focus(); }
        };

        function bloquearFicha() {
            aplicarFeedbackBotao(document.querySelector('#bloquear-ficha-modal .confirm-btn'));
            const senha = document.getElementById("senha-bloqueio-input").value;
            if (senha.length !== 4 || !/^\d{4}$/.test(senha)) return alert("A senha deve ter exatamente 4 d√≠gitos num√©ricos!");
            isFichaLocked = true; fichaPassword = senha;
            fichas[currentFichaId].isLocked = true;
            fichas[currentFichaId].password = senha;
            saveFichasToStorage(fichas);
            fecharModal("bloquear-ficha-modal"); alert("Ficha bloqueada com sucesso!"); atualizarBotaoBloquear();
        }

        function abrirModalSenha(element = null, callbackSuccess = null) { 
            const modal = document.getElementById("password-modal");
            modal.style.display = "flex"; 
            document.getElementById("senha-desbloqueio-input").value = ""; 
            document.getElementById("senha-desbloqueio-input").focus();
            
            if (element) modal.dataset.elementId = element.id; 
            else delete modal.dataset.elementId;

            modal.callbackSuccess = callbackSuccess; 
        }


        function desbloquearFicha() {
            aplicarFeedbackBotao(document.querySelector('#password-modal .confirm-btn'));
            const senha = document.getElementById("senha-desbloqueio-input").value;
            const modal = document.getElementById("password-modal");
            const elementId = modal.dataset.elementId;
            const originalButton = elementId ? document.getElementById(elementId) : null;
            const callback = modal.callbackSuccess; 

            if (senha !== senhaMatriz && senha !== fichaPassword) return alert("Senha incorreta!");
            
            isFichaUnlocked = true; 

            if (currentFichaId !== FICHA_MATRIZ_ID && senha !== senhaMatriz) {
                if(confirm("Senha correta! Deseja desbloquear a ficha permanentemente? (Cancelar para desbloqueio tempor√°rio)")) {
                     isFichaLocked = false; fichaPassword = null;
                     fichas[currentFichaId].isLocked = false;
                     fichas[currentFichaId].password = null;
                     saveFichasToStorage(fichas);
                     fecharModal("password-modal"); alert("Ficha desbloqueada permanentemente!"); atualizarBotaoBloquear();
                     if (callback) callback(); 
                     else if (originalButton && typeof originalButton.onclick === 'function' && !originalButton.id.startsWith('btn-')) { 
                        originalButton.click();
                     }
                } else {
                     fecharModal("password-modal"); alert("Ficha desbloqueada temporariamente!");
                     if (callback) callback();
                     else if (originalButton && typeof originalButton.onclick === 'function' && !originalButton.id.startsWith('btn-')) {
                        originalButton.click();
                     }
                }
            } else { 
                fecharModal("password-modal"); 
                alert(`Ficha desbloqueada temporariamente ${senha === senhaMatriz ? 'com a senha matriz!' : ''}`);
                if (callback) callback(); 
                else if (originalButton && typeof originalButton.onclick === 'function' && !originalButton.id.startsWith('btn-')) {
                   originalButton.click();
                }
            }
             delete modal.callbackSuccess; 
        }

        function cancelarDesbloqueio() {
            aplicarFeedbackBotao(document.querySelector('#password-modal .cancel-btn'));
            const modal = document.getElementById("password-modal");
            const elementId = modal.dataset.elementId;
            if (elementId && document.getElementById(elementId) && previousValues.has(document.getElementById(elementId))) {
                 document.getElementById(elementId).value = previousValues.get(document.getElementById(elementId)) || "";
            }
            delete modal.callbackSuccess; 
            fecharModal("password-modal");
        }

        // Event listeners para inputs s√£o adicionados ap√≥s a cria√ß√£o da estrutura
        function adicionarEventListenersInputs() {
            document.querySelectorAll('#ficha-content input[type="text"], #ficha-content input[type="number"]:not(#experiencia), #ficha-content textarea').forEach(input => {
                input.addEventListener("focus", (event) => {
                    previousValues.set(event.target, event.target.value);
                });
                input.addEventListener("input", (event) => {
                    const inputTarget = event.target;
                    if (isFichaLocked && !isFichaUnlocked && currentFichaId !== FICHA_MATRIZ_ID) { 
                        inputTarget.value = previousValues.get(inputTarget) || "";
                        abrirModalSenha(inputTarget);
                        return; 
                    }

                    if (atributosInputs.includes(inputTarget)) {
                        calcularAtributos(); 
                    } else if (inputTarget.id.includes("arma")) {
                        previousValues.set(inputTarget, inputTarget.value);
                        calcularAtributos(); 
                    } else if (inputTarget.classList.contains('inventory-weight')) {
                        previousValues.set(inputTarget, inputTarget.value);
                        calcularPesoTotal(); 
                        calcularAtributos(); 
                    } else {
                        previousValues.set(inputTarget, inputTarget.value);
                    }
                    salvarDados();
                });
            });
            if (document.getElementById("nome-personagem")) { // Verifica se o elemento existe
                 document.getElementById("nome-personagem").oninput = salvarDados;
            }

            if (experienciaInput) {
                experienciaInput.addEventListener('focus', (event) => {
                    previousValues.set(event.target, event.target.value); 
                    if (experienciaInput.readOnly && !isXpUnlocked) { 
                        event.preventDefault();
                        senhaGmTitulo.textContent = "Desbloquear Campo de Experi√™ncia";
                        document.getElementById("senha-gm-modal").style.display = "flex";
                        document.getElementById("senha-gm-input").value = "";
                        document.getElementById("senha-gm-input").focus();
                        document.getElementById("confirmar-senha-gm-btn").onclick = () => confirmarDesbloqueioExperiencia();
                    }
                });

                experienciaInput.addEventListener('input', (event) => {
                    if (!experienciaInput.readOnly) { 
                        experiencia = parseInt(event.target.value) || 0;
                        atualizarNivel(); 
                        salvarDados(); 
                    } else {
                        event.target.value = previousValues.get(event.target) || "0"; 
                    }
                });
            }
             if(document.getElementById("moeda-ouro")) document.getElementById("moeda-ouro").addEventListener('input', salvarDados);
            if(document.getElementById("moeda-prata")) document.getElementById("moeda-prata").addEventListener('input', salvarDados);
            if(document.getElementById("moeda-cobre")) document.getElementById("moeda-cobre").addEventListener('input', salvarDados);

        }


        function confirmarDesbloqueioExperiencia() {
            aplicarFeedbackBotao(document.querySelector('#senha-gm-modal .confirm-btn'));
            if (document.getElementById("senha-gm-input").value === senhaMatriz) {
                experienciaInput.readOnly = false;
                xpLockIcon.textContent = 'üîì'; 
                isXpUnlocked = true; 
                experienciaInput.focus(); 
                showNotification("Campo de experi√™ncia desbloqueado por 20 segundos.", "normal-result");

                if (xpUnlockTimerId) clearTimeout(xpUnlockTimerId);
                xpUnlockTimerId = setTimeout(() => {
                    experienciaInput.readOnly = true;
                    xpLockIcon.textContent = 'üîí'; 
                    isXpUnlocked = false; 
                    alert("Tempo para editar experi√™ncia expirou. Insira a senha novamente se precisar.");
                    if (fichas[currentFichaId]) { 
                        fichas[currentFichaId].experiencia = experienciaInput.value; 
                        saveFichasToStorage(fichas); 
                    }
                }, XP_UNLOCK_DURATION_MS);
                fecharModal("senha-gm-modal");
            } else {
                alert("Senha do GM incorreta!");
                fecharModal("senha-gm-modal");
            }
        }


        if(characterImageInput) characterImageInput.onchange = e => {
            const file = e.target.files[0]; if (file) { const reader = new FileReader(); reader.onload = e => { characterImage.src = e.target.result; characterImage.style.display = "block"; salvarDados(); }; reader.readAsDataURL(file); }
        };
        if(document.getElementById("excluir-ficha")) document.getElementById("excluir-ficha").onclick = (e) => {
            aplicarFeedbackBotao(e.currentTarget);
            if (currentFichaId === FICHA_MATRIZ_ID) return alert("A ficha matriz n√£o pode ser exclu√≠da!");
            if (isFichaLocked && !isFichaUnlocked) return abrirModalSenha(document.getElementById("excluir-ficha"));
            if (confirm("Tem certeza que deseja excluir esta ficha?")) {
                delete fichas[currentFichaId];
                saveFichasToStorage(fichas);
                currentFichaId = FICHA_MATRIZ_ID; 
                saveCurrentFichaIdToStorage(currentFichaId);
                 // Recarregar a ficha matriz com a ordem padr√£o
                sectionOrder = [...(fichas[FICHA_MATRIZ_ID]?.sectionOrder || [
                    'informacoes-basicas', 'recursos', 'atributos', 'combate', 
                    'inventario-habilidades', 'locomocao', 'status', 'riqueza'
                ])];
                criarEstruturaFicha();
                carregarFicha(currentFichaId);
                atualizarAbasFichas();
            }
        };
        let isDragging = false, currentX = 0, currentY = 0, initialX, initialY;
        
        if(diceContainer) {
            diceContainer.onmousedown = e => { isDragging = true; initialX = e.clientX - currentX; initialY = e.clientY - currentY; diceContainer.style.cursor = "grabbing"; };
        }
        document.onmousemove = e => { if (isDragging && diceContainer) { e.preventDefault(); currentX = e.clientX - initialX; currentY = e.clientY - initialY; diceContainer.style.left = `${currentX}px`; diceContainer.style.top = `${currentY}px`; diceContainer.style.right = "auto"; } };
        document.onmouseup = () => { if(isDragging && diceContainer) {isDragging = false; diceContainer.style.cursor = "move";} };

        // --- L√ìGICA DO DADO ATUALIZADA ---
        if(diceRoll) diceRoll.onclick = () => {
            if (isDiceRolling || (isFichaLocked && !isFichaUnlocked)) {
                if (isFichaLocked && !isFichaUnlocked) abrirModalSenha(diceRoll);
                return;
            }
            isDiceRolling = true;
            diceRoll.textContent = "..."; 
            diceRoll.classList.add("is-rolling");
            diceRoll.classList.remove("critical-failure", "critical-success");
            diceResult.style.display = "none";

            setTimeout(() => {
                const roll = Math.floor(Math.random() * currentDiceMax) + 1; 
                const fichaNome = (fichas[currentFichaId] ? fichas[currentFichaId].nomeFicha : "Ficha") || "Ficha";
                
                diceRoll.classList.remove("is-rolling"); 
                diceRoll.textContent = roll; 

                let notificationClass = "normal-result";
                let notificationMsg = `${fichaNome} rolou D${currentDiceMax}: ${roll}`; 

                if (roll === 1) { 
                    diceRoll.classList.add("critical-failure");
                    notificationClass = "critical-failure";
                    notificationMsg = `${fichaNome} - D${currentDiceMax}: FALHA CR√çTICA!`;
                } else if (roll === currentDiceMax) { 
                    diceRoll.classList.add("critical-success");
                    notificationClass = "critical-success";
                    notificationMsg = `${fichaNome} - D${currentDiceMax}: SUCESSO CR√çTICO!`;
                }
                showNotification(notificationMsg, notificationClass);
                
                if (fichas[currentFichaId]) {
                    const now = new Date();
                    const timestamp = now.toLocaleString('pt-BR', { 
                        day: '2-digit', month: '2-digit', year: 'numeric', 
                        hour: '2-digit', minute: '2-digit', second: '2-digit' 
                    });
                    fichas[currentFichaId].diceRolls = fichas[currentFichaId].diceRolls || [];
                    fichas[currentFichaId].diceRolls.unshift({ 
                        type: `D${currentDiceMax}`,
                        result: roll,
                        timestamp: timestamp
                    });
                    if (fichas[currentFichaId].diceRolls.length > 100) {
                        fichas[currentFichaId].diceRolls.pop();
                    }
                    salvarDados(); 
                }

                isDiceRolling = false; 
            }, 1000); 
        };
        
        if(changeDiceTypeBtn) changeDiceTypeBtn.addEventListener('click', (event) => {
            aplicarFeedbackBotao(event.currentTarget);
            event.stopPropagation(); 
            if (isDiceRolling) return;
            diceOptionsMenu.style.display = diceOptionsMenu.style.display === 'flex' ? 'none' : 'flex';
        });

        // Os bot√µes de op√ß√£o de dado s√£o criados dinamicamente, ent√£o o listener √© adicionado depois
        function adicionarEventListenersOpcoesDado() {
            document.querySelectorAll('.dice-option-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    aplicarFeedbackBotao(e.currentTarget);
                    if (isDiceRolling) return;
                    currentDiceMax = parseInt(button.dataset.diceMax);
                    changeDiceTypeBtn.textContent = `D${currentDiceMax}`;
                    diceOptionsMenu.style.display = 'none';
                    diceRoll.textContent = '-'; 
                    diceRoll.classList.remove("critical-failure", "critical-success");
                });
            });
        }
        

        // --- L√ìGICA PARA FECHAR MENUS/PAIN√âIS AO CLICAR FORA ---
        document.addEventListener('click', function(event) {
            if (diceOptionsMenu && diceOptionsMenu.style.display === 'flex' && 
                !diceOptionsMenu.contains(event.target) && 
                event.target !== changeDiceTypeBtn) {
                diceOptionsMenu.style.display = 'none';
            }
            if (diceHistoryPanel && diceHistoryPanel.style.display === 'flex' && 
                !diceHistoryPanel.contains(event.target) && 
                event.target !== diceHistoryTrigger) {
                diceHistoryPanel.style.display = 'none';
            }
            if (anotacoesTextarea && anotacoesTextarea.style.display === 'block' && 
                !anotacoesTextarea.contains(event.target) && 
                event.target !== anotacoesBtn) {
                anotacoesTextarea.style.display = 'none';
            }
        });


        if(vantagensDesvantagensBtn) vantagensDesvantagensBtn.onclick = (e) => {
            aplicarFeedbackBotao(e.currentTarget);
            if (isFichaLocked && !isFichaUnlocked) return abrirModalSenha(vantagensDesvantagensBtn);
            tempVantagensSelecionadas = [...vantagensSelecionadas]; tempDesvantagensSelecionadas = [...desvantagensSelecionadas];
            vantagensDesvantagensPanel.style.display = "block"; document.getElementById("salvar-vantagens-btn").style.display = "none"; atualizarVantagensDesvantagensPanel();
        };
        if(fecharPaginaBtn) fecharPaginaBtn.onclick = () => { vantagensDesvantagensPanel.style.display = "none"; };
        if(salvarVantagensBtn) salvarVantagensBtn.onclick = () => {
             document.getElementById("salvar-modal-texto").textContent = "Se salvar, as altera√ß√µes de Vantagens/Desvantagens n√£o poder√£o ser desfeitas.";
             document.getElementById("salvar-vantagens-modal").style.display = "flex";
        };
        if(salvarRacasBtn) salvarRacasBtn.onclick = () => {
             document.getElementById("salvar-modal-texto").textContent = "Se salvar, a altera√ß√£o de Ra√ßa n√£o poder√° ser desfeita.";
             document.getElementById("salvar-vantagens-modal").style.display = "flex";
        };

        if(confirmarSalvarBtn) confirmarSalvarBtn.onclick = () => {
            aplicarFeedbackBotao(confirmarSalvarBtn);
            if (racasPanel.style.display === "block") {
                if (tempRacaSelecionada && tempRacaSelecionada !== racaSelecionada) {
                    const raca = racasData.find(r => r.nome === tempRacaSelecionada);
                    if (raca && calcularPontosVantagemTemp() >= 0) {
                        racaSelecionada = tempRacaSelecionada;
                        racaNomeSpan.textContent = racaSelecionada.split(" (")[0];
                        racaDescricaoInput.value = raca.vantagens.join("\n\n");
                        pontosVantagemSpan.textContent = getPontosVantagem();
                        racasPanel.style.display = "none";
                        calcularAtributos();
                        salvarDados();
                    } else if (raca){
                        alert("Pontos de Vantagem insuficientes para confirmar esta ra√ßa!");
                    }
                } else {
                    racasPanel.style.display = "none";
                }
            } else { 
                if (tempDesvantagensSelecionadas.length > 3) {
                     alert("Voc√™ pode ter no m√°ximo 3 desvantagens!");
                     fecharModal("salvar-vantagens-modal");
                     return;
                }
                if (calcularPontosVantagemTemp() < 0) {
                     alert("Pontos de Vantagem insuficientes com as vantagens selecionadas!");
                     fecharModal("salvar-vantagens-modal");
                     return;
                }

                vantagensSelecionadas = [...tempVantagensSelecionadas];
                desvantagensSelecionadas = [...tempDesvantagensSelecionadas];
                vantagensListDisplay.innerHTML = ""; desvantagensListDisplay.innerHTML = "";
                vantagensSelecionadas.forEach(v => { const div = document.createElement("div"); div.textContent = v; div.className = "list-item"; div.onclick = () => removerVantagem(v); vantagensListDisplay.appendChild(div); });
                desvantagensSelecionadas.forEach(d => { const div = document.createElement("div"); div.textContent = d; div.className = "list-item"; div.onclick = () => removerDesvantagem(d); desvantagensListDisplay.appendChild(div); });
                pontosVantagemSpan.textContent = getPontosVantagem();
                vantagensDesvantagensPanel.style.display = "none";
                calcularAtributos(); 
                salvarDados();
            }
            fecharModal("salvar-vantagens-modal");
        };


        function atualizarVantagensDesvantagensPanel() {
            vantagensList.innerHTML = "<h3>Vantagens</h3>"; desvantagensList.innerHTML = "<h3>Desvantagens</h3>";
            vantagensData.forEach(v => {
                const div = document.createElement("div"); div.className = "vantagem-item"; div.textContent = `${v.nome} - Custo: ${v.custo} PH - ${v.descricao}`;
                if (tempVantagensSelecionadas.includes(v.nome)) div.classList.add("comprada");
                div.onclick = () => {
                    if (vantagensSelecionadas.includes(v.nome)) alert("Vantagem salva s√≥ pode ser removida com permiss√£o do GM.");
                    else if (tempVantagensSelecionadas.includes(v.nome)) tempVantagensSelecionadas = tempVantagensSelecionadas.filter(t => t !== v.nome);
                    else {
                        if (v.restricao === "inicio" && nivel > 0) return alert("Compra dessa vantagem √© somente no n√≠vel 0.");
                        if ((calcularPontosVantagemTemp() - v.custo) >= 0) tempVantagensSelecionadas.push(v.nome); else alert("PH insuficientes!");
                    }
                    atualizarVantagensDesvantagensPanel(); document.getElementById("salvar-vantagens-btn").style.display = "block";
                }; vantagensList.appendChild(div);
            });
            desvantagensData.forEach(d => {
                const div = document.createElement("div"); div.className = "desvantagem-item"; div.textContent = `${d.nome} - Ganho: ${d.ganho} PH - ${d.descricao}`;
                if (tempDesvantagensSelecionadas.includes(d.nome)) div.classList.add("comprada");
                div.onclick = () => {
                    if (desvantagensSelecionadas.includes(d.nome)) alert("Desvantagem salva s√≥ pode ser removida com permiss√£o do GM.");
                    else if (tempDesvantagensSelecionadas.includes(d.nome)) tempDesvantagensSelecionadas = tempDesvantagensSelecionadas.filter(t => t !== d.nome);
                    else { if (tempDesvantagensSelecionadas.length < 3) tempDesvantagensSelecionadas.push(d.nome); else alert("Limite de 3 desvantagens!"); }
                    atualizarVantagensDesvantagensPanel(); document.getElementById("salvar-vantagens-btn").style.display = "block";
                }; desvantagensList.appendChild(div);
            });
            document.getElementById("ph-temp").textContent = calcularPontosVantagemTemp();
        }

        function removerVantagem(v) {
            if (isFichaLocked && !isFichaUnlocked) return abrirModalSenha();
            senhaGmTitulo.textContent = "Pe√ßa permiss√£o ao GM para Remover Vantagem";
            if (confirm(`Deseja remover a vantagem "${v}"?`)) {
                document.getElementById("senha-gm-modal").style.display = "flex"; document.getElementById("senha-gm-input").value = "";
                document.getElementById("confirmar-senha-gm-btn").onclick = () => {
                    if (document.getElementById("senha-gm-input").value === senhaMatriz) {
                        vantagensSelecionadas = vantagensSelecionadas.filter(t => t !== v); Array.from(vantagensListDisplay.children).find(div => div.textContent === v)?.remove();
                        pontosVantagemSpan.textContent = getPontosVantagem();
                        fecharModal("senha-gm-modal"); calcularAtributos(); salvarDados();
                    } else { alert("Senha do GM incorreta!"); fecharModal("senha-gm-modal"); }
                };
            }
        }
        function removerDesvantagem(d) {
            if (isFichaLocked && !isFichaUnlocked) return abrirModalSenha();
            senhaGmTitulo.textContent = "Pe√ßa permiss√£o ao GM para Remover Desvantagem";
            if (confirm(`Deseja remover a desvantagem "${d}"?`)) {
                document.getElementById("senha-gm-modal").style.display = "flex"; document.getElementById("senha-gm-input").value = "";
                document.getElementById("confirmar-senha-gm-btn").onclick = () => {
                    if (document.getElementById("senha-gm-input").value === senhaMatriz) {
                        desvantagensSelecionadas = desvantagensSelecionadas.filter(t => t !== d); Array.from(desvantagensListDisplay.children).find(div => div.textContent === d)?.remove();
                        pontosVantagemSpan.textContent = getPontosVantagem();
                        fecharModal("senha-gm-modal"); calcularAtributos(); salvarDados();
                    } else { alert("Senha do GM incorreta!"); fecharModal("senha-gm-modal"); }
                };
            }
        }

        function calcularPesoTotal() { 
            if(pesoTotalSpan) pesoTotalSpan.textContent = Array.from(document.querySelectorAll("#inventario-slots .inventory-weight")).reduce((total, weight) => total + (parseFloat(weight.value) || 0), 0).toFixed(1);
        }
        
        anotacoesBtn.onclick = () => { 
            aplicarFeedbackBotao(anotacoesBtn);
            anotacoesTextarea.style.display = anotacoesTextarea.style.display === "block" ? "none" : "block"; 
            if (diceHistoryPanel.style.display === 'flex') {
                diceHistoryPanel.style.display = 'none';
            }
        };
        if(anotacoesTextarea) anotacoesTextarea.oninput = salvarDados;


        racasBtn.onclick = (e) => { 
            aplicarFeedbackBotao(e.currentTarget);
            if (isFichaLocked && !isFichaUnlocked) return abrirModalSenha(racasBtn); 
            tempRacaSelecionada = racaSelecionada; 
            atualizarRacasPanel(); 
            racasPanel.style.display = "block"; 
            document.getElementById("salvar-racas-btn").style.display = "none"; 
        };
        fecharRacasBtn.onclick = () => { racasPanel.style.display = "none"; };

        function atualizarRacasPanel() {
            racasList.innerHTML = ""; racasData.forEach(r => {
                const div = document.createElement("div"); div.className = "raca-item";
                div.innerHTML = `<h3>${r.nome}</h3><p>${r.descricao}</p><p><strong>Vantagens:</strong></p><ul>${r.vantagens.map(v => `<li>${v}</li>`).join("")}</ul>`;
                if (tempRacaSelecionada === r.nome) div.classList.add("comprada");
                div.onclick = () => {
                    if (racaSelecionada && racaSelecionada !== r.nome) alert("Ra√ßa salva s√≥ pode ser alterada com permiss√£o do GM.");
                    else if (tempRacaSelecionada === r.nome) { tempRacaSelecionada = null; }
                    else {
                        let phDisponivelParaNovaRaca = calcularPontosVantagemTemp() + (tempRacaSelecionada ? (racasData.find(ra => ra.nome === tempRacaSelecionada)?.custo || 0) : 0);
                        if (phDisponivelParaNovaRaca >= r.custo) {
                            tempRacaSelecionada = r.nome;
                             document.getElementById("confirmar-compra-modal").style.display = "flex";
                             document.getElementById("confirmar-compra-btn").onclick = () => {
                                 atualizarRacasPanel();
                                 document.getElementById("salvar-racas-btn").style.display = "block";
                                 fecharModal("confirmar-compra-modal");
                             };
                        } else { alert("PH insuficientes!"); tempRacaSelecionada = null; }
                    }
                    atualizarRacasPanel();
                    document.getElementById("salvar-racas-btn").style.display = tempRacaSelecionada && tempRacaSelecionada !== racaSelecionada ? "block" : "none";
                }; racasList.appendChild(div);
            });
             phTempRacaSpan.textContent = calcularPontosVantagemTemp();
        }


        function abrirModalRaca() { document.getElementById("raca-opcoes-modal").style.display = "flex"; }
        function excluirRacaSelecionadaModal() {
            fecharModal('raca-opcoes-modal'); if (isFichaLocked && !isFichaUnlocked) return abrirModalSenha();
            senhaGmTitulo.textContent = "Pe√ßa permiss√£o ao GM para Excluir Ra√ßa";
            if (confirm("Tem certeza que deseja excluir a ra√ßa selecionada?")) {
                document.getElementById("senha-gm-modal").style.display = "flex"; document.getElementById("senha-gm-input").value = "";
                document.getElementById("confirmar-senha-gm-btn").onclick = () => {
                    if (document.getElementById("senha-gm-input").value === senhaMatriz) {
                        racaSelecionada = null; tempRacaSelecionada = null; racaNomeSpan.textContent = ""; racaDescricaoInput.value = "";
                        pontosVantagemSpan.textContent = getPontosVantagem(); salvarDados(); fecharModal("senha-gm-modal"); calcularAtributos();
                    } else { alert("Senha do GM incorreta!"); fecharModal("senha-gm-modal"); }
                };
            }
        }
        function editarRacaSelecionadaModal() {
            if (isFichaLocked && !isFichaUnlocked) return abrirModalSenha(); fecharModal('raca-opcoes-modal');
            document.getElementById("editar-raca-modal").style.display = "flex"; document.getElementById("editar-raca-nome").value = racaNomeSpan.textContent;
            document.getElementById("editar-raca-descricao").value = racaDescricaoInput.value;
        }
        function salvarEdicaoRaca() {
            if (isFichaLocked && !isFichaUnlocked) return abrirModalSenha();
            senhaGmTitulo.textContent = "Pe√ßa permiss√£o ao GM para Editar Ra√ßa";
            if (confirm("Tem certeza que deseja editar a ra√ßa selecionada?")) {
                document.getElementById("senha-gm-modal").style.display = "flex"; document.getElementById("senha-gm-input").value = "";
                document.getElementById("confirmar-senha-gm-btn").onclick = () => {
                    if (document.getElementById("senha-gm-input").value === senhaMatriz) {
                        racaNomeSpan.textContent = document.getElementById("editar-raca-nome").value;
                        racaDescricaoInput.value = document.getElementById("editar-raca-descricao").value;
                        fecharModal('editar-raca-modal'); salvarDados(); fecharModal("senha-gm-modal");
                    } else { alert("Senha do GM incorreta!"); fecharModal("senha-gm-modal"); }
                };
            }
        }

        if(classesBtn) classesBtn.onclick = (e) => { aplicarFeedbackBotao(e.currentTarget); classesPanel.style.display = "block"; };
        if(fecharClassesBtn) fecharClassesBtn.onclick = () => { classesPanel.style.display = "none"; };

        if(luaBtn) luaBtn.onclick = (e) => { aplicarFeedbackBotao(e.currentTarget); document.body.classList.add("dark-mode"); salvarDados(); };
        if(solBtn) solBtn.onclick = (e) => { aplicarFeedbackBotao(e.currentTarget); document.body.classList.remove("dark-mode"); salvarDados(); };
        if(resetPontosButton) resetPontosButton.onclick = (e) => { aplicarFeedbackBotao(e.currentTarget); resetarPontos(); };
        if(recomecarButton) recomecarButton.onclick = (e) => { aplicarFeedbackBotao(e.currentTarget); recomecarFicha(); };

        function showNotification(message, type) {
            notification.textContent = message; notification.className = type; notification.style.display = "block";
            setTimeout(() => { notification.style.display = "none"; notification.className = ""; }, 2000);
        }

        if(planoFundoBtn) planoFundoBtn.onclick = (e) => { aplicarFeedbackBotao(e.currentTarget); backgroundModal.style.display = "flex"; };
        
        function aplicarPlanoDeFundo() {
            const file = backgroundImageInput.files[0];
            const selectedSize = document.querySelector('input[name="background-size"]:checked').value;
            if (file) {
                const reader = new FileReader();
                reader.onload = e => {
                    const imageUrl = e.target.result;
                    document.body.style.backgroundImage = `url('${imageUrl}')`;
                    document.body.style.backgroundSize = selectedSize;
                    salvarDados();
                    fecharModal('background-modal');
                };
                reader.readAsDataURL(file);
            } else if (document.body.style.backgroundImage && document.body.style.backgroundImage !== 'none') {
                document.body.style.backgroundSize = selectedSize;
                salvarDados();
                fecharModal('background-modal');
            } else {
                alert("Nenhuma imagem selecionada e nenhuma imagem de fundo existente para aplicar novo tamanho.");
            }
        }

        function excluirPlanoDeFundo() {
            if (confirm("Remover imagem de fundo?")) {
                document.body.style.backgroundImage = 'none';
                salvarDados();
                fecharModal('background-modal');
            }
        }

        function aplicarPlanoDeFundoInicial(ficha) {
            const bgImage = ficha?.backgroundImage;
            const bgSize = ficha?.backgroundSize || 'cover';
            if (bgImage) {
                document.body.style.backgroundImage = `url('${bgImage}')`;
                document.body.style.backgroundSize = bgSize;
            } else {
                document.body.style.backgroundImage = 'none';
            }
        }

        if (backgroundColorButtonVisual && backgroundColorInput) {
            backgroundColorButtonVisual.addEventListener('click', () => backgroundColorInput.click());
            backgroundColorInput.addEventListener('input', (event) => {
                document.body.style.backgroundColor = event.target.value;
                backgroundColorButtonVisual.style.backgroundColor = event.target.value; 
                salvarDados();
            });
        }
        
        function aplicarCorDeFundoInicial(ficha) {
            const defaultColorLight = '#f0e6d2'; 
            const defaultColorDark = '#121212'; 

            let bgColorToApply = ficha?.darkMode ? defaultColorDark : defaultColorLight;
            if (ficha?.backgroundColor) {
                bgColorToApply = ficha.backgroundColor;
            }
            
            document.body.style.backgroundColor = bgColorToApply;
            if (backgroundColorInput) backgroundColorInput.value = bgColorToApply;
            if (backgroundColorButtonVisual) backgroundColorButtonVisual.style.backgroundColor = bgColorToApply;
        }
        
        if (fontSelector) {
            fontSelector.addEventListener('change', (event) => {
                const selectedFont = event.target.value;
                document.body.style.fontFamily = selectedFont;
                if (fichaContainer) fichaContainer.style.fontFamily = selectedFont;
                salvarDados(); 
            });
        }

        function aplicarFonteInicial(ficha) {
            const defaultFont = "'Inter', sans-serif";
            const bodyFont = ficha?.fontFamily || defaultFont;
            document.body.style.fontFamily = bodyFont;
            if (fichaContainer) fichaContainer.style.fontFamily = bodyFont;
            if (fontSelector) fontSelector.value = bodyFont;
        }

        if (diceColorVisualBtn && diceColorInput) {
            diceColorVisualBtn.addEventListener('click', () => diceColorInput.click());
            diceColorInput.addEventListener('input', (event) => {
                diceRoll.style.setProperty('--dice-bg-color', event.target.value);
                diceColorVisualBtn.style.backgroundColor = event.target.value; 
                salvarDados();
            });
        }

        if (diceNumberColorVisualBtn && diceNumberColorInput) {
            diceNumberColorVisualBtn.addEventListener('click', () => diceNumberColorInput.click());
            diceNumberColorInput.addEventListener('input', (event) => {
                diceRoll.style.setProperty('--dice-number-color', event.target.value);
                diceNumberColorVisualBtn.style.color = event.target.value; 
                diceNumberColorVisualBtn.style.backgroundColor = kontrast(event.target.value) === 'black' ? 'white' : 'black';
                salvarDados();
            });
        }
        function kontrast(hexcolor){
            if (hexcolor.slice(0, 1) === '#') { hexcolor = hexcolor.slice(1); }
            if (hexcolor.length === 3) {
                hexcolor = hexcolor.split('').map(function (hex) { return hex + hex; }).join('');
            }
            var r = parseInt(hexcolor.substr(0,2),16);
            var g = parseInt(hexcolor.substr(2,2),16);
            var b = parseInt(hexcolor.substr(4,2),16);
            var yiq = ((r*299)+(g*587)+(b*114))/1000;
            return (yiq >= 128) ? 'black' : 'white';
        }


        function aplicarCoresDadoInicial(ficha) {
            const defaultDiceColor = ficha?.darkMode ? '#1e1e1e' : '#f0e6d2';
            const defaultDiceNumberColor = ficha?.darkMode ? '#e0e0e0' : '#000000';

            const diceBg = ficha?.diceColor || defaultDiceColor;
            const diceNumCol = ficha?.diceNumberColor || defaultDiceNumberColor;

            if(diceRoll) { // Verificar se diceRoll existe
                diceRoll.style.setProperty('--dice-bg-color', diceBg);
                diceRoll.style.setProperty('--dice-number-color', diceNumCol);
            }


            if (diceColorInput) diceColorInput.value = diceBg;
            if (diceColorVisualBtn) diceColorVisualBtn.style.backgroundColor = diceBg;

            if (diceNumberColorInput) diceNumberColorInput.value = diceNumCol;
            if (diceNumberColorVisualBtn) {
                diceNumberColorVisualBtn.style.color = diceNumCol;
                diceNumberColorVisualBtn.style.backgroundColor = kontrast(diceNumCol) === 'black' ? 'white' : 'black';
            }
        }
        
        if(diceHistoryTrigger) diceHistoryTrigger.addEventListener('click', () => {
            aplicarFeedbackBotao(diceHistoryTrigger);
            if (diceHistoryPanel.style.display === 'flex') {
                diceHistoryPanel.style.display = 'none';
                return;
            }
            if (anotacoesTextarea.style.display === 'block') {
                anotacoesTextarea.style.display = 'none';
            }

            senhaGmTitulo.textContent = "Acessar Hist√≥rico de Dados";
            document.getElementById("senha-gm-modal").style.display = "flex"; 
            document.getElementById("senha-gm-input").value = "";
            document.getElementById("senha-gm-input").focus();
            document.getElementById("confirmar-senha-gm-btn").onclick = () => {
                 aplicarFeedbackBotao(document.querySelector('#senha-gm-modal .confirm-btn'));
                if (document.getElementById("senha-gm-input").value === senhaMatriz) {
                    abrirPainelHistoricoDados();
                    fecharModal("senha-gm-modal");
                } else { 
                    alert("Senha do GM incorreta!"); 
                    fecharModal("senha-gm-modal"); 
                }
            };
        });


        function abrirPainelHistoricoDados() {
            diceHistoryPanel.style.display = 'flex'; 
            if (!fichas[currentFichaId] || !fichas[currentFichaId].diceRolls || fichas[currentFichaId].diceRolls.length === 0) {
                diceHistoryList.innerHTML = '<div class="dice-history-item">Nenhuma rolagem registrada.</div>';
                return;
            }

            const rolls = fichas[currentFichaId].diceRolls;
            diceHistoryList.innerHTML = rolls.map(roll => `
                <div class="dice-history-item">
                    Rolagem: <strong>${roll.type}</strong>, Resultado: <strong>${roll.result}</strong>
                    <span class="timestamp">${roll.timestamp}</span>
                </div>
            `).join('');
        }

        if(fecharHistoricoBtn) fecharHistoricoBtn.addEventListener('click', (e) => {
            aplicarFeedbackBotao(e.currentTarget);
            diceHistoryPanel.style.display = 'none';
        });

        if(limparHistoricoBtn) limparHistoricoBtn.addEventListener('click', (e) => {
            aplicarFeedbackBotao(e.currentTarget);
            if (confirm("Tem certeza que deseja limpar todo o hist√≥rico de rolagens desta ficha?")) {
                if (fichas[currentFichaId]) {
                    fichas[currentFichaId].diceRolls = [];
                    salvarDados();
                    abrirPainelHistoricoDados(); 
                    showNotification("Hist√≥rico de rolagens limpo!", "save-success");
                }
            }
        });
        
        function aplicarFeedbackBotao(botao) {
            if (!botao) return;
            botao.classList.add('button-clicked');
            setTimeout(() => {
                botao.classList.remove('button-clicked');
            }, 150); 
        }

        function aplicarEstadoColapsoSecoes(collapsedSectionsMap) {
            document.querySelectorAll('#ficha-content section').forEach(section => {
                const sectionId = section.id;
                const content = section.querySelector('.section-content');
                const icon = section.querySelector('.collapse-icon');
                if (content && icon) {
                    const isCollapsed = collapsedSectionsMap ? collapsedSectionsMap[sectionId] : false; // Default to not collapsed
                    content.classList.toggle('collapsed', isCollapsed);
                    icon.textContent = isCollapsed ? '‚ñ∫' : '‚ñº';
                    icon.classList.toggle('collapsed', isCollapsed);
                }
            });
        }

        function toggleCollapseSection(sectionId) {
            const section = document.getElementById(sectionId);
            if (!section) return;
            const content = section.querySelector('.section-content');
            const icon = section.querySelector('.collapse-icon');

            if (content && icon) {
                const isCollapsed = content.classList.toggle('collapsed');
                icon.classList.toggle('collapsed', isCollapsed);
                icon.textContent = isCollapsed ? '‚ñ∫' : '‚ñº';

                if (!fichas[currentFichaId].collapsedSections) {
                    fichas[currentFichaId].collapsedSections = {};
                }
                fichas[currentFichaId].collapsedSections[sectionId] = isCollapsed;
                salvarDados();
            }
        }

        function moverSecao(sectionId, direcao) {
            const index = sectionOrder.indexOf(sectionId);
            if (index === -1) return;

            let novoIndex = index;
            if (direcao === 'up' && index > 0) {
                novoIndex = index - 1;
            } else if (direcao === 'down' && index < sectionOrder.length - 1) {
                novoIndex = index + 1;
            }

            if (novoIndex !== index) {
                // Remove e insere na nova posi√ß√£o
                const [itemMovido] = sectionOrder.splice(index, 1);
                sectionOrder.splice(novoIndex, 0, itemMovido);

                // Recria a estrutura da ficha com a nova ordem
                criarEstruturaFicha();
                // Recarrega os dados na nova estrutura (preservando estados)
                const fichaAtual = fichas[currentFichaId];
                carregarFicha(currentFichaId); // Isso j√° vai aplicar o estado de colapso e outros dados
                
                // Salva a nova ordem
                fichas[currentFichaId].sectionOrder = [...sectionOrder];
                salvarDados();
            }
        }
        
        function adicionarEventListenersGlobais() {
            adicionarEventListenersInputs(); // Para inputs dentro das se√ß√µes
            
            // Adicionar feedback visual aos bot√µes principais e outros
            document.querySelectorAll('.botao, .ficha-tab, #add-ficha-btn, .dice-option-btn, #change-dice-type-btn, #adicionar-magia-btn').forEach(btn => {
                // Remove listener antigo para evitar duplica√ß√£o se chamado m√∫ltiplas vezes
                const newBtn = btn.cloneNode(true);
                btn.parentNode.replaceChild(newBtn, btn);
                newBtn.addEventListener('click', (e) => {
                    aplicarFeedbackBotao(e.currentTarget);
                    // Se for um bot√£o que j√° tem um onclick definido no HTML, precisamos garantir que ele ainda funcione
                    // Este √© um ponto fraco de recriar o DOM; idealmente, os handlers seriam todos adicionados via JS.
                    // Para os bot√µes principais que s√£o recriados com criarEstruturaFicha, seus listeners precisam ser reatribu√≠dos l√°.
                    // Para os que n√£o s√£o recriados, o listener original permanece.
                    // Para os bot√µes dentro de #ficha-content (como os de Vantagens/Desvantagens), seus listeners precisam ser reatribu√≠dos
                    // ap√≥s criarEstruturaFicha, por exemplo, dentro de um `reasignarEventListenersBotoesControle`.
                });
            });
            
            // Adicionar funcionalidade de colapso √†s se√ß√µes
            document.querySelectorAll('#ficha-content section h2').forEach(header => {
                header.addEventListener('click', (event) => {
                     // N√£o colapsar se o clique foi nos bot√µes de ordena√ß√£o
                    if (event.target.classList.contains('order-btn')) {
                        event.stopPropagation();
                        return;
                    }
                    const sectionId = header.parentElement.id;
                    if (sectionId) {
                        toggleCollapseSection(sectionId);
                    }
                });
                // Adicionar listeners para bot√µes de ordena√ß√£o
                header.querySelectorAll('.order-btn').forEach(btn => {
                    btn.addEventListener('click', (event) => {
                        event.stopPropagation(); // Evita que o clique no bot√£o tamb√©m colapse a se√ß√£o
                        aplicarFeedbackBotao(event.currentTarget);
                        const sectionId = header.parentElement.id;
                        const direction = btn.dataset.direction;
                        moverSecao(sectionId, direction);
                    });
                });
            });

            adicionarEventListenersOpcoesDado();

            // Reatribuir listeners para bot√µes de controle principais (que est√£o fora de #ficha-content mas s√£o recriados)
            // Estes s√£o os bot√µes de Vantagens, Ra√ßas, Classes, Resetar, Recome√ßar, etc.
            // Seus listeners originais j√° devem estar atribu√≠dos no escopo global ou no DOMContentLoaded.
            // O que foi feito em `criarEstruturaFicha` para esses bot√µes foi apenas adicion√°-los ao DOM.
            // Ent√£o, os onclicks definidos no HTML ou em `DOMContentLoaded` deveriam continuar funcionando.
            // Para os bot√µes de AUMENTAR/DIMINUIR VIDA/MAGIA/VIGOR, eles s√£o recriados, ent√£o seus listeners precisam ser reconfigurados:
             const btnDiminuirVida = document.getElementById('btn-diminuir-vida');
            const btnAumentarVida = document.getElementById('btn-aumentar-vida');
            const btnDiminuirMagia = document.getElementById('btn-diminuir-magia');
            const btnAumentarMagia = document.getElementById('btn-aumentar-magia');
            const btnDiminuirVigor = document.getElementById('btn-diminuir-vigor');
            const btnAumentarVigor = document.getElementById('btn-aumentar-vigor');

            if(btnDiminuirVida) setupHoldButtonEvents(btnDiminuirVida, diminuirVida);
            if(btnAumentarVida) setupHoldButtonEvents(btnAumentarVida, aumentarVida);
            if(btnDiminuirMagia) setupHoldButtonEvents(btnDiminuirMagia, diminuirMagia);
            if(btnAumentarMagia) setupHoldButtonEvents(btnAumentarMagia, aumentarMagia);
            if(btnDiminuirVigor) setupHoldButtonEvents(btnDiminuirVigor, diminuirVigor);
            if(btnAumentarVigor) setupHoldButtonEvents(btnAumentarVigor, aumentarVigor);
        }


        function setupHoldButtonEvents(buttonElement, actionFunction) {
            if (!buttonElement) return;

            const startAction = (event) => {
                event.preventDefault(); 
                if (isFichaLocked && !isFichaUnlocked && currentFichaId !== FICHA_MATRIZ_ID) {
                    abrirModalSenha(buttonElement); 
                    return;
                }
                actionFunction(); 
                aplicarFeedbackBotao(buttonElement); // Adiciona feedback aqui
                if (currentActionIntervalId) clearInterval(currentActionIntervalId);
                currentActionIntervalId = setInterval(actionFunction, REPEAT_DELAY_MS);
            };

            const stopAction = () => {
                clearInterval(currentActionIntervalId);
                currentActionIntervalId = null;
            };

            // Remover listeners antigos para evitar duplica√ß√£o
            buttonElement.removeEventListener('mousedown', startAction);
            buttonElement.removeEventListener('mouseup', stopAction);
            buttonElement.removeEventListener('mouseleave', stopAction);
            buttonElement.removeEventListener('touchstart', startAction);
            buttonElement.removeEventListener('touchend', stopAction);
            buttonElement.removeEventListener('touchcancel', stopAction);

            // Adicionar novos listeners
            buttonElement.addEventListener('mousedown', startAction);
            buttonElement.addEventListener('mouseup', stopAction);
            buttonElement.addEventListener('mouseleave', stopAction);
            buttonElement.addEventListener('touchstart', startAction, { passive: false });
            buttonElement.addEventListener('touchend', stopAction);
            buttonElement.addEventListener('touchcancel', stopAction);
        }

        document.addEventListener('DOMContentLoaded', () => {
             fireworksContainerRef = document.getElementById('fireworks-container'); 
             if (diceContainer) { 
                currentX = diceContainer.offsetLeft;
                currentY = diceContainer.offsetTop;
            }
            // A chamada para carregarFichas agora lida com a cria√ß√£o da estrutura
            carregarFichas(); 

            // Os event listeners dos bot√µes de controle da ficha (resetar, etc.)
            // s√£o atribu√≠dos aqui porque esses bot√µes n√£o s√£o recriados por criarEstruturaFicha.
            // Eles est√£o fora do #ficha-content
            document.getElementById("vantagens-desvantagens-btn").onclick = (e) => {
                aplicarFeedbackBotao(e.currentTarget);
                if (isFichaLocked && !isFichaUnlocked) return abrirModalSenha(vantagensDesvantagensBtn);
                tempVantagensSelecionadas = [...vantagensSelecionadas]; tempDesvantagensSelecionadas = [...desvantagensSelecionadas];
                vantagensDesvantagensPanel.style.display = "block"; document.getElementById("salvar-vantagens-btn").style.display = "none"; atualizarVantagensDesvantagensPanel();
            };
            document.getElementById("racas-btn").onclick = (e) => {
                aplicarFeedbackBotao(e.currentTarget);
                if (isFichaLocked && !isFichaUnlocked) return abrirModalSenha(racasBtn); 
                tempRacaSelecionada = racaSelecionada; 
                atualizarRacasPanel(); 
                racasPanel.style.display = "block"; 
                document.getElementById("salvar-racas-btn").style.display = "none"; 
            };
             document.getElementById("classes-btn").onclick = (e) => { 
                aplicarFeedbackBotao(e.currentTarget);
                classesPanel.style.display = "block"; 
            };
            document.getElementById("reset-pontos").onclick = (e) => { 
                aplicarFeedbackBotao(e.currentTarget);
                resetarPontos(); 
            };
            document.getElementById("recomecar").onclick = (e) => { 
                aplicarFeedbackBotao(e.currentTarget);
                recomecarFicha(); 
            };
             document.getElementById("plano-fundo-btn").onclick = (e) => { 
                aplicarFeedbackBotao(e.currentTarget);
                backgroundModal.style.display = "flex"; 
            };
        });

    </script>
</body>
</html>
