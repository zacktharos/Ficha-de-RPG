html
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ficha de Personagem RPG</title>
    <link href="https://fonts.googleapis.com/css2?family=MedievalSharp&family=Inter:wght@400;600&family=Times+New+Roman&family=Arial&family=Courier+New&family=Georgia&family=Verdana&family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --cor-borda-secao: #b8860b;
            --estilo-borda-secao: solid;
            --largura-borda-secao: 2px;
            --ficha-internal-glow: transparent 0 0 0 0 inset; /* Default no glow/shadow */
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0e6d2; /* Cor padrÃ£o modo claro */
            color: #000;
            display: flex;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            background-image: none;
            background-size: cover;
            background-position: center;
            background-attachment: scroll;
            transition: background-color 0.3s, color 0.3s, font-family 0.3s, box-shadow 0.3s;
            box-shadow: none; /* Ensure no body glow by default */
        }
        body.dark-mode {
            background-color: #121212 !important; /* Cor padrÃ£o modo escuro */
            color: #e0e0e0;
            box-shadow: none; /* Ensure no body glow in dark mode */
        }
        #fichas-sidebar {
            width: 100%; height: 60px; padding: 0; display: flex; flex-direction: row;
            align-items: center; justify-content: flex-start; position: fixed;
            top: 0; left: 0; z-index: 1000; overflow-x: auto; background: transparent;
        }
        .ficha-tab {
            visibility: visible; width: 100px; height: 50px; background: #f0e6d2;
            border: 2px solid #b8860b; border-radius: 10px 10px 0 0; margin-right: 10px;
            display: flex; align-items: center; justify-content: center; cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.2);
        }
        .ficha-tab:hover, .ficha-tab.active { background: #a0522d; transform: translateY(-5px); }
        .ficha-tab span {
            font-family: 'MedievalSharp', serif; color: #000; font-size: 0.9rem; text-align: center;
            max-width: 90px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
        }
        #add-ficha-btn {
            width: 100px; height: 50px; background: #f0e6d2; border: 2px solid #b8860b;
            border-radius: 10px 10px 0 0; margin-right: 10px; display: flex; align-items: center;
            justify-content: center; cursor: pointer; transition: transform 0.2s ease;
            box-shadow: 0 0 10px #ffd700, 0 0 20px #ffd700; z-index: 1001;
        }
        #add-ficha-btn span { font-family: 'MedievalSharp', serif; color: #000; font-size: 0.9rem; }
        #add-ficha-btn:hover { background: #a0522d; transform: translateY(-5px); }
        #ficha-container {
            background: #f0e6d2;
            padding: 30px; border-radius: 12px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2), var(--ficha-internal-glow); /* MODIFIED: Uses var for internal shadow */
            width: 95%; max-width: 1200px;
            margin: 80px auto 20px; border: 2px solid #b8860b; position: relative; z-index: 1;
            transition: font-family 0.3s, background-color 0.3s, box-shadow 0.3s, border 0.3s;
        }
        body.dark-mode #ficha-container {
            background: #121212; /* Dark mode ficha background */
            color: #e0e0e0;
            /* The var(--ficha-internal-glow) will be transparent in dark mode via JS */
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2), var(--ficha-internal-glow);
        }

        @keyframes pulsar-aura { /* Used for Nivel 30+ Ficha Aura */
            0% { box-shadow: 0 0 20px #00BFFF, 0 0 30px #00BFFF, 0 0 40px #00BFFF, var(--ficha-internal-glow); }
            50% { box-shadow: 0 0 30px #00BFFF, 0 0 50px #00BFFF, 0 0 60px #00BFFF, var(--ficha-internal-glow); }
            100% { box-shadow: 0 0 20px #00BFFF, 0 0 30px #00BFFF, 0 0 40px #00BFFF, var(--ficha-internal-glow); }
        }
        #ficha-container.aura-azul {
            animation: pulsar-aura 2s infinite;
        }

        h1#nome-personagem-titulo {
            font-family: 'MedievalSharp', serif; color: #1C2526; font-size: 3rem; margin-bottom: 20px;
            text-align: center; text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1); animation: raios 2s infinite linear;
             transition: color 0.3s, text-shadow 0.3s;
        }
        body.dark-mode h1#nome-personagem-titulo {
             color: #c58c5a;
        }
        @keyframes raios {
            0% { text-shadow: 0 0 5px #FFD700, 0 0 10px #FFD700, 0 0 15px #FFD700, 0 0 20px #FF4500; }
            50% { text-shadow: 0 0 10px #FFD700, 0 0 15px #FF4500, 0 0 20px #FF4500, 0 0 25px #FF4500; }
            100% { text-shadow: 0 0 5px #FFD700, 0 0 10px #FFD700, 0 0 15px #FFD700, 0 0 20px #FF4500; }
        }
        #game-master-message { display: none; color: blue; font-size: 1.5rem; text-align: center; font-family: 'MedievalSharp', serif; margin-bottom: 10px; }

        section {
            border-width: var(--largura-borda-secao);
            border-style: var(--estilo-borda-secao);
            border-color: var(--cor-borda-secao);
            border-radius: 8px; padding: 15px; margin-bottom: 20px;
            transition: background-color 0.3s, box-shadow 0.3s, border 0.3s; /* Added box-shadow transition for section shadow */
            /* box-shadow is now controlled by JS for sections */
        }
        body.dark-mode section {
             border-color: #555; /* Default dark mode border for sections */
             /* background-color will be set by JS to dark mode default */
             /* box-shadow will be set to none by JS in dark mode */
        }


        section h2 {
            text-align: center; font-family: 'MedievalSharp', serif; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
             transition: color 0.3s;
        }
        section h2 .collapse-icon { margin-left: 10px; font-size: 1.2rem; transition: transform 0.2s; }
        section .section-content.collapsed { display: none; }
        section h2 .collapse-icon.collapsed { transform: rotate(-90deg); }

        label { font-weight: 600; color: #000; margin-bottom: 8px; display: block;  transition: color 0.3s; }
        body.dark-mode label { color: #e0e0e0; }
        input[type="text"], input[type="number"], textarea, select {
            padding: 10px; border: 2px solid #b8860b; border-radius: 6px; width: calc(100% - 24px);
            margin-bottom: 15px; font-size: 1rem; transition: border-color 0.3s ease, background-color 0.3s, color 0.3s;
            background: #fff; color: #000;
        }
        .recurso-atual-input {
            width: 70px !important;
            text-align: center;
            font-family: 'MedievalSharp', serif;
            font-size: 1.1rem;
            padding: 5px 2px;
            margin: 0 3px !important;
            -moz-appearance: textfield;
            box-sizing: border-box;
        }
        .recurso-atual-input::-webkit-outer-spin-button,
        .recurso-atual-input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        body.dark-mode input[type="text"], body.dark-mode input[type="number"], body.dark-mode textarea, body.dark-mode select {
            background: #333; color: #e0e0e0; border-color: #555;
        }
        input[type="text"]:focus, input[type="number"]:focus, textarea:focus, select:focus {
            border-color: #a0522d; outline: none; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        input[readonly], span[readonly] { background: #e8e8e8; border: 1px solid #ccc; cursor: not-allowed; }
        body.dark-mode input[readonly], body.dark-mode span[readonly] { background: #444; border-color: #666; }
        textarea { resize: vertical; }
        .atributos-container { display: flex; justify-content: space-between; gap: 20px; }
        .atributos-coluna, .atributos-coluna-destaque {
            width: 48%; display: flex; flex-direction: column; align-items: flex-start;
            transition: background-color 0.3s, border-color 0.3s;
        }
        .atributos-coluna-destaque { background: #fff; padding: 10px; border-radius: 6px; border: 1px solid #b8860b; }
        body.dark-mode .atributos-coluna-destaque { background: #333; border-color: #555; }
        .atributo-destaque { padding: 8px; margin-bottom: 10px; display: flex; align-items: center; justify-content: space-between; width: 100%; }
        .atributo-destaque label { font-size: 1.1rem; font-weight: 700; color: #a0522d; }
        .atributo-destaque span { font-size: 1.2rem; font-family: 'MedievalSharp', serif; color: #000; transition: color 0.3s; }
        body.dark-mode .atributo-destaque span { color: #e0e0e0; }
        .atributo-fogo { animation: fogo 1.5s infinite; }
        @keyframes fogo {
            0% { text-shadow: 0 0 5px #ff4500, 0 0 10px #ff4500; }
            50% { text-shadow: 0 0 10px #ff4500, 0 0 15px #ffd700; }
            100% { text-shadow: 0 0 5px #ff4500, 0 0 10px #ff4500; }
        }
        .vida-magia-vigor { display: flex; justify-content: space-around; gap: 15px; flex-wrap: wrap; }
        .atributo-container {
            background: rgba(255, 255, 255, 0.8); padding: 12px; border-radius: 8px; border: 1px solid #b8860b;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); width: 30%; min-width: 200px; text-align: center;
             transition: background-color 0.3s, border-color 0.3s, box-shadow 0.3s;
        }
        body.dark-mode .atributo-container { background: rgba(50, 50, 50, 0.8); } /* Will be overridden by JS if fichaInternalBackground is dark mode default */
        .atributo-container::before { font-size: 1.5rem; margin-bottom: 5px; display: block; }
        .atributo-container.vida::before { content: "â¤ï¸"; }
        .atributo-container.magia::before { content: "âœ¨"; }
        .atributo-container.vigor::before { content: "âš¡"; }
        .medieval-box { background: #f0e6d2; border: 2px solid #b8860b; border-radius: 8px; padding: 10px; margin: 5px 0; text-align: center; transition: background-color 0.3s, border-color 0.3s;}
        body.dark-mode .medieval-box { background: #1e1e1e; border-color: #444; }
        .valor-atual.medieval-box { display: flex; align-items: center; justify-content: center; }

        .regeneracao { font-size: 0.8rem; color: #555; margin-top: 5px; transition: color 0.3s; }
        body.dark-mode .regeneracao { color: #aaa; }
        button {
            background: #b8860b; color: #fff; border: none; padding: 5px 10px;
            cursor: pointer; font-size: 1.2rem; border-radius: 4px; margin: 0 5px;
            transition: background-color 0.3s ease, transform 0.1s ease, box-shadow 0.1s ease, color 0.3s;
        }
        body.dark-mode button { background: #555; }
        button:hover { background: #a0522d; }
        body.dark-mode button:hover { background: #777; }

        .button-clicked {
            transform: scale(0.97);
            box-shadow: inset 1px 1px 3px rgba(0,0,0,0.3);
        }

        .botoes-container { display: flex; justify-content: center; gap: 10px; margin-top: 20px; margin-bottom: 20px; flex-wrap: wrap; }
        .botao {
            padding: 12px 25px; border: none; border-radius: 6px; font-size: 1rem; cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.1s ease, color 0.3s, text-shadow 0.3s, border 0.3s;
            font-family: 'MedievalSharp', serif;
            color: #fff; text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
        }
        body.dark-mode .botao { background: #555; }
        body.dark-mode .botao:hover { background: #777; }
        #reset-pontos, #recomecar, #bloquear-ficha, #excluir-ficha, #gm-mode-btn, #customizacao-btn {
            background-color: #800000;
        }
        .botao-reset:hover, .botao-recomecar:hover, .botao-bloquear:hover, .botao-desbloquear:hover, #excluir-ficha:hover, #gm-mode-btn:hover, #customizacao-btn:hover {
            background: #a0522d; transform: translateY(-2px);
        }
        #gm-mode-btn.gm-active { background-color: #006400; }

        .icon-btn {
            padding: 10px; width: 44px; height: 44px;
            font-size: 1.2rem; line-height: 1; text-align: center;
        }
        #lua-btn { background-color: #333; color: #eee; }
        #sol-btn { background-color: #ffdd00; color: #333; }
        #nivel-container { text-align: center; margin-top: 10px; }
        #nivel {
            padding: 10px; background: #f0e6d2; border: 3px solid #000; border-radius: 50%;
            width: 100px; height: 100px; display: flex; align-items: center; justify-content: center;
            font-size: 3.125rem; box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.5); margin: 0 auto;
            font-family: 'MedievalSharp', serif;
             transition: background-color 0.3s, border-color 0.3s, box-shadow 0.3s;
        }
        body.dark-mode #nivel { background: #1e1e1e; border-color: #444; }
        #nivel.aura-azul { animation: pulsar-aura 5s 1; }
        .expandable-textarea {
            height: 100px; width: 100%; background: #fff; border: 2px solid #b8860b;
            border-radius: 6px; padding: 10px; font-size: 0.9rem; transition: height 0.3s ease, background-color 0.3s, border-color 0.3s;
        }
        body.dark-mode .expandable-textarea { background: #333; }
        .expandable-textarea:focus { height: 15cm; }

        #dice-container {
            position: absolute; top: 20px; right: 20px; width: auto;
            text-align: center;
            font-family: 'MedievalSharp', serif; cursor: move; z-index: 10; user-select: none;
            perspective: 800px;
        }
        #dice-container label { font-size: 1.2rem; color: #000; display: flex; align-items: center; justify-content: center; margin-bottom: 10px; }
        body.dark-mode #dice-container label { color: #e0e0e0; }
        #dice-container label::before { content: "ðŸŽ²"; margin-right: 5px; font-size: 1.5rem; }

        .dice-roll-area { display: flex; align-items: center; justify-content: center; gap: 10px; position: relative;}

        #dice-roll {
            width: 100px; height: 100px;
            background-color: var(--dice-bg-color, #f0e6d2);
            color: var(--dice-number-color, #000000);
            border: 2px solid #b8860b;
            border-radius: 10px;
            display: flex; align-items: center; justify-content: center;
            font-size: 2.5rem;
            cursor: pointer;
            margin: 0;
            position: relative;
            transition: transform 0.3s ease, box-shadow 0.3s ease, background-color 0.3s, color 0.3s, background-image 0.3s, border-color 0.3s;
            font-family: 'MedievalSharp', serif;
            transform-style: preserve-3d;
            background-size: cover;
            background-position: center;
        }
        body.dark-mode #dice-roll { border-color: #444; }

        #dice-roll.is-rolling { animation: rollTheDie 1s ease-out forwards; }
        #dice-roll.is-rolling-fast { animation: rollTheDieFast 0.5s ease-out forwards; }
        #dice-roll.is-rolling-jump { animation: rollTheDieJump 1.2s cubic-bezier(0.5, -0.5, 0.5, 1.5) forwards; }

        @keyframes rollTheDie {
            0% { transform: rotateX(0deg) rotateY(0deg) rotateZ(0deg) scale(1); box-shadow: 0 0 5px #b8860b; }
            25% { transform: rotateX(360deg) rotateY(-270deg) rotateZ(180deg) scale(1.1) translateX(-10px) translateY(5px); box-shadow: 0 0 10px #a0522d, 0 0 15px #FFD700; }
            50% { transform: rotateX(-180deg) rotateY(360deg) rotateZ(-360deg) scale(0.9) translateX(10px) translateY(-10px); box-shadow: 0 0 15px #b8860b, 0 0 20px #a0522d; }
            75% { transform: rotateX(270deg) rotateY(-180deg) rotateZ(270deg) scale(1.05) translateX(-5px) translateY(8px); box-shadow: 0 0 10px #FFD700, 0 0 15px #a0522d; }
            100% { transform: rotateX(0deg) rotateY(0deg) rotateZ(0deg) scale(1); box-shadow: 0 0 5px #b8860b; }
        }
        @keyframes rollTheDieFast {
            0% { transform: rotateZ(0deg) scale(1); }
            100% { transform: rotateZ(720deg) scale(1); }
        }
        @keyframes rollTheDieJump {
            0% { transform: translateY(0) rotate(0deg) scale(1); }
            25% { transform: translateY(-30px) rotate(180deg) scale(1.2); }
            50% { transform: translateY(0) rotate(360deg) scale(1); }
            75% { transform: translateY(-15px) rotate(540deg) scale(1.1); }
            100% { transform: translateY(0) rotate(720deg) scale(1); }
        }

        #dice-result { margin-top: 10px; font-size: 1rem; color: #000; display: none; animation: blink 1s infinite; transition: color 0.3s; }
        body.dark-mode #dice-result { color: #e0e0e0; }
        @keyframes blink { 50% { opacity: 0; } }

        #dice-roll.critical-failure { animation: aura-vermelha 0.5s 4; }
        #dice-roll.critical-success { animation: aura-verde 0.5s 4; }
        @keyframes aura-vermelha {
            0%, 100% { box-shadow: 0 0 5px #ff0000, 0 0 10px #ff0000, 0 0 15px #ff0000 !important; }
            50% { box-shadow: 0 0 20px #ff0000, 0 0 30px #ff0000, 0 0 40px #ff0000 !important; }
        }
        @keyframes aura-verde {
            0%, 100% { box-shadow: 0 0 5px #00ff00, 0 0 10px #00ff00, 0 0 15px #00ff00 !important; }
            50% { box-shadow: 0 0 20px #00ff00, 0 0 30px #00ff00, 0 0 40px #00ff00 !important; }
        }

        #change-dice-type-btn {
            background-color: #d2b48c; color: #3a2800; border: 1px solid #b8860b;
            width: 55px; height: 36px; font-size: 0.9rem; padding: 5px;
            box-sizing: border-box;
             transition: background-color 0.3s, color 0.3s, border-color 0.3s;
        }
        body.dark-mode #change-dice-type-btn { background-color: #4a3c2a; color: #f0e6d2; border-color: #6b5230; }

        #dice-options-menu {
            display: none;
            position: absolute;
            top: 40px;
            right: 0;
            background-color: #f0e6d2;
            border: 1px solid #b8860b;
            border-radius: 4px;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.2);
            z-index: 110;
            padding: 5px;
            flex-direction: column;
            gap: 5px;
             transition: background-color 0.3s, border-color 0.3s;
        }
        body.dark-mode #dice-options-menu { background-color: #1e1e1e; border-color: #444; }
        .dice-option-btn {
            width: 100%;
            padding: 8px 10px;
            font-size: 0.9rem;
            background-color: #e6cca7; color: #3a2800;
            border: 1px solid #b8860b; border-radius: 3px;
            text-align: center;
            margin:0;
             transition: background-color 0.3s, color 0.3s, border-color 0.3s;
        }
        .dice-option-btn:hover { background-color: #d2b48c; }
        body.dark-mode .dice-option-btn { background-color: #3a2f1e; color: #f0e6d2; border-color: #5c4b35; }
        body.dark-mode .dice-option-btn:hover { background-color: #4a3c2a; }

        #fireworks-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 0; pointer-events: none; overflow: hidden;
        }
        .firework-particle {
            position: absolute; border-radius: 50%; opacity: 1;
        }
        @keyframes particle-trail {
            0% { opacity: 1; transform: scale(1) translateY(0px); }
            50% { opacity: 0.7; }
            100% { opacity: 0; transform: scale(0.3) translateY(40px); }
        }

        #dice-history-trigger {
            position: fixed;
            top: calc(50% + 70px);
            right: 10px;
            transform: translateY(-50%);
            padding: 10px 15px;
            background: #a0522d;
            color: white;
            border: 2px solid #b8860b;
            border-right: none;
            border-radius: 6px 0 0 6px;
            font-family: 'MedievalSharp', serif;
            font-size: 1rem;
            cursor: pointer;
            z-index: 1000;
            writing-mode: vertical-rl;
            text-orientation: mixed;
            transition: background-color 0.3s, border-color 0.3s;
        }
        body.dark-mode #dice-history-trigger { background-color: #555; border-color: #444;}

        #dice-history-panel {
            position: fixed;
            right: 50px;
            top: calc(50% + 70px);
            transform: translateY(-50%);
            width: 400px;
            max-height: 400px;
            background: #fff;
            border: 2px solid #b8860b;
            border-radius: 6px;
            padding: 15px;
            font-size: 0.9rem;
            z-index: 1001;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            display: none;
            flex-direction: column;
            transition: background-color 0.3s, border-color 0.3s, color 0.3s;
        }
        body.dark-mode #dice-history-panel { background: #333; color: #e0e0e0; border-color: #555;}

        #dice-history-panel h2 {
            font-family: 'MedievalSharp', serif; font-size: 1.5rem; text-align: center;
            color: #a0522d; margin-bottom: 10px; flex-shrink: 0; transition: color 0.3s;
        }
        body.dark-mode #dice-history-panel h2 { color: #c58c5a;}

        #dice-history-list {
            flex-grow: 1;
            overflow-y: auto;
            background: #f9f2e7;
            border: 1px solid #b8860b;
            border-radius: 4px;
            padding: 8px;
            margin-bottom: 10px;
             transition: background-color 0.3s, border-color 0.3s;
        }
        body.dark-mode #dice-history-list { background: #2a2a2a; border-color: #555; }
        .dice-history-item {
            padding: 6px 4px;
            border-bottom: 1px dashed #d2b48c;
            font-size: 0.9rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: border-bottom-color 0.3s;
        }
        body.dark-mode .dice-history-item { border-bottom-color: #4a3c2a; }
        .dice-history-item:last-child { border-bottom: none; }
        .dice-history-item .timestamp { font-size: 0.7rem; color: #777; margin-left: 8px; white-space: nowrap; transition: color 0.3s; }
        body.dark-mode .dice-history-item .timestamp { color: #aaa; }

        .dice-history-buttons { display: flex; justify-content: space-between; margin-top: auto; flex-shrink: 0;}
        #fechar-historico-btn, #limpar-historico-btn {
            padding: 8px 15px; font-size: 0.9rem; flex-basis: 48%;
        }
        #limpar-historico-btn { background-color: #800000; }
        #limpar-historico-btn:hover { background-color: #a00000; }
        body.dark-mode #limpar-historico-btn { background-color: #400000;}
        body.dark-mode #limpar-historico-btn:hover { background-color: #600000;}

        #notification {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); padding: 20px;
            border-radius: 8px; font-family: 'MedievalSharp', serif; font-size: 1.5rem; color: #fff;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5); display: none; z-index: 2000;
            background: rgba(0, 0, 0, 0.7); transition: opacity 0.3s ease;
        }
        #notification.critical-failure { background: rgba(255, 0, 0, 0.8); animation: aura-vermelha 2s infinite; }
        #notification.critical-success { background: rgba(0, 255, 0, 0.8); animation: aura-verde 2s infinite; }
        #notification.normal-result { animation: blink 1s infinite; }
        #notification.save-success { background: rgba(0, 200, 0, 0.8); }

        #character-image-container {
            position: absolute; top: 10px; left: 10px; width: 100px; height: 100px; background: #f0e6d2;
            border: 2px solid #b8860b; border-radius: 8px; display: flex; align-items: center;
            justify-content: center; cursor: pointer; overflow: hidden; z-index: 10;
            transition: background-color 0.3s, border-color 0.3s;
        }
        body.dark-mode #character-image-container { background: #1e1e1e; }
        #character-image { width: 100%; height: 100%; object-fit: cover; display: none; }
        #character-image-container:hover { box-shadow: 0 0 10px #ffd700; }
        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.5); justify-content: center; align-items: center; z-index: 1000;
        }
        .modal-content {
            background: #f0e6d2; padding: 20px; border-radius: 8px; border: 2px solid #b8860b;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3); width: 300px; text-align: center;
            transition: background-color 0.3s, border-color 0.3s;
        }
        body.dark-mode .modal-content { background: #1e1e1e; border-color: #444; }
        .modal-content h3 { font-family: 'MedievalSharp', serif; color: #000; margin-bottom: 15px; transition: color 0.3s; }
        body.dark-mode .modal-content h3 { color: #e0e0e0; }
        .modal-content input, .modal-content select {
            width: calc(100% - 20px); padding: 10px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 6px;
        }
        body.dark-mode .modal-content input, body.dark-mode .modal-content select { background: #333; color: #e0e0e0; border-color: #555; }
        .modal-content button {
            padding: 10px 20px; border: none; border-radius: 6px; font-family: 'MedievalSharp', serif;
            color: #fff; cursor: pointer; margin: 0 5px;
        }
        .modal-content .confirm-btn { background: #b8860b; }
        .modal-content .confirm-btn:hover { background: #a0522d; }
        .modal-content .cancel-btn { background: #a52a2a; }
        .modal-content .cancel-btn:hover { background: #8b0000; }

        #customizacao-modal .modal-content {
            width: 550px;
            max-height: 90vh;
            overflow-y: auto;
            text-align: left;
        }
        #customizacao-modal .modal-content h3 {
            text-align: center;
            font-size: 1.8rem;
            color: #a0522d;
        }
        body.dark-mode #customizacao-modal .modal-content h3 { color: #c58c5a;}

        #customizacao-modal fieldset {
            border: 1px solid #b8860b;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 20px;
            transition: border-color 0.3s;
        }
        body.dark-mode #customizacao-modal fieldset { border-color: #555; }

        #customizacao-modal legend {
            font-family: 'MedievalSharp', serif;
            font-size: 1.3rem;
            color: #800000;
            padding: 0 10px;
            font-weight: bold;
            transition: color 0.3s;
        }
        body.dark-mode #customizacao-modal legend { color: #d2b48c;}

        #customizacao-modal .input-group {
            margin-bottom: 15px;
        }
        #customizacao-modal .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: normal;
        }
        #customizacao-modal .input-group input[type="color"],
        #customizacao-modal .input-group input[type="file"],
        #customizacao-modal .input-group select,
        #customizacao-modal .input-group input[type="number"],
        #customizacao-modal .input-group input[type="range"] {
            width: 100%;
            box-sizing: border-box;
        }

        #customizacao-modal .radio-group label {
            display: inline-block;
            margin-right: 15px;
            font-weight: normal;
        }
        #customizacao-modal .radio-group input[type="radio"] {
           width: auto;
           margin-right: 5px;
        }
        #customizacao-modal .custom-dice-texture-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }
        #customizacao-modal .custom-dice-texture-controls button {
            flex-shrink: 0;
        }


        #vantagens-desvantagens-btn, #racas-btn, #classes-btn {
            padding: 10px 20px; background: #f0e6d2; border: 2px solid #b8860b; border-radius: 6px;
            font-family: 'MedievalSharp', serif; font-size: 1rem; color: #000; cursor: pointer;
            transition: background-color 0.3s ease, border-color 0.3s, color 0.3s; z-index: 10;
        }
        body.dark-mode #vantagens-desvantagens-btn, body.dark-mode #racas-btn, body.dark-mode #classes-btn {
            background: #1e1e1e; color: #e0e0e0;
        }
        #vantagens-desvantagens-btn:hover, #racas-btn:hover, #classes-btn:hover { background: #a0522d; color: #fff; }
        #vantagens-desvantagens-panel, #racas-panel, #classes-panel {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(240, 230, 210, 0.95); padding: 20px; overflow-y: auto; z-index: 999;
            border: 2px solid #b8860b; box-shadow: 0 0 20px rgba(0, 0, 0, 0.3);
             transition: background-color 0.3s, border-color 0.3s;
        }
        body.dark-mode #vantagens-desvantagens-panel, body.dark-mode #racas-panel, body.dark-mode #classes-panel {
            background: rgba(30, 30, 30, 0.95);
        }
        #vantagens-desvantagens-panel h2, #racas-panel h2, #classes-panel h2 {
            font-family: 'MedievalSharp', serif; font-size: 2rem; text-align: center;
            color: #a0522d; margin-bottom: 20px; transition: color 0.3s;
        }
        #racas-panel h2 { font-size: 3rem; }
        .vantagem-item, .desvantagem-item, .raca-item {
            padding: 10px; margin: 5px 0; background: #fff; border: 1px solid #ccc;
            border-radius: 6px; cursor: pointer; transition: background-color 0.3s ease, border-color 0.3s, color 0.3s;
        }
        body.dark-mode .vantagem-item, body.dark-mode .desvantagem-item, body.dark-mode .raca-item {
            background: #333; border-color: #555;
        }
        .vantagem-item:hover, .desvantagem-item:hover, .raca-item:hover { background: #f0e6d2; }
        body.dark-mode .vantagem-item:hover, body.dark-mode .desvantagem-item:hover, body.dark-mode .raca-item:hover { background: #444; }
        .vantagem-item.comprada, .raca-item.comprada { background: #ffcccc; color: #f00; cursor: default; }
        .desvantagem-item.comprada { background: #ccffcc; color: #080; cursor: default; }
        #salvar-vantagens-btn, #salvar-racas-btn, #fechar-pagina-btn, #fechar-racas-btn, #fechar-classes-btn {
            position: fixed; bottom: 20px; padding: 12px 25px; background: #a52a2a; color: #fff;
            border: none; border-radius: 6px; font-family: 'MedievalSharp', serif; font-size: 1.2rem;
            cursor: pointer; transition: transform 0.2s ease, background-color 0.3s;
        }
        #salvar-vantagens-btn, #salvar-racas-btn { right: 250px; animation: aura-verde-btn 2s infinite; display: none; background: #000; }
        #fechar-pagina-btn, #fechar-racas-btn, #fechar-classes-btn { right: 20px; }
        #salvar-vantagens-btn:hover, #salvar-racas-btn:hover, #fechar-pagina-btn:hover, #fechar-racas-btn:hover, #fechar-classes-btn:hover {
            transform: translateY(-2px);
        }
        @keyframes aura-verde-btn {
            0% { box-shadow: 0 0 5px #00ff00, 0 0 10px #00ff00; }
            50% { box-shadow: 0 0 15px #00ff00, 0 0 20px #00ff00; }
            100% { box-shadow: 0 0 5px #00ff00, 0 0 10px #00ff00; }
        }
        .locomotion-container { background: #8B4513; border: 3px solid #FFD700; border-radius: 10px; padding: 15px; color: #FFD700; font-family: 'MedievalSharp', serif; transition: background-color 0.3s, border-color 0.3s, color 0.3s; }
        .locomotion-item { display: flex; align-items: center; margin-bottom: 10px; }
        .locomotion-item label { font-weight: bold; color: #FFD700; }
        .locomotion-item span { font-size: 1.2rem; color: #FFF; text-shadow: 1px 1px 2px #000; margin-left: 5px; font-weight: bold; }
        #distancia-pulo, #altura-pulo, #velocidade-corrida { background-color: #8B4513; border-color: #8B4513; }
        .list-display { background: #fff; border: 2px solid #b8860b; border-radius: 6px; padding: 10px; min-height: 100px; max-height: 200px; overflow-y: auto;  transition: background-color 0.3s, border-color 0.3s;}
        body.dark-mode .list-display { background: #333; border-color: #555; }
        .list-item { cursor: pointer; margin-bottom: 5px; padding: 5px; border-bottom: 1px solid #ccc; transition: border-color 0.3s;}
        body.dark-mode .list-item { border-color: #555; }
        .list-item:hover { background: #e0e0e0; }
        body.dark-mode .list-item:hover { background: #444; }
        .inventory-slot { display: flex; align-items: center; margin-bottom: 10px; }
        .inventory-slot input[type="text"] { flex-grow: 1; margin-right: 10px; }
        .inventory-slot input[type="number"] { width: 60px; }
        #anotacoes-btn {
            position: fixed; left: 10px; top: 50%; transform: translateY(-50%); padding: 10px 15px;
            background: #f0e6d2; border: 2px solid #b8860b; border-left: none;
            border-radius: 0 6px 6px 0;
            font-family: 'MedievalSharp', serif; font-size: 1rem; color: #000; cursor: pointer;
            transition: background-color 0.3s ease, border-color 0.3s; z-index: 1000;
            writing-mode: vertical-rl; text-orientation: mixed;
        }
        body.dark-mode #anotacoes-btn { background: #1e1e1e; color: #e0e0e0; border-color: #444;}
        #anotacoes-btn:hover { background: #a0522d; color: #fff; }
        #anotacoes-textarea {
            display: none; position: fixed; left: 50px;
            top: 50%; transform: translateY(-50%);
            width: 400px; height: 400px; background: #fff; border: 2px solid #b8860b;
            border-radius: 6px; padding: 10px; font-size: 0.9rem; resize: none; z-index: 1001;
             transition: background-color 0.3s, border-color 0.3s, color 0.3s;
        }
        body.dark-mode #anotacoes-textarea { background: #333; color: #e0e0e0; }
        .magias-container { max-height: 300px; overflow-y: auto; border: 2px solid #b8860b; border-radius: 6px; padding: 10px; background: #fff;  transition: background-color 0.3s, border-color 0.3s; }
        body.dark-mode .magias-container { background: #333; border-color: #555; }
        .magias-container input { margin-bottom: 10px; }
        #adicionar-magia-btn { background: #b8860b; color: #fff; padding: 8px 16px; border-radius: 6px; cursor: pointer; display: block; margin-top: 10px; }
        #adicionar-magia-btn:hover { background: #a0522d; }
        .classe-raca-container { background: #f0e6d2; border: 2px solid #b8860b; padding: 10px; border-radius: 6px; margin-top: 10px; transition: background-color 0.3s, border-color 0.3s;}
        body.dark-mode .classe-raca-container { background: #1e1e1e; border-color: #444; }
        .classe-raca-container label { font-family: 'MedievalSharp', serif; color: #a0522d; font-size: 1.2rem; transition: color 0.3s;}
        .classe-raca-container span[onclick] { background: #fff; border: 2px solid #b8860b; padding: 10px; cursor: pointer; display: block;  transition: background-color 0.3s, border-color 0.3s;}
        body.dark-mode .classe-raca-container span[onclick] { background: #333; color: #e0e0e0; }
        .classe-raca-container textarea { width: 100%; background: #fff; border: 2px solid #b8860b; }
        body.dark-mode .classe-raca-container textarea { background: #333; color: #e0e0e0; }
        .raca-item { margin-bottom: 20px; padding: 10px; background: #fff; border: 2px solid #b8860b; border-radius: 6px; }
        .raca-item h3 { font-family: 'MedievalSharp', serif; font-size: 1.5rem; color: #a0522d;  transition: color 0.3s;}
        .raca-item p { font-size: 1rem; color: #000; transition: color 0.3s;}
        body.dark-mode .raca-item { background: #333; border-color: #555; }
        body.dark-mode .raca-item p { color: #e0e0e0; }
        .theme-buttons-container { display: flex; justify-content: center; align-items:center; gap: 10px; margin-top: -10px; margin-bottom: 20px; flex-wrap: wrap; }

        .lock-icon { margin-left: 5px; cursor: help; }

        .gm-edit-icon {
            font-size: 0.8rem;
            margin-left: 5px;
            cursor: pointer;
            display: none;
            color: #007bff;
        }
        body.gm-mode-active .gm-edit-icon {
            display: inline;
        }
        body.dark-mode .gm-edit-icon {
            color: #61dafb;
        }
        .gm-edit-icon:hover {
            text-shadow: 0 0 3px currentColor;
        }
        #custom-tooltip {
            position: absolute;
            visibility: hidden;
            background-color: #333;
            color: white;
            padding: 8px 12px;
            border-radius: 5px;
            font-size: 0.85rem;
            z-index: 2000;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s ease-in-out;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            max-width: 250px;
            text-align: left;
        }
        body.dark-mode #custom-tooltip {
            background-color: #f0e6d2;
            color: #1e1e1e;
            border: 1px solid #444;
        }
        #custom-tooltip.visible {
            visibility: visible;
            opacity: 1;
        }

        #confirmar-salvar-atributos-texto {
            background-color: yellow; /* Amarelo */
            color: #333; /* Texto escuro para contraste com amarelo */
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px; /* Added margin for spacing */
            animation: glow-red-text 1.5s infinite alternate;
            font-weight: bold;
            font-size: 1.1rem; /* Slightly larger font for emphasis */
        }

        @keyframes glow-red-text {
            0% { text-shadow: 0 0 5px red, 0 0 10px red; box-shadow: 0 0 8px yellow, inset 0 0 5px rgba(255,0,0,0.3); }
            100% { text-shadow: 0 0 10px red, 0 0 15px orangered, 0 0 20px orangered; box-shadow: 0 0 15px yellow, inset 0 0 10px rgba(255,0,0,0.5); }
        }

        /**********************************************
        *      NEW STYLES START HERE (ATUALIZAÃ‡ÃƒO)   *
        ***********************************************/

        .attribute-dice-icon {
            cursor: pointer;
            margin-left: 8px;
            display: inline-block;
            transition: transform 0.2s;
            font-size: 1rem;
            user-select: none;
        }

        .attribute-dice-icon:hover {
            transform: scale(1.2);
        }

        .attribute-dice-icon.selected {
            animation: glow-yellow 1s infinite alternate;
        }

        @keyframes glow-yellow {
            from {
                text-shadow: 0 0 5px #ffd700, 0 0 10px #ffd700, 0 0 15px #ff8c00;
            }
            to {
                text-shadow: 0 0 10px #ffd700, 0 0 20px #ffae42, 0 0 25px #ff8c00;
                transform: scale(1.1);
            }
        }

        #notification .final-sum-result {
            font-size: 2.5em; /* Significantly larger */
            font-weight: bold;
            display: inline-block; /* Needed for animation */
            animation: rgb-flicker 0.5s infinite;
        }

        @keyframes rgb-flicker {
            0%   { color: red; text-shadow: 0 0 5px red; }
            25%  { color: lime; text-shadow: 0 0 5px lime;}
            50%  { color: blue; text-shadow: 0 0 5px blue;}
            75%  { color: yellow; text-shadow: 0 0 5px yellow;}
            100% { color: magenta; text-shadow: 0 0 5px magenta;}
        }

        .input-com-botoes {
            display: flex;
            align-items: center;
            gap: 5px;
            width: 100%;
        }

        .input-com-botoes input[type="number"] {
            flex-grow: 1;
            margin-bottom: 0; /* Override default margin */
            text-align: center;
            -moz-appearance: textfield; /* Remove arrows in Firefox */
        }
        .input-com-botoes input[type="number"]::-webkit-outer-spin-button,
        .input-com-botoes input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none; /* Remove arrows in Chrome/Safari */
            margin: 0;
        }


        .botao-atributo-stepper {
            flex-shrink: 0;
            background-color: #d2b48c;
            color: #3a2800;
            border: 1px solid var(--cor-borda-secao, #b8860b);
            border-radius: 50%;
            width: 32px;
            height: 32px;
            font-size: 1.3rem;
            line-height: 1;
            font-weight: bold;
            cursor: pointer;
            padding: 0;
            margin:0;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s, transform 0.1s;
        }

        .botao-atributo-stepper:hover {
            background-color: #a0522d;
            color: #fff;
        }
        .botao-atributo-stepper:active {
            transform: scale(0.9);
        }

        body.dark-mode .botao-atributo-stepper {
            background-color: #4a3c2a;
            color: #f0e6d2;
            border-color: #6b5230;
        }
        body.dark-mode .botao-atributo-stepper:hover {
            background-color: #777;
        }

        .atributo {
             display: flex;
             align-items: center;
             gap: 10px;
        }

        /* Adjust label for better alignment */
        .atributo > label {
            flex-shrink: 0;
            margin-bottom: 0; /* Remove margin-bottom from label inside .atributo */
        }


        /**********************************************
        *      NEW THEME STYLES START HERE            *
        ***********************************************/

        /* --- Animations --- */
        @keyframes futuristic-glow {
            from { text-shadow: 0 0 4px #fff, 0 0 8px #fff, 0 0 12px #00aaff, 0 0 16px #00aaff; }
            to { text-shadow: 0 0 8px #fff, 0 0 12px #00aaff, 0 0 16px #00aaff, 0 0 20px #00aaff; }
        }
        @keyframes fire-flicker-shadow {
            0%,100% { text-shadow: 0 0 4px #fff, 0 0 10px #ff0, 0 0 20px #f80; }
            50% { text-shadow: 0 0 6px #fff, 0 0 15px #ff0, 0 0 25px #f60; }
        }
        @keyframes fire-flicker-border {
            0%,100% { border-color: #f80; box-shadow: 0 0 10px #f80; }
            50% { border-color: #ff0; box-shadow: 0 0 20px #ff0; }
        }
        @keyframes water-flow {
            0%{background-position:0% 50%}
            50%{background-position:100% 50%}
            100%{background-position:0% 50%}
        }
        @keyframes air-drift {
            0% { transform: translateX(0); opacity: 0.7; }
            50% { transform: translateX(5px); opacity: 1; }
            100% { transform: translateX(0); opacity: 0.7; }
        }
        @keyframes earth-rumble-shadow {
             0%, 100% { text-shadow: 1px 1px 2px #3d2b1f; }
             50% { text-shadow: -1px -1px 2px #3d2b1f; }
        }

        /* --- Futuristic Theme --- */
        .theme-futurista {
            font-family: 'Orbitron', sans-serif !important;
            background: #05080d url('data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"%3E%3Cg fill="%230a142e" fill-opacity="0.4"%3E%3Crect x="0" y="0" width="100" height="1"/%3E%3Crect x="0" y="0" width="1" height="100"/%3E%3C/g%3E%3C/svg%3E') !important;
            color: #00e5ff;
        }
        .theme-futurista #ficha-container {
            background-color: rgba(1, 4, 15, 0.85);
            border: 2px solid #00aaff;
            border-radius: 4px;
            box-shadow: 0 0 25px rgba(0, 170, 255, 0.6), inset 0 0 15px rgba(0, 170, 255, 0.4);
        }
        .theme-futurista h1#nome-personagem-titulo { font-family: 'Orbitron', sans-serif !important; color: #ffffff; animation: futuristic-glow 1.5s infinite alternate; }
        .theme-futurista section {
            background-color: rgba(10, 25, 50, 0.7);
            border-color: #0077cc;
            border-style: solid;
            box-shadow: inset 0 0 8px rgba(0, 120, 200, 0.5);
        }
        .theme-futurista section h2, .theme-futurista .atributo-destaque label { font-family: 'Orbitron', sans-serif !important; color: #00e5ff; }
        .theme-futurista .botao, .theme-futurista button {
            background-color: transparent; border: 2px solid #00aaff; color: #00e5ff;
            text-shadow: 0 0 5px #00e5ff; border-radius: 4px;
        }
        .theme-futurista .botao:hover, .theme-futurista button:hover { background-color: rgba(0, 170, 255, 0.2); transform: scale(1.05); }
        .theme-futurista input, .theme-futurista textarea, .theme-futurista select {
            background-color: #0a1020; color: #00e5ff; border: 1px solid #0077cc;
        }
        .theme-futurista #dice-roll { background-color: #0a1020; color: #00e5ff; border-color: #00aaff; box-shadow: 0 0 10px #00aaff; }

        /* --- Elemental Fogo Theme --- */
        .theme-elemental-fogo { background-color: #2b0c00 !important; }
        .theme-elemental-fogo #ficha-container {
            background-color: rgba(50, 0, 0, 0.7);
            border: 2px solid #ff4500;
            box-shadow: 0 0 30px #ff4500, inset 0 0 20px #8b0000;
            animation: fire-flicker-border 3s infinite linear;
        }
        .theme-elemental-fogo h1, .theme-elemental-fogo h2, .theme-elemental-fogo .atributo-destaque label { color: #ffd700; animation: fire-flicker-shadow 2s infinite alternate; }
        .theme-elemental-fogo section { background-color: rgba(60, 10, 0, 0.7); border-color: #f80; }
        .theme-elemental-fogo .botao, .theme-elemental-fogo button { background: #c04000; border: 1px solid #ff4500; color: #fff; }
        .theme-elemental-fogo input, .theme-elemental-fogo textarea { background-color: #4a1c00; border-color: #c04000; color: #ffebcd; }
        .theme-elemental-fogo #dice-roll {
             background: radial-gradient(circle, #ffcc00 0%, #ff4500 100%); color: #401000;
             border: 2px solid #f80; text-shadow: 0 0 5px #fff; animation: fire-flicker-border 2s infinite alternate;
        }

        /* --- Elemental Agua Theme --- */
        .theme-elemental-agua { background-color: #0b2c3c !important; color: #e0f7fa; }
        .theme-elemental-agua #ficha-container {
            background: linear-gradient(135deg, rgba(20, 80, 120, 0.8), rgba(5, 40, 60, 0.8));
            background-size: 200% 200%;
            border: 2px solid #33cccc;
            border-radius: 20px;
            box-shadow: 0 0 25px #33cccc, inset 0 0 15px rgba(51, 204, 204, 0.4);
            animation: water-flow 8s ease infinite;
        }
        .theme-elemental-agua section { border-radius: 15px; background-color: rgba(10, 50, 80, 0.7); border-color: #17a2b8; }
        .theme-elemental-agua h1, .theme-elemental-agua h2, .theme-elemental-agua .atributo-destaque label { color: #b2ebf2; text-shadow: 0 0 8px #fff; }
        .theme-elemental-agua .botao, .theme-elemental-agua button { background-color: #007b8a; border-radius: 50px; border: 1px solid #17a2b8; }
        .theme-elemental-agua input, .theme-elemental-agua textarea { background-color: #0f3f54; border-color: #17a2b8; border-radius: 10px; color: #e0f7fa; }
        .theme-elemental-agua #dice-roll {
             background: radial-gradient(circle, #b2ebf2, #17a2b8); color: #0b2c3c;
             border-radius: 50%; border: 2px solid #33cccc; box-shadow: 0 0 10px #33cccc, inset 0 0 8px #fff;
        }

        /* --- Elemental Ar Theme --- */
        .theme-elemental-ar { background-color: #e8f7fe !important; color: #2c3e50; }
        .theme-elemental-ar #ficha-container {
            background-color: rgba(255, 255, 255, 0.7);
            border: 2px solid #add8e6;
            box-shadow: 0 0 30px rgba(173, 216, 230, 0.7); backdrop-filter: blur(3px);
        }
        .theme-elemental-ar section { background-color: rgba(240, 248, 255, 0.8); border-color: #cce7ff; border-style: dashed; animation: air-drift 10s infinite alternate; }
        .theme-elemental-ar h1, .theme-elemental-ar h2, .theme-elemental-ar .atributo-destaque label { color: #3498db; }
        .theme-elemental-ar .botao, .theme-elemental-ar button { background-color: #a7d7ec; color: #2c3e50; border: none; text-shadow: none; }
        .theme-elemental-ar input, .theme-elemental-ar textarea { background-color: #f0f8ff; border-color: #a7d7ec; }
        .theme-elemental-ar #dice-roll {
            background: #fff; color: #3498db; border-color: #a7d7ec;
            box-shadow: 0 0 15px #a7d7ec; opacity: 0.9;
        }

        /* --- Elemental Terra Theme --- */
        .theme-elemental-terra { background-color: #3e2e21 !important; }
        .theme-elemental-terra #ficha-container {
            background-color: rgba(139, 69, 19, 0.7);
            border-image: url('data:image/svg+xml,%3Csvg width="100" height="100" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"%3E%3Cpath d="M7.7,64.4c2.9-2.3,4.3-5.5,4.3-8.8c0-3.9-1.9-7.5-5.2-9.7c-2.3-1.6-4.9-2.4-7.8-2.4c-8,0-14.4,6.5-14.4,14.4 c0,8,6.5,14.4,14.4,14.4c1.1,0,2.2-0.1,3.3-0.4c0.9,1.7,2.2,3.3,4,4.6c2.9,2.2,6.4,3.3,10.2,3.3c3.2,0,6.2-0.8,8.8-2.5 c-3.3-3-5-7.1-5-11.4C20.4,70.5,15.1,65.2,7.7,64.4z" fill="%23654321"/%3E%3C/svg%3E') 30 stretch;
            border-width: 15px;
            border-style: solid;
        }
        .theme-elemental-terra section { background-color: rgba(111, 60, 20, 0.7); border: 2px solid #5d4037; }
        .theme-elemental-terra h1, .theme-elemental-terra h2 { color: #f0e2d2; text-shadow: 2px 2px 3px #3e2e21; font-weight: bold; animation: earth-rumble-shadow 4s infinite; }
        .theme-elemental-terra .atributo-destaque label { color: #f0e2d2; }
        .theme-elemental-terra .botao, .theme-elemental-terra button { background-color: #5d4037; color: #f0e2d2; text-shadow: 1px 1px 2px #000; font-weight: bold; border: 1px solid #3e2e21;}
        .theme-elemental-terra input, .theme-elemental-terra textarea { background-color: #d7ccc8; color: #3e2e21; border-color: #5d4037; font-weight: bold; }
        .theme-elemental-terra #dice-roll {
            background-image: url('data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="100" height="100"%3E%3Cdefs%3E%3Cpattern id="p" width="100" height="100" patternUnits="userSpaceOnUse"%3E%3Cpath id="a" data-color="fill" fill="%235a4433" d="M11 0a5 5 0 0 0-5 5v3l-5 5v3l-1 1v5l1 1v2l-1 1v4l1 1v2l-1 1v5l1 1v2l-1 1v4l1 1v3l5 5h3l5-5h2l-1-1h4l1 1h2l-1-1h4l1 1h2l-1-1h4l1 1h2l-1-1h4l1 1h2l5-5h3l5 5h3l-5-5v-3l5-5v-3l1-1v-5l-1-1v-2l1-1v-4l-1-1v-2l1-1v-5l-1-1v-2l1-1v-4l-1-1v-2l-1-1v-5l-1-1v-3l-5-5h-3l-5 5h-2l1 1h-4l-1-1h-2l1 1h-4l-1-1h-2l1 1h-4l-1-1h-2l-5 5h-3z"/%3E%3C/pattern%3E%3C/defs%3E%3Crect fill="url(%23p)" width="100%" height="100%"/%3E%3C/svg%3E');
            color: #f0e2d2; border-color: #3e2e21; border-width: 3px; font-weight: bold; text-shadow: 2px 2px 2px #000;
        }

        /**********************************************
        *          NEW THEME STYLES END HERE          *
        ***********************************************/

        @media (max-width: 768px) {
            body { padding: 10px; }
            #ficha-container { padding: 15px; }
            h1#nome-personagem-titulo { font-size: 2rem; }
            section h2 { font-size: 1.2rem; }
            input, textarea, select { font-size: 0.9rem; }
            .atributos-container, .vida-magia-vigor { flex-direction: column; }
            .atributos-coluna, .atributos-coluna-destaque, .atributo-container { width: 100%; }
            .botoes-container, .theme-buttons-container { flex-wrap: wrap; }

             #dice-container { width: auto; }
            #dice-roll { width: 80px; height: 80px; font-size: 2rem; }
            #change-dice-type-btn {width: 45px; font-size: 0.8rem;}
            #dice-options-menu { top: 35px; }

            #anotacoes-btn { padding: 8px 10px; font-size: 0.9rem;}
            #anotacoes-textarea { left: 40px; width: calc(100vw - 60px); height: 300px; }

            #dice-history-trigger {
                padding: 8px 10px; font-size: 0.9rem;
                top: calc(50% + 120px);
            }
            #dice-history-panel {
                right: 40px; width: calc(100vw - 60px); max-height: 300px;
                top: calc(50% + 120px);
            }
            #customizacao-modal .modal-content {
                 width: 90%;
            }
        }
        #raca-opcoes-modal .modal-content button:nth-child(2) { margin-top: 10px; }

    </style>
</head>
<body class="">
    <div id="fichas-sidebar">
        <div id="add-ficha-btn"><span>+ Fichas</span></div>
    </div>
    <div id="ficha-container">
        <h1 id="nome-personagem-titulo">Ficha de Personagem</h1>
        <div id="game-master-message">VocÃª virou o Game Master</div>
        <div id="character-image-container" onclick="document.getElementById('character-image-input').click()">
            <img id="character-image" alt="Imagem do Personagem">
            <input type="file" id="character-image-input" accept="image/*" style="display:none">
        </div>
        <div id="dice-container">
            <label>Role seu dado:</label>
            <div class="dice-roll-area">
                <div id="dice-roll">-</div>
                <button id="change-dice-type-btn" class="botao icon-btn" title="Mudar Tipo de Dado">D20</button>
            </div>
            <div id="dice-options-menu">
                <button class="dice-option-btn" data-dice-max="20">D20</button>
                <button class="dice-option-btn" data-dice-max="12">D12</button>
                <button class="dice-option-btn" data-dice-max="6">D6</button>
                <button class="dice-option-btn" data-dice-max="4">D4</button>
                <button class="dice-option-btn" data-dice-max="3">D3</button>
            </div>
            <div id="dice-result"></div>
        </div>
        <div id="ficha-content">
            <section id="informacoes-basicas">
                <h2>InformaÃ§Ãµes BÃ¡sicas <span class="collapse-icon">â–¼</span></h2>
                <div class="section-content">
                    <label for="nome-personagem">Nome do Personagem:</label>
                    <input type="text" id="nome-personagem" placeholder="Digite o nome do seu personagem">
                    <label for="descricao-personagem">DescriÃ§Ã£o do Personagem:</label>
                    <textarea id="descricao-personagem" placeholder="Digite a descriÃ§Ã£o do seu personagem"></textarea>
                </div>
            </section>
            <section id="recursos">
                <h2>Recursos <span class="collapse-icon">â–¼</span></h2>
                <div class="section-content">
                    <div class="vida-magia-vigor">
                        <div class="atributo-container vida">
                            <h3>Vida</h3>
                            <div class="valor-total medieval-box">
                                <span>Vida Total: </span>
                                <span id="vida-total">50</span> <span class="gm-edit-icon" data-target-id="vida-total" data-label="Vida Total">âœï¸</span>
                            </div>
                            <div class="valor-atual medieval-box">
                                <span>Vida Atual: </span>
                                <button id="btn-diminuir-vida" title="Diminuir Vida">â–¼</button>
                                <input type="number" id="vida-atual-input" class="recurso-atual-input" value="50" min="0">
                                <button id="btn-aumentar-vida" title="Aumentar Vida">â–²</button>
                            </div>
                            <div class="regeneracao">
                                <span>RegeneraÃ§Ã£o por turno: <span id="regeneracao-vida">0</span> (parado)</span>
                            </div>
                        </div>
                        <div class="atributo-container magia">
                            <h3>Magia</h3>
                            <div class="valor-total medieval-box">
                                <span>Magia Total: </span>
                                <span id="magia-total">20</span> <span class="gm-edit-icon" data-target-id="magia-total" data-label="Magia Total">âœï¸</span>
                            </div>
                            <div class="valor-atual medieval-box">
                                <span>Magia Atual: </span>
                                <button id="btn-diminuir-magia" title="Diminuir Magia">â–¼</button>
                                <input type="number" id="magia-atual-input" class="recurso-atual-input" value="20" min="0">
                                <button id="btn-aumentar-magia" title="Aumentar Magia">â–²</button>
                            </div>
                            <div class="regeneracao">
                                <span>RegeneraÃ§Ã£o por turno: <span id="regeneracao-magia">0</span></span>
                            </div>
                        </div>
                        <div class="atributo-container vigor">
                            <h3>Vigor</h3>
                            <div class="valor-total medieval-box">
                                <span>Vigor Total: </span>
                                <span id="vigor-total">10</span> <span class="gm-edit-icon" data-target-id="vigor-total" data-label="Vigor Total">âœï¸</span>
                            </div>
                            <div class="valor-atual medieval-box">
                                <span>Vigor Atual: </span>
                                <button id="btn-diminuir-vigor" title="Diminuir Vigor">â–¼</button>
                                <input type="number" id="vigor-atual-input" class="recurso-atual-input" value="10" min="0" step="0.1">
                                <button id="btn-aumentar-vigor" title="Aumentar Vigor">â–²</button>
                            </div>
                            <div class="regeneracao">
                                <span>RegeneraÃ§Ã£o por turno: <span id="regeneracao-vigor">0</span> (parado)</span>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
            <section id="atributos">
                <h2>Atributos <span class="collapse-icon">â–¼</span></h2>
                <div class="section-content">
                    <div class="atributos-container">
                        <div class="atributos-coluna">
                            <div class="atributo">
                                <label for="forca" title="ForÃ§a: Afeta dano fÃ­sico corpo a corpo, capacidade de carga e resistÃªncia a dano fÃ­sico (RDF). BÃ´nus em alguns testes de atletismo.">ForÃ§a:</label>
                                <div class="input-com-botoes">
                                    <button class="botao-atributo-stepper" data-target="forca" data-step="-1" title="Diminuir ForÃ§a">â–¼</button>
                                    <input type="number" id="forca" value="0" min="0">
                                    <button class="botao-atributo-stepper" data-target="forca" data-step="1" title="Aumentar ForÃ§a">â–²</button>
                                </div>
                                <span class="attribute-dice-icon" data-attribute-source="forca" title="Rolar com ForÃ§a">ðŸŽ²</span>
                                <span class="gm-edit-icon" data-target-id="forca" data-label="ForÃ§a">âœï¸</span>
                            </div>
                            <div class="atributo">
                                <label for="destreza" title="Destreza: Afeta precisÃ£o de ataques (Acerto), chance de desviar de ataques (Esquiva com Agilidade) e dano com armas de destreza (ex: arcos, adagas).">Destreza:</label>
                                <div class="input-com-botoes">
                                    <button class="botao-atributo-stepper" data-target="destreza" data-step="-1" title="Diminuir Destreza">â–¼</button>
                                    <input type="number" id="destreza" value="0" min="0">
                                    <button class="botao-atributo-stepper" data-target="destreza" data-step="1" title="Aumentar Destreza">â–²</button>
                                </div>
                                <span class="attribute-dice-icon" data-attribute-source="destreza" title="Rolar com Destreza">ðŸŽ²</span>
                                <span class="gm-edit-icon" data-target-id="destreza" data-label="Destreza">âœï¸</span>
                            </div>
                            <div class="atributo">
                                <label for="agilidade" title="Agilidade: Afeta chance de desviar de ataques (Esquiva), iniciativa em combate e testes de acrobacia, furtividade.">Agilidade:</label>
                                <div class="input-com-botoes">
                                    <button class="botao-atributo-stepper" data-target="agilidade" data-step="-1" title="Diminuir Agilidade">â–¼</button>
                                    <input type="number" id="agilidade" value="0" min="0">
                                    <button class="botao-atributo-stepper" data-target="agilidade" data-step="1" title="Aumentar Agilidade">â–²</button>
                                </div>
                                <span class="attribute-dice-icon" data-attribute-source="agilidade" title="Rolar com Agilidade">ðŸŽ²</span>
                                <span class="gm-edit-icon" data-target-id="agilidade" data-label="Agilidade">âœï¸</span>
                            </div>
                            <div class="atributo">
                                <label for="constituicao" title="ConstituiÃ§Ã£o: Define seus Pontos de Vida (PV) base, Pontos de Magia (PM) base, Pontos de Vigor (PVg) base e regeneraÃ§Ã£o desses recursos.">ConstituiÃ§Ã£o:</label>
                                <div class="input-com-botoes">
                                    <button class="botao-atributo-stepper" data-target="constituicao" data-step="-1" title="Diminuir ConstituiÃ§Ã£o">â–¼</button>
                                    <input type="number" id="constituicao" value="0" min="0">
                                    <button class="botao-atributo-stepper" data-target="constituicao" data-step="1" title="Aumentar ConstituiÃ§Ã£o">â–²</button>
                                </div>
                                <span class="attribute-dice-icon" data-attribute-source="constituicao" title="Rolar com ConstituiÃ§Ã£o">ðŸŽ²</span>
                                <span class="gm-edit-icon" data-target-id="constituicao" data-label="ConstituiÃ§Ã£o">âœï¸</span>
                            </div>
                            <div class="atributo">
                                <label for="inteligencia" title="InteligÃªncia: Afeta dano mÃ¡gico, resistÃªncia a dano mÃ¡gico (RDM), quantidade de perÃ­cias conhecidas e testes de conhecimento.">InteligÃªncia:</label>
                                <div class="input-com-botoes">
                                    <button class="botao-atributo-stepper" data-target="inteligencia" data-step="-1" title="Diminuir InteligÃªncia">â–¼</button>
                                    <input type="number" id="inteligencia" value="0" min="0">
                                    <button class="botao-atributo-stepper" data-target="inteligencia" data-step="1" title="Aumentar InteligÃªncia">â–²</button>
                                </div>
                                <span class="attribute-dice-icon" data-attribute-source="inteligencia" title="Rolar com InteligÃªncia">ðŸŽ²</span>
                                <span class="gm-edit-icon" data-target-id="inteligencia" data-label="InteligÃªncia">âœï¸</span>
                            </div>
                        </div>
                        <div class="atributos-coluna-destaque">
                            <div class="atributo-destaque">
                                <label title="ForÃ§a + (Destreza / 5) + BÃ´nus de Armas. Dano fÃ­sico.">Ataque:</label>
                                <span><span id="ataque">0</span><span class="attribute-dice-icon" data-attribute-source="ataque" title="Rolar com Ataque">ðŸŽ²</span></span>
                                <span class="gm-edit-icon" data-target-id="ataque" data-label="Ataque">âœï¸</span>
                            </div>
                            <div class="atributo-destaque">
                                <label title="InteligÃªncia + BÃ´nus de Armas MÃ¡gicas. Dano mÃ¡gico.">Ataque MÃ¡gico:</label>
                                <span><span id="ataque-magico">0</span><span class="attribute-dice-icon" data-attribute-source="ataque-magico" title="Rolar com Ataque MÃ¡gico">ðŸŽ²</span></span>
                                <span class="gm-edit-icon" data-target-id="ataque-magico" data-label="Ataque MÃ¡gico">âœï¸</span>
                            </div>
                            <div class="atributo-destaque">
                                <label title="(Destreza / 3) + (Agilidade / 10). Chance de acertar ataques.">Acerto:</label>
                                <span><span id="acerto">0</span><span class="attribute-dice-icon" data-attribute-source="acerto" title="Rolar com Acerto">ðŸŽ²</span></span>
                                <span class="gm-edit-icon" data-target-id="acerto" data-label="Acerto">âœï¸</span>
                            </div>
                            <div class="atributo-destaque">
                                <label title="(Agilidade / 3). Chance de evitar ataques.">Esquiva:</label>
                                <span><span id="esquiva">0</span><span class="attribute-dice-icon" data-attribute-source="esquiva" title="Rolar com Esquiva">ðŸŽ²</span></span>
                                <span class="gm-edit-icon" data-target-id="esquiva" data-label="Esquiva">âœï¸</span>
                            </div>
                            <div class="atributo-destaque">
                                <label title="(ForÃ§a / 5). ReduÃ§Ã£o de dano fÃ­sico.">RDF:</label>
                                <span><span id="rdf">0</span><span class="attribute-dice-icon" data-attribute-source="rdf" title="Rolar com RDF">ðŸŽ²</span></span>
                                <span class="gm-edit-icon" data-target-id="rdf" data-label="RDF">âœï¸</span>
                            </div>
                            <div class="atributo-destaque">
                                <label title="(InteligÃªncia / 5). ReduÃ§Ã£o de dano mÃ¡gico.">RDM:</label>
                                <span><span id="rdm">0</span><span class="attribute-dice-icon" data-attribute-source="rdm" title="Rolar com RDM">ðŸŽ²</span></span>
                                <span class="gm-edit-icon" data-target-id="rdm" data-label="RDM">âœï¸</span>
                            </div>
                        </div>
                    </div>
                    <div style="text-align: center; margin-top: 15px;">
                        <button id="salvar-atributos-btn" class="botao" style="display: none; background-color: #006400;">Salvar Atributos MÃ­nimos</button>
                    </div>
                </div>
            </section>
            <section id="combate">
                <h2>Combate <span class="collapse-icon">â–¼</span></h2>
                <div class="section-content">
                    <div class="armamento-container">
                        <div class="armamento-coluna">
                            <label>Armamento MÃ£o Direita:</label>
                            <div class="flex items-center mb-2">
                                <input type="text" id="arma-direita-nome" placeholder="Nome da Arma" class="mr-2">
                                <span>Ataque </span>
                                <input type="number" id="arma-direita-ataque" value="0" class="w-20 mr-2">
                                <span>Ataque MÃ¡gico </span>
                                <input type="number" id="arma-direita-ataque-magico" value="0" class="w-20">
                            </div>
                        </div>
                        <div class="armamento-coluna">
                            <label>Armamento MÃ£o Esquerda:</label>
                            <div class="flex items-center">
                                <input type="text" id="arma-esquerda-nome" placeholder="Nome da Arma" class="mr-2">
                                <span>Ataque </span>
                                <input type="number" id="arma-esquerda-ataque" value="0" class="w-20 mr-2">
                                <span>Ataque MÃ¡gico </span>
                                <input type="number" id="arma-esquerda-ataque-magico" value="0" class="w-20">
                            </div>
                        </div>
                    </div>
                </div>
            </section>
            <section id="inventario-habilidades">
                <h2>InventÃ¡rio e Habilidades <span class="collapse-icon">â–¼</span></h2>
                <div class="section-content">
                    <div class="flex gap-20">
                        <div style="width:50%">
                            <label>InventÃ¡rio (Peso Total: <span id="peso-total">0</span> kg / <span id="capacidade-carga">5</span> kg <span class="gm-edit-icon" data-target-id="capacidade-carga" data-label="Capacidade Carga">âœï¸</span>):</label>
                            <div id="inventario-slots">
                                <div class="inventory-slot"><input type="text" placeholder="Item 1" class="inventory-item"><input type="number" min="0" value="0" class="inventory-weight" title="Peso em kg"></div>
                                <div class="inventory-slot"><input type="text" placeholder="Item 2" class="inventory-item"><input type="number" min="0" value="0" class="inventory-weight"></div>
                                <div class="inventory-slot"><input type="text" placeholder="Item 3" class="inventory-item"><input type="number" min="0" value="0" class="inventory-weight"></div>
                                <div class="inventory-slot"><input type="text" placeholder="Item 4" class="inventory-item"><input type="number" min="0" value="0" class="inventory-weight"></div>
                                <div class="inventory-slot"><input type="text" placeholder="Item 5" class="inventory-item"><input type="number" min="0" value="0" class="inventory-weight"></div>
                                <div class="inventory-slot"><input type="text" placeholder="Item 6" class="inventory-item"><input type="number" min="0" value="0" class="inventory-weight"></div>
                                <div class="inventory-slot"><input type="text" placeholder="Item 7" class="inventory-item"><input type="number" min="0" value="0" class="inventory-weight"></div>
                                <div class="inventory-slot"><input type="text" placeholder="Item 8" class="inventory-item"><input type="number" min="0" value="0" class="inventory-weight"></div>
                                <div class="inventory-slot"><input type="text" placeholder="Item 9" class="inventory-item"><input type="number" min="0" value="0" class="inventory-weight"></div>
                                <div class="inventory-slot"><input type="text" placeholder="Item 10" class="inventory-item"><input type="number" min="0" value="0" class="inventory-weight"></div>
                            </div>
                        </div>
                        <div style="width:50%">
                            <label>Magias e Habilidades:</label>
                            <div id="magias-list" class="magias-container">
                                <input type="text" placeholder="Magia/Habilidade 1" class="magia-nome">
                                <input type="text" placeholder="Magia/Habilidade 2" class="magia-nome">
                                <input type="text" placeholder="Magia/Habilidade 3" class="magia-nome">
                                <input type="text" placeholder="Magia/Habilidade 4" class="magia-nome">
                                <input type="text" placeholder="Magia/Habilidade 5" class="magia-nome">
                                <input type="text" placeholder="Magia/Habilidade 6" class="magia-nome">
                                <input type="text" placeholder="Magia/Habilidade 7" class="magia-nome">
                                <input type="text" placeholder="Magia/Habilidade 8" class="magia-nome">
                                <input type="text" placeholder="Magia/Habilidade 9" class="magia-nome">
                                <input type="text" placeholder="Magia/Habilidade 10" class="magia-nome">
                            </div>
                            <button id="adicionar-magia-btn">Adicionar Magia</button>
                        </div>
                    </div>
                    <div class="mt-4">
                        <label>Vantagens:</label>
                        <div id="vantagens-list-display" class="list-display"></div>
                        <label>Desvantagens:</label>
                        <div id="desvantagens-list-display" class="list-display"></div>
                    </div>
                    <div class="classe-raca-container">
                        <label>Classe:</label>
                        <input type="text" id="classe-nome" placeholder="Nome da Classe">
                        <textarea id="classe-descricao" placeholder="DescriÃ§Ã£o da Classe" class="expandable-textarea"></textarea>
                        <label>RaÃ§a:</label>
                        <span id="raca-nome" onclick="abrirModalRaca()"></span>
                        <textarea id="raca-descricao" placeholder="DescriÃ§Ã£o da RaÃ§a" class="expandable-textarea" readonly></textarea>
                    </div>
                </div>
            </section>
            <section id="locomocao">
                <h2>LocomoÃ§Ã£o <span class="collapse-icon">â–¼</span></h2>
                <div class="section-content">
                    <div class="locomotion-container">
                        <div class="locomotion-item">
                            <label>Velocidade de Corrida (km/h):</label><span>ðŸƒâ€â™‚ï¸</span>
                            <span id="velocidade-corrida">25</span>
                            <span class="attribute-dice-icon" data-attribute-source="velocidade-corrida" title="Rolar com Velocidade de Corrida">ðŸŽ²</span>
                            <span class="gm-edit-icon" data-target-id="velocidade-corrida" data-label="Velocidade Corrida">âœï¸</span>
                        </div>
                        <div class="locomotion-item">
                            <label>Altura do Pulo (m):</label><span>â¬†ï¸</span>
                            <span id="altura-pulo">1</span>
                            <span class="attribute-dice-icon" data-attribute-source="altura-pulo" title="Rolar com Altura do Pulo">ðŸŽ²</span>
                             <span class="gm-edit-icon" data-target-id="altura-pulo" data-label="Altura Pulo">âœï¸</span>
                        </div>
                        <div class="locomotion-item">
                            <label>DistÃ¢ncia do Pulo (m):</label><span>âž¡ï¸</span>
                            <span id="distancia-pulo">3</span>
                            <span class="attribute-dice-icon" data-attribute-source="distancia-pulo" title="Rolar com DistÃ¢ncia do Pulo">ðŸŽ²</span>
                            <span class="gm-edit-icon" data-target-id="distancia-pulo" data-label="DistÃ¢ncia Pulo">âœï¸</span>
                        </div>
                    </div>
                </div>
            </section>
            <section id="status">
                <h2>Status <span class="collapse-icon">â–¼</span></h2>
                <div class="section-content">
                    <div class="flex flex-wrap gap-x-20 gap-y-5">
                        <div class="flex-1 min-w-[200px]">
                            <label for="experiencia">ExperiÃªncia: <span id="xp-lock-icon" class="lock-icon">ðŸ”’</span></label>
                            <div class="input-com-botoes">
                               <button class="botao-atributo-stepper" data-target="experiencia" data-step="-1" title="Diminuir ExperiÃªncia">â–¼</button>
                                <input type="number" id="experiencia" value="0" min="0">
                               <button class="botao-atributo-stepper" data-target="experiencia" data-step="1" title="Aumentar ExperiÃªncia">â–²</button>
                            </div>
                        </div>
                        <div class="flex-1 min-w-[200px]">
                            <label>Pontos de Habilidade (PD):</label>
                            <span id="pontos-habilidade">25</span> <span class="gm-edit-icon" data-target-id="pontos-habilidade" data-label="Pontos Habilidade">âœï¸</span>
                            <label>Pontos de Vantagem (PH):</label>
                            <span id="pontos-vantagem">8</span> <span class="gm-edit-icon" data-target-id="pontos-vantagem" data-label="Pontos Vantagem">âœï¸</span>
                        </div>
                    </div>
                    <div id="nivel-container">
                        <label>NÃ­vel:</label>
                        <span id="nivel">0</span> <span class="gm-edit-icon" data-target-id="nivel" data-label="NÃ­vel">âœï¸</span>
                    </div>
                </div>
            </section>

            <div style="display:flex;justify-content:center;gap:20px;margin-bottom:20px">
                <button id="vantagens-desvantagens-btn" class="botao">Vantagens e Desvantagens</button>
                <button id="racas-btn" class="botao">RaÃ§as ðŸ°</button>
                <button id="classes-btn" class="botao">Classes âš”ï¸</button>
            </div>

            <div class="botoes-container">
                <button id="reset-pontos" class="botao botao-reset">Reiniciar Pontos</button>
                <button id="recomecar" class="botao botao-recomecar">RecomeÃ§ar</button>
                <button id="bloquear-ficha" class="botao botao-bloquear">Bloquear Ficha</button>
                <button id="customizacao-btn" class="botao">CustomizaÃ§Ã£o ðŸŽ¨</button>
                <button id="excluir-ficha" class="botao botao-excluir">Excluir Ficha</button>
                <button id="gm-mode-btn" class="botao">Modo Mestre GM ðŸ‘‘</button>
            </div>

            <div class="theme-buttons-container">
                <button id="lua-btn" class="botao icon-btn" title="Modo Noturno">ðŸŒ™</button>
                <button id="sol-btn" class="botao icon-btn" title="Modo Claro">â˜€ï¸</button>
            </div>
        </div>
    </div>
    <button id="anotacoes-btn">AnotaÃ§Ãµes</button>
    <textarea id="anotacoes-textarea" placeholder="Suas anotaÃ§Ãµes aqui..."></textarea>

    <div id="vantagens-desvantagens-panel">
        <h2>Vantagens e Desvantagens</h2>
        <div>Pontos de Vantagem TemporÃ¡rios: <span id="ph-temp">0</span></div>
        <div id="vantagens-list"></div>
        <div id="desvantagens-list"></div>
        <button id="salvar-vantagens-btn">SALVAR</button>
        <button id="fechar-pagina-btn">Fechar PÃ¡gina</button>
    </div>
    <div id="racas-panel">
        <h2>RaÃ§as</h2>
        <div id="ph-temp-raca-container" style="text-align: center; margin-bottom: 10px;">Pontos de Vantagem TemporÃ¡rios: <span id="ph-temp-raca">0</span></div> <div id="racas-list"></div>
        <button id="salvar-racas-btn">SALVAR</button>
        <button id="fechar-racas-btn">Fechar PÃ¡gina</button>
    </div>
    <div id="classes-panel">
        <h2>Classes</h2>
        <button id="fechar-classes-btn">Fechar PÃ¡gina</button>
    </div>
    <div id="nome-ficha-modal" class="modal">
        <div class="modal-content">
            <h3>DÃª um Nome Ã  Ficha</h3>
            <input type="text" id="nome-ficha-input" placeholder="Nome da ficha" maxlength="20">
            <button class="confirm-btn" onclick="criarNovaFicha()">Confirmar</button>
            <button class="cancel-btn" onclick="fecharModal('nome-ficha-modal')">Cancelar</button>
        </div>
    </div>
    <div id="bloquear-ficha-modal" class="modal">
        <div class="modal-content">
            <h3>Ponha sua Senha de 4 DÃ­gitos</h3>
            <input type="password" id="senha-bloqueio-input" placeholder="Senha (4 dÃ­gitos)" maxlength="4">
            <button class="confirm-btn" onclick="bloquearFicha()">Confirmar</button>
            <button class="cancel-btn" onclick="fecharModal('bloquear-ficha-modal')">Cancelar</button>
        </div>
    </div>
    <div id="password-modal" class="modal">
        <div class="modal-content">
            <h3>Digite sua Senha</h3>
            <input type="password" id="senha-desbloqueio-input" placeholder="Senha (4 dÃ­gitos)" maxlength="4">
            <button class="confirm-btn" onclick="desbloquearFicha()">Confirmar</button>
            <button class="cancel-btn" onclick="cancelarDesbloqueio()">Cancelar</button>
        </div>
    </div>
    <div id="confirmar-compra-modal" class="modal">
        <div class="modal-content">
            <h3>Tem certeza que quer comprar isso?</h3>
            <button class="confirm-btn" id="confirmar-compra-btn">Sim</button>
            <button class="cancel-btn" onclick="fecharModal('confirmar-compra-modal')">NÃ£o</button>
        </div>
    </div>
    <div id="salvar-vantagens-modal" class="modal"> <div class="modal-content">
            <h3 id="salvar-modal-texto">Se salvar, as alteraÃ§Ãµes nÃ£o poderÃ£o ser desfeitas.</h3>
            <button class="confirm-btn" id="confirmar-salvar-btn">OK</button> <button class="cancel-btn" onclick="fecharModal('salvar-vantagens-modal')">Cancelar</button>
        </div>
    </div>
     <!-- New Modal for Confirming Attribute Save -->
    <div id="confirmar-salvar-atributos-modal" class="modal">
        <div class="modal-content">
            <h3 id="confirmar-salvar-atributos-texto">Ao clicar em salvar, as alteraÃ§Ãµes nÃ£o poderÃ£o ser desfeitas.</h3>
            <button class="confirm-btn" id="confirmar-salvar-atributos-ok-btn">OK</button>
            <button class="cancel-btn" onclick="fecharModal('confirmar-salvar-atributos-modal')">Cancelar</button>
        </div>
    </div>
    <div id="senha-gm-modal" class="modal">
        <div class="modal-content">
            <h3 id="senha-gm-titulo">PeÃ§a permissÃ£o ao GM</h3>
            <input type="password" id="senha-gm-input" placeholder="Senha GM">
            <button class="confirm-btn" id="confirmar-senha-gm-btn">Confirmar</button>
            <button class="cancel-btn" onclick="fecharModal('senha-gm-modal')">Cancelar</button>
        </div>
    </div>
    <div id="raca-opcoes-modal" class="modal">
        <div class="modal-content">
            <h3>O que vocÃª deseja fazer?</h3>
            <button class="confirm-btn" onclick="excluirRacaSelecionadaModal()">Excluir RaÃ§a</button>
            <button class="confirm-btn" onclick="editarRacaSelecionadaModal()" style="margin-top: 10px;">Editar RaÃ§a</button>
            <button class="cancel-btn" onclick="fecharModal('raca-opcoes-modal')">Cancelar</button>
        </div>
    </div>
    <div id="editar-raca-modal" class="modal">
        <div class="modal-content">
            <h3>Editar RaÃ§a</h3>
            <label for="editar-raca-nome">Nome:</label>
            <input type="text" id="editar-raca-nome">
            <label for="editar-raca-descricao">DescriÃ§Ã£o:</label>
            <textarea id="editar-raca-descricao"></textarea>
            <button class="confirm-btn" onclick="salvarEdicaoRaca()">Salvar</button>
            <button class="cancel-btn" onclick="fecharModal('editar-raca-modal')">Cancelar</button>
        </div>
    </div>
    <div id="notification"></div>

    <!-- MODAL DE CUSTOMIZAÃ‡ÃƒO GERAL -->
    <div id="customizacao-modal" class="modal">
        <div class="modal-content">
            <h3>Painel de CustomizaÃ§Ã£o</h3>

             <fieldset>
                <legend>Modelo de Ficha</legend>
                <div class="input-group">
                    <label for="theme-selector">Tema da Ficha:</label>
                    <select id="theme-selector">
                        <option value="theme-medieval">Medieval (PadrÃ£o)</option>
                        <option value="theme-futurista">Futurista</option>
                        <option value="theme-elemental">Elemental</option>
                    </select>
                </div>
                <div class="input-group" id="elemental-theme-group" style="display: none;">
                    <label for="elemental-theme-selector">Elemento:</label>
                    <select id="elemental-theme-selector">
                        <option value="fogo">Fogo</option>
                        <option value="agua">Ãgua</option>
                        <option value="ar">Ar</option>
                        <option value="terra">Terra</option>
                    </select>
                </div>
                <button class="confirm-btn" onclick="prepararAplicarModeloFicha()" style="width:100%;">Aplicar Modelo</button>
            </fieldset>

            <fieldset>
                <legend>AparÃªncia da PÃ¡gina e Ficha</legend>
                <div class="input-group">
                    <label for="background-color-input">Cor de Fundo (PÃ¡gina):</label>
                    <input type="color" id="background-color-input" value="#f0e6d2">
                </div>
                <div class="input-group">
                    <label for="ficha-internal-background-color-input">Cor de Fundo Base (Interior da Ficha e SeÃ§Ãµes):</label>
                    <input type="color" id="ficha-internal-background-color-input" value="#f0e6d2">
                </div>
                <div class="input-group">
                    <label for="font-selector">Fonte Principal da Ficha:</label>
                    <select id="font-selector" title="Fonte Principal" style="width: 100%; background-color: #f0e6d2; color:black; border:1px solid #b8860b; padding: 10px; border-radius: 6px; ">
                        <option value="'Inter', sans-serif">PadrÃ£o (Inter)</option>
                        <option value="'MedievalSharp', cursive">Medieval</option>
                         <option value="'Orbitron', sans-serif">Futurista (Orbitron)</option>
                        <option value="'Times New Roman', Times, serif">Times New Roman</option>
                        <option value="'Arial', Helvetica, sans-serif">Arial</option>
                        <option value="'Courier New', Courier, monospace">Courier New</option>
                        <option value="'Georgia', serif">Georgia</option>
                        <option value="'Verdana', Geneva, sans-serif">Verdana</option>
                    </select>
                </div>
            </fieldset>

            <fieldset>
                <legend>TransparÃªncia da Ficha</legend>
                <div class="input-group">
                    <label for="ficha-transparency-slider">NÃ­vel de Opacidade (0% = Totalmente Transparente, 100% = Totalmente Opaco): <span id="ficha-transparency-value">100</span>%</label>
                    <input type="range" id="ficha-transparency-slider" min="0" max="100" value="100">
                </div>
                <button class="cancel-btn" onclick="restaurarOpacidadePadraoFicha()" style="width:100%;">Restaurar Opacidade PadrÃ£o (100%)</button>
            </fieldset>

            <fieldset>
                <legend>Sombra (Interna)</legend>
                <div class="input-group">
                    <label for="shadow-color-ficha">Cor da Sombra (Ficha/SeÃ§Ãµes - Interno):</label>
                    <input type="color" id="shadow-color-ficha" value="#000000">
                </div>
                <div class="input-group">
                    <label for="shadow-intensity-ficha-slider">Intensidade da Sombra (Ficha/SeÃ§Ãµes - Interno): <span id="shadow-intensity-ficha-value">0</span>%</label>
                    <input type="range" id="shadow-intensity-ficha-slider" min="0" max="100" value="0">
                </div>
                <button class="cancel-btn" onclick="restaurarSombraPadrao()" style="width:100%; margin-top: 10px;">Restaurar Sombra PadrÃ£o</button>
            </fieldset>

            <fieldset>
                <legend>Plano de Fundo da Ficha (Imagem de fundo apenas da PÃ¡gina)</legend>
                <div class="input-group">
                    <label for="background-image-input">Selecionar Imagem:</label>
                    <input type="file" id="background-image-input" accept="image/*">
                </div>
                <div class="radio-group input-group">
                    <label><input type="radio" name="background-size" value="cover" checked> Preencher Tela (Fixo)</label>
                    <label><input type="radio" name="background-size" value="100% 100%"> Estender (RolÃ¡vel)</label>
                    <label><input type="radio" name="background-size" value="auto"> Tamanho Normal (RolÃ¡vel)</label>
                </div>
                <button class="confirm-btn" onclick="aplicarPlanoDeFundo()">Aplicar Imagem de Fundo da PÃ¡gina</button>
                <button class="cancel-btn" onclick="excluirPlanoDeFundo()">Excluir Imagem de Fundo da PÃ¡gina</button>
            </fieldset>

            <fieldset>
                <legend>Estilos das SeÃ§Ãµes da Ficha</legend>
                <div class="input-group">
                    <label for="cor-borda-secao-input">Cor da Borda das SeÃ§Ãµes:</label>
                    <input type="color" id="cor-borda-secao-input" value="#b8860b">
                </div>
                <div class="input-group">
                    <label for="estilo-borda-secao-select">Estilo da Borda das SeÃ§Ãµes:</label>
                    <select id="estilo-borda-secao-select">
                        <option value="solid">SÃ³lida</option>
                        <option value="dashed">Tracejada</option>
                        <option value="dotted">Pontilhada</option>
                        <option value="double">Dupla</option>
                        <option value="groove">Groove</option>
                        <option value="ridge">Ridge</option>
                    </select>
                </div>
                 <div class="input-group">
                    <label for="largura-borda-secao-input">Largura da Borda (px):</label>
                    <input type="number" id="largura-borda-secao-input" min="0" max="10" value="2">
                </div>
                <button class="confirm-btn" onclick="aplicarEstilosFicha()">Aplicar Estilos de SeÃ§Ã£o</button>
            </fieldset>

            <fieldset>
                <legend>CustomizaÃ§Ã£o do Dado</legend>
                <div class="input-group">
                    <label for="dice-color-input">Cor de Fundo do Dado:</label>
                    <input type="color" id="dice-color-input" value="#f0e6d2">
                </div>
                 <div class="input-group">
                    <label for="dice-number-color-input">Cor do NÃºmero no Dado:</label>
                    <input type="color" id="dice-number-color-input" value="#000000">
                </div>
                <div class="input-group custom-dice-texture-controls">
                    <div style="flex-grow: 1;">
                        <label for="dice-texture-input">Textura do Dado (Imagem 100x100px):</label>
                        <input type="file" id="dice-texture-input" accept="image/*">
                    </div>
                    <button id="remove-dice-texture-btn" class="botao icon-btn" title="Remover Textura do Dado" style="background-color:#cc0000; padding: 10px;">ðŸ—‘ï¸</button>
                </div>
                <div class="input-group">
                     <label for="dice-animation-selector">AnimaÃ§Ã£o do Dado ao Rolar:</label>
                     <select id="dice-animation-selector" title="AnimaÃ§Ã£o do Dado" style="width: 100%; background-color: #f0e6d2; color:black; border:1px solid #b8860b; padding: 10px; border-radius: 6px;">
                        <option value="padrao">AnimaÃ§Ã£o PadrÃ£o</option>
                        <option value="rapido">Giro RÃ¡pido</option>
                        <option value="salto">Salto e Queda</option>
                    </select>
                </div>
            </fieldset>

            <fieldset>
                <legend>Reiniciar AparÃªncia</legend>
                <div class="input-group">
                   <p style="font-size: 0.9em; margin-bottom: 10px;">Isto irÃ¡ restaurar todas as configuraÃ§Ãµes de aparÃªncia (temas, cores, fontes, fundos, etc.) para o padrÃ£o medieval claro, sem afetar seus pontos e dados de personagem.</p>
                   <button id="reset-estetica-btn" class="botao botao-reset" style="width:100%;">Reiniciar EstÃ©tica para PadrÃ£o</button>
                </div>
            </fieldset>

            <button class="cancel-btn" onclick="fecharModal('customizacao-modal')" style="margin-top: 20px; width: calc(100% - 10px);">Fechar CustomizaÃ§Ã£o</button>
        </div>
    </div>

    <!-- NEW THEME CONFIRMATION MODAL -->
    <div id="confirmar-tema-modal" class="modal">
        <div class="modal-content">
            <h3>Quer manter a alteraÃ§Ã£o?</h3>
            <p>A ficha voltarÃ¡ ao modelo anterior se clicar em "NÃ£o".</p>
            <button class="confirm-btn" id="confirmar-tema-sim-btn">Sim</button>
            <button class="cancel-btn" id="confirmar-tema-nao-btn">NÃ£o</button>
        </div>
    </div>


    <div id="fireworks-container"></div>
    <div id="dice-history-trigger">HistÃ³rico de Dados</div>
    <div id="dice-history-panel">
        <h2>HistÃ³rico de Rolagens</h2>
        <div id="dice-history-list">
        </div>
        <div class="dice-history-buttons">
            <button id="limpar-historico-btn" class="botao">Limpar HistÃ³rico</button>
            <button id="fechar-historico-btn" class="botao">Fechar Caixa</button>
        </div>
    </div>
    <div id="custom-tooltip"></div>

    <script>
        const RGP_FICHAS_KEY = 'rpgFichas';
        const RPG_CURRENT_FICHA_ID_KEY = 'rpgCurrentFichaId';
        const FICHA_MATRIZ_ID = "ficha-matriz";

        let fichas = {}, currentFichaId = null, isFichaLocked = false, fichaPassword = null,
            isFichaUnlocked = false, senhaMatriz = "1040", vantagensSelecionadas = [],
            desvantagensSelecionadas = [], tempVantagensSelecionadas = [], tempDesvantagensSelecionadas = [],
            racaSelecionada = null, tempRacaSelecionada = null, vidaTotal, vidaAtual, magiaTotal, magiaAtual,
            vigorTotal, vigorAtual, previousValues = new Map();
        let isGmModeActive = false;
        let previousTheme = '';
        let selectedAttributeIcon = null; // NEW: Tracks the selected attribute icon


        const vantagensData = [
            { nome: "Maestria com Armas curtas (2)", custo: 2, descricao: "+1 em ataque, +1 em acerto com armas curtas." }, { nome: "Maestria com armas pesadas (2)", custo: 2, descricao: "+2 em ataque com armas pesadas." }, { nome: "Maestria com armas de longo alcance (2)", custo: 2, descricao: "+2 em acerto com armas de longo alcance." }, { nome: "Furtar (2)", custo: 2, descricao: "+4 em testes de furto." }, { nome: "LÃ¡bia (2)", custo: 2, descricao: "+5 em testes de lÃ¡bia." }, { nome: "Velejar (1)", custo: 1, descricao: "" }, { nome: "Beleza (1)", custo: 1, descricao: "+3 o teste em lÃ¡bia, paquera e persuasÃ£o." }, { nome: "Boa Fama (2)", custo: 2, descricao: "+4 chance de descontos em armamentos, pousadas, alimentos, etc." }, { nome: "Arremedo (2)", custo: 2, descricao: "Capacidade de imitar qualquer som SIMPLES." }, { nome: "Destemor (1)", custo: 1, descricao: "Dificilmente Ã© assustado por algo." }, { nome: "Empatia (3)", custo: 3, descricao: "Sensibilidade extraordinÃ¡ria em relaÃ§Ã£o aos outras pessoas. Excelente para identificar impostores, possessÃµes por espirito, etc." }, { nome: "Empatia com animais (1)", custo: 1, descricao: "Pode compreender as motivaÃ§Ãµes dos animais." }, { nome: "Patrono (4)", custo: 4, descricao: "Possui um mentor/mestre/professor, atÃ© mesmo uma organizaÃ§Ã£o/guilda que pode lhe oferecer ajuda." }, { nome: "Reconhecimento Social (2)", custo: 2, descricao: "Membro de um grupo respeitado/temido/venerado. +2 teste em lÃ¡bia, paquera e persuasÃ£o." }, { nome: "Riqueza (2)", custo: 2, descricao: "Inicia com 20 moedas de ouro." }, { nome: "AptidÃ£o para magia (4)", custo: 4, descricao: "+15% dano e -15% custo de magia para a magia que tem aptidÃ£o." }, { nome: "Combo FÃ­sico (4)", custo: 4, descricao: "Inicia com 50km velocidade corrida, pulo de 3m altura e 9m distÃ¢ncia.", restricao: "inicio" }, { nome: "Nadar (1)", custo: 1, descricao: "" }, { nome: "Escalar (2)", custo: 2, descricao: "" }, { nome: "Segunda lÃ­ngua (1)", custo: 1, descricao: "Fala mais um idioma." }, { nome: "Paquerador (2)", custo: 2, descricao: "+4 em teste para paquera e persuasÃ£o envolvendo flerte." }, { nome: "Senso de perigo (5)", custo: 5, descricao: "Quando algo grave ocorrer o mestre pedirÃ¡ pra vocÃª jogar um dado para reagir." }, { nome: "Acrobata (3)", custo: 3, descricao: "+ fama ao lutar em pÃºblico." }, { nome: "EquilÃ­brio Perfeito (3)", custo: 3, descricao: "+8 em testes de equilÃ­brio." }, { nome: "Tecnologia (2)", custo: 2, descricao: "Engenhoso, pode inventar coisas, criar objetos improvisados." }, { nome: "Poder Oculto (7)", custo: 7, descricao: "Com 10% vida, ativa +50% em todos atributos. Volta ao normal acima de 10% vida." }, { nome: "SobrevivÃªncia em floresta (2)", custo: 2, descricao: "Facilidade para achar cavernas, criar assentamentos, achar comida, gravar caminhos, achar Ã¡gua, etc." }
        ];
        const desvantagensData = [
            { nome: "Fobia (+2)", ganho: 2, descricao: "Medo irracional de algo especÃ­fico." }, { nome: "MÃ¡ Fama (+2)", ganho: 2, descricao: "Mal visto pela sociedade, dificultando interaÃ§Ãµes sociais." }, { nome: "Alcoolismo (+2)", ganho: 2, descricao: "DependÃªncia de Ã¡lcool que afeta suas decisÃµes." }, { nome: "AltruÃ­smo (+2)", ganho: 2, descricao: "Se sacrifica por outras pessoas, poco se importa com fama ou riqueza." }, { nome: "Avareza (+2)", ganho: 2, descricao: "PreocupaÃ§Ã£o permanente na conservaÃ§Ã£o de riquezas." }, { nome: "Bullying (+3)", ganho: 3, descricao: "Gosta de caÃ§oar, agredir, denegrir, difamar e apontar defeitos." }, { nome: "CircunspeÃ§Ã£o (+2)", ganho: 2, descricao: "NÃ£o entende piadas, entende tudo literal e acredita que todos estÃ£o sÃ©rios." }, { nome: "CompulsÃµes (+3)", ganho: 3, descricao: "HÃ¡bito ou vÃ­cio que toma boa parte dos seus recursos e tempo." }, { nome: "Covardia (+2)", ganho: 2, descricao: "Extremo cuidado com bem-estar fÃ­sico e dificuldade em assumir riscos." }, { nome: "Dependentes (+4)", ganho: 4, descricao: "AlguÃ©m depende de vocÃª a todo momento (filhos, parentes, etc.)." }, { nome: "FÃºria (+2)", ganho: 2, descricao: "TendÃªncia a perder o controle e atacar freneticamente (ativado por dano, insulto ou aleatÃ³rio)." }, { nome: "Honestidade (+3)", ganho: 3, descricao: "NÃ£o consegue mentir ou omitir, sempre fala a verdade e desmascara mentiras." }, { nome: "Impulsividade (+2)", ganho: 2, descricao: "Sempre age sem pensar." }, { nome: "LuxÃºria (+2)", ganho: 2, descricao: "Desejo incontrolÃ¡vel por romance." }, { nome: "Magnetismo Sobrenatural (+2)", ganho: 2, descricao: "Coisas estranhas acontecem com seu personagem em nÃ­vel alarmante." }, { nome: "No Limite (+4)", ganho: 4, descricao: "Assume riscos extremamente irracionais diante de perigo mortal." }, { nome: "Teimosia (+1)", ganho: 1, descricao: "Quer sempre fazer as coisas do seu modo, nÃ£o segue planos que nÃ£o sejam seus." }, { nome: "AmnÃ©sia (+2)", ganho: 2, descricao: "Em certos momentos, nÃ£o consegue lembrar de coisas importantes." }
        ];
        let racasData = [
            { nome: "Humano (3)", custo: 3, descricao: "VersÃ¡teis, ambiciosos, mestres em adaptaÃ§Ã£o.", vantagens: ["Explorador Nato: Cavalo superior, equipamentos, mapa detalhado.", "Mestre das ProfissÃµes: Escolha (Ferreiro LendÃ¡rio, Costureiro Arcano, Arquiteto VisionÃ¡rio) com benefÃ­cios Ãºnicos.", "Rede de InfluÃªncia: Aliado influente (guildas, mercadores, lÃ­deres) com acesso a informaÃ§Ãµes ou ajuda.", "DeterminaÃ§Ã£o InabalÃ¡vel: Uma vez/dia, ignore uma desvantagem (exaustÃ£o, ferimento, magia) por um curto perÃ­odo."] }, { nome: "Elfo (4)", custo: 4, descricao: "SÃ¡bios, mÃ¡gicos, conectados Ã  natureza.", vantagens: ["Sabedoria Ancestral: Domina Ã¡rea (arcana, histÃ³ria, natureza), decifra itens antigos, aprende 1 lÃ­ngua extra.", "VisÃ£o Ã‰lfica Suprema: Enxerga 10m escuro, detecta magias fracas 20m, percebe intenÃ§Ãµes hostis (teste 19+).", "Escudo MÃ¡gico: ResistÃªncia inata a um tipo de efeito mÃ¡gico hostil (dano ou duraÃ§Ã£o -50%)."] }, { nome: "AnÃ£o (4)", custo: 4, descricao: "Resilientes, habilidosos, ligados Ã  terra.", vantagens: ["Fortitude IndomÃ¡vel: Trabalha 3 dias sem descanso, recupera vida/energia 2x mais rÃ¡pido em rocha/subterrÃ¢neo.", "ArtesÃ£o: Escolha (Mestre Minerador, Forjador de Lendas, Joalheiro Divino) com impacto massivo.", "Senhor das Profundezas: Nunca se perde subterrÃ¢neo, detecta armadilhas, sente vibraÃ§Ãµes (prever emboscada/colapso)."] }, { nome: "Orc (3)", custo: 3, descricao: "Guerreiros ferozes, lÃ­deres pela forÃ§a.", vantagens: ["Lenda entre Guerreiros: Inspira temor/respeito, alianÃ§as marciais, acesso missÃµes Ã©picas; inimigos menores fogem (teste 16+).", "ResiliÃªncia Brutal: Luta sem penalidades com ferimentos graves, sÃ³ cai com PV 0, regenera ferimentos leves fora de combate.", "DomÃ­nio da IntimidaÃ§Ã£o: ForÃ§a inimigos a render/recuar com grito (1x/encontro, afeta grupos), bÃ´nus massivo negociaÃ§Ãµes (forÃ§a/medo).", "FÃºria Ancestral: FÃºria 2x/dia (dobra forÃ§a/resistÃªncia por curto perÃ­odo)."] }, { nome: "Meio Animal (Selvagem) (4)", custo: 4, descricao: "Instinto primal com astÃºcia.", vantagens: ["Sentidos PredatÃ³rios: Escolha (visÃ£o, olfato, audiÃ§Ã£o) aguÃ§ado; rastreia km, detecta invisÃ­veis, evita surpresa (teste 12+).", "Senhor dos Terrenos: Adapta-se a 1 ambiente (floresta, deserto, pÃ¢ntano), ignora efeitos negativos, bÃ´nus movimento/furtividade (+1).", "Frenesi Instintivo: 1x/dia, velocidade sobrenatural (2x movimento), ataques adicionais, percepÃ§Ã£o prÃ©-monitÃ³ria (10 min)."] }
        ];
        const nivelData = [
            { nivel: 0, xp: 0, pd: 25, ph: 8 }, { nivel: 1, xp: 10, pd: 31, ph: 9 }, { nivel: 2, xp: 30, pd: 37, ph: 10 }, { nivel: 3, xp: 60, pd: 43, ph: 11 }, { nivel: 4, xp: 100, pd: 49, ph: 12 }, { nivel: 5, xp: 150, pd: 55, ph: 13 }, { nivel: 6, xp: 210, pd: 61, ph: 14 }, { nivel: 7, xp: 280, pd: 67, ph: 15 }, { nivel: 8, xp: 360, pd: 73, ph: 16 }, { nivel: 9, xp: 450, pd: 79, ph: 17 }, { nivel: 10, xp: 550, pd: 85, ph: 18 }, { nivel: 11, xp: 670, pd: 91, ph: 19 }, { nivel: 12, xp: 810, pd: 97, ph: 20 }, { nivel: 13, xp: 970, pd: 103, ph: 21 }, { nivel: 14, xp: 1150, pd: 109, ph: 22 }, { nivel: 15, xp: 1350, pd: 115, ph: 23 }, { nivel: 16, xp: 1570, pd: 121, ph: 24 }, { nivel: 17, xp: 1810, pd: 127, ph: 25 }, { nivel: 18, xp: 2070, pd: 133, ph: 26 }, { nivel: 19, xp: 2350, pd: 139, ph: 27 }, { nivel: 20, xp: 2650, pd: 145, ph: 28 }, { nivel: 21, xp: 2980, pd: 148, ph: 29 }, { nivel: 22, xp: 3340, pd: 151, ph: 30 }, { nivel: 23, xp: 3730, pd: 154, ph: 31 }, { nivel: 24, xp: 4150, pd: 157, ph: 32 }, { nivel: 25, xp: 4600, pd: 160, ph: 33 }, { nivel: 26, xp: 5080, pd: 163, ph: 34 }, { nivel: 27, xp: 5590, pd: 166, ph: 35 }, { nivel: 28, xp: 6130, pd: 169, ph: 36 }, { nivel: 29, xp: 8000, pd: 219, ph: 37 }, { nivel: 30, xp: 10000, pd: 319, ph: 38 }
        ];

        // Cache DOM Elements
        const nomePersonagemInput = document.getElementById("nome-personagem"), descricaoPersonagemInput = document.getElementById("descricao-personagem"),
            forcaInput = document.getElementById("forca"), destrezaInput = document.getElementById("destreza"), agilidadeInput = document.getElementById("agilidade"),
            inteligenciaInput = document.getElementById("inteligencia"), constituicaoInput = document.getElementById("constituicao"),
            ataqueSpan = document.getElementById("ataque"), ataqueMagicoSpan = document.getElementById("ataque-magico"), acertoSpan = document.getElementById("acerto"),
            esquivaSpan = document.getElementById("esquiva"), rdfSpan = document.getElementById("rdf"), rdmSpan = document.getElementById("rdm"),
            armaDireitaNomeInput = document.getElementById("arma-direita-nome"), armaDireitaAtaqueInput = document.getElementById("arma-direita-ataque"),
            armaDireitaAtaqueMagicoInput = document.getElementById("arma-direita-ataque-magico"), armaEsquerdaNomeInput = document.getElementById("arma-esquerda-nome"),
            armaEsquerdaAtaqueInput = document.getElementById("arma-esquerda-ataque"), armaEsquerdaAtaqueMagicoInput = document.getElementById("arma-esquerda-ataque-magico"),
            resetPontosButton = document.getElementById("reset-pontos"), recomecarButton = document.getElementById("recomecar"),
            bloquearFichaButton = document.getElementById("bloquear-ficha"), experienciaInput = document.getElementById("experiencia"),
            xpLockIcon = document.getElementById("xp-lock-icon"),
            nivelSpan = document.getElementById("nivel"), pontosHabilidadeSpan = document.getElementById("pontos-habilidade"),
            pontosVantagemSpan = document.getElementById("pontos-vantagem"), velocidadeCorridaSpan = document.getElementById("velocidade-corrida"),
            alturaPuloSpan = document.getElementById("altura-pulo"), distanciaPuloSpan = document.getElementById("distancia-pulo"),
            nomePersonagemTitulo = document.getElementById("nome-personagem-titulo"), gameMasterMessage = document.getElementById("game-master-message"),
            vantagensListDisplay = document.getElementById("vantagens-list-display"), desvantagensListDisplay = document.getElementById("desvantagens-list-display"),
            inventarioSlots = document.getElementById("inventario-slots"), pesoTotalSpan = document.getElementById("peso-total"),
            capacidadeCargaSpan = document.getElementById("capacidade-carga"),
            diceContainer = document.getElementById("dice-container"), diceRoll = document.getElementById("dice-roll"), diceResult = document.getElementById("dice-result"),
            changeDiceTypeBtn = document.getElementById('change-dice-type-btn'),
            diceOptionsMenu = document.getElementById('dice-options-menu'),
            notification = document.getElementById("notification"), characterImageInput = document.getElementById("character-image-input"),
            characterImage = document.getElementById("character-image"), vantagensDesvantagensBtn = document.getElementById("vantagens-desvantagens-btn"),
            vantagensDesvantagensPanel = document.getElementById("vantagens-desvantagens-panel"), vantagensList = document.getElementById("vantagens-list"),
            desvantagensList = document.getElementById("desvantagens-list"), salvarVantagensBtn = document.getElementById("salvar-vantagens-btn"),
            fecharPaginaBtn = document.getElementById("fechar-pagina-btn"), fichaContainer = document.getElementById("ficha-container"),
            magiasList = document.getElementById("magias-list"), adicionarMagiaBtn = document.getElementById("adicionar-magia-btn"),
            anotacoesBtn = document.getElementById("anotacoes-btn"), anotacoesTextarea = document.getElementById("anotacoes-textarea"),
            racasBtn = document.getElementById("racas-btn"), classesBtn = document.getElementById("classes-btn"), racasPanel = document.getElementById("racas-panel"),
            classesPanel = document.getElementById("classes-panel"), fecharRacasBtn = document.getElementById("fechar-racas-btn"),
            fecharClassesBtn = document.getElementById("fechar-classes-btn"), classeNomeInput = document.getElementById("classe-nome"),
            classeDescricaoInput = document.getElementById("classe-descricao"), racaNomeSpan = document.getElementById("raca-nome"),
            racaDescricaoInput = document.getElementById("raca-descricao"), luaBtn = document.getElementById("lua-btn"), solBtn = document.getElementById("sol-btn"),
            salvarRacasBtn = document.getElementById("salvar-racas-btn"), racasList = document.getElementById("racas-list"),
            atributosInputs = [forcaInput, destrezaInput, agilidadeInput, inteligenciaInput, constituicaoInput],
            salvarAtributosBtnEl = document.getElementById("salvar-atributos-btn"),
            customizacaoBtn = document.getElementById("customizacao-btn"),
            customizacaoModal = document.getElementById("customizacao-modal"),
            backgroundImageInput = document.getElementById("background-image-input"),
            corBordaSecaoInput = document.getElementById("cor-borda-secao-input"),
            estiloBordaSecaoSelect = document.getElementById("estilo-borda-secao-select"),
            larguraBordaSecaoInput = document.getElementById("largura-borda-secao-input"),
            diceTextureInput = document.getElementById("dice-texture-input"),
            removeDiceTextureBtn = document.getElementById("remove-dice-texture-btn"),
            diceAnimationSelector = document.getElementById("dice-animation-selector"),
            backgroundColorInput = document.getElementById('background-color-input'),
            fichaInternalBackgroundColorInput = document.getElementById('ficha-internal-background-color-input'),
            fontSelector = document.getElementById('font-selector'),
            diceColorInput = document.getElementById('dice-color-input'),
            diceNumberColorInput = document.getElementById('dice-number-color-input'),
            fichaTransparencySlider = document.getElementById('ficha-transparency-slider'),
            fichaTransparencyValueSpan = document.getElementById('ficha-transparency-value'),
            shadowColorFichaInput = document.getElementById('shadow-color-ficha'),
            shadowIntensityFichaSlider = document.getElementById('shadow-intensity-ficha-slider'),
            shadowIntensityFichaValueSpan = document.getElementById('shadow-intensity-ficha-value'),
            confirmarSalvarBtn = document.getElementById("confirmar-salvar-btn"),
            phTempRacaSpan = document.getElementById("ph-temp-raca"),
            senhaGmTitulo = document.getElementById("senha-gm-titulo"),
            diceHistoryTrigger = document.getElementById('dice-history-trigger'),
            diceHistoryPanel = document.getElementById('dice-history-panel'),
            diceHistoryList = document.getElementById('dice-history-list'),
            fecharHistoricoBtn = document.getElementById('fechar-historico-btn'),
            limparHistoricoBtn = document.getElementById('limpar-historico-btn'),
            customTooltipElement = document.getElementById('custom-tooltip'),
            gmModeBtn = document.getElementById('gm-mode-btn'),
            vidaAtualInput = document.getElementById('vida-atual-input'),
            magiaAtualInput = document.getElementById('magia-atual-input'),
            vigorAtualInput = document.getElementById('vigor-atual-input'),
            confirmarSalvarAtributosModal = document.getElementById("confirmar-salvar-atributos-modal"),
            confirmarSalvarAtributosOkBtn = document.getElementById("confirmar-salvar-atributos-ok-btn"),
            // Theme UI Elements
            themeSelector = document.getElementById('theme-selector'),
            elementalThemeGroup = document.getElementById('elemental-theme-group'),
            elementalThemeSelector = document.getElementById('elemental-theme-selector'),
            confirmarTemaModal = document.getElementById('confirmar-tema-modal'),
            confirmarTemaSimBtn = document.getElementById('confirmar-tema-sim-btn'),
            confirmarTemaNaoBtn = document.getElementById('confirmar-tema-nao-btn');

        let nivel = 0, nivelAnterior = 0, pontosHabilidadeTotal = 25, pontosHabilidadeUsados = 0, experiencia = 0, vidaBase = 50;
        let currentActionIntervalId = null;
        const REPEAT_DELAY_MS = 75;
        const XP_UNLOCK_DURATION_MS = 20000;
        let xpUnlockTimerId = null;
        let isXpUnlocked = false;
        let isDiceRolling = false;
        let currentDiceMax = 20;
        let fireworksContainerRef;
        let tooltipTimeoutId = null;

        function getFichasFromStorage() {
            const fichasJSON = localStorage.getItem(RGP_FICHAS_KEY);
            return fichasJSON ? JSON.parse(fichasJSON) : {};
        }

        function saveFichasToStorage(fichasObj) {
            localStorage.setItem(RGP_FICHAS_KEY, JSON.stringify(fichasObj));
        }

        function getCurrentFichaIdFromStorage() {
            return localStorage.getItem(RPG_CURRENT_FICHA_ID_KEY);
        }

        function saveCurrentFichaIdToStorage(fichaId) {
            localStorage.setItem(RPG_CURRENT_FICHA_ID_KEY, fichaId);
        }

        function generateLocalId() {
            return `local_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
        }

        function hexToRgb(hex) {
            if (!hex) return null;
            let shorthandRegex = /^#?([a-f\d])([a-f\d])([a-f\d])$/i;
            hex = hex.replace(shorthandRegex, function(m, r, g, b) {
                return r + r + g + g + b + b;
            });
            let result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? {
                r: parseInt(result[1], 16),
                g: parseInt(result[2], 16),
                b: parseInt(result[3], 16)
            } : null;
        }


        function criarFichaMatriz() {
            fichas = getFichasFromStorage();
            if (!fichas[FICHA_MATRIZ_ID]) {
                const fichaMatriz = {
                    nomeFicha: "Matriz", nomePersonagem: "Personagem Matriz", descricaoPersonagem: "Ficha original do sistema",
                    forca: "0", destreza: "0", agilidade: "0", inteligencia: "0", constituicao: "0", experiencia: "0",
                    armaDireitaNome: "", armaDireitaAtaque: "0", armaDireitaAtaqueMagico: "0",
                    armaEsquerdaNome: "", armaEsquerdaAtaque: "0", armaEsquerdaAtaqueMagico: "0",
                    vantagens: "", magiasHabilidades: Array(10).fill("").join("\n"), desvantagens: "",
                    inventario: Array(10).fill({ item: "", peso: "0" }),
                    velocidadeCorrida: "25", alturaPulo: "1", distanciaPulo: "3",
                    isLocked: true, password: senhaMatriz, imagem: null, anotacoes: "",
                    classeNome: "", classeDescricao: "", racaNome: "", racaDescricao: "", racaSelecionada: "",
                    backgroundImage: null, backgroundSize: 'cover', backgroundAttachment: 'scroll',
                    backgroundColor: null,
                    fichaInternalBackgroundColor: null,
                    fichaTransparencyLevel: 100,
                    fontFamily: "'Inter', sans-serif",
                    vidaAtual: 50, magiaAtual: 20, vigorAtual: 10,
                    diceColor: null, diceNumberColor: null, texturaDado: null, animacaoDado: 'padrao',
                    diceRolls: [],
                    collapsedSections: {},
                    gmOverrides: {},
                    corBordaSecao: '#b8860b', estiloBordaSecao: 'solid', larguraBordaSecao: '2px',
                    shadowColorFicha: '#000000',
                    shadowIntensityFicha: 0,
                    lockedAtributos: { forca: 0, destreza: 0, agilidade: 0, constituicao: 0, inteligencia: 0 },
                    theme: 'theme-medieval'
                };
                fichas[FICHA_MATRIZ_ID] = fichaMatriz;
                saveFichasToStorage(fichas);
            }
        }

        function carregarFichas() {
            criarFichaMatriz();
            fichas = getFichasFromStorage();
            const storedCurrentFichaId = getCurrentFichaIdFromStorage();

            if (storedCurrentFichaId && fichas[storedCurrentFichaId]) {
                currentFichaId = storedCurrentFichaId;
            } else {
                currentFichaId = FICHA_MATRIZ_ID;
                saveCurrentFichaIdToStorage(currentFichaId);
            }
            carregarFicha(currentFichaId);
            atualizarAbasFichas();
        }


        function atualizarAbasFichas() {
            const sidebar = document.getElementById("fichas-sidebar");
            const addBtn = document.getElementById("add-ficha-btn");

            while (sidebar.firstChild && sidebar.firstChild !== addBtn) {
                sidebar.removeChild(sidebar.firstChild);
            }

            if (!fichas[FICHA_MATRIZ_ID]) {
                criarFichaMatriz();
            }

            const matrizTab = document.createElement("div");
            matrizTab.className = "ficha-tab";
            const matrizSpan = document.createElement("span");
            matrizSpan.textContent = fichas[FICHA_MATRIZ_ID].nomeFicha || "Matriz";
            matrizTab.appendChild(matrizSpan);
            matrizTab.dataset.fichaId = FICHA_MATRIZ_ID;
            if (FICHA_MATRIZ_ID === currentFichaId) matrizTab.classList.add("active");
            matrizTab.onclick = () => {
                currentFichaId = FICHA_MATRIZ_ID;
                saveCurrentFichaIdToStorage(currentFichaId);
                carregarFicha(FICHA_MATRIZ_ID);
                atualizarAbasFichas();
            };
            sidebar.insertBefore(matrizTab, addBtn);

            for (let fichaId in fichas) {
                if (fichaId !== FICHA_MATRIZ_ID) {
                    const tab = document.createElement("div");
                    tab.className = "ficha-tab";
                    const span = document.createElement("span");
                    span.textContent = fichas[fichaId].nomeFicha || "Sem Nome";
                    tab.appendChild(span);
                    tab.dataset.fichaId = fichaId;
                    if (fichaId === currentFichaId) tab.classList.add("active");
                    tab.onclick = () => {
                        currentFichaId = fichaId;
                        saveCurrentFichaIdToStorage(currentFichaId);
                        carregarFicha(fichaId);
                        atualizarAbasFichas();
                    };
                    sidebar.insertBefore(tab, addBtn);
                }
            }
        }


        document.getElementById("add-ficha-btn").onclick = () => {
            document.getElementById("nome-ficha-modal").style.display = "flex"; document.getElementById("nome-ficha-input").value = ""; document.getElementById("nome-ficha-input").focus();
        };

        function criarNovaFicha() {
            const nomeFicha = document.getElementById("nome-ficha-input").value.trim();
            if (!nomeFicha) return alert("Por favor, dÃª um nome Ã  ficha!");
            const novaFichaId = generateLocalId();
            const novaFicha = {
                nomeFicha, nomePersonagem: "", descricaoPersonagem: "", forca: "0", destreza: "0", agilidade: "0",
                inteligencia: "0", constituicao: "0", experiencia: "0", armaDireitaNome: "", armaDireitaAtaque: "0",
                armaDireitaAtaqueMagico: "0", armaEsquerdaNome: "", armaEsquerdaAtaque: "0", armaEsquerdaAtaqueMagico: "0",
                vantagens: "", magiasHabilidades: Array(10).fill("").join("\n"), desvantagens: "",
                inventario: Array(10).fill({ item: "", peso: "0" }),
                velocidadeCorrida: "25", alturaPulo: "1", distanciaPulo: "3",
                isLocked: false, password: null, imagem: null, anotacoes: "",
                classeNome: "", classeDescricao: "", racaNome: "", racaDescricao: "", racaSelecionada: "",
                backgroundImage: null, backgroundSize: 'cover', backgroundAttachment: 'scroll',
                backgroundColor: null,
                fichaInternalBackgroundColor: null,
                fichaTransparencyLevel: 100,
                fontFamily: "'Inter', sans-serif",
                vidaAtual: 50, magiaAtual: 20, vigorAtual: 10,
                diceColor: null, diceNumberColor: null, texturaDado: null, animacaoDado: 'padrao',
                diceRolls: [],
                collapsedSections: {},
                gmOverrides: {},
                corBordaSecao: '#b8860b', estiloBordaSecao: 'solid', larguraBordaSecao: '2px',
                darkMode: document.body.classList.contains('dark-mode'),
                shadowColorFicha: '#000000',
                shadowIntensityFicha: 0,
                lockedAtributos: { forca: 0, destreza: 0, agilidade: 0, constituicao: 0, inteligencia: 0 },
                theme: 'theme-medieval'
            };
            fichas[novaFichaId] = novaFicha;
            saveFichasToStorage(fichas);
            currentFichaId = novaFichaId;
            saveCurrentFichaIdToStorage(currentFichaId);
            carregarFicha(novaFichaId);
            fecharModal("nome-ficha-modal");
            atualizarAbasFichas();
        }

        function fecharModal(modalId) { document.getElementById(modalId).style.display = "none"; }

        function carregarFicha(fichaId) {
            if (!fichas[fichaId]) {
                console.error("Ficha nÃ£o encontrada:", fichaId);
                currentFichaId = FICHA_MATRIZ_ID;
                saveCurrentFichaIdToStorage(currentFichaId);
                if (!fichas[currentFichaId]) criarFichaMatriz();
                fichaId = currentFichaId;
            }
            const ficha = fichas[fichaId];
            if (!ficha) {
                alert("Erro crÃ­tico: NÃ£o foi possÃ­vel carregar a ficha " + fichaId);
                return;
            }

            // Ensure new properties have defaults
            ficha.gmOverrides = ficha.gmOverrides || {};
            ficha.diceRolls = ficha.diceRolls || [];
            ficha.collapsedSections = ficha.collapsedSections || {};
            ficha.corBordaSecao = ficha.corBordaSecao || '#b8860b';
            ficha.estiloBordaSecao = ficha.estiloBordaSecao || 'solid';
            ficha.larguraBordaSecao = ficha.larguraBordaSecao || '2px';
            ficha.texturaDado = ficha.texturaDado || null;
            ficha.animacaoDado = ficha.animacaoDado || 'padrao';
            ficha.fontFamily = ficha.fontFamily || "'Inter', sans-serif";
            ficha.backgroundColor = ficha.backgroundColor || null;
            ficha.fichaInternalBackgroundColor = ficha.fichaInternalBackgroundColor || null;
            ficha.fichaTransparencyLevel = ficha.fichaTransparencyLevel !== undefined ? ficha.fichaTransparencyLevel : 100;
            ficha.diceColor = ficha.diceColor || null;
            ficha.diceNumberColor = ficha.diceNumberColor || null;
            ficha.backgroundImage = ficha.backgroundImage || null;
            ficha.backgroundSize = ficha.backgroundSize || 'cover';
            ficha.backgroundAttachment = ficha.backgroundAttachment || 'scroll';
            ficha.darkMode = ficha.darkMode === undefined ? false : ficha.darkMode;
            ficha.shadowColorFicha = ficha.shadowColorFicha || '#000000';
            ficha.shadowIntensityFicha = ficha.shadowIntensityFicha !== undefined ? ficha.shadowIntensityFicha : 0;
            ficha.lockedAtributos = ficha.lockedAtributos || { forca: 0, destreza: 0, agilidade: 0, constituicao: 0, inteligencia: 0 };
            ficha.theme = ficha.theme || 'theme-medieval';

            limparClassesDeTema();
            aplicarClassesDeTema(ficha.theme);
            if (ficha.darkMode) {
                 document.body.classList.add('dark-mode');
            } else {
                 document.body.classList.remove('dark-mode');
            }


            nomePersonagemInput.value = ficha.nomePersonagem || "";
            descricaoPersonagemInput.value = ficha.descricaoPersonagem || "";

            forcaInput.value = ficha.forca || "0";
            destrezaInput.value = ficha.destreza || "0";
            agilidadeInput.value = ficha.agilidade || "0";
            inteligenciaInput.value = ficha.inteligencia || "0";
            constituicaoInput.value = ficha.constituicao || "0";

            experienciaInput.value = ficha.experiencia || "0";
            armaDireitaNomeInput.value = ficha.armaDireitaNome || "";
            armaDireitaAtaqueInput.value = ficha.armaDireitaAtaque || "0";
            armaDireitaAtaqueMagicoInput.value = ficha.armaDireitaAtaqueMagico || "0";
            armaEsquerdaNomeInput.value = ficha.armaEsquerdaNome || "";
            armaEsquerdaAtaqueInput.value = ficha.armaEsquerdaAtaque || "0";
            armaEsquerdaAtaqueMagicoInput.value = ficha.armaEsquerdaAtaqueMagico || "0";

            isFichaLocked = ficha.isLocked || false;
            fichaPassword = ficha.password || null;
            isFichaUnlocked = false;
            vantagensSelecionadas = ficha.vantagens ? ficha.vantagens.split("\n").filter(v => v.trim()) : [];
            desvantagensSelecionadas = ficha.desvantagens ? ficha.desvantagens.split("\n").filter(d => d.trim()) : [];
            racaSelecionada = ficha.racaSelecionada || "";
            racaNomeSpan.textContent = racaSelecionada ? racaSelecionada.split(" (")[0] : "";
            racaDescricaoInput.value = racasData.find(r => r.nome === racaSelecionada)?.vantagens.join("\n\n") || "";

            vantagensListDisplay.innerHTML = "";
            desvantagensListDisplay.innerHTML = "";
            vantagensSelecionadas.forEach(v => { const div = document.createElement("div"); div.textContent = v; div.className = "list-item"; div.onclick = () => removerVantagem(v); vantagensListDisplay.appendChild(div); });
            desvantagensSelecionadas.forEach(d => { const div = document.createElement("div"); div.textContent = d; div.className = "list-item"; div.onclick = () => removerDesvantagem(d); desvantagensListDisplay.appendChild(div); });

            const inventario = Array.isArray(ficha.inventario) ? ficha.inventario : Array(10).fill({ item: "", peso: "0" });
            const slots = inventarioSlots.querySelectorAll(".inventory-slot");
            slots.forEach((slot, i) => { slot.querySelector(".inventory-item").value = inventario[i]?.item || ""; slot.querySelector(".inventory-weight").value = inventario[i]?.peso || "0"; });
            calcularPesoTotal();

            const magias = ficha.magiasHabilidades ? ficha.magiasHabilidades.split("\n") : Array(10).fill("");
            magiasList.innerHTML = "";
            magias.forEach((m, i) => { const input = document.createElement("input"); input.type = "text"; input.className = "magia-nome"; input.placeholder = `Magia/Habilidade ${i + 1}`; input.value = m; input.addEventListener('input', salvarDados); magiasList.appendChild(input); });
            anotacoesTextarea.value = ficha.anotacoes || "";
            classeNomeInput.value = ficha.classeNome || "";
            classeDescricaoInput.value = ficha.classeDescricao || "";
            if (ficha.imagem && ficha.imagem.startsWith('data:image')) { characterImage.src = ficha.imagem; characterImage.style.display = "block"; } else { characterImage.src = ''; characterImage.style.display = "none"; }

            atualizarBotaoBloquear();
            atualizarVantagensDesvantagensPanel();
            atualizarRacasPanel();
            experiencia = parseInt(experienciaInput.value) || 0;

            experienciaInput.readOnly = true;
            xpLockIcon.textContent = 'ðŸ”’';
            isXpUnlocked = false;
            if (xpUnlockTimerId) clearTimeout(xpUnlockTimerId);

            vidaAtual = ficha.vidaAtual !== undefined ? parseInt(ficha.vidaAtual) : 50;
            magiaAtual = ficha.magiaAtual !== undefined ? parseInt(ficha.magiaAtual) : 20;
            vigorAtual = ficha.vigorAtual !== undefined ? parseFloat(ficha.vigorAtual) : 10;


            atualizarNivel(); // This calls calcularAtributos

            vidaAtualInput.value = Math.min(vidaAtual, vidaTotal);
            magiaAtualInput.value = Math.min(magiaAtual, magiaTotal);
            vigorAtualInput.value = (Math.min(vigorAtual, vigorTotal)).toFixed(1);

            previousValues.clear();
            atributosInputs.forEach(input => {
                 previousValues.set(input, input.value);
            });
            document.querySelectorAll('input[type="text"]:not(#forca):not(#destreza):not(#agilidade):not(#inteligencia):not(#constituicao), input[type="number"]:not(#forca):not(#destreza):not(#agilidade):not(#inteligencia):not(#constituicao):not(#experiencia):not(.recurso-atual-input), textarea').forEach(input => {
                previousValues.set(input, input.value);
            });

            aplicarPlanoDeFundoInicial(ficha);
            aplicarEstilosFichaInicial(ficha);
            aplicarFonteInicial(ficha);
            aplicarCoresDadoInicial(ficha);
            aplicarCustomizacoesDadoInicial(ficha);
            aplicarEstilosDeFundoVisuais();
            aplicarEstilosDeSombra();
            aplicarEstadoColapsoSecoes(ficha.collapsedSections);

            document.body.classList.toggle("gm-mode-active", isGmModeActive);
            gmModeBtn.classList.toggle("gm-active", isGmModeActive);
            gmModeBtn.textContent = isGmModeActive ? "Modo Mestre Ativo ðŸ‘‘" : "Modo Mestre GM ðŸ‘‘";

            if (salvarAtributosBtnEl) salvarAtributosBtnEl.style.display = "none";
        }

        function atualizarBotaoBloquear() {
            bloquearFichaButton.textContent = isFichaLocked ? "Desbloquear Ficha" : "Bloquear Ficha";
            bloquearFichaButton.classList.toggle("botao-bloquear", !isFichaLocked); bloquearFichaButton.classList.toggle("botao-desbloquear", isFichaLocked);
        }

        function salvarDados() {
            if (!currentFichaId || !fichas[currentFichaId] || (isFichaLocked && !isFichaUnlocked)) return;

            const inventario = Array.from(inventarioSlots.querySelectorAll(".inventory-slot")).map(slot => ({ item: slot.querySelector(".inventory-item").value, peso: slot.querySelector(".inventory-weight").value }));
            const magias = Array.from(magiasList.querySelectorAll(".magia-nome")).map(input => input.value);

            const fichaAtual = fichas[currentFichaId];

            fichaAtual.nomePersonagem = nomePersonagemInput.value;
            fichaAtual.descricaoPersonagem = descricaoPersonagemInput.value;

            fichaAtual.forca = forcaInput.value;
            fichaAtual.destreza = destrezaInput.value;
            fichaAtual.agilidade = agilidadeInput.value;
            fichaAtual.inteligencia = inteligenciaInput.value;
            fichaAtual.constituicao = constituicaoInput.value;

            fichaAtual.experiencia = experienciaInput.value;
            fichaAtual.armaDireitaNome = armaDireitaNomeInput.value;
            fichaAtual.armaDireitaAtaque = armaDireitaAtaqueInput.value;
            fichaAtual.armaDireitaAtaqueMagico = armaDireitaAtaqueMagicoInput.value;
            fichaAtual.armaEsquerdaNome = armaEsquerdaNomeInput.value;
            fichaAtual.armaEsquerdaAtaque = armaEsquerdaAtaqueInput.value;
            fichaAtual.armaEsquerdaAtaqueMagico = armaEsquerdaAtaqueMagicoInput.value;
            fichaAtual.vantagens = vantagensSelecionadas.join("\n");
            fichaAtual.magiasHabilidades = magias.join("\n");
            fichaAtual.desvantagens = desvantagensSelecionadas.join("\n");
            fichaAtual.inventario = inventario;

            fichaAtual.isLocked = isFichaLocked;
            fichaAtual.password = fichaPassword;
            fichaAtual.imagem = characterImage.src.startsWith('data:image') ? characterImage.src : null;
            fichaAtual.anotacoes = anotacoesTextarea.value;
            fichaAtual.classeNome = classeNomeInput.value;
            fichaAtual.classeDescricao = classeDescricaoInput.value;
            fichaAtual.racaNome = racaNomeSpan.textContent;
            fichaAtual.racaDescricao = racaDescricaoInput.value;
            fichaAtual.racaSelecionada = racaSelecionada;
            fichaAtual.diceRolls = fichaAtual.diceRolls || [];
            fichaAtual.collapsedSections = fichaAtual.collapsedSections || {};
            fichaAtual.gmOverrides = fichaAtual.gmOverrides || {};
            fichaAtual.lockedAtributos = fichaAtual.lockedAtributos || { forca: 0, destreza: 0, agilidade: 0, constituicao: 0, inteligencia: 0 };

            fichaAtual.backgroundImage = document.body.style.backgroundImage === 'none' || document.body.style.backgroundImage === '' ? null : document.body.style.backgroundImage.slice(5, -2).replace(/"/g, "").replace(/'/g, "");
            fichaAtual.backgroundSize = document.body.style.backgroundSize;
            fichaAtual.backgroundAttachment = document.body.style.backgroundAttachment;

            if (backgroundColorInput) fichaAtual.backgroundColor = backgroundColorInput.value;
            if (fichaInternalBackgroundColorInput) fichaAtual.fichaInternalBackgroundColor = fichaInternalBackgroundColorInput.value;
            if (fichaTransparencySlider) fichaAtual.fichaTransparencyLevel = parseInt(fichaTransparencySlider.value);

            fichaAtual.darkMode = document.body.classList.contains("dark-mode");
            fichaAtual.fontFamily = fontSelector.value;
            fichaAtual.theme = getCurrentThemeFromClasses();

            fichaAtual.diceColor = diceColorInput.value;
            fichaAtual.diceNumberColor = diceNumberColorInput.value;
            fichaAtual.animacaoDado = diceAnimationSelector.value;

            vidaAtual = parseInt(vidaAtualInput.value);
            magiaAtual = parseInt(magiaAtualInput.value);
            vigorAtual = parseFloat(vigorAtualInput.value);

            fichaAtual.vidaAtual = vidaAtual;
            fichaAtual.magiaAtual = magiaAtual;
            fichaAtual.vigorAtual = vigorAtual;

            fichaAtual.corBordaSecao = corBordaSecaoInput.value;
            fichaAtual.estiloBordaSecao = estiloBordaSecaoSelect.value;
            fichaAtual.larguraBordaSecao = larguraBordaSecaoInput.value + 'px';

            fichaAtual.shadowColorFicha = shadowColorFichaInput.value;
            fichaAtual.shadowIntensityFicha = parseInt(shadowIntensityFichaSlider.value);

            saveFichasToStorage(fichas);
        }

        function calcularNivel(exp) { return nivelData.findLast(data => exp >= data.xp)?.nivel ?? 0; }

        function criarParticulaFogos(x, y, cor, tipo) {
            const particula = document.createElement('div');
            particula.className = 'firework-particle';
            particula.style.position = 'absolute';
            particula.style.left = x + 'px';
            particula.style.top = y + 'px';

            const tamanhoBase = tipo === 'foguete' ? 4 : (Math.random() * 4 + 2);
            particula.style.width = tamanhoBase + 'px';
            particula.style.height = (tipo === 'foguete' ? tamanhoBase * 4 : tamanhoBase) + 'px';

            particula.style.backgroundColor = cor;
            particula.style.borderRadius = '50%';
            particula.style.opacity = '1';

            fireworksContainerRef.appendChild(particula);
            return particula;
        }

        function animarExplosaoFogos(particulaMae) {
            const numParticulasExplosao = 30 + Math.floor(Math.random() * 30);
            const corBase = particulaMae.style.backgroundColor;
            const xBase = parseFloat(particulaMae.style.left);
            const yBase = parseFloat(particulaMae.style.top);

            particulaMae.remove();

            for (let i = 0; i < numParticulasExplosao; i++) {
                const p = criarParticulaFogos(xBase, yBase, corBase, 'explosao');
                const angulo = Math.random() * Math.PI * 2;
                const forca = Math.random() * 100 + 80;
                const duracao = Math.random() * 1.0 + 0.8;

                const targetX = xBase + Math.cos(angulo) * forca;
                const targetYFinal = yBase + Math.sin(angulo) * forca + (Math.random() * 100 + 50);

                p.style.animation = `particle-trail ${duracao}s ease-out forwards`;
                p.style.transition = `transform ${duracao}s cubic-bezier(0.1, 0.7, 0.3, 1)`;

                void p.offsetWidth;

                p.style.transform = `translate(${targetX - xBase}px, ${targetYFinal - yBase}px) scale(0.5)`;

                setTimeout(() => {
                    if (p && p.parentNode) p.remove();
                }, duracao * 1000 + 200);
            }
        }

        function dispararFogoDeArtificioIndividual() {
            if (!fireworksContainerRef) return;
            const cores = ['#FF5252', '#FFC107', '#4CAF50', '#2196F3', '#9C27B0', '#FFEB3B', '#FF4081', '#00BCD4', '#FF9800'];
            const cor = cores[Math.floor(Math.random() * cores.length)];

            const startX = Math.random() * window.innerWidth;
            const startY = window.innerHeight;
            const endY = Math.random() * (window.innerHeight * 0.4) + (window.innerHeight * 0.1);

            const foguete = criarParticulaFogos(startX, startY, cor, 'foguete');
            const duracaoSubida = Math.random() * 1.2 + 0.6;

            foguete.style.transition = `transform ${duracaoSubida}s ease-out`;
            void foguete.offsetWidth;

            foguete.style.transform = `translateY(${endY - startY}px)`;

            setTimeout(() => {
                animarExplosaoFogos(foguete);
            }, duracaoSubida * 1000);
        }

        function dispararFogosDeArtificio(quantidade) {
            for (let i = 0; i < quantidade; i++) {
                setTimeout(dispararFogoDeArtificioIndividual, Math.random() * 1000 + (i * 150));
            }
        }

        function atualizarNivel() {
            const ficha = fichas[currentFichaId];
            if (!ficha) return;

            experiencia = parseInt(experienciaInput.value) || 0;
            nivelAnterior = nivel;

            nivel = ficha.gmOverrides?.nivel !== undefined ? parseInt(ficha.gmOverrides.nivel) : calcularNivel(experiencia);
            nivelSpan.textContent = nivel;

            const nivelInfo = nivelData.find(data => data.nivel === nivel) || nivelData[0];

            pontosHabilidadeTotal = ficha.gmOverrides?.['pontos-habilidade'] !== undefined ?
                                      parseInt(ficha.gmOverrides['pontos-habilidade']) : nivelInfo.pd;

            pontosVantagemSpan.textContent = getPontosVantagem();

            if (nivel > nivelAnterior && ficha.gmOverrides?.nivel === undefined) {
                nivelSpan.classList.add("aura-azul");
                setTimeout(() => nivelSpan.classList.remove("aura-azul"), 5000);
                showNotification(`ParabÃ©ns! VocÃª alcanÃ§ou o NÃ­vel ${nivel}!`, "critical-success");
                dispararFogosDeArtificio(7 + Math.floor(Math.random() * 6));
            }
            gameMasterMessage.style.display = nivel >= 30 ? "block" : "none";

            const isDarkModeActive = document.body.classList.contains('dark-mode');
             if (nivel >= 30 && ficha.gmOverrides?.nivel === undefined && !isDarkModeActive) {
                fichaContainer.classList.add("aura-azul");
            } else {
                fichaContainer.classList.remove("aura-azul");
            }

            calcularAtributos();
        }


        function getPontosVantagem() {
            const ficha = fichas[currentFichaId];
            if (!ficha) return (nivelData.find(data => data.nivel === nivel) || nivelData[0]).ph;

            let phBase;

            if (ficha.gmOverrides?.['pontos-vantagem'] !== undefined) {
                phBase = parseInt(ficha.gmOverrides['pontos-vantagem']);
            } else {
                phBase = (nivelData.find(data => data.nivel === nivel) || nivelData[0]).ph;
            }

            vantagensSelecionadas.forEach(vNome => {
                const vantagem = vantagensData.find(d => d.nome === vNome); if (vantagem) phBase -= vantagem.custo;
            });
            desvantagensSelecionadas.forEach(dNome => {
                const desvantagem = desvantagensData.find(desv => desv.nome === dNome); if (desvantagem) phBase += desvantagem.ganho;
            });
            if (racaSelecionada) {
                const raca = racasData.find(r => r.nome === racaSelecionada); if (raca) phBase -= raca.custo;
            }
            return phBase;
        }


        function calcularPontosVantagemTemp() {
            const ficha = fichas[currentFichaId];
            if (!ficha) return (nivelData.find(data => data.nivel === nivel) || nivelData[0]).ph;

            let ph;

            if (ficha.gmOverrides?.['pontos-vantagem'] !== undefined) {
                ph = parseInt(ficha.gmOverrides['pontos-vantagem']);
            } else {
                ph = (nivelData.find(data => data.nivel === nivel) || nivelData[0]).ph;
            }

            tempVantagensSelecionadas.forEach(vNome => {
                const vantagem = vantagensData.find(d => d.nome === vNome); if (vantagem) ph -= vantagem.custo;
            });
            tempDesvantagensSelecionadas.forEach(dNome => {
                const desvantagem = desvantagensData.find(desv => desv.nome === dNome); if (desvantagem) ph += desvantagem.ganho;
            });
            if (tempRacaSelecionada) {
                const raca = racasData.find(r => r.nome === tempRacaSelecionada); if (raca) ph -= raca.custo;
            }
            return ph;
        }

        function aumentarVida() {
            let val = parseInt(vidaAtualInput.value);
            if (val < vidaTotal) {
                val++;
                vidaAtual = val;
                vidaAtualInput.value = vidaAtual;
                salvarDados();
            }
        }
        function diminuirVida() {
            let val = parseInt(vidaAtualInput.value);
            if (val > 0) {
                val--;
                vidaAtual = val;
                vidaAtualInput.value = vidaAtual;
                salvarDados();
            }
        }
        function aumentarMagia() {
            let val = parseInt(magiaAtualInput.value);
            if (val < magiaTotal) {
                val++;
                magiaAtual = val;
                magiaAtualInput.value = magiaAtual;
                salvarDados();
            }
        }
        function diminuirMagia() {
            let val = parseInt(magiaAtualInput.value);
            if (val > 0) {
                val--;
                magiaAtual = val;
                magiaAtualInput.value = magiaAtual;
                salvarDados();
            }
        }
        function aumentarVigor() {
            let val = parseFloat(vigorAtualInput.value);
            if (val < vigorTotal) {
                val = Math.min(val + 0.1, vigorTotal);
                vigorAtual = val;
                vigorAtualInput.value = vigorAtual.toFixed(1);
                salvarDados();
            }
        }
        function diminuirVigor() {
            let val = parseFloat(vigorAtualInput.value);
            if (val > 0) {
                val = Math.max(val - 0.1, 0);
                vigorAtual = val;
                vigorAtualInput.value = vigorAtual.toFixed(1);
                salvarDados();
            }
        }

        function calcularAtributos() {
            const ficha = fichas[currentFichaId];
            if (!ficha) return;

            let pdGastosPeloJogador = 0;
            atributosInputs.forEach(input => {
                 pdGastosPeloJogador += parseInt(input.value) || 0;
            });

            const pdTotalDisponivel = ficha.gmOverrides?.['pontos-habilidade'] !== undefined ?
                                 parseInt(ficha.gmOverrides['pontos-habilidade']) :
                                 (nivelData.find(data => data.nivel === nivel) || nivelData[0]).pd;

            if (pdGastosPeloJogador > pdTotalDisponivel && ficha.gmOverrides?.['pontos-habilidade'] === undefined) {
                alert("Pontos de habilidade insuficientes! Os valores dos atributos serÃ£o revertidos para o estado anterior vÃ¡lido ou valor mÃ­nimo salvo.");

                atributosInputs.forEach(input => {
                    const lockedValueForThisAttr = (ficha.lockedAtributos && ficha.lockedAtributos[input.id] !== undefined)
                                                  ? ficha.lockedAtributos[input.id]
                                                  : 0;
                    const valueBeforeThisInputEvent = parseInt(previousValues.get(input)) || 0;
                    input.value = Math.max(lockedValueForThisAttr, valueBeforeThisInputEvent);
                });

                pdGastosPeloJogador = 0;
                atributosInputs.forEach(input => {
                    pdGastosPeloJogador += parseInt(input.value) || 0;
                });
            }
            pontosHabilidadeUsados = pdGastosPeloJogador;
            pontosHabilidadeSpan.textContent = pdTotalDisponivel - pontosHabilidadeUsados;

            if (pdGastosPeloJogador > pdTotalDisponivel && ficha.gmOverrides?.['pontos-habilidade'] === undefined) {
                 atributosInputs.forEach(input => {
                    previousValues.set(input, input.value);
                });
            }


            let currentForca = parseInt(forcaInput.value) || 0;
            let currentDestreza = parseInt(destrezaInput.value) || 0;
            let currentAgilidade = parseInt(agilidadeInput.value) || 0;
            let currentInteligencia = parseInt(inteligenciaInput.value) || 0;
            let currentConstituicao = parseInt(constituicaoInput.value) || 0;

            let calcAtaque = currentForca + Math.floor(currentDestreza / 5) + (parseInt(armaDireitaAtaqueInput.value) || 0) + (parseInt(armaEsquerdaAtaqueInput.value) || 0);
            let calcAtaqueMagico = currentInteligencia + (parseInt(armaDireitaAtaqueMagicoInput.value) || 0) + (parseInt(armaEsquerdaAtaqueMagicoInput.value) || 0);
            let calcAcerto = Math.floor(currentDestreza / 3) + Math.floor(currentAgilidade / 10);
            let calcEsquiva = Math.floor(currentAgilidade / 3);
            let calcRdf = Math.floor(currentForca / 5);
            let calcRdm = Math.floor(currentInteligencia / 5);

            const capacidadeBase = 5;
            const bonusForcaCarga = Math.floor(currentForca / 5);
            const capacidadeCargaCalculada = capacidadeBase + bonusForcaCarga;
            const capacidadeCargaFinal = ficha.gmOverrides?.['capacidade-carga'] !== undefined ?
                                        parseInt(ficha.gmOverrides['capacidade-carga']) :
                                        capacidadeCargaCalculada;
            if (capacidadeCargaSpan) capacidadeCargaSpan.textContent = capacidadeCargaFinal;

            const pesoTotalAtual = parseFloat(pesoTotalSpan.textContent) || 0;
            let penalidadeEsquivaAcerto = 0;
            const sobrecarga = pesoTotalAtual - capacidadeCargaFinal;

            if (sobrecarga > 0) {
                penalidadeEsquivaAcerto = -1;
                const sobrecargaAdicional = sobrecarga - 3;
                if (sobrecargaAdicional > 0) {
                    penalidadeEsquivaAcerto -= Math.ceil(sobrecargaAdicional / 3);
                }
                calcAcerto += penalidadeEsquivaAcerto;
                calcEsquiva += penalidadeEsquivaAcerto;
                if (pesoTotalSpan && capacidadeCargaSpan) {
                    pesoTotalSpan.style.color = 'red'; capacidadeCargaSpan.style.color = 'red';
                }
            } else {
                if (pesoTotalSpan && capacidadeCargaSpan) {
                    pesoTotalSpan.style.color = ''; capacidadeCargaSpan.style.color = '';
                }
            }

            ataqueSpan.textContent = ficha.gmOverrides?.ataque !== undefined ? ficha.gmOverrides.ataque : calcAtaque;
            ataqueMagicoSpan.textContent = ficha.gmOverrides?.['ataque-magico'] !== undefined ? ficha.gmOverrides['ataque-magico'] : calcAtaqueMagico;
            acertoSpan.textContent = ficha.gmOverrides?.acerto !== undefined ? ficha.gmOverrides.acerto : calcAcerto;
            esquivaSpan.textContent = ficha.gmOverrides?.esquiva !== undefined ? ficha.gmOverrides.esquiva : calcEsquiva;
            rdfSpan.textContent = ficha.gmOverrides?.rdf !== undefined ? ficha.gmOverrides.rdf : calcRdf;
            rdmSpan.textContent = ficha.gmOverrides?.rdm !== undefined ? ficha.gmOverrides.rdm : calcRdm;

            const velCorridaBase = 25 + Math.floor(currentAgilidade / 3) * 3;
            const altPuloBase = 1 + Math.floor(currentForca / 10);
            const distPuloBase = 3 + 3 * Math.min(Math.floor(currentForca / 5), Math.floor(currentAgilidade / 5));
            let bonusVelocidade = vantagensSelecionadas.includes("Combo FÃ­sico (4)") ? 25 : 0;
            let bonusAlturaPulo = vantagensSelecionadas.includes("Combo FÃ­sico (4)") ? 2 : 0;
            let bonusDistanciaPulo = vantagensSelecionadas.includes("Combo FÃ­sico (4)") ? 6 : 0;

            velocidadeCorridaSpan.textContent = ficha.gmOverrides?.['velocidade-corrida'] !== undefined ? ficha.gmOverrides['velocidade-corrida'] : (velCorridaBase + bonusVelocidade);
            alturaPuloSpan.textContent = ficha.gmOverrides?.['altura-pulo'] !== undefined ? ficha.gmOverrides['altura-pulo'] : (altPuloBase + bonusAlturaPulo);
            distanciaPuloSpan.textContent = ficha.gmOverrides?.['distancia-pulo'] !== undefined ? ficha.gmOverrides['distancia-pulo'] : (distPuloBase + bonusDistanciaPulo);

            let vidaBaseCalculada = 50 + (currentConstituicao * (3 + Math.floor(currentForca / 10))) + 10 * nivel;
            let magiaBaseCalculada = 20 + 3 * currentConstituicao;
            if (currentInteligencia >= 10) magiaBaseCalculada += currentConstituicao * Math.floor(currentInteligencia / 10);
            let vigorBaseCalculado = 10 + 0.4 * currentConstituicao;

            vidaTotal = ficha.gmOverrides?.['vida-total'] !== undefined ? parseInt(ficha.gmOverrides['vida-total']) : Math.ceil(vidaBaseCalculada);
            magiaTotal = ficha.gmOverrides?.['magia-total'] !== undefined ? parseInt(ficha.gmOverrides['magia-total']) : Math.ceil(magiaBaseCalculada);
            vigorTotal = ficha.gmOverrides?.['vigor-total'] !== undefined ? parseFloat(ficha.gmOverrides['vigor-total']) : parseFloat(vigorBaseCalculado.toFixed(1));

            document.getElementById("vida-total").textContent = vidaTotal;
            document.getElementById("magia-total").textContent = magiaTotal;
            document.getElementById("vigor-total").textContent = vigorTotal.toFixed(1);

            vidaAtualInput.max = vidaTotal;
            magiaAtualInput.max = magiaTotal;
            vigorAtualInput.max = vigorTotal;

            vidaAtual = Math.min(parseInt(vidaAtualInput.value) || 0, vidaTotal);
            magiaAtual = Math.min(parseInt(magiaAtualInput.value) || 0, magiaTotal);
            vigorAtual = Math.min(parseFloat(vigorAtualInput.value) || 0, vigorTotal);
            vidaAtualInput.value = vidaAtual;
            magiaAtualInput.value = magiaAtual;
            vigorAtualInput.value = vigorAtual.toFixed(1);

            document.getElementById("regeneracao-vida").textContent = (0.2 * currentConstituicao).toFixed(1);
            document.getElementById("regeneracao-magia").textContent = (0.8 * currentConstituicao).toFixed(1);
            document.getElementById("regeneracao-vigor").textContent = (0.4 * currentConstituicao).toFixed(1);

            const atributosSpansList = [{ span: ataqueSpan, valor: parseFloat(ataqueSpan.textContent) || 0 }, { span: ataqueMagicoSpan, valor: parseFloat(ataqueMagicoSpan.textContent) || 0 }, { span: acertoSpan, valor: parseFloat(acertoSpan.textContent) || 0 }, { span: esquivaSpan, valor: parseFloat(esquivaSpan.textContent) || 0 }, { span: rdfSpan, valor: parseFloat(rdfSpan.textContent) || 0 }, { span: rdmSpan, valor: parseFloat(rdmSpan.textContent) || 0 }];
            atributosSpansList.forEach(a => a.span.classList.remove("atributo-fogo"));
            const maxAtributo = atributosSpansList.reduce((prev, curr) => prev.valor > curr.valor ? prev : curr, { valor: -Infinity });
            if (maxAtributo.valor > 0) maxAtributo.span.classList.add("atributo-fogo");
        }


        function resetarPontos() {
            if (isFichaLocked && !isFichaUnlocked) return abrirModalSenha(resetPontosButton);
            senhaGmTitulo.textContent = "PeÃ§a permissÃ£o ao GM para Resetar Pontos";
            document.getElementById("senha-gm-modal").style.display = "flex";
            document.getElementById("senha-gm-input").value = "";
            document.getElementById("confirmar-senha-gm-btn").onclick = () => {
                if (document.getElementById("senha-gm-input").value === senhaMatriz) {
                    const ficha = fichas[currentFichaId];
                    if (ficha) {
                        atributosInputs.forEach(input => {
                            input.value = 0;
                        });
                        ficha.lockedAtributos = { forca: 0, destreza: 0, agilidade: 0, constituicao: 0, inteligencia: 0 };
                    }
                    pontosHabilidadeUsados = 0;
                    if (salvarAtributosBtnEl) salvarAtributosBtnEl.style.display = "none";
                    atualizarNivel();
                    salvarDados();
                    fecharModal("senha-gm-modal");
                } else { alert("Senha do GM incorreta!"); fecharModal("senha-gm-modal"); }
            };
        }

        function recomecarFicha() {
             if (isFichaLocked && !isFichaUnlocked) return abrirModalSenha(recomecarButton);
            if (confirm("Tem certeza que deseja recomeÃ§ar a ficha? Todas as alteraÃ§Ãµes serÃ£o perdidas.")) {
                const ficha = fichas[currentFichaId];
                if (ficha) {
                    ficha.gmOverrides = {};
                    atributosInputs.forEach(input => {
                        input.value = "0";
                    });
                    ficha.lockedAtributos = { forca: 0, destreza: 0, agilidade: 0, constituicao: 0, inteligencia: 0 };
                }
                if (salvarAtributosBtnEl) salvarAtributosBtnEl.style.display = "none";


                experienciaInput.value = "0";
                experiencia = 0;
                nivel = 0;

                experienciaInput.readOnly = true;
                xpLockIcon.textContent = 'ðŸ”’';
                isXpUnlocked = false;
                if (xpUnlockTimerId) clearTimeout(xpUnlockTimerId);

                pontosHabilidadeUsados = 0;

                nomePersonagemInput.value = ""; descricaoPersonagemInput.value = "";
                armaDireitaNomeInput.value = ""; armaDireitaAtaqueInput.value = "0"; armaDireitaAtaqueMagicoInput.value = "0";
                armaEsquerdaNomeInput.value = ""; armaEsquerdaAtaqueInput.value = "0"; armaEsquerdaAtaqueMagicoInput.value = "0";
                magiasList.innerHTML = ""; for (let i = 0; i < 10; i++) { const input = document.createElement("input"); input.type = "text"; input.className = "magia-nome"; input.placeholder = `Magia/Habilidade ${i + 1}`; input.addEventListener('input', salvarDados); magiasList.appendChild(input); }
                const slots = inventarioSlots.querySelectorAll(".inventory-slot"); slots.forEach(slot => { slot.querySelector(".inventory-item").value = ""; slot.querySelector(".inventory-weight").value = "0"; });
                characterImage.style.display = "none"; characterImage.src = ""; vantagensSelecionadas = []; desvantagensSelecionadas = []; racaSelecionada = null;
                vantagensListDisplay.innerHTML = ""; desvantagensListDisplay.innerHTML = ""; anotacoesTextarea.value = "";
                classeNomeInput.value = ""; classeDescricaoInput.value = ""; racaNomeSpan.textContent = ""; racaDescricaoInput.value = "";

                const currentFichaObject = fichas[currentFichaId] || {};
                currentFichaObject.darkMode = document.body.classList.contains('dark-mode');

                currentFichaObject.diceRolls = [];
                currentFichaObject.collapsedSections = {};
                currentFichaObject.backgroundColor = null;
                currentFichaObject.fichaInternalBackgroundColor = null;
                currentFichaObject.fichaTransparencyLevel = 100;
                currentFichaObject.corBordaSecao = '#b8860b';
                currentFichaObject.estiloBordaSecao = 'solid';
                currentFichaObject.larguraBordaSecao = '2px';
                currentFichaObject.texturaDado = null;
                currentFichaObject.animacaoDado = 'padrao';
                currentFichaObject.diceColor = null;
                currentFichaObject.diceNumberColor = null;
                currentFichaObject.fontFamily = "'Inter', sans-serif";
                currentFichaObject.backgroundImage = null;
                currentFichaObject.backgroundSize = 'cover';
                currentFichaObject.backgroundAttachment = 'scroll';
                currentFichaObject.shadowColorFicha = '#000000';
                currentFichaObject.shadowIntensityFicha = 0;
                currentFichaObject.theme = 'theme-medieval';

                limparClassesDeTema();
                document.body.classList.add('theme-medieval');

                aplicarPlanoDeFundoInicial(currentFichaObject);
                aplicarEstilosFichaInicial(currentFichaObject);
                aplicarCustomizacoesDadoInicial(currentFichaObject);
                aplicarFonteInicial(currentFichaObject);
                aplicarCoresDadoInicial(currentFichaObject);
                aplicarEstilosDeFundoVisuais();
                aplicarEstilosDeSombra();
                aplicarEstadoColapsoSecoes({});

                atualizarNivel();

                vidaAtualInput.value = vidaTotal;
                magiaAtualInput.value = magiaTotal;
                vigorAtualInput.value = vigorTotal.toFixed(1);
                vidaAtual = vidaTotal;
                magiaAtual = magiaTotal;
                vigorAtual = vigorTotal;

                if (customizacaoModal.style.display === "flex") {
                    if(fichaTransparencySlider) fichaTransparencySlider.value = 100;
                    if(fichaTransparencyValueSpan) fichaTransparencyValueSpan.textContent = "100";
                    if(shadowColorFichaInput) shadowColorFichaInput.value = '#000000';
                    if(shadowIntensityFichaSlider) shadowIntensityFichaSlider.value = 0;
                    if(shadowIntensityFichaValueSpan) shadowIntensityFichaValueSpan.textContent = "0";
                }

                salvarDados();
            }
        }

        bloquearFichaButton.onclick = () => {
            if (isFichaLocked) abrirModalSenha();
            else { document.getElementById("bloquear-ficha-modal").style.display = "flex"; document.getElementById("senha-bloqueio-input").value = ""; document.getElementById("senha-bloqueio-input").focus(); }
        };

        function bloquearFicha() {
            const senha = document.getElementById("senha-bloqueio-input").value;
            if (senha.length !== 4 || !/^\d{4}$/.test(senha)) return alert("A senha deve ter exatamente 4 dÃ­gitos numÃ©ricos!");
            isFichaLocked = true; fichaPassword = senha;
            fichas[currentFichaId].isLocked = true;
            fichas[currentFichaId].password = senha;
            saveFichasToStorage(fichas);
            fecharModal("bloquear-ficha-modal"); alert("Ficha bloqueada com sucesso!"); atualizarBotaoBloquear();
        }

        function abrirModalSenha(element = null, callbackSuccess = null) {
            const modal = document.getElementById("password-modal");
            modal.style.display = "flex";
            document.getElementById("senha-desbloqueio-input").value = "";
            document.getElementById("senha-desbloqueio-input").focus();

            if (element) modal.dataset.elementId = element.id;
            else delete modal.dataset.elementId;

            modal.callbackSuccess = callbackSuccess;
        }


        function desbloquearFicha() {
            const senha = document.getElementById("senha-desbloqueio-input").value;
            const modal = document.getElementById("password-modal");
            const elementId = modal.dataset.elementId;
            const originalButton = elementId ? document.getElementById(elementId) : null;
            const callback = modal.callbackSuccess;

            if (senha !== senhaMatriz && senha !== fichaPassword) return alert("Senha incorreta!");

            isFichaUnlocked = true;

            if (currentFichaId !== FICHA_MATRIZ_ID && senha !== senhaMatriz) {
                if(confirm("Senha correta! Deseja desbloquear a ficha permanentemente? (Cancelar para desbloqueio temporÃ¡rio)")) {
                     isFichaLocked = false; fichaPassword = null;
                     fichas[currentFichaId].isLocked = false;
                     fichas[currentFichaId].password = null;
                     saveFichasToStorage(fichas);
                     fecharModal("password-modal"); alert("Ficha desbloqueada permanentemente!"); atualizarBotaoBloquear();
                     if (callback) callback();
                     else if (originalButton && typeof originalButton.onclick === 'function' && !originalButton.id.startsWith('btn-')) {
                        originalButton.click();
                     }
                } else {
                     fecharModal("password-modal"); alert("Ficha desbloqueada temporariamente!");
                     if (callback) callback();
                     else if (originalButton && typeof originalButton.onclick === 'function' && !originalButton.id.startsWith('btn-')) {
                        originalButton.click();
                     }
                }
            } else {
                fecharModal("password-modal");
                alert(`Ficha desbloqueada temporariamente ${senha === senhaMatriz ? 'com a senha matriz!' : ''}`);
                if (callback) callback();
                else if (originalButton && typeof originalButton.onclick === 'function' && !originalButton.id.startsWith('btn-')) {
                   originalButton.click();
                }
            }
             delete modal.callbackSuccess;
        }

        function cancelarDesbloqueio() {
            const modal = document.getElementById("password-modal");
            const elementId = modal.dataset.elementId;
            const inputElement = elementId ? document.getElementById(elementId) : null;

            if (inputElement && inputElement.tagName === 'INPUT' && previousValues.has(inputElement)) {
                 inputElement.value = previousValues.get(inputElement) || inputElement.defaultValue || "";
                 if (atributosInputs.includes(inputElement)) {
                    calcularAtributos();
                }
            }
            delete modal.callbackSuccess;
            fecharModal("password-modal");
        }


        document.querySelectorAll('input[type="text"]:not(#forca):not(#destreza):not(#agilidade):not(#inteligencia):not(#constituicao), input[type="number"]:not(#forca):not(#destreza):not(#agilidade):not(#inteligencia):not(#constituicao):not(#experiencia):not(.recurso-atual-input), textarea').forEach(input => {
            input.addEventListener("focus", (event) => {
                 previousValues.set(event.target, event.target.value);
            });
            input.addEventListener("input", (event) => {
                const inputTarget = event.target;
                if (isFichaLocked && !isFichaUnlocked && currentFichaId !== FICHA_MATRIZ_ID) {
                    inputTarget.value = previousValues.get(inputTarget) || inputTarget.defaultValue || "";
                    abrirModalSenha(inputTarget);
                    return;
                }
                if (inputTarget.id.includes("arma")) {
                    calcularAtributos();
                } else if (inputTarget.classList.contains('inventory-weight')) {
                    calcularPesoTotal();
                    calcularAtributos();
                }
                salvarDados();
            });
        });
        nomePersonagemInput.oninput = salvarDados;

        atributosInputs.forEach(input => {
            input.addEventListener("focus", (event) => {
                 previousValues.set(event.target, event.target.value);
            });
            input.addEventListener("input", (event) => {
                const inputTarget = event.target;
                const ficha = fichas[currentFichaId];

                if (!ficha) return;
                if (isFichaLocked && !isFichaUnlocked && currentFichaId !== FICHA_MATRIZ_ID) {
                    inputTarget.value = previousValues.get(inputTarget) || ((ficha.lockedAtributos && ficha.lockedAtributos[inputTarget.id]) || "0");
                    abrirModalSenha(inputTarget);
                    return;
                }

                let currentValue = parseInt(inputTarget.value) || 0;
                const lockedValue = (ficha.lockedAtributos && ficha.lockedAtributos[inputTarget.id] !== undefined)
                                    ? ficha.lockedAtributos[inputTarget.id]
                                    : 0;

                if (currentValue < lockedValue && !isGmModeActive) { // MODIFIED: Added !isGmModeActive
                    alert(`O valor de ${inputTarget.labels[0].textContent.replace(":", "")} nÃ£o pode ser menor que o valor salvo: ${lockedValue}.`);
                    inputTarget.value = lockedValue;
                }


                if (salvarAtributosBtnEl) {
                    let hasChangesToSave = false;
                    for (const attrInp of atributosInputs) {
                        const currentVal = parseInt(attrInp.value) || 0;
                        const lockedVal = (ficha.lockedAtributos && ficha.lockedAtributos[attrInp.id] !== undefined)
                                          ? ficha.lockedAtributos[attrInp.id]
                                          : 0;
                        if (currentVal > lockedVal) {
                            hasChangesToSave = true;
                            break;
                        }
                    }
                    salvarAtributosBtnEl.style.display = hasChangesToSave ? "inline-block" : "none";
                }

                calcularAtributos();
                salvarDados();
            });
        });


        [vidaAtualInput, magiaAtualInput, vigorAtualInput].forEach(input => {
            input.addEventListener('input', (event) => {
                if (isFichaLocked && !isFichaUnlocked && currentFichaId !== FICHA_MATRIZ_ID) {
                    event.target.value = previousValues.get(event.target) || event.target.defaultValue;
                    abrirModalSenha(event.target);
                    return;
                }

                let value;
                let minVal = 0;
                let maxVal;

                if (event.target === vidaAtualInput) {
                    value = parseInt(event.target.value);
                    maxVal = vidaTotal;
                    if (value > maxVal) value = maxVal;
                    if (value < minVal) value = minVal;
                    if (isNaN(value)) value = vidaAtual;
                    vidaAtual = value;
                    event.target.value = vidaAtual;
                } else if (event.target === magiaAtualInput) {
                    value = parseInt(event.target.value);
                    maxVal = magiaTotal;
                    if (value > maxVal) value = maxVal;
                    if (value < minVal) value = minVal;
                    if (isNaN(value)) value = magiaAtual;
                    magiaAtual = value;
                    event.target.value = magiaAtual;
                } else if (event.target === vigorAtualInput) {
                    value = parseFloat(event.target.value);
                    maxVal = vigorTotal;
                    if (value > maxVal) value = maxVal;
                    if (value < minVal) value = minVal;
                    if (isNaN(value)) value = vigorAtual;
                    vigorAtual = parseFloat(value.toFixed(1));
                    event.target.value = vigorAtual.toFixed(1);
                }
                salvarDados();
            });
            input.addEventListener('focus', (event) => {
                 previousValues.set(event.target, event.target.value);
            });
        });


        experienciaInput.addEventListener('focus', (event) => {
            previousValues.set(event.target, event.target.value);
            if (experienciaInput.readOnly && !isXpUnlocked) {
                event.preventDefault();
                senhaGmTitulo.textContent = "Desbloquear Campo de ExperiÃªncia";
                document.getElementById("senha-gm-modal").style.display = "flex";
                document.getElementById("senha-gm-input").value = "";
                document.getElementById("senha-gm-input").focus();
                document.getElementById("confirmar-senha-gm-btn").onclick = () => confirmarDesbloqueioExperiencia();
            }
        });

        experienciaInput.addEventListener('input', (event) => {
            if (!experienciaInput.readOnly) {
                experiencia = parseInt(event.target.value) || 0;
                 if (fichas[currentFichaId] && fichas[currentFichaId].gmOverrides) {
                    delete fichas[currentFichaId].gmOverrides.nivel;
                }
                atualizarNivel();
                salvarDados();
            } else {
                event.target.value = previousValues.get(event.target) || "0";
            }
        });


        function confirmarDesbloqueioExperiencia() {
            if (document.getElementById("senha-gm-input").value === senhaMatriz) {
                experienciaInput.readOnly = false;
                xpLockIcon.textContent = 'ðŸ”“';
                isXpUnlocked = true;
                experienciaInput.focus();
                showNotification("Campo de experiÃªncia desbloqueado por 20 segundos.", "normal-result");

                if (xpUnlockTimerId) clearTimeout(xpUnlockTimerId);
                xpUnlockTimerId = setTimeout(() => {
                    experienciaInput.readOnly = true;
                    xpLockIcon.textContent = 'ðŸ”’';
                    isXpUnlocked = false;
                    alert("Tempo para editar experiÃªncia expirou. Insira a senha novamente se precisar.");
                    if (fichas[currentFichaId]) {
                        fichas[currentFichaId].experiencia = experienciaInput.value;
                        saveFichasToStorage(fichas);
                    }
                }, XP_UNLOCK_DURATION_MS);
                fecharModal("senha-gm-modal");
            } else {
                alert("Senha do GM incorreta!");
                fecharModal("senha-gm-modal");
            }
        }


        characterImageInput.onchange = e => {
            const file = e.target.files[0]; if (file) { const reader = new FileReader(); reader.onload = e => { characterImage.src = e.target.result; characterImage.style.display = "block"; salvarDados(); }; reader.readAsDataURL(file); }
        };
        document.getElementById("excluir-ficha").onclick = () => {
            if (currentFichaId === FICHA_MATRIZ_ID) return alert("A ficha matriz nÃ£o pode ser excluÃ­da!");
            if (isFichaLocked && !isFichaUnlocked) return abrirModalSenha(document.getElementById("excluir-ficha"));
            if (confirm("Tem certeza que deseja excluir esta ficha?")) {
                delete fichas[currentFichaId];
                saveFichasToStorage(fichas);
                currentFichaId = FICHA_MATRIZ_ID;
                saveCurrentFichaIdToStorage(currentFichaId);
                carregarFicha(currentFichaId);
                atualizarAbasFichas();
            }
        };
        let isDragging = false, currentX = 0, currentY = 0, initialX, initialY;

        diceContainer.onmousedown = e => { isDragging = true; initialX = e.clientX - currentX; initialY = e.clientY - currentY; diceContainer.style.cursor = "grabbing"; };
        document.onmousemove = e => { if (isDragging) { e.preventDefault(); currentX = e.clientX - initialX; currentY = e.clientY - initialY; diceContainer.style.left = `${currentX}px`; diceContainer.style.top = `${currentY}px`; diceContainer.style.right = "auto"; } };
        document.onmouseup = () => { if(isDragging) {isDragging = false; diceContainer.style.cursor = "move";} };

        diceRoll.onclick = () => {
            if (isDiceRolling || (isFichaLocked && !isFichaUnlocked)) {
                if (isFichaLocked && !isFichaUnlocked) abrirModalSenha(diceRoll);
                return;
            }
            isDiceRolling = true;
            diceRoll.textContent = "...";

            diceRoll.classList.remove('is-rolling', 'is-rolling-fast', 'is-rolling-jump', 'critical-failure', 'critical-success');
            diceResult.style.display = "none";

            const animacaoSelecionada = fichas[currentFichaId]?.animacaoDado || 'padrao';
            let classeAnimacao = 'is-rolling';
            let duracaoAnimacao = 1000;

            if (animacaoSelecionada === 'rapido') {
                classeAnimacao = 'is-rolling-fast';
                duracaoAnimacao = 500;
            } else if (animacaoSelecionada === 'salto') {
                classeAnimacao = 'is-rolling-jump';
                duracaoAnimacao = 1200;
            }
            diceRoll.classList.add(classeAnimacao);

            setTimeout(() => {
                const roll = Math.floor(Math.random() * currentDiceMax) + 1;
                const fichaNome = (fichas[currentFichaId] ? fichas[currentFichaId].nomeFicha : "Ficha") || "Ficha";
                diceRoll.classList.remove(classeAnimacao);
                diceRoll.textContent = roll;

                // NEW: Bonus Roll Logic
                if (selectedAttributeIcon) {
                    const attributeSourceId = selectedAttributeIcon.dataset.attributeSource;
                    const sourceElement = document.getElementById(attributeSourceId);
                    let attributeValue = 0;
                    if (sourceElement) {
                        attributeValue = parseInt(sourceElement.value || sourceElement.textContent) || 0;
                    }
                    const totalSum = attributeValue + roll;
                    showSpecialRollResult(attributeValue, roll, totalSum);

                    selectedAttributeIcon.classList.remove('selected');
                    selectedAttributeIcon = null;

                } else {
                     // ORIGINAL: No bonus selected
                    let notificationClass = "normal-result";
                    let notificationMsg = `${fichaNome} rolou D${currentDiceMax}: ${roll}`;

                    if (roll === 1) {
                        diceRoll.classList.add("critical-failure");
                        notificationClass = "critical-failure";
                        notificationMsg = `${fichaNome} - D${currentDiceMax}: FALHA CRÃTICA!`;
                    } else if (roll === currentDiceMax) {
                        diceRoll.classList.add("critical-success");
                        notificationClass = "critical-success";
                        notificationMsg = `${fichaNome} - D${currentDiceMax}: SUCESSO CRÃTICO!`;
                    }
                    showNotification(notificationMsg, notificationClass, 2000);
                }


                if (fichas[currentFichaId]) {
                    const now = new Date();
                    const timestamp = now.toLocaleString('pt-BR', {
                        day: '2-digit', month: '2-digit', year: 'numeric',
                        hour: '2-digit', minute: '2-digit', second: '2-digit'
                    });
                    fichas[currentFichaId].diceRolls = fichas[currentFichaId].diceRolls || [];
                    fichas[currentFichaId].diceRolls.unshift({
                        type: `D${currentDiceMax}`,
                        result: roll,
                        timestamp: timestamp
                    });
                    if (fichas[currentFichaId].diceRolls.length > 100) {
                        fichas[currentFichaId].diceRolls.pop();
                    }
                    salvarDados();
                }
                isDiceRolling = false;
            }, duracaoAnimacao);
        };

        changeDiceTypeBtn.addEventListener('click', (event) => {
            event.stopPropagation();
            if (isDiceRolling) return;
            diceOptionsMenu.style.display = diceOptionsMenu.style.display === 'flex' ? 'none' : 'flex';
        });

        document.querySelectorAll('.dice-option-btn').forEach(button => {
            button.addEventListener('click', () => {
                if (isDiceRolling) return;
                currentDiceMax = parseInt(button.dataset.diceMax);
                changeDiceTypeBtn.textContent = `D${currentDiceMax}`;
                diceOptionsMenu.style.display = 'none';
                diceRoll.textContent = '-';
                diceRoll.classList.remove("critical-failure", "critical-success");
            });
        });

        document.addEventListener('click', function(event) {
            const target = event.target;
            // NEW: Event delegation for attribute dice icons
            if (target.matches('.attribute-dice-icon')) {
                handleAttributeDiceClick(target);
                return;
            }

            if (diceOptionsMenu.style.display === 'flex' &&
                !diceOptionsMenu.contains(event.target) &&
                event.target !== changeDiceTypeBtn) {
                diceOptionsMenu.style.display = 'none';
            }
            if (anotacoesTextarea.style.display === 'block' &&
                !anotacoesTextarea.contains(event.target) &&
                event.target !== anotacoesBtn) {
                anotacoesTextarea.style.display = 'none';
            }
            if (diceHistoryPanel.style.display === 'flex' &&
                !diceHistoryPanel.contains(event.target) &&
                event.target !== diceHistoryTrigger) {
                diceHistoryPanel.style.display = 'none';
            }
        });


        vantagensDesvantagensBtn.onclick = () => {
            if (isFichaLocked && !isFichaUnlocked) return abrirModalSenha(vantagensDesvantagensBtn);
            tempVantagensSelecionadas = [...vantagensSelecionadas]; tempDesvantagensSelecionadas = [...desvantagensSelecionadas];
            vantagensDesvantagensPanel.style.display = "block"; document.getElementById("salvar-vantagens-btn").style.display = "none"; atualizarVantagensDesvantagensPanel();
        };
        fecharPaginaBtn.onclick = () => { vantagensDesvantagensPanel.style.display = "none"; };
        salvarVantagensBtn.onclick = () => {
             document.getElementById("salvar-modal-texto").textContent = "Se salvar, as alteraÃ§Ãµes de Vantagens/Desvantagens nÃ£o poderÃ£o ser desfeitas.";
             document.getElementById("salvar-vantagens-modal").style.display = "flex";
        };
         salvarRacasBtn.onclick = () => {
             document.getElementById("salvar-modal-texto").textContent = "Se salvar, a alteraÃ§Ã£o de RaÃ§a nÃ£o poderÃ¡ ser desfeita.";
             document.getElementById("salvar-vantagens-modal").style.display = "flex";
        };

        confirmarSalvarBtn.onclick = () => {
            if (racasPanel.style.display === "block") {
                if (tempRacaSelecionada && tempRacaSelecionada !== racaSelecionada) {
                    const raca = racasData.find(r => r.nome === tempRacaSelecionada);
                    if (raca && calcularPontosVantagemTemp() >= 0) {
                        racaSelecionada = tempRacaSelecionada;
                        racaNomeSpan.textContent = racaSelecionada.split(" (")[0];
                        racaDescricaoInput.value = raca.vantagens.join("\n\n");
                        racasPanel.style.display = "none";
                        atualizarNivel();
                        salvarDados();
                    } else if (raca){
                        alert("Pontos de Vantagem insuficientes para confirmar esta raÃ§a!");
                    }
                } else {
                    racasPanel.style.display = "none";
                }
            } else if (vantagensDesvantagensPanel.style.display === "block") {
                if (tempDesvantagensSelecionadas.length > 3) {
                     alert("VocÃª pode ter no mÃ¡ximo 3 desvantagens!");
                     fecharModal("salvar-vantagens-modal");
                     return;
                }
                if (calcularPontosVantagemTemp() < 0) {
                     alert("Pontos de Vantagem insuficientes com as vantagens selecionadas!");
                     fecharModal("salvar-vantagens-modal");
                     return;
                }

                vantagensSelecionadas = [...tempVantagensSelecionadas];
                desvantagensSelecionadas = [...tempDesvantagensSelecionadas];
                vantagensListDisplay.innerHTML = ""; desvantagensListDisplay.innerHTML = "";
                vantagensSelecionadas.forEach(v => { const div = document.createElement("div"); div.textContent = v; div.className = "list-item"; div.onclick = () => removerVantagem(v); vantagensListDisplay.appendChild(div); });
                desvantagensSelecionadas.forEach(d => { const div = document.createElement("div"); div.textContent = d; div.className = "list-item"; div.onclick = () => removerDesvantagem(d); desvantagensListDisplay.appendChild(div); });

                vantagensDesvantagensPanel.style.display = "none";
                atualizarNivel();
                salvarDados();
            }
            fecharModal("salvar-vantagens-modal");
        };


        function atualizarVantagensDesvantagensPanel() {
            vantagensList.innerHTML = "<h3>Vantagens</h3>"; desvantagensList.innerHTML = "<h3>Desvantagens</h3>";
            vantagensData.forEach(v => {
                const div = document.createElement("div"); div.className = "vantagem-item"; div.textContent = `${v.nome} - Custo: ${v.custo} PH - ${v.descricao}`;
                if (tempVantagensSelecionadas.includes(v.nome)) div.classList.add("comprada");
                div.onclick = () => {
                    if (vantagensSelecionadas.includes(v.nome)) alert("Vantagem salva sÃ³ pode ser removida com permissÃ£o do GM.");
                    else if (tempVantagensSelecionadas.includes(v.nome)) tempVantagensSelecionadas = tempVantagensSelecionadas.filter(t => t !== v.nome);
                    else {
                        if (v.restricao === "inicio" && nivel > 0) return alert("Compra dessa vantagem Ã© somente no nÃ­vel 0.");
                        if ((calcularPontosVantagemTemp() - v.custo) >= 0) tempVantagensSelecionadas.push(v.nome); else alert("PH insuficientes!");
                    }
                    atualizarVantagensDesvantagensPanel(); document.getElementById("salvar-vantagens-btn").style.display = "block";
                }; vantagensList.appendChild(div);
            });
            desvantagensData.forEach(d => {
                const div = document.createElement("div"); div.className = "desvantagem-item"; div.textContent = `${d.nome} - Ganho: ${d.ganho} PH - ${d.descricao}`;
                if (tempDesvantagensSelecionadas.includes(d.nome)) div.classList.add("comprada");
                div.onclick = () => {
                    if (desvantagensSelecionadas.includes(d.nome)) alert("Desvantagem salva sÃ³ pode ser removida com permissÃ£o do GM.");
                    else if (tempDesvantagensSelecionadas.includes(d.nome)) tempDesvantagensSelecionadas = tempDesvantagensSelecionadas.filter(t => t !== d.nome);
                    else { if (tempDesvantagensSelecionadas.length < 3) tempDesvantagensSelecionadas.push(d.nome); else alert("Limite de 3 desvantagens!"); }
                    atualizarVantagensDesvantagensPanel(); document.getElementById("salvar-vantagens-btn").style.display = "block";
                }; desvantagensList.appendChild(div);
            });
            document.getElementById("ph-temp").textContent = calcularPontosVantagemTemp();
        }

        function removerVantagem(v) {
            if (isFichaLocked && !isFichaUnlocked) return abrirModalSenha();
            senhaGmTitulo.textContent = "PeÃ§a permissÃ£o ao GM para Remover Vantagem";
            if (confirm(`Deseja remover a vantagem "${v}"?`)) {
                document.getElementById("senha-gm-modal").style.display = "flex"; document.getElementById("senha-gm-input").value = "";
                document.getElementById("confirmar-senha-gm-btn").onclick = () => {
                    if (document.getElementById("senha-gm-input").value === senhaMatriz) {
                        vantagensSelecionadas = vantagensSelecionadas.filter(t => t !== v); Array.from(vantagensListDisplay.children).find(div => div.textContent === v)?.remove();
                        fecharModal("senha-gm-modal");
                        atualizarNivel();
                        salvarDados();
                    } else { alert("Senha do GM incorreta!"); fecharModal("senha-gm-modal"); }
                };
            }
        }
        function removerDesvantagem(d) {
            if (isFichaLocked && !isFichaUnlocked) return abrirModalSenha();
            senhaGmTitulo.textContent = "PeÃ§a permissÃ£o ao GM para Remover Desvantagem";
            if (confirm(`Deseja remover a desvantagem "${d}"?`)) {
                document.getElementById("senha-gm-modal").style.display = "flex"; document.getElementById("senha-gm-input").value = "";
                document.getElementById("confirmar-senha-gm-btn").onclick = () => {
                    if (document.getElementById("senha-gm-input").value === senhaMatriz) {
                        desvantagensSelecionadas = desvantagensSelecionadas.filter(t => t !== d); Array.from(desvantagensListDisplay.children).find(div => div.textContent === d)?.remove();
                        fecharModal("senha-gm-modal");
                        atualizarNivel();
                        salvarDados();
                    } else { alert("Senha do GM incorreta!"); fecharModal("senha-gm-modal"); }
                };
            }
        }

        function calcularPesoTotal() {
            pesoTotalSpan.textContent = Array.from(inventarioSlots.querySelectorAll(".inventory-weight")).reduce((total, weight) => total + (parseFloat(weight.value) || 0), 0).toFixed(1);
        }
        inventarioSlots.addEventListener("input", (event) => {
            if (event.target.classList.contains('inventory-weight')) {
                calcularPesoTotal();
                calcularAtributos();
                salvarDados();
            } else if (event.target.classList.contains('inventory-item')) {
                salvarDados();
            }
        });


        anotacoesBtn.onclick = () => {
            anotacoesTextarea.style.display = anotacoesTextarea.style.display === "block" ? "none" : "block";
            if (diceHistoryPanel.style.display === 'flex') {
                diceHistoryPanel.style.display = 'none';
            }
        };

        adicionarMagiaBtn.onclick = () => {
             if (isFichaLocked && !isFichaUnlocked) return abrirModalSenha(adicionarMagiaBtn);
            if (magiasList.children.length < 20) { const input = document.createElement("input"); input.type = "text"; input.className = "magia-nome"; input.placeholder = `Magia/Habilidade ${magiasList.children.length + 1}`; input.addEventListener('input', salvarDados); magiasList.appendChild(input); salvarDados(); }
            else alert("Limite de 20 magias/habilidades!");
        };


        racasBtn.onclick = () => { if (isFichaLocked && !isFichaUnlocked) return abrirModalSenha(racasBtn); tempRacaSelecionada = racaSelecionada; atualizarRacasPanel(); racasPanel.style.display = "block"; document.getElementById("salvar-racas-btn").style.display = "none"; };
        fecharRacasBtn.onclick = () => { racasPanel.style.display = "none"; };

        function atualizarRacasPanel() {
            racasList.innerHTML = ""; racasData.forEach(r => {
                const div = document.createElement("div"); div.className = "raca-item";
                div.innerHTML = `<h3>${r.nome}</h3><p>${r.descricao}</p><p><strong>Vantagens:</strong></p><ul>${r.vantagens.map(v => `<li>${v}</li>`).join("")}</ul>`;
                if (tempRacaSelecionada === r.nome) div.classList.add("comprada");
                div.onclick = () => {
                    if (racaSelecionada && racaSelecionada !== r.nome) alert("RaÃ§a salva sÃ³ pode ser alterada com permissÃ£o do GM.");
                    else if (tempRacaSelecionada === r.nome) { tempRacaSelecionada = null; }
                    else {
                        let phDisponivelParaNovaRaca = calcularPontosVantagemTemp() + (tempRacaSelecionada ? (racasData.find(ra => ra.nome === tempRacaSelecionada)?.custo || 0) : 0);
                        if (phDisponivelParaNovaRaca >= r.custo) {
                            tempRacaSelecionada = r.nome;
                             document.getElementById("confirmar-compra-modal").style.display = "flex";
                             document.getElementById("confirmar-compra-btn").onclick = () => {
                                 atualizarRacasPanel();
                                 document.getElementById("salvar-racas-btn").style.display = "block";
                                 fecharModal("confirmar-compra-modal");
                             };
                        } else { alert("PH insuficientes!"); tempRacaSelecionada = null; }
                    }
                    atualizarRacasPanel();
                    document.getElementById("salvar-racas-btn").style.display = tempRacaSelecionada && tempRacaSelecionada !== racaSelecionada ? "block" : "none";
                }; racasList.appendChild(div);
            });
             phTempRacaSpan.textContent = calcularPontosVantagemTemp();
        }


        function abrirModalRaca() { document.getElementById("raca-opcoes-modal").style.display = "flex"; }
        function excluirRacaSelecionadaModal() {
            fecharModal('raca-opcoes-modal'); if (isFichaLocked && !isFichaUnlocked) return abrirModalSenha();
            senhaGmTitulo.textContent = "PeÃ§a permissÃ£o ao GM para Excluir RaÃ§a";
            if (confirm("Tem certeza que deseja excluir a raÃ§a selecionada?")) {
                document.getElementById("senha-gm-modal").style.display = "flex"; document.getElementById("senha-gm-input").value = "";
                document.getElementById("confirmar-senha-gm-btn").onclick = () => {
                    if (document.getElementById("senha-gm-input").value === senhaMatriz) {
                        racaSelecionada = null; tempRacaSelecionada = null; racaNomeSpan.textContent = ""; racaDescricaoInput.value = "";
                        salvarDados(); fecharModal("senha-gm-modal");
                        atualizarNivel();
                    } else { alert("Senha do GM incorreta!"); fecharModal("senha-gm-modal"); }
                };
            }
        }
        function editarRacaSelecionadaModal() {
            if (isFichaLocked && !isFichaUnlocked) return abrirModalSenha(); fecharModal('raca-opcoes-modal');
            document.getElementById("editar-raca-modal").style.display = "flex"; document.getElementById("editar-raca-nome").value = racaNomeSpan.textContent;
            document.getElementById("editar-raca-descricao").value = racaDescricaoInput.value;
        }
        function salvarEdicaoRaca() {
            if (isFichaLocked && !isFichaUnlocked) return abrirModalSenha();
            senhaGmTitulo.textContent = "PeÃ§a permissÃ£o ao GM para Editar RaÃ§a";
            if (confirm("Tem certeza que deseja editar a raÃ§a selecionada?")) {
                document.getElementById("senha-gm-modal").style.display = "flex"; document.getElementById("senha-gm-input").value = "";
                document.getElementById("confirmar-senha-gm-btn").onclick = () => {
                    if (document.getElementById("senha-gm-input").value === senhaMatriz) {
                        racaNomeSpan.textContent = document.getElementById("editar-raca-nome").value;
                        racaDescricaoInput.value = document.getElementById("editar-raca-descricao").value;
                        fecharModal('editar-raca-modal'); salvarDados(); fecharModal("senha-gm-modal");
                    } else { alert("Senha do GM incorreta!"); fecharModal("senha-gm-modal"); }
                };
            }
        }

        classesBtn.onclick = () => { classesPanel.style.display = "block"; };
        fecharClassesBtn.onclick = () => { classesPanel.style.display = "none"; };

        luaBtn.onclick = () => {
            document.body.classList.add("dark-mode");
            if(fichas[currentFichaId]) fichas[currentFichaId].darkMode = true;
            salvarDados();
            aplicarEstilosDeFundoVisuais();
            aplicarEstilosDeSombra();
            aplicarEstilosFichaInicial(fichas[currentFichaId] || {});
            aplicarCoresDadoInicial(fichas[currentFichaId] || {});
            if (nivel >= 30 && fichas[currentFichaId]?.gmOverrides?.nivel === undefined) {
                 fichaContainer.classList.remove("aura-azul");
            }
        };
        solBtn.onclick = () => {
            document.body.classList.remove("dark-mode");
            if(fichas[currentFichaId]) fichas[currentFichaId].darkMode = false;
            salvarDados();
            aplicarEstilosDeFundoVisuais();
            aplicarEstilosDeSombra();
            aplicarEstilosFichaInicial(fichas[currentFichaId] || {});
            aplicarCoresDadoInicial(fichas[currentFichaId] || {});
            if (nivel >= 30 && fichas[currentFichaId]?.gmOverrides?.nivel === undefined) {
                 fichaContainer.classList.add("aura-azul");
            }
        };
        resetPontosButton.onclick = resetarPontos;
        recomecarButton.onclick = recomecarFicha;

        if (salvarAtributosBtnEl) {
            salvarAtributosBtnEl.addEventListener('click', () => {
                const ficha = fichas[currentFichaId];
                if (!ficha) return;

                if (isFichaLocked && !isFichaUnlocked && currentFichaId !== FICHA_MATRIZ_ID) {
                    abrirModalSenha(salvarAtributosBtnEl, () => {
                        if(confirmarSalvarAtributosModal) confirmarSalvarAtributosModal.style.display = "flex";
                    });
                    return;
                }
                if(confirmarSalvarAtributosModal) confirmarSalvarAtributosModal.style.display = "flex";
            });
        }

        if (confirmarSalvarAtributosOkBtn) {
            confirmarSalvarAtributosOkBtn.addEventListener('click', () => {
                const ficha = fichas[currentFichaId];
                if (!ficha) return;

                ficha.lockedAtributos = ficha.lockedAtributos || {};
                atributosInputs.forEach(input => {
                    ficha.lockedAtributos[input.id] = parseInt(input.value) || 0;
                });

                salvarDados();
                if (salvarAtributosBtnEl) salvarAtributosBtnEl.style.display = "none";

                fecharModal('confirmar-salvar-atributos-modal');
                showNotification("Atributos MÃ­nimos Salvos! Os valores atuais sÃ£o os novos mÃ­nimos.", "save-success");
            });
        }

        // Modified to handle duration
        function showNotification(message, type, duration = 2000) {
            notification.innerHTML = message; // Use innerHTML to parse potential HTML tags
            notification.className = type;
            notification.style.display = "block";
            setTimeout(() => {
                notification.style.display = "none";
                notification.className = "";
                notification.innerHTML = "";
            }, duration);
        }

        // NEW: Function for special roll result display
        function showSpecialRollResult(attributeValue, roll, totalSum) {
             const message = `Total: ${attributeValue} + ${roll} = <span class="final-sum-result">${totalSum}</span>`;
             showNotification(message, 'normal-result', 4000);
        }


        // NEW: Function to handle clicking on attribute dice
        function handleAttributeDiceClick(clickedIcon) {
            // If another icon is already selected, deselect it
            if (selectedAttributeIcon && selectedAttributeIcon !== clickedIcon) {
                selectedAttributeIcon.classList.remove('selected');
            }

            // Toggle the current icon's selection
            if (selectedAttributeIcon === clickedIcon) {
                // Clicked the same icon again, so deselect it
                clickedIcon.classList.remove('selected');
                selectedAttributeIcon = null;
            } else {
                // Select the new icon
                clickedIcon.classList.add('selected');
                selectedAttributeIcon = clickedIcon;
            }
        }


        customizacaoBtn.onclick = () => {
            if (isFichaLocked && !isFichaUnlocked) {
                return abrirModalSenha(customizacaoBtn, () => {
                    abrirModalCustomizacao();
                });
            }
            abrirModalCustomizacao();
        };

        function abrirModalCustomizacao() {
            const ficha = fichas[currentFichaId] || {};
            const isDarkModeActive = document.body.classList.contains('dark-mode');
            const defaultLightPage = '#f0e6d2';
            const defaultDarkPage = '#121212';
            const defaultLightInternal = '#f0e6d2';

            const currentTheme = ficha.theme || 'theme-medieval';
            if (currentTheme.startsWith('theme-elemental')) {
                themeSelector.value = 'theme-elemental';
                elementalThemeGroup.style.display = 'block';
                elementalThemeSelector.value = currentTheme.split('-').pop();
            } else {
                themeSelector.value = currentTheme;
                elementalThemeGroup.style.display = 'none';
            }


            backgroundColorInput.value = ficha.backgroundColor || (isDarkModeActive ? defaultDarkPage : defaultLightPage);
            fichaInternalBackgroundColorInput.value = ficha.fichaInternalBackgroundColor || (isDarkModeActive ? (fichas[FICHA_MATRIZ_ID]?.fichaInternalBackgroundColor || defaultDarkPage ) : defaultLightInternal); // Default to matriz dark or page dark if dark mode, else light
            fontSelector.value = ficha.fontFamily || "'Inter', sans-serif";

            const bgSize = ficha?.backgroundSize || 'cover';
            document.querySelectorAll('#customizacao-modal input[name="background-size"]').forEach(radio => {
                radio.checked = (radio.value === bgSize);
            });
            backgroundImageInput.value = "";

            corBordaSecaoInput.value = ficha.corBordaSecao || '#b8860b';
            estiloBordaSecaoSelect.value = ficha.estiloBordaSecao || 'solid';
            larguraBordaSecaoInput.value = parseInt(ficha.larguraBordaSecao) || 2;

            diceColorInput.value = ficha.diceColor || (isDarkModeActive ? '#1e1e1e' : '#f0e6d2');
            diceNumberColorInput.value = ficha.diceNumberColor || (isDarkModeActive ? '#e0e0e0' : '#000000');
            diceAnimationSelector.value = ficha.animacaoDado || 'padrao';
            diceTextureInput.value = "";

            const currentTransparency = ficha.fichaTransparencyLevel !== undefined ? ficha.fichaTransparencyLevel : 100;
            fichaTransparencySlider.value = currentTransparency;
            fichaTransparencyValueSpan.textContent = currentTransparency;

            shadowColorFichaInput.value = ficha.shadowColorFicha || '#000000';
            shadowIntensityFichaSlider.value = ficha.shadowIntensityFicha !== undefined ? ficha.shadowIntensityFicha : 0;
            shadowIntensityFichaValueSpan.textContent = shadowIntensityFichaSlider.value;

            customizacaoModal.style.display = "flex";
        }

        function aplicarPlanoDeFundo() {
            const file = backgroundImageInput.files[0];
            const selectedSizeOption = document.querySelector('#customizacao-modal input[name="background-size"]:checked');
            const selectedSize = selectedSizeOption.value;
            let attachment = (selectedSize === 'cover') ? 'fixed' : 'scroll';

            if (file) {
                const reader = new FileReader();
                reader.onload = e => {
                    const imageUrl = e.target.result;
                    document.body.style.backgroundImage = `url('${imageUrl}')`;
                    document.body.style.backgroundSize = selectedSize;
                    document.body.style.backgroundAttachment = attachment;
                    if (fichas[currentFichaId]) {
                         fichas[currentFichaId].backgroundImage = imageUrl;
                         fichas[currentFichaId].backgroundSize = selectedSize;
                         fichas[currentFichaId].backgroundAttachment = attachment;
                    }
                    salvarDados();
                    showNotification("Imagem de fundo da pÃ¡gina aplicada!", "save-success");
                };
                reader.readAsDataURL(file);
            } else if (document.body.style.backgroundImage && document.body.style.backgroundImage !== 'none') {
                document.body.style.backgroundSize = selectedSize;
                document.body.style.backgroundAttachment = attachment;
                if (fichas[currentFichaId]) {
                    fichas[currentFichaId].backgroundSize = selectedSize;
                    fichas[currentFichaId].backgroundAttachment = attachment;
                }
                salvarDados();
                showNotification("ConfiguraÃ§Ãµes do plano de fundo da pÃ¡gina atualizadas!", "save-success");
            } else {
                alert("Nenhuma imagem selecionada para aplicar como plano de fundo da pÃ¡gina.");
            }
        }

        function excluirPlanoDeFundo() {
            if (confirm("Remover imagem de fundo da pÃ¡gina?")) {
                document.body.style.backgroundImage = 'none';
                document.body.style.backgroundAttachment = 'scroll';
                if (fichas[currentFichaId]) {
                     fichas[currentFichaId].backgroundImage = null;
                     fichas[currentFichaId].backgroundSize = 'cover';
                     fichas[currentFichaId].backgroundAttachment = 'scroll';
                }
                salvarDados();
                showNotification("Imagem de fundo da pÃ¡gina removida!", "save-success");
            }
        }

        function aplicarPlanoDeFundoInicial(ficha) {
            const bgImage = ficha?.backgroundImage;
            const bgSize = ficha?.backgroundSize || 'cover';
            const bgAttachment = ficha?.backgroundAttachment || (bgSize === 'cover' ? 'fixed' : 'scroll');

            if (bgImage) {
                document.body.style.backgroundImage = `url('${bgImage}')`;
                document.body.style.backgroundSize = bgSize;
                document.body.style.backgroundAttachment = bgAttachment;
            } else {
                document.body.style.backgroundImage = 'none';
                document.body.style.backgroundAttachment = 'scroll';
            }
        }

        function aplicarEstilosDeFundoVisuais() {
            const ficha = fichas[currentFichaId] || {};
            const isDarkModeActive = document.body.classList.contains('dark-mode');

            const defaultLightPageBg = '#f0e6d2';
            const defaultDarkPageBg = '#121212';
            document.body.style.backgroundColor = ficha.backgroundColor || (isDarkModeActive ? defaultDarkPageBg : defaultLightPageBg);
            if (backgroundColorInput) backgroundColorInput.value = ficha.backgroundColor || (isDarkModeActive ? defaultDarkPageBg : defaultLightPageBg);


            let currentTransparencyPercent = (ficha && ficha.fichaTransparencyLevel !== undefined) ? parseInt(ficha.fichaTransparencyLevel) : 100;
            let alpha = currentTransparencyPercent / 100.0;

            const fichaContainerDefaultDark = '#121212';
            const fichaContainerDefaultLight = '#f0e6d2';
            const sectionDefaultDark = '#1e1e1e';
            const sectionDefaultLight = '#f0e6d2';


            let baseFichaContainerColorHex = isDarkModeActive ? fichaContainerDefaultDark : (ficha.fichaInternalBackgroundColor || fichaContainerDefaultLight);
            let baseSectionColorHex = isDarkModeActive ? sectionDefaultDark : (ficha.fichaInternalBackgroundColor || sectionDefaultLight);


            const rgbFichaContainer = hexToRgb(baseFichaContainerColorHex);
            if (rgbFichaContainer) {
                fichaContainer.style.backgroundColor = `rgba(${rgbFichaContainer.r}, ${rgbFichaContainer.g}, ${rgbFichaContainer.b}, ${alpha})`;
            } else {
                fichaContainer.style.backgroundColor = baseFichaContainerColorHex;
            }
            if(isDarkModeActive) fichaContainer.style.color = '#e0e0e0'; else fichaContainer.style.color = '#000';


            document.querySelectorAll('#ficha-container section, #ficha-container .atributos-coluna-destaque, #ficha-container .medieval-box, #ficha-container .atributo-container').forEach(el => {
                 let baseColorForElement;
                 if (isDarkModeActive) {
                    if (el.matches('.atributos-coluna-destaque')) baseColorForElement = '#333';
                    else if (el.matches('.medieval-box')) baseColorForElement = '#1e1e1e';
                    else if (el.matches('.atributo-container')) baseColorForElement = 'rgba(50, 50, 50, 0.8)'; // Default dark for this one
                    else baseColorForElement = sectionDefaultDark; // Default dark for sections
                 } else {
                    if (el.matches('.atributos-coluna-destaque')) baseColorForElement = ficha.fichaInternalBackgroundColor || '#fff';
                    else if (el.matches('.medieval-box')) baseColorForElement = ficha.fichaInternalBackgroundColor || '#f0e6d2';
                    else if (el.matches('.atributo-container')) baseColorForElement = ficha.fichaInternalBackgroundColor || 'rgba(255, 255, 255, 0.8)';
                    else baseColorForElement = ficha.fichaInternalBackgroundColor || sectionDefaultLight;
                 }

                const rgbEl = hexToRgb(baseColorForElement);
                if (rgbEl) {
                    el.style.backgroundColor = `rgba(${rgbEl.r}, ${rgbEl.g}, ${rgbEl.b}, ${alpha})`;
                } else {
                     // Handle cases where baseColorForElement might already have alpha (like 'rgba(50,50,50,0.8)')
                    if (baseColorForElement.startsWith('rgba')) {
                        const parts = baseColorForElement.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)(?:,\s*([\d.]+))?\)/);
                        if (parts) {
                            el.style.backgroundColor = `rgba(${parts[1]}, ${parts[2]}, ${parts[3]}, ${alpha})`;
                        } else {
                            el.style.backgroundColor = baseColorForElement; // Fallback
                        }
                    } else {
                        el.style.backgroundColor = baseColorForElement; // Fallback for non-hex, non-rgba
                    }
                }
            });

            if (fichaInternalBackgroundColorInput) {
                 fichaInternalBackgroundColorInput.value = ficha.fichaInternalBackgroundColor || (isDarkModeActive ? sectionDefaultDark : sectionDefaultLight);
            }
        }


        backgroundColorInput.addEventListener('input', (event) => {
            if(fichas[currentFichaId]) fichas[currentFichaId].backgroundColor = event.target.value;
            aplicarEstilosDeFundoVisuais();
            salvarDados();
        });

        fichaInternalBackgroundColorInput.addEventListener('input', (event) => {
            if(fichas[currentFichaId]) fichas[currentFichaId].fichaInternalBackgroundColor = event.target.value;
            aplicarEstilosDeFundoVisuais();
            salvarDados();
        });

        if (fichaTransparencySlider) {
            fichaTransparencySlider.addEventListener('input', (event) => {
                const level = event.target.value;
                if (fichaTransparencyValueSpan) fichaTransparencyValueSpan.textContent = level;
                if (fichas[currentFichaId]) {
                    fichas[currentFichaId].fichaTransparencyLevel = parseInt(level);
                    aplicarEstilosDeFundoVisuais();
                    salvarDados();
                }
            });
        }

        function restaurarOpacidadePadraoFicha() {
            if (fichas[currentFichaId]) {
                fichas[currentFichaId].fichaTransparencyLevel = 100;
            }
            if (fichaTransparencySlider) fichaTransparencySlider.value = 100;
            if (fichaTransparencyValueSpan) fichaTransparencyValueSpan.textContent = "100";

            aplicarEstilosDeFundoVisuais();
            salvarDados();
            showNotification("Opacidade da ficha restaurada para o padrÃ£o!", "save-success");
        }


        fontSelector.addEventListener('change', (event) => {
            const selectedFont = event.target.value;
            document.body.style.fontFamily = selectedFont;
            if (fichaContainer) fichaContainer.style.fontFamily = selectedFont;
            if (fichas[currentFichaId]) fichas[currentFichaId].fontFamily = selectedFont;
            salvarDados();
        });

        function aplicarFonteInicial(ficha) {
            const defaultFont = "'Inter', sans-serif";
            const bodyFont = ficha?.fontFamily || defaultFont;
            document.body.style.fontFamily = bodyFont;
            if (fichaContainer) fichaContainer.style.fontFamily = bodyFont;
            fontSelector.value = bodyFont;
        }

        diceColorInput.addEventListener('input', (event) => {
            diceRoll.style.setProperty('--dice-bg-color', event.target.value);
            if(fichas[currentFichaId]) fichas[currentFichaId].diceColor = event.target.value;
            salvarDados();
        });

        diceNumberColorInput.addEventListener('input', (event) => {
            diceRoll.style.setProperty('--dice-number-color', event.target.value);
            if(fichas[currentFichaId]) fichas[currentFichaId].diceNumberColor = event.target.value;
            salvarDados();
        });

        function aplicarCoresDadoInicial(ficha) {
            const isDarkMode = document.body.classList.contains('dark-mode');
            const defaultDiceColor = isDarkMode ? '#1e1e1e' : '#f0e6d2';
            const defaultDiceNumberColor = isDarkMode ? '#e0e0e0' : '#000000';

            const diceBg = ficha?.diceColor || defaultDiceColor;
            const diceNumCol = ficha?.diceNumberColor || defaultDiceNumberColor;

            diceRoll.style.setProperty('--dice-bg-color', diceBg);
            diceRoll.style.setProperty('--dice-number-color', diceNumCol);

            if(diceColorInput) diceColorInput.value = diceBg;
            if(diceNumberColorInput) diceNumberColorInput.value = diceNumCol;
        }

        function aplicarEstilosDeSombra() {
            const ficha = fichas[currentFichaId];
            if (!ficha) return;
            const isDarkModeActive = document.body.classList.contains('dark-mode');

            let fichaInternalShadowString = 'transparent 0 0 0 0 inset';
            let sectionInternalShadowString = 'none';

            if (!isDarkModeActive) {
                const intensityFicha = ficha.shadowIntensityFicha || 0;
                const colorFicha = ficha.shadowColorFicha || '#000000';

                if (intensityFicha > 0) {
                    const internalBlurPx = intensityFicha * 0.5;
                    const internalSpreadPx = intensityFicha * 0.2;
                    const commonInsetShadow = `inset 0 0 ${internalBlurPx}px ${internalSpreadPx}px ${colorFicha}`;
                    fichaInternalShadowString = commonInsetShadow;
                    sectionInternalShadowString = commonInsetShadow;
                }
            }

            document.documentElement.style.setProperty('--ficha-internal-glow', fichaInternalShadowString);

            document.querySelectorAll('#ficha-container section').forEach(sec => {
                if (isDarkModeActive) {
                    sec.style.boxShadow = 'none';
                } else {
                    sec.style.boxShadow = sectionInternalShadowString;
                }
            });

            if (nivel >= 30 && ficha.gmOverrides?.nivel === undefined) {
                if (isDarkModeActive) {
                    fichaContainer.classList.remove("aura-azul");
                } else {
                    fichaContainer.classList.add("aura-azul");
                }
            } else {
                fichaContainer.classList.remove("aura-azul");
            }
        }


        function restaurarSombraPadrao() {
            if (fichas[currentFichaId]) {
                fichas[currentFichaId].shadowColorFicha = '#000000';
                fichas[currentFichaId].shadowIntensityFicha = 0;
            }
            shadowColorFichaInput.value = '#000000';
            shadowIntensityFichaSlider.value = 0;
            shadowIntensityFichaValueSpan.textContent = '0';

            aplicarEstilosDeSombra();
            salvarDados();
            showNotification("Sombra restaurada para o padrÃ£o!", "save-success");
        }

        shadowColorFichaInput.addEventListener('input', (event) => {
            if (fichas[currentFichaId]) fichas[currentFichaId].shadowColorFicha = event.target.value;
            aplicarEstilosDeSombra();
            salvarDados();
        });
        shadowIntensityFichaSlider.addEventListener('input', (event) => {
            const intensity = parseInt(event.target.value);
            shadowIntensityFichaValueSpan.textContent = intensity;
            if (fichas[currentFichaId]) fichas[currentFichaId].shadowIntensityFicha = intensity;
            aplicarEstilosDeSombra();
            salvarDados();
        });

        diceHistoryTrigger.addEventListener('click', () => {
            if (diceHistoryPanel.style.display === 'flex') {
                diceHistoryPanel.style.display = 'none';
                return;
            }
            if (anotacoesTextarea.style.display === 'block') {
                anotacoesTextarea.style.display = 'none';
            }
            abrirPainelHistoricoDados();
        });


        function abrirPainelHistoricoDados() {
            diceHistoryPanel.style.display = 'flex';
            if (!fichas[currentFichaId] || !fichas[currentFichaId].diceRolls || fichas[currentFichaId].diceRolls.length === 0) {
                diceHistoryList.innerHTML = '<div class="dice-history-item">Nenhuma rolagem registrada.</div>';
                return;
            }

            const rolls = fichas[currentFichaId].diceRolls;
            diceHistoryList.innerHTML = rolls.map(roll => `
                <div class="dice-history-item">
                    <span>Rolagem: <strong>${roll.type}</strong>, Resultado: <strong>${roll.result}</strong></span>
                    <span class="timestamp">${roll.timestamp}</span>
                </div>
            `).join('');
        }

        fecharHistoricoBtn.addEventListener('click', () => {
            diceHistoryPanel.style.display = 'none';
        });

        limparHistoricoBtn.addEventListener('click', () => {
            senhaGmTitulo.textContent = "PermissÃ£o do GM para Limpar HistÃ³rico";
            document.getElementById("senha-gm-modal").style.display = "flex";
            document.getElementById("senha-gm-input").value = "";
            document.getElementById("senha-gm-input").focus();
            document.getElementById("confirmar-senha-gm-btn").onclick = () => {
                if (document.getElementById("senha-gm-input").value === senhaMatriz) {
                    if (fichas[currentFichaId]) {
                        fichas[currentFichaId].diceRolls = [];
                        salvarDados();
                        abrirPainelHistoricoDados();
                        showNotification("HistÃ³rico de rolagens limpo!", "save-success");
                    }
                    fecharModal("senha-gm-modal");
                } else {
                    alert("Senha do GM incorreta!");
                    fecharModal("senha-gm-modal");
                }
            };
        });

        function aplicarFeedbackBotao(botao) {
            if (!botao) return;
            botao.classList.add('button-clicked');
            setTimeout(() => {
                botao.classList.remove('button-clicked');
            }, 150);
        }

        function aplicarEstadoColapsoSecoes(collapsedSections) {
            document.querySelectorAll('#ficha-content section').forEach(section => {
                const sectionId = section.id;
                const content = section.querySelector('.section-content');
                const icon = section.querySelector('.collapse-icon');
                if (content && icon) {
                    if (collapsedSections && collapsedSections[sectionId]) {
                        content.classList.add('collapsed');
                        icon.textContent = 'â–º';
                        icon.classList.add('collapsed');
                    } else {
                        content.classList.remove('collapsed');
                        icon.textContent = 'â–¼';
                        icon.classList.remove('collapsed');
                    }
                }
            });
        }

        function toggleCollapseSection(sectionId) {
            const section = document.getElementById(sectionId);
            if (!section) return;
            const content = section.querySelector('.section-content');
            const icon = section.querySelector('.collapse-icon');

            if (content && icon) {
                const isCollapsed = content.classList.toggle('collapsed');
                icon.classList.toggle('collapsed', isCollapsed);
                icon.textContent = isCollapsed ? 'â–º' : 'â–¼';

                if (!fichas[currentFichaId].collapsedSections) {
                    fichas[currentFichaId].collapsedSections = {};
                }
                fichas[currentFichaId].collapsedSections[sectionId] = isCollapsed;
                salvarDados();
            }
        }

        function setupHoldButtonEvents(buttonElement, actionFunction) {
            if (!buttonElement) return;
            let isActionActive = false;

            const startAction = (event) => {
                 if (event.type === 'touchstart' && event.cancelable) {
                     event.preventDefault();
                }

                if (isFichaLocked && !isFichaUnlocked && currentFichaId !== FICHA_MATRIZ_ID) {
                    abrirModalSenha(buttonElement);
                    return;
                }
                if (isActionActive) return;
                isActionActive = true;

                actionFunction();
                if (currentActionIntervalId) clearInterval(currentActionIntervalId);
                currentActionIntervalId = setInterval(actionFunction, REPEAT_DELAY_MS);
            };

            const stopAction = () => {
                                if (!isActionActive) return;
                clearInterval(currentActionIntervalId);
                currentActionIntervalId = null;
                isActionActive = false;
            };

            buttonElement.addEventListener('mousedown', startAction);
            buttonElement.addEventListener('mouseup', stopAction);
            buttonElement.addEventListener('mouseleave', stopAction);
            buttonElement.addEventListener('touchstart', startAction, { passive: false });
            buttonElement.addEventListener('touchend', stopAction);
            buttonElement.addEventListener('touchcancel', stopAction);
        }

                function showCustomTooltip(targetElement) {
            const tooltipText = targetElement.getAttribute('title');
            if (!tooltipText || !customTooltipElement) return;

            customTooltipElement.innerHTML = tooltipText;
            const rect = targetElement.getBoundingClientRect();

            let top = rect.bottom + window.scrollY + 5;
            let left = rect.left + window.scrollX + (rect.width / 2) - (customTooltipElement.offsetWidth / 2);

            if (left < 0) left = 5;
            if (left + customTooltipElement.offsetWidth > window.innerWidth) {
                left = window.innerWidth - customTooltipElement.offsetWidth - 5;
            }
            if (top + customTooltipElement.offsetHeight > window.innerHeight + window.scrollY) {
                top = rect.top + window.scrollY - customTooltipElement.offsetHeight - 5;
            }

            customTooltipElement.style.top = `${top}px`;
            customTooltipElement.style.left = `${left}px`;
            customTooltipElement.classList.add('visible');
        }

        function hideCustomTooltip() {
            if (customTooltipElement) {
                customTooltipElement.classList.remove('visible');
            }
        }

        function setupAttributeTooltips() {
            const attributeLabels = [
                document.querySelector('label[for="forca"]'),
                document.querySelector('label[for="destreza"]'),
                document.querySelector('label[for="agilidade"]'),
                document.querySelector('label[for="constituicao"]'),
                document.querySelector('label[for="inteligencia"]')
            ];

            attributeLabels.forEach(label => {
                if (label) {
                    label.addEventListener('mouseenter', (event) => {
                        clearTimeout(tooltipTimeoutId);
                        tooltipTimeoutId = setTimeout(() => {
                            showCustomTooltip(event.target);
                        }, 3000);
                    });

                    label.addEventListener('mouseleave', () => {
                        clearTimeout(tooltipTimeoutId);
                        hideCustomTooltip();
                    });
                }
            });
        }

        gmModeBtn.addEventListener('click', () => {
            if (isGmModeActive) {
                isGmModeActive = false;
                document.body.classList.remove('gm-mode-active');
                gmModeBtn.classList.remove('gm-active');
                gmModeBtn.textContent = "Modo Mestre GM ðŸ‘‘";
                showNotification("Modo Mestre desativado.", "normal-result");
                 // Re-evaluate attribute inputs against locked values if GM mode is turned off
                atributosInputs.forEach(inputTarget => {
                    const ficha = fichas[currentFichaId];
                    if (!ficha) return;
                    let currentValue = parseInt(inputTarget.value) || 0;
                    const lockedValue = (ficha.lockedAtributos && ficha.lockedAtributos[inputTarget.id] !== undefined)
                                        ? ficha.lockedAtributos[inputTarget.id]
                                        : 0;
                    if (currentValue < lockedValue) { // No !isGmModeActive here, because we are *exiting* GM mode
                        inputTarget.value = lockedValue; // Revert to locked if below
                    }
                });
                calcularAtributos(); // Recalculate based on potentially reverted values
                salvarDados();
            } else {
                senhaGmTitulo.textContent = "Ativar Modo Mestre";
                document.getElementById("senha-gm-modal").style.display = "flex";
                document.getElementById("senha-gm-input").value = "";
                document.getElementById("senha-gm-input").focus();
                document.getElementById("confirmar-senha-gm-btn").onclick = () => {
                    if (document.getElementById("senha-gm-input").value === senhaMatriz) {
                        isGmModeActive = true;
                        document.body.classList.add('gm-mode-active');
                        gmModeBtn.classList.add('gm-active');
                        gmModeBtn.textContent = "Modo Mestre Ativo ðŸ‘‘";
                        fecharModal("senha-gm-modal");
                        showNotification("Modo Mestre ativado!", "critical-success");
                    } else {
                        alert("Senha do Mestre incorreta!");
                        fecharModal("senha-gm-modal");
                    }
                };
            }
        });

        function handleGmEdit(event) {
            if (!isGmModeActive) return;
            const targetIcon = event.target;
            if (!targetIcon.classList.contains('gm-edit-icon')) return;

            const targetId = targetIcon.dataset.targetId;
            const fieldLabel = targetIcon.dataset.label || targetId;
            const targetElement = document.getElementById(targetId);

            if (!targetElement) return;

            const isPrimaryAttributeInput = atributosInputs.some(input => input.id === targetId);
            let currentValueToEdit;

            if (isPrimaryAttributeInput) {
                currentValueToEdit = targetElement.value;
            } else {
                currentValueToEdit = targetElement.textContent;
            }

            const newValueString = prompt(`Editar "${fieldLabel}":`, currentValueToEdit);

            if (newValueString !== null) {
                let newValue = newValueString;
                const numericFields = ['vida-total', 'magia-total', 'vigor-total', 'ataque', 'ataque-magico', 'acerto', 'esquiva', 'rdf', 'rdm', 'velocidade-corrida', 'altura-pulo', 'distancia-pulo', 'pontos-habilidade', 'pontos-vantagem', 'nivel', 'capacidade-carga', 'forca', 'destreza', 'agilidade', 'constituicao', 'inteligencia'];

                if (numericFields.includes(targetId)) {
                    const parsedNum = parseFloat(newValueString);
                    if (!isNaN(parsedNum)) {
                        newValue = parsedNum;
                    } else {
                         alert("Valor invÃ¡lido para este campo numÃ©rico.");
                         return;
                    }
                }

                const ficha = fichas[currentFichaId];
                if (!ficha.gmOverrides) {
                    ficha.gmOverrides = {};
                }

                if (isPrimaryAttributeInput) {
                    targetElement.value = newValue;

                } else {
                    ficha.gmOverrides[targetId] = newValue;
                }

                salvarDados();
                atualizarNivel();

                showNotification(`"${fieldLabel}" atualizado para ${newValueString} pelo Mestre.`, "save-success");
            }
        }
        fichaContainer.addEventListener('click', handleGmEdit);

                function aplicarEstilosFicha() {
            const isDarkModeActive = document.body.classList.contains('dark-mode');
            const defaultDarkBorder = '#555';
            const defaultLightBorder = '#b8860b';

            const novaCorBordaCustom = corBordaSecaoInput.value;
            const novoEstiloBorda = estiloBordaSecaoSelect.value;
            const novaLarguraBorda = larguraBordaSecaoInput.value + 'px';

            const corBordaFinal = isDarkModeActive ? defaultDarkBorder : novaCorBordaCustom;

            document.documentElement.style.setProperty('--cor-borda-secao', corBordaFinal);
            document.documentElement.style.setProperty('--estilo-borda-secao', novoEstiloBorda);
            document.documentElement.style.setProperty('--largura-borda-secao', novaLarguraBorda);

            if (fichas[currentFichaId]) {
                fichas[currentFichaId].corBordaSecao = novaCorBordaCustom;
                fichas[currentFichaId].estiloBordaSecao = novoEstiloBorda;
                fichas[currentFichaId].larguraBordaSecao = novaLarguraBorda;
            }
            salvarDados();
            showNotification("Estilos de seÃ§Ã£o aplicados!", "save-success");
        }

        function aplicarEstilosFichaInicial(ficha) {
            const isDarkModeActive = document.body.classList.contains('dark-mode');
            const defaultDarkBorder = '#555';
            const defaultLightBorder = '#b8860b';

            const corBordaCustom = ficha.corBordaSecao || defaultLightBorder;
            const estiloBorda = ficha.estiloBordaSecao || 'solid';
            const larguraBorda = ficha.larguraBordaSecao || '2px';

            const corBordaFinal = isDarkModeActive ? defaultDarkBorder : corBordaCustom;

            document.documentElement.style.setProperty('--cor-borda-secao', corBordaFinal);
            document.documentElement.style.setProperty('--estilo-borda-secao', estiloBorda);
            document.documentElement.style.setProperty('--largura-borda-secao', larguraBorda);

            if (corBordaSecaoInput) corBordaSecaoInput.value = corBordaCustom;
            if (estiloBordaSecaoSelect) estiloBordaSecaoSelect.value = estiloBorda;
            if (larguraBordaSecaoInput) larguraBordaSecaoInput.value = parseInt(larguraBorda) || 2;
        }


                diceTextureInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    aplicarTexturaDado(e.target.result);
                }
                reader.readAsDataURL(file);
            }
        });

        removeDiceTextureBtn.addEventListener('click', () => {
            if (confirm("Remover textura do dado?")) {
                aplicarTexturaDado(null);
            }
        });

        function aplicarTexturaDado(imageDataUrl) {
            const ficha = fichas[currentFichaId];
            if (imageDataUrl) {
                diceRoll.style.backgroundImage = `url('${imageDataUrl}')`;
                if (ficha) ficha.texturaDado = imageDataUrl;
            } else {
                diceRoll.style.backgroundImage = 'none';
                if (ficha) ficha.texturaDado = null;
                 diceTextureInput.value = "";
            }
            if (ficha) salvarDados();
            showNotification(imageDataUrl ? "Textura do dado aplicada!" : "Textura do dado removida!", "save-success");
        }

        diceAnimationSelector.addEventListener('change', () => {
            aplicarAnimacaoDado(diceAnimationSelector.value);
        });

        function aplicarAnimacaoDado(animacao) {
            const ficha = fichas[currentFichaId];
            if (ficha) {
                ficha.animacaoDado = animacao;
                salvarDados();
            }
             showNotification("AnimaÃ§Ã£o do dado alterada!", "save-success");
        }

       function aplicarCustomizacoesDadoInicial(ficha) {
            if (ficha.texturaDado) {
                diceRoll.style.backgroundImage = `url('${ficha.texturaDado}')`;
            } else {
                diceRoll.style.backgroundImage = 'none';
            }
            if(diceAnimationSelector && ficha.animacaoDado) {
                 diceAnimationSelector.value = ficha.animacaoDado;
            }
        }


        /***************************************************
        *               THEME FUNCTIONS START                *
        ****************************************************/
        themeSelector.addEventListener('change', (event) => {
            if (event.target.value === 'theme-elemental') {
                elementalThemeGroup.style.display = 'block';
            } else {
                elementalThemeGroup.style.display = 'none';
            }
        });

        function prepararAplicarModeloFicha() {
            let novoTema = themeSelector.value;
            if (novoTema === 'theme-elemental') {
                novoTema += '-' + elementalThemeSelector.value;
            }
            previousTheme = getCurrentThemeFromClasses();
            limparClassesDeTema();
            aplicarClassesDeTema(novoTema);
            confirmarTemaModal.style.display = 'flex';
        }

        confirmarTemaSimBtn.addEventListener('click', () => {
            const novoTema = getCurrentThemeFromClasses();
            if(fichas[currentFichaId]) {
                fichas[currentFichaId].theme = novoTema;
            }
            salvarDados();
            fecharModal('confirmar-tema-modal');
            showNotification("Tema aplicado com sucesso!", "save-success");
        });

        confirmarTemaNaoBtn.addEventListener('click', () => {
            limparClassesDeTema();
            aplicarClassesDeTema(previousTheme);
            fecharModal('confirmar-tema-modal');
        });

        function aplicarClassesDeTema(themeString) {
             const themeClasses = themeString.split(' ');
             themeClasses.forEach(cls => {
                if(cls) document.body.classList.add(cls);
            });
        }

        function limparClassesDeTema() {
            const classesToRemove = Array.from(document.body.classList).filter(cls => cls.startsWith('theme-'));
            classesToRemove.forEach(cls => document.body.classList.remove(cls));
        }

        function getCurrentThemeFromClasses() {
             const themeClasses = Array.from(document.body.classList).filter(cls => cls.startsWith('theme-'));
             return themeClasses.join(' ') || 'theme-medieval'; // Default
        }

        function reiniciarEstetica() {
            if (!confirm("Tem certeza de que deseja reiniciar TODA a estÃ©tica da ficha para o padrÃ£o? Isso inclui tema, cores, fontes e imagens de fundo. Seus dados de personagem NÃƒO serÃ£o afetados.")) {
                return;
            }

            const ficha = fichas[currentFichaId];
            if (!ficha) return;

            // 1. Reset data object properties to default
            ficha.theme = 'theme-medieval';
            ficha.backgroundColor = null;
            ficha.fichaInternalBackgroundColor = null;
            ficha.backgroundImage = null;
            ficha.backgroundSize = 'cover';
            ficha.backgroundAttachment = 'scroll';
            ficha.fontFamily = "'Inter', sans-serif";
            ficha.fichaTransparencyLevel = 100;
            ficha.corBordaSecao = '#b8860b';
            ficha.estiloBordaSecao = 'solid';
            ficha.larguraBordaSecao = '2px';
            ficha.shadowColorFicha = '#000000';
            ficha.shadowIntensityFicha = 0;
            ficha.diceColor = null;
            ficha.diceNumberColor = null;
            ficha.texturaDado = null;
            ficha.animacaoDado = 'padrao';
            ficha.darkMode = false;

            // 2. Remove any theme classes and apply default
            limparClassesDeTema();
            aplicarClassesDeTema('theme-medieval');
            document.body.classList.remove('dark-mode');


            // 3. Re-apply all visual settings from the now-reset data object
            aplicarPlanoDeFundoInicial(ficha);
            aplicarEstilosDeFundoVisuais();
            aplicarEstilosDeSombra();
            aplicarEstilosFichaInicial(ficha);
            aplicarFonteInicial(ficha);
            aplicarCoresDadoInicial(ficha);
            aplicarCustomizacoesDadoInicial(ficha);

            // 4. Update the controls in the customization modal if it's open
             if (customizacaoModal.style.display === "flex") {
                themeSelector.value = 'theme-medieval';
                elementalThemeGroup.style.display = 'none';
                backgroundColorInput.value = '#f0e6d2';
                fichaInternalBackgroundColorInput.value = '#f0e6d2';
                fontSelector.value = "'Inter', sans-serif";
                backgroundImageInput.value = "";
                corBordaSecaoInput.value = '#b8860b';
                estiloBordaSecaoSelect.value = 'solid';
                larguraBordaSecaoInput.value = 2;
                diceColorInput.value = '#f0e6d2';
                diceNumberColorInput.value = '#000000';
                diceTextureInput.value = "";
                diceAnimationSelector.value = 'padrao';
                fichaTransparencySlider.value = 100;
                fichaTransparencyValueSpan.textContent = '100';
                shadowColorFichaInput.value = '#000000';
                shadowIntensityFichaSlider.value = 0;
                shadowIntensityFichaValueSpan.textContent = '0';
             }


            // 5. Save changes and notify user
            salvarDados();
            showNotification("EstÃ©tica da ficha reiniciada para o padrÃ£o!", "save-success");
            fecharModal('customizacao-modal'); // Close the modal for a clean exit
        }


        /*************************************************
        *                THEME FUNCTIONS END                 *
        **************************************************/

        // (NOVA FUNÃ‡ÃƒO ADICIONADA) Listener para os botÃµes de incremento/decremento
        fichaContainer.addEventListener('click', (event) => {
            const target = event.target;
            if (!target.matches('.botao-atributo-stepper')) {
                 if (target.closest('.gm-edit-icon')) handleGmEdit(event); // Mover o handler de GM aqui.
                 return;
            }

            const targetInputId = target.dataset.target;
            const step = parseInt(target.dataset.step, 10);
            const inputElement = document.getElementById(targetInputId);

            if (!inputElement) return;

            // Simula o foco no campo para que as validaÃ§Ãµes sejam acionadas
            inputElement.focus();
            const originalValue = parseInt(inputElement.value, 10) || 0;

            // Armazena valor anterior para as validaÃ§Ãµes de ficha bloqueada
            previousValues.set(inputElement, originalValue);

            // Delega o desbloqueio para a funÃ§Ã£o de senha, que lida com isso.
            if (isFichaLocked && !isFichaUnlocked && currentFichaId !== FICHA_MATRIZ_ID) {
                abrirModalSenha(inputElement);
                return; // Impede a alteraÃ§Ã£o atÃ© que a ficha seja desbloqueada
            }
             if (targetInputId === 'experiencia' && inputElement.readOnly && !isXpUnlocked) {
                 confirmarDesbloqueioExperiencia();
                return;
             }

            // Realiza a alteraÃ§Ã£o
            const newValue = Math.max(0, originalValue + step);
            inputElement.value = newValue;

            // Dispara manualmente um evento de "input" para que toda a lÃ³gica de cÃ¡lculo e validaÃ§Ã£o seja executada.
            inputElement.dispatchEvent(new Event('input', { bubbles: true }));

             aplicarFeedbackBotao(target);
        });

        document.addEventListener('DOMContentLoaded', () => {
             fireworksContainerRef = document.getElementById('fireworks-container');
             if (diceContainer) {
                currentX = diceContainer.offsetLeft;
                currentY = diceContainer.offsetTop;
            }
            const btnDiminuirVida = document.getElementById('btn-diminuir-vida');
            const btnAumentarVida = document.getElementById('btn-aumentar-vida');
            const btnDiminuirMagia = document.getElementById('btn-diminuir-magia');
            const btnAumentarMagia = document.getElementById('btn-aumentar-magia');
            const btnDiminuirVigor = document.getElementById('btn-diminuir-vigor');
            const btnAumentarVigor = document.getElementById('btn-aumentar-vigor');
            const resetEsteticaBtn = document.getElementById('reset-estetica-btn');


            carregarFichas();

            setupHoldButtonEvents(btnDiminuirVida, diminuirVida);
            setupHoldButtonEvents(btnAumentarVida, aumentarVida);
            setupHoldButtonEvents(btnDiminuirMagia, diminuirMagia);
            setupHoldButtonEvents(btnAumentarMagia, aumentarMagia);
            setupHoldButtonEvents(btnDiminuirVigor, diminuirVigor);
            setupHoldButtonEvents(btnAumentarVigor, aumentarVigor);

            if (resetEsteticaBtn) {
                 resetEsteticaBtn.addEventListener('click', reiniciarEstetica);
            }

            document.querySelectorAll('.botao, .ficha-tab, #add-ficha-btn, .dice-option-btn, #change-dice-type-btn, #adicionar-magia-btn').forEach(btn => {
                btn.addEventListener('click', () => aplicarFeedbackBotao(btn));
            });
            document.querySelectorAll('#ficha-content section h2').forEach(header => {
                header.addEventListener('click', () => {
                    const sectionId = header.parentElement.id;
                    if (sectionId) {
                        toggleCollapseSection(sectionId);
                    }
                });
            });
            setupAttributeTooltips();
        });

    </script>
</body>
</html>
