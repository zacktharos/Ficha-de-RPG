<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ficha de Personagem RPG</title>
    <link href="https://fonts.googleapis.com/css2?family=MedievalSharp&family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@tailwindcss/browser@4"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <style>
        /* Seu CSS aqui */
    </style>
</head>
<body>
    <div id="fichas-sidebar">
        <div id="add-ficha-btn"><span>+ Fichas</span></div>
    </div>

    <div id="ficha-container">
        <h1 id="nome-personagem-titulo">Ficha de Personagem</h1>
        <div id="titulo-mestre" style="display: none;">Você virou o Game Master</div>
        <div id="character-image-container" onclick="document.getElementById('character-image-input').click()">
            <img id="character-image" alt="Imagem do Personagem">
            <input type="file" id="character-image-input" accept="image/*" style="display: none;">
        </div>
        <div id="dice-container">
            <label>Role seu dado:</label>
            <div id="dice-roll">-</div>
            <div id="dice-result"></div>
        </div>

        <div id="ficha-content">
            <div class="text-center mb-4">
                <label for="nome-personagem">Nome do Personagem:</label>
                <input type="text" id="nome-personagem" placeholder="Digite o nome do seu personagem">
            </div>

            <div class="text-center mb-6">
                <label for="descricao-personagem">Descrição do Personagem:</label>
                <textarea id="descricao-personagem" placeholder="Digite a descrição do seu personagem"></textarea>
            </div>

            <div class="vida-magia-vigor">
                <div><label>Pontos de Vida:</label><span id="vida">50</span></div>
                <div><label>Pontos de Magia:</label><span id="magia">20</span></div>
                <div><label>Pontos de Vigor:</label><span id="vigor">10</span></div>
            </div>

            <div class="atributos-container">
                <div class="atributos-coluna">
                    <div class="atributo"><label>Força:</label><input type="number" id="forca" value="0" min="0"></div>
                    <div class="atributo"><label>Destreza:</label><input type="number" id="destreza" value="0" min="0"></div>
                    <div class="atributo"><label>Agilidade:</label><input type="number" id="agilidade" value="0" min="0"></div>
                    <div class="atributo"><label>Constituição:</label><input type="number" id="constituicao" value="0" min="0"></div>
                    <div class="atributo"><label>Inteligência:</label><input type="number" id="inteligencia" value="0" min="0"></div>
                </div>
                <div class="atributos-coluna-destaque">
                    <div class="atributo-destaque"><label>Ataque:</label><span id="ataque">0</span></div>
                    <div class="atributo-destaque"><label>Ataque Mágico:</label><span id="ataque-magico">0</span></div>
                    <div class="atributo-destaque"><label>Acerto:</label><span id="acerto">0</span></div>
                    <div class="atributo-destaque"><label>Esquiva:</label><span id="esquiva">0</span></div>
                    <div class="atributo-destaque"><label>RDF:</label><span id="rdf">0</span></div>
                    <div class="atributo-destaque"><label>RDM:</label><span id="rdm">0</span></div>
                </div>
            </div>

            <div class="armamento-container">
                <div class="armamento-coluna">
                    <label>Armamento Mão Direita:</label>
                    <div class="flex items-center mb-2">
                        <input type="text" id="arma-direita-nome" placeholder="Nome da Arma" class="mr-2">
                        <span>Ataque </span><input type="number" id="arma-direita-ataque" value="0" class="w-20 mr-2">
                        <span>Ataque Mágico </span><input type="number" id="arma-direita-ataque-magico" value="0" class="w-20">
                    </div>
                </div>
                <div class="armamento-coluna">
                    <label>Armamento Mão Esquerda:</label>
                    <div class="flex items-center">
                        <input type="text" id="arma-esquerda-nome" placeholder="Nome da Arma" class="mr-2">
                        <span>Ataque </span><input type="number" id="arma-esquerda-ataque" value="0" class="w-20 mr-2">
                        <span>Ataque Mágico </span><input type="number" id="arma-esquerda-ataque-magico" value="0" class="w-20">
                    </div>
                </div>
            </div>

            <div style="display: flex;">
                <div id="status-container">
                    <div class="mb-4">
                        <label>Experiência:</label>
                        <input type="number" id="experiencia" value="0" min="0">
                    </div>
                    <div class="mb-4">
                        <label>Pontos de Habilidade (PD):</label>
                        <span id="pontos-habilidade">25</span>
                    </div>
                    <div class="mb-4">
                        <label>Pontos de Vantagem (PH):</label>
                        <span id="pontos-vantagem">5</span>
                    </div>
                    <div class="mb-4">
                        <label>Locomoção (m):</label>
                        <span id="locomocao">10</span>
                    </div>
                    <div class="mb-4">
                        <label>Inventário:</label>
                        <textarea id="inventario" class="expandable-textarea" placeholder="Slots 1-10"></textarea>
                    </div>
                </div>

                <div id="right-container">
                    <div class="mb-4">
                        <label>Magias e Habilidades:</label>
                        <textarea id="magias-habilidades" class="expandable-textarea" placeholder="Digite as magias e habilidades"></textarea>
                    </div>
                    <div class="mb-4">
                        <label>Vantagens:</label>
                        <textarea id="vantagens" class="expandable-textarea" placeholder="Suas vantagens aparecerão aqui" readonly></textarea>
                    </div>
                    <div class="mb-4">
                        <label>Desvantagens:</label>
                        <textarea id="desvantagens" class="expandable-textarea" placeholder="Suas desvantagens aparecerão aqui" readonly></textarea>
                    </div>
                </div>
            </div>

            <div id="nivel-container">
                <label>Nível:</label>
                <span id="nivel">0</span>
            </div>

            <div class="botoes-container">
                <button id="reset-pontos" class="botao botao-reset">Reiniciar Pontos</button>
                <button id="recomecar" class="botao botao-recomecar">Recomeçar</button>
                <button id="bloquear-ficha" class="botao botao-bloquear">Bloquear Ficha</button>
            </div>

            <button id="excluir-ficha" class="botao botao-excluir">Excluir Ficha</button>
            <button id="vantagens-desvantagens-btn">Vantagens e Desvantagens</button>
        </div>
    </div>

    <!-- Painel de Vantagens e Desvantagens -->
    <div id="vantagens-desvantagens-panel">
        <h2>Vantagens e Desvantagens</h2>
        <div id="vantagens-list"></div>
        <div id="desvantagens-list"></div>
        <button id="salvar-vantagens-btn">SALVAR</button>
        <button id="fechar-pagina-btn">Fechar Página</button>
    </div>

    <!-- Modais -->
    <div id="nome-ficha-modal" class="modal">
        <div class="modal-content">
            <h3>Dê um Nome à Ficha</h3>
            <input type="text" id="nome-ficha-input" placeholder="Nome da ficha" maxlength="20">
            <button class="confirm-btn" onclick="criarNovaFicha()">Confirmar</button>
            <button class="cancel-btn" onclick="fecharModal('nome-ficha-modal')">Cancelar</button>
        </div>
    </div>

    <div id="bloquear-ficha-modal" class="modal">
        <div class="modal-content">
            <h3>Ponha sua Senha de 4 Dígitos</h3>
            <input type="password" id="senha-bloqueio-input" placeholder="Senha (4 dígitos)" maxlength="4">
            <button class="confirm-btn" onclick="bloquearFicha()">Confirmar</button>
            <button class="cancel-btn" onclick="fecharModal('bloquear-ficha-modal')">Cancelar</button>
        </div>
    </div>

    <div id="password-modal" class="modal">
        <div class="modal-content">
            <h3>Digite sua Senha</h3>
            <input type="password" id="senha-desbloqueio-input" placeholder="Senha (4 dígitos)" maxlength="4">
            <button class="confirm-btn" onclick="desbloquearFicha()">Confirmar</button>
            <button class="cancel-btn" onclick="fecharModal('password-modal')">Cancelar</button>
        </div>
    </div>

    <div id="confirmar-compra-modal" class="modal">
        <div class="modal-content">
            <h3>Tem certeza que quer comprar isso?</h3>
            <button class="confirm-btn" id="confirmar-compra-btn">Sim</button>
            <button class="cancel-btn" onclick="fecharModal('confirmar-compra-modal')">Não</button>
        </div>
    </div>

    <div id="salvar-vantagens-modal" class="modal">
        <div class="modal-content">
            <h3>Se salvar, as alterações não poderão ser desfeitas.</h3>
            <button class="confirm-btn" id="confirmar-salvar-vantagens-btn">OK</button>
            <button class="cancel-btn" onclick="fecharModal('salvar-vantagens-modal')">Cancelar</button>
        </div>
    </div>

    <div id="senha-gm-modal" class="modal">
        <div class="modal-content">
            <h3>Digite a Senha do GM</h3>
            <input type="password" id="senha-gm-input" placeholder="Senha GM">
            <button class="confirm-btn" id="confirmar-senha-gm-btn">Confirmar</button>
            <button class="cancel-btn" onclick="fecharModal('senha-gm-modal')">Cancelar</button>
        </div>
    </div>

    <!-- Notificação movida para fora do #ficha-container -->
    <div id="notification"></div>

    <script>
        const firebaseConfig = {
            apiKey: "Sua API Key",
            authDomain: "Seu Auth Domain",
            databaseURL: "Sua Database URL",
            projectId: "Seu Project ID",
            storageBucket: "Seu Storage Bucket",
            messagingSenderId: "Seu Messaging Sender ID",
            appId: "Seu App ID"
        };

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        let fichas = {};
        let currentFichaId = null;
        let isFichaLocked = false;
        let fichaPassword = null;
        let isFichaUnlocked = false;
        const senhaMatriz = "777";
        let vantagensSelecionadas = [];
        let desvantagensSelecionadas = [];

        const vantagensData = [
            { nome: "Maestria com Armas curtas (2)", custo: 2, descricao: "Adiciona +1 em ataque, +1 em acerto com armas curtas." },
            { nome: "Maestria com armas pesadas (2)", custo: 2, descricao: "Adiciona +2 em ataque com armas pesadas." },
            { nome: "Maestria com armas de longo alcance (2)", custo: 2, descricao: "Adiciona +2 em acerto com armas de longo alcance." },
            { nome: "Furtar (2)", custo: 2, descricao: "+4 em testes de furto." },
            { nome: "Lábia (2)", custo: 2, descricao: "+5 em testes de lábia." },
            { nome: "Velejar (1)", custo: 1, descricao: "" },
            { nome: "Beleza (1)", custo: 1, descricao: "Aumenta em +3 o teste em lábia, paquera e persuasão." },
            { nome: "Boa Fama (2)", custo: 2, descricao: "Aumenta em +4 chance de descontos em armamentos, pousadas, alimentos, etc." },
            { nome: "Arremedo (2)", custo: 2, descricao: "Capacidade de imitar qualquer som SIMPLES." },
            { nome: "Destemor (1)", custo: 1, descricao: "Dificilmente é assustado por algo." },
            { nome: "Empatia (3)", custo: 3, descricao: "Sensibilidade extraordinária em relação aos outras pessoas. É um talento excelente para identificar impostores, possessões por espirito, etc." },
            { nome: "Empatia com animais (1)", custo: 1, descricao: "Pode compreender as motivações dos animais." },
            { nome: "Patrono (4)", custo: 4, descricao: "Possui um mentor/mestre/professor, até mesmo uma organização/guilda que pode lhe oferecer ajuda." },
            { nome: "Reconhecimento Social (2)", custo: 2, descricao: "É membro de uma raça, classe, sexo ou grupo muito respeitado, temido ou venerado pela sociedade. Adiciona +2 pontos o teste em lábia, paquera e persuasão." },
            { nome: "Riqueza (2)", custo: 2, descricao: "Inicia com 20 moedas de ouro." },
            { nome: "Aptidão para magia (4)", custo: 4, descricao: "Adiciona 15% a mais de dano e gasta 15% a menos de magia para toda vez que usa a magia que você tem aptidão." },
            { nome: "Combo Físico (4)", custo: 4, descricao: "Essa vantagem só pode ser comprada no início do jogo. Ao comprar essa vantagem, sua locomoção, altura do pulo e distância dobram.", restricao: "inicio" },
            { nome: "Nadar (1)", custo: 1, descricao: "" },
            { nome: "Escalar (2)", custo: 2, descricao: "" },
            { nome: "Segunda língua (1)", custo: 1, descricao: "Fala mais um idioma." },
            { nome: "Paquerador (2)", custo: 2, descricao: "Adiciona +4 em teste para paquera e persuasão envolvendo flerte." },
            { nome: "Senso de perigo (5)", custo: 5, descricao: "Sempre que houver algo grave para ocorrer o mestre do RPG pedirá pra você jogar um dado para reagir." },
            { nome: "Acrobata (3)", custo: 3, descricao: "Adiciona + fama ao lutar em público." },
            { nome: "Equilíbrio Perfeito (3)", custo: 3, descricao: "Adiciona +8 em testes de equilíbrio." },
            { nome: "Tecnologia (2)", custo: 2, descricao: "Você é engenhoso, pode inventar coisas, criar objetos improvisados." },
            { nome: "Poder Oculto (7)", custo: 7, descricao: "Quando sua vida estiver em 10%, você ativa o poder oculto aumentando todos seus atributos em 50%. Mas a partir do momento em que sua vida sai dos 10%, os atributos voltam ao normal." },
            { nome: "Sobrevivência em floresta (2)", custo: 2, descricao: "Tem facilidade para achar cavernas, criar assentamentos, barracas, achar comida e gravar caminhos no meio da floresta. Facilidade para achar água, etc." }
        ];

        const desvantagensData = [
            { nome: "Fobia (+2)", ganho: 2, descricao: "Você tem um medo irracional de algo específico." },
            { nome: "Má Fama (+2)", ganho: 2, descricao: "Você é mal visto pela sociedade, dificultando interações sociais." },
            { nome: "Alcoolismo (+2)", ganho: 2, descricao: "Você tem uma dependência de álcool que afeta suas decisões." },
            { nome: "Altruísmo (+2)", ganho: 2, descricao: "Se sacrifica por outras pessoas e pouco se importa com fama ou riqueza." },
            { nome: "Avareza (+2)", ganho: 2, descricao: "Preocupação permanente na conservação de riquezas." },
            { nome: "Bullying (+3)", ganho: 3, descricao: "Gosta de caçoar, agredir, denegrir, difamar e apontar defeitos tanto em amigos quanto inimigos." },
            { nome: "Circunspeção (+2)", ganho: 2, descricao: "Não entende piadas, entende tudo de forma literal e acredita que todos estão sempre falando sério." },
            { nome: "Compulsões (+3)", ganho: 3, descricao: "Hábito ou vício que toma boa parte dos seus recursos e tempo." },
            { nome: "Covardia (+2)", ganho: 2, descricao: "Tem extremo cuidado com seu bem-estar físico e dificuldade em assumir riscos." },
            { nome: "Dependentes (+4)", ganho: 4, descricao: "Possui alguém que depende de você a todo momento (filhos, parentes, entes queridos, etc.)." },
            { nome: "Fúria (+2)", ganho: 2, descricao: "Tendência a perder o controle e partir para um ataque frenético, ativado por dano, insulto ou aleatoriamente." },
            { nome: "Honestidade (+3)", ganho: 3, descricao: "Não consegue mentir ou omitir, sempre fala a verdade e desmascara mentiras." },
            { nome: "Impulsividade (+2)", ganho: 2, descricao: "Sempre age sem pensar." },
            { nome: "Luxúria (+2)", ganho: 2, descricao: "Desejo incontrolável por romance." },
            { nome: "Magnetismo Sobrenatural (+2)", ganho: 2, descricao: "Coisas estranhas acontecem com seu personagem em um nível alarmante." },
            { nome: "No Limite (+4)", ganho: 4, descricao: "Assume riscos extremamente irracionais diante de perigo mortal (ex.: enfrentar um boss sozinho)." },
            { nome: "Teimosia (+1)", ganho: 1, descricao: "Quer sempre fazer as coisas do seu modo e não segue planos que não sejam seus." },
            { nome: "Amnésia (+2)", ganho: 2, descricao: "Em certos momentos, não consegue lembrar de coisas importantes." }
        ];

        function criarFichaMatriz() {
            const fichaMatrizId = 'ficha-matriz';
            const fichaMatriz = {
                nomeFicha: 'Matriz',
                nomePersonagem: 'Personagem Matriz',
                descricaoPersonagem: 'Ficha original do sistema',
                forca: '0',
                destreza: '0',
                agilidade: '0',
                inteligencia: '0',
                constituicao: '0',
                experiencia: '0',
                armaDireitaNome: '',
                armaDireitaAtaque: '0',
                armaDireitaAtaqueMagico: '0',
                armaEsquerdaNome: '',
                armaEsquerdaAtaque: '0',
                armaEsquerdaAtaqueMagico: '0',
                vantagens: '',
                magiasHabilidades: '',
                desvantagens: '',
                inventario: 'Slots\n1 - \n\n\n2 - \n\n\n3 - \n\n\n4 - \n\n\n5 - \n\n\n6 - \n\n\n7 - \n\n\n8 - \n\n\n9 - \n\n\n10 - \n\n',
                locomocao: '10',
                isLocked: true,
                password: senhaMatriz,
                imagem: null
            };

            database.ref('fichas/ficha-matriz').once('value', (snapshot) => {
                if (!snapshot.exists()) {
                    database.ref(`fichas/${fichaMatrizId}`).set(fichaMatriz).then(() => {
                        currentFichaId = fichaMatrizId;
                        carregarFicha(fichaMatrizId);
                    });
                } else {
                    currentFichaId = fichaMatrizId;
                    carregarFicha(fichaMatrizId);
                    carregarFichas();
                }
            });
        }

        function carregarFichas() {
            database.ref('fichas').on('value', (snapshot) => {
                fichas = snapshot.val() || {};
                if (!fichas['ficha-matriz']) {
                    criarFichaMatriz();
                } else {
                    atualizarAbasFichas();
                }
            });
        }

        function atualizarAbasFichas() {
            const fichasSidebar = document.getElementById('fichas-sidebar');
            const addFichaBtn = document.getElementById('add-ficha-btn');
            while (fichasSidebar.children.length > 1) {
                fichasSidebar.removeChild(fichasSidebar.children[1]);
            }
            for (let fichaId in fichas) {
                if (fichaId !== 'ficha-matriz') {
                    const tab = document.createElement('div');
                    tab.className = 'ficha-tab';
                    const span = document.createElement('span');
                    span.textContent = fichas[fichaId].nomeFicha || 'Sem Nome';
                    tab.appendChild(span);
                    tab.dataset.fichaId = fichaId;
                    if (fichaId === currentFichaId) {
                        tab.classList.add('active');
                    }
                    tab.onclick = () => {
                        currentFichaId = fichaId;
                        carregarFicha(fichaId);
                        atualizarAbasFichas();
                    };
                    fichasSidebar.appendChild(tab);
                }
            }
            fichasSidebar.insertBefore(addFichaBtn, fichasSidebar.firstChild);
        }

        document.getElementById('add-ficha-btn').onclick = () => {
            document.getElementById('nome-ficha-modal').style.display = 'flex';
            document.getElementById('nome-ficha-input').value = '';
            document.getElementById('nome-ficha-input').focus();
        };

        function criarNovaFicha() {
            const nomeFicha = document.getElementById('nome-ficha-input').value.trim();
            if (!nomeFicha) {
                alert('Por favor, dê um nome à ficha!');
                return;
            }

            const fichaId = database.ref('fichas').push().key;
            const novaFicha = {
                nomeFicha: nomeFicha,
                nomePersonagem: '',
                descricaoPersonagem: '',
                forca: '0',
                destreza: '0',
                agilidade: '0',
                inteligencia: '0',
                constituicao: '0',
                experiencia: '0',
                armaDireitaNome: '',
                armaDireitaAtaque: '0',
                armaDireitaAtaqueMagico: '0',
                armaEsquerdaNome: '',
                armaEsquerdaAtaque: '0',
                armaEsquerdaAtaqueMagico: '0',
                vantagens: '',
                magiasHabilidades: '',
                desvantagens: '',
                inventario: 'Slots\n1 - \n\n\n2 - \n\n\n3 - \n\n\n4 - \n\n\n5 - \n\n\n6 - \n\n\n7 - \n\n\n8 - \n\n\n9 - \n\n\n10 - \n\n',
                locomocao: '10',
                isLocked: false,
                password: null,
                imagem: null
            };

            database.ref(`fichas/${fichaId}`).set(novaFicha).then(() => {
                currentFichaId = fichaId;
                carregarFicha(fichaId);
                fecharModal('nome-ficha-modal');
                atualizarAbasFichas();
            }).catch((error) => {
                console.error('Erro ao criar nova ficha:', error);
                alert('Ocorreu um erro ao criar a ficha. Tente novamente.');
            });
        }

        function fecharModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        const nomePersonagemInput = document.getElementById('nome-personagem');
        const descricaoPersonagemInput = document.getElementById('descricao-personagem');
        const forcaInput = document.getElementById('forca');
        const destrezaInput = document.getElementById('destreza');
        const agilidadeInput = document.getElementById('agilidade');
        const inteligenciaInput = document.getElementById('inteligencia');
        const constituicaoInput = document.getElementById('constituicao');
        const ataqueSpan = document.getElementById('ataque');
        const ataqueMagicoSpan = document.getElementById('ataque-magico');
        const acertoSpan = document.getElementById('acerto');
        const esquivaSpan = document.getElementById('esquiva');
        const rdfSpan = document.getElementById('rdf');
        const rdmSpan = document.getElementById('rdm');
        const vidaSpan = document.getElementById('vida');
        const magiaSpan = document.getElementById('magia');
        const vigorSpan = document.getElementById('vigor');
        const armaDireitaNomeInput = document.getElementById('arma-direita-nome');
        const armaDireitaAtaqueInput = document.getElementById('arma-direita-ataque');
        const armaDireitaAtaqueMagicoInput = document.getElementById('arma-direita-ataque-magico');
        const armaEsquerdaNomeInput = document.getElementById('arma-esquerda-nome');
        const armaEsquerdaAtaqueInput = document.getElementById('arma-esquerda-ataque');
        const armaEsquerdaAtaqueMagicoInput = document.getElementById('arma-esquerda-ataque-magico');
        const resetPontosButton = document.getElementById('reset-pontos');
        const recomecarButton = document.getElementById('recomecar');
        const bloquearFichaButton = document.getElementById('bloquear-ficha');
        const experienciaInput = document.getElementById('experiencia');
        const nivelSpan = document.getElementById('nivel');
        const pontosHabilidadeSpan = document.getElementById('pontos-habilidade');
        const pontosVantagemSpan = document.getElementById('pontos-vantagem');
        const locomocaoSpan = document.getElementById('locomocao');
        const nomePersonagemTitulo = document.getElementById('nome-personagem-titulo');
        const tituloMestre = document.getElementById('titulo-mestre');
        const vantagensInput = document.getElementById('vantagens');
        const magiasHabilidadesInput = document.getElementById('magias-habilidades');
        const desvantagensInput = document.getElementById('desvantagens');
        const inventarioInput = document.getElementById('inventario');
        const diceContainer = document.getElementById('dice-container');
        const diceRoll = document.getElementById('dice-roll');
        const diceResult = document.getElementById('dice-result');
        const notification = document.getElementById('notification');
        const characterImageInput = document.getElementById('character-image-input');
        const characterImage = document.getElementById('character-image');
        const vantagensDesvantagensBtn = document.getElementById('vantagens-desvantagens-btn');
        const vantagensDesvantagensPanel = document.getElementById('vantagens-desvantagens-panel');
        const vantagensList = document.getElementById('vantagens-list');
        const desvantagensList = document.getElementById('desvantagens-list');
        const salvarVantagensBtn = document.getElementById('salvar-vantagens-btn');
        const fecharPaginaBtn = document.getElementById('fechar-pagina-btn');

        const atributosInputs = [forcaInput, destrezaInput, agilidadeInput, inteligenciaInput, constituicaoInput];

        let nivel = 0;
        let nivelAnterior = 0;
        let pontosHabilidadeTotal = 25;
        let pontosHabilidadeUsados = 0;
        let pontosVantagem = 5;
        let locomocaoBase = 10;
        let experiencia = 0;
        let vidaBase = 50;

        const nivelData = [
            { nivel: 0, xp: 0, pd: 25, ph: 5 },
            { nivel: 1, xp: 10, pd: 31, ph: 6 },
            { nivel: 2, xp: 30, pd: 37, ph: 7 },
            { nivel: 3, xp: 60, pd: 43, ph: 8 },
            { nivel: 4, xp: 100, pd: 49, ph: 9 },
            { nivel: 5, xp: 150, pd: 55, ph: 10 },
            { nivel: 6, xp: 210, pd: 61, ph: 11 },
            { nivel: 7, xp: 280, pd: 67, ph: 12 },
            { nivel: 8, xp: 360, pd: 73, ph: 13 },
            { nivel: 9, xp: 450, pd: 79, ph: 14 },
            { nivel: 10, xp: 550, pd: 85, ph: 15 },
            { nivel: 11, xp: 670, pd: 91, ph: 16 },
            { nivel: 12, xp: 810, pd: 97, ph: 17 },
            { nivel: 13, xp: 970, pd: 103, ph: 18 },
            { nivel: 14, xp: 1150, pd: 109, ph: 19 },
            { nivel: 15, xp: 1350, pd: 115, ph: 20 },
            { nivel: 16, xp: 1570, pd: 121, ph: 21 },
            { nivel: 17, xp: 1810, pd: 127, ph: 22 },
            { nivel: 18, xp: 2070, pd: 133, ph: 23 },
            { nivel: 19, xp: 2350, pd: 139, ph: 24 },
            { nivel: 20, xp: 2650, pd: 145, ph: 25 },
            { nivel: 21, xp: 2980, pd: 148, ph: 26 },
            { nivel: 22, xp: 3340, pd: 151, ph: 27 },
            { nivel: 23, xp: 3730, pd: 154, ph: 28 },
            { nivel: 24, xp: 4150, pd: 157, ph: 29 },
            { nivel: 25, xp: 4600, pd: 160, ph: 30 },
            { nivel: 26, xp: 5080, pd: 163, ph: 31 },
            { nivel: 27, xp: 5590, pd: 166, ph: 32 },
            { nivel: 28, xp: 6130, pd: 169, ph: 33 },
            { nivel: 29, xp: 8000, pd: 219, ph: 34 },
            { nivel: 30, xp: 10000, pd: 319, ph: 35 }
        ];

        function carregarFicha(fichaId) {
            if (!fichas[fichaId]) return;

            const ficha = fichas[fichaId];
            nomePersonagemInput.value = ficha.nomePersonagem || '';
            descricaoPersonagemInput.value = ficha.descricaoPersonagem || '';
            forcaInput.value = ficha.forca || '0';
            destrezaInput.value = ficha.destreza || '0';
            agilidadeInput.value = ficha.agilidade || '0';
            inteligenciaInput.value = ficha.inteligencia || '0';
            constituicaoInput.value = ficha.constituicao || '0';
            experienciaInput.value = ficha.experiencia || '0';
            armaDireitaNomeInput.value = ficha.armaDireitaNome || '';
            armaDireitaAtaqueInput.value = ficha.armaDireitaAtaque || '0';
            armaDireitaAtaqueMagicoInput.value = ficha.armaDireitaAtaqueMagico || '0';
            armaEsquerdaNomeInput.value = ficha.armaEsquerdaNome || '';
            armaEsquerdaAtaqueInput.value = ficha.armaEsquerdaAtaque || '0';
            armaEsquerdaAtaqueMagicoInput.value = ficha.armaEsquerdaAtaqueMagico || '0';
            vantagensInput.value = ficha.vantagens || '';
            magiasHabilidadesInput.value = ficha.magiasHabilidades || '';
            desvantagensInput.value = ficha.desvantagens || '';
            inventarioInput.value = ficha.inventario || 'Slots\n1 - \n\n\n2 - \n\n\n3 - \n\n\n4 - \n\n\n5 - \n\n\n6 - \n\n\n7 - \n\n\n8 - \n\n\n9 - \n\n\n10 - \n\n';
            locomocaoSpan.textContent = ficha.locomocao || '10';
            isFichaLocked = ficha.isLocked || false;
            fichaPassword = ficha.password || null;
            isFichaUnlocked = false;

            if (ficha.imagem) {
                characterImage.src = ficha.imagem;
                characterImage.style.display = 'block';
            } else {
                characterImage.style.display = 'none';
            }

            vantagensSelecionadas = ficha.vantagens ? ficha.vantagens.split('\n').filter(v => v.trim()) : [];
            desvantagensSelecionadas = ficha.desvantagens ? ficha.desvantagens.split('\n').filter(d => d.trim()) : [];

            atualizarBotaoBloquear();
            atualizarVantagensDesvantagensPanel();

            experiencia = parseInt(experienciaInput.value) || 0;
            atualizarNivel();
            calcularAtributos();
        }

        function atualizarBotaoBloquear() {
            if (isFichaLocked) {
                bloquearFichaButton.textContent = 'Desbloquear Ficha';
                bloquearFichaButton.classList.remove('botao-bloquear');
                bloquearFichaButton.classList.add('botao-desbloquear');
            } else {
                bloquearFichaButton.textContent = 'Bloquear Ficha';
                bloquearFichaButton.classList.remove('botao-desbloquear');
                bloquearFichaButton.classList.add('botao-bloquear');
            }
        }

        function salvarDados() {
            if (!currentFichaId) return;
            if (isFichaLocked && !isFichaUnlocked) {
                abrirModalSenha();
                return;
            }

            const updates = {
                nomePersonagem: nomePersonagemInput.value,
                descricaoPersonagem: descricaoPersonagemInput.value,
                forca: forcaInput.value,
                destreza: destrezaInput.value,
                agilidade: agilidadeInput.value,
                inteligencia: inteligenciaInput.value,
                constituicao: constituicaoInput.value,
                experiencia: experienciaInput.value,
                armaDireitaNome: armaDireitaNomeInput.value,
                armaDireitaAtaque: armaDireitaAtaqueInput.value,
                armaDireitaAtaqueMagico: armaDireitaAtaqueMagicoInput.value,
                armaEsquerdaNome: armaEsquerdaNomeInput.value,
                armaEsquerdaAtaque: armaEsquerdaAtaqueInput.value,
                armaEsquerdaAtaqueMagico: armaEsquerdaAtaqueMagicoInput.value,
                vantagens: vantagensInput.value,
                magiasHabilidades: magiasHabilidadesInput.value,
                desvantagens: desvantagensInput.value,
                inventario: inventarioInput.value,
                locomocao: locomocaoSpan.textContent,
                imagem: characterImage.src || null
            };

            database.ref(`fichas/${currentFichaId}`).update(updates);
        }

        function calcularNivel(xp) {
            let novoNivel = 0;
            for (let i = 0; i < nivelData.length; i++) {
                if (xp >= nivelData[i].xp) {
                    novoNivel = nivelData[i].nivel;
                } else {
                    break;
                }
            }
            return novoNivel;
        }

        function atualizarNivel() {
            nivelAnterior = nivel;
            nivel = calcularNivel(experiencia);
            nivelSpan.textContent = nivel;
            pontosHabilidadeTotal = nivelData[nivel].pd;
            pontosVantagem = nivelData[nivel].ph;
            pontosVantagemSpan.textContent = pontosVantagem;

            if (nivel > nivelAnterior) {
                nivelSpan.classList.add('aura-azul');
                setTimeout(() => {
                    nivelSpan.classList.remove('aura-azul');
                }, 20000);
            }

            calcularAtributos();
            if (nivel >= 30) {
                nomePersonagemTitulo.style.color = '#FFD700';
                tituloMestre.style.display = 'block';
            } else {
                nomePersonagemTitulo.style.color = '#1C2526';
                tituloMestre.style.display = 'none';
            }
        }

        function calcularAtributos() {
            let forca = parseInt(forcaInput.value) || 0;
            let destreza = parseInt(destrezaInput.value) || 0;
            let agilidade = parseInt(agilidadeInput.value) || 0;
            let inteligencia = parseInt(inteligenciaInput.value) || 0;
            let constituicao = parseInt(constituicaoInput.value) || 0;

            let pontosUsados = forca + destreza + agilidade + inteligencia + constituicao;

            if (pontosUsados > pontosHabilidadeTotal) {
                alert('Você não tem pontos de habilidade suficientes! Reduzindo os atributos para o limite disponível.');
                let excedente = pontosUsados - pontosHabilidadeTotal;
                while (excedente > 0) {
                    if (inteligencia > 0) { inteligencia--; excedente--; inteligenciaInput.value = inteligencia; }
                    if (excedente > 0 && constituicao > 0) { constituicao--; excedente--; constituicaoInput.value = constituicao; }
                    if (excedente > 0 && agilidade > 0) { agilidade--; excedente--; agilidadeInput.value = agilidade; }
                    if (excedente > 0 && destreza > 0) { destreza--; excedente--; destrezaInput.value = destreza; }
                    if (excedente > 0 && forca > 0) { forca--; excedente--; forcaInput.value = forca; }
                }
                pontosUsados = pontosHabilidadeTotal;
            }

            pontosHabilidadeUsados = pontosUsados;
            pontosHabilidadeSpan.textContent = pontosHabilidadeTotal - pontosHabilidadeUsados;

            let ataque = forca + Math.floor(destreza / 5);
            let acerto = Math.floor(destreza / 3) + Math.floor(agilidade / 10);
            let esquiva = Math.floor(agilidade / 3);
            let rdf = Math.floor(forca / 5);
            let rdm = Math.floor(inteligencia / 5);
            let ataqueMagico = inteligencia;

            let magiaBase = 20 + constituicao * 3;
            let vigorBase = 10 + constituicao * 0.4;

            vidaBase = 50 + (constituicao * (3 + Math.floor(forca / 10))) + (nivel * 10);

            if (inteligencia >= 10) {
                magiaBase += constituicao * Math.floor(inteligencia / 10);
            }

            let ataqueArmaDireita = parseInt(armaDireitaAtaqueInput.value) || 0;
            let ataqueArmaEsquerda = parseInt(armaEsquerdaAtaqueInput.value) || 0;
            let ataqueMagicoArmaDireita = parseInt(armaDireitaAtaqueMagicoInput.value) || 0;
            let ataqueMagicoArmaEsquerda = parseInt(armaEsquerdaAtaqueMagicoInput.value) || 0;

            ataque += ataqueArmaDireita + ataqueArmaEsquerda;
            ataqueMagico += ataqueMagicoArmaDireita + ataqueMagicoArmaEsquerda;

            vantagensSelecionadas.forEach(vantagem => {
                if (vantagem === "Maestria com Armas curtas (2)") {
                    ataque += 1;
                    acerto += 1;
                } else if (vantagem === "Maestria com armas pesadas (2)") {
                    ataque += 2;
                } else if (vantagem === "Maestria com armas de longo alcance (2)") {
                    acerto += 2;
                }
            });

            ataqueSpan.textContent = ataque;
            ataqueMagicoSpan.textContent = ataqueMagico;
            acertoSpan.textContent = acerto;
            esquivaSpan.textContent = esquiva;
            rdfSpan.textContent = rdf;
            rdmSpan.textContent = rdm;
            vidaSpan.textContent = Math.ceil(vidaBase);
            magiaSpan.textContent = Math.ceil(magiaBase);
            vigorSpan.textContent = vigorBase.toFixed(1);

            const atributosDestaque = [
                { span: ataqueSpan, valor: ataque },
                { span: ataqueMagicoSpan, valor: ataqueMagico },
                { span: acertoSpan, valor: acerto },
                { span: esquivaSpan, valor: esquiva },
                { span: rdfSpan, valor: rdf },
                { span: rdmSpan, valor: rdm }
            ];

            atributosDestaque.forEach(attr => attr.span.classList.remove('atributo-fogo'));
            const maiorAtributo = atributosDestaque.reduce((max, attr) => max.valor > attr.valor ? max : attr);
            if (maiorAtributo.valor > 0) {
                maiorAtributo.span.classList.add('atributo-fogo');
            }
        }

        function validarDesvantagens() {
            const desvantagensText = desvantagensInput.value.trim();
            const desvantagens = desvantagensText.split('\n').filter(d => d.trim() !== '');
            if (desvantagens.length > 3) {
                alert('Você pode ter no máximo 3 desvantagens!');
                return false;
            }
            return true;
        }

        function resetarPontos() {
            if (isFichaLocked && !isFichaUnlocked) {
                abrirModalSenha();
                return;
            }

            atributosInputs.forEach(input => input.value = 0);
            pontosHabilidadeUsados = 0;
            pontosHabilidadeSpan.textContent = pontosHabilidadeTotal;
            pontosVantagem = nivelData[nivel].ph;
            pontosVantagemSpan.textContent = pontosVantagem;
            locomocaoSpan.textContent = locomocaoBase;
            calcularAtributos();
            salvarDados();
        }

        function recomecarFicha() {
            if (isFichaLocked && !isFichaUnlocked) {
                abrirModalSenha();
                return;
            }

            resetarPontos();
            nomePersonagemInput.value = '';
            descricaoPersonagemInput.value = '';
            experienciaInput.value = 0;
            nivel = 0;
            pontosHabilidadeTotal = nivelData[nivel].pd;
            pontosHabilidadeUsados = 0;
            pontosVantagem = nivelData[nivel].ph;
            nivelSpan.textContent = nivel;
            pontosHabilidadeSpan.textContent = pontosHabilidadeTotal;
            pontosVantagemSpan.textContent = pontosVantagem;
            locomocaoSpan.textContent = locomocaoBase;
            nomePersonagemTitulo.style.color = '#1C2526';
            tituloMestre.style.display = 'none';
            vidaBase = 50;
            armaDireitaNomeInput.value = '';
            armaDireitaAtaqueInput.value = '0';
            armaDireitaAtaqueMagicoInput.value = '0';
            armaEsquerdaNomeInput.value = '';
            armaEsquerdaAtaqueInput.value = '0';
            armaEsquerdaAtaqueMagicoInput.value = '0';
            vantagensInput.value = '';
            magiasHabilidadesInput.value = '';
            desvantagensInput.value = '';
            inventarioInput.value = 'Slots\n1 - \n\n\n2 - \n\n\n3 - \n\n\n4 - \n\n\n5 - \n\n\n6 - \n\n\n7 - \n\n\n8 - \n\n\n9 - \n\n\n10 - \n\n';
            characterImage.style.display = 'none';
            characterImage.src = '';
            vantagensSelecionadas = [];
            desvantagensSelecionadas = [];
            calcularAtributos();
            salvarDados();
        }

        bloquearFichaButton.onclick = () => {
            if (isFichaLocked) {
                abrirModalSenha();
            } else {
                document.getElementById('bloquear-ficha-modal').style.display = 'flex';
                document.getElementById('senha-bloqueio-input').value = '';
                document.getElementById('senha-bloqueio-input').focus();
            }
        };

        function bloquearFicha() {
            const senha = document.getElementById('senha-bloqueio-input').value;
            if (senha.length !== 4 || !/^\d{4}$/.test(senha)) {
                alert('A senha deve ter exatamente 4 dígitos numéricos!');
                return;
            }

            if (!validarDesvantagens()) return;

            isFichaLocked = true;
            fichaPassword = senha;
            database.ref(`fichas/${currentFichaId}`).update({
                isLocked: true,
                password: senha
            }).then(() => {
                fecharModal('bloquear-ficha-modal');
                alert('Ficha bloqueada com sucesso!');
                atualizarBotaoBloquear();
            }).catch((error) => {
                console.error('Erro ao bloquear ficha:', error);
                alert('Ocorreu um erro ao bloquear a ficha. Tente novamente.');
            });
        }

        function abrirModalSenha() {
            document.getElementById('password-modal').style.display = 'flex';
            document.getElementById('senha-desbloqueio-input').value = '';
            document.getElementById('senha-desbloqueio-input').focus();
        }

        function desbloquearFicha() {
            const senha = document.getElementById('senha-desbloqueio-input').value;
            if (senha === senhaMatriz || senha === fichaPassword) {
                isFichaUnlocked = true;
                if (currentFichaId !== 'ficha-matriz' && senha !== senhaMatriz) {
                    isFichaLocked = false;
                    fichaPassword = null;
                    database.ref(`fichas/${currentFichaId}`).update({
                        isLocked: false,
                        password: null
                    }).then(() => {
                        fecharModal('password-modal');
                        alert('Ficha desbloqueada com sucesso!');
                        atualizarBotaoBloquear();
                        salvarDados();
                    }).catch((error) => {
                        console.error('Erro ao desbloquear ficha:', error);
                        alert('Ocorreu um erro ao desbloquear a ficha. Tente novamente.');
                    });
                } else {
                    fecharModal('password-modal');
                    alert('Ficha desbloqueada com a senha matriz!');
                    atualizarBotaoBloquear();
                    salvarDados();
                }
            } else {
                alert('Senha incorreta!');
            }
        }

        nomePersonagemInput.oninput = () => {
            nomePersonagemTitulo.textContent = nomePersonagemInput.value || 'Ficha de Personagem';
            salvarDados();
        };

        experienciaInput.oninput = () => {
            experiencia = parseInt(experienciaInput.value) || 0;
            atualizarNivel();
            salvarDados();
        };

        atributosInputs.forEach(input => {
            input.oninput = () => {
                calcularAtributos();
                salvarDados();
            };
        });

        armaDireitaNomeInput.oninput = () => salvarDados();
        armaDireitaAtaqueInput.oninput = () => {
            calcularAtributos();
            salvarDados();
        };
        armaDireitaAtaqueMagicoInput.oninput = () => {
            calcularAtributos();
            salvarDados();
        };
        armaEsquerdaNomeInput.oninput = () => salvarDados();
        armaEsquerdaAtaqueInput.oninput = () => {
            calcularAtributos();
            salvarDados();
        };
        armaEsquerdaAtaqueMagicoInput.oninput = () => {
            calcularAtributos();
            salvarDados();
        };

        [descricaoPersonagemInput, magiasHabilidadesInput, inventarioInput].forEach(input => {
            input.oninput = () => salvarDados();
        });

        resetPontosButton.onclick = resetarPontos;
        recomecarButton.onclick = recomecarFicha;

        characterImageInput.onchange = (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    characterImage.src = event.target.result;
                    characterImage.style.display = 'block';
                    salvarDados();
                };
                reader.readAsDataURL(file);
            }
        };

        document.getElementById('excluir-ficha').onclick = () => {
            if (currentFichaId === 'ficha-matriz') {
                alert('A ficha matriz não pode ser excluída!');
                return;
            }
            if (confirm('Tem certeza que deseja excluir esta ficha?')) {
                database.ref(`fichas/${currentFichaId}`).remove().then(() => {
                    currentFichaId = 'ficha-matriz';
                    carregarFicha(currentFichaId);
                    atualizarAbasFichas();
                });
            }
        };

        let isDragging = false;
        let currentX = diceContainer.offsetLeft;
        let currentY = diceContainer.offsetTop;
        let initialX, initialY;

        diceContainer.onmousedown = (e) => {
            isDragging = true;
            initialX = e.clientX - currentX;
            initialY = e.clientY - currentY;
            diceContainer.style.cursor = 'grabbing';
        };

        document.onmousemove = (e) => {
            if (isDragging) {
                e.preventDefault();
                currentX = e.clientX - initialX;
                currentY = e.clientY - initialY;
                diceContainer.style.left = `${currentX}px`;
                diceContainer.style.top = `${currentY}px`;
                diceContainer.style.right = 'auto';
            }
        };

        document.onmouseup = () => {
            isDragging = false;
            diceContainer.style.cursor = 'move';
        };

        diceRoll.onclick = () => {
            if (isFichaLocked && !isFichaUnlocked) {
                abrirModalSenha();
                return;
            }

            diceRoll.textContent = 'Rolling...';
            diceResult.style.display = 'none';
            diceRoll.classList.remove('critical-failure', 'critical-success');

            setTimeout(() => {
                const roll = Math.floor(Math.random() * 20) + 1;
                diceRoll.textContent = roll;

                const nomeFicha = fichas[currentFichaId].nomeFicha || 'Sem Nome';

                if (roll === 1) {
                    diceRoll.classList.add('critical-failure');
                    notification.textContent = `${nomeFicha} - FALHA CRÍTICA!`;
                    notification.classList.add('critical-failure');
                } else if (roll === 20) {
                    diceRoll.classList.add('critical-success');
                    notification.textContent = `${nomeFicha} - SUCESSO CRÍTICO!`;
                    notification.classList.add('critical-success');
                } else {
                    diceResult.textContent = `${nomeFicha} rolou: ${roll}`;
                    diceResult.style.display = 'block';
                    notification.textContent = `${nomeFicha} rolou: ${roll}`;
                    notification.classList.add('normal-result');
                }

                notification.style.display = 'block';
                setTimeout(() => {
                    notification.style.display = 'none';
                    notification.classList.remove('critical-failure', 'critical-success', 'normal-result');
                }, 2000);
            }, 1000);
        };

        vantagensDesvantagensBtn.onclick = () => {
            if (isFichaLocked && !isFichaUnlocked) {
                abrirModalSenha();
                return;
            }
            vantagensDesvantagensPanel.style.display = 'block';
            document.getElementById('salvar-vantagens-btn').style.display = 'none';
            atualizarVantagensDesvantagensPanel();
        };

        fecharPaginaBtn.onclick = () => {
            vantagensDesvantagensPanel.style.display = 'none';
        };

        salvarVantagensBtn.onclick = () => {
            document.getElementById('salvar-vantagens-modal').style.display = 'flex';
        };

        document.getElementById('confirmar-salvar-vantagens-btn').onclick = () => {
            if (!validarDesvantagens()) {
                fecharModal('salvar-vantagens-modal');
                return;
            }

            vantagensInput.value = vantagensSelecionadas.join('\n');
            desvantagensInput.value = desvantagensSelecionadas.join('\n');
            pontosVantagemSpan.textContent = pontosVantagem;
            salvarDados();
            vantagensDesvantagensPanel.style.display = 'none';
            fecharModal('salvar-vantagens-modal');
            calcularAtributos();
        };

        function atualizarVantagensDesvantagensPanel() {
            vantagensList.innerHTML = '<h3>Vantagens</h3>';
            desvantagensList.innerHTML = '<h3>Desvantagens</h3>';

            vantagensData.forEach(vantagem => {
                const div = document.createElement('div');
                div.className = 'vantagem-item';
                div.textContent = `${vantagem.nome} - Custo: ${vantagem.custo} PH - ${vantagem.descricao}`;
                if (vantagensSelecionadas.includes(vantagem.nome)) {
                    div.classList.add('comprada');
                }
                div.onclick = () => comprarVantagem(vantagem);
                vantagensList.appendChild(div);
            });

            desvantagensData.forEach(desvantagem => {
                const div = document.createElement('div');
                div.className = 'desvantagem-item';
                div.textContent = `${desvantagem.nome} - Ganho: ${desvantagem.ganho} PH - ${desvantagem.descricao}`;
                if (desvantagensSelecionadas.includes(desvantagem.nome)) {
                    div.classList.add('comprada');
                }
                div.onclick = () => comprarDesvantagem(desvantagem);
                desvantagensList.appendChild(div);
            });
        }

        function comprarVantagem(vantagem) {
            if (vantagem.restricao === 'inicio' && nivel > 0) {
                alert('Essa vantagem só pode ser comprada no início do jogo (Nível 0)!');
                return;
            }

            if (vantagensSelecionadas.includes(vantagem.nome)) {
                vantagensSelecionadas = vantagensSelecionadas.filter(v => v !== vantagem.nome);
                pontosVantagem += vantagem.custo;
                pontosVantagemSpan.textContent = pontosVantagem;
                atualizarVantagensDesvantagensPanel();
                document.getElementById('salvar-vantagens-btn').style.display = 'block';
                calcularAtributos();
                return;
            }

            if (pontosVantagem >= vantagem.custo) {
                document.getElementById('confirmar-compra-modal').style.display = 'flex';
                document.getElementById('confirmar-compra-btn').onclick = () => {
                    vantagensSelecionadas.push(vantagem.nome);
                    pontosVantagem -= vantagem.custo;
                    pontosVantagemSpan.textContent = pontosVantagem;
                    atualizarVantagensDesvantagensPanel();
                    fecharModal('confirmar-compra-modal');
                    document.getElementById('salvar-vantagens-btn').style.display = 'block';
                    calcularAtributos();
                };
            } else {
                alert('Pontos de Vantagem insuficientes!');
            }
        }

        function comprarDesvantagem(desvantagem) {
            if (desvantagensSelecionadas.includes(desvantagem.nome)) {
                desvantagensSelecionadas = desvantagensSelecionadas.filter(d => d !== desvantagem.nome);
                pontosVantagem -= desvantagem.ganho;
                pontosVantagemSpan.textContent = pontosVantagem;
                atualizarVantagensDesvantagensPanel();
                document.getElementById('salvar-vantagens-btn').style.display = 'block';
                return;
            }

            if (desvantagensSelecionadas.length >= 3) {
                alert('Você já atingiu o limite de 3 desvantagens!');
                return;
            }

            document.getElementById('confirmar-compra-modal').style.display = 'flex';
            document.getElementById('confirmar-compra-btn').onclick = () => {
                desvantagensSelecionadas.push(desvantagem.nome);
                pontosVantagem += desvantagem.ganho;
                pontosVantagemSpan.textContent = pontosVantagem;
                atualizarVantagensDesvantagensPanel();
                fecharModal('confirmar-compra-modal');
                document.getElementById('salvar-vantagens-btn').style.display = 'block';
            };
        }

        criarFichaMatriz();
    </script>
</body>
</html>
