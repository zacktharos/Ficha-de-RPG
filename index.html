<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ficha de Personagem RPG</title>
    <link href="https://fonts.googleapis.com/css2?family=MedievalSharp&family=Inter:wght@400;600&family=Times+New+Roman&family=Arial&family=Courier+New&family=Georgia&family=Verdana&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0e6d2; /* Cor de pergaminho padrão */
            color: #000;
            display: flex;
            flex-direction: column; /* Changed to column for userId display */
            min-height: 100vh;
            margin: 0;
            padding: 0; /* Adjusted padding */
            background-image: none;
            background-size: cover;
            background-position: center;
            transition: background 0.3s, color 0.3s, font-family 0.3s;
        }
        body.dark-mode {
            background-color: #121212 !important; /* Garante que o fundo seja sempre escuro */
            color: #e0e0e0;
        }
        #user-id-container {
            width: 100%;
            padding: 5px 20px;
            background-color: rgba(0,0,0,0.1);
            font-size: 0.8rem;
            color: #555;
            text-align: right;
            box-sizing: border-box;
            position: fixed;
            top: 0;
            left: 0;
            z-index: 1001; /* Above sidebar */
        }
        body.dark-mode #user-id-container {
            background-color: rgba(255,255,255,0.1);
            color: #aaa;
        }
        #fichas-sidebar {
            width: 100%; height: 60px; padding: 0 20px; /* Added padding */
            display: flex; flex-direction: row;
            align-items: center; justify-content: flex-start; position: fixed;
            top: 25px; /* Adjusted to be below user-id-container */
            left: 0; z-index: 1000; overflow-x: auto; background: transparent;
            box-sizing: border-box;
        }
        .ficha-tab {
            visibility: visible; min-width: 100px; max-width: 150px; height: 50px; background: #f0e6d2;
            border: 2px solid #b8860b; border-radius: 10px 10px 0 0; margin-right: 10px;
            display: flex; align-items: center; justify-content: center; cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.2);
            padding: 0 10px; /* Padding for text inside tab */
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .ficha-tab:hover, .ficha-tab.active { background: #a0522d; color:white; transform: translateY(-5px); }
        .ficha-tab.active span { color:white; }
        .ficha-tab span {
            font-family: 'MedievalSharp', serif; color: #000; font-size: 0.9rem; text-align: center;
            overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
        }
        #add-ficha-btn {
            min-width: 100px; height: 50px; background: #f0e6d2; border: 2px solid #b8860b;
            border-radius: 10px 10px 0 0; margin-right: 10px; display: flex; align-items: center;
            justify-content: center; cursor: pointer; transition: transform 0.2s ease;
            box-shadow: 0 0 10px #ffd700, 0 0 20px #ffd700; z-index: 1001;
            padding: 0 10px;
        }
        #add-ficha-btn span { font-family: 'MedievalSharp', serif; color: #000; font-size: 0.9rem; }
        #add-ficha-btn:hover { background: #a0522d; transform: translateY(-5px); }
        #add-ficha-btn:hover span { color:white; }
        #ficha-container {
            background: rgba(240, 230, 210, 0.95); padding: 30px; border-radius: 12px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2); width: 95%; max-width: 1200px;
            margin: 100px auto 20px; /* Increased top margin */
            border: 2px solid #b8860b; position: relative; z-index: 1;
            transition: font-family 0.3s;
        }
        body.dark-mode #ficha-container { background: rgba(30, 30, 30, 0.95); color: #e0e0e0; }
        #ficha-container.aura-azul { box-shadow: 0 0 30px 15px #00BFFF; animation: pulsar-aura 2s infinite; }
        @keyframes pulsar-aura {
            0% { box-shadow: 0 0 20px #00BFFF, 0 0 30px #00BFFF, 0 0 40px #00BFFF; }
            50% { box-shadow: 0 0 30px #00BFFF, 0 0 50px #00BFFF, 0 0 60px #00BFFF; }
            100% { box-shadow: 0 0 20px #00BFFF, 0 0 30px #00BFFF, 0 0 40px #00BFFF; }
        }
        h1#nome-personagem-titulo {
            font-family: 'MedievalSharp', serif; color: #1C2526; font-size: 3rem; margin-bottom: 20px;
            text-align: center; text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1); animation: raios 2s infinite linear;
        }
        body.dark-mode h1#nome-personagem-titulo { color: #f0e6d2; }
        @keyframes raios {
            0% { text-shadow: 0 0 5px #FFD700, 0 0 10px #FFD700, 0 0 15px #FFD700, 0 0 20px #FF4500; }
            50% { text-shadow: 0 0 10px #FFD700, 0 0 15px #FFD700, 0 0 20px #FF4500, 0 0 25px #FF4500; }
            100% { text-shadow: 0 0 5px #FFD700, 0 0 10px #FFD700, 0 0 15px #FFD700, 0 0 20px #FF4500; }
        }
        #game-master-message { display: none; color: blue; font-size: 1.5rem; text-align: center; font-family: 'MedievalSharp', serif; margin-bottom: 10px; }
        body.dark-mode #game-master-message { color: #66ccff; }
        section { background: #f0e6d2; border: 2px solid #b8860b; border-radius: 8px; padding: 15px; margin-bottom: 20px; }
        section h2 { text-align: center; font-family: 'MedievalSharp', serif; color: #a0522d;} /* Titles specific font */
        body.dark-mode section h2 { color: #d4af37; }
        body.dark-mode section { background: #1e1e1e; border-color: #444; }
        label { font-weight: 600; color: #000; margin-bottom: 8px; display: block; }
        body.dark-mode label { color: #e0e0e0; }
        input[type="text"], input[type="number"], textarea {
            padding: 10px; border: 2px solid #b8860b; border-radius: 6px; width: calc(100% - 24px);
            margin-bottom: 15px; font-size: 1rem; transition: border-color 0.3s ease;
            background: #fff; color: #000;
        }
        body.dark-mode input[type="text"], body.dark-mode input[type="number"], body.dark-mode textarea {
            background: #333; color: #e0e0e0; border-color: #555;
        }
        input[type="text"]:focus, input[type="number"]:focus, textarea:focus {
            border-color: #a0522d; outline: none; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        input[readonly], span[readonly] { background: #e8e8e8; border: 1px solid #ccc; cursor: not-allowed; }
        body.dark-mode input[readonly], body.dark-mode span[readonly] { background: #444; border-color: #666; }
        textarea { resize: vertical; }
        .atributos-container { display: flex; justify-content: space-between; gap: 20px; flex-wrap: wrap; }
        .atributos-coluna, .atributos-coluna-destaque {
            width: 48%; display: flex; flex-direction: column; align-items: flex-start; min-width: 250px;
        }
        .atributos-coluna-destaque { background: #fff; padding: 10px; border-radius: 6px; border: 1px solid #b8860b; }
        body.dark-mode .atributos-coluna-destaque { background: #333; border-color: #555; }
        .atributo-destaque { padding: 8px; margin-bottom: 10px; display: flex; align-items: center; justify-content: space-between; width: 100%; }
        .atributo-destaque label { font-size: 1.1rem; font-weight: 700; color: #a0522d; }
        body.dark-mode .atributo-destaque label { color: #d4af37; }
        .atributo-destaque span { font-size: 1.2rem; font-family: 'MedievalSharp', serif; color: #000; }
        body.dark-mode .atributo-destaque span { color: #e0e0e0; }
        .atributo-fogo { animation: fogo 1.5s infinite; }
        @keyframes fogo {
            0% { text-shadow: 0 0 5px #ff4500, 0 0 10px #ff4500; }
            50% { text-shadow: 0 0 10px #ff4500, 0 0 15px #ffd700; }
            100% { text-shadow: 0 0 5px #ff4500, 0 0 10px #ff4500; }
        }
        .vida-magia-vigor { display: flex; justify-content: space-around; gap: 15px; flex-wrap: wrap; }
        .atributo-container {
            background: rgba(255, 255, 255, 0.8); padding: 12px; border-radius: 8px; border: 1px solid #b8860b;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); width: 30%; min-width: 200px; text-align: center;
        }
        body.dark-mode .atributo-container { background: rgba(50, 50, 50, 0.8); }
        .atributo-container h3 { font-family: 'MedievalSharp', serif; color: #a0522d; }
        body.dark-mode .atributo-container h3 { color: #d4af37; }
        .atributo-container::before { font-size: 1.5rem; margin-bottom: 5px; display: block; }
        .atributo-container.vida::before { content: "❤️"; }
        .atributo-container.magia::before { content: "✨"; }
        .atributo-container.vigor::before { content: "⚡"; }
        .medieval-box { background: #f0e6d2; border: 2px solid #b8860b; border-radius: 8px; padding: 10px; margin: 5px 0; text-align: center; }
        body.dark-mode .medieval-box { background: #1e1e1e; border-color: #444; }
        .regeneracao { font-size: 0.8rem; color: #555; margin-top: 5px; }
        body.dark-mode .regeneracao { color: #aaa; }
        button {
            background: #b8860b; color: #fff; border: none; padding: 5px 10px;
            cursor: pointer; font-size: 1.2rem; border-radius: 4px; margin: 0 5px;
            transition: background-color 0.3s ease;
        }
        body.dark-mode button { background: #555; }
        button:hover { background: #a0522d; }
        body.dark-mode button:hover { background: #777; }
        .botoes-container { display: flex; justify-content: center; gap: 10px; margin-top: 20px; margin-bottom: 20px; flex-wrap: wrap; }
        .botao {
            padding: 12px 25px; border: none; border-radius: 6px; font-size: 1rem; cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease; font-family: 'MedievalSharp', serif;
            color: #fff; text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
        }
        body.dark-mode .botao { background: #555; }
        body.dark-mode .botao:hover { background: #777; }
        #reset-pontos, #recomecar, #bloquear-ficha, #plano-fundo-btn, #excluir-ficha, #font-selector { background-color: #800000; }
         body.dark-mode #reset-pontos, body.dark-mode #recomecar, body.dark-mode #bloquear-ficha, body.dark-mode #plano-fundo-btn, body.dark-mode #excluir-ficha, body.dark-mode #font-selector { background-color: #a52a2a; }

        .botao-reset:hover, .botao-recomecar:hover, .botao-bloquear:hover, .botao-desbloquear:hover, #excluir-ficha:hover {
            background: #a0522d; transform: translateY(-2px);
        }
        body.dark-mode .botao-reset:hover, body.dark-mode .botao-recomecar:hover, body.dark-mode .botao-bloquear:hover, body.dark-mode .botao-desbloquear:hover, body.dark-mode #excluir-ficha:hover {
            background: #c0623d;
        }
        .icon-btn {
            padding: 10px; width: 44px; height: 44px;
            font-size: 1.2rem; line-height: 1; text-align: center;
        }
        #lua-btn { background-color: #333; color: #eee; }
        #sol-btn { background-color: #ffdd00; color: #333; }
        #cor-fundo-visual-btn { background-color: #800000; }
        body.dark-mode #cor-fundo-visual-btn { background-color: #a52a2a; }
        #nivel-container { text-align: center; margin-top: 10px; }
        #nivel {
            padding: 10px; background: #f0e6d2; border: 3px solid #000; border-radius: 50%;
            width: 100px; height: 100px; display: flex; align-items: center; justify-content: center;
            font-size: 3.125rem; box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.5); margin: 0 auto;
            font-family: 'MedievalSharp', serif; /* Specific font */
        }
        body.dark-mode #nivel { background: #1e1e1e; border-color: #444; }
        #nivel.aura-azul { animation: pulsar-aura 2s 10; }
        .expandable-textarea {
            height: 100px; width: 100%; background: #fff; border: 2px solid #b8860b;
            border-radius: 6px; padding: 10px; font-size: 0.9rem; transition: height 0.3s ease;
        }
        body.dark-mode .expandable-textarea { background: #333; }
        .expandable-textarea:focus { height: 15cm; }
        #dice-container {
            position: absolute; top: 20px; right: 20px; width: 200px; text-align: center;
            font-family: 'MedievalSharp', serif; cursor: move; z-index: 10; user-select: none;
        }
        #dice-container label { font-size: 1.2rem; color: #000; display: flex; align-items: center; justify-content: center; margin-bottom: 10px; }
        body.dark-mode #dice-container label { color: #e0e0e0; }
        #dice-container label::before { content: "🎲"; margin-right: 5px; font-size: 1.5rem; }
        #dice-roll {
            width: 100px; height: 100px; background: #f0e6d2; border: 2px solid #b8860b; border-radius: 10px;
            display: flex; align-items: center; justify-content: center; font-size: 2rem; cursor: pointer;
            margin: 0 auto; position: relative; transition: all 0.3s ease;
             font-family: 'MedievalSharp', serif; /* Specific font */
        }
        body.dark-mode #dice-roll { background: #1e1e1e; border-color: #444; }
        #dice-roll::before { content: "⚅"; font-size: 1.5rem; position: absolute; top: 5px; right: 5px; color: #a0522d; }
        body.dark-mode #dice-roll::before { color: #d4af37; }
        #dice-result { margin-top: 10px; font-size: 1rem; color: #000; display: none; animation: blink 1s infinite; }
        body.dark-mode #dice-result { color: #e0e0e0; }
        @keyframes blink { 50% { opacity: 0; } }
        #dice-roll.critical-failure { animation: aura-vermelha 2s infinite; }
        #dice-roll.critical-success { animation: aura-verde 2s infinite; }
        @keyframes aura-vermelha {
            0% { box-shadow: 0 0 5px #ff0000, 0 0 10px #ff0000; }
            50% { box-shadow: 0 0 15px #ff0000, 0 0 20px #ff0000; }
            100% { box-shadow: 0 0 5px #ff0000, 0 0 10px #ff0000; }
        }
        @keyframes aura-verde {
            0% { box-shadow: 0 0 5px #00ff00, 0 0 10px #00ff00; }
            50% { box-shadow: 0 0 15px #00ff00, 0 0 20px #00ff00; }
            100% { box-shadow: 0 0 5px #00ff00, 0 0 10px #00ff00; }
        }
        #notification {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); padding: 20px;
            border-radius: 8px; font-family: 'MedievalSharp', serif; font-size: 1.5rem; color: #fff;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5); display: none; z-index: 10000; /* Ensure notification is on top */
            background: rgba(0, 0, 0, 0.7); transition: opacity 0.3s ease;
        }
        #notification.critical-failure { background: rgba(255, 0, 0, 0.8); animation: aura-vermelha 2s infinite; }
        #notification.critical-success { background: rgba(0, 255, 0, 0.8); animation: aura-verde 2s infinite; }
        #notification.normal-result, #notification.save-success { animation: blink 1s infinite; }
        #notification.save-success { background: rgba(0, 200, 0, 0.8); }
        #character-image-container {
            position: absolute; top: 10px; left: 10px; width: 100px; height: 100px; background: #f0e6d2;
            border: 2px solid #b8860b; border-radius: 8px; display: flex; align-items: center;
            justify-content: center; cursor: pointer; overflow: hidden; z-index: 10;
        }
        body.dark-mode #character-image-container { background: #1e1e1e; }
        #character-image { width: 100%; height: 100%; object-fit: cover; display: none; }
        #character-image-container:hover { box-shadow: 0 0 10px #ffd700; }
        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.5); justify-content: center; align-items: center; z-index: 1000;
        }
        .modal-content {
            background: #f0e6d2; padding: 20px; border-radius: 8px; border: 2px solid #b8860b;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3); width: 90%; max-width: 400px; text-align: center;
        }
        body.dark-mode .modal-content { background: #1e1e1e; border-color: #444; }
        .modal-content h3 { font-family: 'MedievalSharp', serif; color: #000; margin-bottom: 15px; }
        body.dark-mode .modal-content h3 { color: #e0e0e0; }
        .modal-content input { width: calc(100% - 20px); padding: 10px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 6px; }
        body.dark-mode .modal-content input { background: #333; color: #e0e0e0; border-color: #555; }
        .modal-content button {
            padding: 10px 20px; border: none; border-radius: 6px; font-family: 'MedievalSharp', serif;
            color: #fff; cursor: pointer; margin: 5px; /* Added margin for better spacing on small screens */
        }
        .modal-content .confirm-btn { background: #b8860b; }
        .modal-content .confirm-btn:hover { background: #a0522d; }
        .modal-content .cancel-btn { background: #a52a2a; }
        .modal-content .cancel-btn:hover { background: #8b0000; }
        #vantagens-desvantagens-btn, #racas-btn, #classes-btn {
            padding: 10px 20px; background: #f0e6d2; border: 2px solid #b8860b; border-radius: 6px;
            font-family: 'MedievalSharp', serif; font-size: 1rem; color: #000; cursor: pointer;
            transition: background-color 0.3s ease; z-index: 10;
        }
        body.dark-mode #vantagens-desvantagens-btn, body.dark-mode #racas-btn, body.dark-mode #classes-btn {
            background: #1e1e1e; color: #e0e0e0; border-color: #444;
        }
        #vantagens-desvantagens-btn:hover, #racas-btn:hover, #classes-btn:hover { background: #a0522d; color: #fff; }
        body.dark-mode #vantagens-desvantagens-btn:hover, body.dark-mode #racas-btn:hover, body.dark-mode #classes-btn:hover { background: #c0623d; }
        #vantagens-desvantagens-panel, #racas-panel, #classes-panel {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(240, 230, 210, 0.95); padding: 20px; overflow-y: auto; z-index: 999;
            border: 2px solid #b8860b; box-shadow: 0 0 20px rgba(0, 0, 0, 0.3);
            box-sizing: border-box;
        }
        body.dark-mode #vantagens-desvantagens-panel, body.dark-mode #racas-panel, body.dark-mode #classes-panel {
            background: rgba(30, 30, 30, 0.95); border-color: #444;
        }
        #vantagens-desvantagens-panel h2, #racas-panel h2, #classes-panel h2 {
            font-family: 'MedievalSharp', serif; font-size: 2rem; text-align: center;
            color: #a0522d; margin-bottom: 20px;
        }
        body.dark-mode #vantagens-desvantagens-panel h2, body.dark-mode #racas-panel h2, body.dark-mode #classes-panel h2 { color: #d4af37; }
        #racas-panel h2 { font-size: 3rem; }
        .vantagem-item, .desvantagem-item, .raca-item-selector { /* Renamed .raca-item to .raca-item-selector for clarity */
            padding: 10px; margin: 5px 0; background: #fff; border: 1px solid #ccc;
            border-radius: 6px; cursor: pointer; transition: background-color 0.3s ease;
        }
        body.dark-mode .vantagem-item, body.dark-mode .desvantagem-item, body.dark-mode .raca-item-selector {
            background: #333; border-color: #555;
        }
        .vantagem-item:hover, .desvantagem-item:hover, .raca-item-selector:hover { background: #f0e6d2; }
        body.dark-mode .vantagem-item:hover, body.dark-mode .desvantagem-item:hover, body.dark-mode .raca-item-selector:hover { background: #444; }
        .vantagem-item.comprada, .raca-item-selector.comprada { background: #ffcccc; color: #f00; cursor: default; }
        body.dark-mode .vantagem-item.comprada, body.dark-mode .raca-item-selector.comprada { background: #502222; color: #ff8888;}
        .desvantagem-item.comprada { background: #ccffcc; color: #080; cursor: default; }
        body.dark-mode .desvantagem-item.comprada { background: #225022; color: #88ff88; }
        #salvar-vantagens-btn, #salvar-racas-btn, #fechar-pagina-btn, #fechar-racas-btn, #fechar-classes-btn {
            position: fixed; bottom: 20px; padding: 12px 25px; background: #a52a2a; color: #fff;
            border: none; border-radius: 6px; font-family: 'MedievalSharp', serif; font-size: 1.2rem;
            cursor: pointer; transition: transform 0.2s ease;
        }
        #salvar-vantagens-btn, #salvar-racas-btn { right: 250px; animation: aura-verde-btn 2s infinite; display: none; background: #006400; } /* DarkGreen for save */
        body.dark-mode #salvar-vantagens-btn, body.dark-mode #salvar-racas-btn { background: #008000; } /* Brighter Green for dark mode save */
        #fechar-pagina-btn, #fechar-racas-btn, #fechar-classes-btn { right: 20px; }
        #salvar-vantagens-btn:hover, #salvar-racas-btn:hover, #fechar-pagina-btn:hover, #fechar-racas-btn:hover, #fechar-classes-btn:hover {
            transform: translateY(-2px);
        }
        @keyframes aura-verde-btn {
            0% { box-shadow: 0 0 5px #00ff00, 0 0 10px #00ff00; }
            50% { box-shadow: 0 0 15px #00ff00, 0 0 20px #00ff00; }
            100% { box-shadow: 0 0 5px #00ff00, 0 0 10px #00ff00; }
        }
        .locomotion-container { background: #8B4513; border: 3px solid #FFD700; border-radius: 10px; padding: 15px; color: #FFD700; font-family: 'MedievalSharp', serif; }
        body.dark-mode .locomotion-container { background: #4a2a0c; border-color: #b8860b; color: #d4af37;}
        .locomotion-item { display: flex; align-items: center; margin-bottom: 10px; }
        .locomotion-item label { font-weight: bold; color: #FFD700; }
        body.dark-mode .locomotion-item label { color: #d4af37; }
        .locomotion-item span { font-size: 1.2rem; color: #FFF; text-shadow: 1px 1px 2px #000; margin-left: 5px; font-weight: bold; }
        body.dark-mode .locomotion-item span { color: #f0e6d2; }
        #distancia-pulo, #altura-pulo, #velocidade-corrida { background-color: #8B4513; border-color: #8B4513; }
        body.dark-mode #distancia-pulo, body.dark-mode #altura-pulo, body.dark-mode #velocidade-corrida { background-color: #4a2a0c; border-color: #4a2a0c; }
        .list-display { background: #fff; border: 2px solid #b8860b; border-radius: 6px; padding: 10px; min-height: 100px; max-height: 200px; overflow-y: auto; }
        body.dark-mode .list-display { background: #333; border-color: #555; }
        .list-item { cursor: pointer; margin-bottom: 5px; padding: 5px; border-bottom: 1px solid #ccc; }
        body.dark-mode .list-item { border-color: #555; }
        .list-item:hover { background: #e0e0e0; }
        body.dark-mode .list-item:hover { background: #444; }
        .inventory-slot { display: flex; align-items: center; margin-bottom: 10px; }
        .inventory-slot input[type="text"] { flex-grow: 1; margin-right: 10px; }
        .inventory-slot input[type="number"] { width: 60px; }
        #anotacoes-btn {
            position: fixed; left: 10px; top: 50%; transform: translateY(-50%); padding: 10px 20px;
            background: #f0e6d2; border: 2px solid #b8860b; border-radius: 6px;
            font-family: 'MedievalSharp', serif; font-size: 1rem; color: #000; cursor: pointer;
            transition: background-color 0.3s ease; z-index: 1000;
        }
        body.dark-mode #anotacoes-btn { background: #1e1e1e; color: #e0e0e0; border-color: #444;}
        #anotacoes-btn:hover { background: #a0522d; color: #fff; }
        body.dark-mode #anotacoes-btn:hover { background: #c0623d; }
        #anotacoes-textarea {
            display: none; position: fixed; left: 60px; top: 50%; transform: translateY(-50%);
            width: 400px; height: 400px; background: #fff; border: 2px solid #b8860b;
            border-radius: 6px; padding: 10px; font-size: 0.9rem; resize: none; z-index: 1001;
        }
        body.dark-mode #anotacoes-textarea { background: #333; color: #e0e0e0; }
        .magias-container { max-height: 300px; overflow-y: auto; border: 2px solid #b8860b; border-radius: 6px; padding: 10px; background: #fff; }
        body.dark-mode .magias-container { background: #333; border-color: #555; }
        .magias-container input { margin-bottom: 10px; }
        #adicionar-magia-btn { background: #b8860b; color: #fff; padding: 8px 16px; border-radius: 6px; cursor: pointer; display: block; margin-top: 10px; }
        #adicionar-magia-btn:hover { background: #a0522d; }
        body.dark-mode #adicionar-magia-btn { background: #555; }
        body.dark-mode #adicionar-magia-btn:hover { background: #777; }
        .classe-raca-container { background: #f0e6d2; border: 2px solid #b8860b; padding: 10px; border-radius: 6px; margin-top: 10px; }
        body.dark-mode .classe-raca-container { background: #1e1e1e; border-color: #444; }
        .classe-raca-container label { font-family: 'MedievalSharp', serif; color: #a0522d; font-size: 1.2rem; }
        body.dark-mode .classe-raca-container label { color: #d4af37; }
        .classe-raca-container span[onclick] { background: #fff; border: 2px solid #b8860b; padding: 10px; cursor: pointer; display: block; min-height: 40px; /* Ensure clickable area */ }
        body.dark-mode .classe-raca-container span[onclick] { background: #333; color: #e0e0e0; border-color: #555;}
        .classe-raca-container textarea { width: 100%; background: #fff; border: 2px solid #b8860b; }
        body.dark-mode .classe-raca-container textarea { background: #333; color: #e0e0e0; }
        .raca-item { margin-bottom: 20px; padding: 10px; background: #fff; border: 2px solid #b8860b; border-radius: 6px; } /* This is for display in main sheet */
        .raca-item h3 { font-family: 'MedievalSharp', serif; font-size: 1.5rem; color: #a0522d; }
        .raca-item p { font-size: 1rem; color: #000; }
        body.dark-mode .raca-item { background: #333; border-color: #555; }
        body.dark-mode .raca-item h3 { color: #d4af37; }
        body.dark-mode .raca-item p { color: #e0e0e0; }
        .theme-color-container { display: flex; justify-content: center; align-items:center; gap: 10px; margin-top: -10px; margin-bottom: 20px; flex-wrap: wrap; }
        .theme-option { position: relative; }
        #cor-fundo-visual-btn { cursor: pointer; }

        @media (max-width: 768px) {
            body { padding-top: 85px; /* Account for fixed user-id and sidebar */ }
            #fichas-sidebar { top: 25px; /* Ensure it's below user-id */ }
            #ficha-container { padding: 15px; margin-top: 20px; /* Reduced margin after sidebar */ }
            h1#nome-personagem-titulo { font-size: 2rem; }
            section h2 { font-size: 1.2rem; }
            input, textarea { font-size: 0.9rem; }
            .atributos-container, .vida-magia-vigor { flex-direction: column; }
            .atributos-coluna, .atributos-coluna-destaque, .atributo-container { width: 100%; }
            .botoes-container, .theme-color-container { flex-direction: row; flex-wrap: wrap; }
            #dice-container { position: static; width: 100%; margin-top: 20px; margin-bottom: 20px; }
            #character-image-container { position: static; margin: 0 auto 20px auto; }
            #anotacoes-btn { position: static; margin: 10px auto; display: block; width: fit-content;}
            #anotacoes-textarea { position: static; width: 90%; margin: 10px auto; transform: none; }
             .armamento-container { flex-direction: column; gap: 10px; }
            .armamento-coluna { width: 100%; }
            .armamento-coluna .flex { flex-direction: column; align-items: stretch; }
            .armamento-coluna input[type="text"], .armamento-coluna input[type="number"] { width: 100% !important; margin-right: 0; margin-bottom: 5px; }

            #vantagens-desvantagens-panel, #racas-panel, #classes-panel { padding: 10px; }
            #salvar-vantagens-btn, #salvar-racas-btn { right: auto; left: 50%; transform: translateX(-50%); width: calc(100% - 40px); max-width: 300px; bottom: 70px; }
            #fechar-pagina-btn, #fechar-racas-btn, #fechar-classes-btn { right: auto; left: 50%; transform: translateX(-50%); width: calc(100% - 40px); max-width: 300px; bottom: 20px; }
            #salvar-vantagens-btn, #salvar-racas-btn { right: 20px; left: auto; transform: none; width: auto; }
            #fechar-pagina-btn, #fechar-racas-btn, #fechar-classes-btn { right: 20px; left: auto; transform: none; width: auto; }
            #salvar-vantagens-btn { right: 150px; } /* Adjust for close button */


        }
        #raca-opcoes-modal .modal-content button:nth-child(2) { margin-top: 10px; }
        #background-modal { display: none; }
        #background-modal .modal-content { width: 90%; max-width: 400px; text-align: left; }
        #background-modal .modal-content label { display: block; margin-bottom: 5px; }
        #background-modal .modal-content input[type="file"] { margin-bottom: 10px; }
        #background-modal .modal-content .radio-group { margin-bottom: 15px; }
        #background-modal .modal-content .radio-group label { display: inline-block; margin-right: 10px; }
        .color-option { width: 24px; height: 24px; border-radius: 50%; cursor: pointer; border: 1px solid #ccc; }
    </style>
</head>
<body>
    <div id="user-id-container">
        Carregando ID do Usuário...
    </div>
    <div id="fichas-sidebar">
        <!-- Ficha Matriz Tab will be added by JS if needed -->
        <div id="add-ficha-btn"><span>+ Fichas</span></div>
    </div>

    <div id="ficha-container">
        <h1 id="nome-personagem-titulo">Ficha de Personagem</h1>
        <div id="game-master-message">Você virou o Game Master</div>
        <div id="character-image-container" onclick="document.getElementById('character-image-input').click()">
            <img id="character-image" alt="Imagem do Personagem" onerror="this.style.display='none';">
            <input type="file" id="character-image-input" accept="image/*" style="display:none">
        </div>
        <div id="dice-container">
            <label>Role seu dado:</label>
            <div id="dice-roll">-</div>
            <div id="dice-result"></div>
        </div>
        <div id="ficha-content">
            <!-- Informações Básicas -->
            <section id="informacoes-basicas">
                <h2>Informações Básicas</h2>
                <label for="nome-personagem">Nome do Personagem:</label>
                <input type="text" id="nome-personagem" placeholder="Digite o nome do seu personagem">
                <label for="descricao-personagem">Descrição do Personagem:</label>
                <textarea id="descricao-personagem" placeholder="Digite a descrição do seu personagem"></textarea>
            </section>

            <!-- Recursos -->
            <section id="recursos">
                <h2>Recursos</h2>
                <div class="vida-magia-vigor">
                    <div class="atributo-container vida">
                        <h3>Vida</h3>
                        <div class="valor-total medieval-box">
                            <span>Vida Total: </span>
                            <span id="vida-total" readonly>50</span>
                        </div>
                        <div class="valor-atual medieval-box">
                            <span>Vida Atual: </span>
                            <button id="btn-diminuir-vida" title="Diminuir Vida">▼</button>
                            <span id="vida-atual">50</span>
                            <button id="btn-aumentar-vida" title="Aumentar Vida">▲</button>
                        </div>
                        <div class="regeneracao">
                            <span>Regeneração por turno: <span id="regeneracao-vida">0</span> (parado)</span>
                        </div>
                    </div>
                    <div class="atributo-container magia">
                        <h3>Magia</h3>
                        <div class="valor-total medieval-box">
                            <span>Magia Total: </span>
                            <span id="magia-total" readonly>20</span>
                        </div>
                        <div class="valor-atual medieval-box">
                            <span>Magia Atual: </span>
                            <button id="btn-diminuir-magia" title="Diminuir Magia">▼</button>
                            <span id="magia-atual">20</span>
                            <button id="btn-aumentar-magia" title="Aumentar Magia">▲</button>
                        </div>
                        <div class="regeneracao">
                            <span>Regeneração por turno: <span id="regeneracao-magia">0</span></span>
                        </div>
                    </div>
                    <div class="atributo-container vigor">
                        <h3>Vigor</h3>
                        <div class="valor-total medieval-box">
                            <span>Vigor Total: </span>
                            <span id="vigor-total" readonly>10</span>
                        </div>
                        <div class="valor-atual medieval-box">
                            <span>Vigor Atual: </span>
                            <button id="btn-diminuir-vigor" title="Diminuir Vigor">▼</button>
                            <span id="vigor-atual">10</span>
                            <button id="btn-aumentar-vigor" title="Aumentar Vigor">▲</button>
                        </div>
                        <div class="regeneracao">
                            <span>Regeneração por turno: <span id="regeneracao-vigor">0</span> (parado)</span>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Atributos -->
            <section id="atributos">
                <h2>Atributos</h2>
                <div class="atributos-container">
                    <div class="atributos-coluna">
                        <div class="atributo">
                            <label for="forca" title="Afeta ataque e RDF">Força:</label>
                            <input type="number" id="forca" value="0" min="0">
                        </div>
                        <div class="atributo">
                            <label for="destreza" title="Afeta ataque e acerto">Destreza:</label>
                            <input type="number" id="destreza" value="0" min="0">
                        </div>
                        <div class="atributo">
                            <label for="agilidade" title="Afeta esquiva e acerto">Agilidade:</label>
                            <input type="number" id="agilidade" value="0" min="0">
                        </div>
                        <div class="atributo">
                            <label for="constituicao" title="Afeta vida, magia e vigor">Constituição:</label>
                            <input type="number" id="constituicao" value="0" min="0">
                        </div>
                        <div class="atributo">
                            <label for="inteligencia" title="Afeta ataque mágico e RDM">Inteligência:</label>
                            <input type="number" id="inteligencia" value="0" min="0">
                        </div>
                    </div>
                    <div class="atributos-coluna-destaque">
                        <div class="atributo-destaque">
                            <label>Ataque:</label>
                            <span id="ataque" readonly>0</span>
                        </div>
                        <div class="atributo-destaque">
                            <label>Ataque Mágico:</label>
                            <span id="ataque-magico" readonly>0</span>
                        </div>
                        <div class="atributo-destaque">
                            <label>Acerto:</label>
                            <span id="acerto" readonly>0</span>
                        </div>
                        <div class="atributo-destaque">
                            <label>Esquiva:</label>
                            <span id="esquiva" readonly>0</span>
                        </div>
                        <div class="atributo-destaque">
                            <label>RDF:</label>
                            <span id="rdf" readonly>0</span>
                        </div>
                        <div class="atributo-destaque">
                            <label>RDM:</label>
                            <span id="rdm" readonly>0</span>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Combate -->
            <section id="combate">
                <h2>Combate</h2>
                <div class="armamento-container flex flex-wrap gap-4">
                    <div class="armamento-coluna flex-1 min-w-[300px]">
                        <label>Armamento Mão Direita:</label>
                        <div class="flex items-center mb-2 flex-wrap">
                            <input type="text" id="arma-direita-nome" placeholder="Nome da Arma" class="mr-2 mb-1 sm:mb-0 flex-grow">
                            <span class="mr-1">Ataque </span>
                            <input type="number" id="arma-direita-ataque" value="0" class="w-20 mr-2 mb-1 sm:mb-0">
                            <span class="mr-1">Ataque Mágico </span>
                            <input type="number" id="arma-direita-ataque-magico" value="0" class="w-20 mb-1 sm:mb-0">
                        </div>
                    </div>
                    <div class="armamento-coluna flex-1 min-w-[300px]">
                        <label>Armamento Mão Esquerda:</label>
                        <div class="flex items-center flex-wrap">
                            <input type="text" id="arma-esquerda-nome" placeholder="Nome da Arma" class="mr-2 mb-1 sm:mb-0 flex-grow">
                            <span class="mr-1">Ataque </span>
                            <input type="number" id="arma-esquerda-ataque" value="0" class="w-20 mr-2 mb-1 sm:mb-0">
                            <span class="mr-1">Ataque Mágico </span>
                            <input type="number" id="arma-esquerda-ataque-magico" value="0" class="w-20 mb-1 sm:mb-0">
                        </div>
                    </div>
                </div>
            </section>

            <!-- Inventário e Habilidades -->
            <section id="inventario-habilidades">
                <h2>Inventário e Habilidades</h2>
                <div class="flex flex-wrap gap-x-20 gap-y-10">
                    <div class="flex-1 min-w-[300px]">
                        <label>Inventário (Peso Total: <span id="peso-total">0</span> kg / <span id="capacidade-carga">5</span> kg):</label>
                        <div id="inventario-slots">
                            <!-- Slots de inventário serão gerados por JS se necessário, ou manter estático -->
                            <div class="inventory-slot"><input type="text" placeholder="Item 1" class="inventory-item"><input type="number" min="0" value="0" class="inventory-weight" title="Peso em kg"></div>
                            <div class="inventory-slot"><input type="text" placeholder="Item 2" class="inventory-item"><input type="number" min="0" value="0" class="inventory-weight"></div>
                            <div class="inventory-slot"><input type="text" placeholder="Item 3" class="inventory-item"><input type="number" min="0" value="0" class="inventory-weight"></div>
                            <div class="inventory-slot"><input type="text" placeholder="Item 4" class="inventory-item"><input type="number" min="0" value="0" class="inventory-weight"></div>
                            <div class="inventory-slot"><input type="text" placeholder="Item 5" class="inventory-item"><input type="number" min="0" value="0" class="inventory-weight"></div>
                            <div class="inventory-slot"><input type="text" placeholder="Item 6" class="inventory-item"><input type="number" min="0" value="0" class="inventory-weight"></div>
                            <div class="inventory-slot"><input type="text" placeholder="Item 7" class="inventory-item"><input type="number" min="0" value="0" class="inventory-weight"></div>
                            <div class="inventory-slot"><input type="text" placeholder="Item 8" class="inventory-item"><input type="number" min="0" value="0" class="inventory-weight"></div>
                            <div class="inventory-slot"><input type="text" placeholder="Item 9" class="inventory-item"><input type="number" min="0" value="0" class="inventory-weight"></div>
                            <div class="inventory-slot"><input type="text" placeholder="Item 10" class="inventory-item"><input type="number" min="0" value="0" class="inventory-weight"></div>
                        </div>
                    </div>
                    <div class="flex-1 min-w-[300px]">
                        <label>Magias e Habilidades:</label>
                        <div id="magias-list" class="magias-container">
                             <!-- Inputs de Magias serão gerados por JS -->
                        </div>
                        <button id="adicionar-magia-btn">Adicionar Magia</button>
                    </div>
                </div>
                <div class="mt-4">
                    <label>Vantagens:</label>
                    <div id="vantagens-list-display" class="list-display"></div>
                    <label>Desvantagens:</label>
                    <div id="desvantagens-list-display" class="list-display"></div>
                </div>
                <div class="classe-raca-container">
                    <label>Classe:</label>
                    <input type="text" id="classe-nome" placeholder="Nome da Classe">
                    <textarea id="classe-descricao" placeholder="Descrição da Classe" class="expandable-textarea"></textarea>
                    <label>Raça:</label>
                    <span id="raca-nome" onclick="abrirModalRaca()">Clique para selecionar/editar</span>
                    <textarea id="raca-descricao" placeholder="Descrição da Raça" class="expandable-textarea" readonly></textarea>
                </div>
            </section>

            <!-- Locomoção -->
            <section id="locomocao">
                <h2>Locomoção</h2>
                <div class="locomotion-container">
                    <div class="locomotion-item">
                        <label>Velocidade de Corrida (km/h):</label><span>🏃‍♂️</span><span id="velocidade-corrida" readonly>25</span>
                    </div>
                    <div class="locomotion-item">
                        <label>Altura do Pulo (m):</label><span>⬆️</span><span id="altura-pulo" readonly>1</span>
                    </div>
                    <div class="locomotion-item">
                        <label>Distância do Pulo (m):</label><span>➡️</span><span id="distancia-pulo" readonly>3</span>
                    </div>
                </div>
            </section>

            <!-- Status -->
            <section id="status">
                <h2>Status</h2>
                <div class="flex flex-wrap gap-x-20 gap-y-10">
                    <div class="flex-1 min-w-[200px]">
                        <label for="experiencia">Experiência:</label>
                        <input type="number" id="experiencia" value="0" min="0">
                        <label>Pontos de Habilidade (PD):</label>
                        <span id="pontos-habilidade" readonly>25</span>
                        <label>Pontos de Vantagem (PH):</label>
                        <span id="pontos-vantagem" readonly>8</span>
                    </div>
                    <div id="nivel-container" class="flex-1 min-w-[200px] flex flex-col items-center">
                        <label>Nível:</label>
                        <span id="nivel">0</span>
                    </div>
                </div>
            </section>

            <div class="flex justify-center gap-2 sm:gap-5 my-5 flex-wrap">
                <button id="vantagens-desvantagens-btn">Vantagens e Desvantagens</button>
                <button id="racas-btn">Raças 🏰</button>
                <button id="classes-btn">Classes ⚔️</button>
            </div>

            <div class="botoes-container">
                <button id="reset-pontos" class="botao botao-reset">Reiniciar Pontos</button>
                <button id="recomecar" class="botao botao-recomecar">Recomeçar</button>
                <button id="bloquear-ficha" class="botao botao-bloquear">Bloquear Ficha</button>
                <button id="plano-fundo-btn" class="botao">Plano de fundo</button>
                <button id="excluir-ficha" class="botao botao-excluir">Excluir Ficha</button> </div>

            <div class="theme-color-container">
                <button id="lua-btn" class="botao icon-btn">🌙</button>
                <button id="sol-btn" class="botao icon-btn">☀️</button>
                <div class="theme-option">
                    <label for="background-color-input" id="cor-fundo-visual-btn" class="botao icon-btn" title="Cor de Fundo" style="cursor: pointer;">🎨</label>
                    <input type="color" id="background-color-input" style="visibility: hidden; width: 0; height: 0; padding:0; margin:0; border:none;">
                </div>
                <div class="theme-option">
                    <select id="font-selector" class="botao" title="Fonte Principal" style="padding: 10px 15px; height: 44px; color:white; border:none; border-radius:6px; font-family:'MedievalSharp', serif;">
                        <option value="'Inter', sans-serif">Padrão (Inter)</option>
                        <option value="'MedievalSharp', cursive">Medieval</option>
                        <option value="'Times New Roman', Times, serif">Times New Roman</option>
                        <option value="'Arial', Helvetica, sans-serif">Arial</option>
                        <option value="'Courier New', Courier, monospace">Courier New</option>
                        <option value="'Georgia', serif">Georgia</option>
                        <option value="'Verdana', Geneva, sans-serif">Verdana</option>
                    </select>
                </div>
            </div>
        </div> <!-- Fim #ficha-content -->
    </div> <!-- Fim #ficha-container -->

    <button id="anotacoes-btn">Anotações</button>
    <textarea id="anotacoes-textarea" placeholder="Suas anotações aqui..."></textarea>

    <!-- Painéis de Vantagens/Desvantagens, Raças, Classes -->
    <div id="vantagens-desvantagens-panel">
        <h2>Vantagens e Desvantagens</h2>
        <div>Pontos de Vantagem Temporários: <span id="ph-temp">0</span></div>
        <div id="vantagens-list"></div>
        <div id="desvantagens-list"></div>
        <button id="salvar-vantagens-btn">SALVAR</button>
        <button id="fechar-pagina-btn">Fechar Página</button>
    </div>
    <div id="racas-panel">
        <h2>Raças</h2>
        <div id="ph-temp-raca-container" style="text-align: center; margin-bottom: 10px;">Pontos de Vantagem Temporários: <span id="ph-temp-raca">0</span></div>
        <div id="racas-list"></div>
        <button id="salvar-racas-btn">SALVAR</button>
        <button id="fechar-racas-btn">Fechar Página</button>
    </div>
    <div id="classes-panel">
        <h2>Classes</h2>
        <!-- Conteúdo do painel de classes aqui -->
        <button id="fechar-classes-btn">Fechar Página</button>
    </div>

    <!-- Modais -->
    <div id="nome-ficha-modal" class="modal">
        <div class="modal-content">
            <h3>Dê um Nome à Ficha</h3>
            <input type="text" id="nome-ficha-input" placeholder="Nome da ficha" maxlength="20">
            <button class="confirm-btn" id="confirmar-criar-ficha-btn">Confirmar</button>
            <button class="cancel-btn" onclick="fecharModal('nome-ficha-modal')">Cancelar</button>
        </div>
    </div>
    <div id="bloquear-ficha-modal" class="modal">
        <div class="modal-content">
            <h3>Ponha sua Senha de 4 Dígitos</h3>
            <input type="password" id="senha-bloqueio-input" placeholder="Senha (4 dígitos)" maxlength="4" inputmode="numeric" pattern="\d{4}">
            <button class="confirm-btn" id="confirmar-bloquear-ficha-btn">Confirmar</button>
            <button class="cancel-btn" onclick="fecharModal('bloquear-ficha-modal')">Cancelar</button>
        </div>
    </div>
    <div id="password-modal" class="modal">
        <div class="modal-content">
            <h3>Digite sua Senha</h3>
            <input type="password" id="senha-desbloqueio-input" placeholder="Senha (4 dígitos)" maxlength="4" inputmode="numeric" pattern="\d{4}">
            <button class="confirm-btn" id="confirmar-desbloquear-ficha-btn">Confirmar</button>
            <button class="cancel-btn" onclick="cancelarDesbloqueio()">Cancelar</button>
        </div>
    </div>
    <div id="confirmar-compra-modal" class="modal">
        <div class="modal-content">
            <h3>Tem certeza que quer comprar isso?</h3>
            <button class="confirm-btn" id="confirmar-compra-btn">Sim</button>
            <button class="cancel-btn" onclick="fecharModal('confirmar-compra-modal')">Não</button>
        </div>
    </div>
    <div id="salvar-vantagens-modal" class="modal">
        <div class="modal-content">
            <h3 id="salvar-modal-texto">Se salvar, as alterações não poderão ser desfeitas.</h3>
            <button class="confirm-btn" id="confirmar-salvar-vantagens-racas-btn">OK</button>
            <button class="cancel-btn" onclick="fecharModal('salvar-vantagens-modal')">Cancelar</button>
        </div>
    </div>
    <div id="senha-gm-modal" class="modal">
        <div class="modal-content">
            <h3 id="senha-gm-titulo">Peça permissão ao GM</h3>
            <input type="password" id="senha-gm-input" placeholder="Senha GM" maxlength="4" inputmode="numeric" pattern="\d{4}">
            <button class="confirm-btn" id="confirmar-senha-gm-btn">Confirmar</button>
            <button class="cancel-btn" onclick="fecharModal('senha-gm-modal')">Cancelar</button>
        </div>
    </div>
    <div id="raca-opcoes-modal" class="modal">
        <div class="modal-content">
            <h3>O que você deseja fazer?</h3>
            <button class="confirm-btn" id="excluir-raca-modal-btn">Excluir Raça</button>
            <button class="confirm-btn" id="editar-raca-modal-btn" style="margin-top: 10px;">Editar Raça</button>
            <button class="cancel-btn" onclick="fecharModal('raca-opcoes-modal')">Cancelar</button>
        </div>
    </div>
    <div id="editar-raca-modal" class="modal">
        <div class="modal-content">
            <h3>Editar Raça</h3>
            <label for="editar-raca-nome">Nome:</label>
            <input type="text" id="editar-raca-nome">
            <label for="editar-raca-descricao">Descrição:</label>
            <textarea id="editar-raca-descricao"></textarea>
            <button class="confirm-btn" id="salvar-edicao-raca-btn">Salvar</button>
            <button class="cancel-btn" onclick="fecharModal('editar-raca-modal')">Cancelar</button>
        </div>
    </div>
    <div id="notification"></div>
    <div id="background-modal" class="modal">
        <div class="modal-content">
            <h3>Plano de Fundo</h3>
            <label for="background-image-input">Selecionar Imagem:</label>
            <input type="file" id="background-image-input" accept="image/*">
            <div class="radio-group">
                <label><input type="radio" name="background-size" value="cover" checked>Preencher Tela</label>
                <label><input type="radio" name="background-size" value="100% 100%">Estender</label>
                <label><input type="radio" name="background-size" value="auto">Tamanho Normal</label>
            </div>
            <button class="confirm-btn" id="aplicar-plano-fundo-btn">Aplicar</button>
            <button class="cancel-btn" onclick="fecharModal('background-modal')">Cancelar</button>
            <button class="cancel-btn" id="excluir-plano-fundo-btn">Excluir Imagem</button>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Firebase SDK imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, deleteDoc, onSnapshot, collection, query, getDocs, writeBatch, serverTimestamp, enableIndexedDbPersistence, CACHE_SIZE_UNLIMITED, initializeFirestore, persistentLocalCache, persistentMultipleTabManager } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase config (will be replaced by __firebase_config if available)
        // const firebaseConfigFromUser = { // This is commented out as we will prioritize __firebase_config
        //     apiKey: "AIzaSyBbbwbwPXv6gztkyP3TXK-DtooEI7FcClI",
        //     authDomain: "ficha-de-rpg-b9685.firebaseapp.com",
        //     databaseURL: "https://ficha-de-rpg-b9685-default-rtdb.firebaseio.com",
        //     projectId: "ficha-de-rpg-b9685",
        //     storageBucket: "ficha-de-rpg-b9685.firebasestorage.app",
        //     messagingSenderId: "528610398062",
        //     appId: "1:528610398062:web:8fdb9cfd5ded8167613b7f"
        // };

        // Global Firebase instances
        let fbApp;
        let fbAuth;
        let fbDb;
        let userId = null; // Will be set after authentication
        let globalAppId = 'default-app-id'; // Default, will be replaced by __app_id

        // Firestore collection name
        const FICHAS_COLLECTION = "rpg_fichas";

        // Local cache for all fichas data
        let localFichasCache = {};
        let unsubscribeFichasListener = null; // To store the unsubscribe function for the collection listener

        // Constants for localStorage and default Ficha ID
        const RPG_CURRENT_FICHA_ID_KEY = 'rpgCurrentFichaId';
        const FICHA_MATRIZ_ID = "ficha-matriz"; // Default/template ficha ID

        let currentFichaId = null; // ID of the currently active ficha
        let isFichaLocked = false;
        let fichaPassword = null;
        let isFichaUnlocked = false; // Temporary unlock status for the current session
        let senhaMatriz = "1040"; // Master password

        let vantagensSelecionadas = [];
        let desvantagensSelecionadas = [];
        let tempVantagensSelecionadas = [];
        let tempDesvantagensSelecionadas = [];
        let racaSelecionada = null;
        let tempRacaSelecionada = null;

        let vidaTotal, vidaAtual, magiaTotal, magiaAtual, vigorTotal, vigorAtual;
        let previousValues = new Map(); // To store previous input values for revert on lock/validation

        const vantagensData = [
            { nome: "Maestria com Armas curtas (2)", custo: 2, descricao: "+1 em ataque, +1 em acerto com armas curtas." }, { nome: "Maestria com armas pesadas (2)", custo: 2, descricao: "+2 em ataque com armas pesadas." }, { nome: "Maestria com armas de longo alcance (2)", custo: 2, descricao: "+2 em acerto com armas de longo alcance." }, { nome: "Furtar (2)", custo: 2, descricao: "+4 em testes de furto." }, { nome: "Lábia (2)", custo: 2, descricao: "+5 em testes de lábia." }, { nome: "Velejar (1)", custo: 1, descricao: "" }, { nome: "Beleza (1)", custo: 1, descricao: "+3 o teste em lábia, paquera e persuasão." }, { nome: "Boa Fama (2)", custo: 2, descricao: "+4 chance de descontos em armamentos, pousadas, alimentos, etc." }, { nome: "Arremedo (2)", custo: 2, descricao: "Capacidade de imitar qualquer som SIMPLES." }, { nome: "Destemor (1)", custo: 1, descricao: "Dificilmente é assustado por algo." }, { nome: "Empatia (3)", custo: 3, descricao: "Sensibilidade extraordinária em relação aos outras pessoas. Excelente para identificar impostores, possessões por espirito, etc." }, { nome: "Empatia com animais (1)", custo: 1, descricao: "Pode compreender as motivações dos animais." }, { nome: "Patrono (4)", custo: 4, descricao: "Possui um mentor/mestre/professor, até mesmo uma organização/guilda que pode lhe oferecer ajuda." }, { nome: "Reconhecimento Social (2)", custo: 2, descricao: "Membro de um grupo respeitado/temido/venerado. +2 teste em lábia, paquera e persuasão." }, { nome: "Riqueza (2)", custo: 2, descricao: "Inicia com 20 moedas de ouro." }, { nome: "Aptidão para magia (4)", custo: 4, descricao: "+15% dano e -15% custo de magia para a magia que tem aptidão." }, { nome: "Combo Físico (4)", custo: 4, descricao: "Inicia com 50km velocidade corrida, pulo de 3m altura e 9m distância.", restricao: "inicio" }, { nome: "Nadar (1)", custo: 1, descricao: "" }, { nome: "Escalar (2)", custo: 2, descricao: "" }, { nome: "Segunda língua (1)", custo: 1, descricao: "Fala mais um idioma." }, { nome: "Paquerador (2)", custo: 2, descricao: "+4 em teste para paquera e persuasão envolvendo flerte." }, { nome: "Senso de perigo (5)", custo: 5, descricao: "Quando algo grave ocorrer o mestre pedirá pra você jogar um dado para reagir." }, { nome: "Acrobata (3)", custo: 3, descricao: "+ fama ao lutar em público." }, { nome: "Equilíbrio Perfeito (3)", custo: 3, descricao: "+8 em testes de equilíbrio." }, { nome: "Tecnologia (2)", custo: 2, descricao: "Engenhoso, pode inventar coisas, criar objetos improvisados." }, { nome: "Poder Oculto (7)", custo: 7, descricao: "Com 10% vida, ativa +50% em todos atributos. Volta ao normal acima de 10% vida." }, { nome: "Sobrevivência em floresta (2)", custo: 2, descricao: "Facilidade para achar cavernas, criar assentamentos, achar comida, gravar caminhos, achar água, etc." }
        ];
        const desvantagensData = [
            { nome: "Fobia (+2)", ganho: 2, descricao: "Medo irracional de algo específico." }, { nome: "Má Fama (+2)", ganho: 2, descricao: "Mal visto pela sociedade, dificultando interações sociais." }, { nome: "Alcoolismo (+2)", ganho: 2, descricao: "Dependência de álcool que afeta suas decisões." }, { nome: "Altruísmo (+2)", ganho: 2, descricao: "Se sacrifica por outras pessoas, pouco se importa com fama ou riqueza." }, { nome: "Avareza (+2)", ganho: 2, descricao: "Preocupação permanente na conservação de riquezas." }, { nome: "Bullying (+3)", ganho: 3, descricao: "Gosta de caçoar, agredir, denegrir, difamar e apontar defeitos." }, { nome: "Circunspeção (+2)", ganho: 2, descricao: "Não entende piadas, entende tudo literal e acredita que todos estão sérios." }, { nome: "Compulsões (+3)", ganho: 3, descricao: "Hábito ou vício que toma boa parte dos seus recursos e tempo." }, { nome: "Covardia (+2)", ganho: 2, descricao: "Extremo cuidado com bem-estar físico e dificuldade em assumir riscos." }, { nome: "Dependentes (+4)", ganho: 4, descricao: "Alguém depende de você a todo momento (filhos, parentes, etc.)." }, { nome: "Fúria (+2)", ganho: 2, descricao: "Tendência a perder o controle e atacar freneticamente (ativado por dano, insulto ou aleatório)." }, { nome: "Honestidade (+3)", ganho: 3, descricao: "Não consegue mentir ou omitir, sempre fala a verdade e desmascara mentiras." }, { nome: "Impulsividade (+2)", ganho: 2, descricao: "Sempre age sem pensar." }, { nome: "Luxúria (+2)", ganho: 2, descricao: "Desejo incontrolável por romance." }, { nome: "Magnetismo Sobrenatural (+2)", ganho: 2, descricao: "Coisas estranhas acontecem com seu personagem em nível alarmante." }, { nome: "No Limite (+4)", ganho: 4, descricao: "Assume riscos extremamente irracionais diante de perigo mortal." }, { nome: "Teimosia (+1)", ganho: 1, descricao: "Quer sempre fazer as coisas do seu modo, não segue planos que não sejam seus." }, { nome: "Amnésia (+2)", ganho: 2, descricao: "Em certos momentos, não consegue lembrar de coisas importantes." }
        ];
        let racasData = [
            { nome: "Humano (3)", custo: 3, descricao: "Versáteis, ambiciosos, mestres em adaptação.", vantagens: ["Explorador Nato: Cavalo superior, equipamentos, mapa detalhado.", "Mestre das Profissões: Escolha (Ferreiro Lendário, Costureiro Arcano, Arquiteto Visionário) com benefícios únicos.", "Rede de Influência: Aliado influente (guildas, mercadores, líderes) com acesso a informações ou ajuda.", "Determinação Inabalável: Uma vez/dia, ignore uma desvantagem (exaustão, ferimento, magia) por um curto período."] }, { nome: "Elfo (4)", custo: 4, descricao: "Sábios, mágicos, conectados à natureza.", vantagens: ["Sabedoria Ancestral: Domina área (arcana, história, natureza), decifra itens antigos, aprende 1 língua extra.", "Visão Élfica Suprema: Enxerga 10m escuro, detecta magias fracas 20m, percebe intenções hostis (teste 19+).", "Escudo Mágico: Resistência inata a um tipo de efeito mágico hostil (dano ou duração -50%)."] }, { nome: "Anão (4)", custo: 4, descricao: "Resilientes, habilidosos, ligados à terra.", vantagens: ["Fortitude Indomável: Trabalha 3 dias sem descanso, recupera vida/energia 2x mais rápido em rocha/subterrâneo.", "Artesão: Escolha (Mestre Minerador, Forjador de Lendas, Joalheiro Divino) com impacto massivo.", "Senhor das Profundezas: Nunca se perde subterrâneo, detecta armadilhas, sente vibrações (prever emboscada/colapso)."] }, { nome: "Orc (3)", custo: 3, descricao: "Guerreiros ferozes, líderes pela força.", vantagens: ["Lenda entre Guerreiros: Inspira temor/respeito, alianças marciais, acesso missões épicas; inimigos menores fogem (teste 16+).", "Resiliência Brutal: Luta sem penalidades com ferimentos graves, só cai com PV 0, regenera ferimentos leves fora de combate.", "Domínio da Intimidação: Força inimigos a render/recuar com grito (1x/encontro, afeta grupos), bônus massivo negociações (força/medo).", "Fúria Ancestral: Fúria 2x/dia (dobra força/resistência por curto período)."] }, { nome: "Meio Animal (Selvagem) (4)", custo: 4, descricao: "Instinto primal com astúcia.", vantagens: ["Sentidos Predatórios: Escolha (visão, olfato, audição) aguçado; rastreia km, detecta invisíveis, evita surpresa (teste 12+).", "Senhor dos Terrenos: Adapta-se a 1 ambiente (floresta, deserto, pântano), ignora efeitos negativos, bônus movimento/furtividade (+1).", "Frenesi Instintivo: 1x/dia, velocidade sobrenatural (2x movimento), ataques adicionais, percepção pré-monitória (10 min)."] }
        ];
        const nivelData = [
            { nivel: 0, xp: 0, pd: 25, ph: 8 }, { nivel: 1, xp: 10, pd: 31, ph: 9 }, { nivel: 2, xp: 30, pd: 37, ph: 10 }, { nivel: 3, xp: 60, pd: 43, ph: 11 }, { nivel: 4, xp: 100, pd: 49, ph: 12 }, { nivel: 5, xp: 150, pd: 55, ph: 13 }, { nivel: 6, xp: 210, pd: 61, ph: 14 }, { nivel: 7, xp: 280, pd: 67, ph: 15 }, { nivel: 8, xp: 360, pd: 73, ph: 16 }, { nivel: 9, xp: 450, pd: 79, ph: 17 }, { nivel: 10, xp: 550, pd: 85, ph: 18 }, { nivel: 11, xp: 670, pd: 91, ph: 19 }, { nivel: 12, xp: 810, pd: 97, ph: 20 }, { nivel: 13, xp: 970, pd: 103, ph: 21 }, { nivel: 14, xp: 1150, pd: 109, ph: 22 }, { nivel: 15, xp: 1350, pd: 115, ph: 23 }, { nivel: 16, xp: 1570, pd: 121, ph: 24 }, { nivel: 17, xp: 1810, pd: 127, ph: 25 }, { nivel: 18, xp: 2070, pd: 133, ph: 26 }, { nivel: 19, xp: 2350, pd: 139, ph: 27 }, { nivel: 20, xp: 2650, pd: 145, ph: 28 }, { nivel: 21, xp: 2980, pd: 148, ph: 29 }, { nivel: 22, xp: 3340, pd: 151, ph: 30 }, { nivel: 23, xp: 3730, pd: 154, ph: 31 }, { nivel: 24, xp: 4150, pd: 157, ph: 32 }, { nivel: 25, xp: 4600, pd: 160, ph: 33 }, { nivel: 26, xp: 5080, pd: 163, ph: 34 }, { nivel: 27, xp: 5590, pd: 166, ph: 35 }, { nivel: 28, xp: 6130, pd: 169, ph: 36 }, { nivel: 29, xp: 8000, pd: 219, ph: 37 }, { nivel: 30, xp: 10000, pd: 319, ph: 38 }
        ];

        // Cache DOM Elements
        const nomePersonagemInput = document.getElementById("nome-personagem");
        const descricaoPersonagemInput = document.getElementById("descricao-personagem");
        const forcaInput = document.getElementById("forca");
        const destrezaInput = document.getElementById("destreza");
        const agilidadeInput = document.getElementById("agilidade");
        const inteligenciaInput = document.getElementById("inteligencia");
        const constituicaoInput = document.getElementById("constituicao");
        const ataqueSpan = document.getElementById("ataque");
        const ataqueMagicoSpan = document.getElementById("ataque-magico");
        const acertoSpan = document.getElementById("acerto");
        const esquivaSpan = document.getElementById("esquiva");
        const rdfSpan = document.getElementById("rdf");
        const rdmSpan = document.getElementById("rdm");
        const armaDireitaNomeInput = document.getElementById("arma-direita-nome");
        const armaDireitaAtaqueInput = document.getElementById("arma-direita-ataque");
        const armaDireitaAtaqueMagicoInput = document.getElementById("arma-direita-ataque-magico");
        const armaEsquerdaNomeInput = document.getElementById("arma-esquerda-nome");
        const armaEsquerdaAtaqueInput = document.getElementById("arma-esquerda-ataque");
        const armaEsquerdaAtaqueMagicoInput = document.getElementById("arma-esquerda-ataque-magico");
        const resetPontosButton = document.getElementById("reset-pontos");
        const recomecarButton = document.getElementById("recomecar");
        const bloquearFichaButton = document.getElementById("bloquear-ficha");
        const experienciaInput = document.getElementById("experiencia");
        const nivelSpan = document.getElementById("nivel");
        const pontosHabilidadeSpan = document.getElementById("pontos-habilidade");
        const pontosVantagemSpan = document.getElementById("pontos-vantagem");
        const velocidadeCorridaSpan = document.getElementById("velocidade-corrida");
        const alturaPuloSpan = document.getElementById("altura-pulo");
        const distanciaPuloSpan = document.getElementById("distancia-pulo");
        const nomePersonagemTitulo = document.getElementById("nome-personagem-titulo");
        const gameMasterMessage = document.getElementById("game-master-message");
        const vantagensListDisplay = document.getElementById("vantagens-list-display");
        const desvantagensListDisplay = document.getElementById("desvantagens-list-display");
        const inventarioSlots = document.getElementById("inventario-slots");
        const pesoTotalSpan = document.getElementById("peso-total");
        const capacidadeCargaSpan = document.getElementById("capacidade-carga");
        const diceContainer = document.getElementById("dice-container");
        const diceRoll = document.getElementById("dice-roll");
        const diceResult = document.getElementById("dice-result");
        const notification = document.getElementById("notification");
        const characterImageInput = document.getElementById("character-image-input");
        const characterImage = document.getElementById("character-image");
        const vantagensDesvantagensBtn = document.getElementById("vantagens-desvantagens-btn");
        const vantagensDesvantagensPanel = document.getElementById("vantagens-desvantagens-panel");
        const vantagensList = document.getElementById("vantagens-list");
        const desvantagensList = document.getElementById("desvantagens-list");
        const salvarVantagensBtn = document.getElementById("salvar-vantagens-btn");
        const fecharPaginaBtn = document.getElementById("fechar-pagina-btn");
        const fichaContainer = document.getElementById("ficha-container");
        const magiasList = document.getElementById("magias-list");
        const adicionarMagiaBtn = document.getElementById("adicionar-magia-btn");
        const anotacoesBtn = document.getElementById("anotacoes-btn");
        const anotacoesTextarea = document.getElementById("anotacoes-textarea");
        const racasBtn = document.getElementById("racas-btn");
        const classesBtn = document.getElementById("classes-btn");
        const racasPanel = document.getElementById("racas-panel");
        const classesPanel = document.getElementById("classes-panel");
        const fecharRacasBtn = document.getElementById("fechar-racas-btn");
        const fecharClassesBtn = document.getElementById("fechar-classes-btn");
        const classeNomeInput = document.getElementById("classe-nome");
        const classeDescricaoInput = document.getElementById("classe-descricao");
        const racaNomeSpan = document.getElementById("raca-nome");
        const racaDescricaoInput = document.getElementById("raca-descricao");
        const luaBtn = document.getElementById("lua-btn");
        const solBtn = document.getElementById("sol-btn");
        const salvarRacasBtn = document.getElementById("salvar-racas-btn");
        const racasList = document.getElementById("racas-list");
        const atributosInputs = [forcaInput, destrezaInput, agilidadeInput, inteligenciaInput, constituicaoInput];
        const planoFundoBtn = document.getElementById("plano-fundo-btn");
        const backgroundImageInput = document.getElementById("background-image-input");
        const backgroundModal = document.getElementById("background-modal");
        const backgroundColorInput = document.getElementById('background-color-input');
        const backgroundColorButtonVisual = document.getElementById('cor-fundo-visual-btn');
        const fontSelector = document.getElementById('font-selector');
        const confirmarSalvarVantagensRacasBtn = document.getElementById("confirmar-salvar-vantagens-racas-btn"); // Renamed for clarity
        const phTempRacaSpan = document.getElementById("ph-temp-raca");
        const senhaGmTitulo = document.getElementById("senha-gm-titulo");
        const userIdDisplay = document.getElementById("user-id-container");


        let nivel = 0, nivelAnterior = 0, pontosHabilidadeTotal = 25, pontosHabilidadeUsados = 0, experiencia = 0, vidaBase = 50;
        let currentActionIntervalId = null;
        const REPEAT_DELAY_MS = 75;
        let xpUnlockTimerId = null;
        let isXpUnlocked = false;
        const XP_UNLOCK_DURATION_MS = 20000;


        // --- Firebase Initialization and Auth ---
        async function initializeAndAuthenticate() {
            try {
                // Use __app_id if available, otherwise use a default
                globalAppId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                console.log("Using App ID:", globalAppId);

                // Use __firebase_config if available
                let finalFirebaseConfig;
                if (typeof __firebase_config !== 'undefined' && __firebase_config) {
                    finalFirebaseConfig = JSON.parse(__firebase_config);
                    console.log("Using __firebase_config:", finalFirebaseConfig);
                } else {
                    // Fallback or error if __firebase_config is not provided
                    console.error("__firebase_config is not defined. Firebase cannot be initialized.");
                    showNotification("Erro: Configuração do Firebase não encontrada!", "critical-failure");
                    userIdDisplay.textContent = "Erro de configuração do Firebase.";
                    return;
                }

                fbApp = initializeApp(finalFirebaseConfig);
                
                // Use initializeFirestore for persistence settings
                fbDb = initializeFirestore(fbApp, {
                    localCache: persistentLocalCache({cacheSizeBytes: CACHE_SIZE_UNLIMITED, tabManager: persistentMultipleTabManager()})
                });

                // Enable offline persistence (optional, but good for UX)
                try {
                    await enableIndexedDbPersistence(fbDb);
                    console.log("Persistência offline ativada.");
                } catch (err) {
                    if (err.code == 'failed-precondition') {
                        console.warn("Persistência offline falhou: múltiplas abas abertas ou outra condição.");
                    } else if (err.code == 'unimplemented') {
                        console.warn("Persistência offline não suportada neste navegador.");
                    }
                }


                fbAuth = getAuth(fbApp);
                // fbDb.setLogLevel('debug'); // Firestore logging

                onAuthStateChanged(fbAuth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("Usuário autenticado:", userId);
                        userIdDisplay.textContent = `ID do Usuário: ${userId} (App: ${globalAppId})`;
                        await loadAndSyncFichas(); // Load fichas after user is authenticated
                    } else {
                        console.log("Nenhum usuário autenticado. Tentando login...");
                        userIdDisplay.textContent = "Autenticando...";
                        try {
                            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                                console.log("Tentando signInWithCustomToken...");
                                await signInWithCustomToken(fbAuth, __initial_auth_token);
                            } else {
                                console.log("Tentando signInAnonymously...");
                                await signInAnonymously(fbAuth);
                            }
                        } catch (error) {
                            console.error("Erro na autenticação:", error);
                            showNotification(`Erro de autenticação: ${error.message}`, "critical-failure");
                            userIdDisplay.textContent = "Falha na autenticação.";
                        }
                    }
                });
            } catch (error) {
                console.error("Erro ao inicializar Firebase:", error);
                showNotification("Erro crítico ao inicializar Firebase.", "critical-failure");
                userIdDisplay.textContent = "Erro crítico no Firebase.";
            }
        }


        // --- Firestore Data Handling ---
        function getFichaDocRef(fichaId) {
            // Path: /artifacts/{appId}/public/data/{collectionName}/{documentId}
            const collectionPath = `artifacts/${globalAppId}/public/data/${FICHAS_COLLECTION}`;
            return doc(fbDb, collectionPath, fichaId);
        }

        function getFichasCollectionRef() {
            const collectionPath = `artifacts/${globalAppId}/public/data/${FICHAS_COLLECTION}`;
            return collection(fbDb, collectionPath);
        }

        async function ensureFichaMatrizExists() {
            if (!localFichasCache[FICHA_MATRIZ_ID]) {
                console.log("Ficha Matriz não encontrada no cache local, verificando Firestore...");
                const matrizRef = getFichaDocRef(FICHA_MATRIZ_ID);
                try {
                    const docSnap = await getDoc(matrizRef);
                    if (!docSnap.exists()) {
                        console.log("Ficha Matriz não existe no Firestore. Criando...");
                        const fichaMatrizData = createDefaultFichaData("Matriz", FICHA_MATRIZ_ID);
                        fichaMatrizData.isLocked = true; // Matriz should be locked by default
                        fichaMatrizData.password = senhaMatriz; // Use master password
                        await setDoc(matrizRef, { ...fichaMatrizData, lastUpdated: serverTimestamp() });
                        localFichasCache[FICHA_MATRIZ_ID] = fichaMatrizData; // Add to local cache
                        console.log("Ficha Matriz criada no Firestore.");
                        return fichaMatrizData;
                    } else {
                        console.log("Ficha Matriz carregada do Firestore.");
                        localFichasCache[FICHA_MATRIZ_ID] = docSnap.data(); // Update local cache
                        return docSnap.data();
                    }
                } catch (error) {
                    console.error("Erro ao verificar/criar Ficha Matriz:", error);
                    showNotification("Erro ao acessar Ficha Matriz.", "critical-failure");
                    // Create a local fallback if Firestore fails
                    const fallbackMatriz = createDefaultFichaData("Matriz (Fallback)", FICHA_MATRIZ_ID);
                    localFichasCache[FICHA_MATRIZ_ID] = fallbackMatriz;
                    return fallbackMatriz;
                }
            }
            return localFichasCache[FICHA_MATRIZ_ID];
        }


        async function loadAndSyncFichas() {
            if (unsubscribeFichasListener) {
                unsubscribeFichasListener(); // Unsubscribe from previous listener if any
            }

            const fichasQuery = query(getFichasCollectionRef());
            unsubscribeFichasListener = onSnapshot(fichasQuery, async (querySnapshot) => {
                console.log("Recebida atualização da coleção de fichas.");
                const newCache = {};
                querySnapshot.forEach((doc) => {
                    newCache[doc.id] = { id: doc.id, ...doc.data() };
                });
                localFichasCache = newCache;

                await ensureFichaMatrizExists(); // Make sure Matriz is in cache

                atualizarAbasFichas();

                // Determine currentFichaId
                const storedCurrentFichaId = localStorage.getItem(RPG_CURRENT_FICHA_ID_KEY);
                if (storedCurrentFichaId && localFichasCache[storedCurrentFichaId]) {
                    currentFichaId = storedCurrentFichaId;
                } else if (Object.keys(localFichasCache).length > 0) {
                    // Default to Matriz if available, otherwise first available
                    currentFichaId = localFichasCache[FICHA_MATRIZ_ID] ? FICHA_MATRIZ_ID : Object.keys(localFichasCache)[0];
                } else {
                     currentFichaId = FICHA_MATRIZ_ID; // Fallback if cache is empty (after Matriz check)
                }
                
                if (currentFichaId && localFichasCache[currentFichaId]) {
                    console.log(`Carregando ficha ativa: ${currentFichaId}`);
                    populateUIWithFichaData(localFichasCache[currentFichaId]);
                } else if (currentFichaId === FICHA_MATRIZ_ID && !localFichasCache[FICHA_MATRIZ_ID]) {
                    // This case should be handled by ensureFichaMatrizExists, but as a safe guard:
                    console.warn("Ficha Matriz não está no cache após sync, tentando recarregar.");
                    const matrizData = await ensureFichaMatrizExists();
                    if (matrizData) populateUIWithFichaData(matrizData);
                } else {
                     console.warn(`Ficha ativa ${currentFichaId} não encontrada no cache. Tentando Matriz.`);
                     currentFichaId = FICHA_MATRIZ_ID; // Fallback
                     const matrizData = await ensureFichaMatrizExists();
                     if (matrizData) populateUIWithFichaData(matrizData);
                     else console.error("Não foi possível carregar nenhuma ficha.");
                }
                localStorage.setItem(RPG_CURRENT_FICHA_ID_KEY, currentFichaId);


            }, (error) => {
                console.error("Erro ao ouvir coleção de fichas:", error);
                showNotification("Erro ao sincronizar fichas.", "critical-failure");
            });
        }


        function createDefaultFichaData(nome, id) {
            return {
                id: id, // Ensure ID is part of the data
                nomeFicha: nome,
                nomePersonagem: "",
                descricaoPersonagem: "",
                forca: "0", destreza: "0", agilidade: "0", inteligencia: "0", constituicao: "0",
                experiencia: "0",
                armaDireitaNome: "", armaDireitaAtaque: "0", armaDireitaAtaqueMagico: "0",
                armaEsquerdaNome: "", armaEsquerdaAtaque: "0", armaEsquerdaAtaqueMagico: "0",
                vantagens: [], // Store as array
                magiasHabilidades: Array(10).fill(""), // Store as array
                desvantagens: [], // Store as array
                inventario: Array(10).fill({ item: "", peso: "0" }), // Store as array of objects
                velocidadeCorrida: "25", alturaPulo: "1", distanciaPulo: "3",
                isLocked: false, password: null, imagem: null, anotacoes: "",
                classeNome: "", classeDescricao: "", racaNome: "", racaDescricao: "", racaSelecionada: null,
                backgroundImage: null, backgroundSize: 'cover', backgroundColor: '#f0e6d2',
                fontFamily: "'Inter', sans-serif",
                darkMode: false,
                vidaAtual: 50, magiaAtual: 20, vigorAtual: 10,
                lastUpdated: serverTimestamp() // For Firestore
            };
        }


        function populateUIWithFichaData(fichaData) {
            if (!fichaData) {
                console.warn("Tentativa de popular UI com dados de ficha nulos. Ficha ID:", currentFichaId);
                 // Try to load Matriz as a fallback if current ficha data is missing
                if (localFichasCache[FICHA_MATRIZ_ID]) {
                    fichaData = localFichasCache[FICHA_MATRIZ_ID];
                    currentFichaId = FICHA_MATRIZ_ID; // Switch to Matriz
                    localStorage.setItem(RPG_CURRENT_FICHA_ID_KEY, currentFichaId);
                    showNotification("Ficha atual não encontrada, carregando Ficha Matriz.", "normal-result");
                    atualizarAbasFichas(); // Highlight Matriz tab
                } else {
                    showNotification("Erro: Dados da ficha não encontrados.", "critical-failure");
                    return;
                }
            }
            console.log("Populando UI com dados da ficha:", fichaData.nomeFicha, fichaData);

            isFichaUnlocked = false; // Reset temporary unlock when switching fichas

            nomePersonagemInput.value = fichaData.nomePersonagem || "";
            descricaoPersonagemInput.value = fichaData.descricaoPersonagem || "";
            forcaInput.value = fichaData.forca || "0";
            destrezaInput.value = fichaData.destreza || "0";
            agilidadeInput.value = fichaData.agilidade || "0";
            inteligenciaInput.value = fichaData.inteligencia || "0";
            constituicaoInput.value = fichaData.constituicao || "0";
            experienciaInput.value = fichaData.experiencia || "0";
            armaDireitaNomeInput.value = fichaData.armaDireitaNome || "";
            armaDireitaAtaqueInput.value = fichaData.armaDireitaAtaque || "0";
            armaDireitaAtaqueMagicoInput.value = fichaData.armaDireitaAtaqueMagico || "0";
            armaEsquerdaNomeInput.value = fichaData.armaEsquerdaNome || "";
            armaEsquerdaAtaqueInput.value = fichaData.armaEsquerdaAtaque || "0";
            armaEsquerdaAtaqueMagicoInput.value = fichaData.armaEsquerdaAtaqueMagico || "0";
            velocidadeCorridaSpan.textContent = fichaData.velocidadeCorrida || "25";
            alturaPuloSpan.textContent = fichaData.alturaPulo || "1";
            distanciaPuloSpan.textContent = fichaData.distanciaPulo || "3";

            isFichaLocked = fichaData.isLocked || false;
            fichaPassword = fichaData.password || null;
            atualizarBotaoBloquear();

            vantagensSelecionadas = Array.isArray(fichaData.vantagens) ? fichaData.vantagens : (fichaData.vantagens ? fichaData.vantagens.split("\n").filter(v => v.trim()) : []);
            desvantagensSelecionadas = Array.isArray(fichaData.desvantagens) ? fichaData.desvantagens : (fichaData.desvantagens ? fichaData.desvantagens.split("\n").filter(d => d.trim()) : []);
            
            vantagensListDisplay.innerHTML = "";
            desvantagensListDisplay.innerHTML = "";
            vantagensSelecionadas.forEach(v => { const div = document.createElement("div"); div.textContent = v; div.className = "list-item"; div.onclick = () => removerVantagem(v); vantagensListDisplay.appendChild(div); });
            desvantagensSelecionadas.forEach(d => { const div = document.createElement("div"); div.textContent = d; div.className = "list-item"; div.onclick = () => removerDesvantagem(d); desvantagensListDisplay.appendChild(div); });

            const inventario = Array.isArray(fichaData.inventario) ? fichaData.inventario : Array(10).fill({ item: "", peso: "0" });
            const invSlots = inventarioSlots.querySelectorAll(".inventory-slot");
            invSlots.forEach((slot, i) => {
                slot.querySelector(".inventory-item").value = inventario[i]?.item || "";
                slot.querySelector(".inventory-weight").value = inventario[i]?.peso || "0";
            });
            calcularPesoTotal();

            const magias = Array.isArray(fichaData.magiasHabilidades) ? fichaData.magiasHabilidades : (fichaData.magiasHabilidades && typeof fichaData.magiasHabilidades === 'string' ? fichaData.magiasHabilidades.split("\n") : Array(10).fill(""));
            magiasList.innerHTML = ""; // Clear previous inputs
            magias.forEach((m, i) => {
                const input = document.createElement("input");
                input.type = "text";
                input.className = "magia-nome";
                input.placeholder = `Magia/Habilidade ${i + 1}`;
                input.value = m;
                input.addEventListener('input', salvarDados); // Add event listener
                magiasList.appendChild(input);
            });
             // Ensure at least 10 magia slots are available if fewer are loaded
            const minMagiaSlots = 10;
            for (let i = magias.length; i < minMagiaSlots; i++) {
                const input = document.createElement("input");
                input.type = "text";
                input.className = "magia-nome";
                input.placeholder = `Magia/Habilidade ${i + 1}`;
                input.addEventListener('input', salvarDados);
                magiasList.appendChild(input);
            }


            anotacoesTextarea.value = fichaData.anotacoes || "";
            classeNomeInput.value = fichaData.classeNome || "";
            classeDescricaoInput.value = fichaData.classeDescricao || "";

            racaSelecionada = fichaData.racaSelecionada || null;
            racaNomeSpan.textContent = racaSelecionada ? racaSelecionada.split(" (")[0] : "Clique para selecionar/editar";
            const racaDataObj = racasData.find(r => r.nome === racaSelecionada);
            racaDescricaoInput.value = racaDataObj ? racaDataObj.vantagens.join("\n\n") : "";


            if (fichaData.imagem && fichaData.imagem.startsWith('data:image')) {
                characterImage.src = fichaData.imagem;
                characterImage.style.display = "block";
            } else {
                characterImage.src = '';
                characterImage.style.display = "none";
            }

            experiencia = parseInt(fichaData.experiencia) || 0;
            experienciaInput.readOnly = true;
            isXpUnlocked = false;
            if (xpUnlockTimerId) clearTimeout(xpUnlockTimerId);

            vidaAtual = fichaData.vidaAtual !== undefined ? fichaData.vidaAtual : 50;
            magiaAtual = fichaData.magiaAtual !== undefined ? fichaData.magiaAtual : 20;
            vigorAtual = fichaData.vigorAtual !== undefined ? fichaData.vigorAtual : 10;

            atualizarNivel(); // This calls calcularAtributos

            document.getElementById("vida-atual").textContent = vidaAtual;
            document.getElementById("magia-atual").textContent = magiaAtual;
            document.getElementById("vigor-atual").textContent = parseFloat(vigorAtual).toFixed(1);

            // Ensure current values don't exceed totals after calcularAtributos
            vidaAtual = Math.min(vidaAtual, vidaTotal);
            magiaAtual = Math.min(magiaAtual, magiaTotal);
            vigorAtual = Math.min(vigorAtual, vigorTotal);

            document.getElementById("vida-atual").textContent = vidaAtual;
            document.getElementById("magia-atual").textContent = magiaAtual;
            document.getElementById("vigor-atual").textContent = parseFloat(vigorAtual).toFixed(1);


            pontosVantagemSpan.textContent = getPontosVantagem();

            // Apply theme settings
            document.body.classList.toggle("dark-mode", fichaData.darkMode === true);
            aplicarPlanoDeFundoInicial(fichaData);
            aplicarCorDeFundoInicial(fichaData);
            aplicarFonteInicial(fichaData);

            // Store initial values for potential reverts
            previousValues.clear();
            document.querySelectorAll('input[type="text"],input[type="number"],textarea,select').forEach(input => {
                previousValues.set(input, input.value);
            });
            if (fontSelector) previousValues.set(fontSelector, fontSelector.value);

            // Update title
            nomePersonagemTitulo.textContent = fichaData.nomeFicha || "Ficha de Personagem";

            console.log("UI populada para:", fichaData.nomeFicha);
        }

        async function salvarDados() {
            if (!currentFichaId || !localFichasCache[currentFichaId]) {
                console.warn("Tentativa de salvar dados sem ficha ativa ou dados no cache.");
                showNotification("Nenhuma ficha ativa para salvar.", "critical-failure");
                return;
            }
            if (isFichaLocked && !isFichaUnlocked && currentFichaId !== FICHA_MATRIZ_ID) {
                console.log("Ficha bloqueada. Salvamento impedido.");
                // Revert inputs to previous values if locked and not unlocked
                document.querySelectorAll('input[type="text"],input[type="number"],textarea').forEach(input => {
                    if (previousValues.has(input)) {
                        input.value = previousValues.get(input);
                    }
                });
                if (fontSelector && previousValues.has(fontSelector)) fontSelector.value = previousValues.get(fontSelector);
                // Optionally, re-calculate attributes if they were changed by locked inputs
                // calcularAtributos(); 
                abrirModalSenha(); // Prompt for password
                return;
            }

            const inventario = Array.from(inventarioSlots.querySelectorAll(".inventory-slot")).map(slot => ({
                item: slot.querySelector(".inventory-item").value,
                peso: slot.querySelector(".inventory-weight").value
            }));
            const magias = Array.from(magiasList.querySelectorAll(".magia-nome")).map(input => input.value);

            const fichaDataToSave = {
                ...localFichasCache[currentFichaId], // Preserve existing fields not on the form
                id: currentFichaId, // Ensure ID is part of the data
                nomeFicha: localFichasCache[currentFichaId].nomeFicha, // Nome da ficha não é editável no form principal
                nomePersonagem: nomePersonagemInput.value,
                descricaoPersonagem: descricaoPersonagemInput.value,
                forca: forcaInput.value,
                destreza: destrezaInput.value,
                agilidade: agilidadeInput.value,
                inteligencia: inteligenciaInput.value,
                constituicao: constituicaoInput.value,
                experiencia: experienciaInput.value,
                armaDireitaNome: armaDireitaNomeInput.value,
                armaDireitaAtaque: armaDireitaAtaqueInput.value,
                armaDireitaAtaqueMagico: armaDireitaAtaqueMagicoInput.value,
                armaEsquerdaNome: armaEsquerdaNomeInput.value,
                armaEsquerdaAtaque: armaEsquerdaAtaqueInput.value,
                armaEsquerdaAtaqueMagico: armaEsquerdaAtaqueMagicoInput.value,
                vantagens: vantagensSelecionadas, // Saved as array
                magiasHabilidades: magias, // Saved as array
                desvantagens: desvantagensSelecionadas, // Saved as array
                inventario: inventario,
                velocidadeCorrida: velocidadeCorridaSpan.textContent,
                alturaPulo: alturaPuloSpan.textContent,
                distanciaPulo: distanciaPuloSpan.textContent,
                isLocked: isFichaLocked,
                password: fichaPassword,
                imagem: characterImage.src.startsWith('data:image') ? characterImage.src : null,
                anotacoes: anotacoesTextarea.value,
                classeNome: classeNomeInput.value,
                classeDescricao: classeDescricaoInput.value,
                racaNome: racaNomeSpan.textContent,
                racaDescricao: racaDescricaoInput.value,
                racaSelecionada: racaSelecionada,
                backgroundImage: document.body.style.backgroundImage === 'none' || document.body.style.backgroundImage === '' ? null : document.body.style.backgroundImage.slice(5, -2).replace(/"/g, "").replace(/'/g, ""),
                backgroundSize: document.body.style.backgroundSize || 'cover',
                backgroundColor: document.body.style.backgroundColor || '#f0e6d2',
                darkMode: document.body.classList.contains("dark-mode"),
                fontFamily: fontSelector ? fontSelector.value : "'Inter', sans-serif",
                vidaAtual: vidaAtual,
                magiaAtual: magiaAtual,
                vigorAtual: vigorAtual,
                lastUpdated: serverTimestamp()
            };

            // Update local cache immediately for responsiveness
            localFichasCache[currentFichaId] = fichaDataToSave;

            try {
                const fichaRef = getFichaDocRef(currentFichaId);
                await setDoc(fichaRef, fichaDataToSave); // Use setDoc to overwrite or create
                console.log("Dados salvos no Firestore para:", currentFichaId);
                showNotification("Salvo na Nuvem!", "save-success");

                // Update previousValues after successful save
                document.querySelectorAll('input[type="text"],input[type="number"],textarea').forEach(input => {
                     previousValues.set(input, input.value);
                });
                if (fontSelector) previousValues.set(fontSelector, fontSelector.value);


            } catch (error) {
                console.error("Erro ao salvar dados no Firestore:", error);
                showNotification("Erro ao salvar na nuvem.", "critical-failure");
            }
        }


        // --- Ficha Management (Tabs, Create, Delete) ---
        function atualizarAbasFichas() {
            const sidebar = document.getElementById("fichas-sidebar");
            const addBtn = document.getElementById("add-ficha-btn");
            
            // Clear existing tabs except the add button
            const tabsToRemove = [];
            for (let i = 0; i < sidebar.children.length; i++) {
                if (sidebar.children[i] !== addBtn) {
                    tabsToRemove.push(sidebar.children[i]);
                }
            }
            tabsToRemove.forEach(tab => sidebar.removeChild(tab));

            // Sort fichas: Matriz first, then alphabetically by nomeFicha
            const sortedFichaIds = Object.keys(localFichasCache).sort((a, b) => {
                if (a === FICHA_MATRIZ_ID) return -1;
                if (b === FICHA_MATRIZ_ID) return 1;
                const nomeA = localFichasCache[a]?.nomeFicha?.toLowerCase() || "";
                const nomeB = localFichasCache[b]?.nomeFicha?.toLowerCase() || "";
                return nomeA.localeCompare(nomeB);
            });

            sortedFichaIds.forEach(fichaId => {
                const ficha = localFichasCache[fichaId];
                if (!ficha) return;

                const tab = document.createElement("div");
                tab.className = "ficha-tab";
                const span = document.createElement("span");
                span.textContent = ficha.nomeFicha || "Sem Nome";
                tab.appendChild(span);
                tab.dataset.fichaId = fichaId;

                if (fichaId === currentFichaId) {
                    tab.classList.add("active");
                }

                tab.onclick = () => {
                    if (currentFichaId !== fichaId) {
                        currentFichaId = fichaId;
                        localStorage.setItem(RPG_CURRENT_FICHA_ID_KEY, currentFichaId);
                        if (localFichasCache[currentFichaId]) {
                            populateUIWithFichaData(localFichasCache[currentFichaId]);
                        } else {
                            console.warn(`Dados da ficha ${currentFichaId} não encontrados no cache ao trocar de aba.`);
                            // Attempt to load Matriz as fallback
                             if (localFichasCache[FICHA_MATRIZ_ID]) {
                                currentFichaId = FICHA_MATRIZ_ID;
                                localStorage.setItem(RPG_CURRENT_FICHA_ID_KEY, currentFichaId);
                                populateUIWithFichaData(localFichasCache[FICHA_MATRIZ_ID]);
                            }
                        }
                        atualizarAbasFichas(); // Re-render tabs to update active state
                    }
                };
                sidebar.insertBefore(tab, addBtn); // Insert before the add button
            });
        }


        document.getElementById("add-ficha-btn").onclick = () => {
            document.getElementById("nome-ficha-modal").style.display = "flex";
            document.getElementById("nome-ficha-input").value = "";
            document.getElementById("nome-ficha-input").focus();
        };

        async function criarNovaFicha() {
            const nomeFichaInputElem = document.getElementById("nome-ficha-input");
            const nomeFicha = nomeFichaInputElem.value.trim();
            if (!nomeFicha) {
                alert("Por favor, dê um nome à ficha!");
                return;
            }
            if (Object.values(localFichasCache).some(f => f.nomeFicha === nomeFicha)) {
                alert("Uma ficha com este nome já existe. Por favor, escolha outro nome.");
                return;
            }

            const novaFichaId = `ficha_${Date.now()}_${Math.random().toString(36).substr(2, 5)}`;
            const novaFichaData = createDefaultFichaData(nomeFicha, novaFichaId);

            // Update local cache
            localFichasCache[novaFichaId] = novaFichaData;

            try {
                const fichaRef = getFichaDocRef(novaFichaId);
                await setDoc(fichaRef, novaFichaData);
                console.log("Nova ficha criada no Firestore:", novaFichaId);

                currentFichaId = novaFichaId;
                localStorage.setItem(RPG_CURRENT_FICHA_ID_KEY, currentFichaId);
                
                populateUIWithFichaData(novaFichaData); // Populate UI with new ficha data
                atualizarAbasFichas(); // Update tabs display
                fecharModal("nome-ficha-modal");
                nomeFichaInputElem.value = ""; // Clear input for next time
                showNotification(`Ficha "${nomeFicha}" criada!`, "save-success");

            } catch (error) {
                console.error("Erro ao criar nova ficha no Firestore:", error);
                showNotification("Erro ao criar ficha na nuvem.", "critical-failure");
                // Revert local cache change if Firestore save fails
                delete localFichasCache[novaFichaId];
            }
        }
        document.getElementById("confirmar-criar-ficha-btn").onclick = criarNovaFicha;


        document.getElementById("excluir-ficha").onclick = async () => {
            if (!currentFichaId || !localFichasCache[currentFichaId]) {
                alert("Nenhuma ficha selecionada para excluir.");
                return;
            }
            if (currentFichaId === FICHA_MATRIZ_ID) {
                alert("A Ficha Matriz não pode ser excluída!");
                return;
            }
            if (isFichaLocked && !isFichaUnlocked) {
                abrirModalSenha(document.getElementById("excluir-ficha"));
                return;
            }

            if (confirm(`Tem certeza que deseja excluir a ficha "${localFichasCache[currentFichaId].nomeFicha}"? Esta ação não pode ser desfeita.`)) {
                const fichaIdToDelete = currentFichaId;
                try {
                    const fichaRef = getFichaDocRef(fichaIdToDelete);
                    await deleteDoc(fichaRef);
                    console.log("Ficha excluída do Firestore:", fichaIdToDelete);
                    
                    // Local cache will be updated by the onSnapshot listener.
                    // Switch to Matriz or first available ficha.
                    currentFichaId = FICHA_MATRIZ_ID;
                    if (!localFichasCache[FICHA_MATRIZ_ID] && Object.keys(localFichasCache).length > 0) {
                         currentFichaId = Object.keys(localFichasCache).find(id => id !== fichaIdToDelete) || null;
                    }
                    
                    if (currentFichaId && localFichasCache[currentFichaId]) {
                         localStorage.setItem(RPG_CURRENT_FICHA_ID_KEY, currentFichaId);
                         populateUIWithFichaData(localFichasCache[currentFichaId]);
                    } else if (localFichasCache[FICHA_MATRIZ_ID]) { // Fallback to Matriz if current becomes invalid
                        currentFichaId = FICHA_MATRIZ_ID;
                        localStorage.setItem(RPG_CURRENT_FICHA_ID_KEY, currentFichaId);
                        populateUIWithFichaData(localFichasCache[FICHA_MATRIZ_ID]);
                    } else {
                        // If no fichas left, clear UI or show placeholder
                        console.log("Nenhuma ficha restante após exclusão.");
                        // Potentially clear the form or load a default empty state
                        const emptyMatriz = await ensureFichaMatrizExists(); // Attempt to load/create Matriz
                        populateUIWithFichaData(emptyMatriz);

                    }
                    atualizarAbasFichas(); // This will reflect the deletion
                    showNotification("Ficha excluída.", "normal-result");

                } catch (error) {
                    console.error("Erro ao excluir ficha do Firestore:", error);
                    showNotification("Erro ao excluir ficha da nuvem.", "critical-failure");
                }
            }
        };

        // --- Modal and UI Helper Functions ---
        function fecharModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) modal.style.display = "none";
        }

        function showNotification(message, type) {
            notification.textContent = message;
            notification.className = type; // type can be 'critical-failure', 'critical-success', 'normal-result', 'save-success'
            notification.style.display = "block";
            setTimeout(() => {
                notification.style.display = "none";
                notification.className = "";
            }, 3000); // Increased duration
        }


        // --- Core RPG Logic (largely unchanged, but interacts with global vars like currentFichaId) ---
        function calcularNivel(exp) { return nivelData.findLast(data => exp >= data.xp)?.nivel ?? 0; }

        function atualizarNivel() {
            nivelAnterior = nivel;
            nivel = calcularNivel(experiencia);
            nivelSpan.textContent = nivel;
            const nivelInfo = nivelData.find(data => data.nivel === nivel) || nivelData[0];
            pontosHabilidadeTotal = nivelInfo.pd;
            pontosVantagemSpan.textContent = getPontosVantagem(); // This needs to be correct
            if (nivel > nivelAnterior) {
                nivelSpan.classList.add("aura-azul");
                setTimeout(() => nivelSpan.classList.remove("aura-azul"), 20000);
            }
            gameMasterMessage.style.display = nivel >= 30 ? "block" : "none";
            fichaContainer.classList.toggle("aura-azul", nivel >= 30);
            calcularAtributos();
        }

        function getPontosVantagem() {
            let phBase = (nivelData.find(data => data.nivel === nivel) || nivelData[0]).ph;
            let phGastosVantagens = 0;
            vantagensSelecionadas.forEach(vNome => {
                const vantagem = vantagensData.find(d => d.nome === vNome);
                if (vantagem) phGastosVantagens += vantagem.custo;
            });
            let phGanhosDesvantagens = 0;
            desvantagensSelecionadas.forEach(dNome => {
                const desvantagem = desvantagensData.find(desv => desv.nome === dNome);
                if (desvantagem) phGanhosDesvantagens += desvantagem.ganho;
            });
            let phCustoRaca = 0;
            if (racaSelecionada) {
                const raca = racasData.find(r => r.nome === racaSelecionada);
                if (raca) phCustoRaca = raca.custo;
            }
            return phBase - phGastosVantagens + phGanhosDesvantagens - phCustoRaca;
        }


        function calcularPontosVantagemTemp() { // For panels
            let phBase = (nivelData.find(data => data.nivel === nivel) || nivelData[0]).ph;
            let phGastosVantagens = 0;
            tempVantagensSelecionadas.forEach(vNome => {
                const vantagem = vantagensData.find(d => d.nome === vNome);
                if (vantagem) phGastosVantagens += vantagem.custo;
            });
            let phGanhosDesvantagens = 0;
            tempDesvantagensSelecionadas.forEach(dNome => {
                const desvantagem = desvantagensData.find(desv => desv.nome === dNome);
                if (desvantagem) phGanhosDesvantagens += desvantagem.ganho;
            });
            let phCustoRaca = 0;
            if (tempRacaSelecionada) { // Use tempRacaSelecionada for panel calculation
                const raca = racasData.find(r => r.nome === tempRacaSelecionada);
                if (raca) phCustoRaca = raca.custo;
            }
            return phBase - phGastosVantagens + phGanhosDesvantagens - phCustoRaca;
        }


        function calcularAtributos() {
            let currentForca = parseInt(forcaInput.value) || 0;
            let currentDestreza = parseInt(destrezaInput.value) || 0;
            let currentAgilidade = parseInt(agilidadeInput.value) || 0;
            let currentInteligencia = parseInt(inteligenciaInput.value) || 0;
            let currentConstituicao = parseInt(constituicaoInput.value) || 0;

            let totalPontosAtuais = currentForca + currentDestreza + currentAgilidade + currentInteligencia + currentConstituicao;

            if (totalPontosAtuais > pontosHabilidadeTotal) {
                showNotification("Pontos de habilidade insuficientes! Atributos revertidos.", "critical-failure");
                forcaInput.value = previousValues.get(forcaInput) || "0";
                destrezaInput.value = previousValues.get(destrezaInput) || "0";
                agilidadeInput.value = previousValues.get(agilidadeInput) || "0";
                inteligenciaInput.value = previousValues.get(inteligenciaInput) || "0";
                constituicaoInput.value = previousValues.get(constituicaoInput) || "0";

                currentForca = parseInt(forcaInput.value) || 0;
                currentDestreza = parseInt(destrezaInput.value) || 0;
                currentAgilidade = parseInt(agilidadeInput.value) || 0;
                currentInteligencia = parseInt(inteligenciaInput.value) || 0;
                currentConstituicao = parseInt(constituicaoInput.value) || 0;
            }
            
            // Update previousValues for attributes here, as they might have been reverted
            previousValues.set(forcaInput, forcaInput.value);
            previousValues.set(destrezaInput, destrezaInput.value);
            previousValues.set(agilidadeInput, agilidadeInput.value);
            previousValues.set(inteligenciaInput, inteligenciaInput.value);
            previousValues.set(constituicaoInput, constituicaoInput.value);

            pontosHabilidadeUsados = currentForca + currentDestreza + currentAgilidade + currentInteligencia + currentConstituicao;
            pontosHabilidadeSpan.textContent = pontosHabilidadeTotal - pontosHabilidadeUsados;

            let ataque = currentForca + Math.floor(currentDestreza / 5);
            let acerto = Math.floor(currentDestreza / 3) + Math.floor(currentAgilidade / 10);
            let esquiva = Math.floor(currentAgilidade / 3);
            let rdf = Math.floor(currentForca / 5);
            let rdm = Math.floor(currentInteligencia / 5);
            let ataqueMagico = currentInteligencia;
            let magiaBase = 20 + 3 * currentConstituicao;
            let vigorBase = 10 + 0.4 * currentConstituicao;
            vidaBase = 50 + (currentConstituicao * (3 + Math.floor(currentForca / 10))) + 10 * nivel;
            if (currentInteligencia >= 10) magiaBase += currentConstituicao * Math.floor(currentInteligencia / 10);

            ataque += (parseInt(armaDireitaAtaqueInput.value) || 0) + (parseInt(armaEsquerdaAtaqueInput.value) || 0);
            ataqueMagico += (parseInt(armaDireitaAtaqueMagicoInput.value) || 0) + (parseInt(armaEsquerdaAtaqueMagicoInput.value) || 0);

            const capacidadeBase = 5;
            const bonusForcaCarga = Math.floor(currentForca / 5);
            const capacidadeCargaVal = capacidadeBase + bonusForcaCarga;
            if (capacidadeCargaSpan) capacidadeCargaSpan.textContent = capacidadeCargaVal;

            const pesoTotalAtual = parseFloat(pesoTotalSpan.textContent) || 0;
            let penalidadeEsquivaAcerto = 0;
            const sobrecarga = pesoTotalAtual - capacidadeCargaVal;

            if (sobrecarga > 0) {
                penalidadeEsquivaAcerto = -1;
                const sobrecargaAdicional = sobrecarga - 3;
                if (sobrecargaAdicional > 0) {
                    penalidadeEsquivaAcerto -= Math.ceil(sobrecargaAdicional / 3);
                }
            }

            acerto += penalidadeEsquivaAcerto;
            esquiva += penalidadeEsquivaAcerto;

            if (pesoTotalSpan && capacidadeCargaSpan) {
                const color = sobrecarga > 0 ? 'red' : '';
                pesoTotalSpan.style.color = color;
                capacidadeCargaSpan.style.color = color;
            }

            const velocidadeBase = 25 + Math.floor(currentAgilidade / 3) * 3;
            const alturaPuloBase = 1 + Math.floor(currentForca / 10);
            const distanciaPuloBase = 3 + 3 * Math.min(Math.floor(currentForca / 5), Math.floor(currentAgilidade / 5));
            let bonusVelocidade = vantagensSelecionadas.includes("Combo Físico (4)") ? 25 : 0;
            let bonusAlturaPulo = vantagensSelecionadas.includes("Combo Físico (4)") ? 2 : 0;
            let bonusDistanciaPulo = vantagensSelecionadas.includes("Combo Físico (4)") ? 6 : 0;

            velocidadeCorridaSpan.textContent = velocidadeBase + bonusVelocidade;
            alturaPuloSpan.textContent = alturaPuloBase + bonusAlturaPulo;
            distanciaPuloSpan.textContent = distanciaPuloBase + bonusDistanciaPulo;
            ataqueSpan.textContent = ataque;
            ataqueMagicoSpan.textContent = ataqueMagico;
            acertoSpan.textContent = acerto;
            esquivaSpan.textContent = esquiva;
            rdfSpan.textContent = rdf;
            rdmSpan.textContent = rdm;

            vidaTotal = Math.ceil(vidaBase);
            magiaTotal = Math.ceil(magiaBase);
            vigorTotal = parseFloat(vigorBase.toFixed(1));

            document.getElementById("vida-total").textContent = vidaTotal;
            document.getElementById("magia-total").textContent = magiaTotal;
            document.getElementById("vigor-total").textContent = vigorTotal.toFixed(1);

            // Clamp current values to new totals if they exceed them
            vidaAtual = Math.min(vidaAtual, vidaTotal);
            magiaAtual = Math.min(magiaAtual, magiaTotal);
            vigorAtual = Math.min(vigorAtual, vigorTotal);

            document.getElementById("vida-atual").textContent = vidaAtual;
            document.getElementById("magia-atual").textContent = magiaAtual;
            document.getElementById("vigor-atual").textContent = vigorAtual.toFixed(1);


            const regeneracaoVida = (0.2 * currentConstituicao).toFixed(1);
            const regeneracaoMagia = (0.8 * currentConstituicao).toFixed(1);
            const regeneracaoVigor = (0.4 * currentConstituicao).toFixed(1);
            document.getElementById("regeneracao-vida").textContent = regeneracaoVida;
            document.getElementById("regeneracao-magia").textContent = regeneracaoMagia;
            document.getElementById("regeneracao-vigor").textContent = regeneracaoVigor;

            const atributosSpans = [{ span: ataqueSpan, valor: ataque }, { span: ataqueMagicoSpan, valor: ataqueMagico }, { span: acertoSpan, valor: acerto }, { span: esquivaSpan, valor: esquiva }, { span: rdfSpan, valor: rdf }, { span: rdmSpan, valor: rdm }];
            atributosSpans.forEach(a => a.span.classList.remove("atributo-fogo"));
            const maxAtributo = atributosSpans.reduce((prev, curr) => (curr.valor > prev.valor ? curr : prev), { valor: -Infinity }); // Ensure a valid initial comparison
            if (maxAtributo.valor > 0) maxAtributo.span.classList.add("atributo-fogo");
        }


        function aumentarVida() { if (vidaAtual < vidaTotal) { vidaAtual++; document.getElementById("vida-atual").textContent = vidaAtual; salvarDados(); } }
        function diminuirVida() { if (vidaAtual > 0) { vidaAtual--; document.getElementById("vida-atual").textContent = vidaAtual; salvarDados(); } }
        function aumentarMagia() { if (magiaAtual < magiaTotal) { magiaAtual++; document.getElementById("magia-atual").textContent = magiaAtual; salvarDados(); } }
        function diminuirMagia() { if (magiaAtual > 0) { magiaAtual--; document.getElementById("magia-atual").textContent = magiaAtual; salvarDados(); } }
        function aumentarVigor() { if (vigorAtual < vigorTotal) { vigorAtual = Math.min(vigorAtual + 0.1, vigorTotal); document.getElementById("vigor-atual").textContent = vigorAtual.toFixed(1); salvarDados(); } }
        function diminuirVigor() { if (vigorAtual > 0) { vigorAtual = Math.max(vigorAtual - 0.1, 0); document.getElementById("vigor-atual").textContent = vigorAtual.toFixed(1); salvarDados(); } }


        function resetarPontos() {
            if (isFichaLocked && !isFichaUnlocked && currentFichaId !== FICHA_MATRIZ_ID) return abrirModalSenha(resetPontosButton);
            senhaGmTitulo.textContent = "Peça permissão ao GM para Resetar Pontos";
            document.getElementById("senha-gm-modal").style.display = "flex";
            document.getElementById("senha-gm-input").value = "";
            document.getElementById("confirmar-senha-gm-btn").onclick = () => {
                if (document.getElementById("senha-gm-input").value === senhaMatriz) {
                    atributosInputs.forEach(input => input.value = 0);
                    pontosHabilidadeUsados = 0;
                    pontosHabilidadeSpan.textContent = pontosHabilidadeTotal; // This should be correct based on current level
                    velocidadeCorridaSpan.textContent = "25";
                    alturaPuloSpan.textContent = "1";
                    distanciaPuloSpan.textContent = "3";
                    calcularAtributos(); // Recalculate derived stats
                    pontosVantagemSpan.textContent = getPontosVantagem(); // Recalculate PH
                    salvarDados();
                    fecharModal("senha-gm-modal");
                    showNotification("Pontos de atributo resetados.", "normal-result");
                } else {
                    alert("Senha do GM incorreta!");
                    fecharModal("senha-gm-modal");
                }
            };
        }

        function recomecarFicha() {
            if (isFichaLocked && !isFichaUnlocked && currentFichaId !== FICHA_MATRIZ_ID) return abrirModalSenha(recomecarButton);
            if (confirm("Tem certeza que deseja recomeçar a ficha? Todas as alterações serão perdidas e salvas na nuvem.")) {
                const currentFichaNome = localFichasCache[currentFichaId]?.nomeFicha || "Ficha Atual";
                const defaultData = createDefaultFichaData(currentFichaNome, currentFichaId); // Use existing name and ID

                // Apply default data to UI and internal state
                isFichaLocked = defaultData.isLocked; // Usually false for a reset unless it's Matriz
                fichaPassword = defaultData.password;
                if (currentFichaId === FICHA_MATRIZ_ID) { // Matriz specific lock
                    isFichaLocked = true;
                    fichaPassword = senhaMatriz;
                }

                vantagensSelecionadas = [...defaultData.vantagens];
                desvantagensSelecionadas = [...defaultData.desvantagens];
                racaSelecionada = defaultData.racaSelecionada;
                
                experiencia = parseInt(defaultData.experiencia) || 0;
                experienciaInput.value = experiencia.toString();
                experienciaInput.readOnly = true;
                isXpUnlocked = false;
                if (xpUnlockTimerId) clearTimeout(xpUnlockTimerId);

                vidaAtual = defaultData.vidaAtual;
                magiaAtual = defaultData.magiaAtual;
                vigorAtual = defaultData.vigorAtual;

                // Populate UI with default data (this will also call atualizarNivel and calcularAtributos)
                populateUIWithFichaData(defaultData); 
                
                // Explicitly save the reset state to Firestore
                salvarDados(); 
                showNotification("Ficha recomeçada.", "normal-result");
            }
        }

        // --- Lock/Unlock Logic ---
        function atualizarBotaoBloquear() {
            bloquearFichaButton.textContent = isFichaLocked ? "Desbloquear Ficha" : "Bloquear Ficha";
            bloquearFichaButton.classList.toggle("botao-bloquear", !isFichaLocked);
            bloquearFichaButton.classList.toggle("botao-desbloquear", isFichaLocked);
        }

        bloquearFichaButton.onclick = () => {
            if (currentFichaId === FICHA_MATRIZ_ID) {
                alert("A Ficha Matriz é bloqueada/desbloqueada com a senha mestre (1040).");
                 abrirModalSenha(); // Allow trying to unlock Matriz
                return;
            }
            if (isFichaLocked) {
                abrirModalSenha();
            } else {
                document.getElementById("bloquear-ficha-modal").style.display = "flex";
                document.getElementById("senha-bloqueio-input").value = "";
                document.getElementById("senha-bloqueio-input").focus();
            }
        };
        document.getElementById("confirmar-bloquear-ficha-btn").onclick = () => { // Bind to new button ID
            const senha = document.getElementById("senha-bloqueio-input").value;
            if (senha.length !== 4 || !/^\d{4}$/.test(senha)) {
                alert("A senha deve ter exatamente 4 dígitos numéricos!");
                return;
            }
            isFichaLocked = true;
            fichaPassword = senha;
            isFichaUnlocked = false; // Locking resets temporary unlock
            salvarDados(); // Save lock state to Firestore
            fecharModal("bloquear-ficha-modal");
            alert("Ficha bloqueada com sucesso!");
            atualizarBotaoBloquear();
        };

        function abrirModalSenha(element = null) {
            document.getElementById("password-modal").style.display = "flex";
            document.getElementById("senha-desbloqueio-input").value = "";
            document.getElementById("senha-desbloqueio-input").focus();
            if (element) {
                document.getElementById("password-modal").dataset.elementId = element.id;
            } else {
                delete document.getElementById("password-modal").dataset.elementId;
            }
        }
        document.getElementById("confirmar-desbloquear-ficha-btn").onclick = () => { // Bind to new button ID
            const senhaInput = document.getElementById("senha-desbloqueio-input").value;
            const modal = document.getElementById("password-modal");
            const elementId = modal.dataset.elementId;
            const originalButton = elementId ? document.getElementById(elementId) : null;

            const isMatriz = currentFichaId === FICHA_MATRIZ_ID;
            const correctPassword = isMatriz ? senhaMatriz : fichaPassword;

            if (senhaInput !== correctPassword) {
                alert("Senha incorreta!");
                return;
            }

            isFichaUnlocked = true; // Temporarily unlock for this session
            showNotification("Ficha desbloqueada temporariamente!", "normal-result");

            if (!isMatriz) { // For non-Matriz fichas, ask if permanent unlock
                if (confirm("Senha correta! Deseja desbloquear a ficha permanentemente? (Cancelar para desbloqueio temporário)")) {
                    isFichaLocked = false;
                    fichaPassword = null;
                    salvarDados(); // Save permanent unlock state
                    alert("Ficha desbloqueada permanentemente!");
                    atualizarBotaoBloquear();
                }
            }
            
            fecharModal("password-modal");
            if (originalButton && typeof originalButton.onclick === 'function' && !originalButton.id.startsWith('btn-')) {
                originalButton.click(); // Trigger original action if one was pending
            }
             // Allow editing inputs that were blocked
            document.querySelectorAll('input, textarea, select').forEach(el => {
                if (previousValues.has(el) && el.value !== previousValues.get(el)) {
                    // If the value was changed while locked, it might have been reverted.
                    // Now that it's unlocked, the user can freely edit.
                    // No specific action needed here other than allowing edits.
                }
            });
        };


        function cancelarDesbloqueio() {
            const modal = document.getElementById("password-modal");
            const elementId = modal.dataset.elementId;
            const targetElement = elementId ? document.getElementById(elementId) : null;

            // Revert the input value if an input field triggered the password modal
            if (targetElement && (targetElement.tagName === 'INPUT' || targetElement.tagName === 'TEXTAREA')) {
                if (previousValues.has(targetElement)) {
                    targetElement.value = previousValues.get(targetElement);
                }
            }
            fecharModal("password-modal");
        }


        // --- Input Handling & Locking ---
        document.querySelectorAll('input[type="text"],input[type="number"]:not(#experiencia),textarea,select').forEach(input => {
            input.addEventListener("focus", (event) => {
                // Store the value on focus, only if not already locked and trying to edit
                if (!(isFichaLocked && !isFichaUnlocked && currentFichaId !== FICHA_MATRIZ_ID)) {
                     previousValues.set(event.target, event.target.value);
                }
            });
            input.addEventListener("input", (event) => {
                const inputTarget = event.target;
                if (isFichaLocked && !isFichaUnlocked && currentFichaId !== FICHA_MATRIZ_ID) {
                    // Revert to stored previous value
                    if(previousValues.has(inputTarget)) inputTarget.value = previousValues.get(inputTarget);
                    else inputTarget.value = ""; // Fallback if no previous value (should not happen often)
                    
                    abrirModalSenha(inputTarget); // Pass the input element itself
                    return;
                }

                // If unlocked or not locked, proceed with calculations and save
                if (atributosInputs.includes(inputTarget)) {
                    calcularAtributos();
                } else if (inputTarget.id.includes("arma")) {
                    calcularAtributos();
                } else if (inputTarget.classList.contains('inventory-weight')) {
                    calcularPesoTotal(); // This will call calcularAtributos
                }
                // For other inputs, previousValues will be updated by the focus listener before this input event
                // or if they change it now, it's fine.
                salvarDados();
            });
        });
        if (fontSelector) { // Special handling for select if needed
            fontSelector.addEventListener("change", (event) => {
                 if (isFichaLocked && !isFichaUnlocked && currentFichaId !== FICHA_MATRIZ_ID) {
                    if(previousValues.has(event.target)) event.target.value = previousValues.get(event.target);
                    abrirModalSenha(event.target);
                    return;
                }
                document.body.style.fontFamily = event.target.value;
                if (fichaContainer) fichaContainer.style.fontFamily = event.target.value;
                salvarDados();
            });
        }


        experienciaInput.addEventListener('focus', (event) => {
            previousValues.set(event.target, event.target.value);
            if (experienciaInput.readOnly && !isXpUnlocked) {
                event.preventDefault();
                senhaGmTitulo.textContent = "Desbloquear Campo de Experiência";
                document.getElementById("senha-gm-modal").style.display = "flex";
                document.getElementById("senha-gm-input").value = "";
                document.getElementById("senha-gm-input").focus();
                document.getElementById("confirmar-senha-gm-btn").onclick = () => confirmarDesbloqueioExperiencia();
            }
        });

        experienciaInput.addEventListener('input', (event) => {
            if (!experienciaInput.readOnly) {
                experiencia = parseInt(event.target.value) || 0;
                atualizarNivel();
                salvarDados();
            } else {
                event.target.value = previousValues.get(event.target) || "0";
            }
        });

        function confirmarDesbloqueioExperiencia() {
            if (document.getElementById("senha-gm-input").value === senhaMatriz) {
                experienciaInput.readOnly = false;
                isXpUnlocked = true;
                experienciaInput.focus();
                showNotification("Campo de experiência desbloqueado por 20 segundos.", "normal-result");

                if (xpUnlockTimerId) clearTimeout(xpUnlockTimerId);
                xpUnlockTimerId = setTimeout(() => {
                    experienciaInput.readOnly = true;
                    isXpUnlocked = false;
                    alert("Tempo para editar experiência expirou. Insira a senha novamente se precisar.");
                    // Data is saved on input, so no explicit save here unless value changed after timeout
                }, XP_UNLOCK_DURATION_MS);
                fecharModal("senha-gm-modal");
            } else {
                alert("Senha do GM incorreta!");
                fecharModal("senha-gm-modal");
            }
        }

        // --- Image Handling ---
        characterImageInput.onchange = e => {
            if (isFichaLocked && !isFichaUnlocked && currentFichaId !== FICHA_MATRIZ_ID) {
                abrirModalSenha(characterImageInput); // Or characterImageContainer
                e.target.value = ""; // Clear the file input
                return;
            }
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = e => {
                    characterImage.src = e.target.result;
                    characterImage.style.display = "block";
                    salvarDados();
                };
                reader.readAsDataURL(file);
            }
        };

        // --- Dice Roller ---
        let isDragging = false, currentX = 0, currentY = 0, initialX, initialY;
        if (diceContainer) {
            diceContainer.onmousedown = e => { isDragging = true; initialX = e.clientX - currentX; initialY = e.clientY - currentY; diceContainer.style.cursor = "grabbing"; };
            document.onmousemove = e => { if (isDragging) { e.preventDefault(); currentX = e.clientX - initialX; currentY = e.clientY - initialY; diceContainer.style.left = `${currentX}px`; diceContainer.style.top = `${currentY}px`; diceContainer.style.right = "auto"; } };
            document.onmouseup = () => { if(isDragging) {isDragging = false; diceContainer.style.cursor = "move";} };
        }

        diceRoll.onclick = () => {
            if (isFichaLocked && !isFichaUnlocked && currentFichaId !== FICHA_MATRIZ_ID) return abrirModalSenha(diceRoll);
            diceRoll.textContent = "Rolling...";
            diceResult.style.display = "none";
            diceRoll.classList.remove("critical-failure", "critical-success");
            setTimeout(() => {
                const roll = Math.floor(Math.random() * 20) + 1;
                const fichaNome = (localFichasCache[currentFichaId] ? localFichasCache[currentFichaId].nomeFicha : "Ficha") || "Ficha";
                diceRoll.textContent = roll;
                let notificationClass = "normal-result";
                let notificationMsg = `${fichaNome} rolou: ${roll}`;
                if (roll === 1) { diceRoll.classList.add("critical-failure"); notificationClass = "critical-failure"; notificationMsg = `${fichaNome} - FALHA CRÍTICA!`; }
                else if (roll === 20) { diceRoll.classList.add("critical-success"); notificationClass = "critical-success"; notificationMsg = `${fichaNome} - SUCESSO CRÍTICO!`; }
                else { diceResult.textContent = `Resultado: ${roll}`; diceResult.style.display = "block"; }
                showNotification(notificationMsg, notificationClass);
            }, 1000);
        };


        // --- Vantagens/Desvantagens Panel Logic ---
        vantagensDesvantagensBtn.onclick = () => {
            if (isFichaLocked && !isFichaUnlocked && currentFichaId !== FICHA_MATRIZ_ID) return abrirModalSenha(vantagensDesvantagensBtn);
            tempVantagensSelecionadas = [...vantagensSelecionadas]; // Copy current selections to temp
            tempDesvantagensSelecionadas = [...desvantagensSelecionadas];
            vantagensDesvantagensPanel.style.display = "block";
            document.getElementById("salvar-vantagens-btn").style.display = "none"; // Hide save initially
            atualizarVantagensDesvantagensPanel();
        };
        fecharPaginaBtn.onclick = () => { vantagensDesvantagensPanel.style.display = "none"; };

        salvarVantagensBtn.onclick = () => {
             document.getElementById("salvar-modal-texto").textContent = "Se salvar, as alterações de Vantagens/Desvantagens não poderão ser desfeitas.";
             document.getElementById("salvar-vantagens-modal").style.display = "flex";
             // The actual save logic is now in confirmarSalvarVantagensRacasBtn's click handler
        };
        
        confirmarSalvarVantagensRacasBtn.onclick = () => { // Consolidated save button
            if (vantagensDesvantagensPanel.style.display === "block") { // Saving Vantagens/Desvantagens
                if (tempDesvantagensSelecionadas.length > 3) {
                     alert("Você pode ter no máximo 3 desvantagens!");
                     fecharModal("salvar-vantagens-modal");
                     return;
                }
                if (calcularPontosVantagemTemp() < 0) { // Uses temp selections
                     alert("Pontos de Vantagem insuficientes com as vantagens/desvantagens selecionadas!");
                     fecharModal("salvar-vantagens-modal");
                     return;
                }

                vantagensSelecionadas = [...tempVantagensSelecionadas];
                desvantagensSelecionadas = [...tempDesvantagensSelecionadas];
                
                vantagensListDisplay.innerHTML = ""; desvantagensListDisplay.innerHTML = "";
                vantagensSelecionadas.forEach(v => { const div = document.createElement("div"); div.textContent = v; div.className = "list-item"; div.onclick = () => removerVantagem(v); vantagensListDisplay.appendChild(div); });
                desvantagensSelecionadas.forEach(d => { const div = document.createElement("div"); div.textContent = d; div.className = "list-item"; div.onclick = () => removerDesvantagem(d); desvantagensListDisplay.appendChild(div); });
                
                pontosVantagemSpan.textContent = getPontosVantagem(); // Update main display
                vantagensDesvantagensPanel.style.display = "none";
                calcularAtributos(); // Recalculate if PH changes affect anything (indirectly)
                salvarDados(); // Save changes to Firestore
            } else if (racasPanel.style.display === "block") { // Saving Raça
                if (tempRacaSelecionada && tempRacaSelecionada !== racaSelecionada) {
                    const raca = racasData.find(r => r.nome === tempRacaSelecionada);
                    if (raca && calcularPontosVantagemTemp() >= 0) { // Uses temp selections including tempRaca
                        racaSelecionada = tempRacaSelecionada;
                        racaNomeSpan.textContent = racaSelecionada.split(" (")[0];
                        racaDescricaoInput.value = raca.vantagens.join("\n\n");
                        pontosVantagemSpan.textContent = getPontosVantagem();
                        racasPanel.style.display = "none";
                        calcularAtributos();
                        salvarDados();
                    } else if (raca){
                        alert("Pontos de Vantagem insuficientes para confirmar esta raça!");
                    } else {
                         racasPanel.style.display = "none"; // No change or invalid selection
                    }
                } else {
                    racasPanel.style.display = "none"; // No change made
                }
            }
            fecharModal("salvar-vantagens-modal");
        };


        function atualizarVantagensDesvantagensPanel() {
            vantagensList.innerHTML = "<h3>Vantagens</h3>";
            desvantagensList.innerHTML = "<h3>Desvantagens</h3>";

            vantagensData.forEach(v => {
                const div = document.createElement("div");
                div.className = "vantagem-item";
                div.textContent = `${v.nome} - Custo: ${v.custo} PH - ${v.descricao}`;
                if (tempVantagensSelecionadas.includes(v.nome)) div.classList.add("comprada");

                div.onclick = () => {
                    if (vantagensSelecionadas.includes(v.nome)) { // Already saved
                        alert("Vantagem salva só pode ser removida com permissão do GM.");
                    } else if (tempVantagensSelecionadas.includes(v.nome)) { // Temporarily selected, de-select
                        tempVantagensSelecionadas = tempVantagensSelecionadas.filter(t => t !== v.nome);
                    } else { // Not selected, try to select
                        if (v.restricao === "inicio" && nivel > 0) {
                            alert("Compra dessa vantagem é somente no nível 0.");
                            return;
                        }
                        // Check PH with this new advantage added temporarily
                        const phAfterAdding = calcularPontosVantagemTemp() - v.custo + (tempVantagensSelecionadas.includes(v.nome) ? v.custo : 0) ;
                        if (phAfterAdding >= 0) { // Check if PH would be sufficient
                             tempVantagensSelecionadas.push(v.nome);
                        } else {
                             alert("PH insuficientes!");
                        }
                    }
                    atualizarVantagensDesvantagensPanel(); // Re-render panel
                    document.getElementById("salvar-vantagens-btn").style.display = "block"; // Show save button
                };
                vantagensList.appendChild(div);
            });

            desvantagensData.forEach(d => {
                const div = document.createElement("div");
                div.className = "desvantagem-item";
                div.textContent = `${d.nome} - Ganho: ${d.ganho} PH - ${d.descricao}`;
                if (tempDesvantagensSelecionadas.includes(d.nome)) div.classList.add("comprada");

                div.onclick = () => {
                    if (desvantagensSelecionadas.includes(d.nome)) { // Already saved
                        alert("Desvantagem salva só pode ser removida com permissão do GM.");
                    } else if (tempDesvantagensSelecionadas.includes(d.nome)) { // Temporarily selected, de-select
                        tempDesvantagensSelecionadas = tempDesvantagensSelecionadas.filter(t => t !== d.nome);
                    } else { // Not selected, try to select
                        if (tempDesvantagensSelecionadas.length < 3) {
                            tempDesvantagensSelecionadas.push(d.nome);
                        } else {
                            alert("Limite de 3 desvantagens!");
                        }
                    }
                    atualizarVantagensDesvantagensPanel(); // Re-render panel
                    document.getElementById("salvar-vantagens-btn").style.display = "block"; // Show save button
                };
                desvantagensList.appendChild(div);
            });
            document.getElementById("ph-temp").textContent = calcularPontosVantagemTemp();
        }

        function removerVantagem(v) { // From main display
            if (isFichaLocked && !isFichaUnlocked && currentFichaId !== FICHA_MATRIZ_ID) return abrirModalSenha();
            senhaGmTitulo.textContent = "Peça permissão ao GM para Remover Vantagem";
            if (confirm(`Deseja remover a vantagem "${v}"?`)) {
                document.getElementById("senha-gm-modal").style.display = "flex";
                document.getElementById("senha-gm-input").value = "";
                document.getElementById("confirmar-senha-gm-btn").onclick = () => {
                    if (document.getElementById("senha-gm-input").value === senhaMatriz) {
                        vantagensSelecionadas = vantagensSelecionadas.filter(t => t !== v);
                        // Update display
                        vantagensListDisplay.innerHTML = "";
                        vantagensSelecionadas.forEach(val => { const div = document.createElement("div"); div.textContent = val; div.className = "list-item"; div.onclick = () => removerVantagem(val); vantagensListDisplay.appendChild(div); });
                        pontosVantagemSpan.textContent = getPontosVantagem();
                        fecharModal("senha-gm-modal");
                        calcularAtributos();
                        salvarDados();
                    } else {
                        alert("Senha do GM incorreta!");
                        fecharModal("senha-gm-modal");
                    }
                };
            }
        }
        function removerDesvantagem(d) { // From main display
            if (isFichaLocked && !isFichaUnlocked && currentFichaId !== FICHA_MATRIZ_ID) return abrirModalSenha();
            senhaGmTitulo.textContent = "Peça permissão ao GM para Remover Desvantagem";
            if (confirm(`Deseja remover a desvantagem "${d}"?`)) {
                document.getElementById("senha-gm-modal").style.display = "flex";
                document.getElementById("senha-gm-input").value = "";
                document.getElementById("confirmar-senha-gm-btn").onclick = () => {
                    if (document.getElementById("senha-gm-input").value === senhaMatriz) {
                        desvantagensSelecionadas = desvantagensSelecionadas.filter(t => t !== d);
                        // Update display
                        desvantagensListDisplay.innerHTML = "";
                        desvantagensSelecionadas.forEach(val => { const div = document.createElement("div"); div.textContent = val; div.className = "list-item"; div.onclick = () => removerDesvantagem(val); desvantagensListDisplay.appendChild(div); });
                        pontosVantagemSpan.textContent = getPontosVantagem();
                        fecharModal("senha-gm-modal");
                        calcularAtributos();
                        salvarDados();
                    } else {
                        alert("Senha do GM incorreta!");
                        fecharModal("senha-gm-modal");
                    }
                };
            }
        }

        // --- Inventory Weight ---
        function calcularPesoTotal() {
            pesoTotalSpan.textContent = Array.from(inventarioSlots.querySelectorAll(".inventory-weight"))
                .reduce((total, weight) => total + (parseFloat(weight.value) || 0), 0).toFixed(1);
            calcularAtributos(); // Update encumbrance penalties
        }
        inventarioSlots.addEventListener("input", (event) => {
            if (isFichaLocked && !isFichaUnlocked && currentFichaId !== FICHA_MATRIZ_ID) {
                 if(previousValues.has(event.target)) event.target.value = previousValues.get(event.target);
                 abrirModalSenha(event.target);
                 return;
            }
            if (event.target.classList.contains('inventory-weight')) {
                calcularPesoTotal();
            }
            salvarDados(); // Save on any inventory change
        });

        // --- Anotações ---
        anotacoesBtn.onclick = () => { anotacoesTextarea.style.display = anotacoesTextarea.style.display === "block" ? "none" : "block"; };
        document.addEventListener('click', (event) => {
            if (anotacoesTextarea.style.display === "block" && !anotacoesTextarea.contains(event.target) && !anotacoesBtn.contains(event.target)) {
                anotacoesTextarea.style.display = 'none';
            }
        });
        anotacoesTextarea.oninput = salvarDados; // Already handled by general input listener

        // --- Magias ---
        adicionarMagiaBtn.onclick = () => {
            if (isFichaLocked && !isFichaUnlocked && currentFichaId !== FICHA_MATRIZ_ID) return abrirModalSenha(adicionarMagiaBtn);
            if (magiasList.children.length < 20) {
                const input = document.createElement("input");
                input.type = "text";
                input.className = "magia-nome";
                input.placeholder = `Magia/Habilidade ${magiasList.children.length + 1}`;
                input.addEventListener('input', salvarDados); // Ensure new inputs also save
                magiasList.appendChild(input);
                salvarDados(); // Save the fact that a new slot (even if empty) is added
            } else {
                alert("Limite de 20 magias/habilidades!");
            }
        };
        // Event listeners for existing magia inputs are added during populateUIWithFichaData


        // --- Raças Panel Logic ---
        racasBtn.onclick = () => {
            if (isFichaLocked && !isFichaUnlocked && currentFichaId !== FICHA_MATRIZ_ID) return abrirModalSenha(racasBtn);
            tempRacaSelecionada = racaSelecionada; // Store current selection in temp
            atualizarRacasPanel();
            racasPanel.style.display = "block";
            document.getElementById("salvar-racas-btn").style.display = "none"; // Hide save initially
        };
        fecharRacasBtn.onclick = () => { racasPanel.style.display = "none"; };
        salvarRacasBtn.onclick = () => { // This button is for the Raças panel
            document.getElementById("salvar-modal-texto").textContent = "Se salvar, a alteração de Raça não poderá ser desfeita.";
            document.getElementById("salvar-vantagens-modal").style.display = "flex";
            // Actual save logic is in confirmarSalvarVantagensRacasBtn
        };

        function atualizarRacasPanel() {
            racasList.innerHTML = ""; // Clear previous items
            racasData.forEach(r => {
                const div = document.createElement("div");
                div.className = "raca-item-selector"; // Use distinct class for selector items
                div.innerHTML = `<h3>${r.nome}</h3><p>${r.descricao}</p><p><strong>Vantagens:</strong></p><ul>${r.vantagens.map(v => `<li>${v}</li>`).join("")}</ul>`;
                if (tempRacaSelecionada === r.nome) div.classList.add("comprada");

                div.onclick = () => {
                    if (racaSelecionada && racaSelecionada !== r.nome && racaSelecionada !== tempRacaSelecionada) { // If a race is already saved and it's different from the one clicked
                        alert("Raça salva só pode ser alterada com permissão do GM.");
                        return;
                    }
                    
                    if (tempRacaSelecionada === r.nome) { // Clicked on already temp selected race (deselect)
                        tempRacaSelecionada = null;
                    } else { // Try to select a new race
                        // Calculate PH if this race is chosen, reverting current tempRaca if any
                        let phIfThisRaca = (nivelData.find(data => data.nivel === nivel) || nivelData[0]).ph;
                        // Subtract cost of *other* advantages/disadvantages currently in temp
                        tempVantagensSelecionadas.forEach(vNome => { phIfThisRaca -= (vantagensData.find(vd => vd.nome === vNome)?.custo || 0); });
                        tempDesvantagensSelecionadas.forEach(dNome => { phIfThisRaca += (desvantagensData.find(dd => dd.nome === dNome)?.ganho || 0); });
                        // Now subtract cost of *this* new race
                        phIfThisRaca -= r.custo;

                        if (phIfThisRaca >= 0) {
                            tempRacaSelecionada = r.nome;
                            document.getElementById("confirmar-compra-modal").style.display = "flex";
                            document.getElementById("confirmar-compra-btn").onclick = () => {
                                atualizarRacasPanel(); // Re-render to show selection
                                document.getElementById("salvar-racas-btn").style.display = "block";
                                fecharModal("confirmar-compra-modal");
                            };
                        } else {
                            alert("PH insuficientes para selecionar esta raça com as vantagens/desvantagens atuais!");
                            tempRacaSelecionada = racaSelecionada; // Revert temp to original saved one
                        }
                    }
                    atualizarRacasPanel(); // Re-render to reflect selection change
                    // Show save button only if a change is made from the original saved race
                    document.getElementById("salvar-racas-btn").style.display = (tempRacaSelecionada && tempRacaSelecionada !== racaSelecionada) ? "block" : "none";
                };
                racasList.appendChild(div);
            });
            phTempRacaSpan.textContent = calcularPontosVantagemTemp(); // Uses tempRacaSelecionada
        }


        // --- Raça Editing/Deleting from Main Sheet ---
        function abrirModalRaca() { // When clicking on racaNomeSpan in main sheet
            if (!racaSelecionada) { // No race selected, open race panel to choose
                racasBtn.click();
                return;
            }
            document.getElementById("raca-opcoes-modal").style.display = "flex";
        }
        document.getElementById("excluir-raca-modal-btn").onclick = () => {
            fecharModal('raca-opcoes-modal');
            if (isFichaLocked && !isFichaUnlocked && currentFichaId !== FICHA_MATRIZ_ID) return abrirModalSenha();
            senhaGmTitulo.textContent = "Peça permissão ao GM para Excluir Raça";
            if (confirm("Tem certeza que deseja excluir a raça selecionada?")) {
                document.getElementById("senha-gm-modal").style.display = "flex";
                document.getElementById("senha-gm-input").value = "";
                document.getElementById("confirmar-senha-gm-btn").onclick = () => {
                    if (document.getElementById("senha-gm-input").value === senhaMatriz) {
                        racaSelecionada = null;
                        tempRacaSelecionada = null; // Clear temp as well
                        racaNomeSpan.textContent = "Clique para selecionar/editar";
                        racaDescricaoInput.value = "";
                        pontosVantagemSpan.textContent = getPontosVantagem();
                        fecharModal("senha-gm-modal");
                        calcularAtributos();
                        salvarDados();
                    } else {
                        alert("Senha do GM incorreta!");
                        fecharModal("senha-gm-modal");
                    }
                };
            }
        };
        document.getElementById("editar-raca-modal-btn").onclick = () => {
            if (isFichaLocked && !isFichaUnlocked && currentFichaId !== FICHA_MATRIZ_ID) return abrirModalSenha();
            fecharModal('raca-opcoes-modal');
            document.getElementById("editar-raca-modal").style.display = "flex";
            document.getElementById("editar-raca-nome").value = racaNomeSpan.textContent; // Current display name
            document.getElementById("editar-raca-descricao").value = racaDescricaoInput.value; // Current display description
        };
        document.getElementById("salvar-edicao-raca-btn").onclick = () => {
            if (isFichaLocked && !isFichaUnlocked && currentFichaId !== FICHA_MATRIZ_ID) return abrirModalSenha();
            senhaGmTitulo.textContent = "Peça permissão ao GM para Editar Raça";
             // Note: Editing name/desc here doesn't change PH cost or core race advantages from data.
             // This is more like a custom override of display text.
            if (confirm("Tem certeza que deseja editar a descrição da raça selecionada? (Não altera custos ou vantagens base)")) {
                document.getElementById("senha-gm-modal").style.display = "flex";
                document.getElementById("senha-gm-input").value = "";
                document.getElementById("confirmar-senha-gm-btn").onclick = () => {
                    if (document.getElementById("senha-gm-input").value === senhaMatriz) {
                        // racaNomeSpan.textContent = document.getElementById("editar-raca-nome").value; // Avoid changing the core name linked to data
                        racaDescricaoInput.value = document.getElementById("editar-raca-descricao").value;
                        fecharModal('editar-raca-modal');
                        salvarDados(); // Save the new description
                        fecharModal("senha-gm-modal");
                    } else {
                        alert("Senha do GM incorreta!");
                        fecharModal("senha-gm-modal");
                    }
                };
            }
        };

        // --- Classes Panel ---
        classesBtn.onclick = () => { classesPanel.style.display = "block"; /* TODO: Implement classes content */ };
        fecharClassesBtn.onclick = () => { classesPanel.style.display = "none"; };

        // --- Theme and Appearance ---
        luaBtn.onclick = () => { document.body.classList.add("dark-mode"); aplicarCorDeFundoInicial(localFichasCache[currentFichaId]); salvarDados(); };
        solBtn.onclick = () => { document.body.classList.remove("dark-mode"); aplicarCorDeFundoInicial(localFichasCache[currentFichaId]); salvarDados(); };

        planoFundoBtn.onclick = () => { backgroundModal.style.display = "flex"; };
        document.getElementById("aplicar-plano-fundo-btn").onclick = () => {
            if (isFichaLocked && !isFichaUnlocked && currentFichaId !== FICHA_MATRIZ_ID) return abrirModalSenha();
            const file = backgroundImageInput.files[0];
            const selectedSize = document.querySelector('input[name="background-size"]:checked').value;
            if (file) {
                const reader = new FileReader();
                reader.onload = e => {
                    const imageUrl = e.target.result;
                    document.body.style.backgroundImage = `url('${imageUrl}')`;
                    document.body.style.backgroundSize = selectedSize;
                    salvarDados(); // Save background image URL and size
                    fecharModal('background-modal');
                };
                reader.readAsDataURL(file);
            } else if (document.body.style.backgroundImage && document.body.style.backgroundImage !== 'none') {
                // Only update size if an image is already set
                document.body.style.backgroundSize = selectedSize;
                salvarDados();
                fecharModal('background-modal');
            } else {
                alert("Nenhuma imagem selecionada e nenhuma imagem de fundo existente para aplicar novo tamanho.");
            }
        };
        document.getElementById("excluir-plano-fundo-btn").onclick = () => {
            if (isFichaLocked && !isFichaUnlocked && currentFichaId !== FICHA_MATRIZ_ID) return abrirModalSenha();
            if (confirm("Remover imagem de fundo?")) {
                document.body.style.backgroundImage = 'none';
                salvarDados(); // Save that background image is null
                fecharModal('background-modal');
            }
        };

        function aplicarPlanoDeFundoInicial(ficha) {
            const bgImage = ficha?.backgroundImage;
            const bgSize = ficha?.backgroundSize || 'cover';
            if (bgImage) {
                document.body.style.backgroundImage = `url('${bgImage}')`;
                document.body.style.backgroundSize = bgSize;
            } else {
                document.body.style.backgroundImage = 'none';
            }
        }

        if (backgroundColorButtonVisual && backgroundColorInput) {
            backgroundColorButtonVisual.addEventListener('click', () => {
                if (isFichaLocked && !isFichaUnlocked && currentFichaId !== FICHA_MATRIZ_ID) {
                    abrirModalSenha(backgroundColorButtonVisual); return;
                }
                backgroundColorInput.click()
            });
            backgroundColorInput.addEventListener('input', (event) => {
                // Lock check already handled by the button click
                document.body.style.backgroundColor = event.target.value;
                backgroundColorButtonVisual.style.backgroundColor = event.target.value;
                salvarDados();
            });
        }

        function aplicarCorDeFundoInicial(ficha) {
            const isDark = ficha?.darkMode === true || document.body.classList.contains("dark-mode");
            const defaultColorLight = '#f0e6d2';
            const defaultColorDark = '#121212';
            let bgColorToApply = isDark ? defaultColorDark : defaultColorLight;

            if (ficha?.backgroundColor) {
                bgColorToApply = ficha.backgroundColor;
            }
            document.body.style.backgroundColor = bgColorToApply;
            if (backgroundColorInput) backgroundColorInput.value = bgColorToApply;
            if (backgroundColorButtonVisual) backgroundColorButtonVisual.style.backgroundColor = bgColorToApply;
        }
        
        function aplicarFonteInicial(ficha) {
            const defaultFont = "'Inter', sans-serif";
            const bodyFont = ficha?.fontFamily || defaultFont;
            document.body.style.fontFamily = bodyFont;
            if (fichaContainer) fichaContainer.style.fontFamily = bodyFont;
            if (fontSelector) fontSelector.value = bodyFont;
        }


        // --- Hold Button Functionality (for Vida/Magia/Vigor) ---
        function setupHoldButtonEvents(buttonElement, actionFunction) {
            if (!buttonElement) return;
            let intervalId = null;
            const startAction = (event) => {
                event.preventDefault();
                if (isFichaLocked && !isFichaUnlocked && currentFichaId !== FICHA_MATRIZ_ID) {
                    abrirModalSenha(buttonElement);
                    return;
                }
                actionFunction(); // Call once immediately
                if (intervalId) clearInterval(intervalId); // Clear any existing interval
                intervalId = setInterval(actionFunction, REPEAT_DELAY_MS);
            };
            const stopAction = () => {
                clearInterval(intervalId);
                intervalId = null;
            };
            buttonElement.addEventListener('mousedown', startAction);
            buttonElement.addEventListener('mouseup', stopAction);
            buttonElement.addEventListener('mouseleave', stopAction); // Stop if mouse leaves button while pressed
            buttonElement.addEventListener('touchstart', startAction, { passive: false }); // passive:false to allow preventDefault
            buttonElement.addEventListener('touchend', stopAction);
            buttonElement.addEventListener('touchcancel', stopAction);
        }
        
        // --- DOMContentLoaded ---
        document.addEventListener('DOMContentLoaded', async () => {
            if (diceContainer) {
                currentX = diceContainer.offsetLeft;
                currentY = diceContainer.offsetTop;
            }
            
            await initializeAndAuthenticate(); // This will handle auth and then load fichas.

            // Setup hold buttons after DOM is ready
            const btnDiminuirVida = document.getElementById('btn-diminuir-vida');
            const btnAumentarVida = document.getElementById('btn-aumentar-vida');
            const btnDiminuirMagia = document.getElementById('btn-diminuir-magia');
            const btnAumentarMagia = document.getElementById('btn-aumentar-magia');
            const btnDiminuirVigor = document.getElementById('btn-diminuir-vigor');
            const btnAumentarVigor = document.getElementById('btn-aumentar-vigor');

            // Remove any pre-existing simple click listeners if they were there
            if(btnDiminuirVida) btnDiminuirVida.onclick = null;
            if(btnAumentarVida) btnAumentarVida.onclick = null;
            if(btnDiminuirMagia) btnDiminuirMagia.onclick = null;
            if(btnAumentarMagia) btnAumentarMagia.onclick = null;
            if(btnDiminuirVigor) btnDiminuirVigor.onclick = null;
            if(btnAumentarVigor) btnAumentarVigor.onclick = null;

            setupHoldButtonEvents(btnDiminuirVida, diminuirVida);
            setupHoldButtonEvents(btnAumentarVida, aumentarVida);
            setupHoldButtonEvents(btnDiminuirMagia, diminuirMagia);
            setupHoldButtonEvents(btnAumentarMagia, aumentarMagia);
            setupHoldButtonEvents(btnDiminuirVigor, diminuirVigor);
            setupHoldButtonEvents(btnAumentarVigor, aumentarVigor);

            // Bind other buttons that don't need complex setup here as they are already bound above
            resetPontosButton.onclick = resetarPontos;
            recomecarButton.onclick = recomecarFicha;
        });

    </script>
</body>
</html>
