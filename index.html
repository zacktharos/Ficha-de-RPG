html
<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ficha de Personagem RPG</title>
    <link href="https://fonts.googleapis.com/css2?family=MedievalSharp&family=Inter:wght@400;600&display=swap"
        rel="stylesheet">
    <script src="https://unpkg.com/@tailwindcss/browser@4"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <style>
        /* Estilos gerais e modo escuro (mantidos) */
        body {
            font-family: 'Inter', sans-serif;
            background: var(--external-bg, #f5f5f5 url('medieval_background.jpg') center/cover);
            color: var(--text-color, #000);
            display: flex;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            transition: background 0.3s, color 0.3s;
            --external-bg: #f5f5f5 url('medieval_background.jpg') center/cover; /* Vari√°vel CSS para fundo externo */
            --internal-bg: rgba(240, 230, 210, 0.95); /* Vari√°vel CSS para fundo interno */
            --text-color: #000;
            --border-color: #b8860b;
            --section-bg: #f0e6d2;
            --input-bg: #fff;
            --input-border: #b8860b;
            --input-text: #000;
            --readonly-bg: #e8e8e8;
            --readonly-border: #ccc;
            --button-bg: #b8860b;
            --button-hover-bg: #a0522d;
            --modal-bg: #f0e6d2;
            --modal-border: #b8860b;
            --modal-text: #000;
            --list-item-border: #ccc;
            --list-item-hover-bg: #e0e0e0;
        }

        body.dark-mode {
            --external-bg: #121212;
            --internal-bg: rgba(30, 30, 30, 0.95);
            --text-color: #e0e0e0;
            --border-color: #444;
            --section-bg: #1e1e1e;
            --input-bg: #333;
            --input-border: #555;
            --input-text: #e0e0e0;
            --readonly-bg: #444;
            --readonly-border: #666;
            --button-bg: #555;
            --button-hover-bg: #777;
            --modal-bg: #1e1e1e;
            --modal-border: #444;
            --modal-text: #e0e0e0;
            --list-item-border: #555;
            --list-item-hover-bg: #444;
        }

        /* Restante dos estilos gerais mantidos... */
        #chat-btn-container {
            position: fixed;
            left: 10px;
            top: calc(50% - 120px); /* Ajuste para mover o bot√£o para cima com mais espa√ßo */
            z-index: 1000;
        }

        #chat-btn {
            padding: 15px;
            background: var(--section-bg);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-family: 'MedievalSharp', serif;
            font-size: 1.2rem;
            color: var(--text-color);
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 3px 3px 7px rgba(0, 0, 0, 0.3);
            position: relative; /* Para posicionar o contador */
        }

        #chat-btn:hover {
            background: var(--button-hover-bg);
            transform: translateY(-3px);
        }

        #chat-btn::after {
            content: attr(data-unread);
            position: absolute;
            top: -10px;
            right: -10px;
            background-color: red;
            color: white;
            border-radius: 50%;
            padding: 3px 6px;
            font-size: 0.8rem;
            min-width: 20px;
            text-align: center;
            display: none; /* Come√ßa escondido */
            line-height: 1;
            font-family: 'Inter', sans-serif; /* Fonte normal para o n√∫mero */
        }

        #chat-btn[data-unread]:not([data-unread="0"]):after {
            display: block; /* Mostra apenas se data-unread for diferente de 0 */
        }

        #fichas-sidebar {
            width: 100%;
            height: 60px;
            padding: 0;
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: flex-start;
            position: fixed;
            top: 0;
            left: 0;
            z-index: 1000;
            overflow-x: auto;
            background: transparent
        }

        .ficha-tab {
            visibility: visible;
            width: 100px;
            height: 50px;
            background: var(--section-bg);
            border: 2px solid var(--border-color);
            border-radius: 10px 10px 0 0;
            margin-right: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.2);
            flex-shrink: 0; /* Evita que as abas encolham */
        }

        .ficha-tab:hover {
            background: var(--button-hover-bg);
            transform: translateY(-5px)
        }

        .ficha-tab.active {
            background: var(--button-hover-bg);
            transform: translateY(-5px);
            border-bottom-color: var(--button-hover-bg); /* Cor da borda inferior quando ativo */
        }

        .ficha-tab span {
            font-family: 'MedievalSharp', serif;
            color: var(--text-color);
            font-size: 0.9rem;
            text-align: center;
            max-width: 90px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap
        }

        #add-ficha-btn {
            width: 100px;
            height: 50px;
            background: var(--section-bg);
            border: 2px solid var(--border-color);
            border-radius: 10px 10px 0 0;
            margin-right: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: transform 0.2s ease;
            box-shadow: 0 0 10px #ffd700, 0 0 20px #ffd700;
            z-index: 1001;
            flex-shrink: 0; /* Evita que o bot√£o encolha */
        }

        #add-ficha-btn span {
            font-family: 'MedievalSharp', serif;
            color: var(--text-color);
            font-size: 0.9rem
        }

        #add-ficha-btn:hover {
            background: var(--button-hover-bg);
            transform: translateY(-5px)
        }

        #ficha-container {
            background: var(--internal-bg);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
            width: 95%;
            max-width: 1200px;
            margin: 80px auto 20px;
            border: 2px solid var(--border-color);
            position: relative;
            color: var(--text-color); /* Garante a cor do texto dentro da ficha */
        }

        #ficha-container.aura-azul {
            box-shadow: 0 0 30px 15px #00BFFF;
            animation: pulsar-aura 2s infinite
        }

        @keyframes pulsar-aura {
            0% { box-shadow: 0 0 20px #00BFFF, 0 0 30px #00BFFF, 0 0 40px #00BFFF; }
            50% { box-shadow: 0 0 30px #00BFFF, 0 0 50px #00BFFF, 0 0 60px #00BFFF; }
            100% { box-shadow: 0 0 20px #00BFFF, 0 0 30px #00BFFF, 0 0 40px #00BFFF; }
        }

        h1#nome-personagem-titulo {
            font-family: 'MedievalSharp', serif;
            color: var(--text-color); /* Cor do t√≠tulo principal */
            font-size: 3rem;
            margin-bottom: 20px;
            text-align: center;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
            animation: raios 2s infinite linear
        }

        @keyframes raios {
            0% { text-shadow: 0 0 5px #FFD700, 0 0 10px #FFD700, 0 0 15px #FFD700, 0 0 20px #FF4500; }
            50% { text-shadow: 0 0 10px #FFD700, 0 0 15px #FFD700, 0 0 20px #FF4500, 0 0 25px #FF4500; }
            100% { text-shadow: 0 0 5px #FFD700, 0 0 10px #FFD700, 0 0 15px #FFD700, 0 0 20px #FF4500; }
        }

        #game-master-message {
            display: none;
            color: blue;
            font-size: 1.5rem;
            text-align: center;
            font-family: 'MedievalSharp', serif;
            margin-bottom: 10px
        }

        section {
            background: var(--section-bg);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            color: var(--text-color); /* Cor do texto dentro das se√ß√µes */
        }

        section h2 {
            text-align: center;
            color: var(--text-color); /* Cor dos t√≠tulos de se√ß√£o */
        }

        label {
            font-weight: 600;
            color: var(--text-color); /* Cor das labels */
            margin-bottom: 8px;
            display: block
        }

        input[type="text"],
        input[type="number"],
        textarea {
            padding: 10px;
            border: 2px solid var(--input-border);
            border-radius: 6px;
            width: calc(100% - 24px);
            margin-bottom: 15px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
            background: var(--input-bg);
            color: var(--input-text);
        }

        input[type="text"]:focus,
        input[type="number"]:focus,
        textarea:focus {
            border-color: var(--button-hover-bg); /* Usa a cor hover do bot√£o para foco */
            outline: none;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1)
        }

        input[readonly],
        span[readonly] {
            background: var(--readonly-bg);
            border: 1px solid var(--readonly-border);
            cursor: not-allowed;
            color: var(--text-color); /* Ajuste para cor do texto em readonly */
            opacity: 0.7;
        }

        textarea { resize: vertical; }

        .atributos-container {
            display: flex;
            justify-content: space-between;
            gap: 20px
        }

        .atributos-coluna,
        .atributos-coluna-destaque {
            width: 48%;
            display: flex;
            flex-direction: column;
            align-items: flex-start
        }

        .atributos-coluna-destaque {
            background: var(--input-bg); /* Fundo da coluna destaque */
            padding: 10px;
            border-radius: 6px;
            border: 1px solid var(--input-border);
        }

        .atributo-destaque {
            padding: 8px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
        }

        .atributo-destaque label {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--button-hover-bg); /* Cor de destaque */
        }

        .atributo-destaque span {
            font-size: 1.2rem;
            font-family: 'MedievalSharp', serif;
            color: var(--text-color);
        }

        .atributo-fogo { animation: fogo 1.5s infinite; }

        @keyframes fogo {
            0% { text-shadow: 0 0 5px #ff4500, 0 0 10px #ff4500; }
            50% { text-shadow: 0 0 10px #ff4500, 0 0 15px #ffd700; }
            100% { text-shadow: 0 0 5px #ff4500, 0 0 10px #ff4500; }
        }

        .vida-magia-vigor {
            display: flex;
            justify-content: space-around;
            gap: 15px;
            flex-wrap: wrap
        }

        .atributo-container {
            background: rgba(255, 255, 255, 0.8); /* Fundo semi-transparente */
            padding: 12px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            width: 30%;
            min-width: 200px;
            text-align: center;
            background-color: var(--section-bg); /* Usa o fundo da se√ß√£o */
        }

        .atributo-container::before {
            font-size: 1.5rem;
            margin-bottom: 5px;
            display: block
        }

        .atributo-container.vida::before { content: "‚ù§Ô∏è"; }
        .atributo-container.magia::before { content: "‚ú®"; }
        .atributo-container.vigor::before { content: "‚ö°"; }

        .medieval-box {
            background: var(--input-bg); /* Fundo das caixas internas */
            border: 2px solid var(--border-color);
            border-radius: 8px;
            padding: 10px;
            margin: 5px 0;
            text-align: center;
            color: var(--text-color); /* Cor do texto */
        }

        .regeneracao {
            font-size: 0.8rem;
            color: var(--text-color); /* Cor do texto de regenera√ß√£o */
            opacity: 0.8;
            margin-top: 5px
        }

        button {
            background: var(--button-bg);
            color: #fff; /* Cor do texto dos bot√µes geralmente √© branca */
            border: none;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 1.2rem;
            border-radius: 4px;
            margin: 0 5px;
            transition: background-color 0.3s ease
        }

        button:hover { background: var(--button-hover-bg); }

        .botoes-container {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap; /* Permite que os bot√µes quebrem linha */
        }

        .botao {
            padding: 12px 25px;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            font-family: 'MedievalSharp', serif;
            color: #fff; /* Cor padr√£o do texto dos bot√µes */
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
            background: var(--button-bg); /* Usa a vari√°vel de fundo do bot√£o */
        }
        .botao:hover {
            background: var(--button-hover-bg);
            transform: translateY(-2px);
        }


        .botao-reset { background: #b8860b; }
        .botao-reset:hover { background: #a0522d; }

        .botao-recomecar { background: #a52a2a; }
        .botao-recomecar:hover { background: #8b0000; }

        .botao-bloquear,
        .botao-desbloquear { background: #4a4a4a; }
        .botao-bloquear:hover,
        .botao-desbloquear:hover { background: #2a2a2a; }

        .botao-excluir {
            background: #a52a2a;
            position: absolute;
            bottom: 20px;
            left: 20px;
        }
        .botao-excluir:hover { background: #8b0000; transform: translateY(-2px); }

        /* Estilo espec√≠fico para os bot√µes Lua, Sol e Cor Fundo */
        #lua-btn, #sol-btn, #cor-fundo-btn {
             background: #4a4a4a; /* Fundo cinza escuro */
             color: #fff;
        }
        #lua-btn:hover, #sol-btn:hover, #cor-fundo-btn:hover {
             background: #2a2a2a; /* Fundo mais escuro no hover */
             transform: translateY(-2px);
        }


        #nivel-container { text-align: center; margin-top: 10px; }
        #nivel {
            padding: 10px;
            background: var(--section-bg);
            border: 3px solid var(--border-color); /* Usando a cor da borda */
            border-radius: 50%;
            width: 100px;
            height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3.125rem;
            box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.5);
            margin: 0 auto;
            color: var(--text-color); /* Cor do n√∫mero do n√≠vel */
        }

        #nivel.aura-azul { animation: pulsar-aura 2s 10; }

        .expandable-textarea {
            height: 100px;
            width: 100%;
            background: var(--input-bg);
            border: 2px solid var(--input-border);
            border-radius: 6px;
            padding: 10px;
            font-size: 0.9rem;
            transition: height 0.3s ease;
            color: var(--input-text);
        }

        .expandable-textarea:focus { height: 15cm; }

        #dice-container {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 200px;
            text-align: center;
            font-family: 'MedievalSharp', serif;
            cursor: move;
            z-index: 10;
            user-select: none
        }
        #dice-container label {
            font-size: 1.2rem;
            color: var(--text-color);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 10px
        }
        #dice-container label::before { content: "üé≤"; margin-right: 5px; font-size: 1.5rem; }

        #dice-roll {
            width: 100px;
            height: 100px;
            background: var(--section-bg);
            border: 2px solid var(--border-color);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            cursor: pointer;
            margin: 0 auto;
            position: relative;
            transition: all 0.3s ease;
            color: var(--text-color);
        }
        #dice-roll::before { content: "‚öÖ"; font-size: 1.5rem; position: absolute; top: 5px; right: 5px; color: var(--button-hover-bg); }
        #dice-result { margin-top: 10px; font-size: 1rem; color: var(--text-color); display: none; animation: blink 1s infinite; }

        @keyframes blink { 50% { opacity: 0 } }

        #dice-roll.critical-failure { animation: aura-vermelha 2s infinite; }
        #dice-roll.critical-success { animation: aura-verde 2s infinite; }

        @keyframes aura-vermelha {
            0% { box-shadow: 0 0 5px #ff0000, 0 0 10px #ff0000; }
            50% { box-shadow: 0 0 15px #ff0000, 0 0 20px #ff0000; }
            100% { box-shadow: 0 0 5px #ff0000, 0 0 10px #ff0000; }
        }
        @keyframes aura-verde {
            0% { box-shadow: 0 0 5px #00ff00, 0 0 10px #00ff00; }
            50% { box-shadow: 0 0 15px #00ff00, 0 0 20px #00ff00; }
            100% { box-shadow: 0 0 5px #00ff00, 0 0 10px #00ff00; }
        }

        #notification {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 20px;
            border-radius: 8px;
            font-family: 'MedievalSharp', serif;
            font-size: 1.5rem;
            color: #fff;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
            display: none;
            z-index: 100;
            background: rgba(0, 0, 0, 0.7);
            transition: opacity 0.3s ease;
        }
        #notification.critical-failure { background: rgba(255, 0, 0, 0.8); animation: aura-vermelha 2s infinite; }
        #notification.critical-success { background: rgba(0, 255, 0, 0.8); animation: aura-verde 2s infinite; }
        #notification.normal-result,
        #notification.save-success { animation: blink 1s infinite; }
        #notification.save-success { background: rgba(0, 200, 0, 0.8); }

        #character-image-container {
            position: absolute;
            top: 10px;
            left: 10px;
            width: 100px;
            height: 100px;
            background: var(--section-bg);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            overflow: hidden;
            z-index: 10;
        }
        #character-image { width: 100%; height: 100%; object-fit: cover; display: none; }
        #character-image-container:hover { box-shadow: 0 0 10px #ffd700; }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background: var(--modal-bg);
            padding: 20px;
            border-radius: 8px;
            border: 2px solid var(--modal-border);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            width: 300px;
            text-align: center;
            color: var(--modal-text); /* Cor do texto no modal */
        }
        .modal-content h3, .modal-content h4 {
            font-family: 'MedievalSharp', serif;
            color: var(--modal-text);
            margin-bottom: 15px;
        }
        .modal-content input, .modal-content textarea { /* Estilo unificado para inputs/textarea no modal */
            width: calc(100% - 22px); /* Ajuste para padding e borda */
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid var(--input-border);
            border-radius: 6px;
            background: var(--input-bg);
            color: var(--input-text);
        }
        .modal-content button {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-family: 'MedievalSharp', serif;
            color: #fff;
            cursor: pointer;
            margin: 5px; /* Espa√ßamento entre bot√µes */
            background: var(--button-bg); /* Fundo do bot√£o */
        }
        .modal-content button:hover {
             background: var(--button-hover-bg);
        }
        .modal-content .confirm-btn { background: #b8860b; }
        .modal-content .confirm-btn:hover { background: #a0522d; }
        .modal-content .cancel-btn { background: #a52a2a; }
        .modal-content .cancel-btn:hover { background: #8b0000; }

        /* Bot√µes Vantagens, Ra√ßas, Classes */
        #vantagens-desvantagens-btn,
        #racas-btn,
        #classes-btn {
            padding: 10px 20px;
            background: var(--section-bg);
            border: 2px solid var(--border-color);
            border-radius: 6px;
            font-family: 'MedievalSharp', serif;
            font-size: 1rem;
            color: var(--text-color);
            cursor: pointer;
            transition: background-color 0.3s ease;
            z-index: 10;
            margin: 5px; /* Adiciona margem */
        }
        #vantagens-desvantagens-btn:hover,
        #racas-btn:hover,
        #classes-btn:hover {
            background: var(--button-hover-bg);
            color: #fff; /* Texto branco no hover */
        }

        /* Paineis Vantagens, Ra√ßas, Classes */
        #vantagens-desvantagens-panel,
        #racas-panel,
        #classes-panel {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--internal-bg); /* Usa fundo interno para consist√™ncia */
            padding: 20px;
            overflow-y: auto;
            z-index: 999;
            border: 2px solid var(--border-color);
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.3);
            color: var(--text-color); /* Cor do texto */
        }
        #vantagens-desvantagens-panel h2, #racas-panel h2, #classes-panel h2 {
            font-family: 'MedievalSharp', serif;
            font-size: 2rem;
            text-align: center;
            color: var(--button-hover-bg); /* Cor destaque */
            margin-bottom: 20px;
        }
        #racas-panel h2 { font-size: 3rem; }

        .vantagem-item,
        .desvantagem-item,
        .raca-item {
            padding: 10px;
            margin: 5px 0;
            background: var(--input-bg);
            border: 1px solid var(--input-border);
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            color: var(--text-color); /* Cor do texto */
        }
        .vantagem-item:hover,
        .desvantagem-item:hover,
        .raca-item:hover {
            background: var(--list-item-hover-bg); /* Cor de hover da lista */
        }
        .vantagem-item.comprada, .raca-item.comprada { background: #ffcccc; color: #f00; cursor: default; }
        .desvantagem-item.comprada { background: #ccffcc; color: #080; cursor: default; }

        /* Bot√µes de Salvar/Fechar nos pain√©is */
        #salvar-vantagens-btn, #salvar-racas-btn,
        #fechar-pagina-btn, #fechar-racas-btn, #fechar-classes-btn {
            position: fixed;
            bottom: 20px;
            padding: 12px 25px;
            background: #a52a2a; /* Vermelho padr√£o para fechar */
            color: #fff;
            border: none;
            border-radius: 6px;
            font-family: 'MedievalSharp', serif;
            font-size: 1.2rem;
            cursor: pointer;
            transition: transform 0.2s ease;
        }
        #salvar-vantagens-btn, #salvar-racas-btn {
            right: 250px;
            animation: aura-verde-btn 2s infinite;
            display: none; /* Come√ßa escondido */
            background: #006400; /* Verde escuro para salvar */
        }
        #fechar-pagina-btn, #fechar-racas-btn, #fechar-classes-btn { right: 20px; }

        #salvar-vantagens-btn:hover, #salvar-racas-btn:hover,
        #fechar-pagina-btn:hover, #fechar-racas-btn:hover, #fechar-classes-btn:hover {
            transform: translateY(-2px);
        }

        @keyframes aura-verde-btn {
            0% { box-shadow: 0 0 5px #00ff00, 0 0 10px #00ff00; }
            50% { box-shadow: 0 0 15px #00ff00, 0 0 20px #00ff00; }
            100% { box-shadow: 0 0 5px #00ff00, 0 0 10px #00ff00; }
        }

        /* Locomo√ß√£o */
        .locomotion-container {
            background: #8B4513;
            border: 3px solid #FFD700;
            border-radius: 10px;
            padding: 15px;
            color: #FFD700;
            font-family: 'MedievalSharp', serif;
        }
        .locomotion-item { display: flex; align-items: center; margin-bottom: 10px; }
        .locomotion-item label { font-weight: bold; color: #FFD700; }
        .locomotion-item span {
            font-size: 1.2rem;
            color: #FFF;
            text-shadow: 1px 1px 2px #000;
            margin-left: 5px;
            font-weight: bold;
        }
        #distancia-pulo, #altura-pulo, #velocidade-corrida {
            /* Readonly, estilo j√° definido */
        }

        /* List Display (Vantagens/Desvantagens na ficha) */
        .list-display {
            background: var(--input-bg);
            border: 2px solid var(--input-border);
            border-radius: 6px;
            padding: 10px;
            min-height: 100px;
            max-height: 200px;
            overflow-y: auto;
            color: var(--text-color); /* Cor do texto */
        }
        .list-item {
            cursor: pointer;
            margin-bottom: 5px;
            padding: 5px;
            border-bottom: 1px solid var(--list-item-border);
        }
        .list-item:hover { background: var(--list-item-hover-bg); }

        /* Invent√°rio */
        .inventory-slot { display: flex; align-items: center; margin-bottom: 10px; }
        .inventory-slot input[type="text"] { flex-grow: 1; margin-right: 10px; margin-bottom: 0; /* Remove margem inferior padr√£o */}
        .inventory-slot input[type="number"] { width: 60px; margin-bottom: 0; /* Remove margem inferior padr√£o */ }

        /* Anota√ß√µes */
        #anotacoes-btn {
            position: fixed;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            padding: 10px 20px;
            background: var(--section-bg);
            border: 2px solid var(--border-color);
            border-radius: 6px;
            font-family: 'MedievalSharp', serif;
            font-size: 1rem;
            color: var(--text-color);
            cursor: pointer;
            transition: background-color 0.3s ease;
            z-index: 900; /* Abaixo dos modais */
        }
        #anotacoes-btn:hover { background: var(--button-hover-bg); color: #fff; }

        #anotacoes-textarea {
            display: none;
            position: fixed;
            left: 60px; /* Ajustar posi√ß√£o se necess√°rio */
            top: 50%;
            transform: translateY(-50%);
            width: 400px;
            height: 400px;
            background: var(--input-bg);
            border: 2px solid var(--input-border);
            border-radius: 6px;
            padding: 10px;
            font-size: 0.9rem;
            resize: none;
            color: var(--input-text);
            z-index: 900; /* Abaixo dos modais */
        }

        /* Hist√≥rico Dados */
        #historico-dados-btn {
            position: fixed;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            padding: 10px 20px;
            background: var(--section-bg);
            border: 2px solid var(--border-color);
            border-radius: 6px;
            font-family: 'MedievalSharp', serif;
            font-size: 1rem;
            color: var(--text-color);
            cursor: pointer;
            transition: background-color 0.3s ease;
            z-index: 900; /* Abaixo dos modais */
        }
        #historico-dados-btn:hover { background: var(--button-hover-bg); color: #fff; }

        #historico-dados-panel {
            display: none;
            position: fixed;
            right: 10px; /* Ajustar posi√ß√£o se necess√°rio */
            top: 50%;
            transform: translateY(-50%);
            width: 300px;
            background: var(--input-bg);
            border: 2px solid var(--input-border);
            border-radius: 6px;
            padding: 10px;
            max-height: 400px;
            overflow-y: auto;
            color: var(--text-color); /* Cor do texto */
            z-index: 900; /* Abaixo dos modais */
        }
        #historico-dados-panel h3 { font-family: 'MedievalSharp', serif; color: var(--text-color); margin-bottom: 10px; }
        #historico-lista div { padding: 5px; border-bottom: 1px solid var(--list-item-border); }
        #excluir-historico-btn { background: #a52a2a; color: #fff; padding: 8px 16px; border-radius: 6px; cursor: pointer; margin-top: 10px; border: none; /* Remove borda padr√£o */ }
        #excluir-historico-btn:hover { background: #8b0000; }

        /* Magias */
        .magias-container {
            max-height: 300px;
            overflow-y: auto;
            border: 2px solid var(--input-border);
            border-radius: 6px;
            padding: 10px;
            background: var(--input-bg);
        }
        .magias-container input { margin-bottom: 10px; }
        #adicionar-magia-btn {
            background: var(--button-bg);
            color: #fff;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            display: block;
            margin-top: 10px;
            border: none; /* Remove borda padr√£o */
            font-size: 1rem; /* Tamanho de fonte consistente */
            font-family: 'MedievalSharp', serif; /* Fonte consistente */
        }
        #adicionar-magia-btn:hover { background: var(--button-hover-bg); }

        /* Classe/Ra√ßa */
        .classe-raca-container {
            background: var(--section-bg);
            border: 2px solid var(--border-color);
            padding: 10px;
            border-radius: 6px;
            margin-top: 10px;
        }
        .classe-raca-container label {
            font-family: 'MedievalSharp', serif;
            color: var(--button-hover-bg); /* Cor destaque */
            font-size: 1.2rem;
        }
        .classe-raca-container span[onclick] {
            background: var(--input-bg);
            border: 2px solid var(--input-border);
            padding: 10px;
            cursor: pointer;
            display: block;
            color: var(--input-text); /* Cor do texto */
            margin-bottom: 15px; /* Adiciona espa√ßo abaixo */
            border-radius: 6px; /* Consist√™ncia */
        }
        .classe-raca-container textarea {
            width: 100%;
            background: var(--input-bg);
            border: 2px solid var(--input-border);
            color: var(--input-text);
            /* Estilo expandable j√° definido */
        }

        /* Ra√ßas no painel */
        .raca-item {
            margin-bottom: 20px;
            padding: 10px;
            background: var(--input-bg);
            border: 2px solid var(--input-border);
            border-radius: 6px;
        }
        .raca-item h3 { font-family: 'MedievalSharp', serif; font-size: 1.5rem; color: var(--button-hover-bg); }
        .raca-item p, .raca-item ul li { font-size: 1rem; color: var(--text-color); }

        /* Chat Modal */
        #chat-modal { display: none; /* Mantido */ }
        #chat-modal .modal-content {
            width: 500px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
        }
        #chat-modal .chat-header {
            padding: 10px;
            border-bottom: 1px solid var(--list-item-border);
            font-family: 'MedievalSharp', serif;
            font-size: 1.5rem;
            text-align: center;
            color: var(--modal-text);
        }
        #chat-modal .chat-body { flex-grow: 1; display: flex; overflow: hidden; }
        #chat-modal .user-list {
            width: 150px;
            border-right: 1px solid var(--list-item-border);
            overflow-y: auto;
            padding: 10px;
        }
        #chat-modal .user-list h4 { font-family: 'MedievalSharp', serif; margin-bottom: 5px; color: var(--modal-text); }
        #chat-modal .user-list .user-item {
            padding: 8px;
            cursor: pointer;
            border-bottom: 1px solid var(--list-item-border);
            color: var(--modal-text);
        }
        #chat-modal .user-list .user-item:hover { background-color: var(--list-item-hover-bg); }

        #chat-modal .conversation {
            flex-grow: 1;
            padding: 10px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }
        #chat-modal .message-container { display: flex; flex-direction: column; margin-bottom: 8px; }
        #chat-modal .message {
            padding: 8px;
            border-radius: 5px;
            background-color: var(--readonly-bg); /* Fundo da mensagem recebida */
            color: var(--text-color);
            width: fit-content;
            max-width: 80%;
        }
        #chat-modal .message.sent {
            background-color: #cce5ff; /* Azul claro para enviadas (light mode) */
            align-self: flex-end;
        }
        body.dark-mode #chat-modal .message.sent {
             background-color: #6699cc; /* Azul mais escuro para enviadas (dark mode) */
             color: #e0e0e0;
        }
        #chat-modal .sender-name { font-size: 0.8rem; color: #777; margin-bottom: 2px; }
        body.dark-mode #chat-modal .sender-name { color: #aaa; }

        #chat-modal .chat-input { padding: 10px; border-top: 1px solid var(--list-item-border); display: flex; }
        #chat-modal .chat-input input[type="text"] {
             flex-grow: 1;
             padding: 8px;
             border-radius: 5px;
             border: 1px solid var(--input-border);
             margin-right: 10px;
             background: var(--input-bg);
             color: var(--input-text);
        }
        #chat-modal .chat-input button { padding: 8px 15px; border-radius: 5px; font-size: 1rem; /* Ajuste tamanho */ }

        /* Modais Senha Chat */
        #chat-password-modal .modal-content,
        #open-chat-modal .modal-content { width: 350px; }

        /* Espa√ßamento bot√µes modal ra√ßa */
        #raca-opcoes-modal .modal-content button { margin-top: 5px; margin-bottom: 5px; }

        /* NOVO: Modal de Cores de Fundo */
        #cor-fundo-modal .modal-content {
            width: 450px; /* Largura um pouco maior */
            max-height: 80vh;
            overflow-y: auto;
        }
        .color-options-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
            padding: 10px;
            border: 1px dashed var(--input-border);
            border-radius: 6px;
        }
        .color-option {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid var(--input-border);
            display: inline-block;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            position: relative; /* Para tooltip */
        }
        .color-option:hover {
            transform: scale(1.1);
        }
        .color-option.selected-color {
            border-width: 3px;
            border-color: #ffd700; /* Destaque dourado para selecionado */
            box-shadow: 0 0 8px rgba(255, 215, 0, 0.7);
        }
        /* Tooltip simples para nome da cor */
        .color-option::after {
            content: attr(data-color-name);
            position: absolute;
            bottom: 110%;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 3px 6px;
            border-radius: 4px;
            font-size: 0.8rem;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s, visibility 0.2s;
        }
        .color-option:hover::after {
            opacity: 1;
            visibility: visible;
        }

        /* Efeito Ex√©rcito (Camuflagem) */
        .color-option[data-color-value*="camouflage"] {
             background-image: linear-gradient(45deg, #556B2F 25%, #8FBC8F 25%, #8FBC8F 50%, #556B2F 50%, #556B2F 75%, #8FBC8F 75%, #8FBC8F 100%);
             background-size: 20px 20px;
        }


        /* Media Queries (mantidos) */
        @media (max-width: 768px) {
            body { padding: 10px; }
            #ficha-container { padding: 15px; margin-top: 70px; /* Mais espa√ßo para sidebar */}
            h1#nome-personagem-titulo { font-size: 2rem; }
            section h2 { font-size: 1.2rem; }
            input, textarea { font-size: 0.9rem; }
            .atributos-container, .vida-magia-vigor { flex-direction: column; gap: 10px; }
            .atributos-coluna, .atributos-coluna-destaque, .atributo-container { width: 100%; }
            .botoes-container { gap: 5px; }
            .botao { padding: 10px 15px; font-size: 0.9rem; }
            #dice-container { position: static; width: 100%; margin-bottom: 15px; }
            #character-image-container { position: static; margin: 0 auto 15px; }
            #fichas-sidebar { height: 50px; } /* Reduz altura da sidebar */
            .ficha-tab, #add-ficha-btn { height: 40px; width: 80px; font-size: 0.8rem; }
            .modal-content { width: 90%; }
            #chat-modal .modal-content { width: 95%; }
            #chat-modal .chat-body { flex-direction: column; }
            #chat-modal .user-list { width: 100%; border-right: none; border-bottom: 1px solid var(--list-item-border); max-height: 150px; }
            #anotacoes-btn, #historico-dados-btn, #chat-btn-container { position: static; transform: none; margin: 10px 0; width: 100%; text-align: center; }
            #anotacoes-textarea, #historico-dados-panel { position: static; transform: none; width: 100%; max-height: 200px; margin-bottom: 10px; }
             #cor-fundo-modal .modal-content { width: 90%; } /* Ajuste modal de cores */
        }

    </style>
</head>

<body>
    <!-- Bot√£o Chat (mantido) -->
    <div id="chat-btn-container">
        <button id="chat-btn" data-unread="0">üí¨ Chat</button>
    </div>

    <!-- Sidebar de Fichas (mantido) -->
    <div id="fichas-sidebar">
        <!-- Abas das fichas ser√£o inseridas aqui -->
        <div id="add-ficha-btn"><span>+ Fichas</span></div>
    </div>

    <!-- Container Principal da Ficha -->
    <div id="ficha-container">
        <h1 id="nome-personagem-titulo">Ficha de Personagem</h1>
        <div id="game-master-message">Voc√™ virou o Game Master</div>

        <!-- Imagem do Personagem (mantido) -->
        <div id="character-image-container" onclick="document.getElementById('character-image-input').click()">
            <img id="character-image" alt="Imagem do Personagem">
            <input type="file" id="character-image-input" accept="image/*" style="display:none">
        </div>

        <!-- Container do Dado (mantido) -->
        <div id="dice-container">
            <label>Role seu dado:</label>
            <div id="dice-roll">-</div>
            <div id="dice-result"></div>
        </div>

        <!-- Conte√∫do da Ficha (mantido) -->
        <div id="ficha-content">
            <section id="informacoes-basicas">
                <h2>Informa√ß√µes B√°sicas</h2>
                <label for="nome-personagem">Nome do Personagem:</label>
                <input type="text" id="nome-personagem" placeholder="Digite o nome do seu personagem">

                <label for="descricao-personagem">Descri√ß√£o do Personagem:</label>
                <textarea id="descricao-personagem" placeholder="Digite a descri√ß√£o do seu personagem"></textarea>
            </section>

            <section id="recursos">
                <h2>Recursos</h2>
                <div class="vida-magia-vigor">
                    <div class="atributo-container vida">
                        <h3>Vida</h3>
                        <div class="valor-total medieval-box">
                            <span>Vida Total: </span>
                            <span id="vida-total" readonly>50</span>
                        </div>
                        <div class="valor-atual medieval-box">
                            <span>Vida Atual: </span>
                            <button onclick="diminuirVida()" title="Diminuir Vida">‚ñº</button>
                            <span id="vida-atual">50</span>
                            <button onclick="aumentarVida()" title="Aumentar Vida">‚ñ≤</button>
                        </div>
                        <div class="regeneracao">
                            <span>Regenera√ß√£o por turno: <span id="regeneracao-vida">0</span> (parado)</span>
                        </div>
                    </div>

                    <div class="atributo-container magia">
                        <h3>Magia</h3>
                        <div class="valor-total medieval-box">
                            <span>Magia Total: </span>
                            <span id="magia-total" readonly>20</span>
                        </div>
                        <div class="valor-atual medieval-box">
                            <span>Magia Atual: </span>
                            <button onclick="diminuirMagia()" title="Diminuir Magia">‚ñº</button>
                            <span id="magia-atual">20</span>
                            <button onclick="aumentarMagia()" title="Aumentar Magia">‚ñ≤</button>
                        </div>
                        <div class="regeneracao">
                            <span>Regenera√ß√£o por turno: <span id="regeneracao-magia">0</span></span>
                        </div>
                    </div>

                    <div class="atributo-container vigor">
                        <h3>Vigor</h3>
                        <div class="valor-total medieval-box">
                            <span>Vigor Total: </span>
                            <span id="vigor-total" readonly>10</span>
                        </div>
                        <div class="valor-atual medieval-box">
                            <span>Vigor Atual: </span>
                            <button onclick="diminuirVigor()" title="Diminuir Vigor">‚ñº</button>
                            <span id="vigor-atual">10</span>
                            <button onclick="aumentarVigor()" title="Aumentar Vigor">‚ñ≤</button>
                        </div>
                        <div class="regeneracao">
                            <span>Regenera√ß√£o por turno: <span id="regeneracao-vigor">0</span> (parado)</span>
                        </div>
                    </div>
                </div>
            </section>

            <section id="atributos">
                <h2>Atributos</h2>
                <div class="atributos-container">
                    <div class="atributos-coluna">
                        <div class="atributo">
                            <label for="forca" title="Afeta ataque e RDF">For√ßa:</label>
                            <input type="number" id="forca" value="0" min="0">
                        </div>
                        <div class="atributo">
                            <label for="destreza" title="Afeta ataque e acerto">Destreza:</label>
                            <input type="number" id="destreza" value="0" min="0">
                        </div>
                        <div class="atributo">
                            <label for="agilidade" title="Afeta esquiva e acerto">Agilidade:</label>
                            <input type="number" id="agilidade" value="0" min="0">
                        </div>
                        <div class="atributo">
                            <label for="constituicao" title="Afeta vida, magia e vigor">Constitui√ß√£o:</label>
                            <input type="number" id="constituicao" value="0" min="0">
                        </div>
                        <div class="atributo">
                            <label for="inteligencia" title="Afeta ataque m√°gico e RDM">Intelig√™ncia:</label>
                            <input type="number" id="inteligencia" value="0" min="0">
                        </div>
                    </div>

                    <div class="atributos-coluna-destaque">
                        <div class="atributo-destaque">
                            <label>Ataque:</label>
                            <span id="ataque" readonly>0</span>
                        </div>
                        <div class="atributo-destaque">
                            <label>Ataque M√°gico:</label>
                            <span id="ataque-magico" readonly>0</span>
                        </div>
                        <div class="atributo-destaque">
                            <label>Acerto:</label>
                            <span id="acerto" readonly>0</span>
                        </div>
                        <div class="atributo-destaque">
                            <label>Esquiva:</label>
                            <span id="esquiva" readonly>0</span>
                        </div>
                        <div class="atributo-destaque">
                            <label>RDF:</label>
                            <span id="rdf" readonly>0</span>
                        </div>
                        <div class="atributo-destaque">
                            <label>RDM:</label>
                            <span id="rdm" readonly>0</span>
                        </div>
                    </div>
                </div>
            </section>

            <section id="combate">
                 <h2>Combate</h2>
                 <div class="armamento-container" style="display: flex; gap: 20px; flex-wrap: wrap;"> {/* Ajuste para flex e gap */}
                     <div class="armamento-coluna" style="flex: 1; min-width: 300px;"> {/* Flex√≠vel */}
                         <label>Armamento M√£o Direita:</label>
                         <div class="flex items-center mb-2 flex-wrap"> {/* Permite quebra de linha */}
                             <input type="text" id="arma-direita-nome" placeholder="Nome da Arma" class="mr-2 flex-grow mb-1 sm:mb-0"> {/* Cresce e ajusta margem */}
                             <span class="mr-1">Ataque </span>
                             <input type="number" id="arma-direita-ataque" value="0" class="w-20 mr-2 mb-1 sm:mb-0">
                             <span class="mr-1">Atq. M√°gico </span>
                             <input type="number" id="arma-direita-ataque-magico" value="0" class="w-20 mb-1 sm:mb-0">
                         </div>
                     </div>
                     <div class="armamento-coluna" style="flex: 1; min-width: 300px;"> {/* Flex√≠vel */}
                         <label>Armamento M√£o Esquerda:</label>
                         <div class="flex items-center flex-wrap"> {/* Permite quebra de linha */}
                             <input type="text" id="arma-esquerda-nome" placeholder="Nome da Arma/Escudo" class="mr-2 flex-grow mb-1 sm:mb-0"> {/* Cresce e ajusta margem */}
                             <span class="mr-1">Ataque </span>
                             <input type="number" id="arma-esquerda-ataque" value="0" class="w-20 mr-2 mb-1 sm:mb-0">
                             <span class="mr-1">Atq. M√°gico </span>
                             <input type="number" id="arma-esquerda-ataque-magico" value="0" class="w-20 mb-1 sm:mb-0">
                         </div>
                     </div>
                 </div>
             </section>

            <section id="inventario-habilidades">
                <h2>Invent√°rio e Habilidades</h2>
                <div class="flex gap-20 flex-wrap"> {/* Adicionado flex-wrap */}
                    <div style="width:100%; max-width: 500px; margin-bottom: 20px;"> {/* Ajustado para responsividade */}
                        <label>Invent√°rio (Peso Total: <span id="peso-total">0</span> kg):</label>
                        <div id="inventario-slots">
                            <!-- Slots de invent√°rio mantidos -->
                             <div class="inventory-slot">
                                 <input type="text" placeholder="Item 1" class="inventory-item">
                                 <input type="number" min="0" value="0" class="inventory-weight" title="Peso em kg">
                             </div>
                             <div class="inventory-slot">
                                 <input type="text" placeholder="Item 2" class="inventory-item">
                                 <input type="number" min="0" value="0" class="inventory-weight">
                             </div>
                             <div class="inventory-slot">
                                 <input type="text" placeholder="Item 3" class="inventory-item">
                                 <input type="number" min="0" value="0" class="inventory-weight">
                             </div>
                             <div class="inventory-slot">
                                 <input type="text" placeholder="Item 4" class="inventory-item">
                                 <input type="number" min="0" value="0" class="inventory-weight">
                             </div>
                             <div class="inventory-slot">
                                 <input type="text" placeholder="Item 5" class="inventory-item">
                                 <input type="number" min="0" value="0" class="inventory-weight">
                             </div>
                             <div class="inventory-slot">
                                 <input type="text" placeholder="Item 6" class="inventory-item">
                                 <input type="number" min="0" value="0" class="inventory-weight">
                             </div>
                             <div class="inventory-slot">
                                 <input type="text" placeholder="Item 7" class="inventory-item">
                                 <input type="number" min="0" value="0" class="inventory-weight">
                             </div>
                             <div class="inventory-slot">
                                 <input type="text" placeholder="Item 8" class="inventory-item">
                                 <input type="number" min="0" value="0" class="inventory-weight">
                             </div>
                             <div class="inventory-slot">
                                 <input type="text" placeholder="Item 9" class="inventory-item">
                                 <input type="number" min="0" value="0" class="inventory-weight">
                             </div>
                             <div class="inventory-slot">
                                 <input type="text" placeholder="Item 10" class="inventory-item">
                                 <input type="number" min="0" value="0" class="inventory-weight">
                             </div>
                        </div>
                    </div>

                    <div style="width:100%; max-width: 500px;"> {/* Ajustado para responsividade */}
                        <label>Magias e Habilidades:</label>
                        <div id="magias-list" class="magias-container">
                           <!-- Inputs de magia/habilidade mantidos -->
                            <input type="text" placeholder="Magia/Habilidade 1" class="magia-nome">
                            <input type="text" placeholder="Magia/Habilidade 2" class="magia-nome">
                            <input type="text" placeholder="Magia/Habilidade 3" class="magia-nome">
                            <input type="text" placeholder="Magia/Habilidade 4" class="magia-nome">
                            <input type="text" placeholder="Magia/Habilidade 5" class="magia-nome">
                            <input type="text" placeholder="Magia/Habilidade 6" class="magia-nome">
                            <input type="text" placeholder="Magia/Habilidade 7" class="magia-nome">
                            <input type="text" placeholder="Magia/Habilidade 8" class="magia-nome">
                            <input type="text" placeholder="Magia/Habilidade 9" class="magia-nome">
                            <input type="text" placeholder="Magia/Habilidade 10" class="magia-nome">
                        </div>
                        <button id="adicionar-magia-btn">Adicionar Magia</button>
                    </div>
                </div>

                <div class="mt-4">
                    <label>Vantagens:</label>
                    <div id="vantagens-list-display" class="list-display"></div>
                    <label class="mt-4">Desvantagens:</label> {/* Adicionado mt-4 */}
                    <div id="desvantagens-list-display" class="list-display"></div>
                </div>

                <div class="classe-raca-container mt-4"> {/* Adicionado mt-4 */}
                    <label>Classe:</label>
                    <input type="text" id="classe-nome" placeholder="Nome da Classe">
                    <textarea id="classe-descricao" placeholder="Descri√ß√£o da Classe"
                        class="expandable-textarea"></textarea>

                    <label class="mt-4">Ra√ßa:</label> {/* Adicionado mt-4 */}
                    <span id="raca-nome" onclick="abrirModalRaca()">Clique para selecionar/editar</span> {/* Texto inicial */}
                    <textarea id="raca-descricao" placeholder="Descri√ß√£o da Ra√ßa" class="expandable-textarea"
                        readonly></textarea>
                </div>
            </section>

            <section id="locomocao">
                <h2>Locomo√ß√£o</h2>
                <div class="locomotion-container">
                    <div class="locomotion-item">
                        <label>Velocidade de Corrida (km/h):</label>
                        <span>üèÉ‚Äç‚ôÇÔ∏è</span>
                        <span id="velocidade-corrida" readonly>25</span>
                    </div>
                    <div class="locomotion-item">
                        <label>Altura do Pulo (m):</label>
                        <span>‚¨ÜÔ∏è</span>
                        <span id="altura-pulo" readonly>1</span>
                    </div>
                    <div class="locomotion-item">
                        <label>Dist√¢ncia do Pulo (m):</label>
                        <span>‚û°Ô∏è</span>
                        <span id="distancia-pulo" readonly>3</span>
                    </div>
                </div>
            </section>

            <section id="status">
                <h2>Status</h2>
                <div class="flex gap-20 flex-wrap"> {/* Adicionado flex-wrap */}
                    <div style="min-width: 200px;"> {/* Largura m√≠nima */}
                        <label>Experi√™ncia:</label>
                        <input type="number" id="experiencia" value="0" min="0">
                        <label>Pontos de Habilidade (PD):</label>
                        <span id="pontos-habilidade" readonly>25</span>
                        <label>Pontos de Vantagem (PH):</label>
                        <span id="pontos-vantagem" readonly>8</span>
                    </div>
                     <div id="nivel-container" style="min-width: 200px; text-align: center;"> {/* N√≠vel aqui */}
                         <label>N√≠vel:</label>
                         <span id="nivel">0</span>
                     </div>
                </div>
                <!-- N√≠vel movido para dentro do flex container acima -->
            </section>

            <!-- Bot√µes Vantagens, Ra√ßas, Classes -->
            <div style="display:flex;justify-content:center;gap:10px;margin-bottom:20px;flex-wrap:wrap;">
                <button id="vantagens-desvantagens-btn" class="botao">Vantagens e Desvantagens</button>
                <button id="racas-btn" class="botao">Ra√ßas üè∞</button>
                <button id="classes-btn" class="botao">Classes ‚öîÔ∏è</button>
            </div>

            <!-- Bot√µes Principais -->
            <div class="botoes-container">
                <button id="reset-pontos" class="botao botao-reset">Reiniciar Pontos</button>
                <button id="recomecar" class="botao botao-recomecar">Recome√ßar</button>
                <button id="bloquear-ficha" class="botao botao-bloquear">Bloquear Ficha</button>
                <button id="lua-btn" class="botao">üåô</button>
                <button id="sol-btn" class="botao">‚òÄÔ∏è</button>
                <button id="cor-fundo-btn" class="botao">üé® Cor</button> <!-- NOVO BOT√ÉO -->
            </div>

            <!-- Bot√£o Excluir Ficha (mantido) -->
            <button id="excluir-ficha" class="botao botao-excluir">Excluir Ficha</button>
        </div>
    </div>

    <!-- Bot√£o e Textarea de Anota√ß√µes (mantidos) -->
    <button id="anotacoes-btn">Anota√ß√µes</button>
    <textarea id="anotacoes-textarea" placeholder="Suas anota√ß√µes aqui..."></textarea>

    <!-- Bot√£o e Painel de Hist√≥rico de Dados (mantidos) -->
    <button id="historico-dados-btn">Hist√≥rico</button>
    <div id="historico-dados-panel">
        <h3>Hist√≥rico de Dados</h3>
        <div id="historico-lista"></div>
        <button id="excluir-historico-btn">Excluir</button>
    </div>

    <!-- Paineis Vantagens/Desvantagens, Ra√ßas, Classes (mantidos) -->
    <div id="vantagens-desvantagens-panel">
        <h2>Vantagens e Desvantagens</h2>
        <div>Pontos de Vantagem Tempor√°rios: <span id="ph-temp">0</span></div>
        <div id="vantagens-list"></div>
        <div id="desvantagens-list"></div>
        <button id="salvar-vantagens-btn">SALVAR</button>
        <button id="fechar-pagina-btn">Fechar</button>
    </div>

    <div id="racas-panel">
        <h2>Ra√ßas</h2>
        <div id="racas-list"></div>
        <button id="salvar-racas-btn">SALVAR</button>
        <button id="fechar-racas-btn">Fechar</button>
    </div>

    <div id="classes-panel">
        <h2>Classes</h2>
        <!-- Conte√∫do das classes pode ser adicionado aqui -->
        <button id="fechar-classes-btn">Fechar</button>
    </div>

    <!-- Modais existentes (mantidos) -->
    <div id="nome-ficha-modal" class="modal">
        <div class="modal-content">
            <h3>D√™ um Nome √† Ficha</h3>
            <input type="text" id="nome-ficha-input" placeholder="Nome da ficha" maxlength="20">
            <button class="confirm-btn" onclick="criarNovaFicha()">Confirmar</button>
            <button class="cancel-btn" onclick="fecharModal('nome-ficha-modal')">Cancelar</button>
        </div>
    </div>

    <div id="bloquear-ficha-modal" class="modal">
        <div class="modal-content">
            <h3>Ponha sua Senha de 4 D√≠gitos</h3>
            <input type="password" id="senha-bloqueio-input" placeholder="Senha (4 d√≠gitos)" maxlength="4" pattern="\d{4}" inputmode="numeric">
            <button class="confirm-btn" onclick="bloquearFicha()">Confirmar</button>
            <button class="cancel-btn" onclick="fecharModal('bloquear-ficha-modal')">Cancelar</button>
        </div>
    </div>

    <div id="password-modal" class="modal">
        <div class="modal-content">
            <h3>Digite sua Senha</h3>
            <input type="password" id="senha-desbloqueio-input" placeholder="Senha (4 d√≠gitos)" maxlength="4" pattern="\d{4}" inputmode="numeric">
            <button class="confirm-btn" onclick="desbloquearFicha()">Confirmar</button>
            <button class="cancel-btn" onclick="cancelarDesbloqueio()">Cancelar</button>
        </div>
    </div>

    <div id="confirmar-compra-modal" class="modal">
        <div class="modal-content">
            <h3 id="confirmar-compra-texto">Tem certeza que quer comprar isso?</h3>
            <button class="confirm-btn" id="confirmar-compra-btn">Sim</button>
            <button class="cancel-btn" onclick="fecharModal('confirmar-compra-modal')">N√£o</button>
        </div>
    </div>

    <div id="salvar-vantagens-modal" class="modal">
        <div class="modal-content">
            <h3>Se salvar, as altera√ß√µes n√£o poder√£o ser desfeitas sem permiss√£o do GM.</h3>
            <button class="confirm-btn" id="confirmar-salvar-vantagens-btn">OK</button>
            <button class="cancel-btn" onclick="fecharModal('salvar-vantagens-modal')">Cancelar</button>
        </div>
    </div>

    <div id="senha-gm-modal" class="modal">
        <div class="modal-content">
            <h3>Pe√ßa permiss√£o ao GM</h3>
            <input type="password" id="senha-gm-input" placeholder="Senha GM">
            <button class="confirm-btn" id="confirmar-senha-gm-btn">Confirmar</button>
            <button class="cancel-btn" onclick="fecharModal('senha-gm-modal')">Cancelar</button>
        </div>
    </div>

    <div id="raca-opcoes-modal" class="modal">
        <div class="modal-content">
            <h3>O que voc√™ deseja fazer?</h3>
            <button class="confirm-btn" onclick="excluirRacaSelecionadaModal()">Excluir Ra√ßa</button>
            <button class="confirm-btn" onclick="editarRacaSelecionadaModal()">Editar Ra√ßa</button>
            <button class="cancel-btn" onclick="fecharModal('raca-opcoes-modal')">Cancelar</button>
        </div>
    </div>

    <div id="editar-raca-modal" class="modal">
        <div class="modal-content">
            <h3>Editar Ra√ßa</h3>
            <label for="editar-raca-nome">Nome:</label>
            <input type="text" id="editar-raca-nome">
            <label for="editar-raca-descricao">Descri√ß√£o:</label>
            <textarea id="editar-raca-descricao"></textarea>
            <button class="confirm-btn" onclick="salvarEdicaoRaca()">Salvar</button>
            <button class="cancel-btn" onclick="fecharModal('editar-raca-modal')">Cancelar</button>
        </div>
    </div>

    <div id="chat-password-modal" class="modal">
        <div class="modal-content">
            <h3>Definir Senha do Chat</h3>
            <input type="password" id="chat-senha-input" placeholder="Senha do Chat (min 4 char)">
            <input type="password" id="chat-confirmar-senha-input" placeholder="Confirmar Senha">
            <button class="confirm-btn" onclick="definirSenhaChat()">Confirmar</button>
            <button class="cancel-btn" onclick="fecharModal('chat-password-modal')">Cancelar</button>
        </div>
    </div>

    <div id="open-chat-modal" class="modal">
        <div class="modal-content">
            <h3>Digite a Senha do Chat</h3>
            <input type="password" id="abrir-chat-senha-input" placeholder="Senha do Chat">
            <button class="confirm-btn" onclick="abrirChat()">Confirmar</button>
            <button class="cancel-btn" onclick="fecharModal('open-chat-modal')">Cancelar</button>
        </div>
    </div>

    <div id="chat-modal" class="modal">
        <div class="modal-content">
            <div class="chat-header"> Chat Privado </div>
            <div class="chat-body">
                <div class="user-list">
                    <h4>Fichas Online</h4>
                    <div id="available-fichas"></div>
                </div>
                <div class="conversation" id="conversation-area">
                    <!-- Mensagens ser√£o carregadas aqui -->
                     <div style="text-align: center; margin-top: 20px; color: var(--modal-text);">Selecione uma ficha para conversar.</div>
                </div>
            </div>
            <div class="chat-input">
                <input type="text" id="mensagem-input" placeholder="Digite sua mensagem..." disabled> <!-- Come√ßa desabilitado -->
                <button onclick="enviarMensagem()" id="enviar-mensagem-btn" disabled>Enviar</button> <!-- Come√ßa desabilitado -->
            </div>
             <button class="cancel-btn" style="margin-top: 10px;" onclick="fecharChatModal()">Fechar Chat</button> <!-- Bot√£o Fechar Chat -->
        </div>
    </div>

    <!-- NOVO MODAL: Cores de Fundo -->
    <div id="cor-fundo-modal" class="modal">
        <div class="modal-content">
            <h3>Escolha as Cores de Fundo</h3>

            <h4>Cor de Fundo Externa (Fora da Ficha)</h4>
            <div id="cores-externas-container" class="color-options-container">
                <!-- Op√ß√µes de cores externas ser√£o inseridas aqui -->
            </div>

            <h4>Cor de Fundo Interna (Ficha)</h4>
            <div id="cores-internas-container" class="color-options-container">
                <!-- Op√ß√µes de cores internas ser√£o inseridas aqui -->
            </div>

            <div class="botoes-container" style="justify-content: space-around;">
                <button id="salvar-cores-fundo-btn" class="confirm-btn">Salvar</button>
                <button id="excluir-cores-fundo-btn" class="cancel-btn" style="background-color: #ffa500;">Padr√£o</button> <!-- Bot√£o Excluir/Resetar -->
                <button id="cancelar-cores-fundo-btn" class="cancel-btn">Cancelar</button>
            </div>
        </div>
    </div>


    <!-- Notifica√ß√£o e √Åudio (mantidos) -->
    <div id="notification"></div>
    <audio id="new-message-sound" preload="auto">
        <source src="notification_sound.mp3" type="audio/mpeg">
    </audio>

    <script>
        // Configura√ß√£o Firebase (mantida)
        const firebaseConfig = {
            apiKey: "AIzaSyBbbwbwPXv6gztkyP3TXK-DtooEI7FcClI", // Substitua pela sua chave real se necess√°rio
            authDomain: "ficha-de-rpg-b9685.firebaseapp.com",
            databaseURL: "https://ficha-de-rpg-b9685-default-rtdb.firebaseio.com",
            projectId: "ficha-de-rpg-b9685",
            storageBucket: "ficha-de-rpg-b9685.firebasestorage.app",
            messagingSenderId: "528610398062",
            appId: "1:528610398062:web:8fdb9cfd5ded8167613b7f"
        };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Vari√°veis Globais (mantidas e adicionadas)
        let fichas = {},
            currentFichaId = null,
            isFichaLocked = false,
            fichaPassword = null,
            isFichaUnlocked = false,
            senhaMatriz = "1040",
            vantagensSelecionadas = [],
            desvantagensSelecionadas = [],
            tempVantagensSelecionadas = [],
            tempDesvantagensSelecionadas = [],
            racaSelecionada = null,
            tempRacaSelecionada = null,
            vidaTotal,
            vidaAtual,
            magiaTotal,
            magiaAtual,
            vigorTotal,
            vigorAtual,
            previousValues = new Map(),
            chatPassword = null,
            isChatOpen = false,
            selectedChatUser = null,
            selectedChatUserName = null, // Nome do usu√°rio do chat selecionado
            chatListener = null; // Para desativar listener antigo

        // NOVO: Vari√°veis para cores de fundo
        let tempExternalColor = null;
        let tempInternalColor = null;
        let currentExternalColor = null;
        let currentInternalColor = null;
        const defaultExternalColor = { value: "#f5f5f5 url('medieval_background.jpg') center/cover", type: 'image', name: 'Padr√£o' };
        const defaultInternalColor = { value: 'rgba(240, 230, 210, 0.95)', type: 'color', name: 'Pergaminho' };

        // NOVO: Defini√ß√£o das cores dispon√≠veis
        const backgroundColors = [
            { name: 'Pergaminho', value: 'rgba(240, 230, 210, 0.95)', type: 'color', defaultFor: 'internal' },
            { name: 'Padr√£o Imagem', value: "#f5f5f5 url('medieval_background.jpg') center/cover", type: 'image', defaultFor: 'external' },
            { name: 'Bord√¥', value: '#800000', type: 'color' },
            { name: 'Azul Escuro', value: '#00008B', type: 'color' },
            { name: 'Azul Claro', value: '#ADD8E6', type: 'color' },
            { name: 'Verde Escuro', value: '#006400', type: 'color' },
            { name: 'Verde Claro', value: '#90EE90', type: 'color' },
            { name: 'Rosa Claro', value: '#FFB6C1', type: 'color' },
            { name: 'Rosa Escuro', value: '#FF1493', type: 'color' },
            { name: 'Branco', value: '#FFFFFF', type: 'color' },
            { name: 'Cinza Claro', value: '#f5f5f5', type: 'color' }, // Adicionado Cinza Claro (base light mode)
            { name: 'Cinza Escuro', value: '#1e1e1e', type: 'color' }, // Adicionado Cinza Escuro (base dark mode)
            { name: 'Preto', value: '#121212', type: 'color' }, // Adicionado Preto (base dark mode body)
            { name: 'Laranja', value: '#FFA500', type: 'color' },
            { name: 'Roxo', value: '#800080', type: 'color' },
            { name: 'Vermelho', value: '#FF0000', type: 'color' },
            { name: 'Amarelo', value: '#FFFF00', type: 'color' },
            { name: 'Ex√©rcito', value: 'linear-gradient(45deg, #556B2F 25%, #8FBC8F 25%, #8FBC8F 50%, #556B2F 50%, #556B2F 75%, #8FBC8F 75%, #8FBC8F 100%)', type: 'gradient' } // Usando gradiente CSS
        ];

        // Dados de Vantagens, Desvantagens, Ra√ßas, N√≠veis (mantidos)
        const vantagensData = [ { nome: "Maestria com Armas curtas (2)", custo: 2, descricao: "Adiciona +1 em ataque, +1 em acerto com armas curtas." }, { nome: "Maestria com armas pesadas (2)", custo: 2, descricao: "Adiciona +2 em ataque com armas pesadas." }, { nome: "Maestria com armas de longo alcance (2)", custo: 2, descricao: "Adiciona +2 em acerto com armas de longo alcance." }, { nome: "Furtar (2)", custo: 2, descricao: "+4 em testes de furto." }, { nome: "L√°bia (2)", custo: 2, descricao: "+5 em testes de l√°bia." }, { nome: "Velejar (1)", custo: 1, descricao: "" }, { nome: "Beleza (1)", custo: 1, descricao: "Aumenta em +3 o teste em l√°bia, paquera e persuas√£o." }, { nome: "Boa Fama (2)", custo: 2, descricao: "Aumenta em +4 chance de descontos em armamentos, pousadas, alimentos, etc." }, { nome: "Arremedo (2)", custo: 2, descricao: "Capacidade de imitar qualquer som SIMPLES." }, { nome: "Destemor (1)", custo: 1, descricao: "Dificilmente √© assustado por algo." }, { nome: "Empatia (3)", custo: 3, descricao: "Sensibilidade extraordin√°ria em rela√ß√£o aos outras pessoas. √â um talento excelente para identificar impostores, possess√µes por espirito, etc." }, { nome: "Empatia com animais (1)", custo: 1, descricao: "Pode compreender as motiva√ß√µes dos animais." }, { nome: "Patrono (4)", custo: 4, descricao: "Possui um mentor/mestre/professor, at√© mesmo uma organiza√ß√£o/guilda que pode lhe oferecer ajuda." }, { nome: "Reconhecimento Social (2)", custo: 2, descricao: "√â membro de uma ra√ßa, classe, sexo ou grupo muito respeitado, temido ou venerado pela sociedade. Adiciona +2 pontos o teste em l√°bia, paquera e persuas√£o." }, { nome: "Riqueza (2)", custo: 2, descricao: "Inicia com 20 moedas de ouro." }, { nome: "Aptid√£o para magia (4)", custo: 4, descricao: "Adiciona 15% a mais de dano e gasta 15% a menos de magia para toda vez que usa a magia que voc√™ tem aptid√£o." }, { nome: "Combo F√≠sico (4)", custo: 4, descricao: "Essa vantagem lhe concede come√ßar sua locomo√ß√£o com 50km velocidade corrida, pulo de 3 metros de altura e 9 metros de dist√¢ncia.", restricao: "inicio" }, { nome: "Nadar (1)", custo: 1, descricao: "" }, { nome: "Escalar (2)", custo: 2, descricao: "" }, { nome: "Segunda l√≠ngua (1)", custo: 1, descricao: "Fala mais um idioma." }, { nome: "Paquerador (2)", custo: 2, descricao: "Adiciona +4 em teste para paquera e persuas√£o envolvendo flerte." }, { nome: "Senso de perigo (5)", custo: 5, descricao: "Sempre que houver algo grave para ocorrer o mestre do RPG pedir√° pra voc√™ jogar um dado para reagir." }, { nome: "Acrobata (3)", custo: 3, descricao: "Adiciona + fama ao lutar em p√∫blico." }, { nome: "Equil√≠brio Perfeito (3)", custo: 3, descricao: "Adiciona +8 em testes de equil√≠brio." }, { nome: "Tecnologia (2)", custo: 2, descricao: "Voc√™ √© engenhoso, pode inventar coisas, criar objetos improvisados." }, { nome: "Poder Oculto (7)", custo: 7, descricao: "Quando sua vida estiver em 10%, voc√™ ativa o poder oculto aumentando todos seus atributos em 50%. Mas a partir do momento em que sua vida sai dos 10%, os atributos voltam ao normal." }, { nome: "Sobreviv√™ncia em floresta (2)", custo: 2, descricao: "Tem facilidade para achar cavernas, criar assentamentos, barracas, achar comida e gravar caminhos no meio da floresta. Facilidade para achar √°gua, etc." }];
        const desvantagensData = [ { nome: "Fobia (+2)", ganho: 2, descricao: "Voc√™ tem um medo irracional de algo espec√≠fico." }, { nome: "M√° Fama (+2)", ganho: 2, descricao: "Voc√™ √© mal visto pela sociedade, dificultando intera√ß√µes sociais." }, { nome: "Alcoolismo (+2)", ganho: 2, descricao: "Voc√™ tem uma depend√™ncia de √°lcool que afeta suas decis√µes." }, { nome: "Altru√≠smo (+2)", ganho: 2, descricao: "Se sacrifica por outras pessoas e pouco se importa com fama ou riqueza." }, { nome: "Avareza (+2)", ganho: 2, descricao: "Preocupa√ß√£o permanente na conserva√ß√£o de riquezas." }, { nome: "Bullying (+3)", ganho: 3, descricao: "Gosta de ca√ßoar, agredir, denegrir, difamar e apontar defeitos tanto em amigos quanto inimigos." }, { nome: "Circunspe√ß√£o (+2)", ganho: 2, descricao: "N√£o entende piadas, entende tudo de forma literal e acredita que todos est√£o sempre falando s√©rio." }, { nome: "Compuls√µes (+3)", ganho: 3, descricao: "H√°bito ou v√≠cio que toma boa parte dos seus recursos e tempo." }, { nome: "Covardia (+2)", ganho: 2, descricao: "Tem extremo cuidado com seu bem-estar f√≠sico e dificuldade em assumir riscos." }, { nome: "Dependentes (+4)", ganho: 4, descricao: "Possui algu√©m que depende de voc√™ a todo momento (filhos, parentes, entes queridos, etc.)." }, { nome: "F√∫ria (+2)", ganho: 2, descricao: "Tend√™ncia a perder o controle e partir para um ataque fren√©tico, ativado por dano, insulto ou aleatoriamente." }, { nome: "Honestidade (+3)", ganho: 3, descricao: "N√£o consegue mentir ou omitir, sempre fala a verdade e desmascara mentiras." }, { nome: "Impulsividade (+2)", ganho: 2, descricao: "Sempre age sem pensar." }, { nome: "Lux√∫ria (+2)", ganho: 2, descricao: "Desejo incontrol√°vel por romance." }, { nome: "Magnetismo Sobrenatural (+2)", ganho: 2, descricao: "Coisas estranhas acontecem com seu personagem em um n√≠vel alarmante." }, { nome: "No Limite (+4)", ganho: 4, descricao: "Assume riscos extremamente irracionais diante de perigo mortal (ex.: enfrentar um boss sozinho)." }, { nome: "Teimosia (+1)", ganho: 1, descricao: "Quer sempre fazer as coisas do seu modo e n√£o segue planos que n√£o sejam seus." }, { nome: "Amn√©sia (+2)", ganho: 2, descricao: "Em certos momentos, n√£o consegue lembrar de coisas importantes." }];
        let racasData = [ { nome: "Humano (3)", custo: 3, descricao: "Os humanos s√£o vers√°teis, ambiciosos e mestres em se adaptar a qualquer situa√ß√£o. Suas vantagens refletem uma capacidade excepcional de prosperar em qualquer ambiente.", vantagens: ["Explorador Nato: Come√ßam com um cavalo de ra√ßa superior (mais r√°pido e resistente), equipamentos de montaria completos (selas, suprimentos para semanas) e um mapa detalhado de uma regi√£o inicial √† escolha, permitindo explorar √°reas distantes com facilidade e seguran√ßa.", "Mestre das Profiss√µes: Escolhem uma profiss√£o com benef√≠cios. Ferreiro Lend√°rio: Criam armas e armaduras com 5 pontos de qualidade automaticamente e podem forjar itens com propriedades √∫nicas (ex.: espada que brilha ao detectar inimigos). Costureiro Arcano: Produzem vestimentas leves ou armaduras com resist√™ncia a dois elementos (ex.: fogo e gelo) e b√¥nus de regenera√ß√£o passiva de energia ou vida. Arquiteto Vision√°rio: Constroem estruturas permanentes em metade do tempo e com o dobro da resist√™ncia, podendo criar bases estrat√©gicas com defesas embutidas (ex.: torres de vigia).", "Rede de Influ√™ncia: Iniciam com uma rede de contatos: um aliado influente (guildas, mercadores ou l√≠deres locais) oferecendo acesso a informa√ß√µes secretas ou at√© interven√ß√£o em conflitos.", "Determina√ß√£o Inabal√°vel: Uma vez por dia, podem ignorar completamente uma situa√ß√£o de desvantagem (ex.: exaust√£o, ferimento grave ou efeito m√°gico negativo), agindo como se estivessem em plena capacidade por um curto per√≠odo."] }, { nome: "Elfo (4)", custo: 4, descricao: "Os elfos s√£o s√°bios, m√°gicos e profundamente conectados ao mundo natural. Suas vantagens agora destacam sua supremacia m√°gica e harmonia com a natureza.", vantagens: ["Sabedoria Ancestral: Dominam uma √°rea de conhecimento (ex.: arcana, hist√≥ria, natureza) com maestria, podendo decifrar pergaminhos, ru√≠nas ou magias antigas automaticamente, e aprendem 1 l√≠nguas extra.", "Vis√£o √âlfica Suprema: Enxergam no escuro at√© 10 metros, detectam magias fracas em um raio de 20 metros e percebem inten√ß√µes hostis em seres vivos com um teste muito dif√≠cil, 19 ou +.", "Escudo M√°gico: Ganham resist√™ncia inata a um tipo de efeito magico hostil (n√£o apenas encantamentos), reduzindo o dano ou a dura√ß√£o desses efeitos em 50%, refletindo sua ess√™ncia m√°gica."] }, { nome: "An√£o (4)", custo: 4, descricao: "Os an√µes s√£o resilientes, habilidosos e ligados √† terra. Suas vantagens agora enfatizam sua supremacia em crafting e sobreviv√™ncia em condi√ß√µes extremas.", vantagens: ["Fortitude Indom√°vel: Trabalham por 3 dias sem descanso, ignorando efeitos de fadiga, e recuperam vida e energia ao dormir em ambientes rochosos ou subterr√¢neos duas vezes mais r√°pido.", "Artes√£o: Escolhem uma especializa√ß√£o com impacto massivo: Mestre Minerador: Identificam e extraem recursos raros (ex.: mithril) com o dobro da velocidade e podem abrir t√∫neis tempor√°rios em rochas s√≥lidas com ferramentas improvisadas. Forjador de Lendas: Produzem armas e armaduras com 10 pontos de qualidade e propriedades m√°gicas tempor√°rias (ex.: arma que causa dano elemental extra), al√©m de reparar itens quebrados durante um curto periodo de tempo (1 a 2 dias). Joalheiro Divino: Criam artefatos que armazenam magias moderadas (ex.: um anel que lan√ßa uma bola de fogo uma vez por dia) ou concedem b√¥nus Tempor√°rios a atributos (ex.: +1 for√ßa).", "Senhor das Profundezas: Nunca se perdem em ambientes subterr√¢neos, detectam armadilhas (naturais ou artificiais) automaticamente e podem sentir vibra√ß√µes no solo para prever emboscadas ou colapsos."] }, { nome: "Orc (3)", custo: 3, descricao: "Os orcs s√£o guerreiros ferozes e l√≠deres carism√°ticos pela for√ßa. Suas vantagens agora amplificam sua presen√ßa intimidadora e poder bruto.", vantagens: ["Lenda entre Guerreiros: Inspiram temor e respeito em qualquer cultura que valorize for√ßa, garantindo alian√ßas com fac√ß√µes marciais e acesso a miss√µes √©picas; inimigos menores fogem automaticamente em sua presen√ßa (teste dif√≠cil, 16 ou +).", "Resili√™ncia Brutal: Lutam sem penalidades mesmo com ferimentos graves e s√≥ caem quando atingem PV 0, al√©m de regenerarem ferimentos leves passivamente fora de combate.", "Dom√≠nio da Intimida√ß√£o: Podem for√ßar inimigos a se renderem ou recuarem com um grito poderoso uma vez por encontro, afetando grupos inteiros, e ganham b√¥nus massivos em negocia√ß√µes baseadas em for√ßa ou medo.", "F√∫ria Ancestral: Entram em um estado de f√∫ria duas vezes por dia, duplicando for√ßa e resist√™ncia por um curto per√≠odo."] }, { nome: "Meio Animal (Selvagem) (4)", custo: 4, descricao: "Os meio animais combinam instinto primal com ast√∫cia. Suas vantagens agora os tornam mestres da sobreviv√™ncia e predadores supremos.", vantagens: ["Sentidos Predat√≥rios: Pode escolher um sentido agu√ßado de acordo com sua parte animal. (vis√£o, olfato, audi√ß√£o), permitindo rastrear alvos a quil√¥metros, detectar inimigos invis√≠veis e evitar qualquer surpresa com um teste moderado, 12 ou +.", "Senhor dos Terrenos: Adaptam-se completamente a um ambiente (ex.: floresta, deserto, p√¢ntano), ignorando todos os efeitos negativos e ganhando b√¥nus de movimento e furtividade nesses locais. b√¥nus +1.", "Frenesi Instintivo: Uma vez por dia, canalizam seus instintos para ganhar velocidade sobrenatural (dobro de movimento), ataques adicionais e uma percep√ß√£o quase premonit√≥ria de perigos, tornando-os ca√ßadores ou fugitivos imbat√≠veis por um curto per√≠odo (10 min)."] }];
        const nivelData = [ { nivel: 0, xp: 0, pd: 25, ph: 8 }, { nivel: 1, xp: 10, pd: 31, ph: 9 }, { nivel: 2, xp: 30, pd: 37, ph: 10 }, { nivel: 3, xp: 60, pd: 43, ph: 11 }, { nivel: 4, xp: 100, pd: 49, ph: 12 }, { nivel: 5, xp: 150, pd: 55, ph: 13 }, { nivel: 6, xp: 210, pd: 61, ph: 14 }, { nivel: 7, xp: 280, pd: 67, ph: 15 }, { nivel: 8, xp: 360, pd: 73, ph: 16 }, { nivel: 9, xp: 450, pd: 79, ph: 17 }, { nivel: 10, xp: 550, pd: 85, ph: 18 }, { nivel: 11, xp: 670, pd: 91, ph: 19 }, { nivel: 12, xp: 810, pd: 97, ph: 20 }, { nivel: 13, xp: 970, pd: 103, ph: 21 }, { nivel: 14, xp: 1150, pd: 109, ph: 22 }, { nivel: 15, xp: 1350, pd: 115, ph: 23 }, { nivel: 16, xp: 1570, pd: 121, ph: 24 }, { nivel: 17, xp: 1810, pd: 127, ph: 25 }, { nivel: 18, xp: 2070, pd: 133, ph: 26 }, { nivel: 19, xp: 2350, pd: 139, ph: 27 }, { nivel: 20, xp: 2650, pd: 145, ph: 28 }, { nivel: 21, xp: 2980, pd: 148, ph: 29 }, { nivel: 22, xp: 3340, pd: 151, ph: 30 }, { nivel: 23, xp: 3730, pd: 154, ph: 31 }, { nivel: 24, xp: 4150, pd: 157, ph: 32 }, { nivel: 25, xp: 4600, pd: 160, ph: 33 }, { nivel: 26, xp: 5080, pd: 163, ph: 34 }, { nivel: 27, xp: 5590, pd: 166, ph: 35 }, { nivel: 28, xp: 6130, pd: 169, ph: 36 }, { nivel: 29, xp: 8000, pd: 219, ph: 37 }, { nivel: 30, xp: 10000, pd: 319, ph: 38 }];

        // Refer√™ncias DOM (mantidas e adicionadas)
        const nomePersonagemInput = document.getElementById("nome-personagem"),
            descricaoPersonagemInput = document.getElementById("descricao-personagem"),
            forcaInput = document.getElementById("forca"),
            destrezaInput = document.getElementById("destreza"),
            agilidadeInput = document.getElementById("agilidade"),
            inteligenciaInput = document.getElementById("inteligencia"),
            constituicaoInput = document.getElementById("constituicao"),
            ataqueSpan = document.getElementById("ataque"),
            ataqueMagicoSpan = document.getElementById("ataque-magico"),
            acertoSpan = document.getElementById("acerto"),
            esquivaSpan = document.getElementById("esquiva"),
            rdfSpan = document.getElementById("rdf"),
            rdmSpan = document.getElementById("rdm"),
            armaDireitaNomeInput = document.getElementById("arma-direita-nome"),
            armaDireitaAtaqueInput = document.getElementById("arma-direita-ataque"),
            armaDireitaAtaqueMagicoInput = document.getElementById("arma-direita-ataque-magico"),
            armaEsquerdaNomeInput = document.getElementById("arma-esquerda-nome"),
            armaEsquerdaAtaqueInput = document.getElementById("arma-esquerda-ataque"),
            armaEsquerdaAtaqueMagicoInput = document.getElementById("arma-esquerda-ataque-magico"),
            resetPontosButton = document.getElementById("reset-pontos"),
            recomecarButton = document.getElementById("recomecar"),
            bloquearFichaButton = document.getElementById("bloquear-ficha"),
            experienciaInput = document.getElementById("experiencia"),
            nivelSpan = document.getElementById("nivel"),
            pontosHabilidadeSpan = document.getElementById("pontos-habilidade"),
            pontosVantagemSpan = document.getElementById("pontos-vantagem"),
            velocidadeCorridaSpan = document.getElementById("velocidade-corrida"),
            alturaPuloSpan = document.getElementById("altura-pulo"),
            distanciaPuloSpan = document.getElementById("distancia-pulo"),
            nomePersonagemTitulo = document.getElementById("nome-personagem-titulo"),
            gameMasterMessage = document.getElementById("game-master-message"),
            vantagensListDisplay = document.getElementById("vantagens-list-display"),
            desvantagensListDisplay = document.getElementById("desvantagens-list-display"),
            inventarioSlots = document.getElementById("inventario-slots"),
            pesoTotalSpan = document.getElementById("peso-total"),
            diceContainer = document.getElementById("dice-container"),
            diceRoll = document.getElementById("dice-roll"),
            diceResult = document.getElementById("dice-result"),
            notification = document.getElementById("notification"),
            characterImageInput = document.getElementById("character-image-input"),
            characterImage = document.getElementById("character-image"),
            vantagensDesvantagensBtn = document.getElementById("vantagens-desvantagens-btn"),
            vantagensDesvantagensPanel = document.getElementById("vantagens-desvantagens-panel"),
            vantagensList = document.getElementById("vantagens-list"),
            desvantagensList = document.getElementById("desvantagens-list"),
            salvarVantagensBtn = document.getElementById("salvar-vantagens-btn"),
            fecharPaginaBtn = document.getElementById("fechar-pagina-btn"),
            fichaContainer = document.getElementById("ficha-container"),
            magiasList = document.getElementById("magias-list"),
            adicionarMagiaBtn = document.getElementById("adicionar-magia-btn"),
            anotacoesBtn = document.getElementById("anotacoes-btn"),
            anotacoesTextarea = document.getElementById("anotacoes-textarea"),
            racasBtn = document.getElementById("racas-btn"),
            classesBtn = document.getElementById("classes-btn"),
            racasPanel = document.getElementById("racas-panel"),
            classesPanel = document.getElementById("classes-panel"),
            fecharRacasBtn = document.getElementById("fechar-racas-btn"),
            fecharClassesBtn = document.getElementById("fechar-classes-btn"),
            classeNomeInput = document.getElementById("classe-nome"),
            classeDescricaoInput = document.getElementById("classe-descricao"),
            racaNomeSpan = document.getElementById("raca-nome"),
            racaDescricaoInput = document.getElementById("raca-descricao"),
            luaBtn = document.getElementById("lua-btn"),
            solBtn = document.getElementById("sol-btn"),
            salvarRacasBtn = document.getElementById("salvar-racas-btn"),
            racasList = document.getElementById("racas-list"),
            atributosInputs = [forcaInput, destrezaInput, agilidadeInput, inteligenciaInput, constituicaoInput],
            chatBtn = document.getElementById("chat-btn"),
            availableFichasDiv = document.getElementById("available-fichas"),
            conversationAreaDiv = document.getElementById("conversation-area"),
            mensagemInput = document.getElementById("mensagem-input"),
            enviarMensagemBtn = document.getElementById("enviar-mensagem-btn"), // Ref bot√£o enviar msg
            newMessageSound = document.getElementById("new-message-sound"),
            // NOVO: Refer√™ncias para modal de cores
            corFundoBtn = document.getElementById("cor-fundo-btn"),
            corFundoModal = document.getElementById("cor-fundo-modal"),
            coresExternasContainer = document.getElementById("cores-externas-container"),
            coresInternasContainer = document.getElementById("cores-internas-container"),
            salvarCoresFundoBtn = document.getElementById("salvar-cores-fundo-btn"),
            excluirCoresFundoBtn = document.getElementById("excluir-cores-fundo-btn"),
            cancelarCoresFundoBtn = document.getElementById("cancelar-cores-fundo-btn");

        // Vari√°veis de Status (mantidas)
        let nivel = 0,
            nivelAnterior = 0,
            pontosHabilidadeTotal = 25,
            pontosHabilidadeUsados = 0,
            experiencia = 0,
            vidaBase = 50;

        // --- FUN√á√ïES ---

        // NOVO: Aplica a cor de fundo (externa ou interna)
        function applyBackgroundColor(targetElement, colorData) {
            if (!colorData || !colorData.value) return; // N√£o faz nada se n√£o houver cor

            if (colorData.type === 'color' || colorData.type === 'gradient') {
                targetElement.style.background = colorData.value;
            } else if (colorData.type === 'image') {
                 // Para imagens, definimos background completo
                 targetElement.style.background = colorData.value;
            }

            // Atualiza vari√°veis CSS se estiver usando-as
             if (targetElement === document.body) {
                 document.documentElement.style.setProperty('--external-bg', colorData.value);
             } else if (targetElement === fichaContainer) {
                 document.documentElement.style.setProperty('--internal-bg', colorData.value);
             }
        }

        // NOVO: Encontra uma cor pelo valor na lista de cores
        function findColorByValue(value) {
            return backgroundColors.find(c => c.value === value);
        }

        // Fun√ß√£o para criar ficha matriz (adiciona cores padr√£o)
        function criarFichaMatriz() {
            const fichaId = "ficha-matriz";
            const fichaMatriz = {
                nomeFicha: "Matriz",
                nomePersonagem: "Personagem Matriz",
                descricaoPersonagem: "Ficha original do sistema",
                // ... outros campos mantidos ...
                forca: "0", destreza: "0", agilidade: "0", inteligencia: "0", constituicao: "0", experiencia: "0",
                armaDireitaNome: "", armaDireitaAtaque: "0", armaDireitaAtaqueMagico: "0",
                armaEsquerdaNome: "", armaEsquerdaAtaque: "0", armaEsquerdaAtaqueMagico: "0",
                vantagens: "", magiasHabilidades: Array(10).fill("").join("\n"), desvantagens: "",
                inventario: Array(10).fill({ item: "", peso: "0" }),
                velocidadeCorrida: "25", alturaPulo: "1", distanciaPulo: "3",
                isLocked: true, password: senhaMatriz, imagem: null, anotacoes: "",
                classeNome: "", classeDescricao: "", racaNome: "", racaDescricao: "", racaSelecionada: "",
                chatPassword: null,
                corFundoExterno: defaultExternalColor.value, // NOVO: Cor externa padr√£o
                corFundoInterno: defaultInternalColor.value  // NOVO: Cor interna padr√£o
            };
            database.ref("fichas/ficha-matriz").once("value", snapshot => {
                if (snapshot.exists()) {
                    // Se j√° existe, apenas carrega
                    currentFichaId = fichaId;
                    carregarFichas(); // Carrega todas as fichas para atualizar a lista
                } else {
                    // Se n√£o existe, cria
                    database.ref(`fichas/${fichaId}`).set(fichaMatriz).then(() => {
                        currentFichaId = fichaId;
                        carregarFichas(); // Carrega todas ap√≥s criar
                    });
                }
            });
        }

        // Carrega todas as fichas (mantido, chama criarFichaMatriz se necess√°rio)
        function carregarFichas() {
            database.ref("fichas").on("value", snapshot => {
                fichas = snapshot.val() || {};
                if (!fichas["ficha-matriz"]) {
                    criarFichaMatriz(); // Cria se n√£o existir
                } else {
                    // Se a ficha matriz existe, verifica se a ficha atual ainda existe
                    if (currentFichaId && !fichas[currentFichaId]) {
                        currentFichaId = "ficha-matriz"; // Volta para a matriz se a atual foi deletada
                    }
                    // Define a ficha atual se nenhuma estiver selecionada
                    if (!currentFichaId) {
                         currentFichaId = localStorage.getItem('lastFichaId') || "ficha-matriz";
                         // Verifica se a ficha salva ainda existe
                         if (!fichas[currentFichaId]) {
                              currentFichaId = "ficha-matriz";
                         }
                    }
                    atualizarAbasFichas();
                    carregarFicha(currentFichaId); // Carrega a ficha atual ou a matriz
                    atualizarListaFichasChat();
                    verificarNovasMensagens();
                }
            });
        }

        // Atualiza abas (mantido)
        function atualizarAbasFichas() {
            const sidebar = document.getElementById("fichas-sidebar");
            const addBtn = document.getElementById("add-ficha-btn");

            // Limpa abas existentes, exceto o bot√£o de adicionar
            const existingTabs = sidebar.querySelectorAll('.ficha-tab');
            existingTabs.forEach(tab => sidebar.removeChild(tab));

            // Adiciona as abas
            for (let fichaId in fichas) {
                 if (fichaId === "ficha-matriz") continue; // Pula a ficha matriz

                 const ficha = fichas[fichaId];
                 const tab = document.createElement("div");
                 tab.className = "ficha-tab";
                 const span = document.createElement("span");
                 span.textContent = ficha.nomeFicha || "Sem Nome";
                 tab.appendChild(span);
                 tab.dataset.fichaId = fichaId;

                 if (fichaId === currentFichaId) {
                      tab.classList.add("active");
                 }

                 tab.onclick = () => {
                     if (currentFichaId !== fichaId) { // Evita recarregar a mesma ficha
                          currentFichaId = fichaId;
                          localStorage.setItem('lastFichaId', fichaId); // Salva a √∫ltima ficha aberta
                          carregarFicha(fichaId);
                          atualizarAbasFichas(); // Re-renderiza para marcar a aba ativa
                          atualizarListaFichasChat();
                          verificarNovasMensagens();
                          // Limpa √°rea de conversa ao trocar de ficha
                          selectedChatUser = null;
                          selectedChatUserName = null;
                          conversationAreaDiv.innerHTML = '<div style="text-align: center; margin-top: 20px; color: var(--modal-text);">Selecione uma ficha para conversar.</div>';
                          mensagemInput.disabled = true;
                          enviarMensagemBtn.disabled = true;
                          if (chatListener) {
                             chatListener.off(); // Remove o listener antigo
                             chatListener = null;
                          }
                     }
                 };

                 sidebar.insertBefore(tab, addBtn); // Insere antes do bot√£o "+"
            }
        }


        // Abrir modal para nome da nova ficha (mantido)
        document.getElementById("add-ficha-btn").onclick = () => {
            document.getElementById("nome-ficha-modal").style.display = "flex";
            document.getElementById("nome-ficha-input").value = "";
            document.getElementById("nome-ficha-input").focus();
        };

        // Criar nova ficha (adiciona cores padr√£o)
        function criarNovaFicha() {
            const nomeFicha = document.getElementById("nome-ficha-input").value.trim();
            if (!nomeFicha) return alert("Por favor, d√™ um nome √† ficha!");

            const novaFichaId = database.ref("fichas").push().key;
            const novaFicha = {
                nomeFicha,
                // ... outros campos zerados/padr√£o ...
                nomePersonagem: "", descricaoPersonagem: "",
                forca: "0", destreza: "0", agilidade: "0", inteligencia: "0", constituicao: "0", experiencia: "0",
                armaDireitaNome: "", armaDireitaAtaque: "0", armaDireitaAtaqueMagico: "0",
                armaEsquerdaNome: "", armaEsquerdaAtaque: "0", armaEsquerdaAtaqueMagico: "0",
                vantagens: "", magiasHabilidades: Array(10).fill("").join("\n"), desvantagens: "",
                inventario: Array(10).fill({ item: "", peso: "0" }),
                velocidadeCorrida: "25", alturaPulo: "1", distanciaPulo: "3",
                isLocked: false, password: null, imagem: null, anotacoes: "",
                classeNome: "", classeDescricao: "", racaNome: "", racaDescricao: "", racaSelecionada: "",
                chatPassword: null,
                corFundoExterno: defaultExternalColor.value, // NOVO: Cor externa padr√£o
                corFundoInterno: defaultInternalColor.value  // NOVO: Cor interna padr√£o
            };
            database.ref(`fichas/${novaFichaId}`).set(novaFicha).then(() => {
                currentFichaId = novaFichaId;
                localStorage.setItem('lastFichaId', novaFichaId); // Salva como √∫ltima aberta
                // N√£o precisa chamar carregarFicha aqui, pois o listener 'on value' far√° isso
                fecharModal("nome-ficha-modal");
                // atualizarAbasFichas(); // O listener j√° faz isso
                // atualizarListaFichasChat(); // O listener j√° faz isso
            }).catch(error => console.error("Erro ao criar nova ficha:", error));
        }

        // Fechar modal gen√©rico (mantido)
        function fecharModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = "none";
            }
        }

        // Carregar dados da ficha (modificado para carregar e aplicar cores)
        function carregarFicha(fichaId) {
             if (!fichas || !fichas[fichaId]) {
                  console.error(`Ficha com ID ${fichaId} n√£o encontrada.`);
                  // Tenta voltar para a matriz ou a √∫ltima v√°lida
                  currentFichaId = localStorage.getItem('lastFichaId') || "ficha-matriz";
                  if (!fichas[currentFichaId]) currentFichaId = "ficha-matriz"; // √öltimo recurso
                  if (currentFichaId !== fichaId) { // Evita loop infinito
                       carregarFicha(currentFichaId);
                  }
                  return;
             }
             const ficha = fichas[fichaId];

             // Carrega cores salvas ou padr√£o
             currentExternalColor = findColorByValue(ficha.corFundoExterno) || defaultExternalColor;
             currentInternalColor = findColorByValue(ficha.corFundoInterno) || defaultInternalColor;

             // Aplica cores
             applyBackgroundColor(document.body, currentExternalColor);
             applyBackgroundColor(fichaContainer, currentInternalColor);

             // Atualiza modo do body (claro/escuro) baseado na cor externa para consist√™ncia de texto/borda
             // Se a cor externa for escura, aplica dark-mode, sen√£o remove.
             // (Isso √© uma heur√≠stica, pode precisar de ajuste fino)
             const isDarkBackground = ['#121212', '#00008B', '#006400', '#800000', '#1e1e1e', '#800080'].includes(currentExternalColor.value);
             if (isDarkBackground) {
                 document.body.classList.add('dark-mode');
             } else {
                 document.body.classList.remove('dark-mode');
             }


             // Carrega outros dados da ficha (mantido)
             nomePersonagemInput.value = ficha.nomePersonagem || "";
             descricaoPersonagemInput.value = ficha.descricaoPersonagem || "";
             forcaInput.value = ficha.forca || "0";
             destrezaInput.value = ficha.destreza || "0";
             agilidadeInput.value = ficha.agilidade || "0";
             inteligenciaInput.value = ficha.inteligencia || "0";
             constituicaoInput.value = ficha.constituicao || "0";
             experienciaInput.value = ficha.experiencia || "0";
             armaDireitaNomeInput.value = ficha.armaDireitaNome || "";
             armaDireitaAtaqueInput.value = ficha.armaDireitaAtaque || "0";
             armaDireitaAtaqueMagicoInput.value = ficha.armaDireitaAtaqueMagico || "0";
             armaEsquerdaNomeInput.value = ficha.armaEsquerdaNome || "";
             armaEsquerdaAtaqueInput.value = ficha.armaEsquerdaAtaque || "0";
             armaEsquerdaAtaqueMagicoInput.value = ficha.armaEsquerdaAtaqueMagico || "0";

             velocidadeCorridaSpan.textContent = ficha.velocidadeCorrida || "25";
             alturaPuloSpan.textContent = ficha.alturaPulo || "1";
             distanciaPuloSpan.textContent = ficha.distanciaPulo || "3";

             isFichaLocked = ficha.isLocked || false;
             fichaPassword = ficha.password || null;
             isFichaUnlocked = false; // Sempre come√ßa bloqueada se tiver senha

             vantagensSelecionadas = ficha.vantagens ? ficha.vantagens.split("\n").filter(v => v.trim()) : [];
             desvantagensSelecionadas = ficha.desvantagens ? ficha.desvantagens.split("\n").filter(d => d.trim()) : [];
             racaSelecionada = ficha.racaSelecionada || null; // Usar null se n√£o houver

             // Atualiza nome e descri√ß√£o da ra√ßa na UI
             if (racaSelecionada) {
                 const racaData = racasData.find(r => r.nome === racaSelecionada);
                 racaNomeSpan.textContent = racaSelecionada.split(" (")[0]; // Mostra s√≥ o nome
                 racaDescricaoInput.value = racaData ? racaData.vantagens.join("\n\n") : "";
             } else {
                 racaNomeSpan.textContent = "Clique para selecionar/editar"; // Texto padr√£o
                 racaDescricaoInput.value = "";
             }


             // Limpa e preenche listas de vantagens/desvantagens na UI
             vantagensListDisplay.innerHTML = "";
             desvantagensListDisplay.innerHTML = "";
             vantagensSelecionadas.forEach(v => {
                 const div = document.createElement("div");
                 div.textContent = v;
                 div.className = "list-item";
                 div.onclick = () => removerVantagem(v);
                 vantagensListDisplay.appendChild(div);
             });
             desvantagensSelecionadas.forEach(d => {
                 const div = document.createElement("div");
                 div.textContent = d;
                 div.className = "list-item";
                 div.onclick = () => removerDesvantagem(d);
                 desvantagensListDisplay.appendChild(div);
             });

             // Carrega invent√°rio
             const inventario = Array.isArray(ficha.inventario) ? ficha.inventario : Array(10).fill({ item: "", peso: "0" });
             const slots = inventarioSlots.querySelectorAll(".inventory-slot");
             // Garante que temos o n√∫mero certo de slots no HTML (caso tenha mudado)
             while (slots.length < 10) {
                // Clona o √∫ltimo slot e adiciona se faltar (raro, mas defensivo)
                const lastSlot = slots[slots.length - 1];
                if (lastSlot) {
                    const newSlot = lastSlot.cloneNode(true);
                    newSlot.querySelector('.inventory-item').value = '';
                    newSlot.querySelector('.inventory-item').placeholder = `Item ${slots.length + 1}`;
                    newSlot.querySelector('.inventory-weight').value = '0';
                    inventarioSlots.appendChild(newSlot);
                    slots = inventarioSlots.querySelectorAll(".inventory-slot"); // Re-seleciona
                } else break; // Se n√£o houver nenhum slot, sai
             }
             slots.forEach((slot, i) => {
                 const itemInput = slot.querySelector(".inventory-item");
                 const weightInput = slot.querySelector(".inventory-weight");
                 itemInput.value = inventario[i]?.item || "";
                 weightInput.value = inventario[i]?.peso || "0";
                 itemInput.placeholder = `Item ${i+1}`; // Garante placeholder correto
             });
             calcularPesoTotal();

             // Carrega Magias/Habilidades
             const magias = ficha.magiasHabilidades ? ficha.magiasHabilidades.split("\n") : [];
             magiasList.innerHTML = ""; // Limpa lista
             const numMagiasBase = 10; // N√∫mero inicial de slots
             const totalSlots = Math.max(numMagiasBase, magias.length);
             for(let i = 0; i < totalSlots; i++) {
                  adicionarInputMagia(magias[i] || ""); // Adiciona input com valor ou vazio
             }

             // Carrega anota√ß√µes, classe, imagem, etc.
             anotacoesTextarea.value = ficha.anotacoes || "";
             classeNomeInput.value = ficha.classeNome || "";
             classeDescricaoInput.value = ficha.classeDescricao || "";

             if (ficha.imagem) {
                 characterImage.src = ficha.imagem;
                 characterImage.style.display = "block";
             } else {
                 characterImage.src = ""; // Limpa src
                 characterImage.style.display = "none";
             }

             // Atualiza UI e c√°lculos
             nomePersonagemTitulo.textContent = ficha.nomePersonagem || "Ficha de Personagem"; // Atualiza t√≠tulo H1
             atualizarBotaoBloquear();
             // N√£o precisa chamar atualizar paineis de Vantagens/Ra√ßas aqui, s√≥ ao abrir
             experiencia = parseInt(experienciaInput.value) || 0;
             atualizarNivel(); // Calcula n√≠vel, PH, PD e chama calcularAtributos
             // Os valores de vida/magia/vigor atuais precisam ser carregados do BD se forem persistidos
             // Por enquanto, resetamos ao carregar a ficha (pode ser ajustado depois se necess√°rio)
             vidaAtual = vidaTotal;
             magiaAtual = magiaTotal;
             vigorAtual = vigorTotal;
             document.getElementById("vida-atual").textContent = vidaAtual;
             document.getElementById("magia-atual").textContent = magiaAtual;
             document.getElementById("vigor-atual").textContent = vigorAtual.toFixed(1);
             // pontosVantagemSpan j√° √© atualizado em atualizarNivel -> getPontosVantagem

             // Limpa valores pr√©vios para checagem de altera√ß√£o
             previousValues.clear();
             document.querySelectorAll('input[type="text"], input[type="number"], textarea').forEach(input => previousValues.set(input, input.value));

             // Chat
             chatPassword = ficha.chatPassword;
             atualizarEstadoChatBotao();

             console.log(`Ficha "${ficha.nomeFicha}" (${fichaId}) carregada.`);
        }


        // Atualizar bot√£o de bloquear (mantido)
        function atualizarBotaoBloquear() {
            if (isFichaLocked) {
                bloquearFichaButton.textContent = "Desbloquear Ficha";
                bloquearFichaButton.classList.remove("botao-bloquear");
                bloquearFichaButton.classList.add("botao-desbloquear");
            } else {
                bloquearFichaButton.textContent = "Bloquear Ficha";
                bloquearFichaButton.classList.remove("botao-desbloquear");
                bloquearFichaButton.classList.add("botao-bloquear");
            }
            // Desabilita/Habilita inputs baseado no estado de bloqueio (exceto se desbloqueado temporariamente)
            const inputsToLock = document.querySelectorAll(
                 '#ficha-content input[type="text"], ' +
                 '#ficha-content input[type="number"]:not(#experiencia), ' + // Permite alterar XP mesmo bloqueado
                 '#ficha-content textarea, ' +
                 '#ficha-content .inventory-item, #ficha-content .inventory-weight, ' +
                 '#ficha-content .magia-nome, #adicionar-magia-btn, ' +
                 '#classe-nome, #classe-descricao, #raca-nome'
            );
            const isEffectivelyLocked = isFichaLocked && !isFichaUnlocked;
            inputsToLock.forEach(input => {
                input.readOnly = isEffectivelyLocked;
                input.style.cursor = isEffectivelyLocked ? 'not-allowed' : '';
            });
            // Bot√µes que devem ser bloqueados
             const buttonsToLock = [resetPontosButton, recomecarButton, vantagensDesvantagensBtn, racasBtn, document.getElementById('excluir-ficha')];
             buttonsToLock.forEach(btn => {
                  if (btn) { // Verifica se o bot√£o existe
                       btn.disabled = isEffectivelyLocked;
                       btn.style.opacity = isEffectivelyLocked ? 0.6 : 1;
                       btn.style.cursor = isEffectivelyLocked ? 'not-allowed' : 'pointer';
                  }
             });
             // Permite sempre editar XP e rolar dados
             experienciaInput.readOnly = false;
             experienciaInput.style.cursor = '';
             diceRoll.style.cursor = 'pointer';
        }

        // Salvar dados (modificado para incluir cores)
        function salvarDados(showNotificationFlag = true) {
             if (!currentFichaId || !fichas[currentFichaId]) return; // N√£o salva se n√£o houver ficha carregada
             if (isFichaLocked && !isFichaUnlocked) {
                 console.warn("Tentativa de salvar dados com ficha bloqueada.");
                 // N√£o abre modal de senha aqui para evitar popups excessivos
                 return;
             }

             // Coleta dados do invent√°rio e magias
             const inventario = Array.from(inventarioSlots.querySelectorAll(".inventory-slot")).map(slot => ({
                 item: slot.querySelector(".inventory-item").value.trim(),
                 peso: slot.querySelector(".inventory-weight").value || "0"
             }));
             const magias = Array.from(magiasList.querySelectorAll(".magia-nome")).map(input => input.value.trim());

             // Monta objeto de dados para salvar
             const dados = {
                 nomePersonagem: nomePersonagemInput.value.trim(),
                 descricaoPersonagem: descricaoPersonagemInput.value.trim(),
                 forca: forcaInput.value || "0",
                 destreza: destrezaInput.value || "0",
                 agilidade: agilidadeInput.value || "0",
                 inteligencia: inteligenciaInput.value || "0",
                 constituicao: constituicaoInput.value || "0",
                 experiencia: experienciaInput.value || "0",
                 armaDireitaNome: armaDireitaNomeInput.value.trim(),
                 armaDireitaAtaque: armaDireitaAtaqueInput.value || "0",
                 armaDireitaAtaqueMagico: armaDireitaAtaqueMagicoInput.value || "0",
                 armaEsquerdaNome: armaEsquerdaNomeInput.value.trim(),
                 armaEsquerdaAtaque: armaEsquerdaAtaqueInput.value || "0",
                 armaEsquerdaAtaqueMagico: armaEsquerdaAtaqueMagicoInput.value || "0",
                 vantagens: vantagensSelecionadas.join("\n"),
                 desvantagens: desvantagensSelecionadas.join("\n"),
                 racaSelecionada: racaSelecionada, // J√° atualizado
                 inventario: inventario,
                 magiasHabilidades: magias.join("\n"),
                 velocidadeCorrida: velocidadeCorridaSpan.textContent,
                 alturaPulo: alturaPuloSpan.textContent,
                 distanciaPulo: distanciaPuloSpan.textContent,
                 isLocked: isFichaLocked,
                 password: fichaPassword,
                 imagem: characterImage.style.display === 'block' ? characterImage.src : null,
                 anotacoes: anotacoesTextarea.value.trim(),
                 classeNome: classeNomeInput.value.trim(),
                 classeDescricao: classeDescricaoInput.value.trim(),
                 // racaNome e racaDescricao s√£o derivados de racaSelecionada, n√£o precisam salvar separados
                 chatPassword: chatPassword,
                 // NOVO: Salva as cores atuais
                 corFundoExterno: currentExternalColor?.value || defaultExternalColor.value,
                 corFundoInterno: currentInternalColor?.value || defaultInternalColor.value
             };

             // Atualiza no Firebase
             database.ref(`fichas/${currentFichaId}`).update(dados).then(() => {
                 if (showNotificationFlag) {
                      showNotification("Salvo!", "save-success");
                 }
                 // Atualiza valores pr√©vios ap√≥s salvar com sucesso
                 previousValues.clear();
                 document.querySelectorAll('input[type="text"], input[type="number"], textarea').forEach(input => previousValues.set(input, input.value));
                 console.log(`Dados da ficha ${currentFichaId} salvos.`);
             }).catch(error => {
                  console.error("Erro ao salvar dados:", error);
                  showNotification("Erro ao salvar!", "critical-failure");
             });
        }


        // Calcular N√≠vel (mantido)
        function calcularNivel(exp) {
            return nivelData.findLast(data => exp >= data.xp)?.nivel || 0;
        }

        // Atualizar N√≠vel (mantido, chama calcularAtributos)
        function atualizarNivel() {
            nivelAnterior = nivel;
            nivel = calcularNivel(experiencia);
            nivelSpan.textContent = nivel;

            const nivelInfo = nivelData.find(data => data.nivel === nivel) || nivelData[0];
            pontosHabilidadeTotal = nivelInfo.pd;

            // Atualiza PH e PD restantes na UI
            pontosHabilidadeSpan.textContent = pontosHabilidadeTotal - pontosHabilidadeUsados;
            pontosVantagemSpan.textContent = getPontosVantagem(); // Recalcula PH total

            // Efeitos visuais de subida de n√≠vel
            if (nivel > nivelAnterior) {
                nivelSpan.classList.add("aura-azul");
                setTimeout(() => nivelSpan.classList.remove("aura-azul"), 20000); // Dura√ß√£o da anima√ß√£o
                showNotification(`N√≠vel ${nivel}!`, "critical-success"); // Notifica subida de n√≠vel
            }

            // Mensagem de Game Master
            gameMasterMessage.style.display = nivel >= 30 ? "block" : "none";
            fichaContainer.classList.toggle("aura-azul", nivel >= 30);

            // Recalcula atributos que dependem do n√≠vel (como vida)
            calcularAtributos();
        }


        // Calcular Pontos de Vantagem restantes (mantido)
        function getPontosVantagem() {
             const nivelInfo = nivelData.find(data => data.nivel === nivel) || nivelData[0];
             let phBase = nivelInfo.ph;
             let phGastos = 0;

             // Soma custos das vantagens
             vantagensSelecionadas.forEach(vNome => {
                 const vantagem = vantagensData.find(d => d.nome === vNome);
                 if (vantagem) phGastos += vantagem.custo;
             });

             // Subtrai ganhos das desvantagens
             desvantagensSelecionadas.forEach(dNome => {
                 const desvantagem = desvantagensData.find(desv => desv.nome === dNome);
                 if (desvantagem) phGastos -= desvantagem.ganho; // Subtrai o ganho (inverso do custo)
             });

             // Soma custo da ra√ßa
             if (racaSelecionada) {
                 const raca = racasData.find(r => r.nome === racaSelecionada);
                 if (raca) phGastos += raca.custo;
             }

             return phBase - phGastos;
         }


        // Calcular Pontos de Vantagem tempor√°rios (para painel) (mantido)
         function calcularPontosVantagemTemp() {
             const nivelInfo = nivelData.find(data => data.nivel === nivel) || nivelData[0];
             let phBase = nivelInfo.ph;
             let phGastosTemp = 0;

             tempVantagensSelecionadas.forEach(vNome => {
                 const vantagem = vantagensData.find(d => d.nome === vNome);
                 if (vantagem) phGastosTemp += vantagem.custo;
             });

             tempDesvantagensSelecionadas.forEach(dNome => {
                 const desvantagem = desvantagensData.find(desv => desv.nome === dNome);
                 if (desvantagem) phGastosTemp -= desvantagem.ganho;
             });

             // Considera a ra√ßa tempor√°ria SE ela for diferente da ra√ßa j√° salva
             // Se j√° tem ra√ßa salva, o custo dela J√Å EST√Å nos PH base (impl√≠cito)
             const racaAtualCusto = racaSelecionada ? (racasData.find(r => r.nome === racaSelecionada)?.custo || 0) : 0;
             const racaTempCusto = tempRacaSelecionada ? (racasData.find(r => r.nome === tempRacaSelecionada)?.custo || 0) : 0;

             // Adiciona a diferen√ßa de custo da ra√ßa
             phGastosTemp += (racaTempCusto - racaAtualCusto);


             // Os PH base j√° consideram os itens salvos. Apenas aplicamos os gastos/ganhos tempor√°rios.
             let phAtual = getPontosVantagem(); // Pega os pontos j√° considerando o salvo

             // Calcula a diferen√ßa entre os gastos salvos e os tempor√°rios
             let phGastosSalvos = 0;
             vantagensSelecionadas.forEach(vNome => { phGastosSalvos += (vantagensData.find(d => d.nome === vNome)?.custo || 0); });
             desvantagensSelecionadas.forEach(dNome => { phGastosSalvos -= (desvantagensData.find(desv => desv.nome === dNome)?.ganho || 0); });

             let phGastosTempReal = 0;
             tempVantagensSelecionadas.forEach(vNome => { phGastosTempReal += (vantagensData.find(d => d.nome === vNome)?.custo || 0); });
             tempDesvantagensSelecionadas.forEach(dNome => { phGastosTempReal -= (desvantagensData.find(desv => desv.nome === dNome)?.ganho || 0); });

             // A diferen√ßa √© o que foi adicionado/removido temporariamente
             let diffGastos = phGastosTempReal - phGastosSalvos;


             // Adiciona a diferen√ßa de custo da ra√ßa (se mudou)
             diffGastos += (racaTempCusto - racaAtualCusto);


             return phAtual - diffGastos; // Subtrai a diferen√ßa dos pontos atuais
         }

        // Fun√ß√µes de aumentar/diminuir Vida, Magia, Vigor (mantidas, chamam salvarDados)
        function aumentarVida() { if (vidaAtual < vidaTotal) { vidaAtual++; document.getElementById("vida-atual").textContent = vidaAtual; /* salvarDados(false); */ } } // Salvar pode ser opcional aqui
        function diminuirVida() { if (vidaAtual > 0) { vidaAtual--; document.getElementById("vida-atual").textContent = vidaAtual; /* salvarDados(false); */ } }
        function aumentarMagia() { if (magiaAtual < magiaTotal) { magiaAtual++; document.getElementById("magia-atual").textContent = magiaAtual; /* salvarDados(false); */ } }
        function diminuirMagia() { if (magiaAtual > 0) { magiaAtual--; document.getElementById("magia-atual").textContent = magiaAtual; /* salvarDados(false); */ } }
        function aumentarVigor() { if (vigorAtual < vigorTotal) { vigorAtual = Math.min(vigorAtual + 0.1, vigorTotal); document.getElementById("vigor-atual").textContent = vigorAtual.toFixed(1); /* salvarDados(false); */ } }
        function diminuirVigor() { if (vigorAtual > 0) { vigorAtual = Math.max(vigorAtual - 0.1, 0); document.getElementById("vigor-atual").textContent = vigorAtual.toFixed(1); /* salvarDados(false); */ } }

        // Calcular Atributos Derivados (mantido)
        function calcularAtributos() {
             const forca = parseInt(forcaInput.value) || 0,
                   destreza = parseInt(destrezaInput.value) || 0,
                   agilidade = parseInt(agilidadeInput.value) || 0,
                   inteligencia = parseInt(inteligenciaInput.value) || 0,
                   constituicao = parseInt(constituicaoInput.value) || 0;

             // Calcula pontos usados e verifica limite
             let totalPontosUsados = forca + destreza + agilidade + inteligencia + constituicao;
             pontosHabilidadeUsados = totalPontosUsados;
             pontosHabilidadeSpan.textContent = pontosHabilidadeTotal - pontosHabilidadeUsados;

              // Verifica se excedeu os pontos APENAS se o total for maior que o permitido
              // Isso permite reduzir valores mesmo que j√° esteja acima do limite (corrigindo)
             if (totalPontosUsados > pontosHabilidadeTotal) {
                  // Tenta reverter o √∫ltimo input alterado
                  for (const input of atributosInputs) {
                       if (input.value !== (previousValues.get(input) || "0")) {
                            input.value = previousValues.get(input) || "0";
                            // Recalcula pontos usados ap√≥s reverter
                            pontosHabilidadeUsados = Array.from(atributosInputs).reduce((sum, inp) => sum + (parseInt(inp.value) || 0), 0);
                            pontosHabilidadeSpan.textContent = pontosHabilidadeTotal - pontosHabilidadeUsados;
                            alert("Pontos de habilidade (PD) insuficientes!");
                            break; // Reverte apenas o primeiro que mudou
                       }
                  }
                  // Se mesmo assim estourou (raro), for√ßa um rec√°lculo geral
                  calcularAtributos();
                  return; // Interrompe aqui para evitar salvar estado inv√°lido
             }


             // C√°lculos dos atributos derivados
             let ataqueBase = forca + Math.floor(destreza / 5);
             let acerto = Math.floor(destreza / 3) + Math.floor(agilidade / 10);
             let esquiva = Math.floor(agilidade / 3);
             let rdf = Math.floor(forca / 5);
             let rdm = Math.floor(inteligencia / 5);
             let ataqueMagicoBase = inteligencia;

             // B√¥nus de Vantagens (Exemplo: Maestria)
             let bonusAtaqueCurta = 0, bonusAcertoCurta = 0, bonusAtaquePesada = 0, bonusAcertoLongo = 0;
             if (vantagensSelecionadas.includes("Maestria com Armas curtas (2)")) { bonusAtaqueCurta = 1; bonusAcertoCurta = 1; }
             if (vantagensSelecionadas.includes("Maestria com armas pesadas (2)")) { bonusAtaquePesada = 2; }
             if (vantagensSelecionadas.includes("Maestria com armas de longo alcance (2)")) { bonusAcertoLongo = 2; }
             // Aplicar b√¥nus baseado no tipo de arma equipada (simplificado aqui)
             // Idealmente, teria um campo para tipo de arma
             let ataqueFinal = ataqueBase + (parseInt(armaDireitaAtaqueInput.value) || 0) + (parseInt(armaEsquerdaAtaqueInput.value) || 0) /* + bonusAtaque apropriado */;
             let ataqueMagicoFinal = ataqueMagicoBase + (parseInt(armaDireitaAtaqueMagicoInput.value) || 0) + (parseInt(armaEsquerdaAtaqueMagicoInput.value) || 0);
             let acertoFinal = acerto /* + bonusAcerto apropriado */;


             // Vida, Magia, Vigor
             vidaBase = 50 + (constituicao * (3 + Math.floor(forca / 10))) + 10 * nivel;
             let magiaBase = 20 + 3 * constituicao;
             if (inteligencia >= 10) magiaBase += constituicao * Math.floor(inteligencia / 10);
             let vigorBase = 10 + 0.4 * constituicao;

             vidaTotal = Math.ceil(vidaBase);
             magiaTotal = Math.ceil(magiaBase);
             vigorTotal = parseFloat(vigorBase.toFixed(1));

             // Locomo√ß√£o
             const velocidadeBase = 25 + Math.floor(agilidade / 3) * 3;
             const alturaPuloBase = 1 + Math.floor(forca / 10);
             const distanciaPuloBase = 3 + 3 * Math.min(Math.floor(forca / 5), Math.floor(agilidade / 5));

             // B√¥nus de Vantagem (Combo F√≠sico) - Aplicado apenas se a vantagem estiver selecionada
             let bonusVelocidade = 0, bonusAlturaPulo = 0, bonusDistanciaPulo = 0;
             if (vantagensSelecionadas.includes("Combo F√≠sico (4)")) {
                 bonusVelocidade = 25; // 50km/h total (25 base + 25 bonus)
                 bonusAlturaPulo = 2; // 3m total (1 base + 2 bonus)
                 bonusDistanciaPulo = 6; // 9m total (3 base + 6 bonus)
             }

             velocidadeCorridaSpan.textContent = velocidadeBase + bonusVelocidade;
             alturaPuloSpan.textContent = alturaPuloBase + bonusAlturaPulo;
             distanciaPuloSpan.textContent = distanciaPuloBase + bonusDistanciaPulo;


             // Atualiza a UI
             ataqueSpan.textContent = ataqueFinal;
             ataqueMagicoSpan.textContent = ataqueMagicoFinal;
             acertoSpan.textContent = acertoFinal;
             esquivaSpan.textContent = esquiva;
             rdfSpan.textContent = rdf;
             rdmSpan.textContent = rdm;

             document.getElementById("vida-total").textContent = vidaTotal;
             document.getElementById("magia-total").textContent = magiaTotal;
             document.getElementById("vigor-total").textContent = vigorTotal.toFixed(1);

             // Ajusta valores atuais se o total diminuiu
             vidaAtual = Math.min(vidaAtual === undefined ? vidaTotal : vidaAtual, vidaTotal);
             magiaAtual = Math.min(magiaAtual === undefined ? magiaTotal : magiaAtual, magiaTotal);
             vigorAtual = Math.min(vigorAtual === undefined ? vigorTotal : vigorAtual, vigorTotal);
             document.getElementById("vida-atual").textContent = vidaAtual;
             document.getElementById("magia-atual").textContent = magiaAtual;
             document.getElementById("vigor-atual").textContent = vigorAtual.toFixed(1);

             // Regenera√ß√£o
             const regeneracaoVida = (0.2 * constituicao).toFixed(1);
             const regeneracaoMagia = (0.8 * constituicao).toFixed(1);
             const regeneracaoVigor = (0.4 * constituicao).toFixed(1);
             document.getElementById("regeneracao-vida").textContent = regeneracaoVida;
             document.getElementById("regeneracao-magia").textContent = regeneracaoMagia;
             document.getElementById("regeneracao-vigor").textContent = regeneracaoVigor;

             // Destaque do maior atributo (mantido)
             const atributos = [ { span: ataqueSpan, valor: ataqueFinal }, { span: ataqueMagicoSpan, valor: ataqueMagicoFinal }, { span: acertoSpan, valor: acertoFinal }, { span: esquivaSpan, valor: esquiva }, { span: rdfSpan, valor: rdf }, { span: rdmSpan, valor: rdm }];
             atributos.forEach(a => a.span.classList.remove("atributo-fogo"));
             if (atributos.length > 0) {
                 const maxAtributo = atributos.reduce((prev, curr) => (prev.valor || 0) > (curr.valor || 0) ? prev : curr);
                 if (maxAtributo.valor > 0) maxAtributo.span.classList.add("atributo-fogo");
             }
         }


        // Resetar Pontos (mantido, requer senha GM)
        function resetarPontos() {
            if (isFichaLocked && !isFichaUnlocked) return abrirModalSenha(resetPontosButton);
            if (confirm("Tem certeza que deseja reiniciar os pontos de habilidade (PD)? Voc√™ precisar√° da permiss√£o do GM.")) {
                abrirModalSenhaGM(() => {
                    atributosInputs.forEach(input => input.value = 0);
                    pontosHabilidadeUsados = 0;
                    // pontosHabilidadeSpan j√° √© atualizado por calcularAtributos
                    calcularAtributos(); // Recalcula tudo, incluindo PD restantes
                    salvarDados();
                    showNotification("Pontos de habilidade reiniciados!", "save-success");
                });
            }
        }

        // Recome√ßar Ficha (mantido, n√£o requer senha GM, mas confirma√ß√£o)
        function recomecarFicha() {
             // N√£o precisa verificar bloqueio aqui, pois afeta apenas a ficha atual do usu√°rio
             if (confirm("Tem certeza que deseja recome√ßar esta ficha? Todos os dados (exceto nome da ficha, senha de bloqueio e senha do chat) ser√£o PERDIDOS e redefinidos para o padr√£o.")) {
                 // Guarda dados a preservar
                 const nomeFichaPreservado = fichas[currentFichaId]?.nomeFicha || "";
                 const isLockedPreservado = isFichaLocked;
                 const passwordPreservado = fichaPassword;
                 const chatPasswordPreservado = chatPassword;

                 // Pega a estrutura de uma ficha nova (exceto nome e senhas)
                 const fichaReset = {
                     nomeFicha: nomeFichaPreservado, // Preserva nome
                     nomePersonagem: "", descricaoPersonagem: "",
                     forca: "0", destreza: "0", agilidade: "0", inteligencia: "0", constituicao: "0", experiencia: "0",
                     armaDireitaNome: "", armaDireitaAtaque: "0", armaDireitaAtaqueMagico: "0",
                     armaEsquerdaNome: "", armaEsquerdaAtaque: "0", armaEsquerdaAtaqueMagico: "0",
                     vantagens: "", desvantagens: "", racaSelecionada: null,
                     inventario: Array(10).fill({ item: "", peso: "0" }),
                     magiasHabilidades: Array(10).fill("").join("\n"),
                     velocidadeCorrida: "25", alturaPulo: "1", distanciaPulo: "3",
                     isLocked: isLockedPreservado, // Preserva estado de bloqueio
                     password: passwordPreservado, // Preserva senha de bloqueio
                     imagem: null, anotacoes: "",
                     classeNome: "", classeDescricao: "",
                     chatPassword: chatPasswordPreservado, // Preserva senha do chat
                     corFundoExterno: defaultExternalColor.value, // Reseta cores
                     corFundoInterno: defaultInternalColor.value
                 };

                 // Atualiza o objeto local 'fichas' e salva no Firebase
                 fichas[currentFichaId] = fichaReset;
                 database.ref(`fichas/${currentFichaId}`).set(fichaReset).then(() => {
                     // Recarrega a ficha com os dados resetados
                     carregarFicha(currentFichaId);
                     showNotification("Ficha recome√ßada!", "save-success");
                 }).catch(error => {
                     console.error("Erro ao recome√ßar ficha:", error);
                     showNotification("Erro ao recome√ßar!", "critical-failure");
                 });
             }
         }

        // Abrir modal senha GM gen√©rico
        function abrirModalSenhaGM(callbackOnConfirm) {
             const modal = document.getElementById("senha-gm-modal");
             const input = document.getElementById("senha-gm-input");
             const confirmBtn = document.getElementById("confirmar-senha-gm-btn");

             input.value = "";
             modal.style.display = "flex";
             input.focus();

             // Remove listener antigo e adiciona novo
             const newConfirmBtn = confirmBtn.cloneNode(true);
             confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);

             newConfirmBtn.onclick = () => {
                 if (input.value === senhaMatriz) {
                     fecharModal("senha-gm-modal");
                     if (callbackOnConfirm && typeof callbackOnConfirm === 'function') {
                         callbackOnConfirm(); // Executa a a√ß√£o desejada
                     }
                 } else {
                     alert("Senha do GM incorreta!");
                     // N√£o fecha o modal para tentar de novo
                 }
             };
        }


        // Bloquear/Desbloquear Ficha (l√≥gica de modais e senhas mantida)
        bloquearFichaButton.onclick = () => {
            if (isFichaLocked) {
                abrirModalSenha(); // Abre modal para desbloquear
            } else {
                 // Verifica se tem mais de 3 desvantagens ANTES de abrir o modal de bloqueio
                 if (desvantagensSelecionadas.length > 3) {
                      alert("Voc√™ n√£o pode bloquear a ficha com mais de 3 desvantagens! Remova o excesso primeiro.");
                      return;
                 }
                // Abre modal para definir senha de bloqueio
                document.getElementById("bloquear-ficha-modal").style.display = "flex";
                document.getElementById("senha-bloqueio-input").value = "";
                document.getElementById("senha-bloqueio-input").focus();
            }
        };

        function bloquearFicha() {
             const senhaInput = document.getElementById("senha-bloqueio-input");
             const senha = senhaInput.value;
             if (!/^\d{4}$/.test(senha)) { // Verifica 4 d√≠gitos num√©ricos
                 alert("A senha deve ter exatamente 4 d√≠gitos num√©ricos!");
                 senhaInput.focus();
                 return;
             }
             if (desvantagensSelecionadas.length > 3) { // Dupla verifica√ß√£o
                 alert("Voc√™ ainda tem mais de 3 desvantagens!");
                 fecharModal('bloquear-ficha-modal');
                 return;
             }

             isFichaLocked = true;
             fichaPassword = senha;
             isFichaUnlocked = false; // Garante que est√° bloqueada ap√≥s definir senha
             database.ref(`fichas/${currentFichaId}`).update({
                 isLocked: true,
                 password: senha
             }).then(() => {
                 fecharModal("bloquear-ficha-modal");
                 showNotification("Ficha bloqueada!", "save-success");
                 atualizarBotaoBloquear(); // Atualiza UI
             }).catch(error => {
                  console.error("Erro ao bloquear ficha:", error);
                  showNotification("Erro ao bloquear!", "critical-failure");
             });
        }


        function abrirModalSenha(elementToFocusAfter = null) {
             const modal = document.getElementById("password-modal");
             const input = document.getElementById("senha-desbloqueio-input");
             modal.style.display = "flex";
             input.value = "";
             input.focus();
             // Guarda o elemento que disparou (se houver) para poss√≠vel rollback
             modal.dataset.triggerElementId = elementToFocusAfter ? elementToFocusAfter.id : '';
         }

        function desbloquearFicha() {
             const senhaInput = document.getElementById("senha-desbloqueio-input");
             const senha = senhaInput.value;
             const modal = document.getElementById("password-modal");
             const triggerElementId = modal.dataset.triggerElementId;

             if (senha !== senhaMatriz && senha !== fichaPassword) {
                 alert("Senha incorreta!");
                 senhaInput.focus();
                 return;
             }

             fecharModal("password-modal");

             if (senha === senhaMatriz) {
                 // Desbloqueio Tempor√°rio com Senha Matriz
                 isFichaUnlocked = true;
                 showNotification("Desbloqueio tempor√°rio (GM)!", "normal-result");
                 atualizarBotaoBloquear(); // Apenas atualiza a UI para refletir inputs edit√°veis
                 // Se uma a√ß√£o espec√≠fica estava pendente (reset/recome√ßar), executa-a
                  if (triggerElementId === 'reset-pontos') resetarPontos();
                  else if (triggerElementId === 'recomecar') recomecarFicha();
                  // Se era um input, permite a edi√ß√£o (j√° habilitada por isFichaUnlocked)
             } else if (senha === fichaPassword && currentFichaId !== "ficha-matriz") {
                 // Desbloqueio Permanente (Senha do Usu√°rio, exceto Matriz)
                 isFichaLocked = false;
                 fichaPassword = null;
                 isFichaUnlocked = false; // N√£o precisa mais do desbloqueio tempor√°rio
                 database.ref(`fichas/${currentFichaId}`).update({
                     isLocked: false,
                     password: null
                 }).then(() => {
                     showNotification("Ficha desbloqueada permanentemente!", "save-success");
                     atualizarBotaoBloquear();
                     // Se uma a√ß√£o espec√≠fica estava pendente, executa-a
                     if (triggerElementId === 'reset-pontos') resetarPontos();
                     else if (triggerElementId === 'recomecar') recomecarFicha();
                 }).catch(error => {
                     console.error("Erro ao desbloquear ficha:", error);
                     showNotification("Erro ao desbloquear!", "critical-failure");
                 });
             }
         }


        function cancelarDesbloqueio() {
             const modal = document.getElementById("password-modal");
             const triggerElementId = modal.dataset.triggerElementId;
             fecharModal("password-modal");

             // Se o desbloqueio foi cancelado ao tentar editar um campo, reverte o valor
             if (triggerElementId) {
                 const element = document.getElementById(triggerElementId);
                 if (element && previousValues.has(element)) {
                     element.value = previousValues.get(element);
                 }
             }
             // Garante que a UI reflete o estado bloqueado
             atualizarBotaoBloquear();
        }

        // Verificar altera√ß√£o em inputs (mantido)
        function verificarAlteracao(event) {
             const input = event.target;
             // Permite sempre editar XP
             if (input.id === 'experiencia') return;
              // Permite bot√µes de vida/magia/vigor
             if (input.tagName === 'BUTTON' && input.parentElement.classList.contains('valor-atual')) return;


             if (isFichaLocked && !isFichaUnlocked) {
                 // Impede a altera√ß√£o padr√£o
                 event.preventDefault();
                 // Guarda o valor que estava antes de tentar mudar
                 if (!previousValues.has(input)) {
                      previousValues.set(input, input.value);
                 }
                 // Abre modal de senha, passando o input como refer√™ncia
                 abrirModalSenha(input);
                 return false; // Impede a edi√ß√£o
             } else {
                 // Se n√£o est√° bloqueado, apenas guarda o valor atual para poss√≠vel rollback
                 previousValues.set(input, input.value);
             }
         }

        // Adicionar listeners aos inputs (mantido e ajustado)
        // Usar delega√ß√£o de eventos no container da ficha para inputs adicionados dinamicamente (magias, invent√°rio)
         fichaContainer.addEventListener('beforeinput', verificarAlteracao); // Captura antes da altera√ß√£o
         fichaContainer.addEventListener('input', (event) => { // Captura ap√≥s a altera√ß√£o (se permitida)
             const input = event.target;
             if (!isFichaLocked || isFichaUnlocked) {
                 // Se for XP, atualiza n√≠vel
                 if (input.id === 'experiencia') {
                     experiencia = parseInt(input.value) || 0;
                     atualizarNivel();
                     salvarDados(false); // Salva sem notifica√ß√£o
                 }
                 // Se for atributo principal, recalcula
                 else if (atributosInputs.includes(input)) {
                     calcularAtributos();
                     salvarDados(false);
                 }
                 // Se for arma, recalcula
                 else if (input.id.startsWith('arma-')) {
                     calcularAtributos();
                     salvarDados(false);
                 }
                  // Se for peso do invent√°rio, recalcula peso total
                 else if (input.classList.contains('inventory-weight')) {
                      calcularPesoTotal();
                      salvarDados(false);
                 }
                 // Para outros campos (nome, descri√ß√£o, itens, magias, classe, etc.), apenas salva
                 else if (input.tagName === 'INPUT' || input.tagName === 'TEXTAREA') {
                     salvarDados(false);
                 }
             }
         });

        // Input do Nome do Personagem (listener espec√≠fico para t√≠tulo H1)
        nomePersonagemInput.addEventListener('input', () => {
            nomePersonagemTitulo.textContent = nomePersonagemInput.value || "Ficha de Personagem";
            // O save j√° √© tratado pelo listener geral 'input' no fichaContainer
        });

        // Upload de Imagem (mantido)
        characterImageInput.onchange = e => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = e => {
                    characterImage.src = e.target.result;
                    characterImage.style.display = "block";
                    salvarDados(); // Salva a nova imagem
                };
                reader.readAsDataURL(file);
            }
        };

        // Excluir Ficha (mantido)
        document.getElementById("excluir-ficha").onclick = () => {
            if (currentFichaId === "ficha-matriz") {
                alert("A ficha matriz n√£o pode ser exclu√≠da!");
                return;
            }
            if (isFichaLocked && !isFichaUnlocked) return abrirModalSenha(document.getElementById('excluir-ficha'));

            if (confirm(`Tem certeza que deseja excluir a ficha "${fichas[currentFichaId]?.nomeFicha || currentFichaId}"? Esta a√ß√£o n√£o pode ser desfeita.`)) {
                database.ref(`fichas/${currentFichaId}`).remove().then(() => {
                    showNotification("Ficha exclu√≠da!", "save-success");
                    localStorage.removeItem('lastFichaId'); // Remove da mem√≥ria local
                    // O listener 'on value' detectar√° a remo√ß√£o e chamar√° carregarFichas,
                    // que por sua vez selecionar√° a ficha matriz ou outra v√°lida.
                }).catch(error => {
                     console.error("Erro ao excluir ficha:", error);
                     showNotification("Erro ao excluir!", "critical-failure");
                });
            }
        };

        // Drag and Drop do Dado (mantido)
        let isDragging = false, currentX, currentY, initialX, initialY;
         // Inicializa a posi√ß√£o do dado com base no CSS (se houver) ou padr√£o
         currentX = diceContainer.offsetLeft;
         currentY = diceContainer.offsetTop;

        diceContainer.onmousedown = e => {
            // S√≥ permite arrastar se n√£o for o input dentro dele
             if (e.target === diceContainer || e.target === diceRoll || e.target === diceContainer.querySelector('label')) {
                  isDragging = true;
                  // Calcula a posi√ß√£o inicial relativa ao elemento
                  initialX = e.clientX - diceContainer.getBoundingClientRect().left;
                  initialY = e.clientY - diceContainer.getBoundingClientRect().top;
                  diceContainer.style.cursor = "grabbing";
                  diceContainer.style.position = 'absolute'; // Garante que est√° absoluto para mover
                  diceContainer.style.right = 'auto'; // Permite mover livremente
                  diceContainer.style.bottom = 'auto';
             }
        };
        document.onmousemove = e => {
            if (isDragging) {
                e.preventDefault();
                // Nova posi√ß√£o = posi√ß√£o do mouse - offset inicial
                currentX = e.clientX - initialX;
                currentY = e.clientY - initialY;

                // Limita a posi√ß√£o dentro da janela vis√≠vel (opcional)
                // currentX = Math.max(0, Math.min(currentX, window.innerWidth - diceContainer.offsetWidth));
                // currentY = Math.max(0, Math.min(currentY, window.innerHeight - diceContainer.offsetHeight));

                diceContainer.style.left = `${currentX}px`;
                diceContainer.style.top = `${currentY}px`;
            }
        };
        document.onmouseup = () => {
            if (isDragging) {
                isDragging = false;
                diceContainer.style.cursor = "move";
            }
        };


        // Listener para Dados Rolados por Outros (mantido)
        database.ref('dadosRolados').limitToLast(10).on('child_added', snapshot => { // Limita aos √∫ltimos 10
             const dado = snapshot.val();
             const lista = document.getElementById("historico-lista");

             // Adiciona ao hist√≥rico visual
             const div = document.createElement("div");
             div.textContent = `${dado.nomeFicha || '??'} rolou: ${dado.resultado}`;
             // Adiciona no in√≠cio da lista
             if (lista.firstChild) {
                 lista.insertBefore(div, lista.firstChild);
             } else {
                 lista.appendChild(div);
             }
             // Limita o n√∫mero de itens vis√≠veis (opcional)
             while (lista.children.length > 20) {
                 lista.removeChild(lista.lastChild);
             }

             // Notifica se o dado n√£o for da ficha atual
             if (dado.fichaId !== currentFichaId) {
                 showNotification(`${dado.nomeFicha || '??'} rolou: ${dado.resultado}`, "normal-result");
             }
         });

        // Rolar Dado (mantido)
        diceRoll.onclick = () => {
            // N√£o precisa verificar bloqueio, rolar dado √© permitido
            diceRoll.textContent = "üé≤"; // Mostra √≠cone enquanto rola
            diceResult.style.display = "none";
            diceRoll.classList.remove("critical-failure", "critical-success");
            diceRoll.style.animation = 'spin 0.5s linear infinite'; // Anima√ß√£o de giro

            setTimeout(() => {
                const roll = Math.floor(Math.random() * 20) + 1;
                const fichaNome = fichas[currentFichaId]?.nomeFicha || "Sem Nome";

                diceRoll.style.animation = ''; // Para anima√ß√£o
                diceRoll.textContent = roll;

                let notificationType = "normal-result";
                let notificationText = `${fichaNome} rolou: ${roll}`;

                if (roll === 1) {
                    diceRoll.classList.add("critical-failure");
                    notificationType = "critical-failure";
                    notificationText = `${fichaNome} - FALHA CR√çTICA! (${roll})`;
                } else if (roll === 20) {
                    diceRoll.classList.add("critical-success");
                    notificationType = "critical-success";
                    notificationText = `${fichaNome} - SUCESSO CR√çTICO! (${roll})`;
                } else {
                    diceResult.textContent = `Resultado: ${roll}`; // Mostra resultado abaixo
                    diceResult.style.display = "block";
                }

                showNotification(notificationText, notificationType);

                // Salva no Firebase (triggera o child_added listener)
                const dadoRef = database.ref('dadosRolados').push();
                dadoRef.set({
                    fichaId: currentFichaId,
                    nomeFicha: fichaNome,
                    resultado: roll,
                    timestamp: firebase.database.ServerValue.TIMESTAMP // Adiciona timestamp
                });
            }, 700); // Tempo da anima√ß√£o
        };

        // --- Vantagens / Desvantagens ---

        // Abrir Painel Vantagens/Desvantagens (mantido)
        vantagensDesvantagensBtn.onclick = () => {
            if (isFichaLocked && !isFichaUnlocked) return abrirModalSenha(vantagensDesvantagensBtn);
            // Copia arrays salvos para os tempor√°rios
            tempVantagensSelecionadas = [...vantagensSelecionadas];
            tempDesvantagensSelecionadas = [...desvantagensSelecionadas];
            vantagensDesvantagensPanel.style.display = "block";
            document.getElementById("salvar-vantagens-btn").style.display = "none"; // Esconde bot√£o salvar inicialmente
            atualizarVantagensDesvantagensPanel(); // Atualiza a exibi√ß√£o no painel
        };

        // Fechar Painel Vantagens/Desvantagens (mantido)
        fecharPaginaBtn.onclick = () => {
            vantagensDesvantagensPanel.style.display = "none";
            // N√£o salva altera√ß√µes tempor√°rias
        };

        // Bot√£o Salvar no Painel Vantagens/Desvantagens -> Abre Modal Confirma√ß√£o (mantido)
        salvarVantagensBtn.onclick = () => {
             // Verifica limite de desvantagens ANTES de abrir modal de salvar
             if (tempDesvantagensSelecionadas.length > 3) {
                 alert("Voc√™ selecionou mais de 3 desvantagens! Remova o excesso antes de salvar.");
                 return;
             }
            document.getElementById("salvar-vantagens-modal").style.display = "flex";
        };

        // Confirmar Salvar Vantagens/Desvantagens (l√≥gica principal de salvar V/D)
        document.getElementById("confirmar-salvar-vantagens-btn").onclick = () => {
             // Verifica novamente o limite de desvantagens
             if (tempDesvantagensSelecionadas.length > 3) {
                 alert("Erro: Voc√™ ainda tem mais de 3 desvantagens selecionadas!");
                 fecharModal("salvar-vantagens-modal");
                 return;
             }

             // Atualiza as listas principais com os dados tempor√°rios
             vantagensSelecionadas = [...tempVantagensSelecionadas];
             desvantagensSelecionadas = [...tempDesvantagensSelecionadas];

             // Atualiza a exibi√ß√£o na ficha principal
             vantagensListDisplay.innerHTML = "";
             desvantagensListDisplay.innerHTML = "";
             vantagensSelecionadas.forEach(v => {
                 const div = document.createElement("div");
                 div.textContent = v;
                 div.className = "list-item";
                 div.onclick = () => removerVantagem(v); // Adiciona listener para remover (com senha GM)
                 vantagensListDisplay.appendChild(div);
             });
             desvantagensSelecionadas.forEach(d => {
                 const div = document.createElement("div");
                 div.textContent = d;
                 div.className = "list-item";
                 div.onclick = () => removerDesvantagem(d); // Adiciona listener para remover (com senha GM)
                 desvantagensListDisplay.appendChild(div);
             });

             // Recalcula PH e salva os dados gerais da ficha
             pontosVantagemSpan.textContent = getPontosVantagem();
             calcularAtributos(); // Recalcula b√¥nus que podem depender de V/D
             salvarDados();

             // Fecha painel e modal
             vantagensDesvantagensPanel.style.display = "none";
             fecharModal("salvar-vantagens-modal");
             showNotification("Vantagens/Desvantagens salvas!", "save-success");
         };

        // Atualizar Painel Vantagens/Desvantagens (mantido)
        function atualizarVantagensDesvantagensPanel() {
             vantagensList.innerHTML = "<h3>Vantagens Dispon√≠veis</h3>";
             desvantagensList.innerHTML = "<h3>Desvantagens Dispon√≠veis</h3>";
             const phTemp = calcularPontosVantagemTemp();
             document.getElementById("ph-temp").textContent = phTemp;

             vantagensData.forEach(v => {
                 const div = document.createElement("div");
                 div.className = "vantagem-item";
                 div.textContent = `${v.nome} - Custo: ${v.custo} PH - ${v.descricao}`;
                 const isCompradaTemp = tempVantagensSelecionadas.includes(v.nome);
                 const isCompradaSalva = vantagensSelecionadas.includes(v.nome);
                 const podeComprar = phTemp >= v.custo;
                 const restricaoInicioOk = !(v.restricao === "inicio" && nivel > 0);

                 if (isCompradaTemp) {
                     div.classList.add("comprada"); // Marca como selecionada temporariamente
                     div.title = "Clique para remover sele√ß√£o";
                 } else if (isCompradaSalva) {
                     div.style.opacity = 0.5; // Mostra como j√° salva e n√£o clic√°vel aqui
                     div.style.cursor = 'not-allowed';
                     div.title = "J√° salva. Remova na ficha principal (requer GM).";
                 } else if (!podeComprar) {
                     div.style.opacity = 0.5;
                     div.style.cursor = 'not-allowed';
                     div.title = "PH tempor√°rio insuficiente.";
                 } else if (!restricaoInicioOk) {
                     div.style.opacity = 0.5;
                     div.style.cursor = 'not-allowed';
                     div.title = "S√≥ pode ser comprada no n√≠vel 0.";
                 } else {
                     div.title = "Clique para selecionar";
                 }


                 div.onclick = () => {
                     if (isCompradaSalva) return; // N√£o faz nada se j√° estiver salva

                     if (isCompradaTemp) {
                         // Remove da sele√ß√£o tempor√°ria
                         tempVantagensSelecionadas = tempVantagensSelecionadas.filter(t => t !== v.nome);
                     } else {
                         // Adiciona √† sele√ß√£o tempor√°ria, se puder
                         if (podeComprar && restricaoInicioOk) {
                             tempVantagensSelecionadas.push(v.nome);
                         } else if (!podeComprar) {
                             alert("Pontos de Vantagem (PH) tempor√°rios insuficientes!");
                         } else if (!restricaoInicioOk) {
                             alert("Esta vantagem s√≥ pode ser comprada no n√≠vel 0.");
                         }
                     }
                     // Atualiza o painel e mostra o bot√£o salvar
                     atualizarVantagensDesvantagensPanel();
                     document.getElementById("salvar-vantagens-btn").style.display = "block";
                 };
                 vantagensList.appendChild(div);
             });

             desvantagensData.forEach(d => {
                 const div = document.createElement("div");
                 div.className = "desvantagem-item";
                 div.textContent = `${d.nome} - Ganho: ${d.ganho} PH - ${d.descricao}`;
                 const isCompradaTemp = tempDesvantagensSelecionadas.includes(d.nome);
                 const isCompradaSalva = desvantagensSelecionadas.includes(d.nome);
                 const limiteOk = tempDesvantagensSelecionadas.length < 3;

                 if (isCompradaTemp) {
                     div.classList.add("comprada"); // Verde claro para desvantagem selecionada
                     div.title = "Clique para remover sele√ß√£o";
                 } else if (isCompradaSalva) {
                     div.style.opacity = 0.5;
                     div.style.cursor = 'not-allowed';
                     div.title = "J√° salva. Remova na ficha principal (requer GM).";
                 } else if (!limiteOk) {
                     div.style.opacity = 0.5;
                     div.style.cursor = 'not-allowed';
                     div.title = "Limite de 3 desvantagens atingido.";
                 } else {
                      div.title = "Clique para selecionar";
                 }

                 div.onclick = () => {
                     if (isCompradaSalva) return;

                     if (isCompradaTemp) {
                         tempDesvantagensSelecionadas = tempDesvantagensSelecionadas.filter(t => t !== d.nome);
                     } else {
                         if (limiteOk) {
                             tempDesvantagensSelecionadas.push(d.nome);
                         } else {
                             alert("Voc√™ j√° atingiu o limite de 3 desvantagens!");
                         }
                     }
                     atualizarVantagensDesvantagensPanel();
                     document.getElementById("salvar-vantagens-btn").style.display = "block";
                 };
                 desvantagensList.appendChild(div);
             });
         }


        // Remover Vantagem (requer senha GM)
        function removerVantagem(vNome) {
            if (isFichaLocked && !isFichaUnlocked) return abrirModalSenha(); // Precisa estar desbloqueado para iniciar remo√ß√£o
            abrirModalSenhaGM(() => {
                 vantagensSelecionadas = vantagensSelecionadas.filter(v => v !== vNome);
                 // Atualiza UI da ficha principal
                 const itemToRemove = Array.from(vantagensListDisplay.children).find(div => div.textContent === vNome);
                 if (itemToRemove) vantagensListDisplay.removeChild(itemToRemove);
                 // Recalcula PH e salva
                 pontosVantagemSpan.textContent = getPontosVantagem();
                 calcularAtributos(); // Recalcula b√¥nus
                 salvarDados();
                 showNotification(`Vantagem "${vNome.split(' (')[0]}" removida!`, "save-success");
            });
        }

        // Remover Desvantagem (requer senha GM)
        function removerDesvantagem(dNome) {
            if (isFichaLocked && !isFichaUnlocked) return abrirModalSenha();
             abrirModalSenhaGM(() => {
                 desvantagensSelecionadas = desvantagensSelecionadas.filter(d => d !== dNome);
                 const itemToRemove = Array.from(desvantagensListDisplay.children).find(div => div.textContent === dNome);
                 if (itemToRemove) desvantagensListDisplay.removeChild(itemToRemove);
                 pontosVantagemSpan.textContent = getPontosVantagem();
                 calcularAtributos();
                 salvarDados();
                 showNotification(`Desvantagem "${dNome.split(' (+')[0]}" removida!`, "save-success");
             });
        }

        // --- Ra√ßas ---

        // Abrir Painel Ra√ßas (mantido)
        racasBtn.onclick = () => {
            if (isFichaLocked && !isFichaUnlocked) return abrirModalSenha(racasBtn);
            tempRacaSelecionada = racaSelecionada; // Copia ra√ßa atual para tempor√°ria
            racasPanel.style.display = "block";
            document.getElementById("salvar-racas-btn").style.display = "none"; // Esconde salvar inicialmente
            atualizarRacasPanel();
        };

        // Fechar Painel Ra√ßas (mantido)
        fecharRacasBtn.onclick = () => {
            racasPanel.style.display = "none";
        };

        // Bot√£o Salvar no Painel Ra√ßas -> Abre Modal Confirma√ß√£o
        salvarRacasBtn.onclick = () => {
             // Verifica se uma ra√ßa tempor√°ria foi selecionada e √© diferente da salva
             if (tempRacaSelecionada && tempRacaSelecionada !== racaSelecionada) {
                  const racaTempData = racasData.find(r => r.nome === tempRacaSelecionada);
                  const phNecessario = racaTempData?.custo || 0;
                   // Verifica se tem PH suficiente considerando a troca
                   const phDisponivel = calcularPontosVantagemTemp(); // PH j√° considera a troca temp

                  if (phDisponivel < 0) { // Se ficou negativo ap√≥s selecionar a ra√ßa temp
                       alert(`PH insuficiente para escolher a ra√ßa "${racaTempData.nome.split(' (')[0]}". Voc√™ precisa de ${phNecessario} PH, mas ficaria com ${phDisponivel}.`);
                       return;
                  }
                  // Mostra confirma√ß√£o espec√≠fica para ra√ßa
                  document.getElementById("confirmar-compra-texto").textContent = `Confirmar escolha da ra√ßa "${racaTempData.nome.split(' (')[0]}"? O custo de ${phNecessario} PH ser√° aplicado.`;
                  document.getElementById("confirmar-compra-modal").style.display = "flex";
                  document.getElementById("confirmar-compra-btn").onclick = () => confirmarSalvarRaca();

             } else if (!tempRacaSelecionada && racaSelecionada) {
                  // Caso tenha deselecionado a ra√ßa (implica remover a ra√ßa salva)
                  document.getElementById("confirmar-compra-texto").textContent = `Confirmar remo√ß√£o da ra√ßa "${racaSelecionada.split(' (')[0]}"? Isso requer permiss√£o do GM.`;
                  document.getElementById("confirmar-compra-modal").style.display = "flex";
                  document.getElementById("confirmar-compra-btn").onclick = () => confirmarSalvarRaca(); // A confirma√ß√£o pedir√° senha GM
             } else {
                   // Nenhuma mudan√ßa na ra√ßa, apenas fecha
                   racasPanel.style.display = "none";
                   fecharModal("confirmar-compra-modal"); // Fecha se estiver aberto
             }
         };

         // Fun√ß√£o chamada ao confirmar a mudan√ßa de ra√ßa no modal
         function confirmarSalvarRaca() {
             fecharModal("confirmar-compra-modal"); // Fecha modal de confirma√ß√£o da ra√ßa

             const racaAnterior = racaSelecionada;
             const racaNova = tempRacaSelecionada;

             // Fun√ß√£o para aplicar a mudan√ßa de ra√ßa
             const aplicarMudancaRaca = () => {
                 racaSelecionada = racaNova; // Atualiza a ra√ßa principal

                 // Atualiza UI da ficha principal
                 if (racaSelecionada) {
                     const racaData = racasData.find(r => r.nome === racaSelecionada);
                     racaNomeSpan.textContent = racaSelecionada.split(" (")[0];
                     racaDescricaoInput.value = racaData ? racaData.vantagens.join("\n\n") : "";
                 } else {
                     racaNomeSpan.textContent = "Clique para selecionar/editar";
                     racaDescricaoInput.value = "";
                 }

                 // Recalcula PH, atributos e salva
                 pontosVantagemSpan.textContent = getPontosVantagem();
                 calcularAtributos(); // Recalcula para aplicar poss√≠veis b√¥nus/custos
                 salvarDados();

                 racasPanel.style.display = "none"; // Fecha painel de ra√ßas
                 showNotification(`Ra√ßa ${racaSelecionada ? `"${racaSelecionada.split(' (')[0]}" selecionada` : 'removida'}!`, "save-success");
             };

             // Se j√° havia uma ra√ßa salva, precisa de senha GM para mudar/remover
             if (racaAnterior) {
                 abrirModalSenhaGM(aplicarMudancaRaca);
             } else {
                 // Se n√£o havia ra√ßa salva, aplica diretamente
                 aplicarMudancaRaca();
             }
         }


        // Atualizar Painel Ra√ßas (mantido)
        function atualizarRacasPanel() {
             racasList.innerHTML = ""; // Limpa lista
             const phTemp = calcularPontosVantagemTemp(); // Calcula PH considerando sele√ß√£o tempor√°ria
             document.getElementById("ph-temp").textContent = phTemp; // Mostra PH temp no painel de V/D (se aberto)

             racasData.forEach(r => {
                 const div = document.createElement("div");
                 div.className = "raca-item";
                 div.innerHTML = `<h3>${r.nome}</h3><p>${r.descricao}</p><p><strong>Vantagens Raciais:</strong></p><ul>${r.vantagens.map(v => `<li>${v}</li>`).join("")}</ul>`;

                 const isSelecionadaTemp = tempRacaSelecionada === r.nome;
                 const isSelecionadaSalva = racaSelecionada === r.nome;
                  // Calcula o PH necess√°rio *considerando a troca*
                  const custoReal = r.custo - (racaSelecionada ? (racasData.find(ra => ra.nome === racaSelecionada)?.custo || 0) : 0);
                  const podeSelecionar = phTemp >= custoReal || isSelecionadaTemp; // Pode selecionar se tiver PH ou se j√° est√° selecionada temp


                 if (isSelecionadaTemp) {
                     div.classList.add("comprada"); // Marca como selecionada temporariamente
                     div.title = "Clique para deselecionar";
                 } else if (isSelecionadaSalva) {
                      // N√£o pode deselecionar aqui se j√° estiver salva
                      div.style.opacity = 0.6;
                      div.style.cursor = 'not-allowed';
                      div.title = "Ra√ßa j√° salva. Edite/Exclua na ficha principal (requer GM).";
                 } else if (!podeSelecionar && !isSelecionadaSalva) {
                      div.style.opacity = 0.6;
                      div.style.cursor = 'not-allowed';
                      div.title = `PH tempor√°rio insuficiente (precisa ${r.custo}, tem ${phTemp + (racaSelecionada ? (racasData.find(ra => ra.nome === racaSelecionada)?.custo || 0) : 0) })`;
                 } else {
                      div.title = "Clique para selecionar";
                 }

                 div.onclick = () => {
                     // N√£o permite intera√ß√£o se j√° estiver salva permanentemente
                     if (isSelecionadaSalva && !isSelecionadaTemp) return;

                     if (isSelecionadaTemp) {
                         // Deseleciona a ra√ßa tempor√°ria
                         tempRacaSelecionada = null;
                         document.getElementById("salvar-racas-btn").style.display = racaSelecionada ? "block" : "none"; // Mostra salvar se tinha uma ra√ßa antes
                     } else {
                          // Verifica se pode selecionar
                          if (podeSelecionar) {
                               tempRacaSelecionada = r.nome;
                               document.getElementById("salvar-racas-btn").style.display = "block"; // Mostra bot√£o salvar
                          } else {
                               alert("Pontos de Vantagem (PH) tempor√°rios insuficientes para escolher esta ra√ßa!");
                          }
                     }
                     // Atualiza o painel para refletir a mudan√ßa na sele√ß√£o tempor√°ria
                     atualizarRacasPanel();
                 };
                 racasList.appendChild(div);
             });
             // Atualiza exibi√ß√£o do PH tempor√°rio no painel de ra√ßas
             const phTempDisplay = racasPanel.querySelector('#ph-temp-racas'); // Adicionar este span no HTML do painel se desejar
             if(phTempDisplay) phTempDisplay.textContent = calcularPontosVantagemTemp();
         }


        // Abrir Op√ß√µes da Ra√ßa (Excluir/Editar) (mantido)
        function abrirModalRaca() {
            if (!racaSelecionada) {
                 // Se nenhuma ra√ßa selecionada, abre o painel de sele√ß√£o
                 racasBtn.click();
                 return;
            }
            // Se j√° tem ra√ßa, abre op√ß√µes
            document.getElementById("raca-opcoes-modal").style.display = "flex";
        }

        // Excluir Ra√ßa Selecionada (requer senha GM)
        function excluirRacaSelecionadaModal() {
            fecharModal('raca-opcoes-modal');
             if (!racaSelecionada) return; // N√£o faz nada se n√£o houver ra√ßa

             abrirModalSenhaGM(() => {
                 const racaRemovidaNome = racaSelecionada.split(' (')[0];
                 racaSelecionada = null; // Remove a sele√ß√£o
                 // Atualiza UI
                 racaNomeSpan.textContent = "Clique para selecionar/editar";
                 racaDescricaoInput.value = "";
                 // Recalcula PH e salva
                 pontosVantagemSpan.textContent = getPontosVantagem();
                 calcularAtributos();
                 salvarDados();
                 showNotification(`Ra√ßa "${racaRemovidaNome}" removida!`, "save-success");
             });
        }

        // Abrir Modal Editar Ra√ßa (requer senha GM para salvar) (mantido)
        function editarRacaSelecionadaModal() {
             fecharModal('raca-opcoes-modal');
             if (!racaSelecionada) return; // N√£o faz nada se n√£o houver ra√ßa
             // N√£o precisa de senha GM para abrir, s√≥ para salvar a edi√ß√£o

             document.getElementById("editar-raca-modal").style.display = "flex";
             document.getElementById("editar-raca-nome").value = racaNomeSpan.textContent; // Usa o nome exibido
             document.getElementById("editar-raca-descricao").value = racaDescricaoInput.value; // Usa a descri√ß√£o exibida
        }

        // Salvar Edi√ß√£o da Ra√ßa (requer senha GM)
        function salvarEdicaoRaca() {
             if (!racaSelecionada) return; // Seguran√ßa extra

             abrirModalSenhaGM(() => {
                 // Atualiza os campos na UI principal (a descri√ß√£o √© s√≥ visual aqui)
                 // Nota: N√£o alteramos o 'racaSelecionada' (que cont√©m o custo)
                 racaNomeSpan.textContent = document.getElementById("editar-raca-nome").value.trim();
                 racaDescricaoInput.value = document.getElementById("editar-raca-descricao").value.trim();

                 fecharModal('editar-raca-modal');
                 // Salva os dados gerais (que incluem racaNome e racaDescricao indiretamente via UI elements)
                 // Idealmente, salvar√≠amos esses campos editados no Firebase tamb√©m,
                 // mas para simplificar, estamos apenas mudando a exibi√ß√£o.
                 // Para persistir a edi√ß√£o, adicione campos como `racaNomeEditado`, `racaDescricaoEditada`
                 // ao objeto `dados` na fun√ß√£o `salvarDados`.
                 salvarDados(); // Salva a ficha com os novos textos visuais
                 showNotification("Descri√ß√£o da ra√ßa editada (visualmente)!", "save-success");
             });
        }

        // --- Classes ---

        // Abrir/Fechar Painel Classes (mantido)
        classesBtn.onclick = () => {
             if (isFichaLocked && !isFichaUnlocked) return abrirModalSenha(classesBtn);
            classesPanel.style.display = "block";
            // Popular o painel de classes aqui, se necess√°rio
        };
        fecharClassesBtn.onclick = () => {
            classesPanel.style.display = "none";
        };

        // --- Modos Claro/Escuro e Cores ---

        // Bot√µes Lua/Sol (Modo Escuro/Claro) - Resetam cores customizadas
        luaBtn.onclick = () => {
            document.body.classList.add("dark-mode");
            // Reseta cores customizadas para o padr√£o dark
             applyBackgroundColor(document.body, findColorByValue('#121212') || defaultExternalColor); // Usa preto ou padr√£o
             applyBackgroundColor(fichaContainer, findColorByValue('rgba(30, 30, 30, 0.95)') || defaultInternalColor); // Usa cinza escuro ou padr√£o
             // N√£o salva essa mudan√ßa no Firebase, √© s√≥ visual/tempor√°rio
        };
        solBtn.onclick = () => {
            document.body.classList.remove("dark-mode");
            // Reseta cores customizadas para o padr√£o light
            applyBackgroundColor(document.body, defaultExternalColor);
            applyBackgroundColor(fichaContainer, defaultInternalColor);
            // N√£o salva essa mudan√ßa no Firebase
        };

        // NOVO: Abrir Modal de Cores
        corFundoBtn.onclick = () => {
            if (isFichaLocked && !isFichaUnlocked) return abrirModalSenha(corFundoBtn);

            // Guarda cores atuais em vari√°veis tempor√°rias
            tempExternalColor = currentExternalColor;
            tempInternalColor = currentInternalColor;

            // Popula as op√ß√µes de cores nos containers
            populateColorOptions(coresExternasContainer, 'external', tempExternalColor);
            populateColorOptions(coresInternasContainer, 'internal', tempInternalColor);

            corFundoModal.style.display = 'flex';
        };

        // NOVO: Popula as bolinhas de cores no modal
        function populateColorOptions(container, type, selectedColor) {
            container.innerHTML = ''; // Limpa op√ß√µes anteriores
            backgroundColors.forEach(color => {
                const colorDiv = document.createElement('div');
                colorDiv.className = 'color-option';
                colorDiv.dataset.colorValue = color.value;
                colorDiv.dataset.colorType = color.type;
                colorDiv.dataset.colorName = color.name; // Para tooltip

                // Aplica a cor ou gradiente/imagem √† bolinha
                if (color.type === 'color') {
                    colorDiv.style.backgroundColor = color.value;
                } else if (color.type === 'gradient' || color.type === 'image') {
                    // Para gradiente/imagem, pode ser necess√°rio ajustar o estilo
                    // Se for imagem, idealmente teria um preview menor
                    if (color.name === 'Ex√©rcito') {
                         // Aplica classe espec√≠fica para camo
                         colorDiv.classList.add('color-option-camouflage');
                         // Ou aplica o gradiente diretamente
                         colorDiv.style.backgroundImage = color.value;
                         colorDiv.style.backgroundSize = 'cover'; // Ajusta tamanho do gradiente/imagem
                    } else if (color.type === 'image') {
                        // Tenta mostrar a imagem de fundo (pode n√£o ficar ideal em c√≠rculo pequeno)
                        colorDiv.style.backgroundImage = `url('${color.value.match(/url\(['"]?(.*?)['"]?\)/)?.[1] || ''}')`;
                        colorDiv.style.backgroundSize = 'cover';
                        colorDiv.style.backgroundPosition = 'center';
                    } else {
                         // Fallback: cor s√≥lida se n√£o for camo/imagem reconhecida
                         colorDiv.style.backgroundColor = '#ccc'; // Cor gen√©rica
                    }
                }


                // Marca a cor selecionada atualmente
                if (selectedColor && color.value === selectedColor.value) {
                    colorDiv.classList.add('selected-color');
                }

                // Adiciona evento de clique
                colorDiv.onclick = () => {
                    // Remove sele√ß√£o anterior no mesmo container
                    container.querySelectorAll('.selected-color').forEach(el => el.classList.remove('selected-color'));
                    // Adiciona sele√ß√£o √† clicada
                    colorDiv.classList.add('selected-color');
                    // Atualiza a vari√°vel tempor√°ria correspondente
                    const chosenColor = findColorByValue(color.value);
                    if (type === 'external') {
                        tempExternalColor = chosenColor;
                    } else if (type === 'internal') {
                        tempInternalColor = chosenColor;
                    }
                };

                container.appendChild(colorDiv);
            });
        }


        // NOVO: Bot√£o Salvar Cores no Modal
        salvarCoresFundoBtn.onclick = () => {
            // Atualiza as cores principais com as tempor√°rias
            currentExternalColor = tempExternalColor;
            currentInternalColor = tempInternalColor;

            // Aplica as cores selecionadas
            applyBackgroundColor(document.body, currentExternalColor);
            applyBackgroundColor(fichaContainer, currentInternalColor);

             // Ajusta modo claro/escuro baseado na nova cor externa
             const isDarkBackground = ['#121212', '#00008B', '#006400', '#800000', '#1e1e1e', '#800080'].includes(currentExternalColor?.value);
             if (isDarkBackground) {
                 document.body.classList.add('dark-mode');
             } else {
                 document.body.classList.remove('dark-mode');
             }

            // Salva as cores na ficha atual
            salvarDados(); // A fun√ß√£o salvarDados j√° inclui os campos de cor

            fecharModal('cor-fundo-modal');
            showNotification("Cores de fundo salvas!", "save-success");
        };

        // NOVO: Bot√£o Excluir/Resetar Cores no Modal
        excluirCoresFundoBtn.onclick = () => {
            // Reseta as cores para o padr√£o
            currentExternalColor = defaultExternalColor;
            currentInternalColor = defaultInternalColor;

            // Aplica as cores padr√£o
            applyBackgroundColor(document.body, currentExternalColor);
            applyBackgroundColor(fichaContainer, currentInternalColor);
             document.body.classList.remove('dark-mode'); // Volta para modo claro padr√£o

            // Salva as cores padr√£o na ficha atual
            salvarDados();

            fecharModal('cor-fundo-modal');
            showNotification("Cores de fundo redefinidas para o padr√£o!", "save-success");
        };

        // NOVO: Bot√£o Cancelar Cores no Modal
        cancelarCoresFundoBtn.onclick = () => {
            fecharModal('cor-fundo-modal');
            // N√£o faz nada, as cores voltam ao que eram antes de abrir o modal
            // (pois as altera√ß√µes eram s√≥ nas vari√°veis temp)
        };


        // --- Outros ---

        // Calcular Peso Total Invent√°rio (mantido)
        function calcularPesoTotal() {
            pesoTotalSpan.textContent = Array.from(inventarioSlots.querySelectorAll(".inventory-weight"))
                .reduce((total, weight) => total + (parseFloat(weight.value) || 0), 0)
                .toFixed(1);
        }
        inventarioSlots.addEventListener("input", (event) => {
             if (event.target.classList.contains('inventory-weight')) {
                  calcularPesoTotal();
                  // salvarDados(false); // O listener geral j√° salva
             }
         });

        // Bot√£o e Textarea Anota√ß√µes (mantido)
        anotacoesBtn.onclick = () => {
            anotacoesTextarea.style.display = anotacoesTextarea.style.display === "block" ? "none" : "block";
             if(anotacoesTextarea.style.display === "block") {
                  anotacoesTextarea.focus();
             }
        };
        // Fechar anota√ß√µes ao clicar fora (mantido)
        document.addEventListener('click', function(event) {
            if (anotacoesTextarea.style.display === "block" && !anotacoesTextarea.contains(event.target) && !anotacoesBtn.contains(event.target)) {
                anotacoesTextarea.style.display = 'none';
                salvarDados(false); // Salva ao fechar
            }
             // Fechar hist√≥rico de dados ao clicar fora
             const panelHistorico = document.getElementById("historico-dados-panel");
             const btnHistorico = document.getElementById("historico-dados-btn");
             if (panelHistorico.style.display === "block" && !panelHistorico.contains(event.target) && !btnHistorico.contains(event.target)) {
                 panelHistorico.style.display = "none";
             }
        });
        // Salvar anota√ß√µes enquanto digita (j√° coberto pelo listener geral)


        // Adicionar Magia/Habilidade (mantido e melhorado)
         function adicionarInputMagia(valor = "") {
             const i = magiasList.children.length + 1;
             if (i > 20) return false; // Limite

             const input = document.createElement("input");
             input.type = "text";
             input.className = "magia-nome";
             input.placeholder = `Magia/Habilidade ${i}`;
             input.value = valor;
             magiasList.appendChild(input);
             return true;
         }

        adicionarMagiaBtn.onclick = () => {
            if (isFichaLocked && !isFichaUnlocked) return abrirModalSenha(adicionarMagiaBtn);

            if (!adicionarInputMagia()) {
                alert("Voc√™ atingiu o limite de 20 magias/habilidades!");
            } else {
                salvarDados(false); // Salva ao adicionar slot
            }
        };

        // Hist√≥rico de Dados (mantido)
        document.getElementById("historico-dados-btn").onclick = () => {
            document.getElementById("historico-dados-panel").style.display = "block";
        };
        // Listener para fechar ao clicar fora j√° adicionado acima
        document.getElementById("excluir-historico-btn").onclick = () => {
             abrirModalSenhaGM(() => {
                 database.ref('dadosRolados').remove().then(() => {
                     document.getElementById("historico-lista").innerHTML = ""; // Limpa lista visual
                     showNotification("Hist√≥rico de dados exclu√≠do!", "save-success");
                 }).catch(error => console.error("Erro ao excluir hist√≥rico:", error));
             });
        };

        // Notifica√ß√£o (mantido)
        function showNotification(message, type) {
            notification.textContent = message;
            notification.className = ''; // Limpa classes anteriores
            notification.classList.add(type); // Adiciona a classe do tipo
            notification.style.display = "block";
            // Remove a notifica√ß√£o ap√≥s um tempo
            setTimeout(() => {
                notification.style.display = "none";
                notification.className = ""; // Limpa classe ao esconder
            }, 2500); // Tempo um pouco maior
        }

        // --- Chat ---

        // Abrir Modal Senha ou Modal Chat (mantido)
        chatBtn.onclick = () => {
             if (!currentFichaId || currentFichaId === "ficha-matriz") {
                  alert("Selecione ou crie uma ficha de personagem para usar o chat.");
                  return;
             }
            if (!chatPassword) {
                // Se n√£o tem senha, abre modal para definir
                document.getElementById("chat-password-modal").style.display = "flex";
                document.getElementById("chat-senha-input").value = "";
                document.getElementById("chat-confirmar-senha-input").value = "";
                document.getElementById("chat-senha-input").focus();
            } else {
                // Se j√° tem senha, abre modal para digitar
                document.getElementById("open-chat-modal").style.display = "flex";
                document.getElementById("abrir-chat-senha-input").value = "";
                document.getElementById("abrir-chat-senha-input").focus();
            }
        };

        // Definir Senha do Chat (mantido)
        function definirSenhaChat() {
            const senhaInput = document.getElementById("chat-senha-input");
            const confirmarSenhaInput = document.getElementById("chat-confirmar-senha-input");
            const senha = senhaInput.value;
            const confirmarSenha = confirmarSenhaInput.value;

            if (senha.length < 4) {
                alert("A senha do chat deve ter pelo menos 4 caracteres.");
                senhaInput.focus();
                return;
            }
            if (senha !== confirmarSenha) {
                alert("As senhas n√£o coincidem.");
                confirmarSenhaInput.focus();
                return;
            }

            chatPassword = senha;
            database.ref(`fichas/${currentFichaId}`).update({ chatPassword: senha }).then(() => {
                fecharModal("chat-password-modal");
                showNotification("Senha do chat definida!", "save-success");
                atualizarEstadoChatBotao();
                 // Tenta abrir o chat diretamente ap√≥s definir a senha
                 abrirChatComSenha(senha);
            }).catch(error => {
                 console.error("Erro ao definir senha do chat:", error);
                 showNotification("Erro ao definir senha!", "critical-failure");
            });
        }

        // Abrir Chat (ap√≥s digitar senha) (mantido)
        function abrirChat() {
            const senhaDigitada = document.getElementById("abrir-chat-senha-input").value;
            abrirChatComSenha(senhaDigitada);
        }

        // Fun√ß√£o auxiliar para abrir chat validando a senha
        function abrirChatComSenha(senha) {
             if (senha === chatPassword) {
                 fecharModal("open-chat-modal"); // Fecha modal de digitar senha
                 document.getElementById("chat-modal").style.display = "flex";
                 isChatOpen = true;
                 selectedChatUser = null; // Reseta sele√ß√£o
                 selectedChatUserName = null;
                 conversationAreaDiv.innerHTML = '<div style="text-align: center; margin-top: 20px; color: var(--modal-text);">Selecione uma ficha para conversar.</div>'; // Mensagem inicial
                 mensagemInput.disabled = true; // Desabilita input de msg
                 enviarMensagemBtn.disabled = true; // Desabilita bot√£o enviar
                 // Limpa contador de n√£o lidas ao abrir
                 chatBtn.dataset.unread = 0;
                 console.log("Chat aberto");
                 atualizarListaFichasChat(); // Garante que a lista est√° atualizada
             } else {
                 alert("Senha do chat incorreta.");
                 const inputSenha = document.getElementById("abrir-chat-senha-input");
                 if (inputSenha) inputSenha.focus(); // Foca no input se errar
             }
         }

        // Fechar Modal do Chat
        function fecharChatModal() {
            fecharModal('chat-modal');
            isChatOpen = false;
            selectedChatUser = null;
            selectedChatUserName = null;
            // Desativa listener de mensagens da conversa atual
            if (chatListener) {
                chatListener.off();
                chatListener = null;
                console.log("Listener de chat removido.");
            }
            console.log("Chat fechado");
            verificarNovasMensagens(); // Reativa verifica√ß√£o de n√£o lidas em background
        }

        // Atualizar Estado do Bot√£o Chat (mantido)
        function atualizarEstadoChatBotao() {
            if (!currentFichaId || currentFichaId === 'ficha-matriz') {
                 chatBtn.textContent = "üí¨ Chat (Selecione Ficha)";
                 chatBtn.disabled = true;
                 chatBtn.style.opacity = 0.6;
                 chatBtn.style.cursor = 'not-allowed';
            } else if (chatPassword) {
                chatBtn.textContent = "üí¨ Chat";
                chatBtn.disabled = false;
                 chatBtn.style.opacity = 1;
                 chatBtn.style.cursor = 'pointer';
            } else {
                chatBtn.textContent = "üí¨ Definir Chat";
                chatBtn.disabled = false;
                 chatBtn.style.opacity = 1;
                 chatBtn.style.cursor = 'pointer';
            }
        }


        // Atualizar Lista de Fichas no Chat (mantido)
        function atualizarListaFichasChat() {
             availableFichasDiv.innerHTML = ""; // Limpa lista
             if (!fichas) return;

             // Adiciona op√ß√£o "Chat Geral" (se desejado)
             // const generalChatDiv = document.createElement("div");
             // generalChatDiv.className = "user-item";
             // generalChatDiv.textContent = "Chat Geral";
             // generalChatDiv.dataset.fichaId = "general";
             // generalChatDiv.onclick = () => iniciarConversa("general", "Chat Geral");
             // availableFichasDiv.appendChild(generalChatDiv);

             // Adiciona outras fichas
             for (const fichaId in fichas) {
                 if (fichaId !== "ficha-matriz" && fichaId !== currentFichaId) {
                     const ficha = fichas[fichaId];
                     const userDiv = document.createElement("div");
                     userDiv.className = "user-item";
                     userDiv.textContent = ficha.nomeFicha || "Sem Nome";
                     userDiv.dataset.fichaId = fichaId;
                     userDiv.onclick = () => iniciarConversa(fichaId, ficha.nomeFicha || "Sem Nome");

                     // Destaca se for a conversa selecionada
                     if(fichaId === selectedChatUser) {
                          userDiv.style.fontWeight = 'bold';
                          userDiv.style.backgroundColor = 'var(--list-item-hover-bg)';
                     }

                     availableFichasDiv.appendChild(userDiv);
                 }
             }
         }

        // Iniciar Conversa (mantido e melhorado)
        function iniciarConversa(otherFichaId, otherFichaNome) {
             console.log(`Iniciando conversa com ${otherFichaNome} (${otherFichaId})`);
             selectedChatUser = otherFichaId;
             selectedChatUserName = otherFichaNome;

             // Atualiza header da conversa
             conversationAreaDiv.innerHTML = `<div class="chat-conversation-header" style="padding-bottom: 10px; border-bottom: 1px solid var(--list-item-border); margin-bottom: 10px; font-weight: bold; color: var(--modal-text);">Conversa com ${otherFichaNome}</div><div id="mensagens" style="flex-grow: 1; overflow-y: auto; display: flex; flex-direction: column;"></div>`; // Container para mensagens

             // Habilita input e bot√£o de enviar
             mensagemInput.disabled = false;
             enviarMensagemBtn.disabled = false;
             mensagemInput.focus();

             // Carrega mensagens da conversa
             carregarMensagens(otherFichaId);

             // Atualiza destaque na lista de usu√°rios
             atualizarListaFichasChat();

              // Limpa notifica√ß√£o n√£o lida para esta conversa espec√≠fica (se houver)
             // (A l√≥gica de n√£o lidas pode ser mais refinada para contar por conversa)
             chatBtn.dataset.unread = Math.max(0, (parseInt(chatBtn.dataset.unread) || 0) - 1); // Simplesmente decrementa
         }


        // Enviar Mensagem (mantido)
        function enviarMensagem() {
             if (!selectedChatUser) {
                 // alert("Selecione uma ficha para enviar a mensagem."); // J√° desabilitado
                 return;
             }
             const mensagem = mensagemInput.value.trim();
             if (mensagem) {
                 const chatKey = getChatId(currentFichaId, selectedChatUser);
                 const chatRef = database.ref('mensagens').child(chatKey).push();
                 chatRef.set({
                     senderId: currentFichaId,
                     senderName: fichas[currentFichaId]?.nomeFicha || 'Desconhecido', // Salva nome do remetente
                     receiverId: selectedChatUser, // Pode ser 'general' ou ID espec√≠fico
                     content: mensagem,
                     timestamp: firebase.database.ServerValue.TIMESTAMP
                 }).then(() => {
                      mensagemInput.value = ""; // Limpa input
                      console.log(`Mensagem enviada para ${chatKey}`);
                 }).catch(error => {
                      console.error("Erro ao enviar mensagem:", error);
                      showNotification("Erro ao enviar mensagem!", "critical-failure");
                 });
             }
         }
        // Enviar com Enter
        mensagemInput.addEventListener('keypress', function (e) {
            if (e.key === 'Enter' && !e.shiftKey && !mensagemInput.disabled) {
                e.preventDefault(); // Impede nova linha
                enviarMensagem();
            }
        });

        // Carregar Mensagens (mantido e melhorado)
        function carregarMensagens(otherFichaId) {
             const mensagensDiv = document.getElementById("mensagens");
             if (!mensagensDiv) {
                 console.error("Elemento #mensagens n√£o encontrado.");
                 return;
             }
             mensagensDiv.innerHTML = ""; // Limpa mensagens antigas da UI

             // Remove listener antigo, se existir
             if (chatListener) {
                 chatListener.off();
                 console.log("Listener de chat anterior removido.");
             }

             const chatKey = getChatId(currentFichaId, otherFichaId);
             console.log(`Carregando mensagens para ${chatKey}`);
             chatListener = database.ref('mensagens').child(chatKey).orderByChild('timestamp').limitToLast(50); // Limita as √∫ltimas 50

             chatListener.on('child_added', snapshot => {
                 const mensagemData = snapshot.val();
                 if (!mensagemData) return;

                 const messageContainer = document.createElement("div");
                 messageContainer.className = "message-container";

                 const senderNameDiv = document.createElement("div");
                 senderNameDiv.className = "sender-name";
                 // Usa nome salvo ou busca no objeto 'fichas' como fallback
                 senderNameDiv.textContent = mensagemData.senderName || fichas[mensagemData.senderId]?.nomeFicha || 'Desconhecido';

                 const mensagemDiv = document.createElement("div");
                 mensagemDiv.className = `message ${mensagemData.senderId === currentFichaId ? 'sent' : 'received'}`;
                 mensagemDiv.textContent = mensagemData.content; // Cuidado com HTML injection se permitir HTML

                 // Adiciona timestamp (opcional)
                 const timestampDiv = document.createElement("div");
                 timestampDiv.style.fontSize = '0.7rem';
                 timestampDiv.style.color = 'var(--text-color)';
                 timestampDiv.style.opacity = '0.6';
                 timestampDiv.style.marginTop = '2px';
                 timestampDiv.textContent = mensagemData.timestamp ? new Date(mensagemData.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '';

                 // Monta a estrutura da mensagem
                 if (mensagemData.senderId === currentFichaId) {
                      messageContainer.style.alignItems = 'flex-end'; // Alinha nome e msg √† direita
                      mensagemDiv.appendChild(timestampDiv); // Timestamp dentro da bolha enviada
                      messageContainer.appendChild(senderNameDiv);
                      messageContainer.appendChild(mensagemDiv);
                 } else {
                      messageContainer.style.alignItems = 'flex-start'; // Alinha nome e msg √† esquerda
                      mensagemDiv.appendChild(timestampDiv); // Timestamp dentro da bolha recebida
                      messageContainer.appendChild(senderNameDiv);
                      messageContainer.appendChild(mensagemDiv);
                 }


                 mensagensDiv.appendChild(messageContainer);

                 // Auto-scroll para a √∫ltima mensagem
                 mensagensDiv.scrollTop = mensagensDiv.scrollHeight;
             });
         }

        // Gerar ID do Chat (mantido)
        function getChatId(id1, id2) {
            // Trata chat geral separadamente
            if (id1 === 'general' || id2 === 'general') return 'general_chat';
            // Ordena IDs para consist√™ncia
            return id1 < id2 ? `${id1}_${id2}` : `${id2}_${id1}`;
        }

        // Verificar Novas Mensagens (mantido e ajustado)
        let globalMessagesListener = null; // Listener global para notifica√ß√µes
         function verificarNovasMensagens() {
             if (!currentFichaId || currentFichaId === 'ficha-matriz') return;

             // Remove listener global antigo se existir
             if (globalMessagesListener) {
                  globalMessagesListener.off();
             }

             globalMessagesListener = database.ref('mensagens');
             globalMessagesListener.on('value', (snapshot) => {
                 if (!snapshot.exists() || !currentFichaId || currentFichaId === 'ficha-matriz') {
                      chatBtn.dataset.unread = 0;
                      return; // Sai se n√£o h√° mensagens ou ficha inv√°lida
                 }

                 let unreadCount = 0;
                 let lastMessageTimestamp = 0; // Para tocar som apenas uma vez por leva
                 let shouldPlaySound = false;

                 snapshot.forEach((chatSnapshot) => {
                     const chatId = chatSnapshot.key;
                     // Verifica se o chat ID pertence √† ficha atual (privado ou geral)
                     if (chatId === 'general_chat' || chatId.includes(currentFichaId)) {
                         chatSnapshot.forEach((mensagemSnapshot) => {
                             const msg = mensagemSnapshot.val();
                             const msgKey = mensagemSnapshot.key; // Chave √∫nica da mensagem

                             // Verifica se a mensagem √© para o usu√°rio atual e n√£o foi enviada por ele
                             if (msg && msg.receiverId === currentFichaId && msg.senderId !== currentFichaId) {
                                  // Verifica se a mensagem j√° foi 'vista' (simplificado: se o chat est√° aberto com aquele user)
                                  const isChattingWithSender = isChatOpen && selectedChatUser === msg.senderId;
                                  if (!isChattingWithSender) {
                                       // Aqui, idealmente, verificar√≠amos um timestamp de 'lastRead' por chat
                                       // Por simplicidade, contamos todas como n√£o lidas se o chat n√£o estiver aberto com o remetente
                                       unreadCount++;
                                       if (msg.timestamp > lastMessageTimestamp) {
                                            lastMessageTimestamp = msg.timestamp;
                                            shouldPlaySound = true; // Marcar para tocar som para a mensagem mais recente
                                       }
                                  }
                             }
                             // Adicionar l√≥gica para chat geral se implementado
                             // else if (chatId === 'general_chat' && msg.senderId !== currentFichaId) { ... }
                         });
                     }
                 });

                 // Atualiza contador visual
                 chatBtn.dataset.unread = unreadCount > 0 ? unreadCount : 0;

                 // Toca som apenas se houver novas mensagens e o som n√£o tiver tocado recentemente
                 if (shouldPlaySound && newMessageSound.paused) {
                      newMessageSound.play().catch(e => console.warn("Erro ao tocar som de notifica√ß√£o:", e));
                 }
             });
         }

        // --- Inicializa√ß√£o ---
        carregarFichas(); // Inicia o carregamento das fichas

    </script>
</body>
</html>
