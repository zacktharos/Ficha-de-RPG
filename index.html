<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ficha de Personagem RPG</title>
    <link href="https://fonts.googleapis.com/css2?family=MedievalSharp&family=Inter:wght@400;600&family=Times+New+Roman&family=Arial&family=Courier+New&family=Georgia&family=Verdana&family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --cor-borda-secao: #b8860b;
            --estilo-borda-secao: solid;
            --largura-borda-secao: 2px;
            --ficha-internal-glow: transparent 0 0 0 0 inset; /* Default no glow/shadow */
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0e6d2; /* Cor padrão modo claro */
            color: #000;
            display: flex;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            background-image: none;
            background-size: cover;
            background-position: center;
            background-attachment: scroll;
            transition: background-color 0.3s, color 0.3s, font-family 0.3s, box-shadow 0.3s;
            box-shadow: none; /* Ensure no body glow by default */
        }
        body.dark-mode {
            background-color: #121212 !important; /* Cor padrão modo escuro */
            color: #e0e0e0;
            box-shadow: none; /* Ensure no body glow in dark mode */
        }
        #fichas-sidebar {
            width: 100%; height: 60px; padding: 0; display: flex; flex-direction: row;
            align-items: center; justify-content: flex-start; position: fixed;
            top: 0; left: 0; z-index: 1000; overflow-x: auto; background: transparent;
        }
        .ficha-tab {
            visibility: visible; width: 100px; height: 50px; background: #f0e6d2;
            border: 2px solid #b8860b; border-radius: 10px 10px 0 0; margin-right: 10px;
            display: flex; align-items: center; justify-content: center; cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.2);
        }
        .ficha-tab:hover, .ficha-tab.active { background: #a0522d; transform: translateY(-5px); }
        .ficha-tab span {
            font-family: 'MedievalSharp', serif; color: #000; font-size: 0.9rem; text-align: center;
            max-width: 90px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
        }
        #add-ficha-btn {
            width: 100px; height: 50px; background: #f0e6d2; border: 2px solid #b8860b;
            border-radius: 10px 10px 0 0; margin-right: 10px; display: flex; align-items: center;
            justify-content: center; cursor: pointer; transition: transform 0.2s ease;
            box-shadow: 0 0 10px #ffd700, 0 0 20px #ffd700; z-index: 1001;
        }
        #add-ficha-btn span { font-family: 'MedievalSharp', serif; color: #000; font-size: 0.9rem; }
        #add-ficha-btn:hover { background: #a0522d; transform: translateY(-5px); }
        #ficha-container {
            background: #f0e6d2;
            padding: 30px; border-radius: 12px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2), var(--ficha-internal-glow); /* MODIFIED: Uses var for internal shadow */
            width: 95%; max-width: 1200px;
            margin: 80px auto 20px; border: 2px solid #b8860b; position: relative; z-index: 1;
            transition: font-family 0.3s, background-color 0.3s, box-shadow 0.3s, border 0.3s;
        }
        body.dark-mode #ficha-container {
            background: #121212; /* Dark mode ficha background */
            color: #e0e0e0;
            /* The var(--ficha-internal-glow) will be transparent in dark mode via JS */
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2), var(--ficha-internal-glow);
        }

        @keyframes pulsar-aura { /* Used for Nivel 30+ Ficha Aura */
            0% { box-shadow: 0 0 20px #00BFFF, 0 0 30px #00BFFF, 0 0 40px #00BFFF, var(--ficha-internal-glow); }
            50% { box-shadow: 0 0 30px #00BFFF, 0 0 50px #00BFFF, 0 0 60px #00BFFF, var(--ficha-internal-glow); }
            100% { box-shadow: 0 0 20px #00BFFF, 0 0 30px #00BFFF, 0 0 40px #00BFFF, var(--ficha-internal-glow); }
        }
        #ficha-container.aura-azul {
            animation: pulsar-aura 2s infinite;
        }

        h1#nome-personagem-titulo {
            font-family: 'MedievalSharp', serif; color: #1C2526; font-size: 3rem; margin-bottom: 20px;
            text-align: center; text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1); animation: raios 2s infinite linear;
             transition: color 0.3s, text-shadow 0.3s;
        }
        body.dark-mode h1#nome-personagem-titulo {
             color: #c58c5a;
        }
        @keyframes raios {
            0% { text-shadow: 0 0 5px #FFD700, 0 0 10px #FFD700, 0 0 15px #FFD700, 0 0 20px #FF4500; }
            50% { text-shadow: 0 0 10px #FFD700, 0 0 15px #FFD700, 0 0 20px #FF4500, 0 0 25px #FF4500; }
            100% { text-shadow: 0 0 5px #FFD700, 0 0 10px #FFD700, 0 0 15px #FFD700, 0 0 20px #FF4500; }
        }
        #game-master-message { display: none; color: blue; font-size: 1.5rem; text-align: center; font-family: 'MedievalSharp', serif; margin-bottom: 10px; }

        section {
            border-width: var(--largura-borda-secao);
            border-style: var(--estilo-borda-secao);
            border-color: var(--cor-borda-secao);
            border-radius: 8px; padding: 15px; margin-bottom: 20px;
            transition: background-color 0.3s, box-shadow 0.3s, border 0.3s; /* Added box-shadow transition for section shadow */
            /* box-shadow is now controlled by JS for sections */
        }
        body.dark-mode section {
             border-color: #555; /* Default dark mode border for sections */
             /* background-color will be set by JS to dark mode default */
             /* box-shadow will be set to none by JS in dark mode */
        }


        section h2 {
            text-align: center; font-family: 'MedievalSharp', serif; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
             transition: color 0.3s;
        }
        section h2 .collapse-icon { margin-left: 10px; font-size: 1.2rem; transition: transform 0.2s; }
        section .section-content.collapsed { display: none; }
        section h2 .collapse-icon.collapsed { transform: rotate(-90deg); }

        label { font-weight: 600; color: #000; margin-bottom: 8px; display: block;  transition: color 0.3s; }
        body.dark-mode label { color: #e0e0e0; }
        input[type="text"], input[type="number"], textarea, select {
            padding: 10px; border: 2px solid #b8860b; border-radius: 6px; width: calc(100% - 24px);
            margin-bottom: 15px; font-size: 1rem; transition: border-color 0.3s ease, background-color 0.3s, color 0.3s;
            background: #fff; color: #000;
        }
        .recurso-atual-input {
            width: 70px !important;
            text-align: center;
            font-family: 'MedievalSharp', serif;
            font-size: 1.1rem;
            padding: 5px 2px;
            margin: 0 3px !important;
            -moz-appearance: textfield;
            box-sizing: border-box;
        }
        .recurso-atual-input::-webkit-outer-spin-button,
        .recurso-atual-input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        body.dark-mode input[type="text"], body.dark-mode input[type="number"], body.dark-mode textarea, body.dark-mode select {
            background: #333; color: #e0e0e0; border-color: #555;
        }
        input[type="text"]:focus, input[type="number"]:focus, textarea:focus, select:focus {
            border-color: #a0522d; outline: none; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        input[readonly], span[readonly] { background: #e8e8e8; border: 1px solid #ccc; cursor: not-allowed; }
        body.dark-mode input[readonly], body.dark-mode span[readonly] { background: #444; border-color: #666; }
        textarea { resize: vertical; }
        .atributos-container { display: flex; justify-content: space-between; gap: 20px; }
        .atributos-coluna, .atributos-coluna-destaque {
            width: 48%; display: flex; flex-direction: column; align-items: flex-start;
            transition: background-color 0.3s, border-color 0.3s;
        }
        .atributos-coluna-destaque { background: #fff; padding: 10px; border-radius: 6px; border: 1px solid #b8860b; }
        body.dark-mode .atributos-coluna-destaque { background: #333; border-color: #555; }
        .atributo-destaque { padding: 8px; margin-bottom: 10px; display: flex; align-items: center; justify-content: space-between; width: 100%; }
        .atributo-destaque label { font-size: 1.1rem; font-weight: 700; color: #a0522d; }
        .atributo-destaque span { font-size: 1.2rem; font-family: 'MedievalSharp', serif; color: #000; transition: color 0.3s; }
        body.dark-mode .atributo-destaque span { color: #e0e0e0; }
        .atributo-fogo { animation: fogo 1.5s infinite; }
        @keyframes fogo {
            0% { text-shadow: 0 0 5px #ff4500, 0 0 10px #ff4500; }
            50% { text-shadow: 0 0 10px #ff4500, 0 0 15px #ffd700; }
            100% { text-shadow: 0 0 5px #ff4500, 0 0 10px #ff4500; }
        }
        .vida-magia-vigor { display: flex; justify-content: space-around; gap: 15px; flex-wrap: wrap; }
        .atributo-container {
            background: rgba(255, 255, 255, 0.8); padding: 12px; border-radius: 8px; border: 1px solid #b8860b;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); width: 30%; min-width: 200px; text-align: center;
             transition: background-color 0.3s, border-color 0.3s, box-shadow 0.3s;
        }
        body.dark-mode .atributo-container { background: rgba(50, 50, 50, 0.8); } /* Will be overridden by JS if fichaInternalBackground is dark mode default */
        .atributo-container::before { font-size: 1.5rem; margin-bottom: 5px; display: block; }
        .atributo-container.vida::before { content: "❤️"; }
        .atributo-container.magia::before { content: "✨"; }
        .atributo-container.vigor::before { content: "⚡"; }
        .medieval-box { background: #f0e6d2; border: 2px solid #b8860b; border-radius: 8px; padding: 10px; margin: 5px 0; text-align: center; transition: background-color 0.3s, border-color 0.3s;}
        body.dark-mode .medieval-box { background: #1e1e1e; border-color: #444; }
        .valor-atual.medieval-box { display: flex; align-items: center; justify-content: center; }

        .regeneracao { font-size: 0.8rem; color: #555; margin-top: 5px; transition: color 0.3s; }
        body.dark-mode .regeneracao { color: #aaa; }
        button {
            background: #b8860b; color: #fff; border: none; padding: 5px 10px;
            cursor: pointer; font-size: 1.2rem; border-radius: 4px; margin: 0 5px;
            transition: background-color 0.3s ease, transform 0.1s ease, box-shadow 0.1s ease, color 0.3s;
        }
        body.dark-mode button { background: #555; }
        button:hover { background: #a0522d; }
        body.dark-mode button:hover { background: #777; }

        .button-clicked {
            transform: scale(0.97);
            box-shadow: inset 1px 1px 3px rgba(0,0,0,0.3);
        }

        .botoes-container { display: flex; justify-content: center; gap: 10px; margin-top: 20px; margin-bottom: 20px; flex-wrap: wrap; }
        .botao {
            padding: 12px 25px; border: none; border-radius: 6px; font-size: 1rem; cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.1s ease, color 0.3s, text-shadow 0.3s, border 0.3s;
            font-family: 'MedievalSharp', serif;
            color: #fff; text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
        }
        body.dark-mode .botao { background: #555; }
        body.dark-mode .botao:hover { background: #777; }
        #reset-pontos, #recomecar, #bloquear-ficha, #excluir-ficha, #gm-mode-btn, #customizacao-btn {
            background-color: #800000;
        }
        .botao-reset:hover, .botao-recomecar:hover, .botao-bloquear:hover, .botao-desbloquear:hover, #excluir-ficha:hover, #gm-mode-btn:hover, #customizacao-btn:hover {
            background: #a0522d; transform: translateY(-2px);
        }
        #gm-mode-btn.gm-active { background-color: #006400; }

        .icon-btn {
            padding: 10px; width: 44px; height: 44px;
            font-size: 1.2rem; line-height: 1; text-align: center;
        }
        #lua-btn { background-color: #333; color: #eee; }
        #sol-btn { background-color: #ffdd00; color: #333; }
        #nivel-container { text-align: center; margin-top: 10px; }
        #nivel {
            padding: 10px; background: #f0e6d2; border: 3px solid #000; border-radius: 50%;
            width: 100px; height: 100px; display: flex; align-items: center; justify-content: center;
            font-size: 3.125rem; box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.5); margin: 0 auto;
            font-family: 'MedievalSharp', serif;
             transition: background-color 0.3s, border-color 0.3s, box-shadow 0.3s;
        }
        body.dark-mode #nivel { background: #1e1e1e; border-color: #444; }
        #nivel.aura-azul { animation: pulsar-aura 5s 1; }
        .expandable-textarea {
            height: 100px; width: 100%; background: #fff; border: 2px solid #b8860b;
            border-radius: 6px; padding: 10px; font-size: 0.9rem; transition: height 0.3s ease, background-color 0.3s, border-color 0.3s;
        }
        body.dark-mode .expandable-textarea { background: #333; }
        .expandable-textarea:focus { height: 15cm; }

        #dice-container {
            position: absolute; top: 20px; right: 20px; width: auto;
            text-align: center;
            font-family: 'MedievalSharp', serif; cursor: move; z-index: 10; user-select: none;
            perspective: 800px;
        }
        #dice-container label { font-size: 1.2rem; color: #000; display: flex; align-items: center; justify-content: center; margin-bottom: 10px; }
        body.dark-mode #dice-container label { color: #e0e0e0; }
        #dice-container label::before { content: "🎲"; margin-right: 5px; font-size: 1.5rem; }

        .dice-roll-area { display: flex; align-items: center; justify-content: center; gap: 10px; position: relative;}

        #dice-roll {
            width: 100px; height: 100px;
            background-color: var(--dice-bg-color, #f0e6d2);
            color: var(--dice-number-color, #000000);
            border: 2px solid #b8860b;
            border-radius: 10px;
            display: flex; align-items: center; justify-content: center;
            font-size: 2.5rem;
            cursor: pointer;
            margin: 0;
            position: relative;
            transition: transform 0.3s ease, box-shadow 0.3s ease, background-color 0.3s, color 0.3s, background-image 0.3s, border-color 0.3s;
            font-family: 'MedievalSharp', serif;
            transform-style: preserve-3d;
            background-size: cover;
            background-position: center;
        }
        body.dark-mode #dice-roll { border-color: #444; }

        #dice-roll.is-rolling { animation: rollTheDie 1s ease-out forwards; }
        #dice-roll.is-rolling-fast { animation: rollTheDieFast 0.5s ease-out forwards; }
        #dice-roll.is-rolling-jump { animation: rollTheDieJump 1.2s cubic-bezier(0.5, -0.5, 0.5, 1.5) forwards; }

        @keyframes rollTheDie {
            0% { transform: rotateX(0deg) rotateY(0deg) rotateZ(0deg) scale(1); box-shadow: 0 0 5px #b8860b; }
            25% { transform: rotateX(360deg) rotateY(-270deg) rotateZ(180deg) scale(1.1) translateX(-10px) translateY(5px); box-shadow: 0 0 10px #a0522d, 0 0 15px #FFD700; }
            50% { transform: rotateX(-180deg) rotateY(360deg) rotateZ(-360deg) scale(0.9) translateX(10px) translateY(-10px); box-shadow: 0 0 15px #b8860b, 0 0 20px #a0522d; }
            75% { transform: rotateX(270deg) rotateY(-180deg) rotateZ(270deg) scale(1.05) translateX(-5px) translateY(8px); box-shadow: 0 0 10px #FFD700, 0 0 15px #a0522d; }
            100% { transform: rotateX(0deg) rotateY(0deg) rotateZ(0deg) scale(1); box-shadow: 0 0 5px #b8860b; }
        }
        @keyframes rollTheDieFast {
            0% { transform: rotateZ(0deg) scale(1); }
            100% { transform: rotateZ(720deg) scale(1); }
        }
        @keyframes rollTheDieJump {
            0% { transform: translateY(0) rotate(0deg) scale(1); }
            25% { transform: translateY(-30px) rotate(180deg) scale(1.2); }
            50% { transform: translateY(0) rotate(360deg) scale(1); }
            75% { transform: translateY(-15px) rotate(540deg) scale(1.1); }
            100% { transform: translateY(0) rotate(720deg) scale(1); }
        }

        #dice-result { margin-top: 10px; font-size: 1rem; color: #000; display: none; animation: blink 1s infinite; transition: color 0.3s; }
        body.dark-mode #dice-result { color: #e0e0e0; }
        @keyframes blink { 50% { opacity: 0; } }

        #dice-roll.critical-failure { animation: aura-vermelha 0.5s 4; }
        #dice-roll.critical-success { animation: aura-verde 0.5s 4; }
        @keyframes aura-vermelha {
            0%, 100% { box-shadow: 0 0 5px #ff0000, 0 0 10px #ff0000, 0 0 15px #ff0000 !important; }
            50% { box-shadow: 0 0 20px #ff0000, 0 0 30px #ff0000, 0 0 40px #ff0000 !important; }
        }
        @keyframes aura-verde {
            0%, 100% { box-shadow: 0 0 5px #00ff00, 0 0 10px #00ff00, 0 0 15px #00ff00 !important; }
            50% { box-shadow: 0 0 20px #00ff00, 0 0 30px #00ff00, 0 0 40px #00ff00 !important; }
        }

        #change-dice-type-btn {
            background-color: #d2b48c; color: #3a2800; border: 1px solid #b8860b;
            width: 55px; height: 36px; font-size: 0.9rem; padding: 5px;
            box-sizing: border-box;
             transition: background-color 0.3s, color 0.3s, border-color 0.3s;
        }
        body.dark-mode #change-dice-type-btn { background-color: #4a3c2a; color: #f0e6d2; border-color: #6b5230; }

        #dice-options-menu {
            display: none;
            position: absolute;
            top: 40px;
            right: 0;
            background-color: #f0e6d2;
            border: 1px solid #b8860b;
            border-radius: 4px;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.2);
            z-index: 110;
            padding: 5px;
            flex-direction: column;
            gap: 5px;
             transition: background-color 0.3s, border-color 0.3s;
        }
        body.dark-mode #dice-options-menu { background-color: #1e1e1e; border-color: #444; }
        .dice-option-btn {
            width: 100%;
            padding: 8px 10px;
            font-size: 0.9rem;
            background-color: #e6cca7; color: #3a2800;
            border: 1px solid #b8860b; border-radius: 3px;
            text-align: center;
            margin:0;
             transition: background-color 0.3s, color 0.3s, border-color 0.3s;
        }
        .dice-option-btn:hover { background-color: #d2b48c; }
        body.dark-mode .dice-option-btn { background-color: #3a2f1e; color: #f0e6d2; border-color: #5c4b35; }
        body.dark-mode .dice-option-btn:hover { background-color: #4a3c2a; }

        #fireworks-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 0; pointer-events: none; overflow: hidden;
        }
        .firework-particle {
            position: absolute; border-radius: 50%; opacity: 1;
        }
        @keyframes particle-trail {
            0% { opacity: 1; transform: scale(1) translateY(0px); }
            50% { opacity: 0.7; }
            100% { opacity: 0; transform: scale(0.3) translateY(40px); }
        }

        #dice-history-trigger {
            position: fixed;
            top: calc(50% + 70px);
            right: 10px;
            transform: translateY(-50%);
            padding: 10px 15px;
            background: #a0522d;
            color: white;
            border: 2px solid #b8860b;
            border-right: none;
            border-radius: 6px 0 0 6px;
            font-family: 'MedievalSharp', serif;
            font-size: 1rem;
            cursor: pointer;
            z-index: 1000;
            writing-mode: vertical-rl;
            text-orientation: mixed;
            transition: background-color 0.3s, border-color 0.3s;
        }
        body.dark-mode #dice-history-trigger { background-color: #555; border-color: #444;}

        #dice-history-panel {
            position: fixed;
            right: 50px;
            top: calc(50% + 70px);
            transform: translateY(-50%);
            width: 400px;
            max-height: 400px;
            background: #fff;
            border: 2px solid #b8860b;
            border-radius: 6px;
            padding: 15px;
            font-size: 0.9rem;
            z-index: 1001;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            display: none;
            flex-direction: column;
            transition: background-color 0.3s, border-color 0.3s, color 0.3s;
        }
        body.dark-mode #dice-history-panel { background: #333; color: #e0e0e0; border-color: #555;}

        #dice-history-panel h2 {
            font-family: 'MedievalSharp', serif; font-size: 1.5rem; text-align: center;
            color: #a0522d; margin-bottom: 10px; flex-shrink: 0; transition: color 0.3s;
        }
        body.dark-mode #dice-history-panel h2 { color: #c58c5a;}

        #dice-history-list {
            flex-grow: 1;
            overflow-y: auto;
            background: #f9f2e7;
            border: 1px solid #b8860b;
            border-radius: 4px;
            padding: 8px;
            margin-bottom: 10px;
             transition: background-color 0.3s, border-color 0.3s;
        }
        body.dark-mode #dice-history-list { background: #2a2a2a; border-color: #555; }
        .dice-history-item {
            padding: 6px 4px;
            border-bottom: 1px dashed #d2b48c;
            font-size: 0.9rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: border-bottom-color 0.3s;
        }
        body.dark-mode .dice-history-item { border-bottom-color: #4a3c2a; }
        .dice-history-item:last-child { border-bottom: none; }
        .dice-history-item .timestamp { font-size: 0.7rem; color: #777; margin-left: 8px; white-space: nowrap; transition: color 0.3s; }
        body.dark-mode .dice-history-item .timestamp { color: #aaa; }

        .dice-history-buttons { display: flex; justify-content: space-between; margin-top: auto; flex-shrink: 0;}
        #fechar-historico-btn, #limpar-historico-btn {
            padding: 8px 15px; font-size: 0.9rem; flex-basis: 48%;
        }
        #limpar-historico-btn { background-color: #800000; }
        #limpar-historico-btn:hover { background-color: #a00000; }
        body.dark-mode #limpar-historico-btn { background-color: #400000;}
        body.dark-mode #limpar-historico-btn:hover { background-color: #600000;}

        #notification {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); padding: 20px;
            border-radius: 8px; font-family: 'MedievalSharp', serif; font-size: 1.5rem; color: #fff;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5); display: none; z-index: 2000;
            background: rgba(0, 0, 0, 0.7); transition: opacity 0.3s ease;
        }
        #notification.critical-failure { background: rgba(255, 0, 0, 0.8); animation: aura-vermelha 2s infinite; }
        #notification.critical-success { background: rgba(0, 255, 0, 0.8); animation: aura-verde 2s infinite; }
        #notification.normal-result { animation: blink 1s infinite; }
        #notification.save-success { background: rgba(0, 200, 0, 0.8); }

        #character-image-container {
            position: absolute; top: 10px; left: 10px; width: 100px; height: 100px; background: #f0e6d2;
            border: 2px solid #b8860b; border-radius: 8px; display: flex; align-items: center;
            justify-content: center; cursor: pointer; overflow: hidden; z-index: 10;
            transition: background-color 0.3s, border-color 0.3s;
        }
        body.dark-mode #character-image-container { background: #1e1e1e; }
        #character-image { width: 100%; height: 100%; object-fit: cover; display: none; }
        #character-image-container:hover { box-shadow: 0 0 10px #ffd700; }
        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.5); justify-content: center; align-items: center; z-index: 1000;
        }
        .modal-content {
            background: #f0e6d2; padding: 20px; border-radius: 8px; border: 2px solid #b8860b;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3); width: 300px; text-align: center;
            transition: background-color 0.3s, border-color 0.3s;
        }
        body.dark-mode .modal-content { background: #1e1e1e; border-color: #444; }
        .modal-content h3 { font-family: 'MedievalSharp', serif; color: #000; margin-bottom: 15px; transition: color 0.3s; }
        body.dark-mode .modal-content h3 { color: #e0e0e0; }
        .modal-content input, .modal-content select {
            width: calc(100% - 20px); padding: 10px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 6px;
        }
        body.dark-mode .modal-content input, body.dark-mode .modal-content select { background: #333; color: #e0e0e0; border-color: #555; }
        .modal-content button {
            padding: 10px 20px; border: none; border-radius: 6px; font-family: 'MedievalSharp', serif;
            color: #fff; cursor: pointer; margin: 0 5px;
        }
        .modal-content .confirm-btn { background: #b8860b; }
        .modal-content .confirm-btn:hover { background: #a0522d; }
        .modal-content .cancel-btn { background: #a52a2a; }
        .modal-content .cancel-btn:hover { background: #8b0000; }

        #customizacao-modal .modal-content {
            width: 550px;
            max-height: 90vh;
            overflow-y: auto;
            text-align: left;
        }
        #customizacao-modal .modal-content h3 {
            text-align: center;
            font-size: 1.8rem;
            color: #a0522d;
        }
        body.dark-mode #customizacao-modal .modal-content h3 { color: #c58c5a;}

        #customizacao-modal fieldset {
            border: 1px solid #b8860b;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 20px;
            transition: border-color 0.3s;
        }
        body.dark-mode #customizacao-modal fieldset { border-color: #555; }

        #customizacao-modal legend {
            font-family: 'MedievalSharp', serif;
            font-size: 1.3rem;
            color: #800000;
            padding: 0 10px;
            font-weight: bold;
            transition: color 0.3s;
        }
        body.dark-mode #customizacao-modal legend { color: #d2b48c;}

        #customizacao-modal .input-group {
            margin-bottom: 15px;
        }
        #customizacao-modal .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: normal;
        }
        #customizacao-modal .input-group input[type="color"],
        #customizacao-modal .input-group input[type="file"],
        #customizacao-modal .input-group select,
        #customizacao-modal .input-group input[type="number"],
        #customizacao-modal .input-group input[type="range"] {
            width: 100%;
            box-sizing: border-box;
        }

        #customizacao-modal .radio-group label {
            display: inline-block;
            margin-right: 15px;
            font-weight: normal;
        }
        #customizacao-modal .radio-group input[type="radio"] {
           width: auto;
           margin-right: 5px;
        }
        #customizacao-modal .custom-dice-texture-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }
        #customizacao-modal .custom-dice-texture-controls button {
            flex-shrink: 0;
        }


        #vantagens-desvantagens-btn, #racas-btn, #classes-btn {
            padding: 10px 20px; background: #f0e6d2; border: 2px solid #b8860b; border-radius: 6px;
            font-family: 'MedievalSharp', serif; font-size: 1rem; color: #000; cursor: pointer;
            transition: background-color 0.3s ease, border-color 0.3s, color 0.3s; z-index: 10;
        }
        body.dark-mode #vantagens-desvantagens-btn, body.dark-mode #racas-btn, body.dark-mode #classes-btn {
            background: #1e1e1e; color: #e0e0e0;
        }
        #vantagens-desvantagens-btn:hover, #racas-btn:hover, #classes-btn:hover { background: #a0522d; color: #fff; }
        #vantagens-desvantagens-panel, #racas-panel, #classes-panel {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(240, 230, 210, 0.95); padding: 20px; overflow-y: auto; z-index: 999;
            border: 2px solid #b8860b; box-shadow: 0 0 20px rgba(0, 0, 0, 0.3);
             transition: background-color 0.3s, border-color 0.3s;
        }
        body.dark-mode #vantagens-desvantagens-panel, body.dark-mode #racas-panel, body.dark-mode #classes-panel {
            background: rgba(30, 30, 30, 0.95);
        }
        #vantagens-desvantagens-panel h2, #racas-panel h2, #classes-panel h2 {
            font-family: 'MedievalSharp', serif; font-size: 2rem; text-align: center;
            color: #a0522d; margin-bottom: 20px; transition: color 0.3s;
        }
        #racas-panel h2 { font-size: 3rem; }
        .vantagem-item, .desvantagem-item, .raca-item {
            padding: 10px; margin: 5px 0; background: #fff; border: 1px solid #ccc;
            border-radius: 6px; cursor: pointer; transition: background-color 0.3s ease, border-color 0.3s, color 0.3s;
        }
        body.dark-mode .vantagem-item, body.dark-mode .desvantagem-item, body.dark-mode .raca-item {
            background: #333; border-color: #555;
        }
        .vantagem-item:hover, .desvantagem-item:hover, .raca-item:hover { background: #f0e6d2; }
        body.dark-mode .vantagem-item:hover, body.dark-mode .desvantagem-item:hover, body.dark-mode .raca-item:hover { background: #444; }
        .vantagem-item.comprada, .raca-item.comprada { background: #ffcccc; color: #f00; cursor: default; }
        .desvantagem-item.comprada { background: #ccffcc; color: #080; cursor: default; }
        #salvar-vantagens-btn, #salvar-racas-btn, #fechar-pagina-btn, #fechar-racas-btn, #fechar-classes-btn {
            position: fixed; bottom: 20px; padding: 12px 25px; background: #a52a2a; color: #fff;
            border: none; border-radius: 6px; font-family: 'MedievalSharp', serif; font-size: 1.2rem;
            cursor: pointer; transition: transform 0.2s ease, background-color 0.3s;
        }
        #salvar-vantagens-btn, #salvar-racas-btn { right: 250px; animation: aura-verde-btn 2s infinite; display: none; background: #000; }
        #fechar-pagina-btn, #fechar-racas-btn, #fechar-classes-btn { right: 20px; }
        #salvar-vantagens-btn:hover, #salvar-racas-btn:hover, #fechar-pagina-btn:hover, #fechar-racas-btn:hover, #fechar-classes-btn:hover {
            transform: translateY(-2px);
        }
        @keyframes aura-verde-btn {
            0% { box-shadow: 0 0 5px #00ff00, 0 0 10px #00ff00; }
            50% { box-shadow: 0 0 15px #00ff00, 0 0 20px #00ff00; }
            100% { box-shadow: 0 0 5px #00ff00, 0 0 10px #00ff00; }
        }
        .locomotion-container { background: #8B4513; border: 3px solid #FFD700; border-radius: 10px; padding: 15px; color: #FFD700; font-family: 'MedievalSharp', serif; transition: background-color 0.3s, border-color 0.3s, color 0.3s; }
        .locomotion-item { display: flex; align-items: center; margin-bottom: 10px; }
        .locomotion-item label { font-weight: bold; color: #FFD700; }
        .locomotion-item span { font-size: 1.2rem; color: #FFF; text-shadow: 1px 1px 2px #000; margin-left: 5px; font-weight: bold; }
        #distancia-pulo, #altura-pulo, #velocidade-corrida { background-color: #8B4513; border-color: #8B4513; }
        .list-display { background: #fff; border: 2px solid #b8860b; border-radius: 6px; padding: 10px; min-height: 100px; max-height: 200px; overflow-y: auto;  transition: background-color 0.3s, border-color 0.3s;}
        body.dark-mode .list-display { background: #333; border-color: #555; }
        .list-item { cursor: pointer; margin-bottom: 5px; padding: 5px; border-bottom: 1px solid #ccc; transition: border-color 0.3s;}
        body.dark-mode .list-item { border-color: #555; }
        .list-item:hover { background: #e0e0e0; }
        body.dark-mode .list-item:hover { background: #444; }
        .inventory-slot { display: flex; align-items: center; margin-bottom: 10px; }
        .inventory-slot input[type="text"] { flex-grow: 1; margin-right: 10px; }
        .inventory-slot input[type="number"] { width: 60px; }
        #anotacoes-btn {
            position: fixed; left: 10px; top: 50%; transform: translateY(-50%); padding: 10px 15px;
            background: #f0e6d2; border: 2px solid #b8860b; border-left: none;
            border-radius: 0 6px 6px 0;
            font-family: 'MedievalSharp', serif; font-size: 1rem; color: #000; cursor: pointer;
            transition: background-color 0.3s ease, border-color 0.3s; z-index: 1000;
            writing-mode: vertical-rl; text-orientation: mixed;
        }
        body.dark-mode #anotacoes-btn { background: #1e1e1e; color: #e0e0e0; border-color: #444;}
        #anotacoes-btn:hover { background: #a0522d; color: #fff; }
        #anotacoes-textarea {
            display: none; position: fixed; left: 50px;
            top: 50%; transform: translateY(-50%);
            width: 400px; height: 400px; background: #fff; border: 2px solid #b8860b;
            border-radius: 6px; padding: 10px; font-size: 0.9rem; resize: none; z-index: 1001;
             transition: background-color 0.3s, border-color 0.3s, color 0.3s;
        }
        body.dark-mode #anotacoes-textarea { background: #333; color: #e0e0e0; }

        /*******************************************************
        *      STYLES FOR UPGRADED MAGIC SYSTEM START HERE     *
        ********************************************************/

        .magias-container {
            max-height: 400px; /* Increased height */
            overflow-y: auto;
            border: 2px solid #b8860b;
            border-radius: 6px;
            padding: 10px;
            background: #fff;
            transition: background-color 0.3s, border-color 0.3s;
        }
        body.dark-mode .magias-container { background: #333; border-color: #555; }

        .magia-item {
            display: flex;
            flex-direction: column;
            gap: 5px;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px dashed #b8860b;
        }
         body.dark-mode .magia-item { border-bottom-color: #555; }
        .magia-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        .magia-item .magia-nome {
             font-weight: bold;
             margin-bottom: 5px !important;
             font-size: 1.1rem;
        }
        .magia-detalhes {
            display: flex;
            align-items: center;
            flex-wrap: wrap; /* Allow wrapping on small screens */
            gap: 10px;
        }
        .magia-detalhes input, .magia-detalhes select {
            margin-bottom: 0 !important; /* Override default margin */
            padding: 8px;
            font-size: 0.9rem;
        }
        /* --- MODIFIED: Adjusted width and added new class for vigor cost --- */
        .magia-detalhes .magia-custo, .magia-detalhes .magia-custo-vigor {
            width: 60px !important; text-align: center;
        }
        .magia-detalhes .magia-dano { flex-grow: 1; min-width: 100px;}
        .magia-detalhes .magia-tipo { width: 120px !important; flex-grow: 1; }
        .lancar-magia-btn {
             font-size: 1.3rem;
             padding: 4px 8px;
             line-height: 1;
             min-width: 40px;
             flex-shrink: 0;
             margin-left: auto !important; /* Push button to the end */
        }
        .lancar-magia-btn:hover {
            box-shadow: 0 0 8px #00e5ff;
            text-shadow: 0 0 5px #fff;
        }
        body.dark-mode .lancar-magia-btn:hover {
             box-shadow: 0 0 8px #c58c5a;
        }

        #adicionar-magia-btn {
            background: #b8860b; color: #fff; padding: 8px 16px; border-radius: 6px;
            cursor: pointer; display: block; margin-top: 10px;
        }
        #adicionar-magia-btn:hover { background: #a0522d; }
        body.dark-mode #adicionar-magia-btn { background: #555; }
        body.dark-mode #adicionar-magia-btn:hover { background: #777; }

        /*******************************************************
        *       STYLES FOR UPGRADED MAGIC SYSTEM END HERE      *
        ********************************************************/


        .classe-raca-container { background: #f0e6d2; border: 2px solid #b8860b; padding: 10px; border-radius: 6px; margin-top: 10px; transition: background-color 0.3s, border-color 0.3s;}
        body.dark-mode .classe-raca-container { background: #1e1e1e; border-color: #444; }
        .classe-raca-container label { font-family: 'MedievalSharp', serif; color: #a0522d; font-size: 1.2rem; transition: color 0.3s;}
        .classe-raca-container span[onclick] { background: #fff; border: 2px solid #b8860b; padding: 10px; cursor: pointer; display: block;  transition: background-color 0.3s, border-color 0.3s;}
        body.dark-mode .classe-raca-container span[onclick] { background: #333; color: #e0e0e0; }
        .classe-raca-container textarea { width: 100%; background: #fff; border: 2px solid #b8860b; }
        body.dark-mode .classe-raca-container textarea { background: #333; color: #e0e0e0; }
        .raca-item { margin-bottom: 20px; padding: 10px; background: #fff; border: 2px solid #b8860b; border-radius: 6px; }
        .raca-item h3 { font-family: 'MedievalSharp', serif; font-size: 1.5rem; color: #a0522d;  transition: color 0.3s;}
        .raca-item p { font-size: 1rem; color: #000; transition: color 0.3s;}
        body.dark-mode .raca-item { background: #333; border-color: #555; }
        body.dark-mode .raca-item p { color: #e0e0e0; }
        .theme-buttons-container { display: flex; justify-content: center; align-items:center; gap: 10px; margin-top: -10px; margin-bottom: 20px; flex-wrap: wrap; }

        .lock-icon { margin-left: 5px; cursor: help; }

        .gm-edit-icon {
            font-size: 0.8rem;
            margin-left: 5px;
            cursor: pointer;
            display: none;
            color: #007bff;
        }
        body.gm-mode-active .gm-edit-icon {
            display: inline;
        }
        body.dark-mode .gm-edit-icon {
            color: #61dafb;
        }
        .gm-edit-icon:hover {
            text-shadow: 0 0 3px currentColor;
        }
        #custom-tooltip {
            position: absolute;
            visibility: hidden;
            background-color: #333;
            color: white;
            padding: 8px 12px;
            border-radius: 5px;
            font-size: 0.85rem;
            z-index: 2000;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s ease-in-out;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            max-width: 250px;
            text-align: left;
        }
        body.dark-mode #custom-tooltip {
            background-color: #f0e6d2;
            color: #1e1e1e;
            border: 1px solid #444;
        }
        #custom-tooltip.visible {
            visibility: visible;
            opacity: 1;
        }

        #confirmar-salvar-atributos-texto {
            background-color: yellow; /* Amarelo */
            color: #333; /* Texto escuro para contraste com amarelo */
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px; /* Added margin for spacing */
            animation: glow-red-text 1.5s infinite alternate;
            font-weight: bold;
            font-size: 1.1rem; /* Slightly larger font for emphasis */
        }

        @keyframes glow-red-text {
            0% { text-shadow: 0 0 5px red, 0 0 10px red; box-shadow: 0 0 8px yellow, inset 0 0 5px rgba(255,0,0,0.3); }
            100% { text-shadow: 0 0 10px red, 0 0 15px orangered, 0 0 20px orangered; box-shadow: 0 0 15px yellow, inset 0 0 10px rgba(255,0,0,0.5); }
        }

        /**********************************************
        *      NEW STYLES START HERE                 *
        ***********************************************/

        .attribute-dice-icon {
            cursor: pointer;
            margin-left: 8px;
            display: inline-block;
            transition: transform 0.2s;
            font-size: 1rem;
            user-select: none;
        }

        .attribute-dice-icon:hover {
            transform: scale(1.2);
        }

        .attribute-dice-icon.selected {
            animation: glow-yellow 1s infinite alternate;
        }

        @keyframes glow-yellow {
            from {
                text-shadow: 0 0 5px #ffd700, 0 0 10px #ffd700, 0 0 15px #ff8c00;
            }
            to {
                text-shadow: 0 0 10px #ffd700, 0 0 20px #ffae42, 0 0 25px #ff8c00;
                transform: scale(1.1);
            }
        }

        #notification .final-sum-result {
            font-size: 2.5em; /* Significantly larger */
            font-weight: bold;
            display: inline-block; /* Needed for animation */
            animation: rgb-flicker 0.5s infinite;
        }

        @keyframes rgb-flicker {
            0%   { color: red; text-shadow: 0 0 5px red; }
            25%  { color: lime; text-shadow: 0 0 5px lime;}
            50%  { color: blue; text-shadow: 0 0 5px blue;}
            75%  { color: yellow; text-shadow: 0 0 5px yellow;}
            100% { color: magenta; text-shadow: 0 0 5px magenta;}
        }

        /**********************************************
        *      NEW THEME STYLES START HERE            *
        ***********************************************/

        /* --- Animations --- */
        @keyframes futuristic-glow {
            from { text-shadow: 0 0 4px #fff, 0 0 8px #fff, 0 0 12px #00aaff, 0 0 16px #00aaff; }
            to { text-shadow: 0 0 8px #fff, 0 0 12px #00aaff, 0 0 16px #00aaff, 0 0 20px #00aaff; }
        }
        @keyframes fire-flicker-shadow {
            0%,100% { text-shadow: 0 0 4px #fff, 0 0 10px #ff0, 0 0 20px #f80; }
            50% { text-shadow: 0 0 6px #fff, 0 0 15px #ff0, 0 0 25px #f60; }
        }
        @keyframes fire-flicker-border {
            0%,100% { border-color: #f80; box-shadow: 0 0 10px #f80; }
            50% { border-color: #ff0; box-shadow: 0 0 20px #ff0; }
        }
        @keyframes water-flow {
            0%{background-position:0% 50%}
            50%{background-position:100% 50%}
            100%{background-position:0% 50%}
        }
        @keyframes air-drift {
            0% { transform: translateX(0); opacity: 0.7; }
            50% { transform: translateX(5px); opacity: 1; }
            100% { transform: translateX(0); opacity: 0.7; }
        }
        @keyframes earth-rumble-shadow {
             0%, 100% { text-shadow: 1px 1px 2px #3d2b1f; }
             50% { text-shadow: -1px -1px 2px #3d2b1f; }
        }

        /* --- Futuristic Theme --- */
        .theme-futurista {
            font-family: 'Orbitron', sans-serif !important;
            background: #05080d url('data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"%3E%3Cg fill="%230a142e" fill-opacity="0.4"%3E%3Crect x="0" y="0" width="100" height="1"/%3E%3Crect x="0" y="0" width="1" height="100"/%3E%3C/g%3E%3C/svg%3E') !important;
            color: #00e5ff;
        }
        .theme-futurista #ficha-container {
            background-color: rgba(1, 4, 15, 0.85);
            border: 2px solid #00aaff;
            border-radius: 4px;
            box-shadow: 0 0 25px rgba(0, 170, 255, 0.6), inset 0 0 15px rgba(0, 170, 255, 0.4);
        }
        .theme-futurista h1#nome-personagem-titulo { font-family: 'Orbitron', sans-serif !important; color: #ffffff; animation: futuristic-glow 1.5s infinite alternate; }
        .theme-futurista section {
            background-color: rgba(10, 25, 50, 0.7);
            border-color: #0077cc;
            border-style: solid;
            box-shadow: inset 0 0 8px rgba(0, 120, 200, 0.5);
        }
        .theme-futurista section h2, .theme-futurista .atributo-destaque label { font-family: 'Orbitron', sans-serif !important; color: #00e5ff; }
        .theme-futurista .botao, .theme-futurista button {
            background-color: transparent; border: 2px solid #00aaff; color: #00e5ff;
            text-shadow: 0 0 5px #00e5ff; border-radius: 4px;
        }
        .theme-futurista .botao:hover, .theme-futurista button:hover { background-color: rgba(0, 170, 255, 0.2); transform: scale(1.05); }
        .theme-futurista input, .theme-futurista textarea, .theme-futurista select {
            background-color: #0a1020; color: #00e5ff; border: 1px solid #0077cc;
        }
        .theme-futurista #dice-roll { background-color: #0a1020; color: #00e5ff; border-color: #00aaff; box-shadow: 0 0 10px #00aaff; }

        /* --- Elemental Fogo Theme --- */
        .theme-elemental-fogo { background-color: #2b0c00 !important; }
        .theme-elemental-fogo #ficha-container {
            background-color: rgba(50, 0, 0, 0.7);
            border: 2px solid #ff4500;
            box-shadow: 0 0 30px #ff4500, inset 0 0 20px #8b0000;
            animation: fire-flicker-border 3s infinite linear;
        }
        .theme-elemental-fogo h1, .theme-elemental-fogo h2, .theme-elemental-fogo .atributo-destaque label { color: #ffd700; animation: fire-flicker-shadow 2s infinite alternate; }
        .theme-elemental-fogo section { background-color: rgba(60, 10, 0, 0.7); border-color: #f80; }
        .theme-elemental-fogo .botao, .theme-elemental-fogo button { background: #c04000; border: 1px solid #ff4500; color: #fff; }
        .theme-elemental-fogo input, .theme-elemental-fogo textarea { background-color: #4a1c00; border-color: #c04000; color: #ffebcd; }
        .theme-elemental-fogo #dice-roll {
             background: radial-gradient(circle, #ffcc00 0%, #ff4500 100%); color: #401000;
             border: 2px solid #f80; text-shadow: 0 0 5px #fff; animation: fire-flicker-border 2s infinite alternate;
        }

        /* --- Elemental Agua Theme --- */
        .theme-elemental-agua { background-color: #0b2c3c !important; color: #e0f7fa; }
        .theme-elemental-agua #ficha-container {
            background: linear-gradient(135deg, rgba(20, 80, 120, 0.8), rgba(5, 40, 60, 0.8));
            background-size: 200% 200%;
            border: 2px solid #33cccc;
            border-radius: 20px;
            box-shadow: 0 0 25px #33cccc, inset 0 0 15px rgba(51, 204, 204, 0.4);
            animation: water-flow 8s ease infinite;
        }
        .theme-elemental-agua section { border-radius: 15px; background-color: rgba(10, 50, 80, 0.7); border-color: #17a2b8; }
        .theme-elemental-agua h1, .theme-elemental-agua h2, .theme-elemental-agua .atributo-destaque label { color: #b2ebf2; text-shadow: 0 0 8px #fff; }
        .theme-elemental-agua .botao, .theme-elemental-agua button { background-color: #007b8a; border-radius: 50px; border: 1px solid #17a2b8; }
        .theme-elemental-agua input, .theme-elemental-agua textarea { background-color: #0f3f54; border-color: #17a2b8; border-radius: 10px; color: #e0f7fa; }
        .theme-elemental-agua #dice-roll {
             background: radial-gradient(circle, #b2ebf2, #17a2b8); color: #0b2c3c;
             border-radius: 50%; border: 2px solid #33cccc; box-shadow: 0 0 10px #33cccc, inset 0 0 8px #fff;
        }

        /* --- Elemental Ar Theme --- */
        .theme-elemental-ar { background-color: #e8f7fe !important; color: #2c3e50; }
        .theme-elemental-ar #ficha-container {
            background-color: rgba(255, 255, 255, 0.7);
            border: 2px solid #add8e6;
            box-shadow: 0 0 30px rgba(173, 216, 230, 0.7); backdrop-filter: blur(3px);
        }
        .theme-elemental-ar section { background-color: rgba(240, 248, 255, 0.8); border-color: #cce7ff; border-style: dashed; animation: air-drift 10s infinite alternate; }
        .theme-elemental-ar h1, .theme-elemental-ar h2, .theme-elemental-ar .atributo-destaque label { color: #4682b4; text-shadow: 0 0 5px #fff; animation: air-drift 5s infinite alternate; }
        .theme-elemental-ar .botao, .theme-elemental-ar button { background-color: #add8e6; color: #2c3e50; border: 1px solid #87ceeb; }
        .theme-elemental-ar input, .theme-elemental-ar textarea { background-color: #f0f8ff; border-color: #87ceeb; color: #2c3e50; }
        .theme-elemental-ar #dice-roll { background: linear-gradient(to bottom, #fff, #add8e6); color: #2c3e50; border: 2px solid #87ceeb; animation: air-drift 6s infinite alternate; }

        /* --- Elemental Terra Theme --- */
        .theme-elemental-terra { background-color: #8b4513 !important; color: #f5deb3; }
        .theme-elemental-terra #ficha-container {
            background-color: rgba(139, 69, 19, 0.8);
            border: 2px solid #cd853f;
            box-shadow: 0 0 20px #cd853f, inset 0 0 10px #8b4513;
            animation: earth-rumble-shadow 2s infinite alternate;
        }
        .theme-elemental-terra section { background-color: rgba(160, 82, 45, 0.7); border-color: #a0522d; border-style: double; }
        .theme-elemental-terra h1, .theme-elemental-terra h2, .theme-elemental-terra .atributo-destaque label { color: #f4a460; animation: earth-rumble-shadow 1.5s infinite alternate; }
        .theme-elemental-terra .botao, .theme-elemental-terra button { background-color: #a0522d; border: 1px solid #cd853f; color: #fff; }
        .theme-elemental-terra input, .theme-elemental-terra textarea { background-color: #8b4513; border-color: #cd853f; color: #f5deb3; }
        .theme-elemental-terra #dice-roll { background: radial-gradient(circle, #cd853f, #8b4513); color: #f5deb3; border: 2px solid #a0522d; animation: earth-rumble-shadow 2s infinite alternate; }

        /**********************************************
        *      NEW THEME STYLES END HERE              *
        ***********************************************/

    </style>
</head>
<body>
    <div id="fichas-sidebar"></div>
    <div id="ficha-container">
        <div id="game-master-message"></div>
        <h1 id="nome-personagem-titulo"></h1>
        <div id="ficha-content">
            <!-- Seções da Ficha -->
            <section id="informacoes-basicas">
                <h2>Informações Básicas <span class="collapse-icon">▼</span></h2>
                <div class="section-content">
                    <label for="nome-personagem">Nome do Personagem</label>
                    <input type="text" id="nome-personagem" placeholder="Digite o nome do personagem">
                    <label for="idade">Idade</label>
                    <input type="number" id="idade" min="0">
                    <label for="raca">Raça</label>
                    <span id="raca" onclick="abrirPaginaRacas()">Selecionar Raça</span>
                    <textarea id="descricao-raca" readonly></textarea>
                    <label for="classe">Classe</label>
                    <span id="classe" onclick="abrirPaginaClasses()">Selecionar Classe</span>
                    <textarea id="descricao-classe" readonly></textarea>
                    <label for="experiencia">Experiência</label>
                    <input type="number" id="experiencia" min="0">
                    <div id="nivel-container">
                        <span id="nivel"></span>
                    </div>
                </div>
            </section>

            <section id="atributos">
                <h2>Atributos <span class="collapse-icon">▼</span></h2>
                <div class="section-content">
                    <div class="atributos-container">
                        <div class="atributos-coluna">
                            <label for="forca">Força <span class="attribute-dice-icon" data-attribute="forca">🎲</span></label>
                            <input type="number" id="forca" min="0">
                            <button id="btn-diminuir-forca">-</button>
                            <button id="btn-aumentar-forca">+</button>
                            <label for="destreza">Destreza <span class="attribute-dice-icon" data-attribute="destreza">🎲</span></label>
                            <input type="number" id="destreza" min="0">
                            <button id="btn-diminuir-destreza">-</button>
                            <button id="btn-aumentar-destreza">+</button>
                            <label for="agilidade">Agilidade <span class="attribute-dice-icon" data-attribute="agilidade">🎲</span></label>
                            <input type="number" id="agilidade" min="0">
                            <button id="btn-diminuir-agilidade">-</button>
                            <button id="btn-aumentar-agilidade">+</button>
                            <label for="constituicao">Constituição <span class="attribute-dice-icon" data-attribute="constituicao">🎲</span></label>
                            <input type="number" id="constituicao" min="0">
                            <button id="btn-diminuir-constituicao">-</button>
                            <button id="btn-aumentar-constituicao">+</button>
                            <label for="inteligencia">Inteligência <span class="attribute-dice-icon" data-attribute="inteligencia">🎲</span></label>
                            <input type="number" id="inteligencia" min="0">
                            <button id="btn-diminuir-inteligencia">-</button>
                            <button id="btn-aumentar-inteligencia">+</button>
                        </div>
                        <div class="atributos-coluna-destaque">
                            <div class="atributo-destaque">
                                <label>Ataque</label>
                                <span id="ataque"></span> <span class="gm-edit-icon" data-target-id="ataque" data-label="Ataque">✏️</span>
                            </div>
                            <div class="atributo-destaque">
                                <label>Ataque Mágico</label>
                                <span id="ataque-magico"></span> <span class="gm-edit-icon" data-target-id="ataque-magico" data-label="Ataque Mágico">✏️</span>
                            </div>
                            <div class="atributo-destaque">
                                <label>Acerto</label>
                                <span id="acerto"></span> <span class="gm-edit-icon" data-target-id="acerto" data-label="Acerto">✏️</span>
                            </div>
                            <div class="atributo-destaque">
                                <label>Esquiva</label>
                                <span id="esquiva"></span> <span class="gm-edit-icon" data-target-id="esquiva" data-label="Esquiva">✏️</span>
                            </div>
                            <div class="atributo-destaque">
                                <label>RDF</label>
                                <span id="rdf"></span> <span class="gm-edit-icon" data-target-id="rdf" data-label="RDF">✏️</span>
                            </div>
                            <div class="atributo-destaque">
                                <label>RDM</label>
                                <span id="rdm"></span> <span class="gm-edit-icon" data-target-id="rdm" data-label="RDM">✏️</span>
                            </div>
                        </div>
                    </div>
                    <div class="locomotion-container">
                        <div class="locomotion-item">
                            <label>Velocidade de Corrida:</label>
                            <span id="velocidade-corrida"></span> m/s <span class="gm-edit-icon" data-target-id="velocidade-corrida" data-label="Velocidade de Corrida">✏️</span>
                        </div>
                        <div class="locomotion-item">
                            <label>Altura de Pulo:</label>
                            <span id="altura-pulo"></span> m <span class="gm-edit-icon" data-target-id="altura-pulo" data-label="Altura de Pulo">✏️</span>
                        </div>
                        <div class="locomotion-item">
                            <label>Distância de Pulo:</label>
                            <span id="distancia-pulo"></span> m <span class="gm-edit-icon" data-target-id="distancia-pulo" data-label="Distância de Pulo">✏️</span>
                        </div>
                    </div>
                    <label for="pontos-habilidade">Pontos de Habilidade Restantes</label>
                    <span id="pontos-habilidade" readonly></span>
                    <label for="pontos-vantagem">Pontos de Vantagem Restantes</label>
                    <span id="pontos-vantagem" readonly></span>
                </div>
            </section>

            <section id="recursos">
                <h2>Recursos <span class="collapse-icon">▼</span></h2>
                <div class="section-content">
                    <div class="vida-magia-vigor">
                        <div class="atributo-container vida">
                            <label>Vida Total</label>
                            <span id="vida-total"></span> <span class="gm-edit-icon" data-target-id="vida-total" data-label="Vida Total">✏️</span>
                            <div class="valor-atual medieval-box">
                                <button id="btn-diminuir-vida">-</button>
                                <input type="number" class="recurso-atual-input" id="vida-atual" min="0">
                                <button id="btn-aumentar-vida">+</button>
                            </div>
                            <div class="regeneracao">Regenera 10% por hora</div>
                        </div>
                        <div class="atributo-container magia">
                            <label>Magia Total</label>
                            <span id="magia-total"></span> <span class="gm-edit-icon" data-target-id="magia-total" data-label="Magia Total">✏️</span>
                            <div class="valor-atual medieval-box">
                                <button id="btn-diminuir-magia">-</button>
                                <input type="number" class="recurso-atual-input" id="magia-atual" min="0">
                                <button id="btn-aumentar-magia">+</button>
                            </div>
                            <div class="regeneracao">Regenera 20% por hora</div>
                        </div>
                        <div class="atributo-container vigor">
                            <label>Vigor Total</label>
                            <span id="vigor-total"></span> <span class="gm-edit-icon" data-target-id="vigor-total" data-label="Vigor Total">✏️</span>
                            <div class="valor-atual medieval-box">
                                <button id="btn-diminuir-vigor">-</button>
                                <input type="number" class="recurso-atual-input" id="vigor-atual" min="0">
                                <button id="btn-aumentar-vigor">+</button>
                            </div>
                            <div class="regeneracao">Regenera 30% por hora</div>
                        </div>
                    </div>
                </div>
            </section>

            <section id="vantagens-desvantagens">
                <h2>Vantagens e Desvantagens <span class="collapse-icon">▼</span></h2>
                <div class="section-content">
                    <button id="vantagens-desvantagens-btn">Abrir Lista de Vantagens/Desvantagens</button>
                    <label>Vantagens Compradas</label>
                    <div class="list-display" id="vantagens-compradas"></div>
                    <label>Desvantagens Compradas</label>
                    <div class="list-display" id="desvantagens-compradas"></div>
                </div>
            </section>

            <section id="magias">
                <h2>Magias <span class="collapse-icon">▼</span></h2>
                <div class="section-content">
                    <div class="magias-container" id="magias-container"></div>
                    <button id="adicionar-magia-btn">Adicionar Magia</button>
                </div>
            </section>

            <section id="inventario">
                <h2>Inventário <span class="collapse-icon">▼</span></h2>
                <div class="section-content">
                    <label>Capacidade de Carga</label>
                    <span id="capacidade-carga"></span> kg <span class="gm-edit-icon" data-target-id="capacidade-carga" data-label="Capacidade de Carga">✏️</span>
                    <div id="inventario-slots"></div>
                    <button id="adicionar-item-btn">Adicionar Item</button>
                </div>
            </section>

            <section id="anotacoes">
                <h2>Anotações <span class="collapse-icon">▼</span></h2>
                <div class="section-content">
                    <textarea id="anotacoes" class="expandable-textarea"></textarea>
                </div>
            </section>
        </div>
        <div class="botoes-container">
            <button id="reset-pontos" class="botao botao-reset">Resetar Pontos</button>
            <button id="recomecar" class="botao botao-recomecar">Recomeçar Ficha</button>
            <button id="bloquear-ficha" class="botao botao-bloquear">Bloquear Ficha 🔒</button>
            <button id="excluir-ficha" class="botao">Excluir Ficha</button>
            <button id="gm-mode-btn" class="botao">Modo Mestre GM 👑</button>
            <button id="customizacao-btn" class="botao">Customização 🎨</button>
            <button id="sol-btn" class="icon-btn botao">☀️</button>
            <button id="lua-btn" class="icon-btn botao">🌙</button>
        </div>
    </div>

    <!-- Dice Container -->
    <div id="dice-container">
        <label>Dado</label>
        <div class="dice-roll-area">
            <span id="dice-roll">1</span>
            <button id="change-dice-type-btn">d20</button>
        </div>
        <div id="dice-options-menu">
            <button class="dice-option-btn" data-type="d4">d4</button>
            <button class="dice-option-btn" data-type="d6">d6</button>
            <button class="dice-option-btn" data-type="d8">d8</button>
            <button class="dice-option-btn" data-type="d10">d10</button>
            <button class="dice-option-btn" data-type="d12">d12</button>
            <button class="dice-option-btn" data-type="d20">d20</button>
            <button class="dice-option-btn" data-type="d100">d100</button>
        </div>
        <span id="dice-result"></span>
    </div>

    <!-- Fireworks Container -->
    <div id="fireworks-container"></div>

    <!-- Dice History Panel -->
    <div id="dice-history-trigger">Histórico de Dados</div>
    <div id="dice-history-panel">
        <h2>Histórico de Rolagens</h2>
        <div id="dice-history-list"></div>
        <div class="dice-history-buttons">
            <button id="fechar-historico-btn" class="botao">Fechar</button>
            <button id="limpar-historico-btn" class="botao">Limpar Histórico</button>
        </div>
    </div>

    <!-- Notification -->
    <div id="notification"></div>

    <!-- Character Image -->
    <div id="character-image-container" onclick="abrirModal('imagem-modal')">
        <img id="character-image" alt="Imagem do Personagem">
    </div>

    <!-- Modals -->
    <div id="imagem-modal" class="modal">
        <div class="modal-content">
            <h3>Imagem do Personagem</h3>
            <input type="text" id="imagem-url" placeholder="URL da Imagem">
            <input type="file" id="imagem-file" accept="image/*">
            <button class="confirm-btn" onclick="aplicarImagemPersonagem()">Aplicar</button>
            <button class="cancel-btn" onclick="fecharModal('imagem-modal')">Cancelar</button>
        </div>
    </div>

    <div id="customizacao-modal" class="modal">
        <div class="modal-content">
            <h3>Customização da Ficha</h3>
            <fieldset>
                <legend>Tema</legend>
                <div class="input-group">
                    <label for="theme-selector">Selecionar Tema</label>
                    <select id="theme-selector">
                        <option value="theme-medieval">Medieval (Padrão)</option>
                        <option value="theme-futurista">Futurista</option>
                        <option value="theme-elemental">Elemental</option>
                    </select>
                    <div id="elemental-theme-group" style="display: none; margin-top: 10px;">
                        <label for="elemental-theme-selector">Elemento</label>
                        <select id="elemental-theme-selector">
                            <option value="fogo">Fogo</option>
                            <option value="agua">Água</option>
                            <option value="ar">Ar</option>
                            <option value="terra">Terra</option>
                        </select>
                    </div>
                </div>
                <button id="aplicar-tema-btn">Aplicar Tema</button>
            </fieldset>
            <fieldset>
                <legend>Cor de Fundo</legend>
                <div class="input-group">
                    <label for="background-color">Cor de Fundo da Página</label>
                    <input type="color" id="background-color">
                </div>
                <div class="input-group">
                    <label for="ficha-internal-background-color">Cor de Fundo Interna da Ficha</label>
                    <input type="color" id="ficha-internal-background-color">
                </div>
            </fieldset>
            <fieldset>
                <legend>Fonte</legend>
                <div class="input-group">
                    <label for="font-selector">Selecionar Fonte</label>
                    <select id="font-selector">
                        <option value="'Inter', sans-serif">Inter (Padrão)</option>
                        <option value="'MedievalSharp', serif">MedievalSharp</option>
                        <option value="'Times New Roman', serif">Times New Roman</option>
                        <option value="'Arial', sans-serif">Arial</option>
                        <option value="'Courier New', monospace">Courier New</option>
                        <option value="'Georgia', serif">Georgia</option>
                        <option value="'Verdana', sans-serif">Verdana</option>
                        <option value="'Orbitron', sans-serif">Orbitron</option>
                    </select>
                </div>
            </fieldset>
            <fieldset>
                <legend>Imagem de Fundo</legend>
                <div class="input-group">
                    <label for="background-image">Carregar Imagem de Fundo</label>
                    <input type="file" id="background-image" accept="image/*">
                </div>
                <div class="radio-group">
                    <label><input type="radio" name="background-size" value="cover" checked> Cover</label>
                    <label><input type="radio" name="background-size" value="contain"> Contain</label>
                    <label><input type="radio" name="background-size" value="auto"> Auto</label>
                </div>
                <button id="aplicar-background-btn">Aplicar Plano de Fundo</button>
                <button id="excluir-background-btn">Excluir Plano de Fundo</button>
            </fieldset>
            <fieldset>
                <legend>Estilos de Seção</legend>
                <div class="input-group">
                    <label for="cor-borda-secao">Cor da Borda das Seções</label>
                    <input type="color" id="cor-borda-secao" value="#b8860b">
                </div>
                <div class="input-group">
                    <label for="estilo-borda-secao">Estilo da Borda</label>
                    <select id="estilo-borda-secao">
                        <option value="solid">Sólida</option>
                        <option value="dashed">Tracejada</option>
                        <option value="dotted">Pontilhada</option>
                        <option value="double">Dupla</option>
                        <option value="none">Nenhuma</option>
                    </select>
                </div>
                <div class="input-group">
                    <label for="largura-borda-secao">Largura da Borda (px)</label>
                    <input type="number" id="largura-borda-secao" min="0" value="2">
                </div>
                <button id="aplicar-estilos-secao-btn">Aplicar Estilos de Seção</button>
            </fieldset>
            <fieldset>
                <legend>Customização do Dado</legend>
                <div class="input-group">
                    <label for="dice-color">Cor de Fundo do Dado</label>
                    <input type="color" id="dice-color">
                </div>
                <div class="input-group">
                    <label for="dice-number-color">Cor do Número do Dado</label>
                    <input type="color" id="dice-number-color">
                </div>
                <div class="input-group">
                    <label for="dice-texture">Textura do Dado</label>
                    <input type="file" id="dice-texture" accept="image/*">
                </div>
                <div class="custom-dice-texture-controls">
                    <button id="remove-dice-texture-btn">Remover Textura</button>
                </div>
                <div class="input-group">
                    <label for="dice-animation-selector">Animação do Dado</label>
                    <select id="dice-animation-selector">
                        <option value="padrao">Padrão</option>
                        <option value="rapida">Rápida</option>
                        <option value="salto">Salto</option>
                    </select>
                </div>
            </fieldset>
            <fieldset>
                <legend>Transparência da Ficha</legend>
                <div class="input-group">
                    <label for="ficha-transparency-slider">Nível de Transparência (%)</label>
                    <input type="range" id="ficha-transparency-slider" min="0" max="100" value="100">
                    <span id="ficha-transparency-value">100</span>
                </div>
                <button id="reset-transparency-btn">Restaurar Padrão</button>
            </fieldset>
            <fieldset>
                <legend>Sombra Interna da Ficha</legend>
                <div class="input-group">
                    <label for="shadow-color-ficha">Cor da Sombra</label>
                    <input type="color" id="shadow-color-ficha" value="#000000">
                </div>
                <div class="input-group">
                    <label for="shadow-intensity-ficha-slider">Intensidade da Sombra</label>
                    <input type="range" id="shadow-intensity-ficha-slider" min="0" max="50" value="0">
                    <span id="shadow-intensity-ficha-value">0</span>
                </div>
                <button id="reset-shadow-btn">Restaurar Padrão</button>
            </fieldset>
            <button id="reset-estetica-btn" class="botao">Reiniciar Estética</button>
            <button class="cancel-btn" onclick="fecharModal('customizacao-modal')">Fechar</button>
        </div>
    </div>

    <div id="vantagens-desvantagens-panel">
        <h2>Vantagens e Desvantagens</h2>
        <div id="vantagens-list"></div>
        <div id="desvantagens-list"></div>
        <button id="salvar-vantagens-btn">Salvar</button>
        <button id="fechar-pagina-btn">Fechar</button>
    </div>

    <div id="racas-panel">
        <h2>Raças</h2>
        <div id="racas-list"></div>
        <button id="salvar-racas-btn">Salvar</button>
        <button id="fechar-racas-btn">Fechar</button>
    </div>

    <div id="classes-panel">
        <h2>Classes</h2>
        <div id="classes-list"></div>
        <button id="fechar-classes-btn">Fechar</button>
    </div>

    <div id="senha-modal" class="modal">
        <div class="modal-content">
            <h3 id="senha-titulo">Digite a Senha para Desbloquear</h3>
            <input type="password" id="senha-input">
            <button class="confirm-btn" id="confirmar-senha-btn">Confirmar</button>
            <button class="cancel-btn" onclick="fecharModal('senha-modal')">Cancelar</button>
        </div>
    </div>

    <div id="senha-gm-modal" class="modal">
        <div class="modal-content">
            <h3 id="senha-gm-titulo">Senha do GM</h3>
            <input type="password" id="senha-gm-input">
            <button class="confirm-btn" id="confirmar-senha-gm-btn">Confirmar</button>
            <button class="cancel-btn" onclick="fecharModal('senha-gm-modal')">Cancelar</button>
        </div>
    </div>

    <div id="confirmar-tema-modal" class="modal">
        <div class="modal-content">
            <h3>Confirmar Tema</h3>
            <p>Deseja aplicar este tema?</p>
            <button id="confirmar-tema-sim-btn" class="confirm-btn">Sim</button>
            <button id="confirmar-tema-nao-btn" class="cancel-btn">Não</button>
        </div>
    </div>

    <div id="anotacoes-btn">Anotações</div>
    <textarea id="anotacoes-textarea"></textarea>

    <div id="custom-tooltip"></div>

    <script>
        const REPEAT_DELAY_MS = 100;
        const FICHA_MATRIZ_ID = 'matriz';
        let fichas = {};
        let currentFichaId = FICHA_MATRIZ_ID;
        let isFichaLocked = false;
        let isFichaUnlocked = false;
        let isGmModeActive = false;
        let isXpUnlocked = false;
        let senhaMatriz = '1234'; // Senha padrão da ficha matriz
        let currentX = 0;
        let currentY = 0;
        let isDragging = false;
        let offsetX = 0;
        let offsetY = 0;
        let currentActionIntervalId = null;
        let diceType = 20;
        let diceRolls = [];
        let fireworksContainerRef = null;
        let selectedAttributeIcon = null;
        let tooltipTimeoutId = null;
        let previousTheme = 'theme-medieval';

        const atributosInputs = [
            document.getElementById('forca'),
            document.getElementById('destreza'),
            document.getElementById('agilidade'),
            document.getElementById('constituicao'),
            document.getElementById('inteligencia')
        ];

        const vidaTotalSpan = document.getElementById('vida-total');
        const magiaTotalSpan = document.getElementById('magia-total');
        const vigorTotalSpan = document.getElementById('vigor-total');
        const ataqueSpan = document.getElementById('ataque');
        const ataqueMagicoSpan = document.getElementById('ataque-magico');
        const acertoSpan = document.getElementById('acerto');
        const esquivaSpan = document.getElementById('esquiva');
        const rdfSpan = document.getElementById('rdf');
        const rdmSpan = document.getElementById('rdm');
        const velocidadeCorridaSpan = document.getElementById('velocidade-corrida');
        const alturaPuloSpan = document.getElementById('altura-pulo');
        const distanciaPuloSpan = document.getElementById('distancia-pulo');
        const pontosHabilidadeSpan = document.getElementById('pontos-habilidade');
        const pontosVantagemSpan = document.getElementById('pontos-vantagem');
        const capacidadeCargaSpan = document.getElementById('capacidade-carga');
        const nivelSpan = document.getElementById('nivel');
        const experienciaInput = document.getElementById('experiencia');
        const nomePersonagemInput = document.getElementById('nome-personagem');
        const idadeInput = document.getElementById('idade');
        const racaSpan = document.getElementById('raca');
        const descricaoRacaTextarea = document.getElementById('descricao-raca');
        const classeSpan = document.getElementById('classe');
        const descricaoClasseTextarea = document.getElementById('descricao-classe');
        const vidaAtualInput = document.getElementById('vida-atual');
        const magiaAtualInput = document.getElementById('magia-atual');
        const vigorAtualInput = document.getElementById('vigor-atual');
        const vantagensCompradasDiv = document.getElementById('vantagens-compradas');
        const desvantagensCompradasDiv = document.getElementById('desvantagens-compradas');
        const magiasContainer = document.getElementById('magias-container');
        const inventarioSlotsDiv = document.getElementById('inventario-slots');
        const anotacoesTextarea = document.getElementById('anotacoes');
        const diceRoll = document.getElementById('dice-roll');
        const diceResult = document.getElementById('dice-result');
        const changeDiceTypeBtn = document.getElementById('change-dice-type-btn');
        const diceOptionsMenu = document.getElementById('dice-options-menu');
        const diceHistoryTrigger = document.getElementById('dice-history-trigger');
        const diceHistoryPanel = document.getElementById('dice-history-panel');
        const diceHistoryList = document.getElementById('dice-history-list');
        const fecharHistoricoBtn = document.getElementById('fechar-historico-btn');
        const limparHistoricoBtn = document.getElementById('limpar-historico-btn');
        const notification = document.getElementById('notification');
        const characterImageContainer = document.getElementById('character-image-container');
        const characterImage = document.getElementById('character-image');
        const imagemUrlInput = document.getElementById('imagem-url');
        const imagemFileInput = document.getElementById('imagem-file');
        const customizacaoModal = document.getElementById('customizacao-modal');
        const customizacaoBtn = document.getElementById('customizacao-btn');
        const themeSelector = document.getElementById('theme-selector');
        const elementalThemeGroup = document.getElementById('elemental-theme-group');
        const elementalThemeSelector = document.getElementById('elemental-theme-selector');
        const aplicarTemaBtn = document.getElementById('aplicar-tema-btn');
        const backgroundColorInput = document.getElementById('background-color');
        const fichaInternalBackgroundColorInput = document.getElementById('ficha-internal-background-color');
        const fontSelector = document.getElementById('font-selector');
        const backgroundImageInput = document.getElementById('background-image');
        const aplicarBackgroundBtn = document.getElementById('aplicar-background-btn');
        const excluirBackgroundBtn = document.getElementById('excluir-background-btn');
        const corBordaSecaoInput = document.getElementById('cor-borda-secao');
        const estiloBordaSecaoSelect = document.getElementById('estilo-borda-secao');
        const larguraBordaSecaoInput = document.getElementById('largura-borda-secao');
        const aplicarEstilosSecaoBtn = document.getElementById('aplicar-estilos-secao-btn');
        const diceColorInput = document.getElementById('dice-color');
        const diceNumberColorInput = document.getElementById('dice-number-color');
        const diceTextureInput = document.getElementById('dice-texture');
        const removeDiceTextureBtn = document.getElementById('remove-dice-texture-btn');
        const diceAnimationSelector = document.getElementById('dice-animation-selector');
        const fichaTransparencySlider = document.getElementById('ficha-transparency-slider');
        const fichaTransparencyValueSpan = document.getElementById('ficha-transparency-value');
        const resetTransparencyBtn = document.getElementById('reset-transparency-btn');
        const shadowColorFichaInput = document.getElementById('shadow-color-ficha');
        const shadowIntensityFichaSlider = document.getElementById('shadow-intensity-ficha-slider');
        const shadowIntensityFichaValueSpan = document.getElementById('shadow-intensity-ficha-value');
        const resetShadowBtn = document.getElementById('reset-shadow-btn');
        const vantagensDesvantagensBtn = document.getElementById('vantagens-desvantagens-btn');
        const racasBtn = document.getElementById('racas-btn');
        const classesBtn = document.getElementById('classes-btn');
        const vantagensDesvantagensPanel = document.getElementById('vantagens-desvantagens-panel');
        const racasPanel = document.getElementById('racas-panel');
        const classesPanel = document.getElementById('classes-panel');
        const salvarVantagensBtn = document.getElementById('salvar-vantagens-btn');
        const salvarRacasBtn = document.getElementById('salvar-racas-btn');
        const fecharPaginaBtn = document.getElementById('fechar-pagina-btn');
        const fecharRacasBtn = document.getElementById('fechar-racas-btn');
        const fecharClassesBtn = document.getElementById('fechar-classes-btn');
        const resetPontosBtn = document.getElementById('reset-pontos');
        const recomecarBtn = document.getElementById('recomecar');
        const bloquearFichaBtn = document.getElementById('bloquear-ficha');
        const excluirFichaBtn = document.getElementById('excluir-ficha');
        const gmModeBtn = document.getElementById('gm-mode-btn');
        const solBtn = document.getElementById('sol-btn');
        const luaBtn = document.getElementById('lua-btn');
        const adicionarMagiaBtn = document.getElementById('adicionar-magia-btn');
        const adicionarItemBtn = document.getElementById('adicionar-item-btn');
        const anotacoesBtn = document.getElementById('anotacoes-btn');
        const customTooltipElement = document.getElementById('custom-tooltip');
        const confirmarTemaModal = document.getElementById('confirmar-tema-modal');
        const confirmarTemaSimBtn = document.getElementById('confirmar-tema-sim-btn');
        const confirmarTemaNaoBtn = document.getElementById('confirmar-tema-nao-btn');
        const fichaContainer = document.getElementById('ficha-container');

        // Lista de Vantagens e Desvantagens (exemplo)
        const vantagens = [
            { nome: "Vantagem 1", custo: 1, descricao: "Descrição da Vantagem 1" },
            // Adicione mais vantagens
        ];
        const desvantagens = [
            { nome: "Desvantagem 1", custo: -1, descricao: "Descrição da Desvantagem 1" },
            // Adicione mais desvantagens
        ];

        // Lista de Raças (exemplo)
        const racas = [
            { nome: "Humano", descricao: "Descrição da raça Humano" },
            // Adicione mais raças
        ];

        // Lista de Classes (exemplo)
        const classes = [
            { nome: "Guerreiro", descricao: "Descrição da classe Guerreiro" },
            // Adicione mais classes
        ];

        function hexToRgb(hex) {
            let shorthandRegex = /^#?([a-f\d])([a-f\d])([a-f\d])$/i;
            hex = hex.replace(shorthandRegex, (m, r, g, b) => r + r + g + g + b + b);

            let result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? {
                r: parseInt(result[1], 16),
                g: parseInt(result[2], 16),
                b: parseInt(result[3], 16)
            } : null;
        }

        function salvarDados() {
            localStorage.setItem('fichasRPG', JSON.stringify(fichas));
        }

        function carregarFichas() {
            const fichasSalvas = localStorage.getItem('fichasRPG');
            if (fichasSalvas) {
                fichas = JSON.parse(fichasSalvas);
            } else {
                fichas[FICHA_MATRIZ_ID] = {
                    nome: "Ficha Matriz",
                    idade: 0,
                    raca: "",
                    descricaoRaca: "",
                    classe: "",
                    descricaoClasse: "",
                    experiencia: 0,
                    nivel: 1,
                    forca: 0,
                    destreza: 0,
                    agilidade: 0,
                    constituicao: 0,
                    inteligencia: 0,
                    vidaTotal: 10,
                    magiaTotal: 10,
                    vigorTotal: 10,
                    ataque: "0d6",
                    ataqueMagico: "0d6",
                    acerto: 0,
                    esquiva: 0,
                    rdf: 0,
                    rdm: 0,
                    velocidadeCorrida: 6,
                    alturaPulo: 1,
                    distanciaPulo: 2,
                    pontosHabilidade: 20,
                    pontosVantagem: 5,
                    capacidadeCarga: 10,
                    vidaAtual: 10,
                    magiaAtual: 10,
                    vigorAtual: 10,
                    vantagensCompradas: [],
                    desvantagensCompradas: [],
                    magias: [],
                    inventario: [],
                    anotacoes: "",
                    diceRolls: [],
                    characterImage: null,
                    collapsedSections: {},
                    lockedAtributos: {},
                    gmBonuses: {}, // Changed to gmBonuses for additive bonuses
                    theme: 'theme-medieval',
                    backgroundColor: null,
                    fichaInternalBackgroundColor: null,
                    backgroundImage: null,
                    backgroundSize: 'cover',
                    backgroundAttachment: 'scroll',
                    fontFamily: "'Inter', sans-serif",
                    fichaTransparencyLevel: 100,
                    corBordaSecao: '#b8860b',
                    estiloBordaSecao: 'solid',
                    larguraBordaSecao: '2px',
                    shadowColorFicha: '#000000',
                    shadowIntensityFicha: 0,
                    diceColor: null,
                    diceNumberColor: null,
                    texturaDado: null,
                    animacaoDado: 'padrao',
                    darkMode: false
                };
                salvarDados();
            }

            atualizarSidebarFichas();
            carregarFicha(currentFichaId);
        }

        function atualizarSidebarFichas() {
            const sidebar = document.getElementById('fichas-sidebar');
            sidebar.innerHTML = '';

            Object.keys(fichas).forEach(id => {
                if (id !== FICHA_MATRIZ_ID) {
                    const tab = document.createElement('div');
                    tab.classList.add('ficha-tab');
                    tab.dataset.fichaId = id;
                    tab.innerHTML = `<span>${fichas[id].nome || 'Ficha Sem Nome'}</span>`;
                    tab.onclick = () => carregarFicha(id);
                    sidebar.appendChild(tab);
                }
            });

            const addBtn = document.getElementById('add-ficha-btn');
            if (!addBtn.parentElement) {
                const newAddBtn = document.createElement('div');
                newAddBtn.id = 'add-ficha-btn';
                newAddBtn.innerHTML = '<span>+ Nova Ficha</span>';
                newAddBtn.onclick = adicionarNovaFicha;
                sidebar.appendChild(newAddBtn);
            }
        }

        function adicionarNovaFicha() {
            const nomeNovaFicha = prompt("Nome da nova ficha:");
            if (nomeNovaFicha) {
                const novaFichaId = Date.now().toString();
                fichas[novaFichaId] = { ...fichas[FICHA_MATRIZ_ID], nome: nomeNovaFicha };
                salvarDados();
                atualizarSidebarFichas();
                carregarFicha(novaFichaId);
            }
        }

        function carregarFicha(fichaId) {
            const ficha = fichas[fichaId];
            if (!ficha) return;

            currentFichaId = fichaId;
            isFichaLocked = ficha.locked || false;
            isFichaUnlocked = false;
            isXpUnlocked = false;

            document.querySelectorAll('.ficha-tab').forEach(tab => {
                tab.classList.remove('active');
                if (tab.dataset.fichaId === fichaId) tab.classList.add('active');
            });

            nomePersonagemInput.value = ficha.nome || '';
            idadeInput.value = ficha.idade || 0;
            racaSpan.textContent = ficha.raca || 'Selecionar Raça';
            descricaoRacaTextarea.value = ficha.descricaoRaca || '';
            classeSpan.textContent = ficha.classe || 'Selecionar Classe';
            descricaoClasseTextarea.value = ficha.descricaoClasse || '';
            experienciaInput.value = ficha.experiencia || 0;
            atributosInputs[0].value = ficha.forca || 0;
            atributosInputs[1].value = ficha.destreza || 0;
            atributosInputs[2].value = ficha.agilidade || 0;
            atributosInputs[3].value = ficha.constituicao || 0;
            atributosInputs[4].value = ficha.inteligencia || 0;
            vidaAtualInput.value = ficha.vidaAtual || ficha.vidaTotal || 10;
            magiaAtualInput.value = ficha.magiaAtual || ficha.magiaTotal || 10;
            vigorAtualInput.value = ficha.vigorAtual || ficha.vigorTotal || 10;
            anotacoesTextarea.value = ficha.anotacoes || '';

            atualizarVantagensCompradas();
            atualizarDesvantagensCompradas();
            atualizarMagias();
            atualizarInventario();

            diceRolls = ficha.diceRolls || [];

            if (ficha.characterImage) {
                characterImage.src = ficha.characterImage;
                characterImage.style.display = 'block';
            } else {
                characterImage.style.display = 'none';
            }

            aplicarEstadoColapsoSecoes(ficha.collapsedSections);

            // Aplicar customizações
            aplicarPlanoDeFundoInicial(ficha);
            aplicarEstilosDeFundoVisuais();
            aplicarEstilosDeSombra();
            aplicarEstilosFichaInicial(ficha);
            aplicarFonteInicial(ficha);
            aplicarCoresDadoInicial(ficha);
            aplicarCustomizacoesDadoInicial(ficha);
            limparClassesDeTema();
            aplicarClassesDeTema(ficha.theme || 'theme-medieval');
            if (ficha.darkMode) {
                document.body.classList.add('dark-mode');
            } else {
                document.body.classList.remove('dark-mode');
            }

            calcularAtributos();
            atualizarNivel();
        }

        function calcularAtributos() {
            const ficha = fichas[currentFichaId];
            if (!ficha) return;

            const forcaValue = parseInt(atributosInputs[0].value) || 0;
            const destrezaValue = parseInt(atributosInputs[1].value) || 0;
            const agilidadeValue = parseInt(atributosInputs[2].value) || 0;
            const constituicaoValue = parseInt(atributosInputs[3].value) || 0;
            const inteligenciaValue = parseInt(atributosInputs[4].value) || 0;

            // Calcular valores base
            let vidaTotalCalc = constituicaoValue * 10 + 100;
            let magiaTotalCalc = inteligenciaValue * 10 + 100;
            let vigorTotalCalc = agilidadeValue * 10 + 100;
            let ataqueCalc = forcaValue;
            let ataqueMagicoCalc = inteligenciaValue;
            let acertoCalc = destrezaValue + agilidadeValue;
            let esquivaCalc = agilidadeValue;
            let rdfCalc = constituicaoValue;
            let rdmCalc = inteligenciaValue;
            let velocidadeCorridaCalc = agilidadeValue * 2 + 6;
            let alturaPuloCalc = forcaValue / 2 + 1;
            let distanciaPuloCalc = forcaValue + 2;
            let capacidadeCargaCalc = forcaValue * 10 + 50;

            // Adicionar bonuses do GM (additive)
            const gmBonuses = ficha.gmBonuses || {};
            vidaTotalSpan.textContent = vidaTotalCalc + (gmBonuses['vida-total'] || 0);
            magiaTotalSpan.textContent = magiaTotalCalc + (gmBonuses['magia-total'] || 0);
            vigorTotalSpan.textContent = vigorTotalCalc + (gmBonuses['vigor-total'] || 0);
            ataqueSpan.textContent = (ataqueCalc + (gmBonuses.ataque || 0)) + 'd6';
            ataqueMagicoSpan.textContent = (ataqueMagicoCalc + (gmBonuses['ataque-magico'] || 0)) + 'd6';
            acertoSpan.textContent = acertoCalc + (gmBonuses.acerto || 0);
            esquivaSpan.textContent = esquivaCalc + (gmBonuses.esquiva || 0);
            rdfSpan.textContent = rdfCalc + (gmBonuses.rdf || 0);
            rdmSpan.textContent = rdmCalc + (gmBonuses.rdm || 0);
            velocidadeCorridaSpan.textContent = velocidadeCorridaCalc + (gmBonuses['velocidade-corrida'] || 0);
            alturaPuloSpan.textContent = alturaPuloCalc + (gmBonuses['altura-pulo'] || 0);
            distanciaPuloSpan.textContent = distanciaPuloCalc + (gmBonuses['distancia-pulo'] || 0);
            capacidadeCargaSpan.textContent = capacidadeCargaCalc + (gmBonuses['capacidade-carga'] || 0);

            // Atualizar valores atuais se necessário
            if (parseInt(vidaAtualInput.value) > parseInt(vidaTotalSpan.textContent)) {
                vidaAtualInput.value = vidaTotalSpan.textContent;
            }
            if (parseInt(magiaAtualInput.value) > parseInt(magiaTotalSpan.textContent)) {
                magiaAtualInput.value = magiaTotalSpan.textContent;
            }
            if (parseInt(vigorAtualInput.value) > parseInt(vigorTotalSpan.textContent)) {
                vigorAtualInput.value = vigorTotalSpan.textContent;
            }

            // Calcular pontos restantes
            const pontosGastos = forcaValue + destrezaValue + agilidadeValue + constituicaoValue + inteligenciaValue;
            pontosHabilidadeSpan.textContent = 20 + (ficha.nivel - 1) * 5 - pontosGastos; // Exemplo de cálculo

            salvarFichaAtual();
        }

        function atualizarNivel() {
            const ficha = fichas[currentFichaId];
            if (!ficha) return;

            const experienciaValue = parseInt(experienciaInput.value) || 0;
            let nivelCalc = Math.floor(Math.sqrt(experienciaValue / 100)) + 1;
            const gmBonuses = ficha.gmBonuses || {};
            const nivelTotal = nivelCalc + (gmBonuses.nivel || 0);

            nivelSpan.textContent = nivelTotal;
            ficha.nivel = nivelTotal;

            if (nivelTotal >= 30) {
                fichaContainer.classList.add('aura-azul');
            } else {
                fichaContainer.classList.remove('aura-azul');
            }

            calcularAtributos();
            salvarDados();
        }

        function salvarFichaAtual() {
            const ficha = fichas[currentFichaId];
            if (!ficha) return;

            ficha.nome = nomePersonagemInput.value;
            ficha.idade = parseInt(idadeInput.value) || 0;
            ficha.raca = racaSpan.textContent;
            ficha.descricaoRaca = descricaoRacaTextarea.value;
            ficha.classe = classeSpan.textContent;
            ficha.descricaoClasse = descricaoClasseTextarea.value;
            ficha.experiencia = parseInt(experienciaInput.value) || 0;
            ficha.forca = parseInt(atributosInputs[0].value) || 0;
            ficha.destreza = parseInt(atributosInputs[1].value) || 0;
            ficha.agilidade = parseInt(atributosInputs[2].value) || 0;
            ficha.constituicao = parseInt(atributosInputs[3].value) || 0;
            ficha.inteligencia = parseInt(atributosInputs[4].value) || 0;
            ficha.vidaAtual = parseInt(vidaAtualInput.value) || 0;
            ficha.magiaAtual = parseInt(magiaAtualInput.value) || 0;
            ficha.vigorAtual = parseInt(vigorAtualInput.value) || 0;
            ficha.anotacoes = anotacoesTextarea.value;
            ficha.diceRolls = diceRolls;

            salvarDados();
        }

        function getCalculatedValue(targetId) {
            const forcaValue = parseInt(atributosInputs[0].value) || 0;
            const destrezaValue = parseInt(atributosInputs[1].value) || 0;
            const agilidadeValue = parseInt(atributosInputs[2].value) || 0;
            const constituicaoValue = parseInt(atributosInputs[3].value) || 0;
            const inteligenciaValue = parseInt(atributosInputs[4].value) || 0;
            const experienciaValue = parseInt(experienciaInput.value) || 0;

            switch (targetId) {
                case 'vida-total':
                    return constituicaoValue * 10 + 100;
                case 'magia-total':
                    return inteligenciaValue * 10 + 100;
                case 'vigor-total':
                    return agilidadeValue * 10 + 100;
                case 'ataque':
                    return forcaValue;
                case 'ataque-magico':
                    return inteligenciaValue;
                case 'acerto':
                    return destrezaValue + agilidadeValue;
                case 'esquiva':
                    return agilidadeValue;
                case 'rdf':
                    return constituicaoValue;
                case 'rdm':
                    return inteligenciaValue;
                case 'velocidade-corrida':
                    return agilidadeValue * 2 + 6;
                case 'altura-pulo':
                    return forcaValue / 2 + 1;
                case 'distancia-pulo':
                    return forcaValue + 2;
                case 'capacidade-carga':
                    return forcaValue * 10 + 50;
                case 'nivel':
                    return Math.floor(Math.sqrt(experienciaValue / 100)) + 1;
                default:
                    return 0;
            }
        }

        function handleGmEdit(event) {
            if (!isGmModeActive) return;
            const targetIcon = event.target;
            if (!targetIcon.classList.contains('gm-edit-icon')) return;

            const targetId = targetIcon.dataset.targetId;
            const fieldLabel = targetIcon.dataset.label || targetId;
            const targetElement = document.getElementById(targetId);

            if (!targetElement) return;

            const isPrimaryAttributeInput = atributosInputs.some(input => input.id === targetId);
            let currentValueToEdit;

            if (isPrimaryAttributeInput) {
                currentValueToEdit = targetElement.value;
            } else {
                currentValueToEdit = targetElement.textContent;
            }

            const newValueString = prompt(`Editar "${fieldLabel}":`, currentValueToEdit);

            if (newValueString !== null) {
                let newValue = parseFloat(newValueString);
                if (isNaN(newValue)) {
                    alert("Valor inválido.");
                    return;
                }

                const ficha = fichas[currentFichaId];
                if (!ficha.gmBonuses) {
                    ficha.gmBonuses = {};
                }

                if (isPrimaryAttributeInput) {
                    targetElement.value = newValue;
                } else {
                    // Calculate bonus as difference from current calculated value
                    const currentCalc = getCalculatedValue(targetId);
                    const bonus = newValue - currentCalc;
                    ficha.gmBonuses[targetId] = bonus;
                }

                calcularAtributos();
                atualizarNivel();
                salvarDados();

                showNotification(`"${fieldLabel}" atualizado para ${newValueString} pelo Mestre.`, "save-success");
            }
        }

        // Outras funções permanecem as mesmas, mas garanta que calcularAtributos e atualizarNivel usem os bonuses aditivos

        // Adicione listeners para inputs
        atributosInputs.forEach(input => {
            input.addEventListener('input', calcularAtributos);
        });
        experienciaInput.addEventListener('input', atualizarNivel);

        // Inicialização
        carregarFichas();

        // Dicas de funcionalidades adicionais:
        // 1. Adicionar suporte a exportar/importar fichas em JSON para backup.
        // 2. Integrar rolagens automáticas para testes de atributos (ex: clique em atributo para rolar d20 + mod).
        // 3. Adicionar seção de habilidades especiais com custos de mana/vigor.
        // 4. Suporte a multi-jogadores com sincronização via WebSocket (para sessões online).
        // 5. Galeria de imagens pré-carregadas para raças/classes.
        // 6. Calculadora de dano integrada com rolagens.
        // 7. Histórico de mudanças na ficha para undo/redo.
        // 8. Temas personalizados via upload de CSS.
        // 9. Suporte a idiomas múltiplos.
        // 10. Integração com API de RPG para sugestões de itens/magias.
    </script>
</body>
</html>
