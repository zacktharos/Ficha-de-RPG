<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ficha de Personagem RPG</title>
  <link href="https://fonts.googleapis.com/css2?family=MedievalSharp&family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/@tailwindcss/browser@4"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
  <style>
    /* **************** CSS INICIAL (sem altera√ß√µes visuais) **************** */
    body {
      font-family: 'Inter', sans-serif;
      background-color: #f0e6d2; /* Cor de pergaminho padr√£o */
      color: #000;
      display: flex;
      min-height: 100vh;
      margin: 0;
      padding: 20px;
      background-image: none;
      background-size: cover;
      background-position: center;
      background-attachment: fixed; /* Altera√ß√£o: A imagem agora se adapta √† viewport */
      transition: background 0.3s, color 0.3s;
    }
    body.dark-mode {
      background-color: #121212 !important;
      color: #e0e0e0;
    }
    #chat-btn-container { position: fixed; left: 10px; top: calc(50% - 120px); z-index: 1000; }
    #chat-btn {
      padding: 15px;
      background: #f0e6d2;
      border: 2px solid #b8860b;
      border-radius: 8px;
      font-family: 'MedievalSharp', serif;
      font-size: 1.2rem;
      color: #000;
      cursor: pointer;
      transition: background-color 0.3s ease, transform 0.2s ease;
      box-shadow: 3px 3px 7px rgba(0, 0, 0, 0.3);
      z-index: 1000;
    }
    #chat-btn:hover { background: #a0522d; transform: translateY(-3px); }
    #chat-btn::after {
      content: attr(data-unread);
      position: absolute;
      top: -10px;
      right: -10px;
      background-color: red;
      color: white;
      border-radius: 50%;
      padding: 5px;
      font-size: 0.8rem;
      min-width: 20px;
      text-align: center;
      display: none;
    }
    #chat-btn[data-unread]:after { display: block; }
    body.dark-mode #chat-btn { background: #1e1e1e; color: #e0e0e0; border-color: #444; }
    body.dark-mode #chat-btn:hover { background: #333; }
    #fichas-sidebar {
      width: 100%; height: 60px; padding: 0; display: flex; flex-direction: row;
      align-items: center; justify-content: flex-start; position: fixed;
      top: 0; left: 0; z-index: 1000; overflow-x: auto; background: transparent;
    }
    .ficha-tab {
      visibility: visible; width: 100px; height: 50px; background: #f0e6d2;
      border: 2px solid #b8860b; border-radius: 10px 10px 0 0; margin-right: 10px;
      display: flex; align-items: center; justify-content: center; cursor: pointer;
      transition: background-color 0.3s ease, transform 0.2s ease;
      box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.2);
    }
    .ficha-tab:hover, .ficha-tab.active { background: #a0522d; transform: translateY(-5px); }
    .ficha-tab span {
      font-family: 'MedievalSharp', serif; color: #000; font-size: 0.9rem; text-align: center;
      max-width: 90px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
    }
    #add-ficha-btn {
      width: 100px; height: 50px; background: #f0e6d2; border: 2px solid #b8860b;
      border-radius: 10px 10px 0 0; margin-right: 10px; display: flex; align-items: center;
      justify-content: center; cursor: pointer; transition: transform 0.2s ease;
      box-shadow: 0 0 10px #ffd700, 0 0 20px #ffd700; z-index: 1001;
    }
    #add-ficha-btn span { font-family: 'MedievalSharp', serif; color: #000; font-size: 0.9rem; }
    #add-ficha-btn:hover { background: #a0522d; transform: translateY(-5px); }
    #ficha-container {
      background: rgba(240, 230, 210, 0.95); padding: 30px; border-radius: 12px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2); width: 95%; max-width: 1200px;
      margin: 80px auto 20px; border: 2px solid #b8860b; position: relative; z-index: 1;
    }
    body.dark-mode #ficha-container { background: rgba(30, 30, 30, 0.95); color: #e0e0e0; }
    #ficha-container.aura-azul { box-shadow: 0 0 30px 15px #00BFFF; animation: pulsar-aura 2s infinite; }
    @keyframes pulsar-aura {
      0% { box-shadow: 0 0 20px #00BFFF, 0 0 30px #00BFFF, 0 0 40px #00BFFF; }
      50% { box-shadow: 0 0 30px #00BFFF, 0 0 50px #00BFFF, 0 0 60px #00BFFF; }
      100% { box-shadow: 0 0 20px #00BFFF, 0 0 30px #00BFFF, 0 0 40px #00BFFF; }
    }
    h1#nome-personagem-titulo {
      font-family: 'MedievalSharp', serif; color: #1C2526; font-size: 3rem; margin-bottom: 20px;
      text-align: center; text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1); animation: raios 2s infinite linear;
    }
    @keyframes raios {
      0% { text-shadow: 0 0 5px #FFD700, 0 0 10px #FFD700, 0 0 15px #FFD700, 0 0 20px #FF4500; }
      50% { text-shadow: 0 0 10px #FFD700, 0 0 15px #FFD700, 0 0 20px #FF4500, 0 0 25px #FF4500; }
      100% { text-shadow: 0 0 5px #FFD700, 0 0 10px #FFD700, 0 0 15px #FFD700, 0 0 20px #FF4500; }
    }
    #game-master-message { display: none; color: blue; font-size: 1.5rem; text-align: center; font-family: 'MedievalSharp', serif; margin-bottom: 10px; }
    section { background: #f0e6d2; border: 2px solid #b8860b; border-radius: 8px; padding: 15px; margin-bottom: 20px; }
    section h2 { text-align: center; }
    body.dark-mode section { background: #1e1e1e; border-color: #444; }
    label { font-weight: 600; color: #000; margin-bottom: 8px; display: block; }
    body.dark-mode label { color: #e0e0e0; }
    input[type="text"], input[type="number"], textarea {
      padding: 10px; border: 2px solid #b8860b; border-radius: 6px; width: calc(100% - 24px);
      margin-bottom: 15px; font-size: 1rem; transition: border-color 0.3s ease;
      background: #fff; color: #000;
    }
    body.dark-mode input[type="text"], body.dark-mode input[type="number"], body.dark-mode textarea {
      background: #333; color: #e0e0e0; border-color: #555;
    }
    input[type="text"]:focus, input[type="number"]:focus, textarea:focus {
      border-color: #a0522d; outline: none; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }
    input[readonly], span[readonly] { background: #e8e8e8; border: 1px solid #ccc; cursor: not-allowed; }
    body.dark-mode input[readonly], body.dark-mode span[readonly] { background: #444; border-color: #666; }
    textarea { resize: vertical; }
    .atributos-container { display: flex; justify-content: space-between; gap: 20px; }
    .atributos-coluna, .atributos-coluna-destaque {
      width: 48%; display: flex; flex-direction: column; align-items: flex-start;
    }
    .atributos-coluna-destaque { background: #fff; padding: 10px; border-radius: 6px; border: 1px solid #b8860b; }
    body.dark-mode .atributos-coluna-destaque { background: #333; border-color: #555; }
    .atributo-destaque { padding: 8px; margin-bottom: 10px; display: flex; align-items: center; justify-content: space-between; width: 100%; }
    .atributo-destaque label { font-size: 1.1rem; font-weight: 700; color: #a0522d; }
    .atributo-destaque span { font-size: 1.2rem; font-family: 'MedievalSharp', serif; color: #000; }
    body.dark-mode .atributo-destaque span { color: #e0e0e0; }
    .atributo-fogo { animation: fogo 1.5s infinite; }
    @keyframes fogo {
      0% { text-shadow: 0 0 5px #ff4500, 0 0 10px #ff4500; }
      50% { text-shadow: 0 0 10px #ff4500, 0 0 15px #ffd700; }
      100% { text-shadow: 0 0 5px #ff4500, 0 0 10px #ff4500; }
    }
    .vida-magia-vigor { display: flex; justify-content: space-around; gap: 15px; flex-wrap: wrap; }
    .atributo-container {
      background: rgba(255, 255, 255, 0.8); padding: 12px; border-radius: 8px; border: 1px solid #b8860b;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); width: 30%; min-width: 200px; text-align: center;
    }
    body.dark-mode .atributo-container { background: rgba(50, 50, 50, 0.8); }
    .atributo-container::before { font-size: 1.5rem; margin-bottom: 5px; display: block; }
    .atributo-container.vida::before { content: "‚ù§Ô∏è"; }
    .atributo-container.magia::before { content: "‚ú®"; }
    .atributo-container.vigor::before { content: "‚ö°"; }
    .medieval-box { background: #f0e6d2; border: 2px solid #b8860b; border-radius: 8px; padding: 10px; margin: 5px 0; text-align: center; }
    body.dark-mode .medieval-box { background: #1e1e1e; border-color: #444; }
    .regeneracao { font-size: 0.8rem; color: #555; margin-top: 5px; }
    body.dark-mode .regeneracao { color: #aaa; }
    button {
      background: #b8860b; color: #fff; border: none; padding: 5px 10px;
      cursor: pointer; font-size: 1.2rem; border-radius: 4px; margin: 0 5px;
      transition: background-color 0.3s ease;
    }
    body.dark-mode button { background: #555; }
    button:hover { background: #a0522d; }
    body.dark-mode button:hover { background: #777; }
    .botoes-container { display: flex; justify-content: center; gap: 10px; margin-top: 20px; margin-bottom: 20px; flex-wrap: wrap; }
    .botao {
      padding: 12px 25px; border: none; border-radius: 6px; font-size: 1rem; cursor: pointer;
      transition: background-color 0.3s ease, transform 0.2s ease; font-family: 'MedievalSharp', serif;
      color: #fff; text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
    }
    body.dark-mode .botao { background: #555; }
    body.dark-mode .botao:hover { background: #777; }
    #reset-pontos, #recomecar, #bloquear-ficha, #plano-fundo-btn, #excluir-ficha { background-color: #800000; }
    .botao-reset:hover, .botao-recomecar:hover, .botao-bloquear:hover, .botao-desbloquear:hover, #excluir-ficha:hover {
      background: #a0522d; transform: translateY(-2px);
    }
    .icon-btn {
      padding: 10px; width: 44px; height: 44px;
      font-size: 1.2rem; line-height: 1; text-align: center;
    }
    #lua-btn { background-color: #333; color: #eee; }
    #sol-btn { background-color: #ffdd00; color: #333; }
    #cor-fundo-btn { background-color: #800000; }
    #cor-fundo-btn-wrapper { line-height: 1; vertical-align: middle; }
    #nivel-container { text-align: center; margin-top: 10px; }
    #nivel {
      padding: 10px; background: #f0e6d2; border: 3px solid #000; border-radius: 50%;
      width: 100px; height: 100px; display: flex; align-items: center; justify-content: center;
      font-size: 3.125rem; box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.5); margin: 0 auto;
    }
    body.dark-mode #nivel { background: #1e1e1e; border-color: #444; }
    #nivel.aura-azul { animation: pulsar-aura 2s 10; }
    .expandable-textarea {
      height: 100px; width: 100%; background: #fff; border: 2px solid #b8860b;
      border-radius: 6px; padding: 10px; font-size: 0.9rem; transition: height 0.3s ease;
    }
    body.dark-mode .expandable-textarea { background: #333; }
    .expandable-textarea:focus { height: 15cm; }
    #dice-container {
      position: absolute; top: 20px; right: 20px; width: 200px; text-align: center;
      font-family: 'MedievalSharp', serif; cursor: move; z-index: 10; user-select: none;
    }
    #dice-container label { font-size: 1.2rem; color: #000; display: flex; align-items: center; justify-content: center; margin-bottom: 10px; }
    body.dark-mode #dice-container label { color: #e0e0e0; }
    #dice-container label::before { content: "üé≤"; margin-right: 5px; font-size: 1.5rem; }
    #dice-roll {
      width: 100px; height: 100px; background: #f0e6d2; border: 2px solid #b8860b; border-radius: 10px;
      display: flex; align-items: center; justify-content: center; font-size: 2rem; cursor: pointer;
      margin: 0 auto; position: relative; transition: all 0.3s ease;
    }
    body.dark-mode #dice-roll { background: #1e1e1e; border-color: #444; }
    #dice-roll::before { content: "‚öÖ"; font-size: 1.5rem; position: absolute; top: 5px; right: 5px; color: #a0522d; }
    #dice-result { margin-top: 10px; font-size: 1rem; color: #000; display: none; animation: blink 1s infinite; }
    body.dark-mode #dice-result { color: #e0e0e0; }
    @keyframes blink { 50% { opacity: 0; } }
    #dice-roll.critical-failure { animation: aura-vermelha 2s infinite; }
    #dice-roll.critical-success { animation: aura-verde 2s infinite; }
    @keyframes aura-vermelha {
      0% { box-shadow: 0 0 5px #ff0000, 0 0 10px #ff0000; }
      50% { box-shadow: 0 0 15px #ff0000, 0 0 20px #ff0000; }
      100% { box-shadow: 0 0 5px #ff0000, 0 0 10px #ff0000; }
    }
    @keyframes aura-verde {
      0% { box-shadow: 0 0 5px #00ff00, 0 0 10px #00ff00; }
      50% { box-shadow: 0 0 15px #00ff00, 0 0 20px #00ff00; }
      100% { box-shadow: 0 0 5px #00ff00, 0 0 10px #00ff00; }
    }
    #notification {
      position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); padding: 20px;
      border-radius: 8px; font-family: 'MedievalSharp', serif; font-size: 1.5rem; color: #fff;
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5); display: none; z-index: 100;
      background: rgba(0, 0, 0, 0.7); transition: opacity 0.3s ease;
    }
    #notification.critical-failure { background: rgba(255, 0, 0, 0.8); animation: aura-vermelha 2s infinite; }
    #notification.critical-success { background: rgba(0, 255, 0, 0.8); animation: aura-verde 2s infinite; }
    #notification.normal-result, #notification.save-success { animation: blink 1s infinite; }
    #notification.save-success { background: rgba(0, 200, 0, 0.8); }
    #character-image-container {
      position: absolute; top: 10px; left: 10px; width: 100px; height: 100px; background: #f0e6d2;
      border: 2px solid #b8860b; border-radius: 8px; display: flex; align-items: center;
      justify-content: center; cursor: pointer; overflow: hidden; z-index: 10;
    }
    body.dark-mode #character-image-container { background: #1e1e1e; }
    #character-image { width: 100%; height: 100%; object-fit: cover; display: none; }
    #character-image-container:hover { box-shadow: 0 0 10px #ffd700; }
    .modal {
      display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.5); justify-content: center; align-items: center; z-index: 1000;
    }
    .modal-content {
      background: #f0e6d2; padding: 20px; border-radius: 8px; border: 2px solid #b8860b;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3); width: 300px; text-align: center;
    }
    body.dark-mode .modal-content { background: #1e1e1e; border-color: #444; }
    .modal-content h3 { font-family: 'MedievalSharp', serif; color: #000; margin-bottom: 15px; }
    body.dark-mode .modal-content h3 { color: #e0e0e0; }
    .modal-content input { width: calc(100% - 20px); padding: 10px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 6px; }
    body.dark-mode .modal-content input { background: #333; color: #e0e0e0; border-color: #555; }
    .modal-content button {
      padding: 10px 20px; border: none; border-radius: 6px; font-family: 'MedievalSharp', serif;
      color: #fff; cursor: pointer; margin: 0 5px;
    }
    .modal-content .confirm-btn { background: #b8860b; }
    .modal-content .confirm-btn:hover { background: #a0522d; }
    .modal-content .cancel-btn { background: #a52a2a; }
    .modal-content .cancel-btn:hover { background: #8b0000; }
    #vantagens-desvantagens-btn, #racas-btn, #classes-btn {
      padding: 10px 20px; background: #f0e6d2; border: 2px solid #b8860b; border-radius: 6px;
      font-family: 'MedievalSharp', serif; font-size: 1rem; color: #000; cursor: pointer;
      transition: background-color 0.3s ease; z-index: 10;
    }
    body.dark-mode #vantagens-desvantagens-btn, body.dark-mode #racas-btn, body.dark-mode #classes-btn {
      background: #1e1e1e; color: #e0e0e0;
    }
    #vantagens-desvantagens-btn:hover, #racas-btn:hover, #classes-btn:hover { background: #a0522d; color: #fff; }
    #vantagens-desvantagens-panel, #racas-panel, #classes-panel {
      display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(240, 230, 210, 0.95); padding: 20px; overflow-y: auto; z-index: 999;
      border: 2px solid #b8860b; box-shadow: 0 0 20px rgba(0, 0, 0, 0.3);
    }
    body.dark-mode #vantagens-desvantagens-panel, body.dark-mode #racas-panel, body.dark-mode #classes-panel {
      background: rgba(30, 30, 30, 0.95);
    }
    #vantagens-desvantagens-panel h2, #racas-panel h2, #classes-panel h2 {
      font-family: 'MedievalSharp', serif; font-size: 2rem; text-align: center;
      color: #a0522d; margin-bottom: 20px;
    }
    #racas-panel h2 { font-size: 3rem; }
    .vantagem-item, .desvantagem-item, .raca-item {
      padding: 10px; margin: 5px 0; background: #fff; border: 1px solid #ccc;
      border-radius: 6px; cursor: pointer; transition: background-color 0.3s ease;
    }
    body.dark-mode .vantagem-item, body.dark-mode .desvantagem-item, body.dark-mode .raca-item {
      background: #333; border-color: #555;
    }
    .vantagem-item:hover, .desvantagem-item:hover, .raca-item:hover { background: #f0e6d2; }
    body.dark-mode .vantagem-item:hover, body.dark-mode .desvantagem-item:hover, body.dark-mode .raca-item:hover { background: #444; }
    .vantagem-item.comprada, .raca-item.comprada { background: #ffcccc; color: #f00; cursor: default; }
    .desvantagem-item.comprada { background: #ccffcc; color: #080; cursor: default; }
    #salvar-vantagens-btn, #salvar-racas-btn, #fechar-pagina-btn, #fechar-racas-btn, #fechar-classes-btn {
      position: fixed; bottom: 20px; padding: 12px 25px; background: #a52a2a; color: #fff;
      border: none; border-radius: 6px; font-family: 'MedievalSharp', serif; font-size: 1.2rem;
      cursor: pointer; transition: transform 0.2s ease;
    }
    #salvar-vantagens-btn, #salvar-racas-btn { right: 250px; animation: aura-verde-btn 2s infinite; display: none; background: #000; }
    #fechar-pagina-btn, #fechar-racas-btn, #fechar-classes-btn { right: 20px; }
    #salvar-vantagens-btn:hover, #salvar-racas-btn:hover, #fechar-pagina-btn:hover, #fechar-racas-btn:hover, #fechar-classes-btn:hover {
      transform: translateY(-2px);
    }
    @keyframes aura-verde-btn {
      0% { box-shadow: 0 0 5px #00ff00, 0 0 10px #00ff00; }
      50% { box-shadow: 0 0 15px #00ff00, 0 0 20px #00ff00; }
      100% { box-shadow: 0 0 5px #00ff00, 0 0 10px #00ff00; }
    }
    .locomotion-container { background: #8B4513; border: 3px solid #FFD700; border-radius: 10px; padding: 15px; color: #FFD700; font-family: 'MedievalSharp', serif; }
    .locomotion-item { display: flex; align-items: center; margin-bottom: 10px; }
    .locomotion-item label { font-weight: bold; color: #FFD700; }
    .locomotion-item span { font-size: 1.2rem; color: #FFF; text-shadow: 1px 1px 2px #000; margin-left: 5px; font-weight: bold; }
    #distancia-pulo, #altura-pulo, #velocidade-corrida { background-color: #8B4513; border-color: #8B4513; }
    .list-display { background: #fff; border: 2px solid #b8860b; border-radius: 6px; padding: 10px; min-height: 100px; max-height: 200px; overflow-y: auto; }
    body.dark-mode .list-display { background: #333; border-color: #555; }
    .list-item { cursor: pointer; margin-bottom: 5px; padding: 5px; border-bottom: 1px solid #ccc; }
    body.dark-mode .list-item { border-color: #555; }
    .list-item:hover { background: #e0e0e0; }
    body.dark-mode .list-item:hover { background: #444; }
    .inventory-slot { display: flex; align-items: center; margin-bottom: 10px; }
    .inventory-slot input[type="text"] { flex-grow: 1; margin-right: 10px; }
    .inventory-slot input[type="number"] { width: 60px; }
    #anotacoes-btn {
      position: fixed; left: 10px; top: 50%; transform: translateY(-50%); padding: 10px 20px;
      background: #f0e6d2; border: 2px solid #b8860b; border-radius: 6px;
      font-family: 'MedievalSharp', serif; font-size: 1rem; color: #000; cursor: pointer;
      transition: background-color 0.3s ease; z-index: 1000;
    }
    body.dark-mode #anotacoes-btn { background: #1e1e1e; color: #e0e0e0; }
    #anotacoes-btn:hover, #historico-dados-btn:hover { background: #a0522d; color: #fff; }
    #anotacoes-textarea {
      display: none; position: fixed; left: 60px; top: 50%; transform: translateY(-50%);
      width: 400px; height: 400px; background: #fff; border: 2px solid #b8860b;
      border-radius: 6px; padding: 10px; font-size: 0.9rem; resize: none; z-index: 1001;
    }
    body.dark-mode #anotacoes-textarea { background: #333; color: #e0e0e0; }
    #historico-dados-btn {
      position: fixed; right: 10px; top: 50%; transform: translateY(-50%); padding: 10px 20px;
      background: #f0e6d2; border: 2px solid #b8860b; border-radius: 6px;
      font-family: 'MedievalSharp', serif; font-size: 1rem; color: #000; cursor: pointer;
      transition: background-color 0.3s ease;
    }
    body.dark-mode #historico-dados-btn { background: #1e1e1e; color: #e0e0e0; }
    #historico-dados-panel {
      display: none; position: fixed; right: 10px; top: 50%; transform: translateY(-50%);
      width: 300px; background: #fff; border: 2px solid #b8860b; border-radius: 6px;
      padding: 10px; max-height: 400px; overflow-y: auto;
    }
    body.dark-mode #historico-dados-panel { background: #333; border-color: #555; }
    #historico-dados-panel h3 { font-family: 'MedievalSharp', serif; color: #000; margin-bottom: 10px; }
    body.dark-mode #historico-dados-panel h3 { color: #e0e0e0; }
    #historico-lista div { padding: 5px; border-bottom: 1px solid #ccc; }
    body.dark-mode #historico-lista div { border-color: #555; }
    #excluir-historico-btn { background: #a52a2a; color: #fff; padding: 8px 16px; border-radius: 6px; cursor: pointer; margin-top: 10px; }
    #excluir-historico-btn:hover { background: #8b0000; }
    .magias-container { max-height: 300px; overflow-y: auto; border: 2px solid #b8860b; border-radius: 6px; padding: 10px; background: #fff; }
    body.dark-mode .magias-container { background: #333; border-color: #555; }
    .magias-container input { margin-bottom: 10px; }
    #adicionar-magia-btn { background: #b8860b; color: #fff; padding: 8px 16px; border-radius: 6px; cursor: pointer; display: block; margin-top: 10px; }
    #adicionar-magia-btn:hover { background: #a0522d; }
    .classe-raca-container { background: #f0e6d2; border: 2px solid #b8860b; padding: 10px; border-radius: 6px; margin-top: 10px; }
    body.dark-mode .classe-raca-container { background: #1e1e1e; border-color: #444; }
    .classe-raca-container label { font-family: 'MedievalSharp', serif; color: #a0522d; font-size: 1.2rem; }
    .classe-raca-container span[onclick] { background: #fff; border: 2px solid #b8860b; padding: 10px; cursor: pointer; display: block; }
    body.dark-mode .classe-raca-container span[onclick] { background: #333; color: #e0e0e0; }
    .classe-raca-container textarea { width: 100%; background: #fff; border: 2px solid #b8860b; }
    body.dark-mode .classe-raca-container textarea { background: #333; color: #e0e0e0; }
    .raca-item { margin-bottom: 20px; padding: 10px; background: #fff; border: 2px solid #b8860b; border-radius: 6px; }
    .raca-item h3 { font-family: 'MedievalSharp', serif; font-size: 1.5rem; color: #a0522d; }
    .raca-item p { font-size: 1rem; color: #000; }
    body.dark-mode .raca-item { background: #333; border-color: #555; }
    body.dark-mode .raca-item p { color: #e0e0e0; }
    .theme-color-container { display: flex; justify-content: center; gap: 10px; margin-top: -10px; margin-bottom: 20px; }
    #background-color-selector {
      bottom: 100%; left: 50%;
      transform: translateX(-50%);
      margin-bottom: 5px;
      margin-top: 0;
      display: none;
      position: absolute; background-color: #fff; border: 1px solid #ccc; padding: 10px; border-radius: 5px; z-index: 1002; display: flex; gap: 10px;
    }
    #background-color-selector { display: none; }
    @media (max-width: 768px) {
      body { padding: 10px; }
      #ficha-container { padding: 15px; }
      h1#nome-personagem-titulo { font-size: 2rem; }
      section h2 { font-size: 1.2rem; }
      input, textarea { font-size: 0.9rem; }
      .atributos-container, .vida-magia-vigor { flex-direction: column; }
      .atributos-coluna, .atributos-coluna-destaque, .atributo-container { width: 100%; }
      .botoes-container, .theme-color-container { flex-direction: row; flex-wrap: wrap; }
    }
    /* Estilos para o modal de chat */
    #chat-modal { display: none; }
    #chat-modal .modal-content { width: 500px; max-height: 80vh; display: flex; flex-direction: column; }
    #chat-modal .chat-header { padding: 10px; border-bottom: 1px solid #ccc; font-family: 'MedievalSharp', serif; font-size: 1.5rem; text-align: center; }
    #chat-modal .chat-body { flex-grow: 1; display: flex; overflow: hidden; }
    #chat-modal .user-list { width: 150px; border-right: 1px solid #ccc; overflow-y: auto; padding: 10px; }
    #chat-modal .user-list h4 { font-family: 'MedievalSharp', serif; margin-bottom: 5px; }
    #chat-modal .user-list .user-item { padding: 8px; cursor: pointer; border-bottom: 1px solid #eee; }
    #chat-modal .user-list .user-item:hover { background-color: #f0e6d2; }
    body.dark-mode #chat-modal .user-list .user-item:hover { background-color: #333; }
    #chat-modal .conversation { flex-grow: 1; padding: 10px; overflow-y: auto; display: flex; flex-direction: column; }
    #chat-modal .message-container { display: flex; flex-direction: column; margin-bottom: 8px; }
    #chat-modal .message { padding: 8px; border-radius: 5px; background-color: #e0e0e0; color: #000; width: fit-content; max-width: 80%; }
    body.dark-mode #chat-modal .message { background-color: #444; color: #e0e0e0; }
    #chat-modal .message.sent { background-color: #cce5ff; align-self: flex-end; }
    body.dark-mode #chat-modal .message.sent { background-color: #6699cc; color: #e0e0e0; }
    #chat-modal .sender-name { font-size: 0.8rem; color: #777; margin-bottom: 2px; }
    body.dark-mode #chat-modal .sender-name { color: #aaa; }
    #chat-modal .chat-input { padding: 10px; border-top: 1px solid #ccc; display: flex; }
    #chat-modal .chat-input input[type="text"] { flex-grow: 1; padding: 8px; border-radius: 5px; border: 1px solid #ccc; margin-right: 10px; }
    body.dark-mode #chat-modal .chat-input input[type="text"] { background-color: #333; color: #e0e0e0; border-color: #555; }
    #chat-modal .chat-input button { padding: 8px 15px; border-radius: 5px; }
    /* Estilos para os modais de senha do chat */
    #chat-password-modal .modal-content, #open-chat-modal .modal-content { width: 350px; }
    /* Espa√ßamento dos bot√µes de ra√ßa */
    #raca-opcoes-modal .modal-content button:nth-child(2) { margin-top: 10px; }
    /* Estilos para o modal de plano de fundo */
    #background-modal { display: none; }
    #background-modal .modal-content { width: 400px; text-align: left; }
    #background-modal .modal-content label { display: block; margin-bottom: 5px; }
    #background-modal .modal-content input[type="file"] { margin-bottom: 10px; }
    #background-modal .modal-content .radio-group { margin-bottom: 15px; }
    #background-modal .modal-content .radio-group label { display: inline-block; margin-right: 10px; }
    /* Estilos para o seletor de cor de fundo */
    .color-option { width: 24px; height: 24px; border-radius: 50%; cursor: pointer; border: 1px solid #ccc; }
  </style>
</head>
<body>
  <div id="chat-btn-container">
    <button id="chat-btn" data-unread="0">üí¨ Chat</button>
  </div>
  <div id="fichas-sidebar">
    <div id="add-ficha-btn"><span>+ Fichas</span></div>
  </div>
  <div id="ficha-container">
    <h1 id="nome-personagem-titulo">Ficha de Personagem</h1>
    <div id="game-master-message">Voc√™ virou o Game Master</div>
    <div id="character-image-container" onclick="document.getElementById('character-image-input').click()">
      <img id="character-image" alt="Imagem do Personagem">
      <input type="file" id="character-image-input" accept="image/*" style="display:none">
    </div>
    <div id="dice-container">
      <label>Role seu dado:</label>
      <div id="dice-roll">-</div>
      <div id="dice-result"></div>
    </div>
    <div id="ficha-content">
      <section id="informacoes-basicas">
        <h2>Informa√ß√µes B√°sicas</h2>
        <label for="nome-personagem">Nome do Personagem:</label>
        <input type="text" id="nome-personagem" placeholder="Digite o nome do seu personagem">
        <label for="descricao-personagem">Descri√ß√£o do Personagem:</label>
        <textarea id="descricao-personagem" placeholder="Digite a descri√ß√£o do seu personagem"></textarea>
      </section>
      <section id="recursos">
        <h2>Recursos</h2>
        <div class="vida-magia-vigor">
          <div class="atributo-container vida">
            <h3>Vida</h3>
            <div class="valor-total medieval-box">
              <span>Vida Total: </span>
              <span id="vida-total" readonly>50</span>
            </div>
            <div class="valor-atual medieval-box">
              <span>Vida Atual: </span>
              <button onclick="diminuirVida()" title="Diminuir Vida">‚ñº</button>
              <span id="vida-atual">50</span>
              <button onclick="aumentarVida()" title="Aumentar Vida">‚ñ≤</button>
            </div>
            <div class="regeneracao">
              <span>Regenera√ß√£o por turno: <span id="regeneracao-vida">0</span> (parado)</span>
            </div>
          </div>
          <div class="atributo-container magia">
            <h3>Magia</h3>
            <div class="valor-total medieval-box">
              <span>Magia Total: </span>
              <span id="magia-total" readonly>20</span>
            </div>
            <div class="valor-atual medieval-box">
              <span>Magia Atual: </span>
              <button onclick="diminuirMagia()" title="Diminuir Magia">‚ñº</button>
              <span id="magia-atual">20</span>
              <button onclick="aumentarMagia()" title="Aumentar Magia">‚ñ≤</button>
            </div>
            <div class="regeneracao">
              <span>Regenera√ß√£o por turno: <span id="regeneracao-magia">0</span></span>
            </div>
          </div>
          <div class="atributo-container vigor">
            <h3>Vigor</h3>
            <div class="valor-total medieval-box">
              <span>Vigor Total: </span>
              <span id="vigor-total" readonly>10</span>
            </div>
            <div class="valor-atual medieval-box">
              <span>Vigor Atual: </span>
              <button onclick="diminuirVigor()" title="Diminuir Vigor">‚ñº</button>
              <span id="vigor-atual">10</span>
              <button onclick="aumentarVigor()" title="Aumentar Vigor">‚ñ≤</button>
            </div>
            <div class="regeneracao">
              <span>Regenera√ß√£o por turno: <span id="regeneracao-vigor">0</span> (parado)</span>
            </div>
          </div>
        </div>
      </section>
      <section id="atributos">
        <h2>Atributos</h2>
        <div class="atributos-container">
          <div class="atributos-coluna">
            <div class="atributo">
              <label for="forca" title="Afeta ataque e RDF">For√ßa:</label>
              <input type="number" id="forca" value="0" min="0">
            </div>
            <div class="atributo">
              <label for="destreza" title="Afeta ataque e acerto">Destreza:</label>
              <input type="number" id="destreza" value="0" min="0">
            </div>
            <div class="atributo">
              <label for="agilidade" title="Afeta esquiva e acerto">Agilidade:</label>
              <input type="number" id="agilidade" value="0" min="0">
            </div>
            <div class="atributo">
              <label for="constituicao" title="Afeta vida, magia e vigor">Constitui√ß√£o:</label>
              <input type="number" id="constituicao" value="0" min="0">
            </div>
            <div class="atributo">
              <label for="inteligencia" title="Afeta ataque m√°gico e RDM">Intelig√™ncia:</label>
              <input type="number" id="inteligencia" value="0" min="0">
            </div>
          </div>
          <div class="atributos-coluna-destaque">
            <div class="atributo-destaque">
              <label>Ataque:</label>
              <span id="ataque" readonly>0</span>
            </div>
            <div class="atributo-destaque">
              <label>Ataque M√°gico:</label>
              <span id="ataque-magico" readonly>0</span>
            </div>
            <div class="atributo-destaque">
              <label>Acerto:</label>
              <span id="acerto" readonly>0</span>
            </div>
            <div class="atributo-destaque">
              <label>Esquiva:</label>
              <span id="esquiva" readonly>0</span>
            </div>
            <div class="atributo-destaque">
              <label>RDF:</label>
              <span id="rdf" readonly>0</span>
            </div>
            <div class="atributo-destaque">
              <label>RDM:</label>
              <span id="rdm" readonly>0</span>
            </div>
          </div>
        </div>
      </section>
      <section id="combate">
        <h2>Combate</h2>
        <div class="armamento-container">
          <div class="armamento-coluna">
            <label>Armamento M√£o Direita:</label>
            <div class="flex items-center mb-2">
              <input type="text" id="arma-direita-nome" placeholder="Nome da Arma" class="mr-2">
              <span>Ataque </span>
              <input type="number" id="arma-direita-ataque" value="0" class="w-20 mr-2">
              <span>Ataque M√°gico </span>
              <input type="number" id="arma-direita-ataque-magico" value="0" class="w-20">
            </div>
          </div>
          <div class="armamento-coluna">
            <label>Armamento M√£o Esquerda:</label>
            <div class="flex items-center">
              <input type="text" id="arma-esquerda-nome" placeholder="Nome da Arma" class="mr-2">
              <span>Ataque </span>
              <input type="number" id="arma-esquerda-ataque" value="0" class="w-20 mr-2">
              <span>Ataque M√°gico </span>
              <input type="number" id="arma-esquerda-ataque-magico" value="0" class="w-20">
            </div>
          </div>
        </div>
      </section>
      <section id="inventario-habilidades">
        <h2>Invent√°rio e Habilidades</h2>
        <div class="flex gap-20">
          <div style="width:50%">
            <label>Invent√°rio (Peso Total: <span id="peso-total">0</span> kg):</label>
            <div id="inventario-slots">
              <div class="inventory-slot"><input type="text" placeholder="Item 1" class="inventory-item"><input type="number" min="0" value="0" class="inventory-weight" title="Peso em kg"></div>
              <div class="inventory-slot"><input type="text" placeholder="Item 2" class="inventory-item"><input type="number" min="0" value="0" class="inventory-weight"></div>
              <div class="inventory-slot"><input type="text" placeholder="Item 3" class="inventory-item"><input type="number" min="0" value="0" class="inventory-weight"></div>
              <div class="inventory-slot"><input type="text" placeholder="Item 4" class="inventory-item"><input type="number" min="0" value="0" class="inventory-weight"></div>
              <div class="inventory-slot"><input type="text" placeholder="Item 5" class="inventory-item"><input type="number" min="0" value="0" class="inventory-weight"></div>
              <div class="inventory-slot"><input type="text" placeholder="Item 6" class="inventory-item"><input type="number" min="0" value="0" class="inventory-weight"></div>
              <div class="inventory-slot"><input type="text" placeholder="Item 7" class="inventory-item"><input type="number" min="0" value="0" class="inventory-weight"></div>
              <div class="inventory-slot"><input type="text" placeholder="Item 8" class="inventory-item"><input type="number" min="0" value="0" class="inventory-weight"></div>
              <div class="inventory-slot"><input type="text" placeholder="Item 9" class="inventory-item"><input type="number" min="0" value="0" class="inventory-weight"></div>
              <div class="inventory-slot"><input type="text" placeholder="Item 10" class="inventory-item"><input type="number" min="0" value="0" class="inventory-weight"></div>
            </div>
          </div>
          <div style="width:50%">
            <label>Magias e Habilidades:</label>
            <div id="magias-list" class="magias-container">
              <input type="text" placeholder="Magia/Habilidade 1" class="magia-nome">
              <input type="text" placeholder="Magia/Habilidade 2" class="magia-nome">
              <input type="text" placeholder="Magia/Habilidade 3" class="magia-nome">
              <input type="text" placeholder="Magia/Habilidade 4" class="magia-nome">
              <input type="text" placeholder="Magia/Habilidade 5" class="magia-nome">
              <input type="text" placeholder="Magia/Habilidade 6" class="magia-nome">
              <input type="text" placeholder="Magia/Habilidade 7" class="magia-nome">
              <input type="text" placeholder="Magia/Habilidade 8" class="magia-nome">
              <input type="text" placeholder="Magia/Habilidade 9" class="magia-nome">
              <input type="text" placeholder="Magia/Habilidade 10" class="magia-nome">
            </div>
            <button id="adicionar-magia-btn">Adicionar Magia</button>
          </div>
        </div>
        <div class="mt-4">
          <label>Vantagens:</label>
          <div id="vantagens-list-display" class="list-display"></div>
          <label>Desvantagens:</label>
          <div id="desvantagens-list-display" class="list-display"></div>
        </div>
        <div class="classe-raca-container">
          <label>Classe:</label>
          <input type="text" id="classe-nome" placeholder="Nome da Classe">
          <textarea id="classe-descricao" placeholder="Descri√ß√£o da Classe" class="expandable-textarea"></textarea>
          <label>Ra√ßa:</label>
          <span id="raca-nome" onclick="abrirModalRaca()"></span>
          <textarea id="raca-descricao" placeholder="Descri√ß√£o da Ra√ßa" class="expandable-textarea" readonly></textarea>
        </div>
      </section>
      <section id="locomocao">
        <h2>Locomo√ß√£o</h2>
        <div class="locomotion-container">
          <div class="locomotion-item">
            <label>Velocidade de Corrida (km/h):</label>
            <span>üèÉ‚Äç‚ôÇÔ∏è</span>
            <span id="velocidade-corrida" readonly>25</span>
          </div>
          <div class="locomotion-item">
            <label>Altura do Pulo (m):</label>
            <span>‚¨ÜÔ∏è</span>
            <span id="altura-pulo" readonly>1</span>
          </div>
          <div class="locomotion-item">
            <label>Dist√¢ncia do Pulo (m):</label>
            <span>‚û°Ô∏è</span>
            <span id="distancia-pulo" readonly>3</span>
          </div>
        </div>
      </section>
      <section id="status">
        <h2>Status</h2>
        <div class="flex gap-20">
          <div>
            <label>Experi√™ncia:</label>
            <input type="number" id="experiencia" value="0" min="0">
            <label>Pontos de Habilidade (PD):</label>
            <span id="pontos-habilidade" readonly>25</span>
            <label>Pontos de Vantagem (PH):</label>
            <span id="pontos-vantagem" readonly>8</span>
          </div>
          <div></div>
        </div>
        <div id="nivel-container">
          <label>N√≠vel:</label>
          <span id="nivel">0</span>
        </div>
      </section>
      <div style="display:flex;justify-content:center;gap:20px;margin-bottom:20px">
        <button id="vantagens-desvantagens-btn">Vantagens e Desvantagens</button>
        <button id="racas-btn">Ra√ßas üè∞</button>
        <button id="classes-btn">Classes ‚öîÔ∏è</button>
      </div>
      <div class="botoes-container">
        <button id="reset-pontos" class="botao botao-reset">Reiniciar Pontos</button>
        <button id="recomecar" class="botao botao-recomecar">Recome√ßar</button>
        <button id="bloquear-ficha" class="botao botao-bloquear">Bloquear Ficha</button>
        <button id="plano-fundo-btn" class="botao">Plano de fundo</button>
        <button id="excluir-ficha" class="botao botao-excluir">Excluir Ficha</button>
      </div>
      <div class="theme-color-container">
        <button id="lua-btn" class="botao icon-btn">üåô</button>
        <button id="sol-btn" class="botao icon-btn">‚òÄÔ∏è</button>
        <div id="cor-fundo-btn-wrapper" style="display: inline-block; position: relative;">
          <button id="cor-fundo-btn" class="botao icon-btn">üé®</button>
          <div id="background-color-selector">
            <div class="color-option" style="background-color: #800000;" data-color="#800000"></div>
            <div class="color-option" style="background-color: #000080;" data-color="#000080"></div>
            <div class="color-option" style="background-color: #ffffff;" data-color="#ffffff"></div>
            <div class="color-option" style="background-color: #f0e6d2;" data-color="#f0e6d2"></div>
            <div class="color-option" style="background-color: #ffc0cb;" data-color="#ffc0cb"></div>
            <div class="color-option" style="background-color: #006400;" data-color="#006400"></div>
            <div class="color-option" style="background-color: #ff0000;" data-color="#ff0000"></div>
            <div class="color-option" style="background-color: #808080;" data-color="#808080"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <button id="anotacoes-btn">Anota√ß√µes</button>
  <textarea id="anotacoes-textarea" placeholder="Suas anota√ß√µes aqui..."></textarea>
  <button id="historico-dados-btn">Hist√≥rico de dados</button>
  <div id="historico-dados-panel">
    <h3>Hist√≥rico de Dados</h3>
    <div id="historico-lista"></div>
    <button id="excluir-historico-btn">Excluir hist√≥rico</button>
  </div>
  <div id="vantagens-desvantagens-panel">
    <h2>Vantagens e Desvantagens</h2>
    <div>Pontos de Vantagem Tempor√°rios: <span id="ph-temp">0</span></div>
    <div id="vantagens-list"></div>
    <div id="desvantagens-list"></div>
    <button id="salvar-vantagens-btn">SALVAR</button>
    <button id="fechar-pagina-btn">Fechar P√°gina</button>
  </div>
  <div id="racas-panel">
    <h2>Ra√ßas</h2>
    <div id="ph-temp-raca-container" style="text-align: center; margin-bottom: 10px;">Pontos de Vantagem Tempor√°rios: <span id="ph-temp-raca">0</span></div>
    <div id="racas-list"></div>
    <button id="salvar-racas-btn">SALVAR</button>
    <button id="fechar-racas-btn">Fechar P√°gina</button>
  </div>
  <div id="classes-panel">
    <h2>Classes</h2>
    <button id="fechar-classes-btn">Fechar P√°gina</button>
  </div>
  <div id="nome-ficha-modal" class="modal">
    <div class="modal-content">
      <h3>D√™ um Nome √† Ficha</h3>
      <input type="text" id="nome-ficha-input" placeholder="Nome da ficha" maxlength="20">
      <button class="confirm-btn" onclick="criarNovaFicha()">Confirmar</button>
      <button class="cancel-btn" onclick="fecharModal('nome-ficha-modal')">Cancelar</button>
    </div>
  </div>
  <div id="bloquear-ficha-modal" class="modal">
    <div class="modal-content">
      <h3>Ponha sua Senha de 4 D√≠gitos</h3>
      <input type="password" id="senha-bloqueio-input" placeholder="Senha (4 d√≠gitos)" maxlength="4">
      <button class="confirm-btn" onclick="bloquearFicha()">Confirmar</button>
      <button class="cancel-btn" onclick="fecharModal('bloquear-ficha-modal')">Cancelar</button>
    </div>
  </div>
  <div id="password-modal" class="modal">
    <div class="modal-content">
      <h3>Digite sua Senha</h3>
      <input type="password" id="senha-desbloqueio-input" placeholder="Senha (4 d√≠gitos)" maxlength="4">
      <button class="confirm-btn" onclick="desbloquearFicha()">Confirmar</button>
      <button class="cancel-btn" onclick="cancelarDesbloqueio()">Cancelar</button>
    </div>
  </div>
  <div id="confirmar-compra-modal" class="modal">
    <div class="modal-content">
      <h3>Tem certeza que quer comprar isso?</h3>
      <button class="confirm-btn" id="confirmar-compra-btn">Sim</button>
      <button class="cancel-btn" onclick="fecharModal('confirmar-compra-modal')">N√£o</button>
    </div>
  </div>
  <div id="salvar-vantagens-modal" class="modal">
    <div class="modal-content">
      <h3 id="salvar-modal-texto">Se salvar, as altera√ß√µes n√£o poder√£o ser desfeitas.</h3>
      <button class="confirm-btn" id="confirmar-salvar-btn">OK</button>
      <button class="cancel-btn" onclick="fecharModal('salvar-vantagens-modal')">Cancelar</button>
    </div>
  </div>
  <div id="senha-gm-modal" class="modal">
    <div class="modal-content">
      <h3>Pe√ßa permiss√£o ao GM</h3>
      <input type="password" id="senha-gm-input" placeholder="Senha GM">
      <button class="confirm-btn" id="confirmar-senha-gm-btn">Confirmar</button>
      <button class="cancel-btn" onclick="fecharModal('senha-gm-modal')">Cancelar</button>
    </div>
  </div>
  <div id="raca-opcoes-modal" class="modal">
    <div class="modal-content">
      <h3>O que voc√™ deseja fazer?</h3>
      <button class="confirm-btn" onclick="excluirRacaSelecionadaModal()">Excluir Ra√ßa</button>
      <button class="confirm-btn" onclick="editarRacaSelecionadaModal()" style="margin-top: 10px;">Editar Ra√ßa</button>
      <button class="cancel-btn" onclick="fecharModal('raca-opcoes-modal')">Cancelar</button>
    </div>
  </div>
  <div id="editar-raca-modal" class="modal">
    <div class="modal-content">
      <h3>Editar Ra√ßa</h3>
      <label for="editar-raca-nome">Nome:</label>
      <input type="text" id="editar-raca-nome">
      <label for="editar-raca-descricao">Descri√ß√£o:</label>
      <textarea id="editar-raca-descricao"></textarea>
      <button class="confirm-btn" onclick="salvarEdicaoRaca()">Salvar</button>
      <button class="cancel-btn" onclick="fecharModal('editar-raca-modal')">Cancelar</button>
    </div>
  </div>
  <div id="chat-password-modal" class="modal">
    <div class="modal-content">
      <h3>Definir Senha do Chat</h3>
      <input type="password" id="chat-senha-input" placeholder="Senha do Chat">
      <input type="password" id="chat-confirmar-senha-input" placeholder="Confirmar Senha">
      <button class="confirm-btn" onclick="definirSenhaChat()">Confirmar</button>
      <button class="cancel-btn" onclick="fecharModal('chat-password-modal')">Cancelar</button>
    </div>
  </div>
  <div id="open-chat-modal" class="modal">
    <div class="modal-content">
      <h3>Digite a Senha do Chat</h3>
      <input type="password" id="abrir-chat-senha-input" placeholder="Senha do Chat">
      <button class="confirm-btn" onclick="abrirChat()">Confirmar</button>
      <button class="cancel-btn" onclick="fecharModal('open-chat-modal')">Cancelar</button>
    </div>
  </div>
  <div id="chat-modal" class="modal">
    <div class="modal-content">
      <div class="chat-header">Chat Privado</div>
      <div class="chat-body">
        <div class="user-list">
          <h4>Fichas Online</h4>
          <div id="available-fichas"></div>
        </div>
        <div class="conversation" id="conversation-area"></div>
      </div>
      <div class="chat-input">
        <input type="text" id="mensagem-input" placeholder="Digite sua mensagem...">
        <button onclick="enviarMensagem()">Enviar</button>
      </div>
      <button class="cancel-btn" onclick="fecharModal('chat-modal')">Fechar Chat</button>
    </div>
  </div>
  <div id="notification"></div>
  <audio id="new-message-sound" preload="auto">
    <source src="notification_sound.mp3" type="audio/mpeg">
  </audio>
  <div id="background-modal" class="modal">
    <div class="modal-content">
      <h3>Plano de Fundo</h3>
      <label for="background-image-input">Selecionar Imagem:</label>
      <input type="file" id="background-image-input" accept="image/*">
      <div class="radio-group">
        <label><input type="radio" name="background-size" value="cover" checked>Preencher Tela</label>
        <label><input type="radio" name="background-size" value="100% 100%">Estender</label>
        <label><input type="radio" name="background-size" value="auto">Tamanho Normal</label>
      </div>
      <button class="confirm-btn" onclick="aplicarPlanoDeFundo()">Aplicar</button>
      <button class="cancel-btn" onclick="fecharModal('background-modal')">Cancelar</button>
      <button class="cancel-btn" onclick="excluirPlanoDeFundo()">Excluir Imagem</button>
    </div>
  </div>
  <script>
    // **************** JavaScript (Firebase e Fun√ß√µes de Ficha) ****************
    const firebaseConfig = {
      apiKey: "AIzaSyBbbwbwPXv6gztkyP3TXK-DtooEI7FcClI",
      authDomain: "ficha-de-rpg-b9685.firebaseapp.com",
      databaseURL: "https://ficha-de-rpg-b9685-default-rtdb.firebaseio.com",
      projectId: "ficha-de-rpg-b9685",
      storageBucket: "ficha-de-rpg-b9685.firebasestorage.app",
      messagingSenderId: "528610398062",
      appId: "1:528610398062:web:8fdb9cfd5ded8167613b7f"
    };
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    let fichas = {}, currentFichaId = null, isFichaLocked = false, fichaPassword = null,
        isFichaUnlocked = false, senhaMatriz = "1040", vantagensSelecionadas = [],
        desvantagensSelecionadas = [], tempVantagensSelecionadas = [], tempDesvantagensSelecionadas = [],
        racaSelecionada = null, tempRacaSelecionada = null, vidaTotal, vidaAtual, magiaTotal, magiaAtual,
        vigorTotal, vigorAtual, previousValues = new Map(), chatPassword = null, isChatOpen = false, selectedChatUser = null;

    const vantagensData = [
      { nome: "Maestria com Armas curtas (2)", custo: 2, descricao: "+1 em ataque, +1 em acerto com armas curtas." },
      { nome: "Maestria com armas pesadas (2)", custo: 2, descricao: "+2 em ataque com armas pesadas." },
      { nome: "Maestria com armas de longo alcance (2)", custo: 2, descricao: "+2 em acerto com armas de longo alcance." },
      { nome: "Furtar (2)", custo: 2, descricao: "+4 em testes de furto." },
      { nome: "L√°bia (2)", custo: 2, descricao: "+5 em testes de l√°bia." },
      { nome: "Velejar (1)", custo: 1, descricao: "" },
      { nome: "Beleza (1)", custo: 1, descricao: "+3 o teste em l√°bia, paquera e persuas√£o." },
      { nome: "Boa Fama (2)", custo: 2, descricao: "+4 chance de descontos em armamentos, pousadas, alimentos, etc." },
      { nome: "Arremedo (2)", custo: 2, descricao: "Capacidade de imitar qualquer som SIMPLES." },
      { nome: "Destemor (1)", custo: 1, descricao: "Dificilmente √© assustado por algo." },
      { nome: "Empatia (3)", custo: 3, descricao: "Sensibilidade extraordin√°ria em rela√ß√£o aos outras pessoas. Excelente para identificar impostores, possess√µes por espirito, etc." },
      { nome: "Empatia com animais (1)", custo: 1, descricao: "Pode compreender as motiva√ß√µes dos animais." },
      { nome: "Patrono (4)", custo: 4, descricao: "Possui um mentor/mestre/professor, at√© mesmo uma organiza√ß√£o/guilda que pode lhe oferecer ajuda." },
      { nome: "Reconhecimento Social (2)", custo: 2, descricao: "Membro de um grupo respeitado/temido/venerado. +2 teste em l√°bia, paquera e persuas√£o." },
      { nome: "Riqueza (2)", custo: 2, descricao: "Inicia com 20 moedas de ouro." },
      { nome: "Aptid√£o para magia (4)", custo: 4, descricao: "+15% dano e -15% custo de magia para a magia que tem aptid√£o." },
      { nome: "Combo F√≠sico (4)", custo: 4, descricao: "Inicia com 50km velocidade corrida, pulo de 3m altura e 9m dist√¢ncia.", restricao: "inicio" },
      { nome: "Nadar (1)", custo: 1, descricao: "" },
      { nome: "Escalar (2)", custo: 2, descricao: "" },
      { nome: "Segunda l√≠ngua (1)", custo: 1, descricao: "Fala mais um idioma." },
      { nome: "Paquerador (2)", custo: 2, descricao: "+4 em teste para paquera e persuas√£o envolvendo flerte." },
      { nome: "Senso de perigo (5)", custo: 5, descricao: "Quando algo grave ocorrer o mestre pedir√° pra voc√™ jogar um dado para reagir." },
      { nome: "Acrobata (3)", custo: 3, descricao: "+ fama ao lutar em p√∫blico." },
      { nome: "Equil√≠brio Perfeito (3)", custo: 3, descricao: "+8 em testes de equil√≠brio." },
      { nome: "Tecnologia (2)", custo: 2, descricao: "Engenhoso, pode inventar coisas, criar objetos improvisados." },
      { nome: "Poder Oculto (7)", custo: 7, descricao: "Com 10% vida, ativa +50% em todos atributos. Volta ao normal acima de 10% vida." },
      { nome: "Sobreviv√™ncia em floresta (2)", custo: 2, descricao: "Facilidade para achar cavernas, criar assentamentos, achar comida, gravar caminhos, achar √°gua, etc." }
    ];
    const desvantagensData = [
      { nome: "Fobia (+2)", ganho: 2, descricao: "Medo irracional de algo espec√≠fico." },
      { nome: "M√° Fama (+2)", ganho: 2, descricao: "Mal visto pela sociedade, dificultando intera√ß√µes sociais." },
      { nome: "Alcoolismo (+2)", ganho: 2, descricao: "Depend√™ncia de √°lcool que afeta suas decis√µes." },
      { nome: "Altru√≠smo (+2)", ganho: 2, descricao: "Se sacrifica por outras pessoas, pouco se importa com fama ou riqueza." },
      { nome: "Avareza (+2)", ganho: 2, descricao: "Preocupa√ß√£o permanente na conserva√ß√£o de riquezas." },
      { nome: "Bullying (+3)", ganho: 3, descricao: "Gosta de ca√ßoar, agredir, denegrir, difamar e apontar defeitos." }
      // Outros dados de desvantagens podem continuar conforme seu arquivo original...
    ];
    // Outras constantes e dados (ex.: racasData, etc.) permanecem inalterados conforme o original.

    // Fun√ß√£o que calcula os atributos, inclusive os de locomo√ß√£o (com corre√ß√£o do b√¥nus "Combo F√≠sico")
    function calcularAtributos() {
      const forca = parseInt(document.getElementById("forca").value) || 0,
            destreza = parseInt(document.getElementById("destreza").value) || 0,
            agilidade = parseInt(document.getElementById("agilidade").value) || 0,
            inteligencia = parseInt(document.getElementById("inteligencia").value) || 0,
            constituicao = parseInt(document.getElementById("constituicao").value) || 0;
      
      let totalPontos = forca + destreza + agilidade + inteligencia + constituicao;
      if (totalPontos > Number(document.getElementById("pontos-habilidade").textContent)) {
        alert("Pontos de habilidade insuficientes!");
        return;
      }
      // C√°lculo dos atributos de combate
      let ataque = forca + Math.floor(destreza / 5),
          acerto = Math.floor(destreza / 3) + Math.floor(agilidade / 10),
          esquiva = Math.floor(agilidade / 3),
          rdf = Math.floor(forca / 5),
          rdm = Math.floor(inteligencia / 5),
          ataqueMagico = inteligencia;
      // C√°lculo dos b√¥nus de locomo√ß√£o
      const velocidadeBase = 25 + Math.floor(agilidade / 3) * 3,
            alturaPuloBase = 1 + Math.floor(forca / 10),
            distanciaPuloBase = 3 + 3 * Math.min(Math.floor(forca / 5), Math.floor(agilidade / 5));
      // Verifica se alguma vantagem aplicada cont√©m "Combo F√≠sico" e, se sim, soma os b√¥nus
      let bonusVelocidade = vantagensSelecionadas.some(v => v.includes("Combo F√≠sico")) ? 25 : 0;
      let bonusAlturaPulo = vantagensSelecionadas.some(v => v.includes("Combo F√≠sico")) ? 2 : 0;
      let bonusDistanciaPulo = vantagensSelecionadas.some(v => v.includes("Combo F√≠sico")) ? 6 : 0;
      
      document.getElementById("velocidade-corrida").textContent = velocidadeBase + bonusVelocidade;
      document.getElementById("altura-pulo").textContent = alturaPuloBase + bonusAlturaPulo;
      document.getElementById("distancia-pulo").textContent = distanciaPuloBase + bonusDistanciaPulo;

      // Atualize tamb√©m os atributos de combate na interface conforme seu c√≥digo original...
    }

    // Fun√ß√µes do plano de fundo
    function aplicarPlanoDeFundo() {
      const file = document.getElementById("background-image-input").files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = e => {
          const imageUrl = e.target.result;
          document.body.style.backgroundImage = `url('${imageUrl}')`;
          const selectedSize = document.querySelector('input[name="background-size"]:checked').value;
          document.body.style.backgroundSize = selectedSize;
          salvarDados();
          fecharModal('background-modal');
        };
        reader.readAsDataURL(file);
      } else if (document.body.style.backgroundImage !== 'none') {
        const selectedSize = document.querySelector('input[name="background-size"]:checked').value;
        document.body.style.backgroundSize = selectedSize;
        salvarDados();
        fecharModal('background-modal');
      } else {
        alert("Nenhuma imagem selecionada.");
      }
    }
    function excluirPlanoDeFundo() {
      if (confirm("Remover imagem de fundo?")) {
        document.body.style.backgroundImage = 'none';
        salvarDados();
        fecharModal('background-modal');
      }
    }
    function aplicarPlanoDeFundoInicial() {
      const bgImage = fichas[currentFichaId]?.backgroundImage;
      const bgSize = fichas[currentFichaId]?.backgroundSize || 'cover';
      if (currentFichaId && fichas[currentFichaId] && bgImage) {
        document.body.style.backgroundImage = `url('${bgImage}')`;
        document.body.style.backgroundSize = bgSize;
      } else {
        document.body.style.backgroundImage = 'none';
      }
    }
    // Fun√ß√µes de cor de fundo
    const corFundoBtn = document.getElementById("cor-fundo-btn"),
          backgroundColorSelector = document.getElementById("background-color-selector");
    corFundoBtn.onclick = () => {
      backgroundColorSelector.style.display = (backgroundColorSelector.style.display === 'none' || backgroundColorSelector.style.display === '') ? 'flex' : 'none';
    };
    backgroundColorSelector.addEventListener('click', (event) => {
      if (event.target.classList.contains('color-option')) {
        const color = event.target.dataset.color;
        document.body.style.backgroundColor = color;
        salvarDados();
        backgroundColorSelector.style.display = 'none';
        document.querySelectorAll('#background-color-selector .color-option').forEach(option => option.classList.remove('active'));
        event.target.classList.add('active');
      }
    });
    function aplicarCorDeFundoInicial() {
      const bgColor = fichas[currentFichaId]?.backgroundColor;
      if (currentFichaId && fichas[currentFichaId] && bgColor) {
        document.body.style.backgroundColor = bgColor;
        document.querySelectorAll('#background-color-selector .color-option').forEach(option => {
          option.classList.toggle('active', option.dataset.color === bgColor);
        });
      } else {
        document.body.style.backgroundColor = '#f0e6d2';
      }
    }
    document.addEventListener('click', function(event) {
      if (!backgroundColorSelector.contains(event.target) && !corFundoBtn.contains(event.target)) {
        backgroundColorSelector.style.display = 'none';
      }
    });

    // Fun√ß√£o de salvamento dos dados (bug corrigido)
    function salvarDados() {
      if (!currentFichaId) return;
      const fichaAtualizada = {
        nomePersonagem: document.getElementById("nome-personagem").value,
        descricaoPersonagem: document.getElementById("descricao-personagem").value,
        forca: document.getElementById("forca").value,
        destreza: document.getElementById("destreza").value,
        agilidade: document.getElementById("agilidade").value,
        constituicao: document.getElementById("constituicao").value,
        inteligencia: document.getElementById("inteligencia").value,
        experiencia: document.getElementById("experiencia").value,
        armaDireitaNome: document.getElementById("arma-direita-nome").value,
        armaDireitaAtaque: document.getElementById("arma-direita-ataque").value,
        armaDireitaAtaqueMagico: document.getElementById("arma-direita-ataque-magico").value,
        armaEsquerdaNome: document.getElementById("arma-esquerda-nome").value,
        armaEsquerdaAtaque: document.getElementById("arma-esquerda-ataque").value,
        armaEsquerdaAtaqueMagico: document.getElementById("arma-esquerda-ataque-magico").value,
        vantagens: vantagensSelecionadas.join("\n"),
        desvantagens: desvantagensSelecionadas.join("\n"),
        inventario: JSON.stringify(Array.from(document.querySelectorAll('.inventory-slot')).map(slot => {
          return { 
            item: slot.querySelector('.inventory-item').value, 
            peso: slot.querySelector('.inventory-weight').value 
          };
        })),
        velocidadeCorrida: document.getElementById("velocidade-corrida").textContent,
        alturaPulo: document.getElementById("altura-pulo").textContent,
        distanciaPulo: document.getElementById("distancia-pulo").textContent,
        backgroundImage: document.body.style.backgroundImage && document.body.style.backgroundImage !== "none" ? document.body.style.backgroundImage.slice(5, -2) : null,
        backgroundSize: document.body.style.backgroundSize,
        backgroundColor: document.body.style.backgroundColor
      };
      database.ref("fichas/" + currentFichaId).update(fichaAtualizada)
        .then(() => console.log("Dados salvos com sucesso"))
        .catch(error => console.error("Erro ao salvar dados:", error));
    }

    // Fun√ß√µes auxiliares (fechar modal, etc.)
    function fecharModal(modalId) {
      document.getElementById(modalId).style.display = "none";
    }
    // Outras fun√ß√µes de cria√ß√£o, edi√ß√£o e manipula√ß√£o da ficha permanecem inalteradas.

    // Inicializa√ß√£o: carregamento das fichas e aplica√ß√£o dos dados de plano de fundo e cor
    function carregarFichas() {
      // Implemente aqui a fun√ß√£o de carregamento de fichas do Firebase conforme seu c√≥digo original...
      // Ap√≥s carregar, defina currentFichaId e chame:
      aplicarPlanoDeFundoInicial();
      aplicarCorDeFundoInicial();
      calcularAtributos();
    }

    carregarFichas();
  </script>
</body>
</html>
