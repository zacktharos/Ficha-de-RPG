<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ficha de Personagem RPG</title>
    <link href="https://fonts.googleapis.com/css2?family=MedievalSharp&family=Inter:wght@400;600&family=Times+New+Roman&family=Arial&family=Courier+New&family=Georgia&family=Verdana&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0e6d2; /* Cor de pergaminho padrão */
            color: #000;
            display: flex;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            background-image: none;
            background-size: cover;
            background-position: center;
            transition: background 0.3s, color 0.3s, font-family 0.3s;
        }
        body.dark-mode {
            background-color: #121212 !important; /* Garante que o fundo seja sempre escuro */
            color: #e0e0e0;
        }
        #fichas-sidebar {
            width: 100%; height: 60px; padding: 0; display: flex; flex-direction: row;
            align-items: center; justify-content: flex-start; position: fixed;
            top: 0; left: 0; z-index: 1000; overflow-x: auto; background: transparent;
        }
        .ficha-tab {
            visibility: visible; width: 100px; height: 50px; background: #f0e6d2;
            border: 2px solid #b8860b; border-radius: 10px 10px 0 0; margin-right: 10px;
            display: flex; align-items: center; justify-content: center; cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.2);
        }
        .ficha-tab:hover, .ficha-tab.active { background: #a0522d; transform: translateY(-5px); }
        .ficha-tab span {
            font-family: 'MedievalSharp', serif; color: #000; font-size: 0.9rem; text-align: center;
            max-width: 90px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
        }
        #add-ficha-btn {
            width: 100px; height: 50px; background: #f0e6d2; border: 2px solid #b8860b;
            border-radius: 10px 10px 0 0; margin-right: 10px; display: flex; align-items: center;
            justify-content: center; cursor: pointer; transition: transform 0.2s ease;
            box-shadow: 0 0 10px #ffd700, 0 0 20px #ffd700; z-index: 1001;
        }
        #add-ficha-btn span { font-family: 'MedievalSharp', serif; color: #000; font-size: 0.9rem; }
        #add-ficha-btn:hover { background: #a0522d; transform: translateY(-5px); }
        #ficha-container {
            background: rgba(240, 230, 210, 0.95); padding: 30px; border-radius: 12px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2); width: 95%; max-width: 1200px;
            margin: 80px auto 20px; border: 2px solid #b8860b; position: relative; z-index: 1;
            transition: font-family 0.3s; /* Add transition for font changes */
        }
        body.dark-mode #ficha-container { background: rgba(30, 30, 30, 0.95); color: #e0e0e0; }
        #ficha-container.aura-azul { box-shadow: 0 0 30px 15px #00BFFF; animation: pulsar-aura 2s infinite; }
        @keyframes pulsar-aura {
            0% { box-shadow: 0 0 20px #00BFFF, 0 0 30px #00BFFF, 0 0 40px #00BFFF; }
            50% { box-shadow: 0 0 30px #00BFFF, 0 0 50px #00BFFF, 0 0 60px #00BFFF; }
            100% { box-shadow: 0 0 20px #00BFFF, 0 0 30px #00BFFF, 0 0 40px #00BFFF; }
        }
        h1#nome-personagem-titulo {
            font-family: 'MedievalSharp', serif; color: #1C2526; font-size: 3rem; margin-bottom: 20px;
            text-align: center; text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1); animation: raios 2s infinite linear;
        }
        @keyframes raios {
            0% { text-shadow: 0 0 5px #FFD700, 0 0 10px #FFD700, 0 0 15px #FFD700, 0 0 20px #FF4500; }
            50% { text-shadow: 0 0 10px #FFD700, 0 0 15px #FFD700, 0 0 20px #FF4500, 0 0 25px #FF4500; }
            100% { text-shadow: 0 0 5px #FFD700, 0 0 10px #FFD700, 0 0 15px #FFD700, 0 0 20px #FF4500; }
        }
        #game-master-message { display: none; color: blue; font-size: 1.5rem; text-align: center; font-family: 'MedievalSharp', serif; margin-bottom: 10px; }
        section { background: #f0e6d2; border: 2px solid #b8860b; border-radius: 8px; padding: 15px; margin-bottom: 20px; }
        section h2 { text-align: center; font-family: 'MedievalSharp', serif;} /* Titles specific font */
        body.dark-mode section { background: #1e1e1e; border-color: #444; }
        label { font-weight: 600; color: #000; margin-bottom: 8px; display: block; }
        body.dark-mode label { color: #e0e0e0; }
        input[type="text"], input[type="number"], textarea {
            padding: 10px; border: 2px solid #b8860b; border-radius: 6px; width: calc(100% - 24px);
            margin-bottom: 15px; font-size: 1rem; transition: border-color 0.3s ease;
            background: #fff; color: #000;
        }
        body.dark-mode input[type="text"], body.dark-mode input[type="number"], body.dark-mode textarea {
            background: #333; color: #e0e0e0; border-color: #555;
        }
        input[type="text"]:focus, input[type="number"]:focus, textarea:focus {
            border-color: #a0522d; outline: none; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        input[readonly], span[readonly] { background: #e8e8e8; border: 1px solid #ccc; cursor: not-allowed; }
        body.dark-mode input[readonly], body.dark-mode span[readonly] { background: #444; border-color: #666; }
        textarea { resize: vertical; }
        .atributos-container { display: flex; justify-content: space-between; gap: 20px; }
        .atributos-coluna, .atributos-coluna-destaque {
            width: 48%; display: flex; flex-direction: column; align-items: flex-start;
        }
        .atributos-coluna-destaque { background: #fff; padding: 10px; border-radius: 6px; border: 1px solid #b8860b; }
        body.dark-mode .atributos-coluna-destaque { background: #333; border-color: #555; }
        .atributo-destaque { padding: 8px; margin-bottom: 10px; display: flex; align-items: center; justify-content: space-between; width: 100%; }
        .atributo-destaque label { font-size: 1.1rem; font-weight: 700; color: #a0522d; }
        .atributo-destaque span { font-size: 1.2rem; font-family: 'MedievalSharp', serif; color: #000; }
        body.dark-mode .atributo-destaque span { color: #e0e0e0; }
        .atributo-fogo { animation: fogo 1.5s infinite; }
        @keyframes fogo {
            0% { text-shadow: 0 0 5px #ff4500, 0 0 10px #ff4500; }
            50% { text-shadow: 0 0 10px #ff4500, 0 0 15px #ffd700; }
            100% { text-shadow: 0 0 5px #ff4500, 0 0 10px #ff4500; }
        }
        .vida-magia-vigor { display: flex; justify-content: space-around; gap: 15px; flex-wrap: wrap; }
        .atributo-container {
            background: rgba(255, 255, 255, 0.8); padding: 12px; border-radius: 8px; border: 1px solid #b8860b;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); width: 30%; min-width: 200px; text-align: center;
        }
        body.dark-mode .atributo-container { background: rgba(50, 50, 50, 0.8); }
        .atributo-container::before { font-size: 1.5rem; margin-bottom: 5px; display: block; }
        .atributo-container.vida::before { content: "❤️"; }
        .atributo-container.magia::before { content: "✨"; }
        .atributo-container.vigor::before { content: "⚡"; }
        .medieval-box { background: #f0e6d2; border: 2px solid #b8860b; border-radius: 8px; padding: 10px; margin: 5px 0; text-align: center; }
        body.dark-mode .medieval-box { background: #1e1e1e; border-color: #444; }
        .regeneracao { font-size: 0.8rem; color: #555; margin-top: 5px; }
        body.dark-mode .regeneracao { color: #aaa; }
        button {
            background: #b8860b; color: #fff; border: none; padding: 5px 10px;
            cursor: pointer; font-size: 1.2rem; border-radius: 4px; margin: 0 5px;
            transition: background-color 0.3s ease;
        }
        body.dark-mode button { background: #555; }
        button:hover { background: #a0522d; }
        body.dark-mode button:hover { background: #777; }
        .botoes-container { display: flex; justify-content: center; gap: 10px; margin-top: 20px; margin-bottom: 20px; flex-wrap: wrap; }
        .botao {
            padding: 12px 25px; border: none; border-radius: 6px; font-size: 1rem; cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease; font-family: 'MedievalSharp', serif;
            color: #fff; text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
        }
        body.dark-mode .botao { background: #555; }
        body.dark-mode .botao:hover { background: #777; }
        #reset-pontos, #recomecar, #bloquear-ficha, #plano-fundo-btn, #excluir-ficha { background-color: #800000; }
        .botao-reset:hover, .botao-recomecar:hover, .botao-bloquear:hover, .botao-desbloquear:hover, #excluir-ficha:hover {
            background: #a0522d; transform: translateY(-2px);
        }
        .icon-btn {
            padding: 10px; width: 44px; height: 44px;
            font-size: 1.2rem; line-height: 1; text-align: center;
        }
        #lua-btn { background-color: #333; color: #eee; }
        #sol-btn { background-color: #ffdd00; color: #333; }
        #cor-fundo-visual-btn { /* Will be styled dynamically by JS */ }
        #nivel-container { text-align: center; margin-top: 10px; }
        #nivel {
            padding: 10px; background: #f0e6d2; border: 3px solid #000; border-radius: 50%;
            width: 100px; height: 100px; display: flex; align-items: center; justify-content: center;
            font-size: 3.125rem; box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.5); margin: 0 auto;
            font-family: 'MedievalSharp', serif; /* Specific font */
        }
        body.dark-mode #nivel { background: #1e1e1e; border-color: #444; }
        #nivel.aura-azul { animation: pulsar-aura 2s 10; }
        .expandable-textarea {
            height: 100px; width: 100%; background: #fff; border: 2px solid #b8860b;
            border-radius: 6px; padding: 10px; font-size: 0.9rem; transition: height 0.3s ease;
        }
        body.dark-mode .expandable-textarea { background: #333; }
        .expandable-textarea:focus { height: 15cm; }
        #dice-container {
            position: absolute; top: 20px; right: 20px; width: 200px; text-align: center;
            font-family: 'MedievalSharp', serif; cursor: move; z-index: 10; user-select: none;
        }
        #dice-container label { font-size: 1.2rem; color: #000; display: flex; align-items: center; justify-content: center; margin-bottom: 10px; }
        body.dark-mode #dice-container label { color: #e0e0e0; }
        #dice-container label::before { content: "🎲"; margin-right: 5px; font-size: 1.5rem; }
        #dice-roll {
            width: 100px; height: 100px; background: #f0e6d2; border: 2px solid #b8860b; border-radius: 10px;
            display: flex; align-items: center; justify-content: center; font-size: 2rem; cursor: pointer;
            margin: 0 auto; position: relative; transition: all 0.3s ease;
             font-family: 'MedievalSharp', serif; /* Specific font */
        }
        body.dark-mode #dice-roll { background: #1e1e1e; border-color: #444; }
        #dice-roll::before { content: "⚅"; font-size: 1.5rem; position: absolute; top: 5px; right: 5px; color: #a0522d; }
        #dice-result { margin-top: 10px; font-size: 1rem; color: #000; display: none; animation: blink 1s infinite; }
        body.dark-mode #dice-result { color: #e0e0e0; }
        @keyframes blink { 50% { opacity: 0; } }
        #dice-roll.critical-failure { animation: aura-vermelha 2s infinite; }
        #dice-roll.critical-success { animation: aura-verde 2s infinite; }
        @keyframes aura-vermelha {
            0% { box-shadow: 0 0 5px #ff0000, 0 0 10px #ff0000; }
            50% { box-shadow: 0 0 15px #ff0000, 0 0 20px #ff0000; }
            100% { box-shadow: 0 0 5px #ff0000, 0 0 10px #ff0000; }
        }
        @keyframes aura-verde {
            0% { box-shadow: 0 0 5px #00ff00, 0 0 10px #00ff00; }
            50% { box-shadow: 0 0 15px #00ff00, 0 0 20px #00ff00; }
            100% { box-shadow: 0 0 5px #00ff00, 0 0 10px #00ff00; }
        }
        #notification {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); padding: 20px;
            border-radius: 8px; font-family: 'MedievalSharp', serif; font-size: 1.5rem; color: #fff;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5); display: none; z-index: 100;
            background: rgba(0, 0, 0, 0.7); transition: opacity 0.3s ease;
        }
        #notification.critical-failure { background: rgba(255, 0, 0, 0.8); animation: aura-vermelha 2s infinite; }
        #notification.critical-success { background: rgba(0, 255, 0, 0.8); animation: aura-verde 2s infinite; }
        #notification.normal-result, #notification.save-success { animation: blink 1s infinite; }
        #notification.save-success { background: rgba(0, 200, 0, 0.8); }
        #character-image-container {
            position: absolute; top: 10px; left: 10px; width: 100px; height: 100px; background: #f0e6d2;
            border: 2px solid #b8860b; border-radius: 8px; display: flex; align-items: center;
            justify-content: center; cursor: pointer; overflow: hidden; z-index: 10;
        }
        body.dark-mode #character-image-container { background: #1e1e1e; }
        #character-image { width: 100%; height: 100%; object-fit: cover; display: none; }
        #character-image-container:hover { box-shadow: 0 0 10px #ffd700; }
        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.5); justify-content: center; align-items: center; z-index: 1000;
        }
        .modal-content {
            background: #f0e6d2; padding: 20px; border-radius: 8px; border: 2px solid #b8860b;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3); width: 300px; text-align: center;
        }
        body.dark-mode .modal-content { background: #1e1e1e; border-color: #444; }
        .modal-content h3 { font-family: 'MedievalSharp', serif; color: #000; margin-bottom: 15px; }
        body.dark-mode .modal-content h3 { color: #e0e0e0; }
        .modal-content input { width: calc(100% - 20px); padding: 10px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 6px; }
        body.dark-mode .modal-content input { background: #333; color: #e0e0e0; border-color: #555; }
        .modal-content button {
            padding: 10px 20px; border: none; border-radius: 6px; font-family: 'MedievalSharp', serif;
            color: #fff; cursor: pointer; margin: 0 5px;
        }
        .modal-content .confirm-btn { background: #b8860b; }
        .modal-content .confirm-btn:hover { background: #a0522d; }
        .modal-content .cancel-btn { background: #a52a2a; }
        .modal-content .cancel-btn:hover { background: #8b0000; }
        #vantagens-desvantagens-btn, #racas-btn, #classes-btn {
            padding: 10px 20px; background: #f0e6d2; border: 2px solid #b8860b; border-radius: 6px;
            font-family: 'MedievalSharp', serif; font-size: 1rem; color: #000; cursor: pointer;
            transition: background-color 0.3s ease; z-index: 10;
        }
        body.dark-mode #vantagens-desvantagens-btn, body.dark-mode #racas-btn, body.dark-mode #classes-btn {
            background: #1e1e1e; color: #e0e0e0;
        }
        #vantagens-desvantagens-btn:hover, #racas-btn:hover, #classes-btn:hover { background: #a0522d; color: #fff; }
        #vantagens-desvantagens-panel, #racas-panel, #classes-panel {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(240, 230, 210, 0.95); padding: 20px; overflow-y: auto; z-index: 999;
            border: 2px solid #b8860b; box-shadow: 0 0 20px rgba(0, 0, 0, 0.3);
        }
        body.dark-mode #vantagens-desvantagens-panel, body.dark-mode #racas-panel, body.dark-mode #classes-panel {
            background: rgba(30, 30, 30, 0.95);
        }
        #vantagens-desvantagens-panel h2, #racas-panel h2, #classes-panel h2 {
            font-family: 'MedievalSharp', serif; font-size: 2rem; text-align: center;
            color: #a0522d; margin-bottom: 20px;
        }
        #racas-panel h2 { font-size: 3rem; }
        .vantagem-item, .desvantagem-item, .raca-item {
            padding: 10px; margin: 5px 0; background: #fff; border: 1px solid #ccc;
            border-radius: 6px; cursor: pointer; transition: background-color 0.3s ease;
        }
        body.dark-mode .vantagem-item, body.dark-mode .desvantagem-item, body.dark-mode .raca-item {
            background: #333; border-color: #555;
        }
        .vantagem-item:hover, .desvantagem-item:hover, .raca-item:hover { background: #f0e6d2; }
        body.dark-mode .vantagem-item:hover, body.dark-mode .desvantagem-item:hover, body.dark-mode .raca-item:hover { background: #444; }
        .vantagem-item.comprada, .raca-item.comprada { background: #ffcccc; color: #f00; cursor: default; }
        .desvantagem-item.comprada { background: #ccffcc; color: #080; cursor: default; }
        #salvar-vantagens-btn, #salvar-racas-btn, #fechar-pagina-btn, #fechar-racas-btn, #fechar-classes-btn {
            position: fixed; bottom: 20px; padding: 12px 25px; background: #a52a2a; color: #fff;
            border: none; border-radius: 6px; font-family: 'MedievalSharp', serif; font-size: 1.2rem;
            cursor: pointer; transition: transform 0.2s ease;
        }
        #salvar-vantagens-btn, #salvar-racas-btn { right: 250px; animation: aura-verde-btn 2s infinite; display: none; background: #000; }
        #fechar-pagina-btn, #fechar-racas-btn, #fechar-classes-btn { right: 20px; }
        #salvar-vantagens-btn:hover, #salvar-racas-btn:hover, #fechar-pagina-btn:hover, #fechar-racas-btn:hover, #fechar-classes-btn:hover {
            transform: translateY(-2px);
        }
        @keyframes aura-verde-btn {
            0% { box-shadow: 0 0 5px #00ff00, 0 0 10px #00ff00; }
            50% { box-shadow: 0 0 15px #00ff00, 0 0 20px #00ff00; }
            100% { box-shadow: 0 0 5px #00ff00, 0 0 10px #00ff00; }
        }
        .locomotion-container { background: #8B4513; border: 3px solid #FFD700; border-radius: 10px; padding: 15px; color: #FFD700; font-family: 'MedievalSharp', serif; }
        .locomotion-item { display: flex; align-items: center; margin-bottom: 10px; }
        .locomotion-item label { font-weight: bold; color: #FFD700; }
        .locomotion-item span { font-size: 1.2rem; color: #FFF; text-shadow: 1px 1px 2px #000; margin-left: 5px; font-weight: bold; }
        #distancia-pulo, #altura-pulo, #velocidade-corrida { background-color: #8B4513; border-color: #8B4513; }
        .list-display { background: #fff; border: 2px solid #b8860b; border-radius: 6px; padding: 10px; min-height: 100px; max-height: 200px; overflow-y: auto; }
        body.dark-mode .list-display { background: #333; border-color: #555; }
        .list-item { cursor: pointer; margin-bottom: 5px; padding: 5px; border-bottom: 1px solid #ccc; }
        body.dark-mode .list-item { border-color: #555; }
        .list-item:hover { background: #e0e0e0; }
        body.dark-mode .list-item:hover { background: #444; }
        .inventory-slot { display: flex; align-items: center; margin-bottom: 10px; }
        .inventory-slot input[type="text"] { flex-grow: 1; margin-right: 10px; }
        .inventory-slot input[type="number"] { width: 60px; }
        #anotacoes-btn {
            position: fixed; left: 10px; top: 50%; transform: translateY(-50%); padding: 10px 20px;
            background: #f0e6d2; border: 2px solid #b8860b; border-radius: 6px;
            font-family: 'MedievalSharp', serif; font-size: 1rem; color: #000; cursor: pointer;
            transition: background-color 0.3s ease; z-index: 1000;
        }
        body.dark-mode #anotacoes-btn { background: #1e1e1e; color: #e0e0e0; }
        #anotacoes-btn:hover { background: #a0522d; color: #fff; }
        #anotacoes-textarea {
            display: none; position: fixed; left: 60px; top: 50%; transform: translateY(-50%);
            width: 400px; height: 400px; background: #fff; border: 2px solid #b8860b;
            border-radius: 6px; padding: 10px; font-size: 0.9rem; resize: none; z-index: 1001;
        }
        body.dark-mode #anotacoes-textarea { background: #333; color: #e0e0e0; }
        .magias-container { max-height: 300px; overflow-y: auto; border: 2px solid #b8860b; border-radius: 6px; padding: 10px; background: #fff; }
        body.dark-mode .magias-container { background: #333; border-color: #555; }
        .magias-container input { margin-bottom: 10px; }
        #adicionar-magia-btn { background: #b8860b; color: #fff; padding: 8px 16px; border-radius: 6px; cursor: pointer; display: block; margin-top: 10px; }
        #adicionar-magia-btn:hover { background: #a0522d; }
        .classe-raca-container { background: #f0e6d2; border: 2px solid #b8860b; padding: 10px; border-radius: 6px; margin-top: 10px; }
        body.dark-mode .classe-raca-container { background: #1e1e1e; border-color: #444; }
        .classe-raca-container label { font-family: 'MedievalSharp', serif; color: #a0522d; font-size: 1.2rem; }
        .classe-raca-container span[onclick] { background: #fff; border: 2px solid #b8860b; padding: 10px; cursor: pointer; display: block; }
        body.dark-mode .classe-raca-container span[onclick] { background: #333; color: #e0e0e0; }
        .classe-raca-container textarea { width: 100%; background: #fff; border: 2px solid #b8860b; }
        body.dark-mode .classe-raca-container textarea { background: #333; color: #e0e0e0; }
        .raca-item { margin-bottom: 20px; padding: 10px; background: #fff; border: 2px solid #b8860b; border-radius: 6px; }
        .raca-item h3 { font-family: 'MedievalSharp', serif; font-size: 1.5rem; color: #a0522d; }
        .raca-item p { font-size: 1rem; color: #000; }
        body.dark-mode .raca-item { background: #333; border-color: #555; }
        body.dark-mode .raca-item p { color: #e0e0e0; }
        .theme-color-container { display: flex; justify-content: center; align-items:center; gap: 10px; margin-top: -10px; margin-bottom: 20px; }
        .theme-option { position: relative; }
        #cor-fundo-visual-btn { cursor: pointer; }

        @media (max-width: 768px) {
            body { padding: 10px; }
            #ficha-container { padding: 15px; }
            h1#nome-personagem-titulo { font-size: 2rem; }
            section h2 { font-size: 1.2rem; }
            input, textarea { font-size: 0.9rem; }
            .atributos-container, .vida-magia-vigor { flex-direction: column; }
            .atributos-coluna, .atributos-coluna-destaque, .atributo-container { width: 100%; }
            .botoes-container, .theme-color-container { flex-direction: row; flex-wrap: wrap; }
        }
        #raca-opcoes-modal .modal-content button:nth-child(2) { margin-top: 10px; }
        #background-modal { display: none; }
        #background-modal .modal-content { width: 400px; text-align: left; }
        #background-modal .modal-content label { display: block; margin-bottom: 5px; }
        #background-modal .modal-content input[type="file"] { margin-bottom: 10px; }
        #background-modal .modal-content .radio-group { margin-bottom: 15px; }
        #background-modal .modal-content .radio-group label { display: inline-block; margin-right: 10px; }
        .color-option { width: 24px; height: 24px; border-radius: 50%; cursor: pointer; border: 1px solid #ccc; }
    </style>
</head>
<body>
    <div id="fichas-sidebar">
        <div id="add-ficha-btn"><span>+ Fichas</span></div>
    </div>
    <div id="ficha-container">
        <h1 id="nome-personagem-titulo">Ficha de Personagem</h1>
        <div id="game-master-message">Você virou o Game Master</div>
        <div id="character-image-container" onclick="document.getElementById('character-image-input').click()">
            <img id="character-image" alt="Imagem do Personagem" onerror="this.style.display='none'; this.src='https://placehold.co/100x100/f0e6d2/b8860b?text=Imagem'">
            <input type="file" id="character-image-input" accept="image/*" style="display:none">
        </div>
        <div id="dice-container">
            <label>Role seu dado:</label>
            <div id="dice-roll">-</div>
            <div id="dice-result"></div>
        </div>
        <div id="ficha-content">
            <section id="informacoes-basicas">
                <h2>Informações Básicas</h2>
                <label for="nome-personagem">Nome do Personagem:</label>
                <input type="text" id="nome-personagem" placeholder="Digite o nome do seu personagem">
                <label for="descricao-personagem">Descrição do Personagem:</label>
                <textarea id="descricao-personagem" placeholder="Digite a descrição do seu personagem"></textarea>
            </section>
            <section id="recursos">
                <h2>Recursos</h2>
                <div class="vida-magia-vigor">
                    <div class="atributo-container vida">
                        <h3>Vida</h3>
                        <div class="valor-total medieval-box">
                            <span>Vida Total: </span>
                            <span id="vida-total" readonly>50</span>
                        </div>
                        <div class="valor-atual medieval-box">
                            <span>Vida Atual: </span>
                            <button id="btn-diminuir-vida" title="Diminuir Vida">▼</button>
                            <span id="vida-atual">50</span>
                            <button id="btn-aumentar-vida" title="Aumentar Vida">▲</button>
                        </div>
                        <div class="regeneracao">
                            <span>Regeneração por turno: <span id="regeneracao-vida">0</span> (parado)</span>
                        </div>
                    </div>
                    <div class="atributo-container magia">
                        <h3>Magia</h3>
                        <div class="valor-total medieval-box">
                            <span>Magia Total: </span>
                            <span id="magia-total" readonly>20</span>
                        </div>
                        <div class="valor-atual medieval-box">
                            <span>Magia Atual: </span>
                            <button id="btn-diminuir-magia" title="Diminuir Magia">▼</button>
                            <span id="magia-atual">20</span>
                            <button id="btn-aumentar-magia" title="Aumentar Magia">▲</button>
                        </div>
                        <div class="regeneracao">
                            <span>Regeneração por turno: <span id="regeneracao-magia">0</span></span>
                        </div>
                    </div>
                    <div class="atributo-container vigor">
                        <h3>Vigor</h3>
                        <div class="valor-total medieval-box">
                            <span>Vigor Total: </span>
                            <span id="vigor-total" readonly>10</span>
                        </div>
                        <div class="valor-atual medieval-box">
                            <span>Vigor Atual: </span>
                            <button id="btn-diminuir-vigor" title="Diminuir Vigor">▼</button>
                            <span id="vigor-atual">10</span>
                            <button id="btn-aumentar-vigor" title="Aumentar Vigor">▲</button>
                        </div>
                        <div class="regeneracao">
                            <span>Regeneração por turno: <span id="regeneracao-vigor">0</span> (parado)</span>
                        </div>
                    </div>
                </div>
            </section>
            <section id="atributos">
                <h2>Atributos</h2>
                <div class="atributos-container">
                    <div class="atributos-coluna">
                        <div class="atributo">
                            <label for="forca" title="Afeta ataque e RDF">Força:</label>
                            <input type="number" id="forca" value="0" min="0">
                        </div>
                        <div class="atributo">
                            <label for="destreza" title="Afeta ataque e acerto">Destreza:</label>
                            <input type="number" id="destreza" value="0" min="0">
                        </div>
                        <div class="atributo">
                            <label for="agilidade" title="Afeta esquiva e acerto">Agilidade:</label>
                            <input type="number" id="agilidade" value="0" min="0">
                        </div>
                        <div class="atributo">
                            <label for="constituicao" title="Afeta vida, magia e vigor">Constituição:</label>
                            <input type="number" id="constituicao" value="0" min="0">
                        </div>
                        <div class="atributo">
                            <label for="inteligencia" title="Afeta ataque mágico e RDM">Inteligência:</label>
                            <input type="number" id="inteligencia" value="0" min="0">
                        </div>
                    </div>
                    <div class="atributos-coluna-destaque">
                        <div class="atributo-destaque">
                            <label>Ataque:</label>
                            <span id="ataque" readonly>0</span>
                        </div>
                        <div class="atributo-destaque">
                            <label>Ataque Mágico:</label>
                            <span id="ataque-magico" readonly>0</span>
                        </div>
                        <div class="atributo-destaque">
                            <label>Acerto:</label>
                            <span id="acerto" readonly>0</span>
                        </div>
                        <div class="atributo-destaque">
                            <label>Esquiva:</label>
                            <span id="esquiva" readonly>0</span>
                        </div>
                        <div class="atributo-destaque">
                            <label>RDF:</label>
                            <span id="rdf" readonly>0</span>
                        </div>
                        <div class="atributo-destaque">
                            <label>RDM:</label>
                            <span id="rdm" readonly>0</span>
                        </div>
                    </div>
                </div>
            </section>
            <section id="combate">
                <h2>Combate</h2>
                <div class="armamento-container">
                    <div class="armamento-coluna">
                        <label>Armamento Mão Direita:</label>
                        <div class="flex items-center mb-2">
                            <input type="text" id="arma-direita-nome" placeholder="Nome da Arma" class="mr-2">
                            <span>Ataque </span>
                            <input type="number" id="arma-direita-ataque" value="0" class="w-20 mr-2">
                            <span>Ataque Mágico </span>
                            <input type="number" id="arma-direita-ataque-magico" value="0" class="w-20">
                        </div>
                    </div>
                    <div class="armamento-coluna">
                        <label>Armamento Mão Esquerda:</label>
                        <div class="flex items-center">
                            <input type="text" id="arma-esquerda-nome" placeholder="Nome da Arma" class="mr-2">
                            <span>Ataque </span>
                            <input type="number" id="arma-esquerda-ataque" value="0" class="w-20 mr-2">
                            <span>Ataque Mágico </span>
                            <input type="number" id="arma-esquerda-ataque-magico" value="0" class="w-20">
                        </div>
                    </div>
                </div>
            </section>
            <section id="inventario-habilidades">
                <h2>Inventário e Habilidades</h2>
                <div class="flex gap-20">
                    <div style="width:50%">
                        <label>Inventário (Peso Total: <span id="peso-total">0</span> kg / <span id="capacidade-carga">5</span> kg):</label>
                        <div id="inventario-slots">
                            <div class="inventory-slot"><input type="text" placeholder="Item 1" class="inventory-item"><input type="number" min="0" value="0" class="inventory-weight" title="Peso em kg"></div>
                            <div class="inventory-slot"><input type="text" placeholder="Item 2" class="inventory-item"><input type="number" min="0" value="0" class="inventory-weight"></div>
                            <div class="inventory-slot"><input type="text" placeholder="Item 3" class="inventory-item"><input type="number" min="0" value="0" class="inventory-weight"></div>
                            <div class="inventory-slot"><input type="text" placeholder="Item 4" class="inventory-item"><input type="number" min="0" value="0" class="inventory-weight"></div>
                            <div class="inventory-slot"><input type="text" placeholder="Item 5" class="inventory-item"><input type="number" min="0" value="0" class="inventory-weight"></div>
                            <div class="inventory-slot"><input type="text" placeholder="Item 6" class="inventory-item"><input type="number" min="0" value="0" class="inventory-weight"></div>
                            <div class="inventory-slot"><input type="text" placeholder="Item 7" class="inventory-item"><input type="number" min="0" value="0" class="inventory-weight"></div>
                            <div class="inventory-slot"><input type="text" placeholder="Item 8" class="inventory-item"><input type="number" min="0" value="0" class="inventory-weight"></div>
                            <div class="inventory-slot"><input type="text" placeholder="Item 9" class="inventory-item"><input type="number" min="0" value="0" class="inventory-weight"></div>
                            <div class="inventory-slot"><input type="text" placeholder="Item 10" class="inventory-item"><input type="number" min="0" value="0" class="inventory-weight"></div>
                        </div>
                    </div>
                    <div style="width:50%">
                        <label>Magias e Habilidades:</label>
                        <div id="magias-list" class="magias-container">
                             </div>
                        <button id="adicionar-magia-btn">Adicionar Magia</button>
                    </div>
                </div>
                <div class="mt-4">
                    <label>Vantagens:</label>
                    <div id="vantagens-list-display" class="list-display"></div>
                    <label>Desvantagens:</label>
                    <div id="desvantagens-list-display" class="list-display"></div>
                </div>
                <div class="classe-raca-container">
                    <label>Classe:</label>
                    <input type="text" id="classe-nome" placeholder="Nome da Classe">
                    <textarea id="classe-descricao" placeholder="Descrição da Classe" class="expandable-textarea"></textarea>
                    <label>Raça:</label>
                    <span id="raca-nome" onclick="abrirModalRaca()"></span>
                    <textarea id="raca-descricao" placeholder="Descrição da Raça" class="expandable-textarea" readonly></textarea>
                </div>
            </section>
            <section id="locomocao">
                <h2>Locomoção</h2>
                <div class="locomotion-container">
                    <div class="locomotion-item">
                        <label>Velocidade de Corrida (km/h):</label><span>🏃‍♂️</span><span id="velocidade-corrida" readonly>25</span>
                    </div>
                    <div class="locomotion-item">
                        <label>Altura do Pulo (m):</label><span>⬆️</span><span id="altura-pulo" readonly>1</span>
                    </div>
                    <div class="locomotion-item">
                        <label>Distância do Pulo (m):</label><span>➡️</span><span id="distancia-pulo" readonly>3</span>
                    </div>
                </div>
            </section>
            <section id="status">
                <h2>Status</h2>
                <div class="flex gap-20">
                    <div>
                        <label>Experiência:</label>
                        <input type="number" id="experiencia" value="0" min="0">
                        <label>Pontos de Habilidade (PD):</label>
                        <span id="pontos-habilidade" readonly>25</span>
                        <label>Pontos de Vantagem (PH):</label>
                        <span id="pontos-vantagem" readonly>8</span>
                    </div>
                    <div></div> </div>
                <div id="nivel-container">
                    <label>Nível:</label>
                    <span id="nivel">0</span>
                </div>
            </section>

            <div style="display:flex;justify-content:center;gap:20px;margin-bottom:20px">
                <button id="vantagens-desvantagens-btn">Vantagens e Desvantagens</button>
                <button id="racas-btn">Raças 🏰</button>
                <button id="classes-btn">Classes ⚔️</button>
            </div>

            <div class="botoes-container">
                <button id="reset-pontos" class="botao botao-reset">Reiniciar Pontos</button>
                <button id="recomecar" class="botao botao-recomecar">Recomeçar</button>
                <button id="bloquear-ficha" class="botao botao-bloquear">Bloquear Ficha</button>
                <button id="plano-fundo-btn" class="botao">Plano de fundo</button>
                <button id="excluir-ficha" class="botao botao-excluir">Excluir Ficha</button>
            </div>

            <div class="theme-color-container">
                <button id="lua-btn" class="botao icon-btn">🌙</button>
                <button id="sol-btn" class="botao icon-btn">☀️</button>
                <div class="theme-option">
                    <label for="background-color-input" id="cor-fundo-visual-btn" class="botao icon-btn" title="Cor de Fundo" style="cursor: pointer;">🎨</label>
                    <input type="color" id="background-color-input" style="visibility: hidden; width: 0; height: 0; padding:0; margin:0; border:none;">
                </div>
                <div class="theme-option">
                    <select id="font-selector" class="botao" title="Fonte Principal" style="padding: 10px 15px; height: 44px; background-color: #800000; color:white; border:none; border-radius:6px; font-family:'MedievalSharp', serif;">
                        <option value="'Inter', sans-serif">Padrão (Inter)</option>
                        <option value="'MedievalSharp', cursive">Medieval</option>
                        <option value="'Times New Roman', Times, serif">Times New Roman</option>
                        <option value="'Arial', Helvetica, sans-serif">Arial</option>
                        <option value="'Courier New', Courier, monospace">Courier New</option>
                        <option value="'Georgia', serif">Georgia</option>
                        <option value="'Verdana', Geneva, sans-serif">Verdana</option>
                    </select>
                </div>
            </div>
        </div> </div> <button id="anotacoes-btn">Anotações</button>
    <textarea id="anotacoes-textarea" placeholder="Suas anotações aqui..."></textarea>

    <div id="vantagens-desvantagens-panel">
        <h2>Vantagens e Desvantagens</h2>
        <div>Pontos de Vantagem Temporários: <span id="ph-temp">0</span></div>
        <div id="vantagens-list"></div>
        <div id="desvantagens-list"></div>
        <button id="salvar-vantagens-btn">SALVAR</button>
        <button id="fechar-pagina-btn">Fechar Página</button>
    </div>
    <div id="racas-panel">
        <h2>Raças</h2>
        <div id="ph-temp-raca-container" style="text-align: center; margin-bottom: 10px;">Pontos de Vantagem Temporários: <span id="ph-temp-raca">0</span></div> <div id="racas-list"></div>
        <button id="salvar-racas-btn">SALVAR</button>
        <button id="fechar-racas-btn">Fechar Página</button>
    </div>
    <div id="classes-panel">
        <h2>Classes</h2>
        <button id="fechar-classes-btn">Fechar Página</button>
    </div>
    <div id="nome-ficha-modal" class="modal">
        <div class="modal-content">
            <h3>Dê um Nome à Ficha</h3>
            <input type="text" id="nome-ficha-input" placeholder="Nome da ficha" maxlength="20">
            <button class="confirm-btn" id="confirmar-criar-nova-ficha-btn">Confirmar</button> <button class="cancel-btn" onclick="fecharModal('nome-ficha-modal')">Cancelar</button>
        </div>
    </div>
    <div id="bloquear-ficha-modal" class="modal">
        <div class="modal-content">
            <h3>Ponha sua Senha de 4 Dígitos</h3>
            <input type="password" id="senha-bloqueio-input" placeholder="Senha (4 dígitos)" maxlength="4">
            <button class="confirm-btn" id="confirmar-bloquear-ficha-btn">Confirmar</button> <button class="cancel-btn" onclick="fecharModal('bloquear-ficha-modal')">Cancelar</button>
        </div>
    </div>
    <div id="password-modal" class="modal">
        <div class="modal-content">
            <h3>Digite sua Senha</h3>
            <input type="password" id="senha-desbloqueio-input" placeholder="Senha (4 dígitos)" maxlength="4">
            <button class="confirm-btn" id="confirmar-desbloquear-ficha-btn">Confirmar</button> <button class="cancel-btn" onclick="cancelarDesbloqueio()">Cancelar</button>
        </div>
    </div>
    <div id="confirmar-compra-modal" class="modal">
        <div class="modal-content">
            <h3>Tem certeza que quer comprar isso?</h3>
            <button class="confirm-btn" id="confirmar-compra-btn">Sim</button>
            <button class="cancel-btn" onclick="fecharModal('confirmar-compra-modal')">Não</button>
        </div>
    </div>
    <div id="salvar-vantagens-modal" class="modal"> <div class="modal-content">
            <h3 id="salvar-modal-texto">Se salvar, as alterações não poderão ser desfeitas.</h3>
            <button class="confirm-btn" id="confirmar-salvar-btn">OK</button> <button class="cancel-btn" onclick="fecharModal('salvar-vantagens-modal')">Cancelar</button>
        </div>
    </div>
    <div id="senha-gm-modal" class="modal">
        <div class="modal-content">
            <h3 id="senha-gm-titulo">Peça permissão ao GM</h3>
            <input type="password" id="senha-gm-input" placeholder="Senha GM">
            <button class="confirm-btn" id="confirmar-senha-gm-btn">Confirmar</button>
            <button class="cancel-btn" onclick="fecharModal('senha-gm-modal')">Cancelar</button>
        </div>
    </div>
    <div id="raca-opcoes-modal" class="modal">
        <div class="modal-content">
            <h3>O que você deseja fazer?</h3>
            <button class="confirm-btn" onclick="excluirRacaSelecionadaModal()">Excluir Raça</button>
            <button class="confirm-btn" onclick="editarRacaSelecionadaModal()" style="margin-top: 10px;">Editar Raça</button>
            <button class="cancel-btn" onclick="fecharModal('raca-opcoes-modal')">Cancelar</button>
        </div>
    </div>
    <div id="editar-raca-modal" class="modal">
        <div class="modal-content">
            <h3>Editar Raça</h3>
            <label for="editar-raca-nome">Nome:</label>
            <input type="text" id="editar-raca-nome">
            <label for="editar-raca-descricao">Descrição:</label>
            <textarea id="editar-raca-descricao"></textarea>
            <button class="confirm-btn" onclick="salvarEdicaoRaca()">Salvar</button>
            <button class="cancel-btn" onclick="fecharModal('editar-raca-modal')">Cancelar</button>
        </div>
    </div>
    <div id="notification"></div>
    <div id="background-modal" class="modal">
        <div class="modal-content">
            <h3>Plano de Fundo</h3>
            <label for="background-image-input">Selecionar Imagem:</label>
            <input type="file" id="background-image-input" accept="image/*">
            <div class="radio-group">
                <label><input type="radio" name="background-size" value="cover" checked>Preencher Tela</label>
                <label><input type="radio" name="background-size" value="100% 100%">Estender</label>
                <label><input type="radio" name="background-size" value="auto">Tamanho Normal</label>
            </div>
            <button class="confirm-btn" onclick="aplicarPlanoDeFundo()">Aplicar</button>
            <button class="cancel-btn" onclick="fecharModal('background-modal')">Cancelar</button>
            <button class="cancel-btn" onclick="excluirPlanoDeFundo()">Excluir Imagem</button>
        </div>
    </div>

    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, getDocs, writeBatch, runTransaction, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-firestore.js";

        // Firebase Configuration (will be provided by the environment)
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'; // Default for local testing

        // Firebase App and Services
        let fbApp;
        let auth;
        let db;
        let userId;

        // Firestore Paths
        let fichasCollectionPath;
        let appStateDocPath; // For storing currentFichaId and other app-level states

        // Global App State
        const FICHA_MATRIZ_ID = "ficha-matriz";
        let fichas = {}; // Local cache of all character sheets for the user
        let currentFichaId = null;
        let isFichaLocked = false;
        let fichaPassword = null;
        let isFichaUnlocked = false; // Temporary unlock state
        let senhaMatriz = "1040"; // GM Password

        let vantagensSelecionadas = [];
        let desvantagensSelecionadas = [];
        let tempVantagensSelecionadas = [];
        let tempDesvantagensSelecionadas = [];
        let racaSelecionada = null;
        let tempRacaSelecionada = null;

        let vidaTotal, vidaAtual, magiaTotal, magiaAtual, vigorTotal, vigorAtual;
        let previousValues = new Map(); // For reverting input values if needed

        // Unsubscribe functions for Firestore listeners
        let fichasCollectionUnsubscribe = null;
        let currentFichaDocUnsubscribe = null;
        let appStateUnsubscribe = null;


        // --- Data Definitions (Vantagens, Desvantagens, Raças, Nível) ---
        const vantagensData = [
            { nome: "Maestria com Armas curtas (2)", custo: 2, descricao: "+1 em ataque, +1 em acerto com armas curtas." }, { nome: "Maestria com armas pesadas (2)", custo: 2, descricao: "+2 em ataque com armas pesadas." }, { nome: "Maestria com armas de longo alcance (2)", custo: 2, descricao: "+2 em acerto com armas de longo alcance." }, { nome: "Furtar (2)", custo: 2, descricao: "+4 em testes de furto." }, { nome: "Lábia (2)", custo: 2, descricao: "+5 em testes de lábia." }, { nome: "Velejar (1)", custo: 1, descricao: "" }, { nome: "Beleza (1)", custo: 1, descricao: "+3 o teste em lábia, paquera e persuasão." }, { nome: "Boa Fama (2)", custo: 2, descricao: "+4 chance de descontos em armamentos, pousadas, alimentos, etc." }, { nome: "Arremedo (2)", custo: 2, descricao: "Capacidade de imitar qualquer som SIMPLES." }, { nome: "Destemor (1)", custo: 1, descricao: "Dificilmente é assustado por algo." }, { nome: "Empatia (3)", custo: 3, descricao: "Sensibilidade extraordinária em relação aos outras pessoas. Excelente para identificar impostores, possessões por espirito, etc." }, { nome: "Empatia com animais (1)", custo: 1, descricao: "Pode compreender as motivações dos animais." }, { nome: "Patrono (4)", custo: 4, descricao: "Possui um mentor/mestre/professor, até mesmo uma organização/guilda que pode lhe oferecer ajuda." }, { nome: "Reconhecimento Social (2)", custo: 2, descricao: "Membro de um grupo respeitado/temido/venerado. +2 teste em lábia, paquera e persuasão." }, { nome: "Riqueza (2)", custo: 2, descricao: "Inicia com 20 moedas de ouro." }, { nome: "Aptidão para magia (4)", custo: 4, descricao: "+15% dano e -15% custo de magia para a magia que tem aptidão." }, { nome: "Combo Físico (4)", custo: 4, descricao: "Inicia com 50km velocidade corrida, pulo de 3m altura e 9m distância.", restricao: "inicio" }, { nome: "Nadar (1)", custo: 1, descricao: "" }, { nome: "Escalar (2)", custo: 2, descricao: "" }, { nome: "Segunda língua (1)", custo: 1, descricao: "Fala mais um idioma." }, { nome: "Paquerador (2)", custo: 2, descricao: "+4 em teste para paquera e persuasão envolvendo flerte." }, { nome: "Senso de perigo (5)", custo: 5, descricao: "Quando algo grave ocorrer o mestre pedirá pra você jogar um dado para reagir." }, { nome: "Acrobata (3)", custo: 3, descricao: "+ fama ao lutar em público." }, { nome: "Equilíbrio Perfeito (3)", custo: 3, descricao: "+8 em testes de equilíbrio." }, { nome: "Tecnologia (2)", custo: 2, descricao: "Engenhoso, pode inventar coisas, criar objetos improvisados." }, { nome: "Poder Oculto (7)", custo: 7, descricao: "Com 10% vida, ativa +50% em todos atributos. Volta ao normal acima de 10% vida." }, { nome: "Sobrevivência em floresta (2)", custo: 2, descricao: "Facilidade para achar cavernas, criar assentamentos, achar comida, gravar caminhos, achar água, etc." }
        ];
        const desvantagensData = [
            { nome: "Fobia (+2)", ganho: 2, descricao: "Medo irracional de algo específico." }, { nome: "Má Fama (+2)", ganho: 2, descricao: "Mal visto pela sociedade, dificultando interações sociais." }, { nome: "Alcoolismo (+2)", ganho: 2, descricao: "Dependência de álcool que afeta suas decisões." }, { nome: "Altruísmo (+2)", ganho: 2, descricao: "Se sacrifica por outras pessoas, pouco se importa com fama ou riqueza." }, { nome: "Avareza (+2)", ganho: 2, descricao: "Preocupação permanente na conservação de riquezas." }, { nome: "Bullying (+3)", ganho: 3, descricao: "Gosta de caçoar, agredir, denegrir, difamar e apontar defeitos." }, { nome: "Circunspeção (+2)", ganho: 2, descricao: "Não entende piadas, entende tudo literal e acredita que todos estão sérios." }, { nome: "Compulsões (+3)", ganho: 3, descricao: "Hábito ou vício que toma boa parte dos seus recursos e tempo." }, { nome: "Covardia (+2)", ganho: 2, descricao: "Extremo cuidado com bem-estar físico e dificuldade em assumir riscos." }, { nome: "Dependentes (+4)", ganho: 4, descricao: "Alguém depende de você a todo momento (filhos, parentes, etc.)." }, { nome: "Fúria (+2)", ganho: 2, descricao: "Tendência a perder o controle e atacar freneticamente (ativado por dano, insulto ou aleatório)." }, { nome: "Honestidade (+3)", ganho: 3, descricao: "Não consegue mentir ou omitir, sempre fala a verdade e desmascara mentiras." }, { nome: "Impulsividade (+2)", ganho: 2, descricao: "Sempre age sem pensar." }, { nome: "Luxúria (+2)", ganho: 2, descricao: "Desejo incontrolável por romance." }, { nome: "Magnetismo Sobrenatural (+2)", ganho: 2, descricao: "Coisas estranhas acontecem com seu personagem em nível alarmante." }, { nome: "No Limite (+4)", ganho: 4, descricao: "Assume riscos extremamente irracionais diante de perigo mortal." }, { nome: "Teimosia (+1)", ganho: 1, descricao: "Quer sempre fazer as coisas do seu modo, não segue planos que não sejam seus." }, { nome: "Amnésia (+2)", ganho: 2, descricao: "Em certos momentos, não consegue lembrar de coisas importantes." }
        ];
        let racasData = [
            { nome: "Humano (3)", custo: 3, descricao: "Versáteis, ambiciosos, mestres em adaptação.", vantagens: ["Explorador Nato: Cavalo superior, equipamentos, mapa detalhado.", "Mestre das Profissões: Escolha (Ferreiro Lendário, Costureiro Arcano, Arquiteto Visionário) com benefícios únicos.", "Rede de Influência: Aliado influente (guildas, mercadores, líderes) com acesso a informações ou ajuda.", "Determinação Inabalável: Uma vez/dia, ignore uma desvantagem (exaustão, ferimento, magia) por um curto período."] }, { nome: "Elfo (4)", custo: 4, descricao: "Sábios, mágicos, conectados à natureza.", vantagens: ["Sabedoria Ancestral: Domina área (arcana, história, natureza), decifra itens antigos, aprende 1 língua extra.", "Visão Élfica Suprema: Enxerga 10m escuro, detecta magias fracas 20m, percebe intenções hostis (teste 19+).", "Escudo Mágico: Resistência inata a um tipo de efeito mágico hostil (dano ou duração -50%)."] }, { nome: "Anão (4)", custo: 4, descricao: "Resilientes, habilidosos, ligados à terra.", vantagens: ["Fortitude Indomável: Trabalha 3 dias sem descanso, recupera vida/energia 2x mais rápido em rocha/subterrâneo.", "Artesão: Escolha (Mestre Minerador, Forjador de Lendas, Joalheiro Divino) com impacto massivo.", "Senhor das Profundezas: Nunca se perde subterrâneo, detecta armadilhas, sente vibrações (prever emboscada/colapso)."] }, { nome: "Orc (3)", custo: 3, descricao: "Guerreiros ferozes, líderes pela força.", vantagens: ["Lenda entre Guerreiros: Inspira temor/respeito, alianças marciais, acesso missões épicas; inimigos menores fogem (teste 16+).", "Resiliência Brutal: Luta sem penalidades com ferimentos graves, só cai com PV 0, regenera ferimentos leves fora de combate.", "Domínio da Intimidação: Força inimigos a render/recuar com grito (1x/encontro, afeta grupos), bônus massivo negociações (força/medo).", "Fúria Ancestral: Fúria 2x/dia (dobra força/resistência por curto período)."] }, { nome: "Meio Animal (Selvagem) (4)", custo: 4, descricao: "Instinto primal com astúcia.", vantagens: ["Sentidos Predatórios: Escolha (visão, olfato, audição) aguçado; rastreia km, detecta invisíveis, evita surpresa (teste 12+).", "Senhor dos Terrenos: Adapta-se a 1 ambiente (floresta, deserto, pântano), ignora efeitos negativos, bônus movimento/furtividade (+1).", "Frenesi Instintivo: 1x/dia, velocidade sobrenatural (2x movimento), ataques adicionais, percepção pré-monitória (10 min)."] }
        ];
        const nivelData = [
            { nivel: 0, xp: 0, pd: 25, ph: 8 }, { nivel: 1, xp: 10, pd: 31, ph: 9 }, { nivel: 2, xp: 30, pd: 37, ph: 10 }, { nivel: 3, xp: 60, pd: 43, ph: 11 }, { nivel: 4, xp: 100, pd: 49, ph: 12 }, { nivel: 5, xp: 150, pd: 55, ph: 13 }, { nivel: 6, xp: 210, pd: 61, ph: 14 }, { nivel: 7, xp: 280, pd: 67, ph: 15 }, { nivel: 8, xp: 360, pd: 73, ph: 16 }, { nivel: 9, xp: 450, pd: 79, ph: 17 }, { nivel: 10, xp: 550, pd: 85, ph: 18 }, { nivel: 11, xp: 670, pd: 91, ph: 19 }, { nivel: 12, xp: 810, pd: 97, ph: 20 }, { nivel: 13, xp: 970, pd: 103, ph: 21 }, { nivel: 14, xp: 1150, pd: 109, ph: 22 }, { nivel: 15, xp: 1350, pd: 115, ph: 23 }, { nivel: 16, xp: 1570, pd: 121, ph: 24 }, { nivel: 17, xp: 1810, pd: 127, ph: 25 }, { nivel: 18, xp: 2070, pd: 133, ph: 26 }, { nivel: 19, xp: 2350, pd: 139, ph: 27 }, { nivel: 20, xp: 2650, pd: 145, ph: 28 }, { nivel: 21, xp: 2980, pd: 148, ph: 29 }, { nivel: 22, xp: 3340, pd: 151, ph: 30 }, { nivel: 23, xp: 3730, pd: 154, ph: 31 }, { nivel: 24, xp: 4150, pd: 157, ph: 32 }, { nivel: 25, xp: 4600, pd: 160, ph: 33 }, { nivel: 26, xp: 5080, pd: 163, ph: 34 }, { nivel: 27, xp: 5590, pd: 166, ph: 35 }, { nivel: 28, xp: 6130, pd: 169, ph: 36 }, { nivel: 29, xp: 8000, pd: 219, ph: 37 }, { nivel: 30, xp: 10000, pd: 319, ph: 38 }
        ];

        // --- Cache DOM Elements ---
        const nomePersonagemInput = document.getElementById("nome-personagem"), descricaoPersonagemInput = document.getElementById("descricao-personagem"),
            forcaInput = document.getElementById("forca"), destrezaInput = document.getElementById("destreza"), agilidadeInput = document.getElementById("agilidade"),
            inteligenciaInput = document.getElementById("inteligencia"), constituicaoInput = document.getElementById("constituicao"),
            ataqueSpan = document.getElementById("ataque"), ataqueMagicoSpan = document.getElementById("ataque-magico"), acertoSpan = document.getElementById("acerto"),
            esquivaSpan = document.getElementById("esquiva"), rdfSpan = document.getElementById("rdf"), rdmSpan = document.getElementById("rdm"),
            armaDireitaNomeInput = document.getElementById("arma-direita-nome"), armaDireitaAtaqueInput = document.getElementById("arma-direita-ataque"),
            armaDireitaAtaqueMagicoInput = document.getElementById("arma-direita-ataque-magico"), armaEsquerdaNomeInput = document.getElementById("arma-esquerda-nome"),
            armaEsquerdaAtaqueInput = document.getElementById("arma-esquerda-ataque"), armaEsquerdaAtaqueMagicoInput = document.getElementById("arma-esquerda-ataque-magico"),
            resetPontosButton = document.getElementById("reset-pontos"), recomecarButton = document.getElementById("recomecar"),
            bloquearFichaButton = document.getElementById("bloquear-ficha"), experienciaInput = document.getElementById("experiencia"),
            nivelSpan = document.getElementById("nivel"), pontosHabilidadeSpan = document.getElementById("pontos-habilidade"),
            pontosVantagemSpan = document.getElementById("pontos-vantagem"), velocidadeCorridaSpan = document.getElementById("velocidade-corrida"),
            alturaPuloSpan = document.getElementById("altura-pulo"), distanciaPuloSpan = document.getElementById("distancia-pulo"),
            nomePersonagemTitulo = document.getElementById("nome-personagem-titulo"), gameMasterMessage = document.getElementById("game-master-message"),
            vantagensListDisplay = document.getElementById("vantagens-list-display"), desvantagensListDisplay = document.getElementById("desvantagens-list-display"),
            inventarioSlots = document.getElementById("inventario-slots"), pesoTotalSpan = document.getElementById("peso-total"),
            capacidadeCargaSpan = document.getElementById("capacidade-carga"),
            diceContainer = document.getElementById("dice-container"), diceRoll = document.getElementById("dice-roll"), diceResult = document.getElementById("dice-result"),
            notification = document.getElementById("notification"), characterImageInput = document.getElementById("character-image-input"),
            characterImage = document.getElementById("character-image"), vantagensDesvantagensBtn = document.getElementById("vantagens-desvantagens-btn"),
            vantagensDesvantagensPanel = document.getElementById("vantagens-desvantagens-panel"), vantagensList = document.getElementById("vantagens-list"),
            desvantagensList = document.getElementById("desvantagens-list"), salvarVantagensBtn = document.getElementById("salvar-vantagens-btn"),
            fecharPaginaBtn = document.getElementById("fechar-pagina-btn"), fichaContainer = document.getElementById("ficha-container"),
            magiasList = document.getElementById("magias-list"), adicionarMagiaBtn = document.getElementById("adicionar-magia-btn"),
            anotacoesBtn = document.getElementById("anotacoes-btn"), anotacoesTextarea = document.getElementById("anotacoes-textarea"),
            racasBtn = document.getElementById("racas-btn"), classesBtn = document.getElementById("classes-btn"), racasPanel = document.getElementById("racas-panel"),
            classesPanel = document.getElementById("classes-panel"), fecharRacasBtn = document.getElementById("fechar-racas-btn"),
            fecharClassesBtn = document.getElementById("fechar-classes-btn"), classeNomeInput = document.getElementById("classe-nome"),
            classeDescricaoInput = document.getElementById("classe-descricao"), racaNomeSpan = document.getElementById("raca-nome"),
            racaDescricaoInput = document.getElementById("raca-descricao"), luaBtn = document.getElementById("lua-btn"), solBtn = document.getElementById("sol-btn"),
            salvarRacasBtn = document.getElementById("salvar-racas-btn"), racasList = document.getElementById("racas-list"),
            atributosInputs = [forcaInput, destrezaInput, agilidadeInput, inteligenciaInput, constituicaoInput],
            planoFundoBtn = document.getElementById("plano-fundo-btn"),
            backgroundImageInput = document.getElementById("background-image-input"), backgroundModal = document.getElementById("background-modal"),
            backgroundColorInput = document.getElementById('background-color-input'),
            backgroundColorButtonVisual = document.getElementById('cor-fundo-visual-btn'),
            fontSelector = document.getElementById('font-selector'),
            confirmarSalvarBtn = document.getElementById("confirmar-salvar-btn"),
            phTempRacaSpan = document.getElementById("ph-temp-raca"),
            senhaGmTitulo = document.getElementById("senha-gm-titulo");

        let nivel = 0, nivelAnterior = 0, pontosHabilidadeTotal = 25, pontosHabilidadeUsados = 0, experiencia = 0, vidaBase = 50;
        let currentActionIntervalId = null;
        const REPEAT_DELAY_MS = 75;
        let xpUnlockTimerId = null;
        let isXpUnlocked = false;
        const XP_UNLOCK_DURATION_MS = 20000;

        // --- Helper Functions ---
        function showUINotification(message, type) { // Renamed to avoid conflict
            notification.textContent = message; notification.className = type; notification.style.display = "block";
            setTimeout(() => { notification.style.display = "none"; notification.className = ""; }, 2000);
        }

        function fecharModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) modal.style.display = "none";
        }

        // --- Firebase Initialization and Auth ---
        async function initializeFirebaseApp() {
            if (!firebaseConfig) {
                console.error("Firebase configuration is missing. App cannot initialize.");
                showUINotification("Erro: Configuração do Firebase ausente.", "critical-failure");
                // Disable UI elements that require Firebase
                document.getElementById('add-ficha-btn').disabled = true;
                // Potentially hide the entire ficha-container or show a message
                return;
            }

            try {
                fbApp = initializeApp(firebaseConfig);
                auth = getAuth(fbApp);
                db = getFirestore(fbApp);
                setLogLevel('debug'); // For Firebase Firestore detailed logs
                console.log("Firebase initialized successfully.");

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        console.log("User is signed in:", user.uid);
                        userId = user.uid;
                        fichasCollectionPath = `artifacts/${appId}/users/${userId}/fichas`;
                        appStateDocPath = `artifacts/${appId}/users/${userId}/appState/rpgSheetData`; // Unique doc for this app's state
                        await loadInitialData();
                    } else {
                        console.log("User is signed out. Attempting to sign in...");
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            try {
                                await signInWithCustomToken(auth, __initial_auth_token);
                                console.log("Signed in with custom token.");
                            } catch (error) {
                                console.error("Error signing in with custom token, trying anonymous:", error);
                                await signInAnonymously(auth);
                                console.log("Signed in anonymously after custom token failure.");
                            }
                        } else {
                            await signInAnonymously(auth);
                            console.log("Signed in anonymously.");
                        }
                        // onAuthStateChanged will be triggered again after sign-in
                    }
                });
            } catch (error) {
                console.error("Error initializing Firebase:", error);
                showUINotification("Erro ao inicializar Firebase: " + error.message, "critical-failure");
            }
        }


        // --- Data Loading and Initial Setup ---
        async function loadInitialData() {
            if (!userId) {
                console.error("User ID not available. Cannot load data.");
                return;
            }
            console.log("Loading initial data for user:", userId);
            showUINotification("Carregando dados...", "normal-result");

            await ensureFichaMatrizExists();
            listenToAppStateChanges(); // This will load currentFichaId and then trigger ficha loading
            listenToFichasCollectionChanges(); // This keeps the 'fichas' object and tabs updated
        }

        async function ensureFichaMatrizExists() {
            const fichaMatrizRef = doc(db, fichasCollectionPath, FICHA_MATRIZ_ID);
            try {
                const docSnap = await getDoc(fichaMatrizRef);
                if (!docSnap.exists()) {
                    console.log("Ficha Matriz not found, creating...");
                    const fichaMatrizData = getDefaultFichaData("Matriz", FICHA_MATRIZ_ID);
                    fichaMatrizData.isLocked = true;
                    fichaMatrizData.password = senhaMatriz;
                    await setDoc(fichaMatrizRef, fichaMatrizData);
                    console.log("Ficha Matriz created.");
                } else {
                    console.log("Ficha Matriz exists.");
                }
            } catch (error) {
                console.error("Error ensuring Ficha Matriz exists:", error);
                showUINotification("Erro ao verificar Ficha Matriz: " + error.message, "critical-failure");
            }
        }

        function getDefaultFichaData(nomeFicha, fichaId) {
            return {
                id: fichaId, // Store ID within the document for convenience
                nomeFicha: nomeFicha || "Nova Ficha",
                nomePersonagem: "",
                descricaoPersonagem: "",
                forca: "0", destreza: "0", agilidade: "0", inteligencia: "0", constituicao: "0",
                experiencia: "0",
                armaDireitaNome: "", armaDireitaAtaque: "0", armaDireitaAtaqueMagico: "0",
                armaEsquerdaNome: "", armaEsquerdaAtaque: "0", armaEsquerdaAtaqueMagico: "0",
                vantagens: [], // Store as array
                magiasHabilidades: Array(10).fill(""), // Store as array
                desvantagens: [], // Store as array
                inventario: Array(10).fill({ item: "", peso: "0" }),
                velocidadeCorrida: "25", alturaPulo: "1", distanciaPulo: "3",
                isLocked: false, password: null,
                imagem: null, anotacoes: "",
                classeNome: "", classeDescricao: "",
                racaNome: "", racaDescricao: "", racaSelecionada: "",
                backgroundImage: null, backgroundSize: 'cover', backgroundColor: '#f0e6d2',
                fontFamily: "'Inter', sans-serif",
                darkMode: false,
                vidaAtual: 50, magiaAtual: 20, vigorAtual: 10,
                lastUpdated: serverTimestamp() // For tracking updates
            };
        }


        // --- Firestore Listeners ---
        function listenToAppStateChanges() {
            if (appStateUnsubscribe) appStateUnsubscribe(); // Unsubscribe from previous listener

            const appStateRef = doc(db, appStateDocPath);
            appStateUnsubscribe = onSnapshot(appStateRef, async (docSnap) => {
                let newCurrentFichaId = FICHA_MATRIZ_ID; // Default
                if (docSnap.exists() && docSnap.data().currentFichaId) {
                    newCurrentFichaId = docSnap.data().currentFichaId;
                    console.log("App state loaded, currentFichaId:", newCurrentFichaId);
                } else {
                    console.log("App state not found or no currentFichaId, defaulting to Matriz and saving state.");
                    await setDoc(appStateRef, { currentFichaId: FICHA_MATRIZ_ID }, { merge: true });
                }

                if (currentFichaId !== newCurrentFichaId) {
                    currentFichaId = newCurrentFichaId;
                    console.log("Current ficha ID set to:", currentFichaId);
                    setupCurrentFichaDocumentListener(currentFichaId);
                    // displayFichaData will be called by the document listener
                }
                 // Ensure tabs are updated if currentFichaId changes
                atualizarAbasFichas();
            }, (error) => {
                console.error("Error listening to app state:", error);
                showUINotification("Erro ao carregar estado da aplicação: " + error.message, "critical-failure");
            });
        }

        function listenToFichasCollectionChanges() {
            if (fichasCollectionUnsubscribe) fichasCollectionUnsubscribe();

            const q = query(collection(db, fichasCollectionPath));
            fichasCollectionUnsubscribe = onSnapshot(q, (querySnapshot) => {
                const newFichas = {};
                querySnapshot.forEach((doc) => {
                    newFichas[doc.id] = { id: doc.id, ...doc.data() };
                });
                fichas = newFichas; // Update local cache
                console.log("Fichas collection updated, total fichas:", Object.keys(fichas).length);
                atualizarAbasFichas();

                // If the currently displayed ficha's data changed in the collection snapshot,
                // and its specific document listener hasn't updated it yet, this ensures consistency.
                // However, the document listener is preferred for updating the current ficha.
                if (currentFichaId && fichas[currentFichaId] && document.getElementById('ficha-container').style.display !== 'none') {
                    // displayFichaData(fichas[currentFichaId]); // Potentially redundant if doc listener is active
                }
            }, (error) => {
                console.error("Error listening to fichas collection:", error);
                showUINotification("Erro ao carregar lista de fichas: " + error.message, "critical-failure");
            });
        }

        function setupCurrentFichaDocumentListener(fichaId) {
            if (currentFichaDocUnsubscribe) currentFichaDocUnsubscribe(); // Unsubscribe from old listener

            if (!fichaId) {
                console.log("No fichaId to listen to. Clearing display.");
                // clearFichaDisplay(); // Implement a function to clear the form
                return;
            }

            console.log("Setting up listener for ficha document:", fichaId);
            const fichaDocRef = doc(db, fichasCollectionPath, fichaId);
            currentFichaDocUnsubscribe = onSnapshot(fichaDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    console.log("Current ficha document data updated:", docSnap.id);
                    const fichaData = { id: docSnap.id, ...docSnap.data() };
                    // Only update if this is the truly current ficha, to avoid race conditions if user clicks tabs fast
                    if (fichaData.id === currentFichaId) {
                         displayFichaData(fichaData);
                    }
                } else {
                    console.warn("Current ficha document does not exist in Firestore:", fichaId);
                    // Potentially switch to Matriz or handle error
                    if (fichaId !== FICHA_MATRIZ_ID) { // Avoid loop if Matriz itself is missing
                        showUINotification(`Ficha ${fichaId} não encontrada. Retornando para Matriz.`, "critical-failure");
                        setCurrentFicha(FICHA_MATRIZ_ID);
                    }
                }
            }, (error) => {
                console.error(`Error listening to ficha document (${fichaId}):`, error);
                showUINotification("Erro ao carregar dados da ficha: " + error.message, "critical-failure");
            });
        }


        // --- UI Update Functions ---
        function atualizarAbasFichas() {
            const sidebar = document.getElementById("fichas-sidebar");
            const addBtn = document.getElementById("add-ficha-btn");
            
            // Remove existing tabs except the add button
            Array.from(sidebar.children).forEach(child => {
                if (child !== addBtn) {
                    sidebar.removeChild(child);
                }
            });

            // Sort fichas: Matriz first, then others by name or timestamp
            const sortedFichaIds = Object.keys(fichas).sort((a, b) => {
                if (a === FICHA_MATRIZ_ID) return -1;
                if (b === FICHA_MATRIZ_ID) return 1;
                return (fichas[a].nomeFicha || "").localeCompare(fichas[b].nomeFicha || "");
            });

            sortedFichaIds.forEach(fichaId => {
                const ficha = fichas[fichaId];
                if (!ficha) return;

                const tab = document.createElement("div");
                tab.className = "ficha-tab";
                const span = document.createElement("span");
                span.textContent = ficha.nomeFicha || "Sem Nome";
                tab.appendChild(span);
                tab.dataset.fichaId = fichaId;

                if (fichaId === currentFichaId) {
                    tab.classList.add("active");
                }

                tab.onclick = () => {
                    if (fichaId !== currentFichaId) {
                         setCurrentFicha(fichaId);
                    }
                };
                sidebar.insertBefore(tab, addBtn); // Insert before the add button
            });
        }
        
        async function setCurrentFicha(fichaId) {
            if (!db || !userId) return; // Ensure Firebase is ready
            currentFichaId = fichaId;
            await setDoc(doc(db, appStateDocPath), { currentFichaId: fichaId }, { merge: true });
            // The appState listener will pick this up and call setupCurrentFichaDocumentListener
            // and also update tabs via its own call to atualizarAbasFichas.
            // For immediate UI responsiveness for tab selection:
            if (fichas[fichaId]) {
                displayFichaData(fichas[fichaId]); // Display cached data immediately
            }
            atualizarAbasFichas(); // Highlight the correct tab immediately
            setupCurrentFichaDocumentListener(fichaId); // Ensure the listener is set for the new ficha
        }


        // --- Main Ficha Display Logic ---
        function displayFichaData(ficha) {
            if (!ficha) {
                console.warn("displayFichaData called with null/undefined ficha.");
                // clearFichaDisplay(); // Optionally clear the form or show a "no ficha selected" message
                return;
            }
            console.log("Displaying data for ficha:", ficha.id, ficha.nomeFicha);

            // Prevent feedback loop if onSnapshot is triggered by programmatic changes that also fire input events
            const currentlyFocusedElement = document.activeElement;
            const focusedElementId = currentlyFocusedElement ? currentlyFocusedElement.id : null;
            const focusedElementValue = currentlyFocusedElement && typeof currentlyFocusedElement.value !== 'undefined' ? currentlyFocusedElement.value : null;


            nomePersonagemInput.value = ficha.nomePersonagem || "";
            descricaoPersonagemInput.value = ficha.descricaoPersonagem || "";
            forcaInput.value = ficha.forca || "0";
            destrezaInput.value = ficha.destreza || "0";
            agilidadeInput.value = ficha.agilidade || "0";
            inteligenciaInput.value = ficha.inteligencia || "0";
            constituicaoInput.value = ficha.constituicao || "0";
            experienciaInput.value = ficha.experiencia || "0";
            armaDireitaNomeInput.value = ficha.armaDireitaNome || "";
            armaDireitaAtaqueInput.value = ficha.armaDireitaAtaque || "0";
            armaDireitaAtaqueMagicoInput.value = ficha.armaDireitaAtaqueMagico || "0";
            armaEsquerdaNomeInput.value = ficha.armaEsquerdaNome || "";
            armaEsquerdaAtaqueInput.value = ficha.armaEsquerdaAtaque || "0";
            armaEsquerdaAtaqueMagicoInput.value = ficha.armaEsquerdaAtaqueMagico || "0";
            velocidadeCorridaSpan.textContent = ficha.velocidadeCorrida || "25";
            alturaPuloSpan.textContent = ficha.alturaPulo || "1";
            distanciaPuloSpan.textContent = ficha.distanciaPulo || "3";

            isFichaLocked = ficha.isLocked || false;
            fichaPassword = ficha.password || null;
            isFichaUnlocked = false; // Reset temporary unlock on load

            vantagensSelecionadas = Array.isArray(ficha.vantagens) ? ficha.vantagens : (ficha.vantagens ? ficha.vantagens.split("\n").filter(v => v.trim()) : []);
            desvantagensSelecionadas = Array.isArray(ficha.desvantagens) ? ficha.desvantagens : (ficha.desvantagens ? ficha.desvantagens.split("\n").filter(d => d.trim()) : []);
            racaSelecionada = ficha.racaSelecionada || "";

            racaNomeSpan.textContent = racaSelecionada ? racaSelecionada.split(" (")[0] : "Selecionar Raça";
            const racaDataObj = racasData.find(r => r.nome === racaSelecionada);
            racaDescricaoInput.value = racaDataObj ? racaDataObj.vantagens.join("\n\n") : "";


            vantagensListDisplay.innerHTML = "";
            desvantagensListDisplay.innerHTML = "";
            vantagensSelecionadas.forEach(v => { const div = document.createElement("div"); div.textContent = v; div.className = "list-item"; div.onclick = () => removerVantagem(v); vantagensListDisplay.appendChild(div); });
            desvantagensSelecionadas.forEach(d => { const div = document.createElement("div"); div.textContent = d; div.className = "list-item"; div.onclick = () => removerDesvantagem(d); desvantagensListDisplay.appendChild(div); });

            const inventario = Array.isArray(ficha.inventario) ? ficha.inventario : Array(10).fill({ item: "", peso: "0" });
            const slots = inventarioSlots.querySelectorAll(".inventory-slot");
            slots.forEach((slot, i) => {
                slot.querySelector(".inventory-item").value = inventario[i]?.item || "";
                slot.querySelector(".inventory-weight").value = inventario[i]?.peso || "0";
            });
            calcularPesoTotal(); // This will also trigger calcularAtributos for encumbrance

            const magias = Array.isArray(ficha.magiasHabilidades) ? ficha.magiasHabilidades : (ficha.magiasHabilidades ? ficha.magiasHabilidades.split("\n") : Array(10).fill(""));
            magiasList.innerHTML = ""; // Clear previous
            magias.forEach((m, i) => {
                const input = document.createElement("input");
                input.type = "text";
                input.className = "magia-nome";
                input.placeholder = `Magia/Habilidade ${i + 1}`;
                input.value = m || "";
                input.addEventListener('input', salvarDados); // Re-add listener
                magiasList.appendChild(input);
            });
            // Ensure there are at least 10 magic slots, add if fewer
            for (let i = magiasList.children.length; i < 10; i++) {
                const input = document.createElement("input");
                input.type = "text";
                input.className = "magia-nome";
                input.placeholder = `Magia/Habilidade ${i + 1}`;
                input.addEventListener('input', salvarDados);
                magiasList.appendChild(input);
            }


            anotacoesTextarea.value = ficha.anotacoes || "";
            classeNomeInput.value = ficha.classeNome || "";
            classeDescricaoInput.value = ficha.classeDescricao || "";

            if (ficha.imagem && ficha.imagem.startsWith('data:image')) {
                characterImage.src = ficha.imagem;
                characterImage.style.display = "block";
            } else {
                characterImage.src = 'https://placehold.co/100x100/f0e6d2/b8860b?text=Imagem'; // Placeholder
                characterImage.style.display = "block"; // Show placeholder
            }

            atualizarBotaoBloquear();
            atualizarVantagensDesvantagensPanel(); // Uses temp values, ensure they are reset if needed
            atualizarRacasPanel(); // Uses temp values

            experiencia = parseInt(ficha.experiencia) || 0;
            experienciaInput.readOnly = true;
            isXpUnlocked = false;
            if (xpUnlockTimerId) clearTimeout(xpUnlockTimerId);

            vidaAtual = ficha.vidaAtual !== undefined ? ficha.vidaAtual : 50;
            magiaAtual = ficha.magiaAtual !== undefined ? ficha.magiaAtual : 20;
            vigorAtual = ficha.vigorAtual !== undefined ? ficha.vigorAtual : 10;

            atualizarNivel(); // This calls calcularAtributos

            // Ensure current values don't exceed totals after calculations
            document.getElementById("vida-atual").textContent = Math.min(vidaAtual, vidaTotal || vidaAtual);
            document.getElementById("magia-atual").textContent = Math.min(magiaAtual, magiaTotal || magiaAtual);
            document.getElementById("vigor-atual").textContent = Math.min(vigorAtual, vigorTotal || vigorAtual).toFixed(1);

            pontosVantagemSpan.textContent = getPontosVantagem();

            aplicarPlanoDeFundoInicial(ficha);
            aplicarCorDeFundoInicial(ficha);
            aplicarFonteInicial(ficha);
            document.body.classList.toggle("dark-mode", ficha.darkMode === true);

            // Restore focus if the updated element was the one focused
            if (focusedElementId) {
                const elementToRestoreFocus = document.getElementById(focusedElementId);
                if (elementToRestoreFocus && typeof elementToRestoreFocus.focus === 'function' && elementToRestoreFocus.value === focusedElementValue) {
                    // Only restore if value hasn't changed due to another source (e.g. user typing fast)
                    // This check is imperfect but helps avoid stealing focus unnecessarily
                    // elementToRestoreFocus.focus();
                    // if (typeof elementToRestoreFocus.setSelectionRange === 'function') {
                    //     elementToRestoreFocus.setSelectionRange(focusedElementValue.length, focusedElementValue.length);
                    // }
                }
            }
            // Store current values as previous for next diff or revert
            document.querySelectorAll('input[type="text"],input[type="number"],textarea').forEach(input => {
                previousValues.set(input, input.value);
            });
        }


        // --- CRUD Operations ---
        document.getElementById("add-ficha-btn").onclick = () => {
            document.getElementById("nome-ficha-modal").style.display = "flex";
            document.getElementById("nome-ficha-input").value = "";
            document.getElementById("nome-ficha-input").focus();
        };

        // Make sure the button ID matches what's in the HTML for creating new ficha
        document.getElementById("confirmar-criar-nova-ficha-btn").onclick = async () => {
            const nomeFicha = document.getElementById("nome-ficha-input").value.trim();
            if (!nomeFicha) {
                showUINotification("Por favor, dê um nome à ficha!", "critical-failure");
                return;
            }
            if (!db || !userId) {
                showUINotification("Firebase não está pronto. Tente novamente.", "critical-failure");
                return;
            }

            // Create a new doc reference with an auto-generated ID
            const newFichaRef = doc(collection(db, fichasCollectionPath));
            const novaFichaId = newFichaRef.id;

            const novaFichaData = getDefaultFichaData(nomeFicha, novaFichaId);

            try {
                await setDoc(newFichaRef, novaFichaData);
                console.log("Nova ficha criada com ID:", novaFichaId);
                await setCurrentFicha(novaFichaId); // This will also save currentFichaId to appState
                fecharModal("nome-ficha-modal");
                // atualizarAbasFichas will be called by the collection listener
                showUINotification(`Ficha "${nomeFicha}" criada!`, "save-success");
            } catch (error) {
                console.error("Erro ao criar nova ficha:", error);
                showUINotification("Erro ao criar ficha: " + error.message, "critical-failure");
            }
        };


        async function salvarDados() {
            if (!currentFichaId || !fichas[currentFichaId] || (isFichaLocked && !isFichaUnlocked) || !db) {
                // console.warn("SalvarDados: Condições não atendidas.", { currentFichaId, isFichaLocked, isFichaUnlocked, db });
                return;
            }

            const inventario = Array.from(inventarioSlots.querySelectorAll(".inventory-slot")).map(slot => ({
                item: slot.querySelector(".inventory-item").value,
                peso: slot.querySelector(".inventory-weight").value
            }));
            const magias = Array.from(magiasList.querySelectorAll(".magia-nome")).map(input => input.value);

            const fichaParaSalvar = {
                id: currentFichaId, // Ensure ID is part of the data
                nomeFicha: fichas[currentFichaId]?.nomeFicha || nomePersonagemInput.value || "Sem Nome", // Preserve original name if only person name changes
                nomePersonagem: nomePersonagemInput.value,
                descricaoPersonagem: descricaoPersonagemInput.value,
                forca: forcaInput.value,
                destreza: destrezaInput.value,
                agilidade: agilidadeInput.value,
                inteligencia: inteligenciaInput.value,
                constituicao: constituicaoInput.value,
                experiencia: experienciaInput.value,
                armaDireitaNome: armaDireitaNomeInput.value,
                armaDireitaAtaque: armaDireitaAtaqueInput.value,
                armaDireitaAtaqueMagico: armaDireitaAtaqueMagicoInput.value,
                armaEsquerdaNome: armaEsquerdaNomeInput.value,
                armaEsquerdaAtaque: armaEsquerdaAtaqueInput.value,
                armaEsquerdaAtaqueMagico: armaEsquerdaAtaqueMagicoInput.value,
                vantagens: vantagensSelecionadas, // Already an array
                magiasHabilidades: magias, // Already an array
                desvantagens: desvantagensSelecionadas, // Already an array
                inventario: inventario,
                velocidadeCorrida: velocidadeCorridaSpan.textContent,
                alturaPulo: alturaPuloSpan.textContent,
                distanciaPulo: distanciaPuloSpan.textContent,
                isLocked: isFichaLocked,
                password: fichaPassword,
                imagem: characterImage.src && characterImage.src.startsWith('data:image') ? characterImage.src : null,
                anotacoes: anotacoesTextarea.value,
                classeNome: classeNomeInput.value,
                classeDescricao: classeDescricaoInput.value,
                racaNome: racaNomeSpan.textContent,
                racaDescricao: racaDescricaoInput.value,
                racaSelecionada: racaSelecionada,
                backgroundImage: document.body.style.backgroundImage === 'none' || document.body.style.backgroundImage === '' ? null : document.body.style.backgroundImage.slice(5, -2).replace(/"/g, "").replace(/'/g, ""),
                backgroundSize: document.body.style.backgroundSize,
                backgroundColor: document.body.style.backgroundColor,
                darkMode: document.body.classList.contains("dark-mode"),
                fontFamily: fontSelector ? fontSelector.value : "'Inter', sans-serif",
                vidaAtual: vidaAtual,
                magiaAtual: magiaAtual,
                vigorAtual: vigorAtual,
                lastUpdated: serverTimestamp()
            };

            try {
                const fichaDocRef = doc(db, fichasCollectionPath, currentFichaId);
                await setDoc(fichaDocRef, fichaParaSalvar, { merge: true }); // Use merge to avoid overwriting fields not present in fichaParaSalvar (e.g. if a new field is added directly in Firestore)
                // console.log("Ficha salva com sucesso:", currentFichaId);
                // showUINotification("Salvo no Firebase!", "save-success"); // Notification can be annoying if saving on every keystroke
            } catch (error) {
                console.error("Erro ao salvar dados da ficha:", error);
                showUINotification("Erro ao salvar: " + error.message, "critical-failure");
            }
        }


        document.getElementById("excluir-ficha").onclick = async () => {
            if (currentFichaId === FICHA_MATRIZ_ID) {
                showUINotification("A ficha matriz não pode ser excluída!", "critical-failure");
                return;
            }
            if (isFichaLocked && !isFichaUnlocked) {
                abrirModalSenha(document.getElementById("excluir-ficha"));
                return;
            }

            // Custom confirmation modal instead of window.confirm
            const confirmModal = document.getElementById('confirmar-compra-modal'); // Re-using a modal, adjust text
            const confirmModalText = confirmModal.querySelector('h3');
            const confirmBtn = confirmModal.querySelector('.confirm-btn');
            const cancelBtn = confirmModal.querySelector('.cancel-btn');

            confirmModalText.textContent = "Tem certeza que deseja excluir esta ficha?";
            confirmModal.style.display = "flex";

            confirmBtn.onclick = async () => {
                fecharModal('confirmar-compra-modal');
                if (!db || !userId) return;
                try {
                    await deleteDoc(doc(db, fichasCollectionPath, currentFichaId));
                    console.log("Ficha excluída:", currentFichaId);
                    showUINotification("Ficha excluída com sucesso!", "save-success");
                    // Switch to Matriz Ficha
                    await setCurrentFicha(FICHA_MATRIZ_ID);
                    // atualizarAbasFichas will be handled by the collection listener
                } catch (error) {
                    console.error("Erro ao excluir ficha:", error);
                    showUINotification("Erro ao excluir ficha: " + error.message, "critical-failure");
                }
            };
            cancelBtn.onclick = () => fecharModal('confirmar-compra-modal');
        };


        // --- Core Game Logic (largely unchanged, but ensure it calls salvarDados) ---
        function calcularNivel(exp) { return nivelData.findLast(data => exp >= data.xp)?.nivel ?? 0; }

        function atualizarNivel() {
            nivelAnterior = nivel; nivel = calcularNivel(experiencia); nivelSpan.textContent = nivel;
            const nivelInfo = nivelData.find(data => data.nivel === nivel) || nivelData[0];
            pontosHabilidadeTotal = nivelInfo.pd;
            pontosVantagemSpan.textContent = getPontosVantagem();
            if (nivel > nivelAnterior) { nivelSpan.classList.add("aura-azul"); setTimeout(() => nivelSpan.classList.remove("aura-azul"), 20000); }
            gameMasterMessage.style.display = nivel >= 30 ? "block" : "none"; fichaContainer.classList.toggle("aura-azul", nivel >= 30);
            calcularAtributos(); // This will also call salvarDados if attributes change PD
        }

        function getPontosVantagem() {
            let ph = (nivelData.find(data => data.nivel === nivel) || nivelData[0]).ph;
            (Array.isArray(vantagensSelecionadas) ? vantagensSelecionadas : []).forEach(v => { const vantagem = vantagensData.find(d => d.nome === v); if (vantagem) ph -= vantagem.custo; });
            (Array.isArray(desvantagensSelecionadas) ? desvantagensSelecionadas : []).forEach(d => { const desvantagem = desvantagensData.find(desv => desv.nome === d); if (desvantagem) ph += desvantagem.ganho; });
            if (racaSelecionada) { const raca = racasData.find(r => r.nome === racaSelecionada); if (raca) ph -= raca.custo; }
            return ph;
        }

        function calcularPontosVantagemTemp() {
            let ph = (nivelData.find(data => data.nivel === nivel) || nivelData[0]).ph;
            tempVantagensSelecionadas.forEach(v => { const vantagem = vantagensData.find(d => d.nome === v); if (vantagem) ph -= vantagem.custo; });
            tempDesvantagensSelecionadas.forEach(d => { const desvantagem = desvantagensData.find(desv => desv.nome === d); if (desvantagem) ph += desvantagem.ganho; });
            if (tempRacaSelecionada) { const raca = racasData.find(r => r.nome === tempRacaSelecionada); if (raca) ph -= raca.custo; }
            return ph;
        }

        function aumentarVida() { if (vidaAtual < vidaTotal) { vidaAtual++; document.getElementById("vida-atual").textContent = vidaAtual; salvarDados(); } }
        function diminuirVida() { if (vidaAtual > 0) { vidaAtual--; document.getElementById("vida-atual").textContent = vidaAtual; salvarDados(); } }
        function aumentarMagia() { if (magiaAtual < magiaTotal) { magiaAtual++; document.getElementById("magia-atual").textContent = magiaAtual; salvarDados(); } }
        function diminuirMagia() { if (magiaAtual > 0) { magiaAtual--; document.getElementById("magia-atual").textContent = magiaAtual; salvarDados(); } }
        function aumentarVigor() { if (vigorAtual < vigorTotal) { vigorAtual = Math.min(vigorAtual + 0.1, vigorTotal); document.getElementById("vigor-atual").textContent = vigorAtual.toFixed(1); salvarDados(); } }
        function diminuirVigor() { if (vigorAtual > 0) { vigorAtual = Math.max(vigorAtual - 0.1, 0); document.getElementById("vigor-atual").textContent = vigorAtual.toFixed(1); salvarDados(); } }

        function calcularAtributos() {
            let currentForca = parseInt(forcaInput.value) || 0;
            let currentDestreza = parseInt(destrezaInput.value) || 0;
            let currentAgilidade = parseInt(agilidadeInput.value) || 0;
            let currentInteligencia = parseInt(inteligenciaInput.value) || 0;
            let currentConstituicao = parseInt(constituicaoInput.value) || 0;
            let totalPontosAtuais = currentForca + currentDestreza + currentAgilidade + currentInteligencia + currentConstituicao;

            if (totalPontosAtuais > pontosHabilidadeTotal) {
                showUINotification("Pontos de habilidade insuficientes! Revertendo.", "critical-failure");
                forcaInput.value = previousValues.get(forcaInput) || "0";
                destrezaInput.value = previousValues.get(destrezaInput) || "0";
                agilidadeInput.value = previousValues.get(agilidadeInput) || "0";
                inteligenciaInput.value = previousValues.get(inteligenciaInput) || "0";
                constituicaoInput.value = previousValues.get(constituicaoInput) || "0";
                // Recalculate based on reverted values
                currentForca = parseInt(forcaInput.value) || 0;
                currentDestreza = parseInt(destrezaInput.value) || 0;
                // ... and so on for other attributes
                totalPontosAtuais = (parseInt(forcaInput.value) || 0) + (parseInt(destrezaInput.value) || 0) + (parseInt(agilidadeInput.value) || 0) + (parseInt(inteligenciaInput.value) || 0) + (parseInt(constituicaoInput.value) || 0);
            }
            previousValues.set(forcaInput, forcaInput.value);
            previousValues.set(destrezaInput, destrezaInput.value);
            // ... store all attributes in previousValues

            pontosHabilidadeUsados = totalPontosAtuais;
            pontosHabilidadeSpan.textContent = pontosHabilidadeTotal - pontosHabilidadeUsados;

            let ataque = currentForca + Math.floor(currentDestreza / 5);
            let acerto = Math.floor(currentDestreza / 3) + Math.floor(currentAgilidade / 10);
            let esquiva = Math.floor(currentAgilidade / 3);
            let rdf = Math.floor(currentForca / 5);
            let rdm = Math.floor(currentInteligencia / 5);
            let ataqueMagico = currentInteligencia;
            let magiaBase = 20 + 3 * currentConstituicao;
            let vigorBase = 10 + 0.4 * currentConstituicao;
            vidaBase = 50 + (currentConstituicao * (3 + Math.floor(currentForca / 10))) + 10 * nivel;
            if (currentInteligencia >= 10) magiaBase += currentConstituicao * Math.floor(currentInteligencia / 10);

            ataque += (parseInt(armaDireitaAtaqueInput.value) || 0) + (parseInt(armaEsquerdaAtaqueInput.value) || 0);
            ataqueMagico += (parseInt(armaDireitaAtaqueMagicoInput.value) || 0) + (parseInt(armaEsquerdaAtaqueMagicoInput.value) || 0);

            const capacidadeBase = 5;
            const bonusForcaCarga = Math.floor(currentForca / 5);
            const capacidadeCarga = capacidadeBase + bonusForcaCarga;
            if (capacidadeCargaSpan) capacidadeCargaSpan.textContent = capacidadeCarga;

            const pesoTotalAtual = parseFloat(pesoTotalSpan.textContent) || 0;
            let penalidadeEsquivaAcerto = 0;
            const sobrecarga = pesoTotalAtual - capacidadeCarga;
            if (sobrecarga > 0) {
                penalidadeEsquivaAcerto = -1;
                const sobrecargaAdicional = sobrecarga - 3;
                if (sobrecargaAdicional > 0) {
                    penalidadeEsquivaAcerto -= Math.ceil(sobrecargaAdicional / 3);
                }
            }
            acerto += penalidadeEsquivaAcerto;
            esquiva += penalidadeEsquivaAcerto;

            if (pesoTotalSpan && capacidadeCargaSpan) {
                const isOverloaded = sobrecarga > 0;
                pesoTotalSpan.style.color = isOverloaded ? 'red' : '';
                capacidadeCargaSpan.style.color = isOverloaded ? 'red' : '';
            }

            const velocidadeBase = 25 + Math.floor(currentAgilidade / 3) * 3;
            const alturaPuloBase = 1 + Math.floor(currentForca / 10);
            const distanciaPuloBase = 3 + 3 * Math.min(Math.floor(currentForca / 5), Math.floor(currentAgilidade / 5));
            let bonusVelocidade = (Array.isArray(vantagensSelecionadas) && vantagensSelecionadas.includes("Combo Físico (4)")) ? 25 : 0;
            let bonusAlturaPulo = (Array.isArray(vantagensSelecionadas) && vantagensSelecionadas.includes("Combo Físico (4)")) ? 2 : 0;
            let bonusDistanciaPulo = (Array.isArray(vantagensSelecionadas) && vantagensSelecionadas.includes("Combo Físico (4)")) ? 6 : 0;

            velocidadeCorridaSpan.textContent = velocidadeBase + bonusVelocidade;
            alturaPuloSpan.textContent = alturaPuloBase + bonusAlturaPulo;
            distanciaPuloSpan.textContent = distanciaPuloBase + bonusDistanciaPulo;
            ataqueSpan.textContent = ataque;
            ataqueMagicoSpan.textContent = ataqueMagico;
            acertoSpan.textContent = acerto;
            esquivaSpan.textContent = esquiva;
            rdfSpan.textContent = rdf;
            rdmSpan.textContent = rdm;

            vidaTotal = Math.ceil(vidaBase);
            magiaTotal = Math.ceil(magiaBase);
            vigorTotal = parseFloat(vigorBase.toFixed(1));

            document.getElementById("vida-total").textContent = vidaTotal;
            document.getElementById("magia-total").textContent = magiaTotal;
            document.getElementById("vigor-total").textContent = vigorTotal.toFixed(1);

            // Update current values if they exceed new totals
            vidaAtual = Math.min(vidaAtual, vidaTotal);
            magiaAtual = Math.min(magiaAtual, magiaTotal);
            vigorAtual = Math.min(vigorAtual, vigorTotal);

            document.getElementById("vida-atual").textContent = vidaAtual;
            document.getElementById("magia-atual").textContent = magiaAtual;
            document.getElementById("vigor-atual").textContent = vigorAtual.toFixed(1);


            const regeneracaoVida = (0.2 * currentConstituicao).toFixed(1);
            const regeneracaoMagia = (0.8 * currentConstituicao).toFixed(1);
            const regeneracaoVigor = (0.4 * currentConstituicao).toFixed(1);
            document.getElementById("regeneracao-vida").textContent = regeneracaoVida;
            document.getElementById("regeneracao-magia").textContent = regeneracaoMagia;
            document.getElementById("regeneracao-vigor").textContent = regeneracaoVigor;

            const atributosSpans = [{ span: ataqueSpan, valor: ataque }, { span: ataqueMagicoSpan, valor: ataqueMagico }, { span: acertoSpan, valor: acerto }, { span: esquivaSpan, valor: esquiva }, { span: rdfSpan, valor: rdf }, { span: rdmSpan, valor: rdm }];
            atributosSpans.forEach(a => a.span.classList.remove("atributo-fogo"));
            const maxAtributo = atributosSpans.reduce((prev, curr) => prev.valor > curr.valor ? prev : curr, { valor: -Infinity }); // Ensure a valid initial comparison
            if (maxAtributo.valor > 0) maxAtributo.span.classList.add("atributo-fogo");

            // After calculations, save the data
            salvarDados();
        }

        function resetarPontos() {
            if (isFichaLocked && !isFichaUnlocked) return abrirModalSenha(resetPontosButton);
            senhaGmTitulo.textContent = "Peça permissão ao GM para Resetar Pontos";
            document.getElementById("senha-gm-modal").style.display = "flex";
            document.getElementById("senha-gm-input").value = "";
            document.getElementById("confirmar-senha-gm-btn").onclick = () => {
                if (document.getElementById("senha-gm-input").value === senhaMatriz) {
                    atributosInputs.forEach(input => input.value = 0);
                    pontosHabilidadeUsados = 0;
                    // pontosHabilidadeSpan.textContent will be updated by calcularAtributos
                    velocidadeCorridaSpan.textContent = "25"; alturaPuloSpan.textContent = "1"; distanciaPuloSpan.textContent = "3";
                    calcularAtributos(); // This will also save
                    pontosVantagemSpan.textContent = getPontosVantagem(); // Recalculate PH display
                    fecharModal("senha-gm-modal");
                } else { showUINotification("Senha do GM incorreta!", "critical-failure"); fecharModal("senha-gm-modal"); }
            };
        }

        function recomecarFicha() {
            if (isFichaLocked && !isFichaUnlocked) return abrirModalSenha(recomecarButton);

            const confirmModal = document.getElementById('confirmar-compra-modal'); // Re-using a modal
            const confirmModalText = confirmModal.querySelector('h3');
            const confirmBtn = confirmModal.querySelector('.confirm-btn');
            const cancelBtn = confirmModal.querySelector('.cancel-btn');

            confirmModalText.textContent = "Tem certeza que deseja recomeçar a ficha? Todas as alterações serão perdidas.";
            confirmModal.style.display = "flex";

            confirmBtn.onclick = () => {
                fecharModal('confirmar-compra-modal');
                atributosInputs.forEach(input => input.value = 0);
                experienciaInput.value = "0";
                experiencia = 0;
                nivel = 0;
                experienciaInput.readOnly = true;
                isXpUnlocked = false;
                if (xpUnlockTimerId) clearTimeout(xpUnlockTimerId);

                const nivelInfo = nivelData.find(data => data.nivel === nivel) || nivelData[0];
                pontosHabilidadeTotal = nivelInfo.pd;
                pontosHabilidadeUsados = 0;
                nivelSpan.textContent = nivel;
                // pontosHabilidadeSpan will be updated by calcularAtributos

                vidaBase = 50;
                velocidadeCorridaSpan.textContent = "25"; alturaPuloSpan.textContent = "1"; distanciaPuloSpan.textContent = "3";
                nomePersonagemInput.value = ""; descricaoPersonagemInput.value = "";
                armaDireitaNomeInput.value = ""; armaDireitaAtaqueInput.value = "0"; armaDireitaAtaqueMagicoInput.value = "0";
                armaEsquerdaNomeInput.value = ""; armaEsquerdaAtaqueInput.value = "0"; armaEsquerdaAtaqueMagicoInput.value = "0";

                magiasList.innerHTML = "";
                for (let i = 0; i < 10; i++) {
                    const input = document.createElement("input"); input.type = "text"; input.className = "magia-nome";
                    input.placeholder = `Magia/Habilidade ${i + 1}`; input.addEventListener('input', salvarDados);
                    magiasList.appendChild(input);
                }

                const slots = inventarioSlots.querySelectorAll(".inventory-slot");
                slots.forEach(slot => { slot.querySelector(".inventory-item").value = ""; slot.querySelector(".inventory-weight").value = "0"; });
                characterImage.style.display = "none"; characterImage.src = "";
                vantagensSelecionadas = []; desvantagensSelecionadas = []; racaSelecionada = null;
                vantagensListDisplay.innerHTML = ""; desvantagensListDisplay.innerHTML = "";
                anotacoesTextarea.value = "";
                classeNomeInput.value = ""; classeDescricaoInput.value = "";
                racaNomeSpan.textContent = "Selecionar Raça"; racaDescricaoInput.value = "";

                calcularAtributos(); // This also calls salvarDados

                vidaAtual = vidaTotal; magiaAtual = magiaTotal; vigorAtual = vigorTotal;
                document.getElementById("vida-atual").textContent = vidaAtual;
                document.getElementById("magia-atual").textContent = magiaAtual;
                document.getElementById("vigor-atual").textContent = vigorAtual.toFixed(1);

                pontosVantagemSpan.textContent = getPontosVantagem();
                // salvarDados(); // Already called by calcularAtributos
                showUINotification("Ficha recomeçada.", "save-success");
            };
            cancelBtn.onclick = () => fecharModal('confirmar-compra-modal');
        }

        // --- Lock/Unlock Ficha ---
        bloquearFichaButton.onclick = () => {
            if (isFichaLocked) abrirModalSenha();
            else {
                document.getElementById("bloquear-ficha-modal").style.display = "flex";
                document.getElementById("senha-bloqueio-input").value = "";
                document.getElementById("senha-bloqueio-input").focus();
            }
        };
        // Changed button ID for confirm
        document.getElementById("confirmar-bloquear-ficha-btn").onclick = () => {
            const senha = document.getElementById("senha-bloqueio-input").value;
            if (senha.length !== 4 || !/^\d{4}$/.test(senha)) {
                showUINotification("A senha deve ter exatamente 4 dígitos numéricos!", "critical-failure");
                return;
            }
            isFichaLocked = true; fichaPassword = senha;
            // No need to update fichas[currentFichaId] here, salvarDados will handle it
            salvarDados(); // Save the new lock state
            fecharModal("bloquear-ficha-modal");
            showUINotification("Ficha bloqueada com sucesso!", "save-success");
            atualizarBotaoBloquear();
        };

        function abrirModalSenha(element = null) {
            document.getElementById("password-modal").style.display = "flex";
            document.getElementById("senha-desbloqueio-input").value = "";
            document.getElementById("senha-desbloqueio-input").focus();
            if (element) document.getElementById("password-modal").dataset.elementId = element.id;
            else delete document.getElementById("password-modal").dataset.elementId;
        }
        // Changed button ID for confirm
        document.getElementById("confirmar-desbloquear-ficha-btn").onclick = () => {
            const senha = document.getElementById("senha-desbloqueio-input").value;
            const modal = document.getElementById("password-modal");
            const elementId = modal.dataset.elementId;
            const originalButton = elementId ? document.getElementById(elementId) : null;

            if (senha !== senhaMatriz && senha !== fichaPassword) {
                showUINotification("Senha incorreta!", "critical-failure");
                return;
            }
            isFichaUnlocked = true; // Temporary unlock

            if (currentFichaId !== FICHA_MATRIZ_ID && senha !== senhaMatriz) {
                 // Custom confirm
                const confirmPermUnlockModal = document.getElementById('confirmar-compra-modal'); // Re-use
                const confirmPermUnlockText = confirmPermUnlockModal.querySelector('h3');
                const confirmPermBtn = confirmPermUnlockModal.querySelector('.confirm-btn');
                const cancelPermBtn = confirmPermUnlockModal.querySelector('.cancel-btn');

                confirmPermUnlockText.textContent = "Senha correta! Deseja desbloquear a ficha permanentemente? (Cancelar para desbloqueio temporário)";
                confirmPermUnlockModal.style.display = "flex";

                confirmPermBtn.onclick = () => {
                    fecharModal('confirmar-compra-modal');
                    isFichaLocked = false; fichaPassword = null;
                    salvarDados(); // Save permanent unlock state
                    fecharModal("password-modal");
                    showUINotification("Ficha desbloqueada permanentemente!", "save-success");
                    atualizarBotaoBloquear();
                    if (originalButton && typeof originalButton.onclick === 'function' && !originalButton.id.startsWith('btn-')) {
                        originalButton.click();
                    }
                };
                cancelPermBtn.onclick = () => {
                    fecharModal('confirmar-compra-modal');
                    fecharModal("password-modal");
                    showUINotification("Ficha desbloqueada temporariamente!", "save-success");
                    if (originalButton && typeof originalButton.onclick === 'function' && !originalButton.id.startsWith('btn-')) {
                        originalButton.click();
                    }
                };

            } else {
                fecharModal("password-modal");
                showUINotification(`Ficha desbloqueada temporariamente ${senha === senhaMatriz ? 'com a senha matriz!' : ''}`, "save-success");
                if (originalButton && typeof originalButton.onclick === 'function' && !originalButton.id.startsWith('btn-')) {
                    originalButton.click();
                }
            }
        };

        function cancelarDesbloqueio() {
            const modal = document.getElementById("password-modal");
            const elementId = modal.dataset.elementId;
            if (elementId && document.getElementById(elementId) && previousValues.has(document.getElementById(elementId))) {
                document.getElementById(elementId).value = previousValues.get(document.getElementById(elementId)) || "";
            }
            fecharModal("password-modal");
        }

        function atualizarBotaoBloquear() {
            bloquearFichaButton.textContent = isFichaLocked ? "Desbloquear Ficha" : "Bloquear Ficha";
            bloquearFichaButton.classList.toggle("botao-bloquear", !isFichaLocked);
            bloquearFichaButton.classList.toggle("botao-desbloquear", isFichaLocked);
        }


        // --- Input Handling & Event Listeners (attributes, inventory, etc.) ---
        document.querySelectorAll('input[type="text"],input[type="number"]:not(#experiencia),textarea').forEach(input => {
            input.addEventListener("focus", (event) => {
                previousValues.set(event.target, event.target.value);
            });
            input.addEventListener("input", (event) => {
                const inputTarget = event.target;
                if (isFichaLocked && !isFichaUnlocked && currentFichaId !== FICHA_MATRIZ_ID) {
                    inputTarget.value = previousValues.get(inputTarget) || "";
                    abrirModalSenha(inputTarget);
                    return;
                }

                if (atributosInputs.includes(inputTarget) || inputTarget.id.includes("arma") || inputTarget.classList.contains('inventory-weight')) {
                    calcularAtributos(); // This will call salvarDados
                } else {
                    // For other fields, directly save. If calcularAtributos is not called, need to explicitly call salvarDados
                    salvarDados();
                }
                // Update previousValues after processing, so revert works correctly
                previousValues.set(inputTarget, inputTarget.value);
            });
        });
        // Special handling for nomePersonagemInput as it's not in the querySelectorAll above if it doesn't match type
        if(nomePersonagemInput) {
            nomePersonagemInput.addEventListener("focus", (event) => previousValues.set(event.target, event.target.value));
            nomePersonagemInput.addEventListener("input", (event) => {
                 if (isFichaLocked && !isFichaUnlocked && currentFichaId !== FICHA_MATRIZ_ID) {
                    event.target.value = previousValues.get(event.target) || "";
                    abrirModalSenha(event.target);
                    return;
                }
                salvarDados();
                previousValues.set(event.target, event.target.value);
            });
        }


        experienciaInput.addEventListener('focus', (event) => {
            previousValues.set(event.target, event.target.value);
            if (experienciaInput.readOnly && !isXpUnlocked) {
                event.preventDefault();
                senhaGmTitulo.textContent = "Desbloquear Campo de Experiência";
                document.getElementById("senha-gm-modal").style.display = "flex";
                document.getElementById("senha-gm-input").value = "";
                document.getElementById("senha-gm-input").focus();
                document.getElementById("confirmar-senha-gm-btn").onclick = () => confirmarDesbloqueioExperiencia();
            }
        });
        experienciaInput.addEventListener('input', (event) => {
            if (!experienciaInput.readOnly) {
                experiencia = parseInt(event.target.value) || 0;
                atualizarNivel(); // Calls calcularAtributos which calls salvarDados
                previousValues.set(event.target, event.target.value);
            } else {
                event.target.value = previousValues.get(event.target) || "0";
            }
        });

        function confirmarDesbloqueioExperiencia() {
            if (document.getElementById("senha-gm-input").value === senhaMatriz) {
                experienciaInput.readOnly = false;
                isXpUnlocked = true;
                experienciaInput.focus();
                showUINotification("Campo de experiência desbloqueado por 20 segundos.", "normal-result");
                if (xpUnlockTimerId) clearTimeout(xpUnlockTimerId);
                xpUnlockTimerId = setTimeout(() => {
                    experienciaInput.readOnly = true;
                    isXpUnlocked = false;
                    showUINotification("Tempo para editar experiência expirou.", "normal-result");
                    // Data is saved on input change by atualizarNivel -> calcularAtributos -> salvarDados
                }, XP_UNLOCK_DURATION_MS);
                fecharModal("senha-gm-modal");
            } else {
                showUINotification("Senha do GM incorreta!", "critical-failure");
                fecharModal("senha-gm-modal");
            }
        }

        // Image Upload
        characterImageInput.onchange = e => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = e => {
                    characterImage.src = e.target.result;
                    characterImage.style.display = "block";
                    salvarDados();
                };
                reader.readAsDataURL(file);
            }
        };

        // Dice Roll
        let isDragging = false, currentX = 0, currentY = 0, initialX, initialY;
        diceContainer.onmousedown = e => { isDragging = true; initialX = e.clientX - currentX; initialY = e.clientY - currentY; diceContainer.style.cursor = "grabbing"; };
        document.onmousemove = e => { if (isDragging) { e.preventDefault(); currentX = e.clientX - initialX; currentY = e.clientY - initialY; diceContainer.style.left = `${currentX}px`; diceContainer.style.top = `${currentY}px`; diceContainer.style.right = "auto"; } };
        document.onmouseup = () => { if (isDragging) { isDragging = false; diceContainer.style.cursor = "move"; } };
        diceRoll.onclick = () => {
            if (isFichaLocked && !isFichaUnlocked) return abrirModalSenha(diceRoll);
            diceRoll.textContent = "Rolling..."; diceResult.style.display = "none"; diceRoll.classList.remove("critical-failure", "critical-success");
            setTimeout(() => {
                const roll = Math.floor(Math.random() * 20) + 1;
                const fichaNome = (fichas[currentFichaId] ? fichas[currentFichaId].nomeFicha : "Ficha") || "Ficha";
                diceRoll.textContent = roll;
                let notificationClass = "normal-result";
                let notificationMsg = `${fichaNome} rolou: ${roll}`;
                if (roll === 1) { diceRoll.classList.add("critical-failure"); notificationClass = "critical-failure"; notificationMsg = `${fichaNome} - FALHA CRÍTICA!`; }
                else if (roll === 20) { diceRoll.classList.add("critical-success"); notificationClass = "critical-success"; notificationMsg = `${fichaNome} - SUCESSO CRÍTICO!`; }
                else { diceResult.textContent = `Resultado: ${roll}`; diceResult.style.display = "block"; }
                showUINotification(notificationMsg, notificationClass);
            }, 1000);
        };

        // Vantagens/Desvantagens Panel
        vantagensDesvantagensBtn.onclick = () => {
            if (isFichaLocked && !isFichaUnlocked) return abrirModalSenha(vantagensDesvantagensBtn);
            tempVantagensSelecionadas = [...(Array.isArray(vantagensSelecionadas) ? vantagensSelecionadas : [])];
            tempDesvantagensSelecionadas = [...(Array.isArray(desvantagensSelecionadas) ? desvantagensSelecionadas : [])];
            vantagensDesvantagensPanel.style.display = "block";
            document.getElementById("salvar-vantagens-btn").style.display = "none";
            atualizarVantagensDesvantagensPanel();
        };
        fecharPaginaBtn.onclick = () => { vantagensDesvantagensPanel.style.display = "none"; };
        salvarVantagensBtn.onclick = () => {
            document.getElementById("salvar-modal-texto").textContent = "Se salvar, as alterações de Vantagens/Desvantagens não poderão ser desfeitas.";
            document.getElementById("salvar-vantagens-modal").style.display = "flex";
        };
        salvarRacasBtn.onclick = () => {
            document.getElementById("salvar-modal-texto").textContent = "Se salvar, a alteração de Raça não poderá ser desfeita.";
            document.getElementById("salvar-vantagens-modal").style.display = "flex";
        };
        confirmarSalvarBtn.onclick = () => {
            if (racasPanel.style.display === "block") { // Saving Race
                if (tempRacaSelecionada && tempRacaSelecionada !== racaSelecionada) {
                    const raca = racasData.find(r => r.nome === tempRacaSelecionada);
                    if (raca && calcularPontosVantagemTemp() >= 0) {
                        racaSelecionada = tempRacaSelecionada;
                        racaNomeSpan.textContent = racaSelecionada.split(" (")[0];
                        racaDescricaoInput.value = raca.vantagens.join("\n\n");
                        // pontosVantagemSpan updated by calcularAtributos
                        racasPanel.style.display = "none";
                        calcularAtributos(); // This will save
                    } else if (raca) {
                        showUINotification("Pontos de Vantagem insuficientes para confirmar esta raça!", "critical-failure");
                    }
                } else {
                    racasPanel.style.display = "none";
                }
            } else { // Saving Vantagens/Desvantagens
                if (tempDesvantagensSelecionadas.length > 3) {
                    showUINotification("Você pode ter no máximo 3 desvantagens!", "critical-failure");
                    fecharModal("salvar-vantagens-modal"); return;
                }
                if (calcularPontosVantagemTemp() < 0) {
                    showUINotification("Pontos de Vantagem insuficientes com as vantagens selecionadas!", "critical-failure");
                    fecharModal("salvar-vantagens-modal"); return;
                }
                vantagensSelecionadas = [...tempVantagensSelecionadas];
                desvantagensSelecionadas = [...tempDesvantagensSelecionadas];
                vantagensListDisplay.innerHTML = ""; desvantagensListDisplay.innerHTML = "";
                vantagensSelecionadas.forEach(v => { const div = document.createElement("div"); div.textContent = v; div.className = "list-item"; div.onclick = () => removerVantagem(v); vantagensListDisplay.appendChild(div); });
                desvantagensSelecionadas.forEach(d => { const div = document.createElement("div"); div.textContent = d; div.className = "list-item"; div.onclick = () => removerDesvantagem(d); desvantagensListDisplay.appendChild(div); });
                // pontosVantagemSpan updated by calcularAtributos
                vantagensDesvantagensPanel.style.display = "none";
                calcularAtributos(); // This will save
            }
            fecharModal("salvar-vantagens-modal");
        };

        function atualizarVantagensDesvantagensPanel() {
            vantagensList.innerHTML = "<h3>Vantagens</h3>"; desvantagensList.innerHTML = "<h3>Desvantagens</h3>";
            vantagensData.forEach(v => {
                const div = document.createElement("div"); div.className = "vantagem-item"; div.textContent = `${v.nome} - Custo: ${v.custo} PH - ${v.descricao}`;
                if (tempVantagensSelecionadas.includes(v.nome)) div.classList.add("comprada");
                div.onclick = () => {
                    if (vantagensSelecionadas.includes(v.nome)) { showUINotification("Vantagem salva só pode ser removida com permissão do GM.", "normal-result"); return; }
                    if (tempVantagensSelecionadas.includes(v.nome)) tempVantagensSelecionadas = tempVantagensSelecionadas.filter(t => t !== v.nome);
                    else {
                        if (v.restricao === "inicio" && nivel > 0) { showUINotification("Compra dessa vantagem é somente no nível 0.", "critical-failure"); return; }
                        if ((calcularPontosVantagemTemp() - v.custo) >= 0) tempVantagensSelecionadas.push(v.nome);
                        else showUINotification("PH insuficientes!", "critical-failure");
                    }
                    atualizarVantagensDesvantagensPanel(); document.getElementById("salvar-vantagens-btn").style.display = "block";
                }; vantagensList.appendChild(div);
            });
            desvantagensData.forEach(d => {
                const div = document.createElement("div"); div.className = "desvantagem-item"; div.textContent = `${d.nome} - Ganho: ${d.ganho} PH - ${d.descricao}`;
                if (tempDesvantagensSelecionadas.includes(d.nome)) div.classList.add("comprada");
                div.onclick = () => {
                    if (desvantagensSelecionadas.includes(d.nome)) { showUINotification("Desvantagem salva só pode ser removida com permissão do GM.", "normal-result"); return; }
                    if (tempDesvantagensSelecionadas.includes(d.nome)) tempDesvantagensSelecionadas = tempDesvantagensSelecionadas.filter(t => t !== d.nome);
                    else {
                        if (tempDesvantagensSelecionadas.length < 3) tempDesvantagensSelecionadas.push(d.nome);
                        else showUINotification("Limite de 3 desvantagens!", "critical-failure");
                    }
                    atualizarVantagensDesvantagensPanel(); document.getElementById("salvar-vantagens-btn").style.display = "block";
                }; desvantagensList.appendChild(div);
            });
            document.getElementById("ph-temp").textContent = calcularPontosVantagemTemp();
        }

        function removerVantagem(v) {
            if (isFichaLocked && !isFichaUnlocked) return abrirModalSenha();
            senhaGmTitulo.textContent = "Peça permissão ao GM para Remover Vantagem";
            // Custom confirm
            const confirmModal = document.getElementById('confirmar-compra-modal');
            const confirmModalText = confirmModal.querySelector('h3');
            confirmModalText.textContent = `Deseja remover a vantagem "${v}"?`;
            confirmModal.style.display = "flex";
            confirmModal.querySelector('.confirm-btn').onclick = () => {
                fecharModal('confirmar-compra-modal');
                document.getElementById("senha-gm-modal").style.display = "flex"; document.getElementById("senha-gm-input").value = "";
                document.getElementById("confirmar-senha-gm-btn").onclick = () => {
                    if (document.getElementById("senha-gm-input").value === senhaMatriz) {
                        vantagensSelecionadas = vantagensSelecionadas.filter(t => t !== v);
                        Array.from(vantagensListDisplay.children).find(div => div.textContent === v)?.remove();
                        // pontosVantagemSpan updated by calcularAtributos
                        fecharModal("senha-gm-modal"); calcularAtributos(); // Will save
                    } else { showUINotification("Senha do GM incorreta!", "critical-failure"); fecharModal("senha-gm-modal"); }
                };
            };
            confirmModal.querySelector('.cancel-btn').onclick = () => fecharModal('confirmar-compra-modal');
        }
        function removerDesvantagem(d) {
            if (isFichaLocked && !isFichaUnlocked) return abrirModalSenha();
            senhaGmTitulo.textContent = "Peça permissão ao GM para Remover Desvantagem";
             // Custom confirm
            const confirmModal = document.getElementById('confirmar-compra-modal');
            const confirmModalText = confirmModal.querySelector('h3');
            confirmModalText.textContent = `Deseja remover a desvantagem "${d}"?`;
            confirmModal.style.display = "flex";
            confirmModal.querySelector('.confirm-btn').onclick = () => {
                fecharModal('confirmar-compra-modal');
                document.getElementById("senha-gm-modal").style.display = "flex"; document.getElementById("senha-gm-input").value = "";
                document.getElementById("confirmar-senha-gm-btn").onclick = () => {
                    if (document.getElementById("senha-gm-input").value === senhaMatriz) {
                        desvantagensSelecionadas = desvantagensSelecionadas.filter(t => t !== d);
                        Array.from(desvantagensListDisplay.children).find(div => div.textContent === d)?.remove();
                        fecharModal("senha-gm-modal"); calcularAtributos(); // Will save
                    } else { showUINotification("Senha do GM incorreta!", "critical-failure"); fecharModal("senha-gm-modal"); }
                };
            };
            confirmModal.querySelector('.cancel-btn').onclick = () => fecharModal('confirmar-compra-modal');
        }

        // Inventory Weight
        function calcularPesoTotal() {
            pesoTotalSpan.textContent = Array.from(inventarioSlots.querySelectorAll(".inventory-weight")).reduce((total, weight) => total + (parseFloat(weight.value) || 0), 0).toFixed(1);
            // calcularAtributos will be called by the input listener for weight if it changes PD
        }
        inventarioSlots.addEventListener("input", (event) => {
            if (event.target.classList.contains('inventory-weight')) {
                calcularPesoTotal();
                calcularAtributos(); // Update encumbrance penalties and save
            } else if (event.target.classList.contains('inventory-item')) {
                salvarDados();
            }
        });

        // Anotações
        anotacoesBtn.onclick = () => { anotacoesTextarea.style.display = anotacoesTextarea.style.display === "block" ? "none" : "block"; };
        document.addEventListener('click', (event) => { if (anotacoesTextarea.style.display === "block" && !anotacoesTextarea.contains(event.target) && !anotacoesBtn.contains(event.target)) anotacoesTextarea.style.display = 'none'; });
        anotacoesTextarea.oninput = salvarDados;

        // Magias
        adicionarMagiaBtn.onclick = () => {
            if (isFichaLocked && !isFichaUnlocked) return abrirModalSenha(adicionarMagiaBtn);
            if (magiasList.children.length < 20) {
                const input = document.createElement("input"); input.type = "text"; input.className = "magia-nome";
                input.placeholder = `Magia/Habilidade ${magiasList.children.length + 1}`;
                input.addEventListener('input', salvarDados);
                magiasList.appendChild(input);
                salvarDados(); // Save after adding the new empty slot
            } else showUINotification("Limite de 20 magias/habilidades!", "critical-failure");
        };

        // Raças Panel
        racasBtn.onclick = () => {
            if (isFichaLocked && !isFichaUnlocked) return abrirModalSenha(racasBtn);
            tempRacaSelecionada = racaSelecionada;
            atualizarRacasPanel();
            racasPanel.style.display = "block";
            document.getElementById("salvar-racas-btn").style.display = "none";
        };
        fecharRacasBtn.onclick = () => { racasPanel.style.display = "none"; };
        function atualizarRacasPanel() {
            racasList.innerHTML = "";
            racasData.forEach(r => {
                const div = document.createElement("div"); div.className = "raca-item";
                div.innerHTML = `<h3>${r.nome}</h3><p>${r.descricao}</p><p><strong>Vantagens:</strong></p><ul>${r.vantagens.map(v => `<li>${v}</li>`).join("")}</ul>`;
                if (tempRacaSelecionada === r.nome) div.classList.add("comprada");
                div.onclick = () => {
                    if (racaSelecionada && racaSelecionada !== r.nome) { showUINotification("Raça salva só pode ser alterada com permissão do GM.", "normal-result"); return; }
                    if (tempRacaSelecionada === r.nome) { tempRacaSelecionada = null; }
                    else {
                        let phDisponivelParaNovaRaca = calcularPontosVantagemTemp() + (tempRacaSelecionada ? (racasData.find(ra => ra.nome === tempRacaSelecionada)?.custo || 0) : 0);
                        if (phDisponivelParaNovaRaca >= r.custo) {
                            tempRacaSelecionada = r.nome;
                            const confirmModal = document.getElementById("confirmar-compra-modal");
                            confirmModal.style.display = "flex";
                            confirmModal.querySelector('.confirm-btn').onclick = () => {
                                atualizarRacasPanel();
                                document.getElementById("salvar-racas-btn").style.display = "block";
                                fecharModal("confirmar-compra-modal");
                            };
                            confirmModal.querySelector('.cancel-btn').onclick = () => {
                                tempRacaSelecionada = null; // Revert if cancelled
                                atualizarRacasPanel();
                                fecharModal("confirmar-compra-modal");
                            }
                        } else { showUINotification("PH insuficientes!", "critical-failure"); tempRacaSelecionada = null; }
                    }
                    atualizarRacasPanel();
                    document.getElementById("salvar-racas-btn").style.display = tempRacaSelecionada && tempRacaSelecionada !== racaSelecionada ? "block" : "none";
                }; racasList.appendChild(div);
            });
            phTempRacaSpan.textContent = calcularPontosVantagemTemp();
        }
        function abrirModalRaca() { document.getElementById("raca-opcoes-modal").style.display = "flex"; }
        function excluirRacaSelecionadaModal() {
            fecharModal('raca-opcoes-modal'); if (isFichaLocked && !isFichaUnlocked) return abrirModalSenha();
            senhaGmTitulo.textContent = "Peça permissão ao GM para Excluir Raça";
            // Custom confirm
            const confirmModal = document.getElementById('confirmar-compra-modal');
            const confirmModalText = confirmModal.querySelector('h3');
            confirmModalText.textContent = "Tem certeza que deseja excluir a raça selecionada?";
            confirmModal.style.display = "flex";
            confirmModal.querySelector('.confirm-btn').onclick = () => {
                fecharModal('confirmar-compra-modal');
                document.getElementById("senha-gm-modal").style.display = "flex"; document.getElementById("senha-gm-input").value = "";
                document.getElementById("confirmar-senha-gm-btn").onclick = () => {
                    if (document.getElementById("senha-gm-input").value === senhaMatriz) {
                        racaSelecionada = null; tempRacaSelecionada = null; racaNomeSpan.textContent = "Selecionar Raça"; racaDescricaoInput.value = "";
                        fecharModal("senha-gm-modal"); calcularAtributos(); // Will save
                    } else { showUINotification("Senha do GM incorreta!", "critical-failure"); fecharModal("senha-gm-modal"); }
                };
            };
            confirmModal.querySelector('.cancel-btn').onclick = () => fecharModal('confirmar-compra-modal');
        }
        function editarRacaSelecionadaModal() {
            if (isFichaLocked && !isFichaUnlocked) return abrirModalSenha(); fecharModal('raca-opcoes-modal');
            document.getElementById("editar-raca-modal").style.display = "flex";
            document.getElementById("editar-raca-nome").value = racaNomeSpan.textContent === "Selecionar Raça" ? "" : racaNomeSpan.textContent;
            document.getElementById("editar-raca-descricao").value = racaDescricaoInput.value;
        }
        function salvarEdicaoRaca() {
            if (isFichaLocked && !isFichaUnlocked) return abrirModalSenha();
            senhaGmTitulo.textContent = "Peça permissão ao GM para Editar Raça";
            // Custom confirm
            const confirmModal = document.getElementById('confirmar-compra-modal');
            const confirmModalText = confirmModal.querySelector('h3');
            confirmModalText.textContent = "Tem certeza que deseja editar a raça selecionada?";
            confirmModal.style.display = "flex";
            confirmModal.querySelector('.confirm-btn').onclick = () => {
                fecharModal('confirmar-compra-modal');
                document.getElementById("senha-gm-modal").style.display = "flex"; document.getElementById("senha-gm-input").value = "";
                document.getElementById("confirmar-senha-gm-btn").onclick = () => {
                    if (document.getElementById("senha-gm-input").value === senhaMatriz) {
                        racaNomeSpan.textContent = document.getElementById("editar-raca-nome").value || "Selecionar Raça";
                        racaDescricaoInput.value = document.getElementById("editar-raca-descricao").value;
                        // Note: This custom edit doesn't change PH cost, it's a GM override for text.
                        // If racaSelecionada needs to be updated to match a new name from racasData, that logic would be more complex.
                        // For now, it just updates the text fields.
                        fecharModal('editar-raca-modal'); salvarDados(); fecharModal("senha-gm-modal");
                    } else { showUINotification("Senha do GM incorreta!", "critical-failure"); fecharModal("senha-gm-modal"); }
                };
            };
            confirmModal.querySelector('.cancel-btn').onclick = () => fecharModal('confirmar-compra-modal');
        }

        // Classes Panel
        classesBtn.onclick = () => { classesPanel.style.display = "block"; };
        fecharClassesBtn.onclick = () => { classesPanel.style.display = "none"; };

        // Theme and Appearance
        luaBtn.onclick = () => { document.body.classList.add("dark-mode"); salvarDados(); };
        solBtn.onclick = () => { document.body.classList.remove("dark-mode"); salvarDados(); };
        resetPontosButton.onclick = resetarPontos;
        recomecarButton.onclick = recomecarFicha;

        planoFundoBtn.onclick = () => { backgroundModal.style.display = "flex"; };
        function aplicarPlanoDeFundo() {
            const file = backgroundImageInput.files[0];
            const selectedSize = document.querySelector('input[name="background-size"]:checked').value;
            if (file) {
                const reader = new FileReader();
                reader.onload = e => {
                    const imageUrl = e.target.result;
                    document.body.style.backgroundImage = `url('${imageUrl}')`;
                    document.body.style.backgroundSize = selectedSize;
                    salvarDados(); fecharModal('background-modal');
                }; reader.readAsDataURL(file);
            } else if (document.body.style.backgroundImage && document.body.style.backgroundImage !== 'none') {
                document.body.style.backgroundSize = selectedSize;
                salvarDados(); fecharModal('background-modal');
            } else {
                showUINotification("Nenhuma imagem selecionada.", "normal-result");
            }
        }
        function excluirPlanoDeFundo() {
            // Custom confirm
            const confirmModal = document.getElementById('confirmar-compra-modal');
            const confirmModalText = confirmModal.querySelector('h3');
            confirmModalText.textContent = "Remover imagem de fundo?";
            confirmModal.style.display = "flex";
            confirmModal.querySelector('.confirm-btn').onclick = () => {
                fecharModal('confirmar-compra-modal');
                document.body.style.backgroundImage = 'none';
                salvarDados(); fecharModal('background-modal');
            };
            confirmModal.querySelector('.cancel-btn').onclick = () => fecharModal('confirmar-compra-modal');
        }
        function aplicarPlanoDeFundoInicial(ficha) {
            const bgImage = ficha?.backgroundImage;
            const bgSize = ficha?.backgroundSize || 'cover';
            if (bgImage) {
                document.body.style.backgroundImage = `url('${bgImage}')`;
                document.body.style.backgroundSize = bgSize;
            } else {
                document.body.style.backgroundImage = 'none';
            }
        }
        if (backgroundColorButtonVisual && backgroundColorInput) {
            backgroundColorButtonVisual.addEventListener('click', () => backgroundColorInput.click());
            backgroundColorInput.addEventListener('input', (event) => {
                document.body.style.backgroundColor = event.target.value;
                backgroundColorButtonVisual.style.backgroundColor = event.target.value;
                salvarDados();
            });
        }
        function aplicarCorDeFundoInicial(ficha) {
            const defaultColorLight = '#f0e6d2'; const defaultColorDark = '#121212';
            let bgColorToApply = ficha?.darkMode ? defaultColorDark : defaultColorLight;
            if (ficha?.backgroundColor) { bgColorToApply = ficha.backgroundColor; }
            document.body.style.backgroundColor = bgColorToApply;
            if (backgroundColorInput) backgroundColorInput.value = bgColorToApply;
            if (backgroundColorButtonVisual) backgroundColorButtonVisual.style.backgroundColor = bgColorToApply;
        }
        if (fontSelector) {
            fontSelector.addEventListener('change', (event) => {
                const selectedFont = event.target.value;
                document.body.style.fontFamily = selectedFont;
                if (fichaContainer) fichaContainer.style.fontFamily = selectedFont;
                salvarDados();
            });
        }
        function aplicarFonteInicial(ficha) {
            const defaultFont = "'Inter', sans-serif";
            const bodyFont = ficha?.fontFamily || defaultFont;
            document.body.style.fontFamily = bodyFont;
            if (fichaContainer) fichaContainer.style.fontFamily = bodyFont;
            if (fontSelector) fontSelector.value = bodyFont;
        }

        // Hold Button Functionality
        function setupHoldButtonEvents(buttonElement, actionFunction) {
            if (!buttonElement) return;
            const startAction = (event) => {
                event.preventDefault();
                if (isFichaLocked && !isFichaUnlocked && currentFichaId !== FICHA_MATRIZ_ID) {
                    abrirModalSenha(buttonElement); return;
                }
                actionFunction();
                if (currentActionIntervalId) clearInterval(currentActionIntervalId);
                currentActionIntervalId = setInterval(actionFunction, REPEAT_DELAY_MS);
            };
            const stopAction = () => { clearInterval(currentActionIntervalId); currentActionIntervalId = null; };
            buttonElement.addEventListener('mousedown', startAction);
            buttonElement.addEventListener('mouseup', stopAction);
            buttonElement.addEventListener('mouseleave', stopAction);
            buttonElement.addEventListener('touchstart', startAction, { passive: false });
            buttonElement.addEventListener('touchend', stopAction);
            buttonElement.addEventListener('touchcancel', stopAction);
        }

        // --- DOMContentLoaded ---
        document.addEventListener('DOMContentLoaded', () => {
            if (diceContainer) {
                currentX = diceContainer.offsetLeft;
                currentY = diceContainer.offsetTop;
            }
            
            initializeFirebaseApp(); // Start Firebase initialization

            // Setup hold buttons after Firebase auth and initial data load (or ensure they are re-setup if displayFichaData rebuilds them)
            const btnDiminuirVida = document.getElementById('btn-diminuir-vida');
            const btnAumentarVida = document.getElementById('btn-aumentar-vida');
            const btnDiminuirMagia = document.getElementById('btn-diminuir-magia');
            const btnAumentarMagia = document.getElementById('btn-aumentar-magia');
            const btnDiminuirVigor = document.getElementById('btn-diminuir-vigor');
            const btnAumentarVigor = document.getElementById('btn-aumentar-vigor');

            // Clear any existing simple onclicks if they were there
            if(btnDiminuirVida) btnDiminuirVida.onclick = null;
            if(btnAumentarVida) btnAumentarVida.onclick = null;
            // ... for all such buttons

            setupHoldButtonEvents(btnDiminuirVida, diminuirVida);
            setupHoldButtonEvents(btnAumentarVida, aumentarVida);
            setupHoldButtonEvents(btnDiminuirMagia, diminuirMagia);
            setupHoldButtonEvents(btnAumentarMagia, aumentarMagia);
            setupHoldButtonEvents(btnDiminuirVigor, diminuirVigor);
            setupHoldButtonEvents(btnAumentarVigor, aumentarVigor);
        });
    </script>
</body>
</html>
