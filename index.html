html
<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ficha de Personagem RPG</title>
    <link href="https://fonts.googleapis.com/css2?family=MedievalSharp&family=Inter:wght@400;600&display=swap"
        rel="stylesheet">
    <script src="https://unpkg.com/@tailwindcss/browser@4"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: #f5f5f5;
            color: #000;
            display: flex;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            background-color: #d2b48c; /* Cor de pergaminho padrão */
            background-image: none; /* Inicialmente sem imagem de fundo */
            background-size: cover;
            background-position: center;
            transition: background 0.3s, color 0.3s
        }

        body.dark-mode {
            background: #121212;
            color: #e0e0e0
        }

        #chat-btn-container {
            position: fixed;
            left: 10px;
            top: calc(50% - 120px);
            /* Ajuste para mover o botão para cima com mais espaço */
            z-index: 1000;
        }

        #chat-btn {
            padding: 15px;
            background: #f0e6d2;
            border: 2px solid #b8860b;
            border-radius: 8px;
            font-family: 'MedievalSharp', serif;
            font-size: 1.2rem;
            color: #000;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 3px 3px 7px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            position: relative; /* Needed for the pseudo-element */
        }

        #chat-btn:hover {
            background: #a0522d;
            transform: translateY(-3px);
        }

        #chat-btn::after {
            content: attr(data-unread);
            position: absolute;
            top: -10px;
            right: -10px;
            background-color: red;
            color: white;
            border-radius: 50%;
            padding: 5px;
            font-size: 0.8rem;
            min-width: 20px;
            text-align: center;
            display: none; /* Hidden by default */
        }

        /* Show the badge only if data-unread is greater than 0 */
        #chat-btn[data-unread]:not([data-unread="0"])::after {
            display: block;
        }


        body.dark-mode #chat-btn {
            background: #1e1e1e;
            color: #e0e0e0;
            border-color: #444;
        }

        body.dark-mode #chat-btn:hover {
            background: #333;
        }

        #fichas-sidebar {
            width: 100%;
            height: 60px;
            padding: 0;
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: flex-start;
            position: fixed;
            top: 0;
            left: 0;
            z-index: 1000;
            overflow-x: auto;
            background: transparent
        }

        .ficha-tab {
            visibility: visible;
            width: 100px;
            height: 50px;
            background: #f0e6d2;
            border: 2px solid #b8860b;
            border-radius: 10px 10px 0 0;
            margin-left: 10px; /* Add some space between tabs */
            flex-shrink: 0; /* Prevent tabs from shrinking */
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.2)
        }

        .ficha-tab:hover {
            background: #a0522d;
            transform: translateY(-5px)
        }

        .ficha-tab.active {
            background: #a0522d;
            transform: translateY(-5px);
            border-bottom: none; /* Optional: remove bottom border for active tab */
        }

        .ficha-tab span {
            font-family: 'MedievalSharp', serif;
            color: #000;
            font-size: 0.9rem;
            text-align: center;
            max-width: 90px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap
        }

        #add-ficha-btn {
            width: 100px;
            height: 50px;
            background: #f0e6d2;
            border: 2px solid #b8860b;
            border-radius: 10px 10px 0 0;
            margin-left: 10px; /* Consistent margin */
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: transform 0.2s ease;
            box-shadow: 0 0 10px #ffd700, 0 0 20px #ffd700;
            z-index: 1001;
            flex-shrink: 0; /* Prevent shrinking */
        }

        #add-ficha-btn span {
            font-family: 'MedievalSharp', serif;
            color: #000;
            font-size: 0.9rem
        }

        #add-ficha-btn:hover {
            background: #a0522d;
            transform: translateY(-5px)
        }

        #ficha-container {
            background: rgba(240, 230, 210, 0.95);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
            width: 95%;
            max-width: 1200px;
            margin: 80px auto 20px;
            border: 2px solid #b8860b;
            position: relative;
            z-index: 1; /* Garante que a ficha fica abaixo da anotação */
        }

        body.dark-mode #ficha-container {
            background: rgba(30, 30, 30, 0.95);
            color: #e0e0e0
        }

        #ficha-container.aura-azul {
            box-shadow: 0 0 30px 15px #00BFFF;
            animation: pulsar-aura 2s infinite
        }

        @keyframes pulsar-aura {
            0% {
                box-shadow: 0 0 20px #00BFFF, 0 0 30px #00BFFF, 0 0 40px #00BFFF
            }

            50% {
                box-shadow: 0 0 30px #00BFFF, 0 0 50px #00BFFF, 0 0 60px #00BFFF
            }

            100% {
                box-shadow: 0 0 20px #00BFFF, 0 0 30px #00BFFF, 0 0 40px #00BFFF
            }
        }

        h1#nome-personagem-titulo {
            font-family: 'MedievalSharp', serif;
            color: #1C2526;
            font-size: 3rem;
            margin-bottom: 20px;
            text-align: center;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
            animation: raios 2s infinite linear
        }

        body.dark-mode h1#nome-personagem-titulo {
            color: #e0e0e0; /* Adjust title color for dark mode */
        }


        @keyframes raios {
            0% {
                text-shadow: 0 0 5px #FFD700, 0 0 10px #FFD700, 0 0 15px #FFD700, 0 0 20px #FF4500
            }

            50% {
                text-shadow: 0 0 10px #FFD700, 0 0 15px #FFD700, 0 0 20px #FF4500, 0 0 25px #FF4500
            }

            100% {
                text-shadow: 0 0 5px #FFD700, 0 0 10px #FFD700, 0 0 15px #FFD700, 0 0 20px #FF4500
            }
        }

        #game-master-message {
            display: none;
            color: blue;
            font-size: 1.5rem;
            text-align: center;
            font-family: 'MedievalSharp', serif;
            margin-bottom: 10px
        }

        section {
            background: #f0e6d2;
            border: 2px solid #b8860b;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px
        }

        section h2 {
            text-align: center;
            font-family: 'MedievalSharp', serif; /* Apply medieval font to section titles */
            font-size: 1.8rem; /* Slightly larger section titles */
            color: #a0522d; /* Section title color */
            margin-bottom: 15px;
        }

        body.dark-mode section {
            background: #1e1e1e;
            border-color: #444
        }

        body.dark-mode section h2 {
            color: #b8860b; /* Dark mode section title color */
        }

        label {
            font-weight: 600;
            color: #000;
            margin-bottom: 8px;
            display: block
        }

        body.dark-mode label {
            color: #e0e0e0
        }

        input[type="text"],
        input[type="number"],
        textarea {
            padding: 10px;
            border: 2px solid #b8860b;
            border-radius: 6px;
            width: calc(100% - 24px);
            margin-bottom: 15px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
            background: #fff;
            color: #000
        }

        body.dark-mode input[type="text"],
        body.dark-mode input[type="number"],
        body.dark-mode textarea {
            background: #333;
            color: #e0e0e0;
            border-color: #555
        }

        input[type="text"]:focus,
        input[type="number"]:focus,
        textarea:focus {
            border-color: #a0522d;
            outline: none;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1)
        }

        input[readonly],
        span[readonly] {
            background: #e8e8e8;
            border: 1px solid #ccc;
            cursor: not-allowed;
             padding: 10px; /* Added padding */
            border-radius: 6px; /* Added border-radius */
            display: inline-block; /* Needed for padding */
            min-width: 40px; /* Ensure minimum width */
            text-align: center; /* Center text */
        }

        body.dark-mode input[readonly],
        body.dark-mode span[readonly] {
            background: #444;
            border-color: #666;
            color: #ccc; /* Ensure readability in dark mode */
        }


        textarea {
            resize: vertical
        }

        .atributos-container {
            display: flex;
            justify-content: space-between;
            gap: 20px;
            flex-wrap: wrap; /* Allow wrapping on smaller screens */
        }

        .atributos-coluna,
        .atributos-coluna-destaque {
             width: 100%; /* Full width on small screens */
            display: flex;
            flex-direction: column;
            align-items: flex-start
        }

         @media (min-width: 768px) { /* Apply side-by-side layout on larger screens */
            .atributos-coluna,
            .atributos-coluna-destaque {
                width: 48%;
            }
        }


        .atributos-coluna-destaque {
            background: #fff;
            padding: 15px; /* Increased padding */
            border-radius: 8px; /* Slightly more rounded */
            border: 2px solid #b8860b; /* Consistent border */
            margin-top: 10px; /* Add space when wrapping */
             box-shadow: 0 2px 4px rgba(0,0,0,0.1); /* Subtle shadow */
        }


        body.dark-mode .atributos-coluna-destaque {
            background: #2a2a2a; /* Darker background for destaque */
            border-color: #555
        }

        .atributo-destaque {
            padding: 10px; /* Increased padding */
            margin-bottom: 12px; /* Increased margin */
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            border-bottom: 1px dashed #b8860b; /* Separator */
        }
         .atributo-destaque:last-child {
            border-bottom: none; /* Remove border for last item */
            margin-bottom: 0;
        }


        .atributo-destaque label {
            font-size: 1.1rem;
            font-weight: 700;
            color: #a0522d
        }

         body.dark-mode .atributo-destaque label {
            color: #f0e6d2; /* Lighter label color in dark mode */
        }


        .atributo-destaque span {
            font-size: 1.3rem; /* Slightly larger value */
            font-family: 'MedievalSharp', serif;
            color: #000;
             font-weight: bold; /* Make value bold */
             min-width: 30px; /* Ensure space for value */
             text-align: right;
        }


        body.dark-mode .atributo-destaque span {
            color: #e0e0e0
        }

        .atributo-fogo {
            animation: fogo 1.5s infinite
        }

        @keyframes fogo {
            0% {
                text-shadow: 0 0 5px #ff4500, 0 0 10px #ff4500
            }

            50% {
                text-shadow: 0 0 10px #ff4500, 0 0 15px #ffd700
            }

            100% {
                text-shadow: 0 0 5px #ff4500, 0 0 10px #ff4500
            }
        }

        .vida-magia-vigor {
            display: flex;
            justify-content: space-around;
            gap: 15px;
            flex-wrap: wrap
        }

        .atributo-container {
            background: rgba(255, 255, 255, 0.8);
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #b8860b;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            width: 100%; /* Full width on small screens */
            min-width: 200px;
            text-align: center;
            margin-bottom: 15px; /* Add margin for wrapped items */
        }

         @media (min-width: 992px) { /* Adjust width for larger screens */
            .atributo-container {
                width: 30%;
            }
        }


        body.dark-mode .atributo-container {
            background: rgba(50, 50, 50, 0.8)
        }

        .atributo-container h3 {
            font-family: 'MedievalSharp', serif; /* Use medieval font */
            font-size: 1.5rem;
            color: #a0522d; /* Match section title color */
            margin-bottom: 10px;
            display: flex; /* Align icon and text */
            align-items: center;
            justify-content: center;
        }

        body.dark-mode .atributo-container h3 {
            color: #b8860b; /* Dark mode title color */
        }


        .atributo-container::before {
             /* Removed emoji from ::before, will add in h3 */
            display: none;
        }


        .atributo-container.vida h3::before {
            content: "❤️";
             margin-right: 8px; /* Space between icon and text */
            font-size: 1.3rem; /* Adjust icon size */
        }


        .atributo-container.magia h3::before {
            content: "✨";
             margin-right: 8px;
             font-size: 1.3rem;
        }


        .atributo-container.vigor h3::before {
            content: "⚡";
            margin-right: 8px;
            font-size: 1.3rem;
        }


        .medieval-box {
            background: #f0e6d2;
            border: 2px solid #b8860b;
            border-radius: 8px;
            padding: 10px;
            margin: 10px 0; /* Increased margin */
            text-align: center
        }

        body.dark-mode .medieval-box {
            background: #1e1e1e;
            border-color: #444
        }

        .medieval-box span:first-child { /* Style the label part */
             font-weight: 600;
             color: #5c4033; /* Darker brown for label */
             margin-right: 5px;
        }

         body.dark-mode .medieval-box span:first-child {
             color: #ccc;
        }

         .medieval-box span#vida-total,
         .medieval-box span#magia-total,
         .medieval-box span#vigor-total { /* Style the total value */
             font-weight: bold;
             font-family: 'MedievalSharp', serif;
             font-size: 1.1rem;
        }

         .medieval-box span#vida-atual,
         .medieval-box span#magia-atual,
         .medieval-box span#vigor-atual { /* Style the current value */
             font-weight: bold;
             font-family: 'MedievalSharp', serif;
             font-size: 1.2rem; /* Make current value slightly larger */
             min-width: 40px; /* Ensure space */
             display: inline-block; /* Allow min-width */
             margin: 0 5px; /* Space around current value */
        }


        .regeneracao {
            font-size: 0.9rem; /* Slightly larger */
            color: #555;
            margin-top: 10px; /* Increased margin */
            font-style: italic; /* Italicize regeneration text */
        }


        body.dark-mode .regeneracao {
            color: #aaa
        }

        button {
            background: #b8860b;
            color: #fff;
            border: none;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 1.2rem;
            border-radius: 4px;
            margin: 0 5px;
            transition: background-color 0.3s ease
        }

        body.dark-mode button {
            background: #555
        }

        button:hover {
            background: #a0522d
        }

        body.dark-mode button:hover {
            background: #777
        }

        /* Specific styling for +/- buttons */
        .valor-atual button {
             font-size: 1rem; /* Smaller font size for +/- */
             padding: 3px 8px; /* Adjust padding */
             vertical-align: middle; /* Align with the number */
        }


        .botoes-container {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap; /* Allow buttons to wrap */
        }

        .botao {
            padding: 12px 25px;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            font-family: 'MedievalSharp', serif;
            color: #fff;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3)
        }

        body.dark-mode .botao {
            background: #555
        }

        body.dark-mode .botao:hover {
            background: #777
        }

        .botao-reset {
            background: #b8860b
        }

        .botao-reset:hover {
            background: #a0522d;
            transform: translateY(-2px)
        }

        .botao-recomecar {
            background: #a52a2a
        }

        .botao-recomecar:hover {
            background: #8b0000;
            transform: translateY(-2px)
        }

        .botao-bloquear,
        .botao-desbloquear {
            background: #4a4a4a
        }

        .botao-bloquear:hover,
        .botao-desbloquear:hover {
            background: #2a2a2a;
            transform: translateY(-2px)
        }

        .botao-excluir {
            background: #a52a2a;
             position: static; /* Remove absolute positioning */
             margin-top: 15px; /* Add space when wrapped */
            /* position: absolute;
            bottom: 20px;
            left: 20px */
        }

        .botao-excluir:hover {
            background: #8b0000;
            transform: translateY(-2px)
        }

        #nivel-container {
            text-align: center;
            margin-top: 20px; /* Increased margin */
            margin-bottom: 15px; /* Added bottom margin */
        }


        #nivel {
            padding: 10px;
            background: #f0e6d2;
            border: 3px solid #000;
            border-radius: 50%;
            width: 100px;
            height: 100px;
            display: inline-flex; /* Use inline-flex */
            align-items: center;
            justify-content: center;
            font-size: 3.125rem;
            box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.5);
             /* margin: 0 auto */ /* Removed auto margin */
             font-family: 'MedievalSharp', serif; /* Use medieval font */
             color: #a0522d; /* Match section title color */
             font-weight: bold;
        }


        body.dark-mode #nivel {
            background: #1e1e1e;
            border-color: #444;
            color: #b8860b; /* Dark mode level color */
        }

        #nivel.aura-azul {
            animation: pulsar-aura 2s 10
        }

        .expandable-textarea {
            height: 100px;
            width: 100%; /* Use full width */
            background: #fff;
            border: 2px solid #b8860b;
            border-radius: 6px;
            padding: 10px;
            font-size: 0.9rem;
            transition: height 0.3s ease;
            box-sizing: border-box; /* Include padding and border in width */
        }

        body.dark-mode .expandable-textarea {
            background: #333
        }

        .expandable-textarea:focus {
            height: 200px; /* Adjust focused height */
        }

        #dice-container {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 150px; /* Adjusted width */
            text-align: center;
            font-family: 'MedievalSharp', serif;
            cursor: move;
            z-index: 10;
            user-select: none;
            background: rgba(240, 230, 210, 0.8); /* Add slight background */
            border: 1px solid #b8860b;
            border-radius: 8px;
            padding: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        body.dark-mode #dice-container {
            background: rgba(30, 30, 30, 0.8);
            border-color: #444;
        }

        #dice-container label {
            font-size: 1.1rem; /* Adjusted size */
            color: #000;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 5px; /* Reduced margin */
        }

        body.dark-mode #dice-container label {
            color: #e0e0e0
        }

        #dice-container label::before {
            content: "🎲";
            margin-right: 5px;
            font-size: 1.3rem; /* Adjusted size */
        }

        #dice-roll {
            width: 80px; /* Adjusted size */
            height: 80px; /* Adjusted size */
            background: #f0e6d2;
            border: 2px solid #b8860b;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            cursor: pointer;
            margin: 0 auto;
            position: relative;
            transition: all 0.3s ease
        }

        body.dark-mode #dice-roll {
            background: #1e1e1e;
            border-color: #444
        }

        #dice-roll::before {
            /* content: "⚅"; */ /* Removed default die face */
            content: ""; /* Clear default */
            font-size: 1.5rem;
            position: absolute;
            top: 5px;
            right: 5px;
            color: #a0522d
        }

        #dice-result {
            margin-top: 8px; /* Reduced margin */
            font-size: 0.9rem; /* Adjusted size */
            color: #000;
            display: none;
            animation: blink 1s infinite
        }

        body.dark-mode #dice-result {
            color: #e0e0e0
        }

        @keyframes blink {
            50% {
                opacity: 0
            }
        }

        #dice-roll.critical-failure {
            animation: aura-vermelha 2s infinite
        }

        #dice-roll.critical-success {
            animation: aura-verde 2s infinite
        }

        @keyframes aura-vermelha {
            0% {
                box-shadow: 0 0 5px #ff0000, 0 0 10px #ff0000
            }

            50% {
                box-shadow: 0 0 15px #ff0000, 0 0 20px #ff0000
            }

            100% {
                box-shadow: 0 0 5px #ff0000, 0 0 10px #ff0000
            }
        }

        @keyframes aura-verde {
            0% {
                box-shadow: 0 0 5px #00ff00, 0 0 10px #00ff00
            }

            50% {
                box-shadow: 0 0 15px #00ff00, 0 0 20px #00ff00
            }

            100% {
                box-shadow: 0 0 5px #00ff00, 0 0 10px #00ff00
            }
        }

        #notification {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 20px;
            border-radius: 8px;
            font-family: 'MedievalSharp', serif;
            font-size: 1.5rem;
            color: #fff;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
            display: none;
            z-index: 2000; /* Ensure notification is on top */
            background: rgba(0, 0, 0, 0.7);
            transition: opacity 0.3s ease;
            text-align: center;
        }


        #notification.critical-failure {
            background: rgba(255, 0, 0, 0.8);
            animation: aura-vermelha 2s infinite
        }

        #notification.critical-success {
            background: rgba(0, 255, 0, 0.8);
            animation: aura-verde 2s infinite
        }

        #notification.normal-result,
        #notification.save-success {
             /* animation: blink 1s infinite; */ /* Removed blinking for normal/save */
             opacity: 1; /* Ensure visible */
        }

        #notification.save-success {
            background: rgba(0, 180, 0, 0.8); /* Slightly darker green */
        }

        #character-image-container {
            position: absolute;
            top: 10px;
            left: 10px;
            width: 100px;
            height: 100px;
            background: #f0e6d2;
            border: 2px solid #b8860b;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            overflow: hidden;
            z-index: 10
        }

        body.dark-mode #character-image-container {
            background: #1e1e1e;
            border-color: #444;
        }

        #character-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: none
        }

         /* Placeholder style when no image */
        #character-image-container:not(:has(img[style*="display: block"]))::before {
            content: "🖼️"; /* Placeholder icon */
            font-size: 3rem;
            color: #a0522d;
        }

        body.dark-mode #character-image-container:not(:has(img[style*="display: block"]))::before {
            color: #b8860b;
        }


        #character-image-container:hover {
            box-shadow: 0 0 10px #ffd700
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6); /* Slightly darker overlay */
            justify-content: center;
            align-items: center;
            z-index: 1500; /* Ensure modals are above most content */
        }

        .modal-content {
            background: #f0e6d2;
            padding: 25px; /* Increased padding */
            border-radius: 8px;
            border: 2px solid #b8860b;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            width: 90%; /* Responsive width */
             max-width: 400px; /* Max width for larger screens */
            text-align: center;
             position: relative; /* For potential absolute elements inside */
        }


        body.dark-mode .modal-content {
            background: #1e1e1e;
            border-color: #444
        }

        .modal-content h3 {
            font-family: 'MedievalSharp', serif;
            color: #a0522d; /* Match section titles */
            margin-bottom: 20px; /* Increased margin */
            font-size: 1.5rem; /* Title size */
        }


        body.dark-mode .modal-content h3 {
            color: #b8860b; /* Dark mode modal title */
        }

        .modal-content input,
        .modal-content textarea /* Apply styles to textarea in modals too */
         {
            width: calc(100% - 22px); /* Adjusted width for border */
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #ccc;
            border-radius: 6px;
            box-sizing: border-box; /* Include padding/border in width */
             background: #fff; /* Ensure background */
             color: #000; /* Ensure text color */
        }

        body.dark-mode .modal-content input,
        body.dark-mode .modal-content textarea {
            background: #333;
            color: #e0e0e0;
            border-color: #555
        }

        .modal-content button {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-family: 'MedievalSharp', serif;
            color: #fff;
            cursor: pointer;
            margin: 5px; /* Spacing between buttons */
             transition: background-color 0.3s ease, transform 0.2s ease; /* Add transitions */
        }

         .modal-content button:hover {
             transform: translateY(-2px); /* Add hover effect */
        }

        .modal-content .confirm-btn {
            background: #b8860b
        }

        .modal-content .confirm-btn:hover {
            background: #a0522d
        }

        .modal-content .cancel-btn {
            background: #a52a2a
        }

        .modal-content .cancel-btn:hover {
            background: #8b0000
        }

        #vantagens-desvantagens-btn,
        #racas-btn,
        #classes-btn {
            padding: 10px 20px;
            background: #f0e6d2;
            border: 2px solid #b8860b;
            border-radius: 6px;
            font-family: 'MedievalSharp', serif;
            font-size: 1rem;
            color: #000;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease; /* Added transform */
            z-index: 10;
            margin: 5px; /* Add margin for wrapping */
        }


        body.dark-mode #vantagens-desvantagens-btn,
        body.dark-mode #racas-btn,
        body.dark-mode #classes-btn {
            background: #1e1e1e;
            color: #e0e0e0;
            border-color: #444; /* Dark mode border */
        }


        #vantagens-desvantagens-btn:hover,
        #racas-btn:hover,
        #classes-btn:hover {
            background: #a0522d;
            color: #fff;
            transform: translateY(-2px); /* Add hover effect */
        }


        #vantagens-desvantagens-panel,
        #racas-panel,
        #classes-panel {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(240, 230, 210, 0.98); /* Slightly less transparent */
            padding: 20px;
            overflow-y: auto;
            z-index: 1400; /* Below modals but above ficha */
            border: 2px solid #b8860b;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.3);
             box-sizing: border-box; /* Include padding in dimensions */
        }


        body.dark-mode #vantagens-desvantagens-panel,
        body.dark-mode #racas-panel,
        body.dark-mode #classes-panel {
            background: rgba(30, 30, 30, 0.98)
        }

        #vantagens-desvantagens-panel h2,
        #racas-panel h2,
        #classes-panel h2 {
            font-family: 'MedievalSharp', serif;
            font-size: 2rem;
            text-align: center;
            color: #a0522d;
            margin-bottom: 20px
        }

         body.dark-mode #vantagens-desvantagens-panel h2,
         body.dark-mode #racas-panel h2,
         body.dark-mode #classes-panel h2 {
             color: #b8860b;
         }

        #racas-panel h2 {
            font-size: 3rem
        }

        /* Style for PH Temp display */
        #vantagens-desvantagens-panel > div:first-of-type {
            text-align: center;
            font-size: 1.2rem;
            margin-bottom: 15px;
            font-weight: bold;
            font-family: 'MedievalSharp', serif;
        }


        .vantagem-item,
        .desvantagem-item,
        .raca-item {
            padding: 15px; /* Increased padding */
            margin: 10px 0; /* Increased margin */
            background: #fff;
            border: 1px solid #ccc;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.3s ease, border-color 0.3s ease; /* Added border transition */
             border-left: 5px solid transparent; /* Add left border for visual cues */
        }


        body.dark-mode .vantagem-item,
        body.dark-mode .desvantagem-item,
        body.dark-mode .raca-item {
            background: #333;
            border-color: #555
        }

        .vantagem-item:hover,
        .desvantagem-item:hover,
        .raca-item:hover {
            background: #f0f0f0; /* Lighter hover */
            border-color: #b8860b; /* Highlight border on hover */
        }

        body.dark-mode .vantagem-item:hover,
        body.dark-mode .desvantagem-item:hover,
        body.dark-mode .raca-item:hover {
            background: #444
        }

        .vantagem-item.comprada,
        .raca-item.comprada {
            background: #d4edda; /* Greenish background for selected advantage/race */
            color: #155724; /* Dark green text */
            cursor: default;
            border-left-color: #28a745; /* Green left border */
            border-color: #c3e6cb;
        }

        .desvantagem-item.comprada {
            background: #f8d7da; /* Reddish background for selected disadvantage */
            color: #721c24; /* Dark red text */
            cursor: default;
            border-left-color: #dc3545; /* Red left border */
             border-color: #f5c6cb;
        }

        body.dark-mode .vantagem-item.comprada,
        body.dark-mode .raca-item.comprada {
             background: #1c3a1f;
             color: #c3e6cb;
             border-left-color: #28a745;
             border-color: #2b6a3e;
        }
        body.dark-mode .desvantagem-item.comprada {
             background: #3a1c1e;
             color: #f5c6cb;
             border-left-color: #dc3545;
             border-color: #803139;
        }


        #salvar-vantagens-btn,
        #salvar-racas-btn,
        #fechar-pagina-btn,
        #fechar-racas-btn,
        #fechar-classes-btn {
            position: fixed;
            bottom: 20px;
            padding: 12px 25px;
            background: #a52a2a;
            color: #fff;
            border: none;
            border-radius: 6px;
            font-family: 'MedievalSharp', serif;
            font-size: 1.2rem;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.3s ease; /* Added box-shadow transition */
        }


        #salvar-vantagens-btn,
        #salvar-racas-btn {
            left: 20px; /* Position Save button on the left */
             /* right: 250px; */
            animation: aura-verde-btn 2s infinite;
            display: none; /* Hidden initially */
            background: #28a745; /* Green color for save */
        }

        #salvar-vantagens-btn:hover,
        #salvar-racas-btn:hover {
             background: #218838; /* Darker green on hover */
             transform: translateY(-2px); /* Keep hover effect */
        }


        #fechar-pagina-btn,
        #fechar-racas-btn,
        #fechar-classes-btn {
            right: 20px;
            background: #6c757d; /* Grey color for close */
        }

         #fechar-pagina-btn:hover,
         #fechar-racas-btn:hover,
         #fechar-classes-btn:hover {
             background: #5a6268; /* Darker grey on hover */
             transform: translateY(-2px); /* Keep hover effect */
         }

        @keyframes aura-verde-btn {
            0% {
                box-shadow: 0 0 5px #00ff00, 0 0 10px #00ff00
            }

            50% {
                box-shadow: 0 0 15px #00ff00, 0 0 20px #00ff00
            }

            100% {
                box-shadow: 0 0 5px #00ff00, 0 0 10px #00ff00
            }
        }

        .locomotion-container {
            background: #8B4513;
            border: 3px solid #FFD700;
            border-radius: 10px;
            padding: 15px;
            color: #FFD700;
            font-family: 'MedievalSharp', serif
        }

        .locomotion-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px
        }

         .locomotion-item:last-child {
            margin-bottom: 0; /* Remove margin for last item */
        }

        .locomotion-item label {
            font-weight: bold;
            color: #FFD700;
             margin-right: 5px; /* Add space */
        }

        .locomotion-item span:nth-of-type(1) { /* Style the emoji */
             font-size: 1.3rem;
             margin-right: 8px;
        }

        .locomotion-item span[readonly] { /* Style the value span */
            font-size: 1.2rem;
            color: #FFF;
            text-shadow: 1px 1px 2px #000;
            /* margin-left: 5px; */ /* Removed margin, handled by label/emoji */
            font-weight: bold;
            background: transparent !important; /* Override readonly styles */
            border: none !important; /* Override readonly styles */
            padding: 0 !important; /* Override readonly styles */
            text-align: left !important; /* Override readonly styles */
             cursor: default !important; /* Override readonly styles */
        }


        #distancia-pulo,
        #altura-pulo,
        #velocidade-corrida {
            /* background-color: #8B4513; */ /* No need to set bg color here */
            /* border-color: #8B4513 */ /* No need to set border color here */
        }

        .list-display {
            background: #fff;
            border: 2px solid #b8860b;
            border-radius: 6px;
            padding: 10px;
            min-height: 100px;
            max-height: 150px; /* Adjusted max height */
            overflow-y: auto;
            margin-bottom: 15px; /* Add margin below lists */
        }


        body.dark-mode .list-display {
            background: #333;
            border-color: #555
        }

        .list-item {
            cursor: pointer;
            margin-bottom: 5px;
            padding: 5px;
            border-bottom: 1px solid #eee; /* Lighter separator */
             transition: background-color 0.2s ease; /* Add transition */
        }
        .list-item:last-child {
            border-bottom: none; /* Remove border for last item */
        }


        body.dark-mode .list-item {
            border-color: #444; /* Dark mode separator */
        }

        .list-item:hover {
            background: #e9ecef; /* Subtle hover */
        }

        body.dark-mode .list-item:hover {
            background: #495057; /* Dark mode hover */
        }

        .inventory-slot {
            display: flex;
            align-items: center;
            margin-bottom: 8px; /* Reduced margin */
        }

        .inventory-slot input[type="text"] {
            flex-grow: 1;
            margin-right: 10px;
            margin-bottom: 0; /* Remove default input margin */
        }

        .inventory-slot input[type="number"] {
            width: 70px; /* Slightly wider */
             text-align: right;
             margin-bottom: 0; /* Remove default input margin */
        }
         /* Add kg label */
        .inventory-slot::after {
            content: "kg";
            margin-left: 5px;
            font-size: 0.9em;
            color: #555;
        }
        body.dark-mode .inventory-slot::after {
            color: #aaa;
        }


        #anotacoes-btn {
            position: fixed;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            padding: 10px 20px;
            background: #f0e6d2;
            border: 2px solid #b8860b;
            border-radius: 6px;
            font-family: 'MedievalSharp', serif;
            font-size: 1rem;
            color: #000;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease; /* Added transform */
            z-index: 1000; /* Garante que o botão fique acima da ficha */
            writing-mode: vertical-rl; /* Vertical text */
             text-orientation: mixed;
             height: 120px; /* Adjust height for vertical button */
             width: auto; /* Adjust width */
        }


        body.dark-mode #anotacoes-btn {
            background: #1e1e1e;
            color: #e0e0e0;
            border-color: #444;
        }

        #anotacoes-btn:hover {
            background: #a0522d;
            color: #fff;
             transform: translateY(-50%) translateX(-3px); /* Adjust hover transform */
        }


        #anotacoes-textarea {
            display: none;
            position: fixed;
            left: 60px; /* Adjust based on button width */
            top: 50%;
            transform: translateY(-50%);
            width: 350px; /* Adjusted width */
            height: 400px;
            background: #fff;
            border: 2px solid #b8860b;
            border-radius: 6px;
            padding: 10px;
            font-size: 0.9rem;
            resize: none;
            z-index: 1001; /* Garante que a caixa de anotações fique acima de tudo */
            box-shadow: 5px 5px 15px rgba(0,0,0,0.3); /* Add shadow */
        }


        body.dark-mode #anotacoes-textarea {
            background: #333;
            color: #e0e0e0;
            border-color: #555;
        }

        #historico-dados-btn {
            position: fixed;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            padding: 10px 20px;
            background: #f0e6d2;
            border: 2px solid #b8860b;
            border-radius: 6px;
            font-family: 'MedievalSharp', serif;
            font-size: 1rem;
            color: #000;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease; /* Added transform */
             writing-mode: vertical-rl; /* Vertical text */
             text-orientation: mixed;
             height: 180px; /* Adjust height */
             width: auto; /* Adjust width */
             z-index: 1000; /* Ensure visibility */
        }


        body.dark-mode #historico-dados-btn {
            background: #1e1e1e;
            color: #e0e0e0;
            border-color: #444;
        }

        #historico-dados-btn:hover {
            background: #a0522d;
            color: #fff;
            transform: translateY(-50%) translateX(3px); /* Adjust hover transform */
        }


        #historico-dados-panel {
            display: none;
            position: fixed;
            right: 60px; /* Adjust based on button width */
            top: 50%;
            transform: translateY(-50%);
            width: 300px;
            background: #fff;
            border: 2px solid #b8860b;
            border-radius: 6px;
            padding: 10px;
            max-height: 400px;
            overflow-y: auto;
            z-index: 1001; /* Above ficha, below annotations maybe? */
            box-shadow: -5px 5px 15px rgba(0,0,0,0.3); /* Add shadow */
        }


        body.dark-mode #historico-dados-panel {
            background: #333;
            border-color: #555
        }

        #historico-dados-panel h3 {
            font-family: 'MedievalSharp', serif;
            color: #a0522d; /* Match theme */
            margin-bottom: 10px;
            text-align: center;
            font-size: 1.3rem;
        }


        body.dark-mode #historico-dados-panel h3 {
            color: #b8860b; /* Dark mode title */
        }

        #historico-lista div {
            padding: 5px;
            border-bottom: 1px solid #eee; /* Lighter separator */
             font-size: 0.9rem; /* Adjust font size */
        }
         #historico-lista div:last-child {
             border-bottom: none;
         }


        body.dark-mode #historico-lista div {
            border-color: #444; /* Dark mode separator */
        }

        #excluir-historico-btn {
            background: #a52a2a;
            color: #fff;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            margin-top: 10px;
            display: block; /* Make it block */
            width: 100%; /* Full width */
            font-family: 'MedievalSharp', serif; /* Match button style */
             transition: background-color 0.3s ease;
        }


        #excluir-historico-btn:hover {
            background: #8b0000
        }

        .magias-container {
            max-height: 250px; /* Adjusted max height */
            overflow-y: auto;
            border: 2px solid #b8860b;
            border-radius: 6px;
            padding: 10px;
            background: #fff;
            margin-bottom: 10px; /* Add margin below */
        }


        body.dark-mode .magias-container {
            background: #333;
            border-color: #555
        }

        .magias-container input {
            margin-bottom: 10px;
             width: 100%; /* Ensure full width */
             box-sizing: border-box; /* Include padding/border */
        }
         .magias-container input:last-child {
             margin-bottom: 0;
         }


        #adicionar-magia-btn {
            background: #b8860b;
            color: #fff;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            display: block;
            /* margin-top: 10px; */ /* Removed margin top, handled by container margin */
             width: 100%; /* Full width */
             font-family: 'MedievalSharp', serif; /* Match button style */
             transition: background-color 0.3s ease;
        }


        #adicionar-magia-btn:hover {
            background: #a0522d
        }

        .classe-raca-container {
            background: #f0e6d2;
            border: 2px solid #b8860b;
            padding: 15px; /* Increased padding */
            border-radius: 8px; /* Match section style */
            margin-top: 20px; /* Increased margin */
        }


        body.dark-mode .classe-raca-container {
            background: #1e1e1e;
            border-color: #444
        }

        .classe-raca-container label {
            font-family: 'MedievalSharp', serif;
            color: #a0522d;
            font-size: 1.3rem; /* Larger label */
             margin-bottom: 8px; /* Add margin below label */
        }
         body.dark-mode .classe-raca-container label {
             color: #b8860b;
         }

        .classe-raca-container input[type="text"], /* Style the class input */
        .classe-raca-container span[onclick] { /* Style the race span */
            background: #fff;
            border: 2px solid #b8860b;
            padding: 10px;
            cursor: pointer;
            display: block;
             border-radius: 6px; /* Add border radius */
             margin-bottom: 15px; /* Add margin below */
             width: 100%; /* Ensure full width */
             box-sizing: border-box; /* Include padding/border */
             min-height: 40px; /* Ensure minimum height for span */
             line-height: 20px; /* Adjust line height for span */
        }


        body.dark-mode .classe-raca-container input[type="text"],
        body.dark-mode .classe-raca-container span[onclick] {
            background: #333;
            color: #e0e0e0;
             border-color: #555; /* Dark mode border */
        }


        .classe-raca-container textarea {
            width: 100%;
            background: #fff;
            border: 2px solid #b8860b;
             margin-bottom: 15px; /* Add margin below textareas */
             min-height: 80px; /* Ensure minimum height */
        }


        body.dark-mode .classe-raca-container textarea {
            background: #333;
            color: #e0e0e0;
             border-color: #555; /* Dark mode border */
        }


        .raca-item { /* Styles moved to panel specific section */
             /* Styles defined under #racas-panel section below */
        }

        .raca-item h3 {
             /* Styles defined under #racas-panel section below */
        }

        .raca-item p {
            /* Styles defined under #racas-panel section below */
        }

         /* Styles specific to #racas-panel items */
        #racas-panel .raca-item {
            margin-bottom: 20px;
            padding: 15px;
            background: #fff;
            border: 2px solid #b8860b;
            border-radius: 6px;
            border-left-width: 5px; /* Keep consistent with V/D panel */
        }
        #racas-panel .raca-item h3 {
            font-family: 'MedievalSharp', serif;
            font-size: 1.5rem;
            color: #a0522d;
            margin-bottom: 5px;
        }
        #racas-panel .raca-item p {
            font-size: 1rem;
            color: #000;
            margin-bottom: 8px;
        }
        #racas-panel .raca-item ul {
            list-style: disc;
            margin-left: 20px;
        }
        #racas-panel .raca-item li {
             font-size: 0.9rem;
             color: #333;
             margin-bottom: 4px;
        }

         body.dark-mode #racas-panel .raca-item {
            background: #333;
            border-color: #555;
        }
         body.dark-mode #racas-panel .raca-item h3 {
            color: #b8860b;
        }
        body.dark-mode #racas-panel .raca-item p {
            color: #e0e0e0;
        }
        body.dark-mode #racas-panel .raca-item li {
             color: #ccc;
        }


        @media (max-width: 768px) {
            body {
                padding: 10px;
                padding-top: 70px; /* Add padding top for fixed sidebar */
            }

            #ficha-container {
                padding: 15px;
                 margin-top: 20px; /* Reduce top margin */
                 width: 100%; /* Ensure full width */
                 max-width: none; /* Remove max width */
                 box-sizing: border-box;
            }

            h1#nome-personagem-titulo {
                font-size: 2rem
            }

            section h2 {
                font-size: 1.5rem; /* Adjusted size */
            }

            input,
            textarea {
                font-size: 0.9rem
            }

            /* Keep attributes side-by-side if possible, but allow wrapping */
            /* .atributos-container { flex-direction: column; } */
            /* .atributos-coluna, .atributos-coluna-destaque { width: 100%; } */

             /* Force resources (vida/magia/vigor) to stack */
             .vida-magia-vigor { flex-direction: column; align-items: center; }
             .atributo-container { width: 90%; max-width: 300px; }

              /* Adjust button container */
            .botoes-container {
                gap: 5px;
            }
            .botao {
                padding: 10px 15px;
                font-size: 0.9rem;
            }
            /* Stack panel buttons */
            #ficha-content > div:nth-last-of-type(3) { /* Target the div holding V/D, Race, Class buttons */
                flex-direction: column;
                align-items: center;
            }
             #vantagens-desvantagens-btn,
             #racas-btn,
             #classes-btn {
                 width: 80%;
                 max-width: 250px;
                 text-align: center;
             }

             /* Adjust Dice container */
            #dice-container {
                 position: static; /* Make it part of the flow */
                 width: 90%;
                 margin: 15px auto;
                 cursor: default; /* No dragging */
            }
             #dice-container label { font-size: 1rem; }
             #dice-roll { width: 60px; height: 60px; font-size: 1.5rem; }

             /* Adjust Character Image */
             #character-image-container {
                 position: static; /* Make it part of the flow */
                 width: 80px;
                 height: 80px;
                 margin: 0 auto 15px auto; /* Center it */
             }
              #character-image-container:not(:has(img[style*="display: block"]))::before { font-size: 2rem; }

              /* Adjust side buttons */
              #chat-btn-container, #anotacoes-btn, #historico-dados-btn {
                 position: static;
                 transform: none;
                 writing-mode: horizontal-tb;
                 width: auto;
                 height: auto;
                 margin: 10px auto;
                 display: block;
                 text-align: center;
              }
               #chat-btn-container { order: 1; } /* Position Chat Button */
               #anotacoes-btn { order: 2; } /* Position Annotations Button */
               #historico-dados-btn { order: 3; } /* Position History Button */

               /* Adjust panels for side buttons */
               #anotacoes-textarea, #historico-dados-panel {
                   position: fixed; /* Keep fixed */
                   left: 50%;
                   top: 50%;
                   transform: translate(-50%, -50%);
                   width: 90%;
                   max-width: 350px;
                   box-shadow: 0 0 15px rgba(0,0,0,0.4);
               }

                 /* Inventory/Skills stacking */
               #inventario-habilidades .flex {
                   flex-direction: column;
                   gap: 10px;
               }
               #inventario-habilidades > div > div { /* Target the containers */
                   width: 100% !important; /* Force full width */
               }

               /* Combat armamento stacking */
                .armamento-container {
                    display: flex;
                    flex-direction: column;
                    gap: 15px;
                }
                .armamento-coluna { width: 100%; }
                .armamento-coluna .flex { flex-wrap: wrap; } /* Allow weapon inputs to wrap */
                .armamento-coluna .flex input[type="number"] { width: 60px; margin-right: 5px; }
                .armamento-coluna .flex span { margin-right: 5px; }
        }


        /* Estilos para o modal de chat */
        #chat-modal {
            /* display: none; */ /* Handled by JS */
        }

        #chat-modal .modal-content {
            width: 95%; /* Responsive */
             max-width: 600px; /* Max width */
            height: 85vh; /* Responsive height */
             max-height: 700px; /* Max height */
            display: flex;
            flex-direction: column;
             padding: 0; /* Remove default padding, handle internally */
        }


        #chat-modal .chat-header {
            padding: 10px 15px; /* Adjust padding */
            border-bottom: 1px solid #ccc;
            font-family: 'MedievalSharp', serif;
            font-size: 1.5rem;
            text-align: center;
             background: #e0cda9; /* Header background */
             border-radius: 8px 8px 0 0; /* Round top corners */
             flex-shrink: 0; /* Prevent shrinking */
        }
         body.dark-mode #chat-modal .chat-header {
             background: #2a2a2a;
             border-color: #444;
             color: #ccc;
         }


        #chat-modal .chat-body {
            flex-grow: 1;
            display: flex;
            overflow: hidden; /* Prevent overflow */
             background: #fff; /* Chat body background */
        }
         body.dark-mode #chat-modal .chat-body {
             background: #333;
         }


        #chat-modal .user-list {
            width: 150px;
            border-right: 1px solid #ccc;
            overflow-y: auto;
            padding: 10px;
             background: #f8f9fa; /* User list background */
             flex-shrink: 0; /* Prevent shrinking */
        }
         body.dark-mode #chat-modal .user-list {
             background: #2a2a2a;
             border-color: #444;
         }


        #chat-modal .user-list h4 {
            font-family: 'MedievalSharp', serif;
            margin-bottom: 10px; /* Increased margin */
             font-size: 1.1rem; /* Adjust size */
             color: #555;
             text-align: center;
        }
         body.dark-mode #chat-modal .user-list h4 {
             color: #aaa;
         }

        #chat-modal .user-list .user-item {
            padding: 8px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
             font-size: 0.9rem; /* Adjust size */
             transition: background-color 0.2s ease;
             border-radius: 4px; /* Add radius */
             margin-bottom: 3px; /* Add margin */
        }
         #chat-modal .user-list .user-item:last-child {
             border-bottom: none;
         }


        #chat-modal .user-list .user-item:hover {
            background-color: #e9ecef; /* Subtle hover */
        }
         #chat-modal .user-list .user-item.active { /* Style for selected user */
             background-color: #cce5ff;
             font-weight: bold;
         }


        body.dark-mode #chat-modal .user-list .user-item:hover {
            background-color: #3f3f3f; /* Dark mode hover */
        }
         body.dark-mode #chat-modal .user-list .user-item.active {
             background-color: #4a6a8a; /* Dark mode active */
         }


        #chat-modal .conversation {
            flex-grow: 1;
            padding: 10px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
             /* Removed background, handled by chat-body */
        }

        #chat-modal .conversation h3 { /* Style for "Conversa com..." */
             text-align: center;
             font-family: 'MedievalSharp', serif;
             color: #777;
             font-size: 1rem;
             margin-bottom: 10px;
        }
        body.dark-mode #chat-modal .conversation h3 {
             color: #aaa;
        }

        #chat-modal #mensagens { /* Container for actual messages */
             flex-grow: 1; /* Allow it to take space */
             display: flex;
             flex-direction: column;
             gap: 10px; /* Space between messages */
        }


        #chat-modal .message-container {
            display: flex;
            flex-direction: column;
            /* margin-bottom: 8px; */ /* Use gap in #mensagens instead */
             max-width: 80%; /* Max width for message bubble */
        }

        #chat-modal .message-container.sent {
             align-self: flex-end; /* Align sent messages to the right */
        }
        #chat-modal .message-container.received {
             align-self: flex-start; /* Align received messages to the left */
        }


        #chat-modal .message {
            padding: 8px 12px; /* Adjust padding */
            border-radius: 15px; /* More rounded bubbles */
            background-color: #e9ecef; /* Default received bubble color */
            color: #000;
            width: fit-content; /* Bubble fits content */
            /* max-width: 80%; */ /* Moved to container */
             line-height: 1.4; /* Improve readability */
        }


        body.dark-mode #chat-modal .message {
            background-color: #444;
            color: #e0e0e0;
        }

        #chat-modal .message-container.sent .message {
            background-color: #cce5ff; /* Sent bubble color */
             border-bottom-right-radius: 5px; /* Sent bubble shape */
        }


        body.dark-mode #chat-modal .message-container.sent .message {
            background-color: #3a5f8a; /* Dark mode sent bubble */
            color: #e0e0e0;
        }
         body.dark-mode #chat-modal .message-container.received .message {
            border-bottom-left-radius: 5px; /* Received bubble shape */
         }

        #chat-modal .sender-name {
            font-size: 0.8rem;
            color: #777;
            margin-bottom: 2px;
             margin-left: 5px; /* Indent sender name slightly */
        }

         #chat-modal .message-container.sent .sender-name {
             text-align: right; /* Align sender name for sent messages */
             margin-right: 5px;
             margin-left: 0;
         }

        body.dark-mode #chat-modal .sender-name {
            color: #aaa;
        }

        #chat-modal .chat-input {
            padding: 10px;
            border-top: 1px solid #ccc;
            display: flex;
             background: #f8f9fa; /* Input area background */
             border-radius: 0 0 8px 8px; /* Round bottom corners */
             flex-shrink: 0; /* Prevent shrinking */
        }
         body.dark-mode #chat-modal .chat-input {
             background: #2a2a2a;
             border-color: #444;
         }

        #chat-modal .chat-input input[type="text"] {
            flex-grow: 1;
            padding: 8px 12px;
            border-radius: 20px; /* Rounded input field */
            border: 1px solid #ccc;
            margin-right: 10px;
             background: #fff; /* Ensure background */
        }


        body.dark-mode #chat-modal .chat-input input[type="text"] {
            background-color: #333;
            color: #e0e0e0;
            border-color: #555;
        }

        #chat-modal .chat-input button { /* Send button */
            padding: 8px 15px;
            border-radius: 20px; /* Match input radius */
             background: #b8860b; /* Match theme */
             color: #fff;
        }
         #chat-modal .chat-input button:hover {
             background: #a0522d;
         }

         /* Close chat button styling within modal */
         #chat-modal > .cancel-btn {
             position: absolute;
             top: 8px;
             right: 10px;
             background: transparent;
             color: #555;
             font-size: 1.5rem;
             padding: 0;
             margin: 0;
             border: none;
             font-family: sans-serif; /* Use a standard font for 'X' */
             line-height: 1;
         }
          #chat-modal > .cancel-btn:hover {
             color: #000;
             transform: none; /* Remove button hover effect */
         }
          body.dark-mode #chat-modal > .cancel-btn {
             color: #aaa;
          }
           body.dark-mode #chat-modal > .cancel-btn:hover {
              color: #fff;
          }


        /* Estilos para os modais de senha do chat */
        #chat-password-modal .modal-content,
        #open-chat-modal .modal-content {
            width: 90%; /* Responsive */
             max-width: 350px; /* Max width */
        }


        /* Espaçamento dos botões de raça (Modal) */
        #raca-opcoes-modal .modal-content button {
             display: block; /* Stack buttons */
             width: 80%; /* Adjust width */
             margin: 10px auto; /* Center and space buttons */
        }
        /* #raca-opcoes-modal .modal-content button:nth-child(2) {
            margin-top: 10px;
        } */

        /* Estilos para o modal de plano de fundo */
        #background-modal {
            /* display: none; */ /* Handled by JS */
        }

        #background-modal .modal-content {
            width: 90%; /* Responsive */
             max-width: 400px; /* Max width */
            text-align: left;
        }

        #background-modal .modal-content label {
            display: block;
            margin-bottom: 5px;
             font-weight: 600; /* Make labels bold */
        }
         body.dark-mode #background-modal .modal-content label {
             color: #ccc; /* Dark mode label */
         }

        #background-modal .modal-content input[type="file"] {
            margin-bottom: 15px; /* Increased margin */
             display: block; /* Ensure block display */
             width: 100%; /* Full width */
             color: #555; /* Style file input text */
        }
         body.dark-mode #background-modal .modal-content input[type="file"] {
             color: #aaa;
         }
         /* Basic styling for file input button */
         #background-modal .modal-content input[type="file"]::file-selector-button {
            padding: 8px 12px;
            border-radius: 4px;
            border: 1px solid #b8860b;
            background: #f0e6d2;
            cursor: pointer;
            font-family: 'Inter', sans-serif;
            margin-right: 10px;
            transition: background-color 0.2s ease;
         }
          #background-modal .modal-content input[type="file"]::file-selector-button:hover {
             background-color: #e0cda9;
          }
          body.dark-mode #background-modal .modal-content input[type="file"]::file-selector-button {
             background: #333;
             border-color: #555;
             color: #e0e0e0;
          }
           body.dark-mode #background-modal .modal-content input[type="file"]::file-selector-button:hover {
             background-color: #444;
           }

        #background-modal .modal-content .radio-group {
            margin-bottom: 15px;
             border: 1px solid #ccc; /* Add border around group */
             padding: 10px;
             border-radius: 6px;
        }
         body.dark-mode #background-modal .modal-content .radio-group {
             border-color: #555;
         }

        #background-modal .modal-content .radio-group label {
            display: inline-block;
            margin-right: 15px; /* Increased spacing */
             cursor: pointer;
             font-weight: normal; /* Normal weight for radio labels */
        }
         #background-modal .modal-content .radio-group input[type="radio"] {
             margin-right: 5px;
             vertical-align: middle; /* Align radio button */
         }

         /* Button container for background modal */
         #background-modal .modal-content .button-container {
             display: flex;
             justify-content: space-between; /* Space out buttons */
             margin-top: 15px;
             gap: 10px; /* Add gap */
         }
         #background-modal .modal-content .button-container button {
             flex-grow: 1; /* Allow buttons to grow */
             margin: 0; /* Remove default margins */
         }
         #background-modal .modal-content .button-container .confirm-btn {
             background: #28a745; /* Green save */
         }
          #background-modal .modal-content .button-container .confirm-btn:hover {
             background: #218838;
         }
         #background-modal .modal-content .button-container .cancel-btn { /* Style both cancel buttons */
             background: #dc3545; /* Red for delete/cancel */
         }
          #background-modal .modal-content .button-container .cancel-btn:hover {
             background: #c82333;
         }
          #background-modal .modal-content .button-container button:nth-of-type(2) { /* Middle button (Cancel) */
             background: #6c757d; /* Grey for cancel */
         }
           #background-modal .modal-content .button-container button:nth-of-type(2):hover {
             background: #5a6268;
         }
    </style>
</head>

<body>
    <div id="chat-btn-container">
        <!-- data-unread attribute will be updated by JS -->
        <button id="chat-btn" data-unread="0">💬 Chat</button>
    </div>

    <div id="fichas-sidebar">
        <!-- Ficha tabs will be added here by JS -->
        <div id="add-ficha-btn"><span>+ Fichas</span></div>
    </div>

    <div id="ficha-container">
        <div id="character-image-container" onclick="document.getElementById('character-image-input').click()">
            <img id="character-image" alt="Imagem do Personagem">
            <input type="file" id="character-image-input" accept="image/*" style="display:none">
        </div>

        <div id="dice-container">
            <label>Role seu dado:</label>
            <div id="dice-roll">-</div>
            <div id="dice-result"></div>
        </div>

        <h1 id="nome-personagem-titulo">Ficha de Personagem</h1>
        <div id="game-master-message">Você virou o Game Master</div>

        <div id="ficha-content">
            <section id="informacoes-basicas">
                <h2>Informações Básicas</h2>
                <label for="nome-personagem">Nome do Personagem:</label>
                <input type="text" id="nome-personagem" placeholder="Digite o nome do seu personagem">

                <label for="descricao-personagem">Descrição do Personagem:</label>
                <textarea id="descricao-personagem" placeholder="Digite a descrição do seu personagem"></textarea>
            </section>

            <section id="recursos">
                <h2>Recursos</h2>
                <div class="vida-magia-vigor">
                    <div class="atributo-container vida">
                        <h3>Vida</h3>
                        <div class="valor-total medieval-box">
                            <span>Vida Total: </span>
                            <span id="vida-total" readonly>50</span>
                        </div>
                        <div class="valor-atual medieval-box">
                            <span>Vida Atual: </span>
                            <button onclick="diminuirVida()" title="Diminuir Vida">▼</button>
                            <span id="vida-atual">50</span>
                            <button onclick="aumentarVida()" title="Aumentar Vida">▲</button>
                        </div>
                        <div class="regeneracao">
                            <span>Regeneração/turno: <span id="regeneracao-vida">0</span> (parado)</span>
                        </div>
                    </div>

                    <div class="atributo-container magia">
                        <h3>Magia</h3>
                        <div class="valor-total medieval-box">
                            <span>Magia Total: </span>
                            <span id="magia-total" readonly>20</span>
                        </div>
                        <div class="valor-atual medieval-box">
                            <span>Magia Atual: </span>
                            <button onclick="diminuirMagia()" title="Diminuir Magia">▼</button>
                            <span id="magia-atual">20</span>
                            <button onclick="aumentarMagia()" title="Aumentar Magia">▲</button>
                        </div>
                        <div class="regeneracao">
                            <span>Regeneração/turno: <span id="regeneracao-magia">0</span></span>
                        </div>
                    </div>

                    <div class="atributo-container vigor">
                        <h3>Vigor</h3>
                        <div class="valor-total medieval-box">
                            <span>Vigor Total: </span>
                            <span id="vigor-total" readonly>10.0</span>
                        </div>
                        <div class="valor-atual medieval-box">
                            <span>Vigor Atual: </span>
                            <button onclick="diminuirVigor()" title="Diminuir Vigor">▼</button>
                            <span id="vigor-atual">10.0</span>
                            <button onclick="aumentarVigor()" title="Aumentar Vigor">▲</button>
                        </div>
                        <div class="regeneracao">
                            <span>Regeneração/turno: <span id="regeneracao-vigor">0.0</span> (parado)</span>
                        </div>
                    </div>
                </div>
            </section>

            <section id="atributos">
                <h2>Atributos</h2>
                 <div class="text-center mb-4 font-semibold">Pontos de Habilidade (PD): <span id="pontos-habilidade" class="font-bold text-lg">25</span></div>
                <div class="atributos-container">
                    <div class="atributos-coluna">
                        <div class="atributo flex items-center mb-2">
                            <label for="forca" title="Afeta ataque e RDF" class="w-1/3">Força:</label>
                            <input type="number" id="forca" value="0" min="0" class="flex-grow">
                        </div>

                        <div class="atributo flex items-center mb-2">
                            <label for="destreza" title="Afeta ataque e acerto" class="w-1/3">Destreza:</label>
                            <input type="number" id="destreza" value="0" min="0" class="flex-grow">
                        </div>

                        <div class="atributo flex items-center mb-2">
                            <label for="agilidade" title="Afeta esquiva e acerto" class="w-1/3">Agilidade:</label>
                            <input type="number" id="agilidade" value="0" min="0" class="flex-grow">
                        </div>

                        <div class="atributo flex items-center mb-2">
                            <label for="constituicao" title="Afeta vida, magia e vigor" class="w-1/3">Constituição:</label>
                            <input type="number" id="constituicao" value="0" min="0" class="flex-grow">
                        </div>

                        <div class="atributo flex items-center mb-2">
                            <label for="inteligencia" title="Afeta ataque mágico e RDM" class="w-1/3">Inteligência:</label>
                            <input type="number" id="inteligencia" value="0" min="0" class="flex-grow">
                        </div>
                    </div>

                    <div class="atributos-coluna-destaque">
                         <h3 class="text-center font-semibold mb-2 font-medievalsharp text-lg">Atributos Derivados</h3>
                        <div class="atributo-destaque">
                            <label>Ataque:</label>
                            <span id="ataque" readonly>0</span>
                        </div>
                        <div class="atributo-destaque">
                            <label>Ataque Mágico:</label>
                            <span id="ataque-magico" readonly>0</span>
                        </div>
                        <div class="atributo-destaque">
                            <label>Acerto:</label>
                            <span id="acerto" readonly>0</span>
                        </div>
                        <div class="atributo-destaque">
                            <label>Esquiva:</label>
                            <span id="esquiva" readonly>0</span>
                        </div>
                        <div class="atributo-destaque">
                            <label>RDF (Res. Dano Físico):</label>
                            <span id="rdf" readonly>0</span>
                        </div>
                        <div class="atributo-destaque">
                            <label>RDM (Res. Dano Mágico):</label>
                            <span id="rdm" readonly>0</span>
                        </div>
                    </div>
                </div>
            </section>

            <section id="combate">
                <h2>Combate</h2>
                <div class="armamento-container">
                    <div class="armamento-coluna">
                        <label>Armamento Mão Direita:</label>
                        <div class="flex items-center flex-wrap mb-2 gap-2">
                            <input type="text" id="arma-direita-nome" placeholder="Nome da Arma" class="flex-grow min-w-[150px]">
                            <div class="flex items-center">
                                <span class="mr-1">Atq </span>
                                <input type="number" id="arma-direita-ataque" value="0" class="w-20">
                             </div>
                             <div class="flex items-center">
                                <span class="mr-1">AtqM </span>
                                <input type="number" id="arma-direita-ataque-magico" value="0" class="w-20">
                             </div>
                        </div>
                    </div>
                    <div class="armamento-coluna">
                        <label>Armamento Mão Esquerda:</label>
                         <div class="flex items-center flex-wrap gap-2">
                            <input type="text" id="arma-esquerda-nome" placeholder="Nome da Arma/Escudo" class="flex-grow min-w-[150px]">
                             <div class="flex items-center">
                                <span class="mr-1">Atq </span>
                                <input type="number" id="arma-esquerda-ataque" value="0" class="w-20">
                             </div>
                              <div class="flex items-center">
                                <span class="mr-1">AtqM </span>
                                <input type="number" id="arma-esquerda-ataque-magico" value="0" class="w-20">
                             </div>
                        </div>
                    </div>
                </div>
            </section>

            <section id="inventario-habilidades">
                <h2>Inventário e Habilidades</h2>
                <div class="flex gap-5 flex-wrap md:flex-nowrap"> <!-- Flex wrap for smaller screens -->
                    <div class="w-full md:w-1/2"> <!-- Full width on small, half on medium+ -->
                        <label>Inventário (Peso Total: <span id="peso-total">0</span> kg):</label>
                        <div id="inventario-slots">
                            <!-- Slots 1-10 -->
                            <div class="inventory-slot">
                                <input type="text" placeholder="Item 1" class="inventory-item">
                                <input type="number" min="0" value="0" class="inventory-weight" title="Peso em kg">
                            </div>
                            <div class="inventory-slot">
                                <input type="text" placeholder="Item 2" class="inventory-item">
                                <input type="number" min="0" value="0" class="inventory-weight">
                            </div>
                            <div class="inventory-slot">
                                <input type="text" placeholder="Item 3" class="inventory-item">
                                <input type="number" min="0" value="0" class="inventory-weight">
                            </div>
                            <div class="inventory-slot">
                                <input type="text" placeholder="Item 4" class="inventory-item">
                                <input type="number" min="0" value="0" class="inventory-weight">
                            </div>
                            <div class="inventory-slot">
                                <input type="text" placeholder="Item 5" class="inventory-item">
                                <input type="number" min="0" value="0" class="inventory-weight">
                            </div>
                             <div class="inventory-slot">
                                <input type="text" placeholder="Item 6" class="inventory-item">
                                <input type="number" min="0" value="0" class="inventory-weight">
                            </div>
                             <div class="inventory-slot">
                                <input type="text" placeholder="Item 7" class="inventory-item">
                                <input type="number" min="0" value="0" class="inventory-weight">
                            </div>
                             <div class="inventory-slot">
                                <input type="text" placeholder="Item 8" class="inventory-item">
                                <input type="number" min="0" value="0" class="inventory-weight">
                            </div>
                             <div class="inventory-slot">
                                <input type="text" placeholder="Item 9" class="inventory-item">
                                <input type="number" min="0" value="0" class="inventory-weight">
                            </div>
                             <div class="inventory-slot">
                                <input type="text" placeholder="Item 10" class="inventory-item">
                                <input type="number" min="0" value="0" class="inventory-weight">
                            </div>
                        </div>
                    </div>

                    <div class="w-full md:w-1/2"> <!-- Full width on small, half on medium+ -->
                        <label>Magias e Habilidades:</label>
                        <div id="magias-list" class="magias-container">
                            <!-- Magia inputs 1-10 -->
                             <input type="text" placeholder="Magia/Habilidade 1" class="magia-nome">
                            <input type="text" placeholder="Magia/Habilidade 2" class="magia-nome">
                            <input type="text" placeholder="Magia/Habilidade 3" class="magia-nome">
                            <input type="text" placeholder="Magia/Habilidade 4" class="magia-nome">
                            <input type="text" placeholder="Magia/Habilidade 5" class="magia-nome">
                            <input type="text" placeholder="Magia/Habilidade 6" class="magia-nome">
                            <input type="text" placeholder="Magia/Habilidade 7" class="magia-nome">
                            <input type="text" placeholder="Magia/Habilidade 8" class="magia-nome">
                            <input type="text" placeholder="Magia/Habilidade 9" class="magia-nome">
                            <input type="text" placeholder="Magia/Habilidade 10" class="magia-nome">
                        </div>
                        <button id="adicionar-magia-btn">+ Magia/Habilidade</button>
                    </div>
                </div>

                <div class="mt-6"> <!-- Increased margin top -->
                    <div class="mb-4"> <!-- Margin below Vantagens -->
                        <label>Vantagens:</label>
                        <div id="vantagens-list-display" class="list-display"></div>
                     </div>
                     <div>
                        <label>Desvantagens:</label>
                        <div id="desvantagens-list-display" class="list-display"></div>
                     </div>
                </div>

                <div class="classe-raca-container">
                     <div class="mb-4"> <!-- Margin below Class -->
                        <label for="classe-nome">Classe:</label>
                        <input type="text" id="classe-nome" placeholder="Nome da Classe">
                        <textarea id="classe-descricao" placeholder="Descrição da Classe"
                            class="expandable-textarea"></textarea>
                     </div>

                     <div>
                        <label for="raca-nome">Raça:</label>
                        <span id="raca-nome" onclick="abrirModalRaca()">Clique para selecionar/editar</span>
                        <textarea id="raca-descricao" placeholder="Vantagens da Raça" class="expandable-textarea"
                            readonly></textarea>
                     </div>
                </div>
            </section>

            <section id="locomocao">
                <h2>Locomoção</h2>
                <div class="locomotion-container">
                    <div class="locomotion-item">
                        <label>Velocidade de Corrida:</label>
                        <span>🏃‍♂️</span>
                        <span id="velocidade-corrida" readonly>25</span>
                        <span class="ml-1">km/h</span> <!-- Added unit -->
                    </div>
                    <div class="locomotion-item">
                        <label>Altura do Pulo:</label>
                        <span>⬆️</span>
                        <span id="altura-pulo" readonly>1</span>
                         <span class="ml-1">m</span> <!-- Added unit -->
                    </div>
                    <div class="locomotion-item">
                        <label>Distância do Pulo:</label>
                        <span>➡️</span>
                        <span id="distancia-pulo" readonly>3</span>
                        <span class="ml-1">m</span> <!-- Added unit -->
                    </div>
                </div>
            </section>

            <section id="status">
                <h2>Status</h2>
                <div class="flex flex-wrap gap-5 justify-around items-center"> <!-- Flex layout for status items -->
                    <div class="text-center">
                        <label for="experiencia" class="block mb-1">Experiência (XP):</label>
                        <input type="number" id="experiencia" value="0" min="0" class="w-32 text-center">
                    </div>
                     <div class="text-center">
                        <label class="block mb-1">Pontos de Vantagem (PH):</label>
                        <span id="pontos-vantagem" readonly class="text-lg font-bold">8</span>
                    </div>
                    <div id="nivel-container" class="text-center">
                        <label class="block mb-1">Nível:</label>
                        <span id="nivel">0</span>
                    </div>
                </div>
            </section>

            <div style="display:flex;justify-content:center;gap:10px; margin-bottom:20px; flex-wrap: wrap;">
                <button id="vantagens-desvantagens-btn">Vantagens e Desvantagens</button>
                <button id="racas-btn">Raças 🏰</button>
                <button id="classes-btn">Classes ⚔️</button>
            </div>

            <div class="botoes-container">
                <button id="reset-pontos" class="botao botao-reset">Reiniciar Pontos</button>
                <button id="recomecar" class="botao botao-recomecar">Recomeçar</button>
                <button id="bloquear-ficha" class="botao botao-bloquear">Bloquear Ficha</button>
                <button id="lua-btn" class="botao" title="Modo Escuro">🌙</button>
                <button id="sol-btn" class="botao" title="Modo Claro">☀️</button>
                <button id="plano-fundo-btn" class="botao">Plano de fundo</button>
                <button id="excluir-ficha" class="botao botao-excluir">Excluir Ficha</button>
            </div>

            <!-- Excluir Ficha button moved to the main button container -->
            <!-- <button id="excluir-ficha" class="botao botao-excluir">Excluir Ficha</button> -->
        </div>
    </div>

    <button id="anotacoes-btn">Anotações</button>
    <textarea id="anotacoes-textarea" placeholder="Suas anotações aqui..."></textarea>

    <button id="historico-dados-btn">Histórico Dados</button>
    <div id="historico-dados-panel">
        <h3>Histórico de Dados</h3>
        <div id="historico-lista"></div>
        <button id="excluir-historico-btn">Excluir histórico</button>
    </div>

    <div id="vantagens-desvantagens-panel">
        <h2>Vantagens e Desvantagens</h2>
        <div>Pontos de Vantagem Temporários: <span id="ph-temp">0</span></div>
        <div id="vantagens-list"></div>
        <div id="desvantagens-list"></div>
        <button id="salvar-vantagens-btn">SALVAR</button>
        <button id="fechar-pagina-btn">Fechar</button>
    </div>

    <div id="racas-panel">
        <h2>Raças</h2>
        <div id="racas-list"></div>
        <button id="salvar-racas-btn">SALVAR</button>
        <button id="fechar-racas-btn">Fechar</button>
    </div>

    <div id="classes-panel">
        <h2>Classes</h2>
        <!-- Content for classes can be added here -->
        <button id="fechar-classes-btn">Fechar</button>
    </div>

    <div id="nome-ficha-modal" class="modal">
        <div class="modal-content">
            <h3>Dê um Nome à Ficha</h3>
            <input type="text" id="nome-ficha-input" placeholder="Nome da ficha" maxlength="20">
            <button class="confirm-btn" onclick="criarNovaFicha()">Confirmar</button>
            <button class="cancel-btn" onclick="fecharModal('nome-ficha-modal')">Cancelar</button>
        </div>
    </div>

    <div id="bloquear-ficha-modal" class="modal">
        <div class="modal-content">
            <h3>Senha de Bloqueio (4 Dígitos)</h3>
            <input type="password" inputmode="numeric" id="senha-bloqueio-input" placeholder="Senha (4 dígitos)" maxlength="4" pattern="\d{4}">
            <button class="confirm-btn" onclick="bloquearFicha()">Confirmar</button>
            <button class="cancel-btn" onclick="fecharModal('bloquear-ficha-modal')">Cancelar</button>
        </div>
    </div>

    <div id="password-modal" class="modal">
        <div class="modal-content">
            <h3>Digite a Senha da Ficha</h3>
             <input type="password" inputmode="numeric" id="senha-desbloqueio-input" placeholder="Senha (4 dígitos)" maxlength="4" pattern="\d{4}">
            <button class="confirm-btn" onclick="desbloquearFicha()">Confirmar</button>
            <button class="cancel-btn" onclick="cancelarDesbloqueio()">Cancelar</button>
        </div>
    </div>

    <div id="confirmar-compra-modal" class="modal">
        <div class="modal-content">
            <h3>Confirmar Seleção?</h3>
             <p>Deseja selecionar este item?</p>
            <button class="confirm-btn" id="confirmar-compra-btn">Sim</button>
            <button class="cancel-btn" onclick="fecharModal('confirmar-compra-modal')">Não</button>
        </div>
    </div>

    <div id="salvar-vantagens-modal" class="modal">
        <div class="modal-content">
            <h3>Salvar Alterações?</h3>
            <p>Após salvar, as alterações não poderão ser desfeitas sem permissão do GM.</p>
            <button class="confirm-btn" id="confirmar-salvar-vantagens-btn">OK</button>
            <button class="cancel-btn" onclick="fecharModal('salvar-vantagens-modal')">Cancelar</button>
        </div>
    </div>

    <div id="senha-gm-modal" class="modal">
        <div class="modal-content">
            <h3>Permissão do GM Necessária</h3>
            <input type="password" id="senha-gm-input" placeholder="Senha GM">
            <button class="confirm-btn" id="confirmar-senha-gm-btn">Confirmar</button>
            <button class="cancel-btn" onclick="fecharModal('senha-gm-modal')">Cancelar</button>
        </div>
    </div>

    <div id="raca-opcoes-modal" class="modal">
        <div class="modal-content">
            <h3>Opções da Raça</h3>
            <button class="confirm-btn" onclick="editarRacaSelecionadaModal()">Editar Raça</button>
            <button class="cancel-btn" onclick="excluirRacaSelecionadaModal()">Excluir Raça</button>
            <button class="cancel-btn" onclick="fecharModal('raca-opcoes-modal')" style="background-color: #6c757d;">Cancelar</button>
        </div>
    </div>

    <div id="editar-raca-modal" class="modal">
        <div class="modal-content">
            <h3>Editar Raça (GM)</h3>
            <label for="editar-raca-nome">Nome:</label>
            <input type="text" id="editar-raca-nome">
            <label for="editar-raca-descricao">Vantagens:</label>
            <textarea id="editar-raca-descricao" rows="6"></textarea>
            <button class="confirm-btn" onclick="salvarEdicaoRaca()">Salvar</button>
            <button class="cancel-btn" onclick="fecharModal('editar-raca-modal')">Cancelar</button>
        </div>
    </div>

    <div id="chat-password-modal" class="modal">
        <div class="modal-content">
            <h3>Definir Senha do Chat</h3>
            <input type="password" id="chat-senha-input" placeholder="Senha do Chat (min 4 caracteres)">
            <input type="password" id="chat-confirmar-senha-input" placeholder="Confirmar Senha">
            <button class="confirm-btn" onclick="definirSenhaChat()">Confirmar</button>
            <button class="cancel-btn" onclick="fecharModal('chat-password-modal')">Cancelar</button>
        </div>
    </div>

    <div id="open-chat-modal" class="modal">
        <div class="modal-content">
            <h3>Digite a Senha do Chat</h3>
            <input type="password" id="abrir-chat-senha-input" placeholder="Senha do Chat">
            <button class="confirm-btn" onclick="abrirChat()">Confirmar</button>
            <button class="cancel-btn" onclick="fecharModal('open-chat-modal')">Cancelar</button>
        </div>
    </div>

    <div id="chat-modal" class="modal">
        <div class="modal-content">
            <div class="chat-header">
                Chat Privado
                 <button class="cancel-btn" onclick="fecharModal('chat-modal')" title="Fechar Chat">×</button>
            </div>
            <div class="chat-body">
                <div class="user-list">
                    <h4>Fichas Online</h4>
                    <div id="available-fichas">
                        <!-- Lista de usuários carregada aqui -->
                        </div>
                </div>
                <div class="conversation" id="conversation-area">
                    <!-- Mensagens da conversa carregadas aqui -->
                     <h3 style="margin-top: 20px;">Selecione uma ficha para conversar.</h3>
                </div>
            </div>
            <div class="chat-input">
                <input type="text" id="mensagem-input" placeholder="Digite sua mensagem...">
                <button onclick="enviarMensagem()">Enviar</button>
            </div>
            <!-- Close button moved to header -->
            <!-- <button class="cancel-btn" onclick="fecharModal('chat-modal')">Fechar Chat</button> -->
        </div>
    </div>

    <div id="notification"></div>

    <audio id="new-message-sound" preload="auto" style="display:none;">
        <!-- Provide a valid path to a notification sound if desired -->
        <source src="notification_sound.mp3" type="audio/mpeg">
        <!-- Example: <source src="/sounds/message.mp3" type="audio/mpeg"> -->
     </audio>

    <div id="background-modal" class="modal">
        <div class="modal-content">
            <h3>Plano de Fundo</h3>
            <label for="background-image-input">Selecionar Imagem:</label>
            <input type="file" id="background-image-input" accept="image/*">

            <div class="radio-group">
                <label><input type="radio" name="background-size" value="cover" checked> Preencher Tela</label>
                <label><input type="radio" name="background-size" value="contain"> Conter na Tela</label>
                <label><input type="radio" name="background-size" value="auto"> Tamanho Original</label>
                 <label><input type="radio" name="background-size" value="100% 100%"> Estender</label>
            </div>

             <div class="button-container">
                 <button class="confirm-btn" onclick="aplicarPlanoDeFundo()">Salvar</button>
                 <button class="cancel-btn" onclick="fecharModal('background-modal')">Cancelar</button>
                <button class="cancel-btn" onclick="excluirPlanoDeFundo()" title="Remove a imagem atual e volta ao padrão">Excluir Imagem</button>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            // Your Firebase config details remain the same
            apiKey: "AIzaSyBbbwbwPXv6gztkyP3TXK-DtooEI7FcClI", // Keep your actual API key
            authDomain: "ficha-de-rpg-b9685.firebaseapp.com",
            databaseURL: "https://ficha-de-rpg-b9685-default-rtdb.firebaseio.com",
            projectId: "ficha-de-rpg-b9685",
            storageBucket: "ficha-de-rpg-b9685.firebasestorage.app",
            messagingSenderId: "528610398062",
            appId: "1:528610398062:web:8fdb9cfd5ded8167613b7f"
        };
        firebase.initializeApp(firebaseConfig);

        const database = firebase.database();

        let fichas = {},
            currentFichaId = null,
            isFichaLocked = false,
            fichaPassword = null,
            isFichaUnlocked = false, // Indicates temporary unlock via GM password
            senhaMatriz = "1040", // GM Password
            vantagensSelecionadas = [],
            desvantagensSelecionadas = [],
            tempVantagensSelecionadas = [], // For editing panel
            tempDesvantagensSelecionadas = [], // For editing panel
            racaSelecionada = null, // Saved race
            tempRacaSelecionada = null, // For editing panel
            vidaTotal = 50, // Default values
            vidaAtual = 50,
            magiaTotal = 20,
            magiaAtual = 20,
            vigorTotal = 10.0,
            vigorAtual = 10.0,
            previousValues = new Map(), // Store previous input values for cancel/lock
            chatPassword = null,
            isChatOpen = false,
            selectedChatUser = null, // The fichaId of the user being chatted with
            messageListeners = {}; // To store active Firebase listeners for messages

        // --- Data Definitions --- (Vantagens, Desvantagens, Raças, Níveis)
        const vantagensData = [{
            nome: "Maestria com Armas curtas (2)",
            custo: 2,
            descricao: "Adiciona +1 em ataque, +1 em acerto com armas curtas."
        }, {
            nome: "Maestria com armas pesadas (2)",
            custo: 2,
            descricao: "Adiciona +2 em ataque com armas pesadas."
        }, {
            nome: "Maestria com armas de longo alcance (2)",
            custo: 2,
            descricao: "Adiciona +2 em acerto com armas de longo alcance."
        }, {
            nome: "Furtar (2)",
            custo: 2,
            descricao: "+4 em testes de furto."
        }, {
            nome: "Lábia (2)",
            custo: 2,
            descricao: "+5 em testes de lábia."
        }, {
            nome: "Velejar (1)",
            custo: 1,
            descricao: ""
        }, {
            nome: "Beleza (1)",
            custo: 1,
            descricao: "Aumenta em +3 o teste em lábia, paquera e persuasão."
        }, {
            nome: "Boa Fama (2)",
            custo: 2,
            descricao: "Aumenta em +4 chance de descontos em armamentos, pousadas, alimentos, etc."
        }, {
            nome: "Arremedo (2)",
            custo: 2,
            descricao: "Capacidade de imitar qualquer som SIMPLES."
        }, {
            nome: "Destemor (1)",
            custo: 1,
            descricao: "Dificilmente é assustado por algo."
        }, {
            nome: "Empatia (3)",
            custo: 3,
            descricao: "Sensibilidade extraordinária em relação aos outras pessoas. É um talento excelente para identificar impostores, possessões por espirito, etc."
        }, {
            nome: "Empatia com animais (1)",
            custo: 1,
            descricao: "Pode compreender as motivações dos animais."
        }, {
            nome: "Patrono (4)",
            custo: 4,
            descricao: "Possui um mentor/mestre/professor, até mesmo uma organização/guilda que pode lhe oferecer ajuda."
        }, {
            nome: "Reconhecimento Social (2)",
            custo: 2,
            descricao: "É membro de uma raça, classe, sexo ou grupo muito respeitado, temido ou venerado pela sociedade. Adiciona +2 pontos o teste em lábia, paquera e persuasão."
        }, {
            nome: "Riqueza (2)",
            custo: 2,
            descricao: "Inicia com 20 moedas de ouro."
        }, {
            nome: "Aptidão para magia (4)",
            custo: 4,
            descricao: "Adiciona 15% a mais de dano e gasta 15% a menos de magia para toda vez que usa a magia que você tem aptidão."
        }, {
            nome: "Combo Físico (4)",
            custo: 4,
            descricao: "Essa vantagem lhe concede começar sua locomoção com 50km velocidade corrida, pulo de 3 metros de altura e 9 metros de distância.",
            restricao: "inicio" // Only available at level 0
        }, {
            nome: "Nadar (1)",
            custo: 1,
            descricao: ""
        }, {
            nome: "Escalar (2)",
            custo: 2,
            descricao: ""
        }, {
            nome: "Segunda língua (1)",
            custo: 1,
            descricao: "Fala mais um idioma."
        }, {
            nome: "Paquerador (2)",
            custo: 2,
            descricao: "Adiciona +4 em teste para paquera e persuasão envolvendo flerte."
        }, {
            nome: "Senso de perigo (5)",
            custo: 5,
            descricao: "Sempre que houver algo grave para ocorrer o mestre do RPG pedirá pra você jogar um dado para reagir."
        }, {
            nome: "Acrobata (3)",
            custo: 3,
            descricao: "Adiciona + fama ao lutar em público."
        }, {
            nome: "Equilíbrio Perfeito (3)",
            custo: 3,
            descricao: "Adiciona +8 em testes de equilíbrio."
        }, {
            nome: "Tecnologia (2)",
            custo: 2,
            descricao: "Você é engenhoso, pode inventar coisas, criar objetos improvisados."
        }, {
            nome: "Poder Oculto (7)",
            custo: 7,
            descricao: "Quando sua vida estiver em 10%, você ativa o poder oculto aumentando todos seus atributos em 50%. Mas a partir do momento em que sua vida sai dos 10%, os atributos voltam ao normal."
        }, {
            nome: "Sobrevivência em floresta (2)",
            custo: 2,
            descricao: "Tem facilidade para achar cavernas, criar assentamentos, barracas, achar comida e gravar caminhos no meio da floresta. Facilidade para achar água, etc."
        }];

        const desvantagensData = [{
            nome: "Fobia (+2)",
            ganho: 2,
            descricao: "Você tem um medo irracional de algo específico."
        }, {
            nome: "Má Fama (+2)",
            ganho: 2,
            descricao: "Você é mal visto pela sociedade, dificultando interações sociais."
        }, {
            nome: "Alcoolismo (+2)",
            ganho: 2,
            descricao: "Você tem uma dependência de álcool que afeta suas decisões."
        }, {
            nome: "Altruísmo (+2)",
            ganho: 2,
            descricao: "Se sacrifica por outras pessoas e pouco se importa com fama ou riqueza."
        }, {
            nome: "Avareza (+2)",
            ganho: 2,
            descricao: "Preocupação permanente na conservação de riquezas."
        }, {
            nome: "Bullying (+3)",
            ganho: 3,
            descricao: "Gosta de caçoar, agredir, denegrir, difamar e apontar defeitos tanto em amigos quanto inimigos."
        }, {
            nome: "Circunspeção (+2)",
            ganho: 2,
            descricao: "Não entende piadas, entende tudo de forma literal e acredita que todos estão sempre falando sério."
        }, {
            nome: "Compulsões (+3)",
            ganho: 3,
            descricao: "Hábito ou vício que toma boa parte dos seus recursos e tempo."
        }, {
            nome: "Covardia (+2)",
            ganho: 2,
            descricao: "Tem extremo cuidado com seu bem-estar físico e dificuldade em assumir riscos."
        }, {
            nome: "Dependentes (+4)",
            ganho: 4,
            descricao: "Possui alguém que depende de você a todo momento (filhos, parentes, entes queridos, etc.)."
        }, {
            nome: "Fúria (+2)",
            ganho: 2,
            descricao: "Tendência a perder o controle e partir para um ataque frenético, ativado por dano, insulto ou aleatoriamente."
        }, {
            nome: "Honestidade (+3)",
            ganho: 3,
            descricao: "Não consegue mentir ou omitir, sempre fala a verdade e desmascara mentiras."
        }, {
            nome: "Impulsividade (+2)",
            ganho: 2,
            descricao: "Sempre age sem pensar."
        }, {
            nome: "Luxúria (+2)",
            ganho: 2,
            descricao: "Desejo incontrolável por romance."
        }, {
            nome: "Magnetismo Sobrenatural (+2)",
            ganho: 2,
            descricao: "Coisas estranhas acontecem com seu personagem em um nível alarmante."
        }, {
            nome: "No Limite (+4)",
            ganho: 4,
            descricao: "Assume riscos extremamente irracionais diante de perigo mortal (ex.: enfrentar um boss sozinho)."
        }, {
            nome: "Teimosia (+1)",
            ganho: 1,
            descricao: "Quer sempre fazer as coisas do seu modo e não segue planos que não sejam seus."
        }, {
            nome: "Amnésia (+2)",
            ganho: 2,
            descricao: "Em certos momentos, não consegue lembrar de coisas importantes."
        }];

        let racasData = [{
            nome: "Humano (3)",
            custo: 3,
            descricao: "Os humanos são versáteis, ambiciosos e mestres em se adaptar a qualquer situação. Suas vantagens refletem uma capacidade excepcional de prosperar em qualquer ambiente.",
            vantagens: ["Explorador Nato: Começam com um cavalo de raça superior (mais rápido e resistente), equipamentos de montaria completos (selas, suprimentos para semanas) e um mapa detalhado de uma região inicial à escolha, permitindo explorar áreas distantes com facilidade e segurança.", "Mestre das Profissões: Escolhem uma profissão com benefícios. Ferreiro Lendário: Criam armas e armaduras com 5 pontos de qualidade automaticamente e podem forjar itens com propriedades únicas (ex.: espada que brilha ao detectar inimigos). Costureiro Arcano: Produzem vestimentas leves ou armaduras com resistência a dois elementos (ex.: fogo e gelo) e bônus de regeneração passiva de energia ou vida. Arquiteto Visionário: Constroem estruturas permanentes em metade do tempo e com o dobro da resistência, podendo criar bases estratégicas com defesas embutidas (ex.: torres de vigia).", "Rede de Influência: Iniciam com uma rede de contatos: um aliado influente (guildas, mercadores ou líderes locais) oferecendo acesso a informações secretas ou até intervenção em conflitos.", "Determinação Inabalável: Uma vez por dia, podem ignorar completamente uma situação de desvantagem (ex.: exaustão, ferimento grave ou efeito mágico negativo), agindo como se estivessem em plena capacidade por um curto período."]
        }, {
            nome: "Elfo (4)",
            custo: 4,
            descricao: "Os elfos são sábios, mágicos e profundamente conectados ao mundo natural. Suas vantagens agora destacam sua supremacia mágica e harmonia com a natureza.",
            vantagens: ["Sabedoria Ancestral: Dominam uma área de conhecimento (ex.: arcana, história, natureza) com maestria, podendo decifrar pergaminhos, ruínas ou magias antigas automaticamente, e aprendem 1 línguas extra.", "Visão Élfica Suprema: Enxergam no escuro até 10 metros, detectam magias fracas em um raio de 20 metros e percebem intenções hostis em seres vivos com um teste muito difícil, 19 ou +.", "Escudo Mágico: Ganham resistência inata a um tipo de efeito magico hostil (não apenas encantamentos), reduzindo o dano ou a duração desses efeitos em 50%, refletindo sua essência mágica."]
        }, {
            nome: "Anão (4)",
            custo: 4,
            descricao: "Os anões são resilientes, habilidosos e ligados à terra. Suas vantagens agora enfatizam sua supremacia em crafting e sobrevivência em condições extremas.",
            vantagens: ["Fortitude Indomável: Trabalham por 3 dias sem descanso, ignorando efeitos de fadiga, e recuperam vida e energia ao dormir em ambientes rochosos ou subterrâneos duas vezes mais rápido.", "Artesão: Escolhem uma especialização com impacto massivo: Mestre Minerador: Identificam e extraem recursos raros (ex.: mithril) com o dobro da velocidade e podem abrir túneis temporários em rochas sólidas com ferramentas improvisadas. Forjador de Lendas: Produzem armas e armaduras com 10 pontos de qualidade e propriedades mágicas temporárias (ex.: arma que causa dano elemental extra), além de reparar itens quebrados durante um curto periodo de tempo (1 a 2 dias). Joalheiro Divino: Criam artefatos que armazenam magias moderadas (ex.: um anel que lança uma bola de fogo uma vez por dia) ou concedem bônus Temporários a atributos (ex.: +1 força).", "Senhor das Profundezas: Nunca se perdem em ambientes subterrâneos, detectam armadilhas (naturais ou artificiais) automaticamente e podem sentir vibrações no solo para prever emboscadas ou colapsos."]
        }, {
            nome: "Orc (3)",
            custo: 3,
            descricao: "Os orcs são guerreiros ferozes e líderes carismáticos pela força. Suas vantagens agora amplificam sua presença intimidadora e poder bruto.",
            vantagens: ["Lenda entre Guerreiros: Inspiram temor e respeito em qualquer cultura que valorize força, garantindo alianças com facções marciais e acesso a missões épicas; inimigos menores fogem automaticamente em sua presença (teste difícil, 16 ou +).", "Resiliência Brutal: Lutam sem penalidades mesmo com ferimentos graves e só caem quando atingem PV 0, além de regenerarem ferimentos leves passivamente fora de combate.", "Domínio da Intimidação: Podem forçar inimigos a se renderem ou recuarem com um grito poderoso uma vez por encontro, afetando grupos inteiros, e ganham bônus massivos em negociações baseadas em força ou medo.", "Fúria Ancestral: Entram em um estado de fúria duas vezes por dia, duplicando força e resistência por um curto período."]
        }, {
            nome: "Meio Animal (Selvagem) (4)",
            custo: 4,
            descricao: "Os meio animais combinam instinto primal com astúcia. Suas vantagens agora os tornam mestres da sobrevivência e predadores supremos.",
            vantagens: ["Sentidos Predatórios: Pode escolher um sentido aguçado de acordo com sua parte animal. (visão, olfato, audição), permitindo rastrear alvos a quilômetros, detectar inimigos invisíveis e evitar qualquer surpresa com um teste moderado, 12 ou +.", "Senhor dos Terrenos: Adaptam-se completamente a um ambiente (ex.: floresta, deserto, pântano), ignorando todos os efeitos negativos e ganhando bônus de movimento e furtividade nesses locais. bônus +1.", "Frenesi Instintivo: Uma vez por dia, canalizam seus instintos para ganhar velocidade sobrenatural (dobro de movimento), ataques adicionais e uma percepção quase premonitória de perigos, tornando-os caçadores ou fugitivos imbatíveis por um curto período (10 min)."]
        }];

         // Level data remains the same
         const nivelData = [{ nivel: 0, xp: 0, pd: 25, ph: 8 }, { nivel: 1, xp: 10, pd: 31, ph: 9 }, { nivel: 2, xp: 30, pd: 37, ph: 10 }, { nivel: 3, xp: 60, pd: 43, ph: 11 }, { nivel: 4, xp: 100, pd: 49, ph: 12 }, { nivel: 5, xp: 150, pd: 55, ph: 13 }, { nivel: 6, xp: 210, pd: 61, ph: 14 }, { nivel: 7, xp: 280, pd: 67, ph: 15 }, { nivel: 8, xp: 360, pd: 73, ph: 16 }, { nivel: 9, xp: 450, pd: 79, ph: 17 }, { nivel: 10, xp: 550, pd: 85, ph: 18 }, { nivel: 11, xp: 670, pd: 91, ph: 19 }, { nivel: 12, xp: 810, pd: 97, ph: 20 }, { nivel: 13, xp: 970, pd: 103, ph: 21 }, { nivel: 14, xp: 1150, pd: 109, ph: 22 }, { nivel: 15, xp: 1350, pd: 115, ph: 23 }, { nivel: 16, xp: 1570, pd: 121, ph: 24 }, { nivel: 17, xp: 1810, pd: 127, ph: 25 }, { nivel: 18, xp: 2070, pd: 133, ph: 26 }, { nivel: 19, xp: 2350, pd: 139, ph: 27 }, { nivel: 20, xp: 2650, pd: 145, ph: 28 }, { nivel: 21, xp: 2980, pd: 148, ph: 29 }, { nivel: 22, xp: 3340, pd: 151, ph: 30 }, { nivel: 23, xp: 3730, pd: 154, ph: 31 }, { nivel: 24, xp: 4150, pd: 157, ph: 32 }, { nivel: 25, xp: 4600, pd: 160, ph: 33 }, { nivel: 26, xp: 5080, pd: 163, ph: 34 }, { nivel: 27, xp: 5590, pd: 166, ph: 35 }, { nivel: 28, xp: 6130, pd: 169, ph: 36 }, { nivel: 29, xp: 8000, pd: 219, ph: 37 }, { nivel: 30, xp: 10000, pd: 319, ph: 38 }];

        // --- DOM Element References ---
        const nomePersonagemInput = document.getElementById("nome-personagem"),
            descricaoPersonagemInput = document.getElementById("descricao-personagem"),
            forcaInput = document.getElementById("forca"),
            destrezaInput = document.getElementById("destreza"),
            agilidadeInput = document.getElementById("agilidade"),
            inteligenciaInput = document.getElementById("inteligencia"),
            constituicaoInput = document.getElementById("constituicao"),
            ataqueSpan = document.getElementById("ataque"),
            ataqueMagicoSpan = document.getElementById("ataque-magico"),
            acertoSpan = document.getElementById("acerto"),
            esquivaSpan = document.getElementById("esquiva"),
            rdfSpan = document.getElementById("rdf"),
            rdmSpan = document.getElementById("rdm"),
            armaDireitaNomeInput = document.getElementById("arma-direita-nome"),
            armaDireitaAtaqueInput = document.getElementById("arma-direita-ataque"),
            armaDireitaAtaqueMagicoInput = document.getElementById("arma-direita-ataque-magico"),
            armaEsquerdaNomeInput = document.getElementById("arma-esquerda-nome"),
            armaEsquerdaAtaqueInput = document.getElementById("arma-esquerda-ataque"),
            armaEsquerdaAtaqueMagicoInput = document.getElementById("arma-esquerda-ataque-magico"),
            resetPontosButton = document.getElementById("reset-pontos"),
            recomecarButton = document.getElementById("recomecar"),
            bloquearFichaButton = document.getElementById("bloquear-ficha"),
            experienciaInput = document.getElementById("experiencia"),
            nivelSpan = document.getElementById("nivel"),
            pontosHabilidadeSpan = document.getElementById("pontos-habilidade"),
            pontosVantagemSpan = document.getElementById("pontos-vantagem"),
            velocidadeCorridaSpan = document.getElementById("velocidade-corrida"),
            alturaPuloSpan = document.getElementById("altura-pulo"),
            distanciaPuloSpan = document.getElementById("distancia-pulo"),
            nomePersonagemTitulo = document.getElementById("nome-personagem-titulo"),
            gameMasterMessage = document.getElementById("game-master-message"),
            vantagensListDisplay = document.getElementById("vantagens-list-display"),
            desvantagensListDisplay = document.getElementById("desvantagens-list-display"),
            inventarioSlots = document.getElementById("inventario-slots"),
            pesoTotalSpan = document.getElementById("peso-total"),
            diceContainer = document.getElementById("dice-container"),
            diceRoll = document.getElementById("dice-roll"),
            diceResult = document.getElementById("dice-result"),
            notification = document.getElementById("notification"),
            characterImageInput = document.getElementById("character-image-input"),
            characterImage = document.getElementById("character-image"),
            vantagensDesvantagensBtn = document.getElementById("vantagens-desvantagens-btn"),
            vantagensDesvantagensPanel = document.getElementById("vantagens-desvantagens-panel"),
            vantagensList = document.getElementById("vantagens-list"),
            desvantagensList = document.getElementById("desvantagens-list"),
            salvarVantagensBtn = document.getElementById("salvar-vantagens-btn"),
            fecharPaginaBtn = document.getElementById("fechar-pagina-btn"),
            fichaContainer = document.getElementById("ficha-container"),
            magiasList = document.getElementById("magias-list"),
            adicionarMagiaBtn = document.getElementById("adicionar-magia-btn"),
            anotacoesBtn = document.getElementById("anotacoes-btn"),
            anotacoesTextarea = document.getElementById("anotacoes-textarea"),
            racasBtn = document.getElementById("racas-btn"),
            classesBtn = document.getElementById("classes-btn"),
            racasPanel = document.getElementById("racas-panel"),
            classesPanel = document.getElementById("classes-panel"),
            fecharRacasBtn = document.getElementById("fechar-racas-btn"),
            fecharClassesBtn = document.getElementById("fechar-classes-btn"),
            classeNomeInput = document.getElementById("classe-nome"),
            classeDescricaoInput = document.getElementById("classe-descricao"),
            racaNomeSpan = document.getElementById("raca-nome"),
            racaDescricaoInput = document.getElementById("raca-descricao"),
            luaBtn = document.getElementById("lua-btn"),
            solBtn = document.getElementById("sol-btn"),
            salvarRacasBtn = document.getElementById("salvar-racas-btn"),
            racasList = document.getElementById("racas-list"),
            atributosInputs = [forcaInput, destrezaInput, agilidadeInput, inteligenciaInput, constituicaoInput],
            chatBtn = document.getElementById("chat-btn"),
            availableFichasDiv = document.getElementById("available-fichas"),
            conversationAreaDiv = document.getElementById("conversation-area"),
            mensagemInput = document.getElementById("mensagem-input"),
            newMessageSound = document.getElementById("new-message-sound"),
            planoFundoBtn = document.getElementById("plano-fundo-btn"),
            backgroundImageInput = document.getElementById("background-image-input"),
            backgroundModal = document.getElementById("background-modal"),
            historicoDadosBtn = document.getElementById("historico-dados-btn"),
            historicoDadosPanel = document.getElementById("historico-dados-panel"),
            historicoLista = document.getElementById("historico-lista"),
            excluirHistoricoBtn = document.getElementById("excluir-historico-btn"),
            phTempSpan = document.getElementById("ph-temp"), // Reference for temp PH display
            confirmarCompraModal = document.getElementById('confirmar-compra-modal'),
            confirmarCompraBtn = document.getElementById('confirmar-compra-btn'),
            salvarVantagensModal = document.getElementById('salvar-vantagens-modal'),
            confirmarSalvarVantagensBtn = document.getElementById('confirmar-salvar-vantagens-btn');

        // --- Global State Variables ---
        let nivel = 0,
            nivelAnterior = 0,
            pontosHabilidadeTotal = 25,
            pontosHabilidadeUsados = 0,
            experiencia = 0,
            vidaBase = 50; // Base HP calculation needs this

        // --- Initialization ---
        function criarFichaMatriz() {
            const fichaId = "ficha-matriz";
            // Default structure for a new ficha (including matriz)
            const fichaMatriz = {
                nomeFicha: "Matriz",
                nomePersonagem: "Personagem Matriz",
                descricaoPersonagem: "Ficha original do sistema",
                forca: "0",
                destreza: "0",
                agilidade: "0",
                inteligencia: "0",
                constituicao: "0",
                experiencia: "0",
                armaDireitaNome: "",
                armaDireitaAtaque: "0",
                armaDireitaAtaqueMagico: "0",
                armaEsquerdaNome: "",
                armaEsquerdaAtaque: "0",
                armaEsquerdaAtaqueMagico: "0",
                vantagens: "", // Stored as newline-separated string
                magiasHabilidades: Array(10).fill("").join("\n"), // Stored as newline-separated string
                desvantagens: "", // Stored as newline-separated string
                inventario: Array(10).fill({ item: "", peso: "0" }), // Array of objects
                velocidadeCorrida: "25",
                alturaPulo: "1",
                distanciaPulo: "3",
                isLocked: true, // Matriz starts locked
                password: senhaMatriz, // Matriz uses GM password
                imagem: null, // Base64 image string or null
                anotacoes: "",
                classeNome: "",
                classeDescricao: "",
                racaNome: "", // Display name (e.g., "Elfo")
                racaDescricao: "", // Description/advantages text
                racaSelecionada: "", // Internal name (e.g., "Elfo (4)")
                chatPassword: null, // Password for private chat
                backgroundImage: null, // Base64 image string or null
                backgroundSize: 'cover' // 'cover', 'contain', 'auto', '100% 100%'
            };
            database.ref("fichas/ficha-matriz").once("value", snapshot => {
                if (snapshot.exists()) {
                    // Matriz exists, proceed to load
                    if (!currentFichaId) currentFichaId = fichaId; // Select Matriz if nothing else selected
                    carregarFichas(); // Load all fichas including Matriz
                } else {
                    // Matriz doesn't exist, create it
                    database.ref(`fichas/${fichaId}`).set(fichaMatriz).then(() => {
                        console.log("Ficha Matriz criada.");
                        if (!currentFichaId) currentFichaId = fichaId;
                         carregarFichas(); // Load all fichas now including the new Matriz
                    }).catch(error => console.error("Erro ao criar Ficha Matriz:", error));
                }
            });
        }

        function carregarFichas() {
            // Detach previous listener if exists to avoid duplicates
             database.ref("fichas").off("value");

            database.ref("fichas").on("value", snapshot => {
                fichas = snapshot.val() || {};
                if (!fichas["ficha-matriz"]) {
                    // If Matriz somehow got deleted, recreate it
                    console.warn("Ficha Matriz não encontrada. Recriando...");
                    criarFichaMatriz(); // This will eventually call carregarFichas again
                    return; // Exit this execution, wait for recreation
                }

                // Ensure a ficha is selected
                if (!currentFichaId || !fichas[currentFichaId]) {
                    // If current ID is invalid or null, try localStorage or default to Matriz
                    const savedFichaId = localStorage.getItem('currentFichaId');
                    if (savedFichaId && fichas[savedFichaId]) {
                        currentFichaId = savedFichaId;
                    } else {
                        currentFichaId = "ficha-matriz";
                    }
                }

                console.log("Fichas carregadas:", Object.keys(fichas));
                atualizarAbasFichas(); // Update UI tabs
                carregarFicha(currentFichaId); // Load data for the selected ficha
                atualizarListaFichasChat(); // Update chat list
                verificarNovasMensagens(); // Check for unread messages
            }, error => {
                console.error("Erro ao carregar fichas:", error);
                // Handle error appropriately, maybe show a message to the user
            });
        }


        // --- Ficha Management (Tabs, Create, Delete) ---
        function atualizarAbasFichas() {
            const sidebar = document.getElementById("fichas-sidebar");
            const addBtn = document.getElementById("add-ficha-btn");

            // Clear existing tabs except the add button
            const existingTabs = sidebar.querySelectorAll(".ficha-tab");
            existingTabs.forEach(tab => sidebar.removeChild(tab));

            // Sort ficha IDs, putting 'ficha-matriz' first (optional)
            const sortedFichaIds = Object.keys(fichas).sort((a, b) => {
                if (a === 'ficha-matriz') return -1;
                if (b === 'ficha-matriz') return 1;
                // Optional: sort others alphabetically by nomeFicha
                const nameA = fichas[a]?.nomeFicha || '';
                const nameB = fichas[b]?.nomeFicha || '';
                return nameA.localeCompare(nameB);
            });


            sortedFichaIds.forEach(fichaId => {
                // if (fichaId !== "ficha-matriz") { // If you want to hide matriz tab
                    const tab = document.createElement("div");
                    tab.className = "ficha-tab";
                    const span = document.createElement("span");
                    span.textContent = fichas[fichaId]?.nomeFicha || "Sem Nome"; // Use optional chaining
                    span.title = span.textContent; // Add tooltip for long names
                    tab.appendChild(span);
                    tab.dataset.fichaId = fichaId;
                    if (fichaId === currentFichaId) {
                        tab.classList.add("active");
                    }

                    tab.onclick = () => {
                        if (currentFichaId !== fichaId) { // Only switch if different
                            currentFichaId = fichaId;
                             localStorage.setItem('currentFichaId', fichaId); // Save selection
                            console.log("Trocando para ficha:", fichaId);
                            carregarFicha(fichaId);
                            atualizarAbasFichas(); // Update active tab style
                            atualizarListaFichasChat();
                            verificarNovasMensagens();
                            if (isChatOpen && selectedChatUser) {
                                // If chat is open, reload messages for the new context
                                carregarMensagens(selectedChatUser);
                            } else if (isChatOpen) {
                                 // Clear conversation if no user selected after switch
                                 conversationAreaDiv.innerHTML = '<h3>Selecione uma ficha para conversar.</h3>';
                                 selectedChatUser = null;
                            }
                        }
                    };

                    sidebar.insertBefore(tab, addBtn); // Insert before the '+' button
                // }
            });
        }

        document.getElementById("add-ficha-btn").onclick = () => {
            document.getElementById("nome-ficha-modal").style.display = "flex";
            document.getElementById("nome-ficha-input").value = "";
            document.getElementById("nome-ficha-input").focus();
        };

        function criarNovaFicha() {
            const nomeFicha = document.getElementById("nome-ficha-input").value.trim();
            if (!nomeFicha) {
                showNotification("Por favor, dê um nome à ficha!", "critical-failure");
                return;
            }
            if (nomeFicha.length > 20) {
                 showNotification("Nome da ficha muito longo (máx 20 caracteres).", "critical-failure");
                 return;
            }

            const novaFichaId = database.ref("fichas").push().key;
            // Use the Matriz structure as a template but reset specific fields
            const novaFicha = JSON.parse(JSON.stringify(fichas["ficha-matriz"])); // Deep copy

            // Reset/Set specific fields for a new ficha
             novaFicha.nomeFicha = nomeFicha;
             novaFicha.nomePersonagem = ""; // Start blank
             novaFicha.descricaoPersonagem = "";
             novaFicha.isLocked = false; // Start unlocked
             novaFicha.password = null;
             novaFicha.experiencia = "0";
             novaFicha.anotacoes = "";
             novaFicha.vantagens = "";
             novaFicha.desvantagens = "";
             novaFicha.racaSelecionada = "";
             novaFicha.racaNome = "";
             novaFicha.racaDescricao = "";
             novaFicha.classeNome = "";
             novaFicha.classeDescricao = "";
             novaFicha.imagem = null;
             novaFicha.backgroundImage = null; // Start with default background
             novaFicha.backgroundSize = 'cover';
             novaFicha.chatPassword = null;
             novaFicha.inventario = Array(10).fill({ item: "", peso: "0" });
             novaFicha.magiasHabilidades = Array(10).fill("").join("\n");
             // Reset attributes? Or keep matriz defaults? Let's keep defaults for now.
             // novaFicha.forca = "0";
             // ... etc ...

            database.ref(`fichas/${novaFichaId}`).set(novaFicha).then(() => {
                console.log("Nova ficha criada:", novaFichaId);
                currentFichaId = novaFichaId; // Switch to the new ficha
                localStorage.setItem('currentFichaId', novaFichaId); // Save selection
                fecharModal("nome-ficha-modal");
                // carregarFichas() will be triggered by the 'value' listener,
                // automatically updating tabs and loading the new ficha.
                // No need to call carregarFicha or atualizarAbasFichas manually here.
                showNotification(`Ficha "${nomeFicha}" criada!`, "save-success");
            }).catch(error => {
                 console.error("Erro ao criar nova ficha:", error);
                 showNotification("Erro ao criar ficha.", "critical-failure");
            });
        }

         document.getElementById("excluir-ficha").onclick = () => {
            if (currentFichaId === "ficha-matriz") {
                showNotification("A ficha matriz não pode ser excluída!", "critical-failure");
                return;
            }
            if (isFichaLocked && !isFichaUnlocked) {
                 abrirModalSenha(document.getElementById("excluir-ficha")); // Pass element for context
                 return;
            }
            // Ask for GM password *always* for deletion? Or just if locked?
            // Let's require GM password for deletion for safety.
             if (confirm(`Tem certeza que deseja excluir a ficha "${fichas[currentFichaId]?.nomeFicha || currentFichaId}"?\nEsta ação NÃO PODE ser desfeita.`)) {
                  document.getElementById("senha-gm-modal").style.display = "flex";
                  document.getElementById("senha-gm-input").value = "";
                  document.getElementById("senha-gm-input").focus();
                  document.getElementById("confirmar-senha-gm-btn").onclick = () => {
                       const gmSenha = document.getElementById("senha-gm-input").value;
                       fecharModal("senha-gm-modal"); // Close modal regardless of password outcome
                       if (gmSenha === senhaMatriz) {
                           const fichaNameToDelete = fichas[currentFichaId]?.nomeFicha || currentFichaId;
                           database.ref(`fichas/${currentFichaId}`).remove().then(() => {
                                console.log("Ficha excluída:", currentFichaId);
                                showNotification(`Ficha "${fichaNameToDelete}" excluída!`, "save-success");
                                // Switch to Matriz after deletion
                                currentFichaId = "ficha-matriz";
                                localStorage.setItem('currentFichaId', currentFichaId);
                                // carregarFichas() will be triggered by the 'value' listener
                           }).catch(error => {
                               console.error("Erro ao excluir ficha:", error);
                               showNotification("Erro ao excluir ficha.", "critical-failure");
                           });
                       } else {
                           showNotification("Senha do GM incorreta! Exclusão cancelada.", "critical-failure");
                       }
                  };
             }
        };


        function fecharModal(modalId) {
            const modal = document.getElementById(modalId);
             if (modal) {
                modal.style.display = "none";
             }
        }

        // --- Data Loading and Display ---
        function carregarFicha(fichaId) {
            if (!fichas || !fichas[fichaId]) {
                console.error("Tentativa de carregar ficha inválida ou inexistente:", fichaId);
                 // Attempt to fallback to Matriz if current is invalid
                 if (fichaId !== "ficha-matriz") {
                     currentFichaId = "ficha-matriz";
                     localStorage.setItem('currentFichaId', currentFichaId);
                     carregarFicha(currentFichaId); // Recursively call with Matriz ID
                 } else {
                     // If even Matriz fails, there's a bigger issue
                     showNotification("Erro crítico: Não foi possível carregar nenhuma ficha.", "critical-failure");
                 }
                return;
            }
            const ficha = fichas[fichaId];
            console.log("Carregando dados para:", fichaId, ficha.nomeFicha);

            // Basic Info
            nomePersonagemInput.value = ficha.nomePersonagem || "";
            nomePersonagemTitulo.textContent = ficha.nomePersonagem || "Ficha de Personagem"; // Update title H1
            descricaoPersonagemInput.value = ficha.descricaoPersonagem || "";

            // Attributes
            forcaInput.value = ficha.forca || "0";
            destrezaInput.value = ficha.destreza || "0";
            agilidadeInput.value = ficha.agilidade || "0";
            inteligenciaInput.value = ficha.inteligencia || "0";
            constituicaoInput.value = ficha.constituicao || "0";

            // Status
            experienciaInput.value = ficha.experiencia || "0";
            experiencia = parseInt(experienciaInput.value) || 0; // Update global var

            // Combat
            armaDireitaNomeInput.value = ficha.armaDireitaNome || "";
            armaDireitaAtaqueInput.value = ficha.armaDireitaAtaque || "0";
            armaDireitaAtaqueMagicoInput.value = ficha.armaDireitaAtaqueMagico || "0";
            armaEsquerdaNomeInput.value = ficha.armaEsquerdaNome || "";
            armaEsquerdaAtaqueInput.value = ficha.armaEsquerdaAtaque || "0";
            armaEsquerdaAtaqueMagicoInput.value = ficha.armaEsquerdaAtaqueMagico || "0";

            // Locomotion (these are calculated, but load saved values initially)
            // Calculation will overwrite these if attributes change
            velocidadeCorridaSpan.textContent = ficha.velocidadeCorrida || "25";
            alturaPuloSpan.textContent = ficha.alturaPulo || "1";
            distanciaPuloSpan.textContent = ficha.distanciaPulo || "3";

            // Lock State
            isFichaLocked = ficha.isLocked || false;
            fichaPassword = ficha.password || null;
            isFichaUnlocked = false; // Reset temporary unlock on load
            atualizarBotaoBloquear();
             // Apply readonly based on lock state immediately
             setCamposReadonly(isFichaLocked);


            // Vantagens/Desvantagens
            vantagensSelecionadas = ficha.vantagens ? ficha.vantagens.split("\n").filter(v => v.trim()) : [];
            desvantagensSelecionadas = ficha.desvantagens ? ficha.desvantagens.split("\n").filter(d => d.trim()) : [];
            atualizarVantagensDesvantagensDisplay(); // Update main sheet display

            // Raça
             racaSelecionada = ficha.racaSelecionada || null; // Use null if empty
             const selectedRacaData = racasData.find(r => r.nome === racaSelecionada);
             racaNomeSpan.textContent = selectedRacaData ? selectedRacaData.nome.split(" (")[0] : "Clique para selecionar/editar"; // Display name or placeholder
             // Load description from data if possible, fallback to saved, then empty
             racaDescricaoInput.value = selectedRacaData ? selectedRacaData.vantagens.join("\n\n") : (ficha.racaDescricao || "");

            // Classe
            classeNomeInput.value = ficha.classeNome || "";
            classeDescricaoInput.value = ficha.classeDescricao || "";

            // Inventory
            const inventario = Array.isArray(ficha.inventario) && ficha.inventario.length >= 10
                ? ficha.inventario
                : Array(10).fill({ item: "", peso: "0" }); // Ensure 10 slots
            const slots = inventarioSlots.querySelectorAll(".inventory-slot");
            slots.forEach((slot, i) => {
                const itemInput = slot.querySelector(".inventory-item");
                const weightInput = slot.querySelector(".inventory-weight");
                itemInput.value = inventario[i]?.item || "";
                weightInput.value = inventario[i]?.peso || "0";
            });
            calcularPesoTotal(); // Update weight display

            // Magias/Habilidades
             const magias = ficha.magiasHabilidades ? ficha.magiasHabilidades.split("\n") : [];
             const magiaInputs = magiasList.querySelectorAll(".magia-nome");

             // Clear existing inputs first
             // magiasList.innerHTML = ''; // simpler way to clear

             // Populate existing or add new inputs up to the number of saved magias or 10, whichever is greater (up to 20 max)
             const numMagiasToDisplay = Math.max(magias.length, 10);
             magiaInputs.forEach((input, i) => {
                 if (i < numMagiasToDisplay && i < 20) { // Update existing inputs first
                     input.value = magias[i] || "";
                     input.style.display = 'block'; // Ensure it's visible
                 } else {
                     input.style.display = 'none'; // Hide excess template inputs
                 }
             });
             // Add new input fields if saved magias exceed current number of inputs (up to 20)
             for (let i = magiaInputs.length; i < numMagiasToDisplay && i < 20; i++) {
                  const input = document.createElement("input");
                  input.type = "text";
                  input.className = "magia-nome";
                  input.placeholder = `Magia/Habilidade ${i + 1}`;
                  input.value = magias[i] || "";
                  magiasList.appendChild(input);
             }


            // Anotações
            anotacoesTextarea.value = ficha.anotacoes || "";

            // Image
            if (ficha.imagem && ficha.imagem.startsWith('data:image')) { // Basic check for base64
                characterImage.src = ficha.imagem;
                characterImage.style.display = "block";
            } else {
                characterImage.src = ""; // Clear src
                characterImage.style.display = "none";
            }

            // Chat Password
            chatPassword = ficha.chatPassword;
            atualizarEstadoChatBotao();

            // Background
             aplicarPlanoDeFundoInicial(ficha); // Pass ficha data

             // Calculations (must be done after loading attributes and level)
             atualizarNivel(); // Calculates level based on XP, updates PD/PH totals
             calcularAtributos(); // Calculates derived stats, HP/MP/VP totals

            // Load current HP/MP/VP *after* totals are calculated
             // Use saved values if they exist and are valid, otherwise default to max
             vidaAtual = (typeof ficha.vidaAtual === 'number' && ficha.vidaAtual <= vidaTotal) ? ficha.vidaAtual : vidaTotal;
             magiaAtual = (typeof ficha.magiaAtual === 'number' && ficha.magiaAtual <= magiaTotal) ? ficha.magiaAtual : magiaTotal;
             vigorAtual = (typeof ficha.vigorAtual === 'number' && ficha.vigorAtual <= vigorTotal) ? ficha.vigorAtual : vigorTotal;

            document.getElementById("vida-atual").textContent = vidaAtual;
            document.getElementById("magia-atual").textContent = magiaAtual;
            document.getElementById("vigor-atual").textContent = vigorAtual.toFixed(1);

            // Update PH display based on calculated level and selections
            pontosVantagemSpan.textContent = getPontosVantagem();

            // Store initial values for potential locking/cancellation
            previousValues.clear();
            document.querySelectorAll('input[type="text"],input[type="number"],textarea').forEach(input => {
                previousValues.set(input.id, input.value); // Store by ID
            });
             // Store V/D/Race selections too
             previousValues.set('vantagensSelecionadas', [...vantagensSelecionadas]);
             previousValues.set('desvantagensSelecionadas', [...desvantagensSelecionadas]);
             previousValues.set('racaSelecionada', racaSelecionada);
        }

         // Helper to update V/D display on the main sheet
         function atualizarVantagensDesvantagensDisplay() {
             vantagensListDisplay.innerHTML = "";
             desvantagensListDisplay.innerHTML = "";

             vantagensSelecionadas.forEach(v => {
                 const div = document.createElement("div");
                 const vantagemData = vantagensData.find(d => d.nome === v);
                 div.textContent = v;
                 if (vantagemData?.descricao) {
                     div.title = vantagemData.descricao; // Add tooltip
                 }
                 div.className = "list-item";
                 div.onclick = () => removerVantagem(v); // Add remove handler
                 vantagensListDisplay.appendChild(div);
             });

             desvantagensSelecionadas.forEach(d => {
                 const div = document.createElement("div");
                  const desvantagemData = desvantagensData.find(desv => desv.nome === d);
                 div.textContent = d;
                  if (desvantagemData?.descricao) {
                     div.title = desvantagemData.descricao; // Add tooltip
                 }
                 div.className = "list-item";
                 div.onclick = () => removerDesvantagem(d); // Add remove handler
                 desvantagensListDisplay.appendChild(div);
             });
         }

         function setCamposReadonly(isLocked) {
            const elementsToLock = document.querySelectorAll(
                '#ficha-content input[type="text"], ' +
                '#ficha-content input[type="number"]:not(#experiencia), ' + // Allow XP input even when locked? Maybe not. Let's lock it too.
                 '#ficha-content input[type="number"], ' +
                '#ficha-content textarea:not(#anotacoes-textarea), ' + // Keep annotations editable? Yes.
                 '#ficha-content .list-item, ' + // Prevent removing V/D
                 '#character-image-container, ' + // Prevent changing image
                 '#raca-nome' // Prevent opening race modal
            );
            elementsToLock.forEach(el => {
                if (isLocked) {
                    // Add readonly attribute or disable click handlers
                     if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
                         el.readOnly = true;
                         el.style.cursor = 'not-allowed';
                     } else if (el.classList.contains('list-item') || el.id === 'raca-nome' || el.id === 'character-image-container') {
                         el.style.pointerEvents = 'none'; // Disable clicks
                         el.style.cursor = 'not-allowed';
                         el.style.opacity = '0.7'; // Visual cue
                     }
                } else {
                     // Remove readonly attribute or re-enable click handlers
                     if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
                         el.readOnly = false;
                          el.style.cursor = '';
                     } else if (el.classList.contains('list-item') || el.id === 'raca-nome' || el.id === 'character-image-container') {
                         el.style.pointerEvents = ''; // Re-enable clicks
                         el.style.cursor = 'pointer';
                         el.style.opacity = '1';
                     }
                }
            });

             // Special handling for buttons that require unlock
             const buttonsToLock = [resetPontosButton, recomecarButton, document.getElementById('excluir-ficha')];
             buttonsToLock.forEach(btn => {
                 if (btn) { // Ensure button exists
                     btn.disabled = isLocked;
                     btn.style.cursor = isLocked ? 'not-allowed' : 'pointer';
                     btn.style.opacity = isLocked ? '0.6' : '1';
                 }
             });
              // Also lock V/D and Race buttons
             vantagensDesvantagensBtn.disabled = isLocked;
             vantagensDesvantagensBtn.style.cursor = isLocked ? 'not-allowed' : 'pointer';
             vantagensDesvantagensBtn.style.opacity = isLocked ? '0.6' : '1';
             racasBtn.disabled = isLocked;
             racasBtn.style.cursor = isLocked ? 'not-allowed' : 'pointer';
             racasBtn.style.opacity = isLocked ? '0.6' : '1';
             // Classes button might not need locking if it's just informational
        }

        // --- Data Saving ---
        function salvarDados(showNotificationFlag = true) { // Add flag to control notification display
            if (!currentFichaId || !fichas[currentFichaId]) {
                console.warn("Tentativa de salvar dados sem ficha válida selecionada.");
                return;
            }
            // Don't save if locked and not temporarily unlocked
            if (isFichaLocked && !isFichaUnlocked) {
                console.warn("Tentativa de salvar dados enquanto a ficha está bloqueada.");
                // Optionally open password modal if an input triggered this
                // abrirModalSenha(); // Be careful not to spam this
                return;
            }

            // Gather data from inputs
            const inventario = Array.from(inventarioSlots.querySelectorAll(".inventory-slot")).map(slot => ({
                item: slot.querySelector(".inventory-item").value.trim(),
                peso: slot.querySelector(".inventory-weight").value || "0"
            }));
            const magias = Array.from(magiasList.querySelectorAll(".magia-nome"))
                                  .map(input => input.value.trim())
                                  .filter(m => m); // Filter out empty strings before joining

            const dados = {
                nomePersonagem: nomePersonagemInput.value.trim(),
                descricaoPersonagem: descricaoPersonagemInput.value.trim(),
                forca: forcaInput.value || "0",
                destreza: destrezaInput.value || "0",
                agilidade: agilidadeInput.value || "0",
                inteligencia: inteligenciaInput.value || "0",
                constituicao: constituicaoInput.value || "0",
                experiencia: experienciaInput.value || "0",
                // Combat
                armaDireitaNome: armaDireitaNomeInput.value.trim(),
                armaDireitaAtaque: armaDireitaAtaqueInput.value || "0",
                armaDireitaAtaqueMagico: armaDireitaAtaqueMagicoInput.value || "0",
                armaEsquerdaNome: armaEsquerdaNomeInput.value.trim(),
                armaEsquerdaAtaque: armaEsquerdaAtaqueInput.value || "0",
                armaEsquerdaAtaqueMagico: armaEsquerdaAtaqueMagicoInput.value || "0",
                // Selections
                vantagens: vantagensSelecionadas.join("\n"),
                desvantagens: desvantagensSelecionadas.join("\n"),
                racaSelecionada: racaSelecionada || "", // Save internal name
                 racaNome: racaNomeSpan.textContent.startsWith('Clique') ? '' : racaNomeSpan.textContent, // Save display name if not placeholder
                 racaDescricao: racaDescricaoInput.value.trim(), // Save current description (might be edited)
                 // Classe
                 classeNome: classeNomeInput.value.trim(),
                 classeDescricao: classeDescricaoInput.value.trim(),
                 // Lists
                magiasHabilidades: magias.join("\n"),
                inventario: inventario,
                // Calculated (save the calculated values)
                velocidadeCorrida: velocidadeCorridaSpan.textContent,
                alturaPulo: alturaPuloSpan.textContent,
                distanciaPulo: distanciaPuloSpan.textContent,
                 // Current Resources (Important!)
                 vidaAtual: vidaAtual,
                 magiaAtual: magiaAtual,
                 vigorAtual: parseFloat(vigorAtual.toFixed(1)), // Ensure number is saved
                // Meta
                isLocked: isFichaLocked,
                password: fichaPassword,
                imagem: (characterImage.style.display === "block" && characterImage.src.startsWith('data:image')) ? characterImage.src : null,
                anotacoes: anotacoesTextarea.value.trim(),
                chatPassword: chatPassword,
                backgroundImage: document.body.style.backgroundImage === 'none' ? null : document.body.style.backgroundImage.match(/url\("?(.+?)"?\)/)?.[1] || null, // Extract URL
                backgroundSize: document.body.style.backgroundSize || 'cover'
            };

            // Update Firebase, use update instead of set to avoid overwriting unrelated data
            database.ref(`fichas/${currentFichaId}`).update(dados).then(() => {
                if (showNotificationFlag) {
                     showNotification("Salvo!", "save-success");
                }
                // Update previous values map after successful save
                 previousValues.clear();
                 document.querySelectorAll('input[type="text"],input[type="number"],textarea').forEach(input => {
                      previousValues.set(input.id, input.value);
                 });
                 previousValues.set('vantagensSelecionadas', [...vantagensSelecionadas]);
                 previousValues.set('desvantagensSelecionadas', [...desvantagensSelecionadas]);
                 previousValues.set('racaSelecionada', racaSelecionada);

            }).catch(error => {
                console.error("Erro ao salvar dados:", error);
                showNotification("Erro ao salvar!", "critical-failure");
            });
        }


        // --- Calculations ---
        function calcularNivel(exp) {
            // Find the highest level where required XP is met
            return nivelData.findLast(data => exp >= data.xp)?.nivel ?? 0; // Use nullish coalescing for default 0
        }

        function atualizarNivel() {
            nivelAnterior = nivel;
            nivel = calcularNivel(experiencia);
            nivelSpan.textContent = nivel;

            // Update total PD based on new level
            const nivelInfo = nivelData.find(data => data.nivel === nivel) || nivelData[0];
            pontosHabilidadeTotal = nivelInfo.pd;

            // Recalculate used PD and update display
            calcularPontosHabilidadeUsados(); // Moved calculation to separate function
            pontosHabilidadeSpan.textContent = pontosHabilidadeTotal - pontosHabilidadeUsados;

            // Update total PH and display current available PH
             // getPontosVantagem() uses the current 'nivel'
            pontosVantagemSpan.textContent = getPontosVantagem();

            // Visual feedback for level up
            if (nivel > nivelAnterior) {
                console.log(`Level Up! ${nivelAnterior} -> ${nivel}`);
                nivelSpan.classList.add("aura-azul");
                // Remove aura after animation finishes (assuming 10 iterations * 2s = 20s)
                setTimeout(() => nivelSpan.classList.remove("aura-azul"), 20000);
                 showNotification(`Level Up! Você alcançou o Nível ${nivel}!`, "critical-success");
            }

            // GM message display (adjust level if needed)
            gameMasterMessage.style.display = nivel >= 30 ? "block" : "none";
            fichaContainer.classList.toggle("aura-azul", nivel >= 30);

            // Recalculate attributes as HP depends on level
            calcularAtributos();
        }

         function calcularPontosHabilidadeUsados() {
            pontosHabilidadeUsados = (parseInt(forcaInput.value) || 0) +
                                    (parseInt(destrezaInput.value) || 0) +
                                    (parseInt(agilidadeInput.value) || 0) +
                                    (parseInt(inteligenciaInput.value) || 0) +
                                    (parseInt(constituicaoInput.value) || 0);
         }

        function getPontosVantagem() {
            const nivelInfo = nivelData.find(data => data.nivel === nivel) || nivelData[0];
            let ph = nivelInfo.ph; // Start with base PH for the level

            // Subtract cost of selected advantages
            vantagensSelecionadas.forEach(vNome => {
                const vantagem = vantagensData.find(d => d.nome === vNome);
                if (vantagem) ph -= vantagem.custo;
            });

            // Add gain from selected disadvantages
            desvantagensSelecionadas.forEach(dNome => {
                const desvantagem = desvantagensData.find(desv => desv.nome === dNome);
                if (desvantagem) ph += desvantagem.ganho;
            });

            // Subtract cost of selected race
            if (racaSelecionada) {
                const raca = racasData.find(r => r.nome === racaSelecionada);
                if (raca) ph -= raca.custo;
            }

            return ph;
        }

        function calcularPontosVantagemTemp() {
            // Same as getPontosVantagem but uses temp lists
             const nivelInfo = nivelData.find(data => data.nivel === nivel) || nivelData[0];
            let ph = nivelInfo.ph;

            tempVantagensSelecionadas.forEach(vNome => {
                const vantagem = vantagensData.find(d => d.nome === vNome);
                if (vantagem) ph -= vantagem.custo;
            });
            tempDesvantagensSelecionadas.forEach(dNome => {
                const desvantagem = desvantagensData.find(desv => desv.nome === dNome);
                if (desvantagem) ph += desvantagem.ganho;
            });
            if (tempRacaSelecionada) { // Use tempRacaSelecionada
                const raca = racasData.find(r => r.nome === tempRacaSelecionada);
                if (raca) ph -= raca.custo;
            }
            return ph;
        }

        function calcularAtributos() {
             calcularPontosHabilidadeUsados(); // Update used PD count first

             // Check if PD limit is exceeded
            if (pontosHabilidadeUsados > pontosHabilidadeTotal) {
                 // Find the input that caused the overflow
                 // This is tricky, ideally check beforeinput event handler should prevent this
                 // As a fallback, just show error and don't update derived stats
                showNotification("Pontos de habilidade (PD) insuficientes!", "critical-failure");
                 // Revert the offending input? Hard to know which one it was here.
                 // The beforeinput handler is better suited for prevention.
                 // For now, just update the PD display to show the negative value
                 pontosHabilidadeSpan.textContent = pontosHabilidadeTotal - pontosHabilidadeUsados;
                 // Maybe disable saving?
                return; // Stop further calculation if invalid state
            }
             // Update PD display if valid
             pontosHabilidadeSpan.textContent = pontosHabilidadeTotal - pontosHabilidadeUsados;


            // Get base attributes
            const forca = parseInt(forcaInput.value) || 0,
                  destreza = parseInt(destrezaInput.value) || 0,
                  agilidade = parseInt(agilidadeInput.value) || 0,
                  inteligencia = parseInt(inteligenciaInput.value) || 0,
                  constituicao = parseInt(constituicaoInput.value) || 0;

            // --- Calculate Derived Attributes ---
            let ataque = forca + Math.floor(destreza / 5);
            let ataqueMagico = inteligencia;
            let acerto = Math.floor(destreza / 3) + Math.floor(agilidade / 10);
            let esquiva = Math.floor(agilidade / 3);
            let rdf = Math.floor(forca / 5);
            let rdm = Math.floor(inteligencia / 5);

            // Add weapon bonuses
            ataque += (parseInt(armaDireitaAtaqueInput.value) || 0) + (parseInt(armaEsquerdaAtaqueInput.value) || 0);
            ataqueMagico += (parseInt(armaDireitaAtaqueMagicoInput.value) || 0) + (parseInt(armaEsquerdaAtaqueMagicoInput.value) || 0);

             // Apply Advantage bonuses (Example: Maestria com Armas Curtas)
             if (vantagensSelecionadas.includes("Maestria com Armas curtas (2)")) {
                 // Assuming player *is* using a short weapon (needs game logic/UI to determine)
                 // For simplicity here, we might apply it generally or require manual adjustment
                  // ataque += 1; // Example - apply conditionally based on equipped weapon type
                  // acerto += 1; // Example - apply conditionally
             }
             if (vantagensSelecionadas.includes("Maestria com armas pesadas (2)")) {
                 // ataque += 2; // Example - apply conditionally
             }
              if (vantagensSelecionadas.includes("Maestria com armas de longo alcance (2)")) {
                 // acerto += 2; // Example - apply conditionally
             }


            // Update derived attribute spans
            ataqueSpan.textContent = ataque;
            ataqueMagicoSpan.textContent = ataqueMagico;
            acertoSpan.textContent = acerto;
            esquivaSpan.textContent = esquiva;
            rdfSpan.textContent = rdf;
            rdmSpan.textContent = rdm;

             // --- Calculate Resources ---
            // Vida: 50 + (CON * (3 + FOR/10)) + 10 * Nível
            vidaBase = 50 + (constituicao * (3 + Math.floor(forca / 10))) + (10 * nivel);
            // Magia: 20 + 3*CON + (CON * INT/10 if INT >= 10)
            let magiaBase = 20 + 3 * constituicao;
            if (inteligencia >= 10) {
                magiaBase += constituicao * Math.floor(inteligencia / 10);
            }
            // Vigor: 10 + 0.4*CON
            let vigorBase = 10 + 0.4 * constituicao;

            // Round totals
            vidaTotal = Math.max(1, Math.ceil(vidaBase)); // Ensure at least 1 HP
            magiaTotal = Math.ceil(magiaBase);
            vigorTotal = parseFloat(vigorBase.toFixed(1));

            // Update total spans
            document.getElementById("vida-total").textContent = vidaTotal;
            document.getElementById("magia-total").textContent = magiaTotal;
            document.getElementById("vigor-total").textContent = vigorTotal.toFixed(1);

            // Clamp current values to new totals
            vidaAtual = Math.min(vidaAtual, vidaTotal);
            magiaAtual = Math.min(magiaAtual, magiaTotal);
            vigorAtual = Math.min(vigorAtual, vigorTotal);

             // Update current value spans immediately after clamping
             document.getElementById("vida-atual").textContent = vidaAtual;
             document.getElementById("magia-atual").textContent = magiaAtual;
             document.getElementById("vigor-atual").textContent = vigorAtual.toFixed(1);

            // --- Calculate Regeneration ---
            const regeneracaoVida = (0.2 * constituicao).toFixed(1);
            const regeneracaoMagia = (0.8 * constituicao).toFixed(1);
            const regeneracaoVigor = (0.4 * constituicao).toFixed(1);
            document.getElementById("regeneracao-vida").textContent = regeneracaoVida;
            document.getElementById("regeneracao-magia").textContent = regeneracaoMagia;
            document.getElementById("regeneracao-vigor").textContent = regeneracaoVigor;

            // --- Calculate Locomotion ---
            const velocidadeBase = 25 + Math.floor(agilidade / 3) * 3;
            const alturaPuloBase = 1 + Math.floor(forca / 10);
            // Distância = 3 + 3 * min(FOR/5, AGI/5)
            const distanciaPuloBase = 3 + 3 * Math.min(Math.floor(forca / 5), Math.floor(agilidade / 5));

            // Apply Combo Físico bonus if selected
            let bonusVelocidade = 0, bonusAlturaPulo = 0, bonusDistanciaPulo = 0;
            if (vantagensSelecionadas.includes("Combo Físico (4)")) {
                bonusVelocidade = 25; // Adds +25 km/h to the base
                bonusAlturaPulo = 2; // Adds +2 m to the base
                bonusDistanciaPulo = 6; // Adds +6 m to the base
            }

            velocidadeCorridaSpan.textContent = velocidadeBase + bonusVelocidade;
            alturaPuloSpan.textContent = alturaPuloBase + bonusAlturaPulo;
            distanciaPuloSpan.textContent = distanciaPuloBase + bonusDistanciaPulo;


            // --- Visual Highlights ---
            const atributosDerivados = [
                { span: ataqueSpan, valor: ataque },
                { span: ataqueMagicoSpan, valor: ataqueMagico },
                { span: acertoSpan, valor: acerto },
                { span: esquivaSpan, valor: esquiva },
                { span: rdfSpan, valor: rdf },
                { span: rdmSpan, valor: rdm }
            ];
            // Remove existing highlights
            atributosDerivados.forEach(a => a.span.classList.remove("atributo-fogo"));
            // Find the max value (ignore 0)
            const maxAtributo = atributosDerivados.reduce((max, current) =>
                (current.valor > 0 && current.valor > max.valor) ? current : max, { valor: 0 });
            // Apply highlight if a max value > 0 was found
            if (maxAtributo.valor > 0) {
                maxAtributo.span.classList.add("atributo-fogo");
            }
        }

        // --- Resource Adjustments (+/- buttons) ---
        function aumentarVida() {
            if (vidaAtual < vidaTotal) {
                vidaAtual++;
                document.getElementById("vida-atual").textContent = vidaAtual;
                salvarDados(false); // Save without showing notification
            }
        }
        function diminuirVida() {
            if (vidaAtual > 0) { // Can go to 0
                vidaAtual--;
                document.getElementById("vida-atual").textContent = vidaAtual;
                salvarDados(false);
            }
        }
        function aumentarMagia() {
            if (magiaAtual < magiaTotal) {
                magiaAtual++;
                document.getElementById("magia-atual").textContent = magiaAtual;
                salvarDados(false);
            }
        }
        function diminuirMagia() {
            if (magiaAtual > 0) {
                magiaAtual--;
                document.getElementById("magia-atual").textContent = magiaAtual;
                salvarDados(false);
            }
        }
        function aumentarVigor() {
            if (vigorAtual < vigorTotal) {
                vigorAtual = Math.min(vigorAtual + 0.1, vigorTotal); // Increase by 0.1
                document.getElementById("vigor-atual").textContent = vigorAtual.toFixed(1);
                salvarDados(false);
            }
        }
        function diminuirVigor() {
            if (vigorAtual > 0) {
                vigorAtual = Math.max(vigorAtual - 0.1, 0); // Decrease by 0.1, floor at 0
                document.getElementById("vigor-atual").textContent = vigorAtual.toFixed(1);
                salvarDados(false);
            }
        }

        // --- Locking / Unlocking ---
        function atualizarBotaoBloquear() {
            if (isFichaLocked) {
                bloquearFichaButton.textContent = "Desbloquear Ficha";
                bloquearFichaButton.classList.remove("botao-bloquear");
                bloquearFichaButton.classList.add("botao-desbloquear");
                 bloquearFichaButton.title = "Clique para desbloquear a ficha";
            } else {
                bloquearFichaButton.textContent = "Bloquear Ficha";
                bloquearFichaButton.classList.remove("botao-desbloquear");
                bloquearFichaButton.classList.add("botao-bloquear");
                 bloquearFichaButton.title = "Clique para definir uma senha e bloquear a ficha";
            }
        }

        bloquearFichaButton.onclick = () => {
            if (isFichaLocked) {
                abrirModalSenha(); // Open password prompt to unlock
            } else {
                 // Open modal to set password
                 // First, check for too many disadvantages
                 if (desvantagensSelecionadas.length > 3) {
                     showNotification("Remova desvantagens! Máximo de 3 permitido para bloquear.", "critical-failure");
                     return;
                 }
                document.getElementById("bloquear-ficha-modal").style.display = "flex";
                document.getElementById("senha-bloqueio-input").value = "";
                document.getElementById("senha-bloqueio-input").focus();
            }
        };

        function bloquearFicha() {
            const senhaInput = document.getElementById("senha-bloqueio-input");
            const senha = senhaInput.value;
            if (!/^\d{4}$/.test(senha)) { // Validate 4 digits
                 showNotification("A senha deve ter exatamente 4 dígitos numéricos!", "critical-failure");
                 senhaInput.focus(); // Keep focus on input
                return;
            }
             // Double check disadvantage count again before saving
             if (desvantagensSelecionadas.length > 3) {
                 showNotification("Remova desvantagens! Máximo de 3 permitido para bloquear.", "critical-failure");
                 fecharModal("bloquear-ficha-modal");
                 return;
             }

            isFichaLocked = true;
            fichaPassword = senha;
            isFichaUnlocked = false; // Ensure temporary unlock is off

            // Save lock state and password to Firebase
            database.ref(`fichas/${currentFichaId}`).update({
                isLocked: true,
                password: senha
            }).then(() => {
                fecharModal("bloquear-ficha-modal");
                showNotification("Ficha bloqueada com sucesso!", "save-success");
                atualizarBotaoBloquear();
                 setCamposReadonly(true); // Apply readonly styles
            }).catch(error => {
                console.error("Erro ao bloquear ficha:", error);
                showNotification("Erro ao bloquear ficha.", "critical-failure");
            });
        }

        function abrirModalSenha(elementRequestingUnlock = null) {
             // Store the element that triggered the unlock request, if any
             const modal = document.getElementById("password-modal");
             if (elementRequestingUnlock) {
                 modal.dataset.elementId = elementRequestingUnlock.id; // Store ID
             } else {
                 delete modal.dataset.elementId; // Clear if no specific element
             }

            modal.style.display = "flex";
            document.getElementById("senha-desbloqueio-input").value = "";
            document.getElementById("senha-desbloqueio-input").focus();
        }

        function desbloquearFicha() {
            const senhaInput = document.getElementById("senha-desbloqueio-input");
            const senha = senhaInput.value;
             const modal = document.getElementById("password-modal");
             const elementIdRequesting = modal.dataset.elementId; // Get requesting element ID

            // Check against both ficha password and GM password
            if (senha !== fichaPassword && senha !== senhaMatriz) {
                showNotification("Senha incorreta!", "critical-failure");
                senhaInput.focus(); // Keep focus
                senhaInput.select(); // Select text for easy re-entry
                return;
            }

            fecharModal("password-modal"); // Close modal on success

            if (senha === senhaMatriz && currentFichaId !== "ficha-matriz") {
                // GM password used on a non-matriz ficha -> Temporary Unlock
                isFichaUnlocked = true; // Set temporary unlock flag
                 showNotification("Ficha desbloqueada temporariamente (Senha GM)!", "save-success");
                 // DO NOT change isFichaLocked or save to Firebase here
                 setCamposReadonly(false); // Allow editing

                 // If a specific action triggered the unlock, perform it now
                 handlePostUnlockAction(elementIdRequesting);

            } else {
                 // Correct ficha password (or GM password on Matriz) -> Permanent Unlock
                 isFichaLocked = false;
                 fichaPassword = null; // Clear password
                 isFichaUnlocked = false; // Ensure temp unlock is off

                 database.ref(`fichas/${currentFichaId}`).update({
                     isLocked: false,
                     password: null
                 }).then(() => {
                     showNotification("Ficha desbloqueada permanentemente!", "save-success");
                     atualizarBotaoBloquear();
                     setCamposReadonly(false); // Allow editing

                      // If a specific action triggered the unlock, perform it now
                      handlePostUnlockAction(elementIdRequesting);

                 }).catch(error => {
                     console.error("Erro ao desbloquear ficha:", error);
                     showNotification("Erro ao salvar desbloqueio.", "critical-failure");
                 });
            }
             // Clear the requesting element ID from the modal dataset
             delete modal.dataset.elementId;
        }

         function handlePostUnlockAction(elementId) {
              if (!elementId) return; // No specific action requested

              console.log("Handling post-unlock action for:", elementId);
              const element = document.getElementById(elementId);
              if (!element) return;

              // Perform action based on the element ID
              if (elementId === "reset-pontos") {
                  resetarPontos(true); // Pass flag to skip password check
              } else if (elementId === "recomecar") {
                  recomecarFicha(true); // Pass flag to skip password check
              } else if (elementId === "excluir-ficha") {
                   // Re-trigger exclusion logic now that it's unlocked
                   document.getElementById("excluir-ficha").onclick();
              }
              // Add more actions here if needed for other locked elements
              // e.g., re-enabling a specific input that was focused before lock
              else if (element.tagName === 'INPUT' || element.tagName === 'TEXTAREA') {
                  // Maybe focus the element again?
                  element.focus();
              }
         }

        function cancelarDesbloqueio() {
            const modal = document.getElementById("password-modal");
            const elementIdRequesting = modal.dataset.elementId;

            // If an input triggered the lock, revert its value
            if (elementIdRequesting) {
                 const element = document.getElementById(elementIdRequesting);
                 const originalValue = previousValues.get(elementIdRequesting);
                 if (element && (element.tagName === 'INPUT' || element.tagName === 'TEXTAREA') && originalValue !== undefined) {
                     element.value = originalValue;
                 }
                 // Clear the requesting element ID
                 delete modal.dataset.elementId;
            }
            fecharModal("password-modal");
        }

        // --- Input Handling & Saving Trigger ---
         function handleInputChange(event) {
             const input = event.target;
             const inputId = input.id;

             // 1. Check Lock State
             if (isFichaLocked && !isFichaUnlocked) {
                 // Find the original value before the change attempt
                 const originalValue = previousValues.get(inputId);
                 if (input.value !== originalValue) {
                     input.value = originalValue; // Revert change immediately
                     abrirModalSenha(input); // Request password
                 }
                 return; // Stop further processing
             }

             // 2. Handle Specific Input Logic (if unlocked or never locked)
             if (inputId === "experiencia") {
                 const newExperiencia = parseInt(input.value) || 0;
                 if (newExperiencia !== experiencia) {
                     experiencia = newExperiencia;
                     atualizarNivel(); // This also calls calcularAtributos
                 }
             } else if (atributosInputs.some(attrInput => attrInput.id === inputId)) {
                  // Check PD before confirming the change
                  const tempForca = parseInt(forcaInput.value) || 0;
                  const tempDestreza = parseInt(destrezaInput.value) || 0;
                  const tempAgilidade = parseInt(agilidadeInput.value) || 0;
                  const tempInteligencia = parseInt(inteligenciaInput.value) || 0;
                  const tempConstituicao = parseInt(constituicaoInput.value) || 0;
                  const tempTotalPontos = tempForca + tempDestreza + tempAgilidade + tempInteligencia + tempConstituicao;

                  if (tempTotalPontos > pontosHabilidadeTotal) {
                      showNotification("Pontos de habilidade (PD) insuficientes!", "critical-failure");
                      input.value = previousValues.get(inputId) || "0"; // Revert this specific input
                      // Recalculate used points based on potentially reverted value
                       calcularPontosHabilidadeUsados();
                       pontosHabilidadeSpan.textContent = pontosHabilidadeTotal - pontosHabilidadeUsados;
                      return; // Stop processing if invalid
                  }
                  // If valid, proceed to calculate all attributes
                 calcularAtributos();
             } else if (inputId.includes("arma")) {
                 // Weapon stats changed, recalculate
                 calcularAtributos();
             } else if (input.classList.contains('inventory-weight') || input.classList.contains('inventory-item')) {
                 calcularPesoTotal(); // Recalculate inventory weight
             }

             // 3. Debounced Save
             debouncedSalvarDados();

             // 4. Update previous value map *after* validation and processing
             // Do this even if save is debounced, so next change compares correctly
             previousValues.set(inputId, input.value);
         }

        // Debounce function
        let saveTimeout;
        function debounce(func, delay) {
            return function(...args) {
                clearTimeout(saveTimeout);
                saveTimeout = setTimeout(() => {
                    func.apply(this, args);
                }, delay);
            };
        }

        // Create a debounced version of salvarDados
        const debouncedSalvarDados = debounce(salvarDados, 1000); // Save 1 second after last input change

        // Add 'input' event listeners to relevant fields
        document.querySelectorAll(
            'input[type="text"]:not(#mensagem-input):not(#nome-ficha-input):not(#senha-bloqueio-input):not(#senha-desbloqueio-input):not(#senha-gm-input):not(#chat-senha-input):not(#chat-confirmar-senha-input):not(#abrir-chat-senha-input):not(#editar-raca-nome), ' + // Exclude modal inputs
            'input[type="number"], ' +
            'textarea:not(#anotacoes-textarea):not(#editar-raca-descricao)' // Allow separate saving for annotations
            ).forEach(input => {
            input.addEventListener('input', handleInputChange);
             // Store initial value on focus for comparison on blur/beforeinput (optional)
             input.addEventListener('focus', (e) => {
                 if (!previousValues.has(e.target.id)) { // Only store if not already set by load/save
                      previousValues.set(e.target.id, e.target.value);
                 }
             });
        });

        // Special handling for annotations - save immediately on input
        anotacoesTextarea.addEventListener('input', () => {
             if (isFichaLocked && !isFichaUnlocked) {
                  // Allow editing annotations even if locked? Current design allows.
                  // If locking is desired, add check here.
             }
             // Save annotations more frequently or immediately if desired
             debounce(salvarDados, 500)(); // Shorter debounce for annotations
        });


        // --- Image Handling ---
        characterImageInput.onchange = e => {
            if (isFichaLocked && !isFichaUnlocked) {
                 abrirModalSenha(characterImageInput); // Pass element for context
                 e.target.value = null; // Clear the file input
                 return;
            }
            const file = e.target.files[0];
            if (file) {
                 if (file.size > 1 * 1024 * 1024) { // Limit file size (e.g., 1MB)
                     showNotification("Imagem muito grande (máx 1MB).", "critical-failure");
                     e.target.value = null; // Clear the file input
                     return;
                 }
                 const reader = new FileReader();
                 reader.onload = event => {
                     characterImage.src = event.target.result;
                     characterImage.style.display = "block";
                     salvarDados(); // Save immediately after image load
                 };
                 reader.onerror = error => {
                     console.error("Erro ao ler imagem:", error);
                     showNotification("Erro ao carregar imagem.", "critical-failure");
                 };
                 reader.readAsDataURL(file);
            }
        };

        // --- Dice Rolling ---
        let isDragging = false,
            currentX, currentY, initialX, initialY;

         // Load dice position from localStorage if available
         const savedDicePos = localStorage.getItem('dicePosition');
         if (savedDicePos) {
             const pos = JSON.parse(savedDicePos);
             diceContainer.style.left = `${pos.x}px`;
             diceContainer.style.top = `${pos.y}px`;
             diceContainer.style.right = "auto"; // Ensure right is not set
             currentX = pos.x;
             currentY = pos.y;
         } else {
             // Default position if not saved (using CSS initial position)
             currentX = diceContainer.offsetLeft;
             currentY = diceContainer.offsetTop;
         }


        diceContainer.onmousedown = e => {
             // Prevent drag on inputs/buttons inside the container if any were added
             if (e.target !== diceContainer && e.target !== diceRoll && e.target.parentElement !== diceContainer) return;

            isDragging = true;
             // Calculate initial offset relative to the viewport
            initialX = e.clientX - diceContainer.getBoundingClientRect().left;
            initialY = e.clientY - diceContainer.getBoundingClientRect().top;
            diceContainer.style.cursor = "grabbing";
            diceContainer.style.transition = 'none'; // Disable transition during drag
        };

        document.onmousemove = e => {
            if (isDragging) {
                e.preventDefault();
                 // Calculate new position based on viewport coordinates
                 currentX = e.clientX - initialX;
                 currentY = e.clientY - initialY;

                 // Clamp position within viewport bounds (optional)
                 const vpWidth = window.innerWidth;
                 const vpHeight = window.innerHeight;
                 const diceWidth = diceContainer.offsetWidth;
                 const diceHeight = diceContainer.offsetHeight;

                 currentX = Math.max(0, Math.min(currentX, vpWidth - diceWidth));
                 currentY = Math.max(0, Math.min(currentY, vpHeight - diceHeight));


                diceContainer.style.left = `${currentX}px`;
                diceContainer.style.top = `${currentY}px`;
                diceContainer.style.right = "auto"; // Ensure right doesn't interfere
            }
        };

        document.onmouseup = () => {
            if (isDragging) {
                isDragging = false;
                diceContainer.style.cursor = "move";
                 diceContainer.style.transition = ''; // Re-enable transition if needed

                 // Save the final position
                 localStorage.setItem('dicePosition', JSON.stringify({ x: currentX, y: currentY }));
            }
        };

         // --- Dice Roll History Listener ---
         database.ref('dadosRolados').on('child_added', snapshot => {
             try { // Add try-catch for safety
                 const dado = snapshot.val();
                 if (!dado || !dado.nomeFicha) return; // Basic validation

                 // Add to history panel
                 const div = document.createElement("div");
                 div.textContent = `${dado.nomeFicha} rolou: ${dado.resultado}`;
                  // Add timestamp?
                  // const timestamp = new Date(dado.timestamp || Date.now()).toLocaleTimeString();
                  // div.textContent += ` (${timestamp})`;
                 historicoLista.insertBefore(div, historicoLista.firstChild); // Add to top

                 // Optionally prune history if it gets too long
                 const maxHistory = 50;
                 while (historicoLista.children.length > maxHistory) {
                     historicoLista.removeChild(historicoLista.lastChild);
                 }

                 // Show notification only if it's NOT the current user's roll
                 if (dado.fichaId !== currentFichaId) {
                      let notificationType = "normal-result";
                      if (dado.resultado === 1) notificationType = "critical-failure";
                      else if (dado.resultado === 20) notificationType = "critical-success";
                     showNotification(`${dado.nomeFicha} rolou: ${dado.resultado}`, notificationType);
                 }
             } catch (error) {
                 console.error("Erro ao processar rolagem de dado do histórico:", error);
             }
         });

        diceRoll.onclick = () => {
            if (isFichaLocked && !isFichaUnlocked) {
                abrirModalSenha(diceRoll);
                return;
            }
            // Prevent rapid clicking
            if (diceRoll.classList.contains('rolling')) return;

            diceRoll.classList.add('rolling');
            diceRoll.textContent = "🎲"; // Rolling animation/placeholder
            diceResult.style.display = "none";
            diceRoll.classList.remove("critical-failure", "critical-success");
            notification.style.display = "none"; // Hide previous notification

            // Simulate rolling animation
            let rollCount = 0;
            const rollInterval = setInterval(() => {
                diceRoll.textContent = Math.floor(Math.random() * 20) + 1;
                rollCount++;
                if (rollCount >= 10) { // Stop animation after ~1 second
                    clearInterval(rollInterval);
                    performFinalRoll();
                }
            }, 100);


        };

         function performFinalRoll() {
             const roll = Math.floor(Math.random() * 20) + 1;
             const fichaNome = fichas[currentFichaId]?.nomeFicha || "Sem Nome";

             diceRoll.textContent = roll;
             diceRoll.classList.remove('rolling');

             let notificationText = `${fichaNome} rolou: ${roll}`;
             let notificationType = "normal-result";

             if (roll === 1) {
                 diceRoll.classList.add("critical-failure");
                 notificationText = `${fichaNome} - FALHA CRÍTICA! (${roll})`;
                 notificationType = "critical-failure";
             } else if (roll === 20) {
                 diceRoll.classList.add("critical-success");
                 notificationText = `${fichaNome} - SUCESSO CRÍTICO! (${roll})`;
                 notificationType = "critical-success";
             } else {
                 diceResult.textContent = `Resultado: ${roll}`; // Display below die
                 diceResult.style.display = "block";
             }

             showNotification(notificationText, notificationType);

             // Save roll to Firebase database
             const dadoRef = database.ref('dadosRolados').push();
             dadoRef.set({
                 fichaId: currentFichaId,
                 nomeFicha: fichaNome,
                 resultado: roll,
                 timestamp: firebase.database.ServerValue.TIMESTAMP // Add timestamp
             }).catch(error => console.error("Erro ao salvar rolagem:", error));
         }

        // --- Vantagens / Desvantagens Panel ---
        vantagensDesvantagensBtn.onclick = () => {
            // Lock check already happens in setCamposReadonly which disables the button
            // if (isFichaLocked && !isFichaUnlocked) return abrirModalSenha(vantagensDesvantagensBtn);

            // Copy current selections to temporary ones for editing
            tempVantagensSelecionadas = [...vantagensSelecionadas];
            tempDesvantagensSelecionadas = [...desvantagensSelecionadas];
             // Use the currently selected race for PH calculation in the panel
             tempRacaSelecionada = racaSelecionada; // Sync temp race for calculation

            vantagensDesvantagensPanel.style.display = "block";
            salvarVantagensBtn.style.display = "none"; // Hide save button initially
            atualizarVantagensDesvantagensPanel(); // Populate the panel
        };

        fecharPaginaBtn.onclick = () => {
            vantagensDesvantagensPanel.style.display = "none";
             // Discard temporary changes
             tempVantagensSelecionadas = [];
             tempDesvantagensSelecionadas = [];
        };

        salvarVantagensBtn.onclick = () => {
             // Open confirmation modal
            salvarVantagensModal.style.display = "flex";
        };

         // Combined handler for saving V/D or Race from the confirmation modal
         confirmarSalvarVantagensBtn.onclick = () => {
              // Determine if we are saving V/D or Race based on which panel is open
              // (This assumes only one of the save buttons is active at a time)

              if (vantagensDesvantagensPanel.style.display === "block") {
                  // --- Saving Vantagens/Desvantagens ---
                  // Final validation before saving
                  if (tempDesvantagensSelecionadas.length > 3) {
                      showNotification("Máximo de 3 desvantagens permitido!", "critical-failure");
                      fecharModal("salvar-vantagens-modal"); // Close confirmation
                      return; // Stay in the panel
                  }

                  // Apply changes: copy temp lists to main lists
                  vantagensSelecionadas = [...tempVantagensSelecionadas];
                  desvantagensSelecionadas = [...tempDesvantagensSelecionadas];

                  // Update the main character sheet display
                  atualizarVantagensDesvantagensDisplay();

                  // Update available PH points on the main sheet
                  pontosVantagemSpan.textContent = getPontosVantagem();

                  // Save all ficha data to Firebase
                  salvarDados();

                  // Close the confirmation modal
                  fecharModal("salvar-vantagens-modal");
                  // Close the V/D panel <<-- ADDED
                  vantagensDesvantagensPanel.style.display = "none";

                  // Recalculate attributes in case V/D affected them (e.g., Combo Físico)
                  calcularAtributos();

                  showNotification("Vantagens/Desvantagens salvas!", "save-success");

              } else if (racasPanel.style.display === "block") {
                    // --- Saving Race ---
                    if (tempRacaSelecionada && tempRacaSelecionada !== racaSelecionada) {
                         // Find the race data
                         const raca = racasData.find(r => r.nome === tempRacaSelecionada);
                         if (raca) {
                             // Apply the change
                             racaSelecionada = tempRacaSelecionada;
                             racaNomeSpan.textContent = raca.nome.split(" (")[0]; // Update display name
                             racaDescricaoInput.value = raca.vantagens.join("\n\n"); // Update description

                             // Update PH points
                             pontosVantagemSpan.textContent = getPontosVantagem();

                             // Save all data
                             salvarDados();

                             // Close confirmation modal
                             fecharModal("salvar-vantagens-modal");
                             // Close the Race panel <<-- ADDED
                             racasPanel.style.display = "none";

                             showNotification("Raça salva!", "save-success");
                         } else {
                              console.error("Raça selecionada temporariamente não encontrada nos dados:", tempRacaSelecionada);
                              fecharModal("salvar-vantagens-modal");
                         }
                    } else {
                         // No change in race, just close modals
                         fecharModal("salvar-vantagens-modal");
                         racasPanel.style.display = "none"; // Close panel even if no change saved
                    }
              } else {
                  // Should not happen, but close confirmation just in case
                   console.warn("Botão de salvar V/D clicado, mas nenhum painel relevante estava aberto.");
                   fecharModal("salvar-vantagens-modal");
              }
         };


        function atualizarVantagensDesvantagensPanel() {
            vantagensList.innerHTML = "<h3>Vantagens Disponíveis</h3>";
            desvantagensList.innerHTML = "<h3>Desvantagens Disponíveis</h3>";

            const currentPH = calcularPontosVantagemTemp(); // Calculate based on temp selections
            phTempSpan.textContent = currentPH; // Update display

            // Populate Vantagens
            vantagensData.forEach(v => {
                const div = document.createElement("div");
                div.className = "vantagem-item";
                 // Add title for full description
                 div.title = v.descricao || 'Sem descrição detalhada.';
                 div.innerHTML = `<strong>${v.nome}</strong> <span class="text-sm text-gray-600">(-${v.custo} PH)</span><br><span class="text-xs">${v.descricao}</span>`;

                 const isSelectedTemp = tempVantagensSelecionadas.includes(v.nome);
                 const isSelectedSaved = vantagensSelecionadas.includes(v.nome);
                 const isDisabled = (v.restricao === "inicio" && nivel > 0) || (currentPH < v.custo && !isSelectedTemp);

                 if (isSelectedTemp) {
                     div.classList.add("comprada"); // Visually mark as selected
                 }
                 if (isDisabled && !isSelectedTemp) {
                      div.style.opacity = "0.5";
                      div.style.cursor = "not-allowed";
                      div.title += isDisabled ? ` (Indisponível: ${v.restricao === "inicio" ? 'Nível > 0' : 'PH insuficiente'})` : '';
                 }
                 if (isSelectedSaved && !isSelectedTemp) {
                      // If it was saved but deselected in this session
                      div.style.textDecoration = 'line-through';
                      div.title += ' (Removido nesta sessão)';
                 }


                div.onclick = () => {
                     if (isDisabled && !isSelectedTemp) {
                         showNotification(`Indisponível: ${v.restricao === "inicio" ? 'Apenas no Nível 0' : 'PH insuficiente'}`, "critical-failure");
                         return;
                     }
                     // Allow deselecting only if it wasn't saved before
                     if (isSelectedTemp && !isSelectedSaved) {
                         tempVantagensSelecionadas = tempVantagensSelecionadas.filter(t => t !== v.nome);
                         salvarVantagensBtn.style.display = "block"; // Show save button on change
                         atualizarVantagensDesvantagensPanel(); // Refresh panel
                     }
                     // Allow selecting if not already selected (temp or saved)
                     else if (!isSelectedTemp && !isSelectedSaved) {
                         tempVantagensSelecionadas.push(v.nome);
                         salvarVantagensBtn.style.display = "block";
                         atualizarVantagensDesvantagensPanel();
                     }
                     // If it IS already saved, don't allow toggling here (needs GM)
                     else if (isSelectedSaved) {
                          showNotification("Remoção de Vantagens salvas requer permissão do GM na ficha principal.", "normal-result");
                     }
                };
                vantagensList.appendChild(div);
            });

            // Populate Desvantagens
            desvantagensData.forEach(d => {
                const div = document.createElement("div");
                div.className = "desvantagem-item";
                div.title = d.descricao || 'Sem descrição detalhada.';
                div.innerHTML = `<strong>${d.nome}</strong> <span class="text-sm text-green-700">(+${d.ganho} PH)</span><br><span class="text-xs">${d.descricao}</span>`;

                const isSelectedTemp = tempDesvantagensSelecionadas.includes(d.nome);
                const isSelectedSaved = desvantagensSelecionadas.includes(d.nome);
                 // Can add disadvantage if limit not reached
                 const isDisabled = (tempDesvantagensSelecionadas.length >= 3 && !isSelectedTemp);

                if (isSelectedTemp) {
                    div.classList.add("comprada"); // Use 'comprada' class for red styling
                }
                 if (isDisabled && !isSelectedTemp) {
                      div.style.opacity = "0.5";
                      div.style.cursor = "not-allowed";
                      div.title += ' (Limite de 3 desvantagens atingido)';
                 }
                  if (isSelectedSaved && !isSelectedTemp) {
                      div.style.textDecoration = 'line-through';
                       div.title += ' (Removido nesta sessão)';
                 }

                div.onclick = () => {
                     if (isDisabled && !isSelectedTemp) {
                         showNotification("Limite de 3 desvantagens atingido!", "critical-failure");
                         return;
                     }
                    // Allow deselecting only if it wasn't saved before
                    if (isSelectedTemp && !isSelectedSaved) {
                        tempDesvantagensSelecionadas = tempDesvantagensSelecionadas.filter(t => t !== d.nome);
                        salvarVantagensBtn.style.display = "block";
                        atualizarVantagensDesvantagensPanel();
                    }
                    // Allow selecting if not already selected and limit not reached
                    else if (!isSelectedTemp && !isSelectedSaved) {
                        tempDesvantagensSelecionadas.push(d.nome);
                        salvarVantagensBtn.style.display = "block";
                        atualizarVantagensDesvantagensPanel();
                    }
                    // If it IS already saved, don't allow toggling here (needs GM)
                     else if (isSelectedSaved) {
                          showNotification("Remoção de Desvantagens salvas requer permissão do GM na ficha principal.", "normal-result");
                     }
                };
                desvantagensList.appendChild(div);
            });
        }

        function removerVantagem(vNome) {
            // This function is called from the MAIN sheet display list item
             if (isFichaLocked && !isFichaUnlocked) {
                 abrirModalSenha(vantagensListDisplay); // Use list display as context
                 return;
             }
            if (confirm(`Deseja solicitar ao GM a remoção da vantagem "${vNome}"?`)) {
                document.getElementById("senha-gm-modal").style.display = "flex";
                document.getElementById("senha-gm-input").value = "";
                document.getElementById("senha-gm-input").focus();
                document.getElementById("confirmar-senha-gm-btn").onclick = () => {
                    const gmSenha = document.getElementById("senha-gm-input").value;
                    fecharModal("senha-gm-modal");
                    if (gmSenha === senhaMatriz) {
                        vantagensSelecionadas = vantagensSelecionadas.filter(v => v !== vNome); // Remove from main list
                        atualizarVantagensDesvantagensDisplay(); // Update display
                        pontosVantagemSpan.textContent = getPontosVantagem(); // Update PH
                        salvarDados(); // Save changes
                        calcularAtributos(); // Recalculate stats
                        showNotification(`Vantagem "${vNome}" removida!`, "save-success");
                    } else {
                        showNotification("Senha do GM incorreta! Remoção cancelada.", "critical-failure");
                    }
                };
            }
        }

        function removerDesvantagem(dNome) {
            // This function is called from the MAIN sheet display list item
            if (isFichaLocked && !isFichaUnlocked) {
                 abrirModalSenha(desvantagensListDisplay); // Use list display as context
                 return;
             }
             if (confirm(`Deseja solicitar ao GM a remoção da desvantagem "${dNome}"?`)) {
                 document.getElementById("senha-gm-modal").style.display = "flex";
                 document.getElementById("senha-gm-input").value = "";
                 document.getElementById("senha-gm-input").focus();
                 document.getElementById("confirmar-senha-gm-btn").onclick = () => {
                      const gmSenha = document.getElementById("senha-gm-input").value;
                      fecharModal("senha-gm-modal");
                      if (gmSenha === senhaMatriz) {
                          desvantagensSelecionadas = desvantagensSelecionadas.filter(d => d !== dNome);
                          atualizarVantagensDesvantagensDisplay();
                          pontosVantagemSpan.textContent = getPontosVantagem();
                          salvarDados();
                          calcularAtributos();
                          showNotification(`Desvantagem "${dNome}" removida!`, "save-success");
                      } else {
                          showNotification("Senha do GM incorreta! Remoção cancelada.", "critical-failure");
                      }
                 };
             }
        }


        // --- Raças Panel ---
        racasBtn.onclick = () => {
             // Lock check already handled by setCamposReadonly disabling button
            tempRacaSelecionada = racaSelecionada; // Copy current selection for editing
            tempVantagensSelecionadas = [...vantagensSelecionadas]; // Sync for PH calculation
            tempDesvantagensSelecionadas = [...desvantagensSelecionadas]; // Sync for PH calculation
            atualizarRacasPanel(); // Populate panel
            racasPanel.style.display = "block";
            salvarRacasBtn.style.display = "none"; // Hide save initially
        };

        fecharRacasBtn.onclick = () => {
            racasPanel.style.display = "none";
             // Discard temporary changes
             tempRacaSelecionada = null;
        };

        salvarRacasBtn.onclick = () => {
            // Use the same confirmation modal as V/D
             salvarVantagensModal.style.display = "flex";
        };
         // Saving logic is handled by confirmarSalvarVantagensBtn.onclick

        function atualizarRacasPanel() {
            racasList.innerHTML = ""; // Clear previous list
             const currentPH = calcularPontosVantagemTemp(); // Use temp lists for calculation
             // Display temp PH in the race panel? Optional.
             // const phDisplay = document.createElement('div');
             // phDisplay.className = 'text-center mb-4 font-bold font-medievalsharp';
             // phDisplay.textContent = `Pontos de Vantagem Temporários: ${currentPH}`;
             // racasList.appendChild(phDisplay);


            racasData.forEach(r => {
                const div = document.createElement("div");
                div.className = "raca-item";
                div.innerHTML = `<h3>${r.nome}</h3><p>${r.descricao}</p><p><strong>Vantagens:</strong></p><ul>${r.vantagens.map(v => `<li>${v}</li>`).join("")}</ul>`;

                 const isSelectedTemp = (tempRacaSelecionada === r.nome);
                 const isSelectedSaved = (racaSelecionada === r.nome);
                  // Disable if already saved a DIFFERENT race, or if PH insufficient
                 const isDisabled = (racaSelecionada && !isSelectedSaved) || (currentPH < r.custo && !isSelectedTemp);

                if (isSelectedTemp) {
                     div.classList.add("comprada"); // Highlight selected race
                 }
                 if (isDisabled && !isSelectedTemp) {
                     div.style.opacity = "0.5";
                     div.style.cursor = "not-allowed";
                     div.title = `Indisponível: ${racaSelecionada ? 'Outra raça já salva' : 'PH insuficiente'}`;
                 }
                 if (isSelectedSaved && !isSelectedTemp) {
                     // If it was saved but deselected in this session
                     div.style.textDecoration = 'line-through';
                     div.title = ' (Removido nesta sessão)';
                 }

                div.onclick = () => {
                     if (isDisabled && !isSelectedTemp) {
                         showNotification(`Indisponível: ${racaSelecionada ? 'Outra raça já salva (requer GM para mudar)' : 'PH insuficiente'}`, "critical-failure");
                         return;
                     }
                     // Allow deselecting only if it wasn't saved before
                     if (isSelectedTemp && !isSelectedSaved) {
                         tempRacaSelecionada = null; // Deselect
                         salvarRacasBtn.style.display = "block";
                         atualizarRacasPanel(); // Refresh panel
                     }
                     // Allow selecting if no race is saved and not already selected temp
                     else if (!isSelectedTemp && !isSelectedSaved && !racaSelecionada) {
                          // Open confirmation modal before selecting
                          confirmarCompraBtn.onclick = () => { // Set action for 'Sim' button
                              tempRacaSelecionada = r.nome; // Select the race
                              fecharModal('confirmar-compra-modal'); // Close this confirmation
                              salvarRacasBtn.style.display = "block"; // Show the main SAVE button
                              atualizarRacasPanel(); // Refresh panel to show selection
                          };
                          confirmarCompraModal.querySelector('h3').textContent = `Selecionar ${r.nome.split(' (')[0]}?`;
                          confirmarCompraModal.querySelector('p').textContent = `Custo: ${r.custo} PH. Confirma a seleção?`;
                          confirmarCompraModal.style.display = 'flex'; // Show confirmation
                     }
                      // If it IS already saved, don't allow toggling here (needs GM)
                     else if (isSelectedSaved) {
                           showNotification("Alteração de Raça salva requer permissão do GM na ficha principal.", "normal-result");
                     }
                };
                racasList.appendChild(div);
            });
        }

         // --- Race Editing/Deleting (from main sheet span click) ---
        function abrirModalRaca() {
            // Check lock state - clicking the span itself might be disabled by setCamposReadonly
             if (isFichaLocked && !isFichaUnlocked) {
                 // Although the span click might be disabled, double-check here
                  abrirModalSenha(racaNomeSpan); // Pass span as context
                  return;
             }
             // Only show options if a race is actually selected
             if (racaSelecionada) {
                 document.getElementById("raca-opcoes-modal").style.display = "flex";
             } else {
                 // If no race selected, go directly to the selection panel
                 racasBtn.onclick();
             }
        }

        function excluirRacaSelecionadaModal() {
             // Requires GM password
            fecharModal('raca-opcoes-modal');
            if (confirm(`Tem certeza que deseja solicitar ao GM a exclusão da raça "${racaNomeSpan.textContent}"?`)) {
                document.getElementById("senha-gm-modal").style.display = "flex";
                document.getElementById("senha-gm-input").value = "";
                document.getElementById("senha-gm-input").focus();
                document.getElementById("confirmar-senha-gm-btn").onclick = () => {
                    const gmSenha = document.getElementById("senha-gm-input").value;
                    fecharModal("senha-gm-modal");
                    if (gmSenha === senhaMatriz) {
                        const removedRaceName = racaNomeSpan.textContent;
                        racaSelecionada = null; // Clear internal selection
                        racaNomeSpan.textContent = "Clique para selecionar/editar"; // Reset display
                        racaDescricaoInput.value = ""; // Clear description
                        pontosVantagemSpan.textContent = getPontosVantagem(); // Update PH
                        salvarDados(); // Save changes
                        showNotification(`Raça "${removedRaceName}" excluída!`, "save-success");
                    } else {
                        showNotification("Senha do GM incorreta! Exclusão cancelada.", "critical-failure");
                    }
                };
            }
        }

        function editarRacaSelecionadaModal() {
             // Requires GM password
             fecharModal('raca-opcoes-modal');
             document.getElementById("senha-gm-modal").style.display = "flex";
             document.getElementById("senha-gm-input").value = "";
             document.getElementById("senha-gm-input").focus();
             document.getElementById("confirmar-senha-gm-btn").onclick = () => {
                 const gmSenha = document.getElementById("senha-gm-input").value;
                 // Don't close GM modal yet, need password for saving edit too
                 if (gmSenha === senhaMatriz) {
                     // Open the edit modal
                     document.getElementById("editar-raca-modal").style.display = "flex";
                     document.getElementById("editar-raca-nome").value = racaNomeSpan.textContent;
                     document.getElementById("editar-raca-descricao").value = racaDescricaoInput.value;
                 } else {
                      fecharModal("senha-gm-modal"); // Close GM modal if password wrong
                      showNotification("Senha do GM incorreta!", "critical-failure");
                 }
             };
        }

        function salvarEdicaoRaca() {
             // Called from the Edit Race Modal's Save button
             // Assumes GM password was already entered correctly to open this modal
              const newName = document.getElementById("editar-raca-nome").value.trim();
              const newDesc = document.getElementById("editar-raca-descricao").value.trim();

              if (!newName) {
                  showNotification("Nome da raça não pode ser vazio.", "critical-failure");
                  return;
              }

              racaNomeSpan.textContent = newName;
              racaDescricaoInput.value = newDesc;

              // Update internal racaSelecionada if name structure changed (e.g., cost removed)
              // This is tricky. Let's assume the GM knows how to format the name if they edit it.
              // If the base race changed, racaSelecionada might become invalid.
              // For simplicity, we just save the display name and description.
              // The *cost* associated might desync if the GM edits the name improperly.

              fecharModal('editar-raca-modal');
              fecharModal('senha-gm-modal'); // Close the GM modal now too
              salvarDados(); // Save the edited name and description
              showNotification("Edição da raça salva (GM)!", "save-success");
        }


        // --- Other Panels (Classes, History, Annotations) ---
        classesBtn.onclick = () => {
            classesPanel.style.display = "block";
            // TODO: Populate classesPanel with content if available
        };
        fecharClassesBtn.onclick = () => {
            classesPanel.style.display = "none";
        };

        historicoDadosBtn.onclick = () => {
            historicoDadosPanel.style.display = historicoDadosPanel.style.display === "block" ? "none" : "block";
        };
         // Close history panel if clicked outside
         document.addEventListener('click', function(event) {
             if (historicoDadosPanel.style.display === "block" && !historicoDadosPanel.contains(event.target) && !historicoDadosBtn.contains(event.target)) {
                 historicoDadosPanel.style.display = 'none';
             }
             // Close annotations panel if clicked outside
             if (anotacoesTextarea.style.display === "block" && !anotacoesTextarea.contains(event.target) && !anotacoesBtn.contains(event.target)) {
                 anotacoesTextarea.style.display = 'none';
             }
         });


        excluirHistoricoBtn.onclick = () => {
             // Requires GM password
             document.getElementById("senha-gm-modal").style.display = "flex";
             document.getElementById("senha-gm-input").value = "";
             document.getElementById("senha-gm-input").focus();
             document.getElementById("confirmar-senha-gm-btn").onclick = () => {
                 const gmSenha = document.getElementById("senha-gm-input").value;
                 fecharModal("senha-gm-modal");
                 if (gmSenha === senhaMatriz) {
                     database.ref('dadosRolados').remove().then(() => {
                         historicoLista.innerHTML = ""; // Clear display
                         showNotification("Histórico de dados excluído!", "save-success");
                     }).catch(error => {
                         console.error("Erro ao excluir histórico:", error);
                         showNotification("Erro ao excluir histórico.", "critical-failure");
                     });
                 } else {
                     showNotification("Senha do GM incorreta!", "critical-failure");
                 }
             };
        };

        anotacoesBtn.onclick = () => {
            anotacoesTextarea.style.display = anotacoesTextarea.style.display === "block" ? "none" : "block";
             if(anotacoesTextarea.style.display === "block") {
                 anotacoesTextarea.focus();
             }
        };

        // --- Magias/Habilidades Add Button ---
        adicionarMagiaBtn.onclick = () => {
             if (isFichaLocked && !isFichaUnlocked) {
                 abrirModalSenha(adicionarMagiaBtn);
                 return;
             }
             // Count currently visible inputs
             const visibleInputs = Array.from(magiasList.querySelectorAll(".magia-nome"))
                                       .filter(input => input.style.display !== 'none');

            if (visibleInputs.length < 20) {
                // Check if there's a hidden input we can reuse
                 const hiddenInput = Array.from(magiasList.querySelectorAll(".magia-nome"))
                                         .find(input => input.style.display === 'none');
                 if (hiddenInput) {
                      hiddenInput.style.display = 'block';
                      hiddenInput.placeholder = `Magia/Habilidade ${visibleInputs.length + 1}`;
                      hiddenInput.value = ''; // Clear value
                      hiddenInput.focus();
                 } else {
                      // If no hidden inputs, create a new one
                      const input = document.createElement("input");
                      input.type = "text";
                      input.className = "magia-nome";
                      input.placeholder = `Magia/Habilidade ${visibleInputs.length + 1}`;
                      magiasList.appendChild(input);
                      input.focus();
                 }
                salvarDados(false); // Save immediately without notification
            } else {
                showNotification("Limite de 20 magias/habilidades atingido!", "normal-result");
            }
        };


        // --- Dark Mode Toggle ---
        luaBtn.onclick = () => {
            document.body.classList.add("dark-mode");
             localStorage.setItem('darkMode', 'enabled'); // Save preference
        };
        solBtn.onclick = () => {
            document.body.classList.remove("dark-mode");
             localStorage.setItem('darkMode', 'disabled'); // Save preference
        };
         // Apply dark mode on load
         if (localStorage.getItem('darkMode') === 'enabled') {
             document.body.classList.add("dark-mode");
         }


        // --- Core Actions (Reset, Recomeçar) ---
        function resetarPontos(skipPasswordCheck = false) {
             if (!skipPasswordCheck && isFichaLocked && !isFichaUnlocked) {
                 abrirModalSenha(resetPontosButton);
                 return;
             }
            if (confirm("Tem certeza que deseja reiniciar os pontos de atributo? (Requer Senha GM)")) {
                document.getElementById("senha-gm-modal").style.display = "flex";
                document.getElementById("senha-gm-input").value = "";
                 document.getElementById("senha-gm-input").focus();
                document.getElementById("confirmar-senha-gm-btn").onclick = () => {
                    const gmSenha = document.getElementById("senha-gm-input").value;
                    fecharModal("senha-gm-modal");
                    if (gmSenha === senhaMatriz) {
                        atributosInputs.forEach(input => input.value = 0);
                         // Recalculate everything after resetting attributes
                         calcularAtributos();
                         // Save the reset state
                        salvarDados();
                        showNotification("Pontos de atributo reiniciados!", "save-success");
                    } else {
                        showNotification("Senha do GM incorreta! Reinício cancelado.", "critical-failure");
                    }
                };
            }
        }

        function recomecarFicha(skipPasswordCheck = false) {
             if (!skipPasswordCheck && isFichaLocked && !isFichaUnlocked) {
                 abrirModalSenha(recomecarButton);
                 return;
             }
            if (confirm("TEM CERTEZA que deseja RECOMEÇAR a ficha? TODAS as informações serão PERDIDAS e zeradas! (Requer Senha GM)")) {
                 document.getElementById("senha-gm-modal").style.display = "flex";
                 document.getElementById("senha-gm-input").value = "";
                 document.getElementById("senha-gm-input").focus();
                 document.getElementById("confirmar-senha-gm-btn").onclick = () => {
                     const gmSenha = document.getElementById("senha-gm-input").value;
                     fecharModal("senha-gm-modal");
                     if (gmSenha === senhaMatriz) {
                          // Reset basic info
                          nomePersonagemInput.value = "";
                          descricaoPersonagemInput.value = "";
                          nomePersonagemTitulo.textContent = "Ficha de Personagem";

                          // Reset attributes
                          atributosInputs.forEach(input => input.value = 0);

                          // Reset status
                          experienciaInput.value = 0;
                          experiencia = 0;
                          // Reset calculated values (will be recalculated by atualizarNivel/calcularAtributos)

                          // Reset combat
                          armaDireitaNomeInput.value = "";
                          armaDireitaAtaqueInput.value = "0";
                          armaDireitaAtaqueMagicoInput.value = "0";
                          armaEsquerdaNomeInput.value = "";
                          armaEsquerdaAtaqueInput.value = "0";
                          armaEsquerdaAtaqueMagicoInput.value = "0";

                          // Reset Magias/Habilidades
                           magiasList.querySelectorAll(".magia-nome").forEach((input, i) => {
                               input.value = "";
                               // Keep first 10 visible, hide others
                               input.style.display = i < 10 ? 'block' : 'none';
                               input.placeholder = `Magia/Habilidade ${i + 1}`;
                           });


                          // Reset Inventory
                          inventarioSlots.querySelectorAll(".inventory-slot").forEach(slot => {
                              slot.querySelector(".inventory-item").value = "";
                              slot.querySelector(".inventory-weight").value = "0";
                          });

                           // Reset V/D/Race
                           vantagensSelecionadas = [];
                           desvantagensSelecionadas = [];
                           racaSelecionada = null;
                           atualizarVantagensDesvantagensDisplay();
                           racaNomeSpan.textContent = "Clique para selecionar/editar";
                           racaDescricaoInput.value = "";

                           // Reset Classe
                           classeNomeInput.value = "";
                           classeDescricaoInput.value = "";

                          // Reset image
                          characterImage.style.display = "none";
                          characterImage.src = "";

                          // Reset annotations
                          anotacoesTextarea.value = "";

                           // Reset chat password? Optional. Let's keep it for now.
                           // chatPassword = null;

                           // Reset background? Optional. Let's keep it for now.
                           // document.body.style.backgroundImage = 'none';
                           // document.body.style.backgroundColor = '#d2b48c';
                           // document.body.style.backgroundSize = 'cover';

                          // Recalculate everything based on Nivel 0 defaults
                           atualizarNivel(); // Sets level to 0, updates PD/PH totals
                           calcularAtributos(); // Recalculates derived stats, HP/MP/VP based on 0 attributes and level 0

                           // Ensure current resources match totals after reset
                           vidaAtual = vidaTotal;
                           magiaAtual = magiaTotal;
                           vigorAtual = vigorTotal;
                           document.getElementById("vida-atual").textContent = vidaAtual;
                           document.getElementById("magia-atual").textContent = magiaAtual;
                           document.getElementById("vigor-atual").textContent = vigorAtual.toFixed(1);

                           // Reset temporary unlock state just in case
                           isFichaUnlocked = false;

                           // Save the wiped state
                           salvarDados();
                           showNotification("Ficha RECOMEÇADA!", "save-success");
                     } else {
                         showNotification("Senha do GM incorreta! Recomeço cancelado.", "critical-failure");
                     }
                 };
            }
        }

        resetPontosButton.onclick = () => resetarPontos(false); // Initial call requires password check
        recomecarButton.onclick = () => recomecarFicha(false); // Initial call requires password check

        // --- Notifications ---
        function showNotification(message, type = "normal-result", duration = 2500) {
            // Clear previous timeout if any
            clearTimeout(notification.timeoutId);

            notification.textContent = message;
            notification.className = ''; // Clear previous classes
             notification.classList.add(type); // Add new type class
            notification.style.display = "block";
            notification.style.opacity = 1; // Ensure visible

            // Auto-hide after duration
             notification.timeoutId = setTimeout(() => {
                 notification.style.opacity = 0;
                 // Use transitionend event to set display none after fade out
                 notification.addEventListener('transitionend', () => {
                     notification.style.display = "none";
                 }, { once: true }); // Remove listener after it runs once
            }, duration);
        }


        // --- Chat Functionality ---
        chatBtn.onclick = () => {
             if (!fichas[currentFichaId]?.chatPassword) { // Check if password is set for current ficha
                 document.getElementById("chat-password-modal").style.display = "flex";
             } else {
                 document.getElementById("open-chat-modal").style.display = "flex";
                 document.getElementById("abrir-chat-senha-input").value = "";
                 document.getElementById("abrir-chat-senha-input").focus();
             }
        };

        function definirSenhaChat() {
            const senhaInput = document.getElementById("chat-senha-input");
            const confirmarSenhaInput = document.getElementById("chat-confirmar-senha-input");
            const senha = senhaInput.value;
            const confirmarSenha = confirmarSenhaInput.value;

            if (senha.length < 4) {
                showNotification("A senha do chat deve ter pelo menos 4 caracteres.", "critical-failure");
                senhaInput.focus();
                return;
            }
            if (senha !== confirmarSenha) {
                showNotification("As senhas não coincidem.", "critical-failure");
                confirmarSenhaInput.focus();
                return;
            }

            chatPassword = senha; // Update global variable
            // Save to Firebase for the current ficha
            database.ref(`fichas/${currentFichaId}`).update({ chatPassword: senha }).then(() => {
                fecharModal("chat-password-modal");
                showNotification("Senha do chat definida!", "save-success");
                atualizarEstadoChatBotao();
            }).catch(error => {
                console.error("Erro ao definir senha do chat:", error);
                showNotification("Erro ao salvar senha do chat.", "critical-failure");
            });
        }

        function abrirChat() {
            const senhaDigitadaInput = document.getElementById("abrir-chat-senha-input");
            const senhaDigitada = senhaDigitadaInput.value;
            const expectedPassword = fichas[currentFichaId]?.chatPassword; // Get expected password

            if (senhaDigitada === expectedPassword) {
                fecharModal("open-chat-modal");
                document.getElementById("chat-modal").style.display = "flex";
                isChatOpen = true;
                 chatBtn.dataset.unread = 0; // Reset unread count on open
                 chatBtn.classList.remove('has-unread'); // Optional: remove visual cue class

                // If a user was previously selected, load that conversation
                 if (selectedChatUser) {
                     iniciarConversa(selectedChatUser, fichas[selectedChatUser]?.nomeFicha || 'Desconhecido');
                 } else {
                     // Otherwise, show placeholder
                     conversationAreaDiv.innerHTML = '<h3>Selecione uma ficha para conversar.</h3>';
                 }
                 atualizarListaFichasChat(); // Refresh user list highlighting

            } else {
                showNotification("Senha do chat incorreta.", "critical-failure");
                 senhaDigitadaInput.focus();
                 senhaDigitadaInput.select();
            }
        }

         // Close chat modal override
         function fecharChatModal() {
             isChatOpen = false;
              // Detach listeners for the current conversation when closing
              if (selectedChatUser) {
                   const chatId = getChatId(currentFichaId, selectedChatUser);
                   if (messageListeners[chatId]) {
                       database.ref('mensagens').child(chatId).off('child_added', messageListeners[chatId]);
                       delete messageListeners[chatId];
                       console.log("Detached listener for chat:", chatId);
                   }
              }
             fecharModal('chat-modal');
             verificarNovasMensagens(); // Re-check for unread messages immediately after closing
         }
          // Assign the override to the close button inside the chat modal
          document.querySelector('#chat-modal .cancel-btn').onclick = fecharChatModal;


        function atualizarEstadoChatBotao() {
            // Check the loaded ficha data for chat password
            if (fichas[currentFichaId]?.chatPassword) {
                chatBtn.textContent = "💬 Chat";
                chatBtn.title = "Abrir Chat Privado";
            } else {
                chatBtn.textContent = "🔒 Definir Chat";
                chatBtn.title = "Definir Senha para Chat Privado";
            }
        }

        function atualizarListaFichasChat() {
            availableFichasDiv.innerHTML = ""; // Clear list
             if (!fichas) return; // No fichas loaded yet

             // Sort users alphabetically
            const sortedFichaIds = Object.keys(fichas)
                .filter(id => id !== "ficha-matriz" && id !== currentFichaId) // Exclude self and matriz
                .sort((a, b) => (fichas[a]?.nomeFicha || '').localeCompare(fichas[b]?.nomeFicha || ''));

             sortedFichaIds.forEach(fichaId => {
                 const ficha = fichas[fichaId];
                 if (ficha) { // Ensure ficha data exists
                     const userDiv = document.createElement("div");
                     userDiv.className = "user-item";
                     userDiv.textContent = ficha.nomeFicha || "Sem Nome";
                     userDiv.dataset.fichaId = fichaId;
                     userDiv.title = userDiv.textContent; // Tooltip for long names

                     // Highlight the currently selected user
                     if (fichaId === selectedChatUser) {
                         userDiv.classList.add('active');
                     }

                     userDiv.onclick = () => {
                          if (selectedChatUser !== fichaId) { // Only switch if different
                             iniciarConversa(fichaId, ficha.nomeFicha || "Sem Nome");
                             // Update highlighting in the list
                             availableFichasDiv.querySelectorAll('.user-item').forEach(item => item.classList.remove('active'));
                             userDiv.classList.add('active');
                          }
                     };
                     availableFichasDiv.appendChild(userDiv);
                 }
             });
        }

        function iniciarConversa(otherFichaId, otherFichaNome) {
             console.log(`Iniciando conversa com ${otherFichaNome} (${otherFichaId})`);
             // Detach listener for the previous conversation, if any
             if (selectedChatUser && selectedChatUser !== otherFichaId) {
                  const oldChatId = getChatId(currentFichaId, selectedChatUser);
                  if (messageListeners[oldChatId]) {
                      database.ref('mensagens').child(oldChatId).off('child_added', messageListeners[oldChatId]);
                      delete messageListeners[oldChatId];
                       console.log("Detached listener for old chat:", oldChatId);
                  }
             }

            selectedChatUser = otherFichaId; // Set the new user

            // Setup conversation area
            conversationAreaDiv.innerHTML = `<h3>Conversa com ${otherFichaNome}</h3><div id="mensagens" class="flex-grow flex flex-col gap-2 p-2"></div>`; // Added classes for layout

            // Load and listen for new messages
            carregarMensagens(otherFichaId);
        }

        function enviarMensagem() {
            if (!selectedChatUser) {
                showNotification("Selecione uma ficha para enviar a mensagem.", "normal-result");
                return;
            }
            const mensagem = mensagemInput.value.trim();
            if (mensagem) {
                const chatId = getChatId(currentFichaId, selectedChatUser);
                const chatRef = database.ref('mensagens').child(chatId).push();
                chatRef.set({
                    senderId: currentFichaId,
                    senderName: fichas[currentFichaId]?.nomeFicha || 'Desconhecido', // Include sender name
                    receiverId: selectedChatUser,
                    content: mensagem,
                    timestamp: firebase.database.ServerValue.TIMESTAMP // Use server timestamp
                }).then(() => {
                    mensagemInput.value = ""; // Clear input on successful send
                     // Scroll down immediately after sending
                     const mensagensDiv = document.getElementById("mensagens");
                     if(mensagensDiv) mensagensDiv.parentElement.scrollTop = mensagensDiv.parentElement.scrollHeight;
                }).catch(error => {
                     console.error("Erro ao enviar mensagem:", error);
                     showNotification("Erro ao enviar mensagem.", "critical-failure");
                });

            }
        }

         // Allow sending message with Enter key
         mensagemInput.addEventListener('keypress', function (e) {
             if (e.key === 'Enter') {
                 e.preventDefault(); // Prevent default form submission/newline
                 enviarMensagem();
             }
         });

        function carregarMensagens(otherFichaId) {
             const mensagensDiv = document.getElementById("mensagens"); // Get the message container
             if (!mensagensDiv) return; // Exit if container not found

             mensagensDiv.innerHTML = ''; // Clear previous messages
             const chatId = getChatId(currentFichaId, otherFichaId);

             // Check if a listener already exists for this chat and detach it first
             if (messageListeners[chatId]) {
                 database.ref('mensagens').child(chatId).off('child_added', messageListeners[chatId]);
                 console.log("Detached existing listener for chat:", chatId);
             }

             // Create and store the new listener function
             messageListeners[chatId] = (snapshot) => {
                  try { // Add try-catch block for safety
                      const mensagemData = snapshot.val();
                      if (!mensagemData) return; // Skip if data is null

                      const messageContainer = document.createElement("div");
                      // Add container class and sent/received class
                      messageContainer.className = `message-container ${mensagemData.senderId === currentFichaId ? 'sent' : 'received'}`;

                      const senderNameDiv = document.createElement("div");
                      senderNameDiv.className = "sender-name";
                      // Use senderName from data, fallback to looking up in fichas
                      senderNameDiv.textContent = mensagemData.senderName || fichas[mensagemData.senderId]?.nomeFicha || 'Desconhecido';

                      const mensagemDiv = document.createElement("div");
                      mensagemDiv.className = "message";
                      mensagemDiv.textContent = mensagemData.content; // Display message content

                      // Append sender name first, then message
                      messageContainer.appendChild(senderNameDiv);
                      messageContainer.appendChild(mensagemDiv);

                      mensagensDiv.appendChild(messageContainer); // Add to the UI

                      // Scroll to the bottom to show the latest message
                      // Use parentElement (conversationAreaDiv) for scrolling
                      mensagensDiv.parentElement.scrollTop = mensagensDiv.parentElement.scrollHeight;
                  } catch (error) {
                       console.error("Erro ao processar mensagem recebida:", error, snapshot.val());
                  }
             };

             // Attach the new listener
             database.ref('mensagens').child(chatId)
                     .orderByChild('timestamp') // Ensure messages are ordered by time
                     .limitToLast(50) // Limit initial load and listener scope (optional but recommended)
                     .on('child_added', messageListeners[chatId], (error) => {
                          console.error(`Erro ao anexar listener para chat ${chatId}:`, error);
                     });
              console.log("Attached listener for chat:", chatId);
        }


        function getChatId(id1, id2) {
            // Consistent chat ID regardless of sender/receiver order
             if (!id1 || !id2) {
                 console.error("Tentativa de gerar chatId com IDs inválidos:", id1, id2);
                 return null; // Or throw an error
             }
            return id1 < id2 ? `${id1}_${id2}` : `${id2}_${id1}`;
        }

         // Global listener for all messages to update unread count
         let globalMessagesListenerAttached = false;
         let lastUnreadCount = 0;

         function verificarNovasMensagens() {
             if (!currentFichaId || globalMessagesListenerAttached) return; // Only attach once

             console.log("Attaching global message listener for unread count.");
             globalMessagesListenerAttached = true; // Mark as attached

             database.ref('mensagens').on('value', (snapshot) => {
                 if (!currentFichaId) return; // Don't process if no ficha selected

                 let unreadCount = 0;
                 const allChats = snapshot.val() || {};

                 for (const chatId in allChats) {
                     // Check if the current user is part of this chat
                     if (chatId.includes(currentFichaId)) {
                         const messages = allChats[chatId];
                         const otherUserId = chatId.replace(currentFichaId, '').replace('_', '');

                         // Count unread messages in this chat
                         for (const messageId in messages) {
                              const msg = messages[messageId];
                              // Check if message is for the current user, from someone else,
                              // and either the chat is closed OR the chat is open but for a DIFFERENT user
                              if (msg.receiverId === currentFichaId &&
                                  msg.senderId !== currentFichaId &&
                                  (!isChatOpen || selectedChatUser !== msg.senderId))
                              {
                                  // We need a 'read' status per message or per chat to be accurate.
                                  // For simplicity now, just count all incoming when chat isn't focused on sender.
                                  unreadCount++;
                              }
                         }
                     }
                 }


                 // Update UI only if count changes
                 if (unreadCount !== lastUnreadCount) {
                      console.log("Unread count updated:", unreadCount);
                     chatBtn.dataset.unread = unreadCount; // Update the data attribute
                     // Optional: Add/Remove a class for CSS styling based on unread count
                     // if (unreadCount > 0) {
                     //     chatBtn.classList.add('has-unread');
                     // } else {
                     //     chatBtn.classList.remove('has-unread');
                     // }

                     // Play sound only if new messages arrived and chat is closed
                     if (unreadCount > lastUnreadCount && !isChatOpen) {
                         newMessageSound.play().catch(e => console.warn("Erro ao tocar som de notificação:", e));
                     }
                     lastUnreadCount = unreadCount; // Store current count for next comparison
                 }

             }, (error) => {
                  console.error("Erro no listener global de mensagens:", error);
                  globalMessagesListenerAttached = false; // Allow re-attachment on error
             });
         }


        // --- Background Image Functionality ---
        planoFundoBtn.onclick = () => {
            backgroundModal.style.display = "flex";
            // Ensure radio button reflects current setting
            const currentSize = document.body.style.backgroundSize || 'cover';
            const radioButtons = document.querySelectorAll('input[name="background-size"]');
            radioButtons.forEach(radio => {
                radio.checked = radio.value === currentSize;
            });
             // Clear file input
             backgroundImageInput.value = null;
        };

        function aplicarPlanoDeFundo() {
            const file = backgroundImageInput.files[0];
             const selectedSize = document.querySelector('input[name="background-size"]:checked')?.value || 'cover'; // Get selected size

            if (file) {
                 // User selected a new image
                  if (file.size > 2 * 1024 * 1024) { // Limit file size (e.g., 2MB)
                      showNotification("Imagem muito grande (máx 2MB).", "critical-failure");
                      backgroundImageInput.value = null; // Clear the file input
                      return;
                  }
                 const reader = new FileReader();
                 reader.onload = e => {
                     const imageUrl = e.target.result; // Base64 string
                     document.body.style.backgroundImage = `url('${imageUrl}')`;
                     document.body.style.backgroundSize = selectedSize;
                     salvarDados(); // Save the new image URL and size
                     fecharModal('background-modal');
                     showNotification("Plano de fundo aplicado!", "save-success");
                 };
                  reader.onerror = () => {
                      showNotification("Erro ao ler imagem.", "critical-failure");
                  };
                 reader.readAsDataURL(file);
            } else {
                 // User didn't select a file, just potentially changed the size setting
                 // Apply the new size if the background image exists
                 if (document.body.style.backgroundImage && document.body.style.backgroundImage !== 'none') {
                      if (document.body.style.backgroundSize !== selectedSize) {
                           document.body.style.backgroundSize = selectedSize;
                           salvarDados(); // Save the new size
                           showNotification("Tamanho do plano de fundo atualizado!", "save-success");
                      }
                 } else {
                     // No image selected and no existing image
                     showNotification("Nenhuma imagem selecionada para aplicar.", "normal-result");
                 }
                 fecharModal('background-modal');
            }
        }

        function excluirPlanoDeFundo() {
            if (confirm("Tem certeza que deseja remover a imagem de fundo e voltar ao padrão?")) {
                document.body.style.backgroundImage = 'none';
                document.body.style.backgroundColor = ''; // Revert to default CSS color
                document.body.style.backgroundSize = 'cover'; // Reset size
                salvarDados(); // Save the state (null image, default size)
                fecharModal('background-modal');
                showNotification("Plano de fundo removido.", "save-success");
            }
        }

         function aplicarPlanoDeFundoInicial(fichaData) {
             // Applies background on ficha load
             if (!fichaData) return;

             const savedImage = fichaData.backgroundImage;
             const savedSize = fichaData.backgroundSize || 'cover';

             if (savedImage && savedImage.startsWith('data:image')) {
                 document.body.style.backgroundImage = `url('${savedImage}')`;
                 document.body.style.backgroundSize = savedSize;
             } else {
                 document.body.style.backgroundImage = 'none';
                 document.body.style.backgroundColor = ''; // Revert to default CSS color
                 document.body.style.backgroundSize = 'cover'; // Reset size
             }
         }


        // --- Initial Load ---
         // Load GM Ficha first, then load all fichas
         document.addEventListener('DOMContentLoaded', () => {
             criarFichaMatriz();
             // carregarFichas() will be called by criarFichaMatriz or its callback
         });


    </script>
</body>

</html>
