<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ficha de Personagem RPG</title>
  <link href="https://fonts.googleapis.com/css2?family=MedievalSharp&family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/@tailwindcss/browser@4"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background-color: #f0e6d2; /* Cor de pergaminho padr√£o */
      color: #000;
      display: flex;
      min-height: 100vh;
      margin: 0;
      padding: 20px;
      background-image: none;
      background-size: cover;
      background-position: center;
      background-attachment: fixed; /* A imagem se expande conforme o monitor (viewport) */
      transition: background 0.3s, color 0.3s;
    }
    body.dark-mode {
      background-color: #121212 !important; /* Garante que o fundo seja sempre escuro */
      color: #e0e0e0;
    }
    /* ... (demais estilos inalterados) ... */
    /* Estilos para o modal de plano de fundo */
    #background-modal { display: none; }
    #background-modal .modal-content { width: 400px; text-align: left; }
    #background-modal .modal-content label { display: block; margin-bottom: 5px; }
    #background-modal .modal-content input[type="file"] { margin-bottom: 10px; }
    #background-modal .modal-content .radio-group { margin-bottom: 15px; }
    #background-modal .modal-content .radio-group label { display: inline-block; margin-right: 10px; }
    /* Estilos para o seletor de cor de fundo */
    .color-option { width: 24px; height: 24px; border-radius: 50%; cursor: pointer; border: 1px solid #ccc; }
  </style>
</head>
<body>
  <div id="chat-btn-container">
    <button id="chat-btn" data-unread="0">üí¨ Chat</button>
  </div>
  <div id="fichas-sidebar">
    <div id="add-ficha-btn"><span>+ Fichas</span></div>
  </div>
  <div id="ficha-container">
    <h1 id="nome-personagem-titulo">Ficha de Personagem</h1>
    <div id="game-master-message">Voc√™ virou o Game Master</div>
    <div id="character-image-container" onclick="document.getElementById('character-image-input').click()">
      <img id="character-image" alt="Imagem do Personagem">
      <input type="file" id="character-image-input" accept="image/*" style="display:none">
    </div>
    <div id="dice-container">
      <label>Role seu dado:</label>
      <div id="dice-roll">-</div>
      <div id="dice-result"></div>
    </div>
    <div id="ficha-content">
      <section id="informacoes-basicas">
        <h2>Informa√ß√µes B√°sicas</h2>
        <label for="nome-personagem">Nome do Personagem:</label>
        <input type="text" id="nome-personagem" placeholder="Digite o nome do seu personagem">
        <label for="descricao-personagem">Descri√ß√£o do Personagem:</label>
        <textarea id="descricao-personagem" placeholder="Digite a descri√ß√£o do seu personagem"></textarea>
      </section>
      <section id="recursos">
        <h2>Recursos</h2>
        <div class="vida-magia-vigor">
          <div class="atributo-container vida">
            <h3>Vida</h3>
            <div class="valor-total medieval-box">
              <span>Vida Total: </span>
              <span id="vida-total" readonly>50</span>
            </div>
            <div class="valor-atual medieval-box">
              <span>Vida Atual: </span>
              <button onclick="diminuirVida()" title="Diminuir Vida">‚ñº</button>
              <span id="vida-atual">50</span>
              <button onclick="aumentarVida()" title="Aumentar Vida">‚ñ≤</button>
            </div>
            <div class="regeneracao">
              <span>Regenera√ß√£o por turno: <span id="regeneracao-vida">0</span> (parado)</span>
            </div>
          </div>
          <div class="atributo-container magia">
            <h3>Magia</h3>
            <div class="valor-total medieval-box">
              <span>Magia Total: </span>
              <span id="magia-total" readonly>20</span>
            </div>
            <div class="valor-atual medieval-box">
              <span>Magia Atual: </span>
              <button onclick="diminuirMagia()" title="Diminuir Magia">‚ñº</button>
              <span id="magia-atual">20</span>
              <button onclick="aumentarMagia()" title="Aumentar Magia">‚ñ≤</button>
            </div>
            <div class="regeneracao">
              <span>Regenera√ß√£o por turno: <span id="regeneracao-magia">0</span></span>
            </div>
          </div>
          <div class="atributo-container vigor">
            <h3>Vigor</h3>
            <div class="valor-total medieval-box">
              <span>Vigor Total: </span>
              <span id="vigor-total" readonly>10</span>
            </div>
            <div class="valor-atual medieval-box">
              <span>Vigor Atual: </span>
              <button onclick="diminuirVigor()" title="Diminuir Vigor">‚ñº</button>
              <span id="vigor-atual">10</span>
              <button onclick="aumentarVigor()" title="Aumentar Vigor">‚ñ≤</button>
            </div>
            <div class="regeneracao">
              <span>Regenera√ß√£o por turno: <span id="regeneracao-vigor">0</span> (parado)</span>
            </div>
          </div>
        </div>
      </section>
      <section id="atributos">
        <h2>Atributos</h2>
        <div class="atributos-container">
          <div class="atributos-coluna">
            <div class="atributo">
              <label for="forca" title="Afeta ataque e RDF">For√ßa:</label>
              <input type="number" id="forca" value="0" min="0">
            </div>
            <div class="atributo">
              <label for="destreza" title="Afeta ataque e acerto">Destreza:</label>
              <input type="number" id="destreza" value="0" min="0">
            </div>
            <div class="atributo">
              <label for="agilidade" title="Afeta esquiva e acerto">Agilidade:</label>
              <input type="number" id="agilidade" value="0" min="0">
            </div>
            <div class="atributo">
              <label for="constituicao" title="Afeta vida, magia e vigor">Constitui√ß√£o:</label>
              <input type="number" id="constituicao" value="0" min="0">
            </div>
            <div class="atributo">
              <label for="inteligencia" title="Afeta ataque m√°gico e RDM">Intelig√™ncia:</label>
              <input type="number" id="inteligencia" value="0" min="0">
            </div>
          </div>
          <div class="atributos-coluna-destaque">
            <div class="atributo-destaque">
              <label>Ataque:</label>
              <span id="ataque" readonly>0</span>
            </div>
            <div class="atributo-destaque">
              <label>Ataque M√°gico:</label>
              <span id="ataque-magico" readonly>0</span>
            </div>
            <div class="atributo-destaque">
              <label>Acerto:</label>
              <span id="acerto" readonly>0</span>
            </div>
            <div class="atributo-destaque">
              <label>Esquiva:</label>
              <span id="esquiva" readonly>0</span>
            </div>
            <div class="atributo-destaque">
              <label>RDF:</label>
              <span id="rdf" readonly>0</span>
            </div>
            <div class="atributo-destaque">
              <label>RDM:</label>
              <span id="rdm" readonly>0</span>
            </div>
          </div>
        </div>
      </section>
      <section id="combate">
        <h2>Combate</h2>
        <div class="armamento-container">
          <div class="armamento-coluna">
            <label>Armamento M√£o Direita:</label>
            <div class="flex items-center mb-2">
              <input type="text" id="arma-direita-nome" placeholder="Nome da Arma" class="mr-2">
              <span>Ataque </span>
              <input type="number" id="arma-direita-ataque" value="0" class="w-20 mr-2">
              <span>Ataque M√°gico </span>
              <input type="number" id="arma-direita-ataque-magico" value="0" class="w-20">
            </div>
          </div>
          <div class="armamento-coluna">
            <label>Armamento M√£o Esquerda:</label>
            <div class="flex items-center">
              <input type="text" id="arma-esquerda-nome" placeholder="Nome da Arma" class="mr-2">
              <span>Ataque </span>
              <input type="number" id="arma-esquerda-ataque" value="0" class="w-20 mr-2">
              <span>Ataque M√°gico </span>
              <input type="number" id="arma-esquerda-ataque-magico" value="0" class="w-20">
            </div>
          </div>
        </div>
      </section>
      <section id="inventario-habilidades">
        <h2>Invent√°rio e Habilidades</h2>
        <div class="flex gap-20">
          <div style="width:50%">
            <label>Invent√°rio (Peso Total: <span id="peso-total">0</span> kg):</label>
            <div id="inventario-slots">
              <div class="inventory-slot"><input type="text" placeholder="Item 1" class="inventory-item"><input type="number" min="0" value="0" class="inventory-weight" title="Peso em kg"></div>
              <div class="inventory-slot"><input type="text" placeholder="Item 2" class="inventory-item"><input type="number" min="0" value="0" class="inventory-weight"></div>
              <div class="inventory-slot"><input type="text" placeholder="Item 3" class="inventory-item"><input type="number" min="0" value="0" class="inventory-weight"></div>
              <div class="inventory-slot"><input type="text" placeholder="Item 4" class="inventory-item"><input type="number" min="0" value="0" class="inventory-weight"></div>
              <div class="inventory-slot"><input type="text" placeholder="Item 5" class="inventory-item"><input type="number" min="0" value="0" class="inventory-weight"></div>
              <div class="inventory-slot"><input type="text" placeholder="Item 6" class="inventory-item"><input type="number" min="0" value="0" class="inventory-weight"></div>
              <div class="inventory-slot"><input type="text" placeholder="Item 7" class="inventory-item"><input type="number" min="0" value="0" class="inventory-weight"></div>
              <div class="inventory-slot"><input type="text" placeholder="Item 8" class="inventory-item"><input type="number" min="0" value="0" class="inventory-weight"></div>
              <div class="inventory-slot"><input type="text" placeholder="Item 9" class="inventory-item"><input type="number" min="0" value="0" class="inventory-weight"></div>
              <div class="inventory-slot"><input type="text" placeholder="Item 10" class="inventory-item"><input type="number" min="0" value="0" class="inventory-weight"></div>
            </div>
          </div>
          <div style="width:50%">
            <label>Magias e Habilidades:</label>
            <div id="magias-list" class="magias-container">
              <input type="text" placeholder="Magia/Habilidade 1" class="magia-nome">
              <input type="text" placeholder="Magia/Habilidade 2" class="magia-nome">
              <input type="text" placeholder="Magia/Habilidade 3" class="magia-nome">
              <input type="text" placeholder="Magia/Habilidade 4" class="magia-nome">
              <input type="text" placeholder="Magia/Habilidade 5" class="magia-nome">
              <input type="text" placeholder="Magia/Habilidade 6" class="magia-nome">
              <input type="text" placeholder="Magia/Habilidade 7" class="magia-nome">
              <input type="text" placeholder="Magia/Habilidade 8" class="magia-nome">
              <input type="text" placeholder="Magia/Habilidade 9" class="magia-nome">
              <input type="text" placeholder="Magia/Habilidade 10" class="magia-nome">
            </div>
            <button id="adicionar-magia-btn">Adicionar Magia</button>
          </div>
        </div>
        <div class="mt-4">
          <label>Vantagens:</label>
          <div id="vantagens-list-display" class="list-display"></div>
          <label>Desvantagens:</label>
          <div id="desvantagens-list-display" class="list-display"></div>
        </div>
        <div class="classe-raca-container">
          <label>Classe:</label>
          <input type="text" id="classe-nome" placeholder="Nome da Classe">
          <textarea id="classe-descricao" placeholder="Descri√ß√£o da Classe" class="expandable-textarea"></textarea>
          <label>Ra√ßa:</label>
          <span id="raca-nome" onclick="abrirModalRaca()"></span>
          <textarea id="raca-descricao" placeholder="Descri√ß√£o da Ra√ßa" class="expandable-textarea" readonly></textarea>
        </div>
      </section>
      <section id="locomocao">
        <h2>Locomo√ß√£o</h2>
        <div class="locomotion-container">
          <div class="locomotion-item">
            <label>Velocidade de Corrida (km/h):</label><span>üèÉ‚Äç‚ôÇÔ∏è</span><span id="velocidade-corrida" readonly>25</span>
          </div>
          <div class="locomotion-item">
            <label>Altura do Pulo (m):</label><span>‚¨ÜÔ∏è</span><span id="altura-pulo" readonly>1</span>
          </div>
          <div class="locomotion-item">
            <label>Dist√¢ncia do Pulo (m):</label><span>‚û°Ô∏è</span><span id="distancia-pulo" readonly>3</span>
          </div>
        </div>
      </section>
      <section id="status">
        <h2>Status</h2>
        <div class="flex gap-20">
          <div>
            <label>Experi√™ncia:</label>
            <input type="number" id="experiencia" value="0" min="0">
            <label>Pontos de Habilidade (PD):</label>
            <span id="pontos-habilidade" readonly>25</span>
            <label>Pontos de Vantagem (PH):</label>
            <span id="pontos-vantagem" readonly>8</span>
          </div>
          <div></div>
        </div>
        <div id="nivel-container">
          <label>N√≠vel:</label>
          <span id="nivel">0</span>
        </div>
      </section>

      <div style="display:flex;justify-content:center;gap:20px;margin-bottom:20px">
        <button id="vantagens-desvantagens-btn">Vantagens e Desvantagens</button>
        <button id="racas-btn">Ra√ßas üè∞</button>
        <button id="classes-btn">Classes ‚öîÔ∏è</button>
      </div>

      <div class="botoes-container">
        <button id="reset-pontos" class="botao botao-reset">Reiniciar Pontos</button>
        <button id="recomecar" class="botao botao-recomecar">Recome√ßar</button>
        <button id="bloquear-ficha" class="botao botao-bloquear">Bloquear Ficha</button>
        <button id="plano-fundo-btn" class="botao">Plano de fundo</button>
        <button id="excluir-ficha" class="botao botao-excluir">Excluir Ficha</button>
      </div>

      <div class="theme-color-container">
        <button id="lua-btn" class="botao icon-btn">üåô</button>
        <button id="sol-btn" class="botao icon-btn">‚òÄÔ∏è</button>
        <div id="cor-fundo-btn-wrapper" style="display: inline-block; position: relative;">
          <button id="cor-fundo-btn" class="botao icon-btn">üé®</button>
          <div id="background-color-selector">
            <div class="color-option" style="background-color: #800000;" data-color="#800000"></div>
            <div class="color-option" style="background-color: #000080;" data-color="#000080"></div>
            <div class="color-option" style="background-color: #ffffff;" data-color="#ffffff"></div>
            <div class="color-option" style="background-color: #f0e6d2;" data-color="#f0e6d2"></div>
            <div class="color-option" style="background-color: #ffc0cb;" data-color="#ffc0cb"></div>
            <div class="color-option" style="background-color: #006400;" data-color="#006400"></div>
            <div class="color-option" style="background-color: #ff0000;" data-color="#ff0000"></div>
            <div class="color-option" style="background-color: #808080;" data-color="#808080"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <button id="anotacoes-btn">Anota√ß√µes</button>
  <textarea id="anotacoes-textarea" placeholder="Suas anota√ß√µes aqui..."></textarea>
  <button id="historico-dados-btn">Hist√≥rico de dados</button>
  <div id="historico-dados-panel">
    <h3>Hist√≥rico de Dados</h3>
    <div id="historico-lista"></div>
    <button id="excluir-historico-btn">Excluir hist√≥rico</button>
  </div>
  <div id="vantagens-desvantagens-panel">
    <h2>Vantagens e Desvantagens</h2>
    <div>Pontos de Vantagem Tempor√°rios: <span id="ph-temp">0</span></div>
    <div id="vantagens-list"></div>
    <div id="desvantagens-list"></div>
    <button id="salvar-vantagens-btn">SALVAR</button>
    <button id="fechar-pagina-btn">Fechar P√°gina</button>
  </div>
  <div id="racas-panel">
    <h2>Ra√ßas</h2>
    <div id="ph-temp-raca-container" style="text-align: center; margin-bottom: 10px;">Pontos de Vantagem Tempor√°rios: <span id="ph-temp-raca">0</span></div>
    <div id="racas-list"></div>
    <button id="salvar-racas-btn">SALVAR</button>
    <button id="fechar-racas-btn">Fechar P√°gina</button>
  </div>
  <div id="classes-panel">
    <h2>Classes</h2>
    <button id="fechar-classes-btn">Fechar P√°gina</button>
  </div>
  <div id="nome-ficha-modal" class="modal">
    <div class="modal-content">
      <h3>D√™ um Nome √† Ficha</h3>
      <input type="text" id="nome-ficha-input" placeholder="Nome da ficha" maxlength="20">
      <button class="confirm-btn" onclick="criarNovaFicha()">Confirmar</button>
      <button class="cancel-btn" onclick="fecharModal('nome-ficha-modal')">Cancelar</button>
    </div>
  </div>
  <div id="bloquear-ficha-modal" class="modal">
    <div class="modal-content">
      <h3>Ponha sua Senha de 4 D√≠gitos</h3>
      <input type="password" id="senha-bloqueio-input" placeholder="Senha (4 d√≠gitos)" maxlength="4">
      <button class="confirm-btn" onclick="bloquearFicha()">Confirmar</button>
      <button class="cancel-btn" onclick="fecharModal('bloquear-ficha-modal')">Cancelar</button>
    </div>
  </div>
  <div id="password-modal" class="modal">
    <div class="modal-content">
      <h3>Digite sua Senha</h3>
      <input type="password" id="senha-desbloqueio-input" placeholder="Senha (4 d√≠gitos)" maxlength="4">
      <button class="confirm-btn" onclick="desbloquearFicha()">Confirmar</button>
      <button class="cancel-btn" onclick="cancelarDesbloqueio()">Cancelar</button>
    </div>
  </div>
  <div id="confirmar-compra-modal" class="modal">
    <div class="modal-content">
      <h3>Tem certeza que quer comprar isso?</h3>
      <button class="confirm-btn" id="confirmar-compra-btn">Sim</button>
      <button class="cancel-btn" onclick="fecharModal('confirmar-compra-modal')">N√£o</button>
    </div>
  </div>
  <div id="salvar-vantagens-modal" class="modal">
    <div class="modal-content">
      <h3 id="salvar-modal-texto">Se salvar, as altera√ß√µes n√£o poder√£o ser desfeitas.</h3>
      <button class="confirm-btn" id="confirmar-salvar-btn">OK</button>
      <button class="cancel-btn" onclick="fecharModal('salvar-vantagens-modal')">Cancelar</button>
    </div>
  </div>
  <div id="senha-gm-modal" class="modal">
    <div class="modal-content">
      <h3>Pe√ßa permiss√£o ao GM</h3>
      <input type="password" id="senha-gm-input" placeholder="Senha GM">
      <button class="confirm-btn" id="confirmar-senha-gm-btn">Confirmar</button>
      <button class="cancel-btn" onclick="fecharModal('senha-gm-modal')">Cancelar</button>
    </div>
  </div>
  <div id="raca-opcoes-modal" class="modal">
    <div class="modal-content">
      <h3>O que voc√™ deseja fazer?</h3>
      <button class="confirm-btn" onclick="excluirRacaSelecionadaModal()">Excluir Ra√ßa</button>
      <button class="confirm-btn" onclick="editarRacaSelecionadaModal()" style="margin-top: 10px;">Editar Ra√ßa</button>
      <button class="cancel-btn" onclick="fecharModal('raca-opcoes-modal')">Cancelar</button>
    </div>
  </div>
  <div id="editar-raca-modal" class="modal">
    <div class="modal-content">
      <h3>Editar Ra√ßa</h3>
      <label for="editar-raca-nome">Nome:</label>
      <input type="text" id="editar-raca-nome">
      <label for="editar-raca-descricao">Descri√ß√£o:</label>
      <textarea id="editar-raca-descricao"></textarea>
      <button class="confirm-btn" onclick="salvarEdicaoRaca()">Salvar</button>
      <button class="cancel-btn" onclick="fecharModal('editar-raca-modal')">Cancelar</button>
    </div>
  </div>
  <div id="chat-password-modal" class="modal">
    <div class="modal-content">
      <h3>Definir Senha do Chat</h3>
      <input type="password" id="chat-senha-input" placeholder="Senha do Chat">
      <input type="password" id="chat-confirmar-senha-input" placeholder="Confirmar Senha">
      <button class="confirm-btn" onclick="definirSenhaChat()">Confirmar</button>
      <button class="cancel-btn" onclick="fecharModal('chat-password-modal')">Cancelar</button>
    </div>
  </div>
  <div id="open-chat-modal" class="modal">
    <div class="modal-content">
      <h3>Digite a Senha do Chat</h3>
      <input type="password" id="abrir-chat-senha-input" placeholder="Senha do Chat">
      <button class="confirm-btn" onclick="abrirChat()">Confirmar</button>
      <button class="cancel-btn" onclick="fecharModal('open-chat-modal')">Cancelar</button>
    </div>
  </div>
  <div id="chat-modal" class="modal">
    <div class="modal-content">
      <div class="chat-header">Chat Privado</div>
      <div class="chat-body">
        <div class="user-list">
          <h4>Fichas Online</h4>
          <div id="available-fichas"></div>
        </div>
        <div class="conversation" id="conversation-area"></div>
      </div>
      <div class="chat-input">
        <input type="text" id="mensagem-input" placeholder="Digite sua mensagem...">
        <button onclick="enviarMensagem()">Enviar</button>
      </div>
      <button class="cancel-btn" onclick="fecharModal('chat-modal')">Fechar Chat</button>
    </div>
  </div>
  <div id="notification"></div>
  <audio id="new-message-sound" preload="auto">
    <source src="notification_sound.mp3" type="audio/mpeg">
  </audio>
  <div id="background-modal" class="modal">
    <div class="modal-content">
      <h3>Plano de Fundo</h3>
      <label for="background-image-input">Selecionar Imagem:</label>
      <input type="file" id="background-image-input" accept="image/*">
      <div class="radio-group">
        <label><input type="radio" name="background-size" value="cover" checked>Preencher Tela</label>
        <label><input type="radio" name="background-size" value="100% 100%">Estender</label>
        <label><input type="radio" name="background-size" value="auto">Tamanho Normal</label>
      </div>
      <button class="confirm-btn" onclick="aplicarPlanoDeFundo()">Aplicar</button>
      <button class="cancel-btn" onclick="fecharModal('background-modal')">Cancelar</button>
      <button class="cancel-btn" onclick="excluirPlanoDeFundo()">Excluir Imagem</button>
    </div>
  </div>
  <script>
    // Configura√ß√£o do Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyBbbwbwPXv6gztkyP3TXK-DtooEI7FcClI",
      authDomain: "ficha-de-rpg-b9685.firebaseapp.com",
      databaseURL: "https://ficha-de-rpg-b9685-default-rtdb.firebaseio.com",
      projectId: "ficha-de-rpg-b9685",
      storageBucket: "ficha-de-rpg-b9685.firebasestorage.app",
      messagingSenderId: "528610398062",
      appId: "1:528610398062:web:8fdb9cfd5ded8167613b7f"
    };
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    let fichas = {}, currentFichaId = null, isFichaLocked = false, fichaPassword = null,
        isFichaUnlocked = false, senhaMatriz = "1040", vantagensSelecionadas = [],
        desvantagensSelecionadas = [], tempVantagensSelecionadas = [], tempDesvantagensSelecionadas = [],
        racaSelecionada = null, tempRacaSelecionada = null, vidaTotal, vidaAtual, magiaTotal, magiaAtual,
        vigorTotal, vigorAtual, previousValues = new Map(), chatPassword = null, isChatOpen = false, selectedChatUser = null;

    const vantagensData = [
      { nome: "Maestria com Armas curtas (2)", custo: 2, descricao: "+1 em ataque, +1 em acerto com armas curtas." },
      { nome: "Maestria com armas pesadas (2)", custo: 2, descricao: "+2 em ataque com armas pesadas." },
      { nome: "Maestria com armas de longo alcance (2)", custo: 2, descricao: "+2 em acerto com armas de longo alcance." },
      { nome: "Furtar (2)", custo: 2, descricao: "+4 em testes de furto." },
      { nome: "L√°bia (2)", custo: 2, descricao: "+5 em testes de l√°bia." },
      { nome: "Velejar (1)", custo: 1, descricao: "" },
      { nome: "Beleza (1)", custo: 1, descricao: "+3 o teste em l√°bia, paquera e persuas√£o." },
      { nome: "Boa Fama (2)", custo: 2, descricao: "+4 chance de descontos em armamentos, pousadas, alimentos, etc." },
      { nome: "Arremedo (2)", custo: 2, descricao: "Capacidade de imitar qualquer som SIMPLES." },
      { nome: "Destemor (1)", custo: 1, descricao: "Dificilmente √© assustado por algo." },
      { nome: "Empatia (3)", custo: 3, descricao: "Sensibilidade extraordin√°ria em rela√ß√£o aos outras pessoas. Excelente para identificar impostores, possess√µes por espirito, etc." },
      { nome: "Empatia com animais (1)", custo: 1, descricao: "Pode compreender as motiva√ß√µes dos animais." },
      { nome: "Patrono (4)", custo: 4, descricao: "Possui um mentor/mestre/professor, at√© mesmo uma organiza√ß√£o/guilda que pode lhe oferecer ajuda." },
      { nome: "Reconhecimento Social (2)", custo: 2, descricao: "Membro de um grupo respeitado/temido/venerado. +2 teste em l√°bia, paquera e persuas√£o." },
      { nome: "Riqueza (2)", custo: 2, descricao: "Inicia com 20 moedas de ouro." },
      { nome: "Aptid√£o para magia (4)", custo: 4, descricao: "+15% dano e -15% custo de magia para a magia que tem aptid√£o." },
      { nome: "Combo F√≠sico (4)", custo: 4, descricao: "Inicia com 50km velocidade corrida, pulo de 3m altura e 9m dist√¢ncia.", restricao: "inicio" },
      { nome: "Nadar (1)", custo: 1, descricao: "" },
      { nome: "Escalar (2)", custo: 2, descricao: "" },
      { nome: "Segunda l√≠ngua (1)", custo: 1, descricao: "Fala mais um idioma." },
      { nome: "Paquerador (2)", custo: 2, descricao: "+4 em teste para paquera e persuas√£o envolvendo flerte." },
      { nome: "Senso de perigo (5)", custo: 5, descricao: "Quando algo grave ocorrer o mestre pedir√° pra voc√™ jogar um dado para reagir." },
      { nome: "Acrobata (3)", custo: 3, descricao: "+ fama ao lutar em p√∫blico." },
      { nome: "Equil√≠brio Perfeito (3)", custo: 3, descricao: "+8 em testes de equil√≠brio." },
      { nome: "Tecnologia (2)", custo: 2, descricao: "Engenhoso, pode inventar coisas, criar objetos improvisados." },
      { nome: "Poder Oculto (7)", custo: 7, descricao: "Com 10% vida, ativa +50% em todos atributos. Volta ao normal acima de 10% vida." },
      { nome: "Sobreviv√™ncia em floresta (2)", custo: 2, descricao: "Facilidade para achar cavernas, criar assentamentos, achar comida, gravar caminhos, achar √°gua, etc." }
    ];
    const desvantagensData = [
      { nome: "Fobia (+2)", ganho: 2, descricao: "Medo irracional de algo espec√≠fico." },
      { nome: "M√° Fama (+2)", ganho: 2, descricao: "Mal visto pela sociedade, dificultando intera√ß√µes sociais." },
      { nome: "Alcoolismo (+2)", ganho: 2, descricao: "Depend√™ncia de √°lcool que afeta suas decis√µes." },
      { nome: "Altru√≠smo (+2)", ganho: 2, descricao: "Se sacrifica por outras pessoas, pouco se importa com fama ou riqueza." },
      { nome: "Avareza (+2)", ganho: 2, descricao: "Preocupa√ß√£o permanente na conserva√ß√£o de riquezas." },
      { nome: "Bullying (+3)", ganho: 3, descricao: "Gosta de ca√ßoar, agredir, denegrir, difamar e apontar defeitos." }
      // ... (restante dos dados de desvantagens)
    ];
    // Outras constantes (racasData, nivelData, etc.) permanecem inalteradas.
    
    // Fun√ß√£o que calcula os atributos, inclusive locomocao
    function calcularAtributos() {
      const forca = parseInt(document.getElementById("forca").value) || 0,
            destreza = parseInt(document.getElementById("destreza").value) || 0,
            agilidade = parseInt(document.getElementById("agilidade").value) || 0,
            inteligencia = parseInt(document.getElementById("inteligencia").value) || 0,
            constituicao = parseInt(document.getElementById("constituicao").value) || 0;
      
      let totalPontos = forca + destreza + agilidade + inteligencia + constituicao;
      if (totalPontos > Number(document.getElementById("pontos-habilidade").textContent)) {
        alert("Pontos de habilidade insuficientes!");
        // Restaura valores anteriores (supondo que previousValues foi setado)
        return;
      }
      // Atualiza√ß√£o dos pontos usados, etc.
      // C√°lculo dos atributos de combate:
      let ataque = forca + Math.floor(destreza / 5),
          acerto = Math.floor(destreza / 3) + Math.floor(agilidade / 10),
          esquiva = Math.floor(agilidade / 3),
          rdf = Math.floor(forca / 5),
          rdm = Math.floor(inteligencia / 5),
          ataqueMagico = inteligencia;
      // Outros c√°lculos (vidaBase, magiaBase, vigorBase, etc.)...
      const velocidadeBase = 25 + Math.floor(agilidade / 3) * 3,
            alturaPuloBase = 1 + Math.floor(forca / 10),
            distanciaPuloBase = 3 + 3 * Math.min(Math.floor(forca / 5), Math.floor(agilidade / 5));
      // Corre√ß√£o da vantagem "Combo F√≠sico": verifica se qualquer vantagem aplicada cont√©m o termo
      let bonusVelocidade = vantagensSelecionadas.some(v => v.includes("Combo F√≠sico")) ? 25 : 0;
      let bonusAlturaPulo = vantagensSelecionadas.some(v => v.includes("Combo F√≠sico")) ? 2 : 0;
      let bonusDistanciaPulo = vantagensSelecionadas.some(v => v.includes("Combo F√≠sico")) ? 6 : 0;
      
      document.getElementById("velocidade-corrida").textContent = velocidadeBase + bonusVelocidade;
      document.getElementById("altura-pulo").textContent = alturaPuloBase + bonusAlturaPulo;
      document.getElementById("distancia-pulo").textContent = distanciaPuloBase + bonusDistanciaPulo;
      
      // Atualiza√ß√£o dos demais atributos na interface...
    }
    
    // Fun√ß√µes do plano de fundo ‚Äì permanecem inalteradas, conforme :contentReference[oaicite:4]{index=4}&#8203;:contentReference[oaicite:5]{index=5}
    function aplicarPlanoDeFundo() {
      const file = document.getElementById("background-image-input").files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = e => {
          const imageUrl = e.target.result;
          document.body.style.backgroundImage = `url('${imageUrl}')`;
          const selectedSize = document.querySelector('input[name="background-size"]:checked').value;
          document.body.style.backgroundSize = selectedSize;
          salvarDados();
          fecharModal('background-modal');
        };
        reader.readAsDataURL(file);
      } else if (document.body.style.backgroundImage !== 'none') {
        const selectedSize = document.querySelector('input[name="background-size"]:checked').value;
        document.body.style.backgroundSize = selectedSize;
        salvarDados();
        fecharModal('background-modal');
      } else {
        alert("Nenhuma imagem selecionada.");
      }
    }
    function excluirPlanoDeFundo() {
      if (confirm("Remover imagem de fundo?")) {
        document.body.style.backgroundImage = 'none';
        salvarDados();
        fecharModal('background-modal');
      }
    }
    function aplicarPlanoDeFundoInicial() {
      const bgImage = fichas[currentFichaId]?.backgroundImage;
      const bgSize = fichas[currentFichaId]?.backgroundSize || 'cover';
      if (currentFichaId && fichas[currentFichaId] && bgImage) {
        document.body.style.backgroundImage = `url('${bgImage}')`;
        document.body.style.backgroundSize = bgSize;
      } else {
        document.body.style.backgroundImage = 'none';
      }
    }
    // Funcionalidade de cor de fundo permanece inalterada.
    const corFundoBtn = document.getElementById("cor-fundo-btn"),
          backgroundColorSelector = document.getElementById("background-color-selector");
    corFundoBtn.onclick = () => {
      backgroundColorSelector.style.display = (backgroundColorSelector.style.display === 'none' || backgroundColorSelector.style.display === '') ? 'flex' : 'none';
    };
    backgroundColorSelector.addEventListener('click', (event) => {
      if (event.target.classList.contains('color-option')) {
        const color = event.target.dataset.color;
        document.body.style.backgroundColor = color;
        salvarDados();
        backgroundColorSelector.style.display = 'none';
        document.querySelectorAll('#background-color-selector .color-option').forEach(option => option.classList.remove('active'));
        event.target.classList.add('active');
      }
    });
    function aplicarCorDeFundoInicial() {
      const bgColor = fichas[currentFichaId]?.backgroundColor;
      if (currentFichaId && fichas[currentFichaId] && bgColor) {
        document.body.style.backgroundColor = bgColor;
        document.querySelectorAll('#background-color-selector .color-option').forEach(option => {
          option.classList.toggle('active', option.dataset.color === bgColor);
        });
      } else {
        document.body.style.backgroundColor = '#f0e6d2'; /* Cor padr√£o */
      }
    }
    document.addEventListener('click', function(event) {
      if (!backgroundColorSelector.contains(event.target) && !corFundoBtn.contains(event.target)) {
        backgroundColorSelector.style.display = 'none';
      }
    });
    
    // Fun√ß√£o de salvamento dos dados (bug de salvamento corrigido)
    function salvarDados() {
      if (!currentFichaId) return;
      const fichaAtualizada = {
        nomePersonagem: document.getElementById("nome-personagem").value,
        descricaoPersonagem: document.getElementById("descricao-personagem").value,
        forca: document.getElementById("forca").value,
        destreza: document.getElementById("destreza").value,
        agilidade: document.getElementById("agilidade").value,
        constituicao: document.getElementById("constituicao").value,
        inteligencia: document.getElementById("inteligencia").value,
        experiencia: document.getElementById("experiencia").value,
        armaDireitaNome: document.getElementById("arma-direita-nome").value,
        armaDireitaAtaque: document.getElementById("arma-direita-ataque").value,
        armaDireitaAtaqueMagico: document.getElementById("arma-direita-ataque-magico").value,
        armaEsquerdaNome: document.getElementById("arma-esquerda-nome").value,
        armaEsquerdaAtaque: document.getElementById("arma-esquerda-ataque").value,
        armaEsquerdaAtaqueMagico: document.getElementById("arma-esquerda-ataque-magico").value,
        vantagens: vantagensSelecionadas.join("\n"),
        desvantagens: desvantagensSelecionadas.join("\n"),
        // Para o invent√°rio, salvamos uma representa√ß√£o JSON dos itens
        inventario: JSON.stringify(Array.from(document.querySelectorAll('.inventory-slot')).map(slot => {
          return { 
            item: slot.querySelector('.inventory-item').value, 
            peso: slot.querySelector('.inventory-weight').value 
          };
        })),
        velocidadeCorrida: document.getElementById("velocidade-corrida").textContent,
        alturaPulo: document.getElementById("altura-pulo").textContent,
        distanciaPulo: document.getElementById("distancia-pulo").textContent,
        // Se houver imagem de fundo, extra√≠mos a URL removendo a parte "url('...')"
        backgroundImage: document.body.style.backgroundImage && document.body.style.backgroundImage !== "none" ? document.body.style.backgroundImage.slice(5, -2) : null,
        backgroundSize: document.body.style.backgroundSize,
        backgroundColor: document.body.style.backgroundColor
      };
      database.ref("fichas/" + currentFichaId).update(fichaAtualizada)
        .then(() => console.log("Dados salvos com sucesso"))
        .catch(error => console.error("Erro ao salvar dados:", error));
    }
    
    // Outras fun√ß√µes (ex.: carregarFicha, atualizarAbasFichas, etc.) permanecem inalteradas.
    function fecharModal(modalId) {
      document.getElementById(modalId).style.display = "none";
    }
    // ... (restante das fun√ß√µes de cria√ß√£o, edi√ß√£o e manipula√ß√£o da ficha)
    
    carregarFichas(); // Inicia o carregamento das fichas (fun√ß√£o existente)
  </script>
</body>
</html>
