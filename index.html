<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ficha de Personagem RPG</title>
    <link href="https://fonts.googleapis.com/css2?family=MedievalSharp&family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@tailwindcss/browser@4"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <!-- Estilos permanecem iguais, omitidos aqui para brevity -->
</head>
<body>
    <!-- HTML da estrutura principal permanece igual até os campos de vantagens/desvantagens -->
    <div id="ficha-container">
        <!-- Outros elementos omitidos para brevity -->
        <div style="display: flex;">
            <div id="status-container">
                <!-- Outros campos omitidos -->
            </div>
            <div id="right-container">
                <div class="mb-4">
                    <label>Magias e Habilidades:</label>
                    <textarea id="magias-habilidades" class="expandable-textarea" placeholder="Digite as magias e habilidades"></textarea>
                </div>
                <div class="mb-4">
                    <label>Vantagens:</label>
                    <textarea id="vantagens" class="expandable-textarea" placeholder="Suas vantagens aparecerão aqui" readonly></textarea>
                </div>
                <div class="mb-4">
                    <label>Desvantagens:</label>
                    <textarea id="desvantagens" class="expandable-textarea" placeholder="Suas desvantagens aparecerão aqui" readonly></textarea>
                </div>
            </div>
        </div>
        <!-- Restante do HTML permanece igual -->
    </div>
    <!-- Restante do HTML (painéis e modais) permanece igual -->

    <script>
        const firebaseConfig = {
            // Configuração do Firebase permanece igual
        };

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        let fichas = {};
        let currentFichaId = null;
        let isFichaLocked = false;
        let fichaPassword = null;
        let isFichaUnlocked = false;
        let isMatrizUnlocked = false; // Nova variável para senha matriz
        const senhaMatriz = "777";
        let vantagensSelecionadas = [];
        let desvantagensSelecionadas = [];

        // Dados de vantagens e desvantagens permanecem iguais
        const vantagensData = [/* ... */];
        const desvantagensData = [/* ... */];

        // Funções existentes como criarFichaMatriz, carregarFichas, atualizarAbasFichas permanecem iguais

        function carregarFicha(fichaId) {
            if (!fichas[fichaId]) return;

            const ficha = fichas[fichaId];
            // Carregamento de outros campos permanece igual
            vantagensInput.value = ficha.vantagens || '';
            magiasHabilidadesInput.value = ficha.magiasHabilidades || '';
            desvantagensInput.value = ficha.desvantagens || '';
            // Carregamento de outros campos permanece igual

            vantagensSelecionadas = ficha.vantagens ? ficha.vantagens.split('\n').filter(v => v.trim()) : [];
            desvantagensSelecionadas = ficha.desvantagens ? ficha.desvantagens.split('\n').filter(d => d.trim()) : [];

            isFichaLocked = ficha.isLocked || false;
            fichaPassword = ficha.password || null;
            isFichaUnlocked = false;
            isMatrizUnlocked = false; // Resetar ao carregar nova ficha

            vantagensInput.setAttribute('readonly', 'readonly');
            desvantagensInput.setAttribute('readonly', 'readonly');

            atualizarBotaoBloquear();
            atualizarVantagensDesvantagensPanel();
            atualizarNivel();
            calcularAtributos();
        }

        function desbloquearFicha() {
            const senha = document.getElementById('senha-desbloqueio-input').value;
            if (senha === senhaMatriz) {
                isFichaUnlocked = true;
                isMatrizUnlocked = true;
                fecharModal('password-modal');
                alert('Ficha desbloqueada com a senha matriz!');
                vantagensInput.removeAttribute('readonly');
                desvantagensInput.removeAttribute('readonly');
                atualizarBotaoBloquear();
                salvarDados();
            } else if (senha === fichaPassword) {
                isFichaUnlocked = true;
                isMatrizUnlocked = false;
                if (currentFichaId !== 'ficha-matriz') {
                    isFichaLocked = false;
                    fichaPassword = null;
                    database.ref(`fichas/${currentFichaId}`).update({
                        isLocked: false,
                        password: null
                    }).then(() => {
                        fecharModal('password-modal');
                        alert('Ficha desbloqueada com sucesso!');
                        atualizarBotaoBloquear();
                        salvarDados();
                    }).catch((error) => {
                        console.error('Erro ao desbloquear ficha:', error);
                        alert('Ocorreu um erro ao desbloquear a ficha. Tente novamente.');
                    });
                } else {
                    fecharModal('password-modal');
                    alert('Ficha desbloqueada com a senha da ficha!');
                    atualizarBotaoBloquear();
                    salvarDados();
                }
            } else {
                alert('Senha incorreta!');
            }
        }

        function salvarDados() {
            if (!currentFichaId) return;
            if (isFichaLocked && !isFichaUnlocked) {
                abrirModalSenha();
                return;
            }

            const updates = {
                // Outros campos permanecem iguais
                vantagens: vantagensInput.value,
                magiasHabilidades: magiasHabilidadesInput.value,
                desvantagens: desvantagensInput.value,
                // Outros campos permanecem iguais
            };

            database.ref(`fichas/${currentFichaId}`).update(updates);
        }

        function recomecarFicha() {
            if (isFichaLocked && !isFichaUnlocked) {
                abrirModalSenha();
                return;
            }

            resetarPontos();
            nomePersonagemInput.value = '';
            // Reset de outros campos permanece igual
            vantagensInput.value = '';
            magiasHabilidadesInput.value = '';
            desvantagensInput.value = '';
            vantagensSelecionadas = [];
            desvantagensSelecionadas = [];
            vantagensInput.setAttribute('readonly', 'readonly');
            desvantagensInput.setAttribute('readonly', 'readonly');
            calcularAtributos();
            salvarDados();
        }

        function comprarVantagem(vantagem) {
            if (vantagem.restricao === 'inicio' && nivel > 0) {
                alert('Essa vantagem só pode ser comprada no início do jogo (Nível 0)!');
                return;
            }

            if (vantagensSelecionadas.includes(vantagem.nome)) {
                if (!isMatrizUnlocked) {
                    alert('Apenas a senha matriz pode remover vantagens!');
                    abrirModalSenha();
                    return;
                }
                document.getElementById('excluir-vantagem-modal').style.display = 'flex';
                document.getElementById('confirmar-excluir-vantagem-btn').onclick = () => {
                    vantagensSelecionadas = vantagensSelecionadas.filter(v => v !== vantagem.nome);
                    pontosVantagem += vantagem.custo;
                    pontosVantagemSpan.textContent = pontosVantagem;
                    vantagensInput.value = vantagensSelecionadas.join('\n');
                    atualizarVantagensDesvantagensPanel();
                    fecharModal('excluir-vantagem-modal');
                    document.getElementById('salvar-vantagens-btn').style.display = 'block';
                    salvarDados();
                };
                return;
            }

            if (pontosVantagem >= vantagem.custo) {
                document.getElementById('confirmar-compra-modal').style.display = 'flex';
                document.getElementById('confirmar-compra-btn').onclick = () => {
                    vantagensSelecionadas.push(vantagem.nome);
                    pontosVantagem -= vantagem.custo;
                    pontosVantagemSpan.textContent = pontosVantagem;
                    vantagensInput.value = vantagensSelecionadas.join('\n');
                    atualizarVantagensDesvantagensPanel();
                    fecharModal('confirmar-compra-modal');
                    document.getElementById('salvar-vantagens-btn').style.display = 'block';
                    salvarDados();
                };
            } else {
                alert('Pontos de Vantagem insuficientes!');
            }
        }

        function comprarDesvantagem(desvantagem) {
            if (desvantagensSelecionadas.includes(desvantagem.nome)) {
                if (!isMatrizUnlocked) {
                    alert('Apenas a senha matriz pode remover desvantagens!');
                    abrirModalSenha();
                    return;
                }
                document.getElementById('excluir-desvantagem-modal').style.display = 'flex';
                document.getElementById('confirmar-excluir-desvantagem-btn').onclick = () => {
                    desvantagensSelecionadas = desvantagensSelecionadas.filter(d => d !== desvantagem.nome);
                    pontosVantagem -= desvantagem.ganho;
                    pontosVantagemSpan.textContent = pontosVantagem;
                    desvantagensInput.value = desvantagensSelecionadas.join('\n');
                    atualizarVantagensDesvantagensPanel();
                    fecharModal('excluir-desvantagem-modal');
                    document.getElementById('salvar-vantagens-btn').style.display = 'block';
                    salvarDados();
                };
                return;
            }

            if (desvantagensSelecionadas.length >= 3) {
                alert('Você já atingiu o limite de 3 desvantagens!');
                return;
            }

            document.getElementById('confirmar-compra-modal').style.display = 'flex';
            document.getElementById('confirmar-compra-btn').onclick = () => {
                desvantagensSelecionadas.push(desvantagem.nome);
                pontosVantagem += desvantagem.ganho;
                pontosVantagemSpan.textContent = pontosVantagem;
                desvantagensInput.value = desvantagensSelecionadas.join('\n');
                atualizarVantagensDesvantagensPanel();
                fecharModal('confirmar-compra-modal');
                document.getElementById('salvar-vantagens-btn').style.display = 'block';
                salvarDados();
            };
        }

        // Listeners de input (removidos para vantagens/desvantagens)
        [descricaoPersonagemInput, magiasHabilidadesInput, inventarioInput].forEach(input => {
            input.oninput = () => salvarDados();
        });

        // Restante do script (atualizarBotaoBloquear, calcularAtributos, etc.) permanece igual

        criarFichaMatriz();
    </script>
</body>
</html>
