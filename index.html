<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ficha de Personagem RPG</title>
    <link href="https://fonts.googleapis.com/css2?family=MedievalSharp&family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@tailwindcss/browser@4"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0e6d2; /* Cor de pergaminho padrão */
            color: #000;
            display: flex;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            background-image: none;
            background-size: cover;
            background-position: center;
            background-attachment: fixed; /* Faz a imagem de fundo ficar fixa na viewport */
            transition: background 0.3s, color 0.3s;
        }
        body.dark-mode {
            background-color: #121212 !important; /* Garante que o fundo seja sempre escuro */
            color: #e0e0e0;
        }
        #chat-btn-container { position: fixed; left: 10px; top: calc(50% - 120px); z-index: 1000; }
        #chat-btn {
            padding: 15px;
            background: #f0e6d2;
            border: 2px solid #b8860b;
            border-radius: 8px;
            font-family: 'MedievalSharp', serif;
            font-size: 1.2rem;
            color: #000;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 3px 3px 7px rgba(0, 0, 0, 0.3);
            z-index: 1000;
        }
        #chat-btn:hover { background: #a0522d; transform: translateY(-3px); }
        #chat-btn::after {
            content: attr(data-unread);
            position: absolute;
            top: -10px;
            right: -10px;
            background-color: red;
            color: white;
            border-radius: 50%;
            padding: 5px;
            font-size: 0.8rem;
            min-width: 20px;
            text-align: center;
            display: none;
        }
        #chat-btn[data-unread]:after { display: block; }
        body.dark-mode #chat-btn { background: #1e1e1e; color: #e0e0e0; border-color: #444; }
        body.dark-mode #chat-btn:hover { background: #333; }
        #fichas-sidebar {
            width: 100%; height: 60px; padding: 0; display: flex; flex-direction: row;
            align-items: center; justify-content: flex-start; position: fixed;
            top: 0; left: 0; z-index: 1000; overflow-x: auto; background: transparent;
        }
        .ficha-tab {
            visibility: visible; width: 100px; height: 50px; background: #f0e6d2;
            border: 2px solid #b8860b; border-radius: 10px 10px 0 0; margin-right: 10px;
            display: flex; align-items: center; justify-content: center; cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.2);
        }
        .ficha-tab:hover, .ficha-tab.active { background: #a0522d; transform: translateY(-5px); }
        .ficha-tab span {
            font-family: 'MedievalSharp', serif; color: #000; font-size: 0.9rem; text-align: center;
            max-width: 90px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
        }
        #add-ficha-btn {
            width: 100px; height: 50px; background: #f0e6d2; border: 2px solid #b8860b;
            border-radius: 10px 10px 0 0; margin-right: 10px; display: flex; align-items: center;
            justify-content: center; cursor: pointer; transition: transform 0.2s ease;
            box-shadow: 0 0 10px #ffd700, 0 0 20px #ffd700; z-index: 1001;
        }
        #add-ficha-btn span { font-family: 'MedievalSharp', serif; color: #000; font-size: 0.9rem; }
        #add-ficha-btn:hover { background: #a0522d; transform: translateY(-5px); }
        #ficha-container {
            background: rgba(240, 230, 210, 0.95); padding: 30px; border-radius: 12px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2); width: 95%; max-width: 1200px;
            margin: 80px auto 20px; border: 2px solid #b8860b; position: relative; z-index: 1;
        }
        body.dark-mode #ficha-container { background: rgba(30, 30, 30, 0.95); color: #e0e0e0; }
        #ficha-container.aura-azul { box-shadow: 0 0 30px 15px #00BFFF; animation: pulsar-aura 2s infinite; }
        @keyframes pulsar-aura {
            0% { box-shadow: 0 0 20px #00BFFF, 0 0 30px #00BFFF, 0 0 40px #00BFFF; }
            50% { box-shadow: 0 0 30px #00BFFF, 0 0 50px #00BFFF, 0 0 60px #00BFFF; }
            100% { box-shadow: 0 0 20px #00BFFF, 0 0 30px #00BFFF, 0 0 40px #00BFFF; }
        }
        h1#nome-personagem-titulo {
            font-family: 'MedievalSharp', serif; color: #1C2526; font-size: 3rem; margin-bottom: 20px;
            text-align: center; text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1); animation: raios 2s infinite linear;
        }
        @keyframes raios {
            0% { text-shadow: 0 0 5px #FFD700, 0 0 10px #FFD700, 0 0 15px #FFD700, 0 0 20px #FF4500; }
            50% { text-shadow: 0 0 10px #FFD700, 0 0 15px #FFD700, 0 0 20px #FF4500, 0 0 25px #FF4500; }
            100% { text-shadow: 0 0 5px #FFD700, 0 0 10px #FFD700, 0 0 15px #FFD700, 0 0 20px #FF4500; }
        }
        #game-master-message { display: none; color: blue; font-size: 1.5rem; text-align: center; font-family: 'MedievalSharp', serif; margin-bottom: 10px; }
        section { background: #f0e6d2; border: 2px solid #b8860b; border-radius: 8px; padding: 15px; margin-bottom: 20px; }
        section h2 { text-align: center; }
        body.dark-mode section { background: #1e1e1e; border-color: #444; }
        label { font-weight: 600; color: #000; margin-bottom: 8px; display: block; }
        body.dark-mode label { color: #e0e0e0; }
        input[type="text"], input[type="number"], textarea {
            padding: 10px; border: 2px solid #b8860b; border-radius: 6px; width: calc(100% - 24px);
            margin-bottom: 15px; font-size: 1rem; transition: border-color 0.3s ease;
            background: #fff; color: #000;
        }
        body.dark-mode input[type="text"], body.dark-mode input[type="number"], body.dark-mode textarea {
            background: #333; color: #e0e0e0; border-color: #555;
        }
        input[type="text"]:focus, input[type="number"]:focus, textarea:focus {
            border-color: #a0522d; outline: none; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        input[readonly], span[readonly] { background: #e8e8e8; border: 1px solid #ccc; cursor: not-allowed; }
        body.dark-mode input[readonly], body.dark-mode span[readonly] { background: #444; border-color: #666; }
        textarea { resize: vertical; }
        .atributos-container { display: flex; justify-content: space-between; gap: 20px; }
        .atributos-coluna, .atributos-coluna-destaque {
            width: 48%; display: flex; flex-direction: column; align-items: align-items: flex-start;
        }
        .atributos-coluna-destaque { background: #fff; padding: 10px; border-radius: 6px; border: 1px solid #b8860b; }
        body.dark-mode .atributos-coluna-destaque { background: #333; border-color: #555; }
        .atributo-destaque { padding: 8px; margin-bottom: 10px; display: flex; align-items: center; justify-content: space-between; width: 100%; }
        .atributo-destaque label { font-size: 1.1rem; font-weight: 700; color: #a0522d; }
        .atributo-destaque span { font-size: 1.2rem; font-family: 'MedievalSharp', serif; color: #000; }
        body.dark-mode .atributo-destaque span { color: #e0e0e0; }
        .atributo-fogo { animation: fogo 1.5s infinite; }
        @keyframes fogo {
            0% { text-shadow: 0 0 5px #ff4500, 0 0 10px #ff4500; }
            50% { text-shadow: 0 0 10px #ff4500, 0 0 15px #ffd700; }
            100% { text-shadow: 0 0 5px #ff4500, 0 0 10px #ff4500; }
        }
        .vida-magia-vigor { display: flex; justify-content: space-around; gap: 15px; flex-wrap: wrap; }
        .atributo-container {
            background: rgba(255, 255, 255, 0.8); padding: 12px; border-radius: 8px; border: 1px solid #b8860b;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); width: 30%; min-width: 200px; text-align: center;
        }
        body.dark-mode .atributo-container { background: rgba(50, 50, 50, 0.8); }
        .atributo-container::before { font-size: 1.5rem; margin-bottom: 5px; display: block; }
        .atributo-container.vida::before { content: "❤️"; }
        .atributo-container.magia::before { content: "✨"; }
        .atributo-container.vigor::before { content: "⚡"; }
        .medieval-box { background: #f0e6d2; border: 2px solid #b8860b; border-radius: 8px; padding: 10px; margin: 5px 0; text-align: center; }
        body.dark-mode .medieval-box { background: #1e1e1e; border-color: #444; }
        .regeneracao { font-size: 0.8rem; color: #555; margin-top: 5px; }
        body.dark-mode .regeneracao { color: #aaa; }
        button {
            background: #b8860b; color: #fff; border: none; padding: 5px 10px;
            cursor: pointer; font-size: 1.2rem; border-radius: 4px; margin: 0 5px;
            transition: background-color 0.3s ease;
        }
        body.dark-mode button { background: #555; }
        button:hover { background: #a0522d; }
        body.dark-mode button:hover { background: #777; }
        .botoes-container { display: flex; justify-content: center; gap: 10px; margin-top: 20px; margin-bottom: 20px; flex-wrap: wrap; /* Allow wrapping */ }
        .botao {
            padding: 12px 25px; border: none; border-radius: 6px; font-size: 1rem; cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease; font-family: 'MedievalSharp', serif;
            color: #fff; text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
        }
        body.dark-mode .botao { background: #555; }
        body.dark-mode .botao:hover { background: #777; }
        /* Removed individual background colors - keeping them for specific buttons */
        #reset-pontos, #recomecar, #bloquear-ficha, #plano-fundo-btn, #excluir-ficha { background-color: #800000; }
        .botao-reset:hover, .botao-recomecar:hover, .botao-bloquear:hover, .botao-desbloquear:hover, #excluir-ficha:hover {
            background: #a0522d; transform: translateY(-2px);
        }
        /* New styles for icon buttons */
        .icon-btn {
            padding: 10px; width: 44px; height: 44px;
            font-size: 1.2rem; line-height: 1; text-align: center;
        }
        #lua-btn { background-color: #333; color: #eee; } /* Keep specific colors */
        #sol-btn { background-color: #ffdd00; color: #333; } /* Keep specific colors */
        #cor-fundo-btn { background-color: #800000; } /* Keep specific color */

        #cor-fundo-btn-wrapper { line-height: 1; vertical-align: middle; }

        #nivel-container { text-align: center; margin-top: 10px; }
        #nivel {
            padding: 10px; background: #f0e6d2; border: 3px solid #000; border-radius: 50%;
            width: 100px; height: 100px; display: flex; align-items: center; justify-content: center;
            font-size: 3.125rem; box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.5); margin: 0 auto;
        }
        body.dark-mode #nivel { background: #1e1e1e; border-color: #444; }
        #nivel.aura-azul { animation: pulsar-aura 2s 10; }
        .expandable-textarea {
            height: 100px; width: 100%; background: #fff; border: 2px solid #b8860b;
            border-radius: 6px; padding: 10px; font-size: 0.9rem; transition: height 0.3s ease;
        }
        body.dark-mode .expandable-textarea { background: #333; }
        .expandable-textarea:focus { height: 15cm; }
        #dice-container {
            position: absolute; top: 20px; right: 20px; width: 200px; text-align: center;
            font-family: 'MedievalSharp', serif; cursor: move; z-index: 10; user-select: none;
        }
        #dice-container label { font-size: 1.2rem; color: #000; display: flex; align-items: center; justify-content: center; margin-bottom: 10px; }
        body.dark-mode #dice-container label { color: #e0e0e0; }
        #dice-container label::before { content: "🎲"; margin-right: 5px; font-size: 1.5rem; }
        #dice-roll {
            width: 100px; height: 100px; background: #f0e6d2; border: 2px solid #b8860b; border-radius: 10px;
            display: flex; align-items: center; justify-content: center; font-size: 2rem; cursor: pointer;
            margin: 0 auto; position: relative; transition: all 0.3s ease;
        }
        body.dark-mode #dice-roll { background: #1e1e1e; border-color: #444; }
        #dice-roll::before { content: "⚅"; font-size: 1.5rem; position: absolute; top: 5px; right: 5px; color: #a0522d; }
        #dice-result { margin-top: 10px; font-size: 1rem; color: #000; display: none; animation: blink 1s infinite; }
        body.dark-mode #dice-result { color: #e0e0e0; }
        @keyframes blink { 50% { opacity: 0; } }
        #dice-roll.critical-failure { animation: aura-vermelha 2s infinite; }
        #dice-roll.critical-success { animation: aura-verde 2s infinite; }
        @keyframes aura-vermelha {
            0% { box-shadow: 0 0 5px #ff0000, 0 0 10px #ff0000; }
            50% { box-shadow: 0 0 15px #ff0000, 0 0 20px #ff0000; }
            100% { box-shadow: 0 0 5px #ff0000, 0 0 10px #ff0000; }
        }
        @keyframes aura-verde {
            0% { box-shadow: 0 0 5px #00ff00, 0 0 10px #00ff00; }
            50% { box-shadow: 0 0 15px #00ff00, 0 0 20px #00ff00; }
            100% { box-shadow: 0 0 5px #00ff00, 0 0 10px #00ff00; }
        }
        #notification {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); padding: 20px;
            border-radius: 8px; font-family: 'MedievalSharp', serif; font-size: 1.5rem; color: #fff;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5); display: none; z-index: 100;
            background: rgba(0, 0, 0, 0.7); transition: opacity 0.3s ease;
        }
        #notification.critical-failure { background: rgba(255, 0, 0, 0.8); animation: aura-vermelha 2s infinite; }
        #notification.critical-success { background: rgba(0, 255, 0, 0.8); animation: aura-verde 2s infinite; }
        #notification.normal-result, #notification.save-success { animation: blink 1s infinite; }
        #notification.save-success { background: rgba(0, 200, 0, 0.8); }
        #character-image-container {
            position: absolute; top: 10px; left: 10px; width: 100px; height: 100px; background: #f0e6d2;
            border: 2px solid #b8860b; border-radius: 8px; display: flex; align-items: center;
            justify-content: center; cursor: pointer; overflow: hidden; z-index: 10;
        }
        body.dark-mode #character-image-container { background: #1e1e1e; }
        #character-image { width: 100%; height: 100%; object-fit: cover; display: none; }
        #character-image-container:hover { box-shadow: 0 0 10px #ffd700; }
        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.5); justify-content: center; align-items: center; z-index: 1000;
        }
        .modal-content {
            background: #f0e6d2; padding: 20px; border-radius: 8px; border: 2px solid #b8860b;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3); width: 300px; text-align: center;
        }
        body.dark-mode .modal-content { background: #1e1e1e; border-color: #444; }
        .modal-content h3 { font-family: 'MedievalSharp', serif; color: #000; margin-bottom: 15px; }
        body.dark-mode .modal-content h3 { color: #e0e0e0; }
        .modal-content input { width: calc(100% - 20px); padding: 10px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 6px; }
        body.dark-mode .modal-content input { background: #333; color: #e0e0e0; border-color: #555; }
        .modal-content button {
            padding: 10px 20px; border: none; border-radius: 6px; font-family: 'MedievalSharp', serif;
            color: #fff; cursor: pointer; margin: 0 5px;
        }
        .modal-content .confirm-btn { background: #b8860b; }
        .modal-content .confirm-btn:hover { background: #a0522d; }
        .modal-content .cancel-btn { background: #a52a2a; }
        .modal-content .cancel-btn:hover { background: #8b0000; }
        #vantagens-desvantagens-btn, #racas-btn, #classes-btn {
            padding: 10px 20px; background: #f0e6d2; border: 2px solid #b8860b; border-radius: 6px;
            font-family: 'MedievalSharp', serif; font-size: 1rem; color: #000; cursor: pointer;
            transition: background-color 0.3s ease; z-index: 10;
        }
        body.dark-mode #vantagens-desvantagens-btn, body.dark-mode #racas-btn, body.dark-mode #classes-btn {
            background: #1e1e1e; color: #e0e0e0;
        }
        #vantagens-desvantagens-btn:hover, #racas-btn:hover, #classes-btn:hover { background: #a0522d; color: #fff; }
        #vantagens-desvantagens-panel, #racas-panel, #classes-panel {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(240, 230, 210, 0.95); padding: 20px; overflow-y: auto; z-index: 999;
            border: 2px solid #b8860b; box-shadow: 0 0 20px rgba(0, 0, 0, 0.3);
        }
        body.dark-mode #vantagens-desvantagens-panel, body.dark-mode #racas-panel, body.dark-mode #classes-panel {
            background: rgba(30, 30, 30, 0.95);
        }
        #vantagens-desvantagens-panel h2, #racas-panel h2, #classes-panel h2 {
            font-family: 'MedievalSharp', serif; font-size: 2rem; text-align: center;
            color: #a0522d; margin-bottom: 20px;
        }
        #racas-panel h2 { font-size: 3rem; }
        .vantagem-item, .desvantagem-item, .raca-item {
            padding: 10px; margin: 5px 0; background: #fff; border: 1px solid #ccc;
            border-radius: 6px; cursor: pointer; transition: background-color 0.3s ease;
        }
        body.dark-mode .vantagem-item, body.dark-mode .desvantagem-item, body.dark-mode .raca-item {
            background: #333; border-color: #555;
        }
        .vantagem-item:hover, .desvantagem-item:hover, .raca-item:hover { background: #f0e6d2; }
        body.dark-mode .vantagem-item:hover, body.dark-mode .desvantagem-item:hover, body.dark-mode .raca-item:hover { background: #444; }
        .vantagem-item.comprada, .raca-item.comprada { background: #ffcccc; color: #f00; cursor: default; }
        .desvantagem-item.comprada { background: #ccffcc; color: #080; cursor: default; }
        #salvar-vantagens-btn, #salvar-racas-btn, #fechar-pagina-btn, #fechar-racas-btn, #fechar-classes-btn {
            position: fixed; bottom: 20px; padding: 12px 25px; background: #a52a2a; color: #fff;
            border: none; border-radius: 6px; font-family: 'MedievalSharp', serif; font-size: 1.2rem;
            cursor: pointer; transition: transform 0.2s ease;
        }
        #salvar-vantagens-btn, #salvar-racas-btn { right: 250px; animation: aura-verde-btn 2s infinite; display: none; background: #000; }
        #fechar-pagina-btn, #fechar-racas-btn, #fechar-classes-btn { right: 20px; }
        #salvar-vantagens-btn:hover, #salvar-racas-btn:hover, #fechar-pagina-btn:hover, #fechar-racas-btn:hover, #fechar-classes-btn:hover {
            transform: translateY(-2px);
        }
        @keyframes aura-verde-btn {
            0% { box-shadow: 0 0 5px #00ff00, 0 0 10px #00ff00; }
            50% { box-shadow: 0 0 15px #00ff00, 0 0 20px #00ff00; }
            100% { box-shadow: 0 0 5px #00ff00, 0 0 10px #00ff00; }
        }
        .locomotion-container { background: #8B4513; border: 3px solid #FFD700; border-radius: 10px; padding: 15px; color: #FFD700; font-family: 'MedievalSharp', serif; }
        .locomotion-item { display: flex; align-items: center; margin-bottom: 10px; }
        .locomotion-item label { font-weight: bold; color: #FFD700; }
        .locomotion-item span { font-size: 1.2rem; color: #FFF; text-shadow: 1px 1px 2px #000; margin-left: 5px; font-weight: bold; }
        #distancia-pulo, #altura-pulo, #velocidade-corrida { background-color: #8B4513; border-color: #8B4513; }
        .list-display { background: #fff; border: 2px solid #b8860b; border-radius: 6px; padding: 10px; min-height: 100px; max-height: 200px; overflow-y: auto; }
        body.dark-mode .list-display { background: #333; border-color: #555; }
        .list-item { cursor: pointer; margin-bottom: 5px; padding: 5px; border-bottom: 1px solid #ccc; }
        body.dark-mode .list-item { border-color: #555; }
        .list-item:hover { background: #e0e0e0; }
        body.dark-mode .list-item:hover { background: #444; }
        .inventory-slot { display: flex; align-items: center; margin-bottom: 10px; }
        .inventory-slot input[type="text"] { flex-grow: 1; margin-right: 10px; }
        .inventory-slot input[type="number"] { width: 60px; }
        #anotacoes-btn {
            position: fixed; left: 10px; top: 50%; transform: translateY(-50%); padding: 10px 20px;
            background: #f0e6d2; border: 2px solid #b8860b; border-radius: 6px;
            font-family: 'MedievalSharp', serif; font-size: 1rem; color: #000; cursor: pointer;
            transition: background-color 0.3s ease; z-index: 1000;
        }
        body.dark-mode #anotacoes-btn { background: #1e1e1e; color: #e0e0e0; }
        #anotacoes-btn:hover, #historico-dados-btn:hover { background: #a0522d; color: #fff; }
        #anotacoes-textarea {
            display: none; position: fixed; left: 60px; top: 50%; transform: translateY(-50%);
            width: 400px; height: 400px; background: #fff; border: 2px solid #b8860b;
            border-radius: 6px; padding: 10px; font-size: 0.9rem; resize: none; z-index: 1001;
        }
        body.dark-mode #anotacoes-textarea { background: #333; color: #e0e0e0; }
        #historico-dados-btn {
            position: fixed; right: 10px; top: 50%; transform: translateY(-50%); padding: 10px 20px;
            background: #f0e6d2; border: 2px solid #b8860b; border-radius: 6px;
            font-family: 'MedievalSharp', serif; font-size: 1rem; color: #000; cursor: pointer;
            transition: background-color 0.3s ease;
        }
        body.dark-mode #historico-dados-btn { background: #1e1e1e; color: #e0e0e0; }
        #historico-dados-panel {
            display: none; position: fixed; right: 10px; top: 50%; transform: translateY(-50%);
            width: 300px; background: #fff; border: 2px solid #b8860b; border-radius: 6px;
            padding: 10px; max-height: 400px; overflow-y: auto;
        }
        body.dark-mode #historico-dados-panel { background: #333; border-color: #555; }
        #historico-dados-panel h3 { font-family: 'MedievalSharp', serif; color: #000; margin-bottom: 10px; }
        body.dark-mode #historico-dados-panel h3 { color: #e0e0e0; }
        #historico-lista div { padding: 5px; border-bottom: 1px solid #ccc; }
        body.dark-mode #historico-lista div { border-color: #555; }
        #excluir-historico-btn { background: #a52a2a; color: #fff; padding: 8px 16px; border-radius: 6px; cursor: pointer; margin-top: 10px; }
        #excluir-historico-btn:hover { background: #8b0000; }
        .magias-container { max-height: 300px; overflow-y: auto; border: 2px solid #b8860b; border-radius: 6px; padding: 10px; background: #fff; }
        body.dark-mode .magias-container { background: #333; border-color: #555; }
        .magias-container input { margin-bottom: 10px; }
        #adicionar-magia-btn { background: #b8860b; color: #fff; padding: 8px 16px; border-radius: 6px; cursor: pointer; display: block; margin-top: 10px; }
        #adicionar-magia-btn:hover { background: #a0522d; }
        .classe-raca-container { background: #f0e6d2; border: 2px solid #b8860b; padding: 10px; border-radius: 6px; margin-top: 10px; }
        body.dark-mode .classe-raca-container { background: #1e1e1e; border-color: #444; }
        .classe-raca-container label { font-family: 'MedievalSharp', serif; color: #a0522d; font-size: 1.2rem; }
        .classe-raca-container span[onclick] { background: #fff; border: 2px solid #b8860b; padding: 10px; cursor: pointer; display: block; }
        body.dark-mode .classe-raca-container span[onclick] { background: #333; color: #e0e0e0; }
        .classe-raca-container textarea { width: 100%; background: #fff; border: 2px solid #b8860b; }
        body.dark-mode .classe-raca-container textarea { background: #333; color: #e0e0e0; }
        .raca-item { margin-bottom: 20px; padding: 10px; background: #fff; border: 2px solid #b8860b; border-radius: 6px; }
        .raca-item h3 { font-family: 'MedievalSharp', serif; font-size: 1.5rem; color: #a0522d; }
        .raca-item p { font-size: 1rem; color: #000; }
        body.dark-mode .raca-item { background: #333; border-color: #555; }
        body.dark-mode .raca-item p { color: #e0e0e0; }
        /* Container for theme/color buttons */
        .theme-color-container { display: flex; justify-content: center; gap: 10px; margin-top: -10px; margin-bottom: 20px; }
        #background-color-selector {
             bottom: 100%; /* Position above the button */
             left: 50%;
             transform: translateX(-50%);
             margin-bottom: 5px; /* Space between button and selector */
             margin-top: 0;
             display: none; /* Keep hidden initially */
             position: absolute; background-color: #fff; border: 1px solid #ccc; padding: 10px; border-radius: 5px; z-index: 1002; display: flex; gap: 10px;
        }
         /* Ensure popup display logic works */
        #background-color-selector { display: none; }

        @media (max-width: 768px) {
            body { padding: 10px; }
            #ficha-container { padding: 15px; }
            h1#nome-personagem-titulo { font-size: 2rem; }
            section h2 { font-size: 1.2rem; }
            input, textarea { font-size: 0.9rem; }
            .atributos-container, .vida-magia-vigor { flex-direction: column; }
            .atributos-coluna, .atributos-coluna-destaque, .atributo-container { width: 100%; }
            .botoes-container, .theme-color-container { flex-direction: row; flex-wrap: wrap; } /* Ensure wrapping on small screens */
        }
        /* Estilos para o modal de chat */
        #chat-modal { display: none; }
        #chat-modal .modal-content { width: 500px; max-height: 80vh; display: flex; flex-direction: column; }
        #chat-modal .chat-header { padding: 10px; border-bottom: 1px solid #ccc; font-family: 'MedievalSharp', serif; font-size: 1.5rem; text-align: center; }
        #chat-modal .chat-body { flex-grow: 1; display: flex; overflow: hidden; }
        #chat-modal .user-list { width: 150px; border-right: 1px solid #ccc; overflow-y: auto; padding: 10px; }
        #chat-modal .user-list h4 { font-family: 'MedievalSharp', serif; margin-bottom: 5px; }
        #chat-modal .user-list .user-item { padding: 8px; cursor: pointer; border-bottom: 1px solid #eee; }
        #chat-modal .user-list .user-item:hover { background-color: #f0e6d2; }
        body.dark-mode #chat-modal .user-list .user-item:hover { background-color: #333; }
        #chat-modal .conversation { flex-grow: 1; padding: 10px; overflow-y: auto; display: flex; flex-direction: column; }
        #chat-modal .message-container { display: flex; flex-direction: column; margin-bottom: 8px; }
        #chat-modal .message { padding: 8px; border-radius: 5px; background-color: #e0e0e0; color: #000; width: fit-content; max-width: 80%; }
        body.dark-mode #chat-modal .message { background-color: #444; color: #e0e0e0; }
        #chat-modal .message.sent { background-color: #cce5ff; align-self: flex-end; }
        body.dark-mode #chat-modal .message.sent { background-color: #6699cc; color: #e0e0e0; }
        #chat-modal .sender-name { font-size: 0.8rem; color: #777; margin-bottom: 2px; }
        body.dark-mode #chat-modal .sender-name { color: #aaa; }
        #chat-modal .chat-input { padding: 10px; border-top: 1px solid #ccc; display: flex; }
        #chat-modal .chat-input input[type="text"] { flex-grow: 1; padding: 8px; border-radius: 5px; border: 1px solid #ccc; margin-right: 10px; }
        body.dark-mode #chat-modal .chat-input input[type="text"] { background-color: #333; color: #e0e0e0; border-color: #555; }
        #chat-modal .chat-input button { padding: 8px 15px; border-radius: 5px; }
        /* Estilos para os modais de senha do chat */
        #chat-password-modal .modal-content, #open-chat-modal .modal-content { width: 350px; }
        /* Espaçamento dos botões de raça */
        #raca-opcoes-modal .modal-content button:nth-child(2) { margin-top: 10px; }
        /* Estilos para o modal de plano de fundo */
        #background-modal { display: none; }
        #background-modal .modal-content { width: 400px; text-align: left; }
        #background-modal .modal-content label { display: block; margin-bottom: 5px; }
        #background-modal .modal-content input[type="file"] { margin-bottom: 10px; }
        #background-modal .modal-content .radio-group { margin-bottom: 15px; }
        #background-modal .modal-content .radio-group label { display: inline-block; margin-right: 10px; }
        /* Estilos para o seletor de cor de fundo */
        .color-option { width: 24px; height: 24px; border-radius: 50%; cursor: pointer; border: 1px solid #ccc; }
    </style>
</head>
<body>
    <div id="chat-btn-container">
        <button id="chat-btn" data-unread="0">💬 Chat</button>
    </div>
    <div id="fichas-sidebar">
        <div id="add-ficha-btn"><span>+ Fichas</span></div>
    </div>
    <div id="ficha-container">
        <h1 id="nome-personagem-titulo">Ficha de Personagem</h1>
        <div id="game-master-message">Você virou o Game Master</div>
        <div id="character-image-container" onclick="document.getElementById('character-image-input').click()">
            <img id="character-image" alt="Imagem Sufficiently do Personagem">
            <input type="file" id="character-image-input" accept="image/*" style="display:none">
        </div>
        <div id="dice-container">
            <label>Role seu dado:</label>
            <div id="dice-roll">-</div>
            <div id="dice-result"></div>
        </div>
        <div id="ficha-content">
            <section id="informacoes-basicas">
                <h2>Informações Básicas</h2>
                <label for="nome-personagem">Nome do Personagem:</label>
                <input type="text" id="nome-personagem" placeholder="Digite o nome do seu personagem">
                <label for="descricao-personagem">Descrição do Personagem:</label>
                <textarea id="descricao-personagem" placeholder="Digite a descrição do seu personagem"></textarea>
            </section>
            <section id="recursos">
                <h2>Recursos</h2>
                <div class="vida-magia-vigor">
                    <div class="atributo-container vida">
                        <h3>Vida</h3>
                        <div class="valor-total medieval-box">
                            <span>Vida Total: </span>
                            <span id="vida-total" readonly>50</span>
                        </div>
                        <div class="valor-atual medieval-box">
                            <span>Vida Atual: </span>
                            <button onclick="diminuirVida()" title="Diminuir Vida">▼</button>
                            <span id="vida-atual">50</span>
                            <button onclick="aumentarVida()" title="Aumentar Vida">▲</button>
                        </div>
                        <div class="regeneracao">
                            <span>Regeneração por turno: <span id="regeneracao-vida">0</span> (parado)</span>
                        </div>
                    </div>
                    <div class="atributo-container magia">
                        <h3>Magia</h3>
                        <div class="valor-total medieval-box">
                            <span>Magia Total: </span>
                            <span id="magia-total" readonly>20</span>
                        </div>
                        <div class="valor-atual medieval-box">
                            <span>Magia Atual: </span>
                            <button onclick="diminuirMagia()" title="Diminuir Magia">▼</button>
                            <span id="magia-atual">20</span>
                            <button onclick="aumentarMagia()" title="Aumentar Magia">▲</button>
                        </div>
                        <div class="regeneracao">
                            <span>Regeneração por turno: <span id="regeneracao-magia">0</span></span>
                        </div>
                    </div>
                    <div class="atributo-container vigor">
                        <h3>Vigor</h3>
                        <div class="valor-total medieval-box">
                            <span>Vigor Total: </span>
                            <span id="vigor-total" readonly>10</span>
                        </div>
                        <div class="valor-atual medieval-box">
                            <span>Vigor Atual: </span>
                            <button onclick="diminuirVigor()" title="Diminuir Vigor">▼</button>
                            <span id="vigor-atual">10</span>
                            <button onclick="aumentarVigor()" title="Aumentar Vigor">▲</button>
                        </div>
                        <div class="regeneracao">
                            <span>Regeneração por turno: <span id="regeneracao-vigor">0</span> (parado)</span>
                        </div>
                    </div>
                </div>
            </section>
            <section id="atributos">
                <h2>Atributos</h2>
                <div class="atributos-container">
                    <div class="atributos-coluna">
                        <div class="atributo">
                            <label for="forca" title="Afeta ataque e RDF">Força:</label>
                            <input type="number" id="forca" value="0" min="0">
                        </div>
                        <div class="atributo">
                            <label for="destreza" title="Afeta ataque e acerto">Destreza:</label>
                            <input type="number" id="destreza" value="0" min="0">
                        </div>
                        <div class="atributo">
                            <label for="agilidade" title="Afeta esquiva e acerto">Agilidade:</label>
                            <input type="number" id="agilidade" value="0" min="0">
                        </div>
                        <div class="atributo">
                            <label for="constituicao" title="Afeta vida, magia e vigor">Constituição:</label>
                            <input type="number" id="constituicao" value="0" min="0">
                        </div>
                        <div class="atributo">
                            <label for="inteligencia" title="Afeta ataque mágico e RDM">Inteligência:</label>
                            <input type="number" id="inteligencia" value="0" min="0">
                        </div>
                    </div>
                    <div class="atributos-coluna-destaque">
                        <div class="atributo-destaque">
                            <label>Ataque:</label>
                            <span id="ataque" readonly>0</span>
                        </div>
                        <div class="atributo-destaque">
                            <label>Ataque Mágico:</label>
                            <span id="ataque-magico" readonly>0</span>
                        </div>
                        <div class="atributo-destaque">
                            <label>Acerto:</label>
                            <span id="acerto" readonly>0</span>
                        </div>
                        <div class="atributo-destaque">
                            <label>Esquiva:</label>
                            <span id="esquiva" readonly>0</span>
                        </div>
                        <div class="atributo-destaque">
                            <label>RDF:</label>
                            <span id="rdf" readonly>0</span>
                        </div>
                        <div class="atributo-destaque">
                            <label>RDM:</label>
                            <span id="rdm" readonly>0</span>
                        </div>
                    </div>
                </div>
            </section>
            <section id="combate">
                <h2>Combate</h2>
                <div class="armamento-container">
                    <div class="armamento-coluna">
                        <label>Armamento Mão Direita:</label>
                        <div class="flex items-center mb-2">
                            <input type="text" id="arma-direita-nome" placeholder="Nome da Arma" class="mr-2">
                            <span>Ataque </span>
                            <input type="number" id="arma-direita-ataque" value="0" class="w-20 mr-2">
                            <span>Ataque Mágico </span>
                            <input type="number" id="arma-direita-ataque-magico" value="0" class="w-20">
                        </div>
                    </div>
                    <div class="armamento-coluna">
                        <label>Armamento Mão Esquerda:</label>
                        <div class="flex items-center">
                            <input type="text" id="arma-esquerda-nome" placeholder="Nome da Arma" class="mr-2">
                            <span>Ataque </span>
                            <input type="number" id="arma-esquerda-ataque" value="0" class="w-20 mr-2">
                            <span>Ataque Mágico </span>
                            <input type="number" id="arma-esquerda-ataque-magico" value="0" class="w-20">
                        </div>
                    </div>
                </div>
            </section>
            <section id="inventario-habilidades">
                <h2>Inventário e Habilidades</h2>
                <div class="flex gap-20">
                    <div style="width:50%">
                        <label>Inventário (Peso Total: <span id="peso-total">0</span> kg):</label>
                        <div id="inventario-slots">
                            <div class="inventory-slot"><input type="text" placeholder="Item 1" class="inventory-item"><input type="number" min="0" value="0" class="inventory-weight" title="Peso em kg"></div>
                            <div class="inventory-slot"><input type="text" placeholder="Item 2" class="inventory-item"><input type="number" min="0" value="0" class="inventory-weight"></div>
                            <div class="inventory-slot"><input type="text" placeholder="Item 3" class="inventory-item"><input type="number" min="0" value="0" class="inventory-weight"></div>
                            <div class="inventory-slot"><input type="text" placeholder="Item 4" class="inventory-item"><input type="number" min="0" value="0" class="inventory-weight"></div>
                            <div class="inventory-slot"><input type="text" placeholder="Item 5" class="inventory-item"><input type="number" min="0" value="0" class="inventory-weight"></div>
                            <div class="inventory-slot"><input type="text" placeholder="Item 6" class="inventory-item"><input type="number" min="0" value="0" class="inventory-weight"></div>
                            <div class="inventory-slot"><input type="text" placeholder="Item 7" class="inventory-item"><input type="number" min="0" value="0" class="inventory-weight"></div>
                            <div class="inventory-slot"><input type="text" placeholder="Item 8" class="inventory-item"><input type="number" min="0" value="0" class="inventory-weight"></div>
                            <div class="inventory-slot"><input type="text" placeholder="Item 9" class="inventory-item"><input type="number" min="0" value="0" class="inventory-weight"></div>
                            <div class="inventory-slot"><input type="text" placeholder="Item 10" class="inventory-item"><input type="number" min="0" value="0" class="inventory-weight"></div>
                        </div>
                    </div>
                    <div style="width:50%">
                        <label>Magias e Habilidades:</label>
                        <div id="magias-list" class="magias-container">
                            <input type="text" placeholder="Magia/Habilidade 1" class="magia-nome">
                            <input type="text" placeholder="Magia/Habilidade 2" class="magia-nome">
                            <input type="text" placeholder="Magia/Habilidade 3" class="magia-nome">
                            <input type="text" placeholder="Magia/Habilidade 4" class="magia-nome">
                            <input type="text" placeholder="Magia/Habilidade 5" class="magia-nome">
                            <input type="text" placeholder="Magia/Habilidade 6" class="magia-nome">
                            <input type="text" placeholder="Magia/Habilidade 7" class="magia-nome">
                            <input type="text" placeholder="Magia/Habilidade 8" class="magia-nome">
                            <input type="text" placeholder="Magia/Habilidade 9" class="magia-nome">
                            <input type="text" placeholder="Magia/Habilidade 10" class="magia-nome">
                        </div>
                        <button id="adicionar-magia-btn">Adicionar Magia</button>
                    </div>
                </div>
                <div class="mt-4">
                    <label>Vantagens:</label>
                    <div id="vantagens-list-display" class="list-display"></div>
                    <label>Desvantagens:</label>
                    <div id="desvantagens-list-display" class="list-display"></div>
                </div>
                <div class="classe-raca-container">
                    <label>Classe:</label>
                    <input type="text" id="classe-nome" placeholder="Nome da Classe">
                    <textarea id="classe-descricao" placeholder="Descrição da Classe" class="expandable-textarea"></textarea>
                    <label>Raça:</label>
                    <span id="raca-nome" onclick="abrirModalRaca()"></span>
                    <textarea id="raca-descricao" placeholder="Descrição da Raça" class="expandable-textarea" readonly></textarea>
                </div>
            </section>
            <section id="locomocao">
                <h2>Locomoção</h2>
                <div class="locomotion-container">
                    <div class="locomotion-item">
                        <label>Velocidade de Corrida (km/h):</label><span>🏃‍♂️</span><span id="velocidade-corrida" readonly>25</span>
                    </div>
                    <div class="locomotion-item">
                        <label>Altura do Pulo (m):</label><span>⬆️</span><span id="altura-pulo" readonly>1</span>
                    </div>
                    <div class="locomotion-item">
                        <label>Distância do Pulo (m):</label><span>➡️</span><span id="distancia-pulo" readonly>3</span>
                    </div>
                </div>
            </section>
            <section id="status">
                <h2>Status</h2>
                <div class="flex gap-20">
                    <div>
                        <label>Experiência:</label>
                        <input type="number" id="experiencia" value="0" min="0">
                        <label>Pontos de Habilidade (PD):</label>
                        <span id="pontos-habilidade" readonly>25</span>
                        <label>Pontos de Vantagem (PH):</label>
                        <span id="pontos-vantagem" readonly>8</span>
                    </div>
                    <div></div>
                </div>
                <div id="nivel-container">
                    <label>Nível:</label>
                    <span id="nivel">0</span>
                </div>
            </section>

            <div style="display:flex;justify-content:center;gap:20px;margin-bottom:20px">
                <button id="vantagens-desvantagens-btn">Vantagens e Desvantagens</button>
                <button id="racas-btn">Raças 🏰</button>
                <button id="classes-btn">Classes ⚔️</button>
            </div>

            <div class="botoes-container">
                <button id="reset-pontos" class="botao botao-reset">Reiniciar Pontos</button>
                <button id="recomecar" class="botao botao-recomecar">Recomeçar</button>
                <button id="bloquear-ficha" class="botao botao-bloquear">Bloquear Ficha</button>
                <button id="plano-fundo-btn" class="botao">Plano de fundo</button>
                <button id="excluir-ficha" class="botao botao-excluir">Excluir Ficha</button> </div>

            <div class="theme-color-container">
                <button id="lua-btn" class="botao icon-btn">🌙</button>
                <button id="sol-btn" class="botao icon-btn">☀️</button>
                <div id="cor-fundo-btn-wrapper" style="display: inline-block; position: relative;">
                     <button id="cor-fundo-btn" class="botao icon-btn">🎨</button> <div id="background-color-selector">
                          <div class="color-option" style="background-color: #800000;" data-color="#800000"></div>
                          <div class="color-option" style="background-color: #000080;" data-color="#000080"></div>
                          <div class="color-option" style="background-color: #ffffff;" data-color="#ffffff"></div>
                          <div class="color-option" style="background-color: #f0e6d2;" data-color="#f0e6d2"></div>
                          <div class="color-option" style="background-color: #ffc0cb;" data-color="#ffc0cb"></div>
                     </div>
                </div>
            </div>
        </div>
    </div>

    <div id="anotacoes-btn">📝 Anotações</div>
    <textarea id="anotacoes-textarea" placeholder="Suas anotações aqui..."></textarea>

    <div id="historico-dados-btn">🎲 Histórico</div>
    <div id="historico-dados-panel">
        <h3>Histórico de Dados</h3>
        <div id="historico-lista"></div>
        <button id="excluir-historico-btn">Excluir Histórico</button>
    </div>

    <div id="vantagens-desvantagens-panel">
        <h2>Vantagens e Desvantagens</h2>
        <div style="display: flex; gap: 20px;">
            <div id="vantagens-list" style="width: 50%;"></div>
            <div id="desvantagens-list" style="width: 50%;"></div>
        </div>
        <div style="text-align: center; margin-top: 20px;">PH Temporário: <span id="ph-temp">8</span></div>
        <button id="salvar-vantagens-btn">Salvar</button>
        <button id="fechar-pagina-btn">Fechar</button>
    </div>

    <div id="racas-panel">
        <h2>Raças</h2>
        <div id="racas-list"></div>
        <div style="text-align: center; margin-top: 20px;">PH Temporário: <span id="ph-temp-raca">8</span></div>
        <button id="salvar-racas-btn">Salvar</button>
        <button id="fechar-racas-btn">Fechar</button>
    </div>

    <div id="classes-panel">
        <h2>Classes</h2>
        <p>Em breve...</p>
        <button id="fechar-classes-btn">Fechar</button>
    </div>

    <div id="notification"></div>

    <div id="password-modal" class="modal">
        <div class="modal-content">
            <h3>Desbloquear Ficha</h3>
            <input type="password" id="senha-desbloqueio-input" placeholder="Digite a senha">
            <button class="confirm-btn" onclick="desbloquearFicha()">Desbloquear</button>
            <button class="cancel-btn" onclick="cancelarDesbloqueio()">Cancelar</button>
        </div>
    </div>

    <div id="bloquear-ficha-modal" class="modal">
        <div class="modal-content">
            <h3>Bloquear Ficha</h3>
            <input type="password" id="senha-bloqueio-input" placeholder="Digite uma senha de 4 dígitos" maxlength="4">
            <button class="confirm-btn" onclick="bloquearFicha()">Bloquear</button>
            <button class="cancel-btn" onclick="fecharModal('bloquear-ficha-modal')">Cancelar</button>
        </div>
    </div>

    <div id="senha-gm-modal" class="modal">
        <div class="modal-content">
            <h3>Senha do Game Master</h3>
            <input type="password" id="senha-gm-input" placeholder="Digite a senha do GM">
            <button id="confirmar-senha-gm-btn" class="confirm-btn">Confirmar</button>
            <button class="cancel-btn" onclick="fecharModal('senha-gm-modal')">Cancelar</button>
        </div>
    </div>

    <div id="salvar-vantagens-modal" class="modal">
         <div class="modal-content">
              <h3>Confirmar Alterações</h3>
              <p id="salvar-modal-texto"></p>
              <button id="confirmar-salvar-btn" class="confirm-btn">Confirmar</button>
              <button class="cancel-btn" onclick="fecharModal('salvar-vantagens-modal')">Cancelar</button>
         </div>
    </div>

    <div id="raca-opcoes-modal" class="modal">
        <div class="modal-content">
            <h3>Opções de Raça</h3>
            <button class="confirm-btn" onclick="editarRacaSelecionadaModal()">Editar Raça</button>
            <button class="cancel-btn" onclick="excluirRacaSelecionadaModal()">Excluir Raça</button>
            <button class="cancel-btn" onclick="fecharModal('raca-opcoes-modal')">Fechar</button>
        </div>
    </div>

    <div id="editar-raca-modal" class="modal">
        <div class="modal-content">
            <h3>Editar Raça</h3>
            <input type="text" id="editar-raca-nome" placeholder="Nome da Raça">
            <textarea id="editar-raca-descricao" placeholder="Descrição da Raça" class="expandable-textarea"></textarea>
            <button class="confirm-btn" onclick="salvarEdicaoRaca()">Salvar</button>
            <button class="cancel-btn" onclick="fecharModal('editar-raca-modal')">Cancelar</button>
        </div>
    </div>

    <div id="chat-password-modal" class="modal">
        <div class="modal-content">
            <h3>Definir Senha do Chat</h3>
            <input type="password" id="chat-senha-input" placeholder="Digite a senha">
            <input type="password" id="chat-confirmar-senha-input" placeholder="Confirme a senha">
            <button class="confirm-btn" onclick="definirSenhaChat()">Definir</button>
            <button class="cancel-btn" onclick="fecharModal('chat-password-modal')">Cancelar</button>
        </div>
    </div>

    <div id="open-chat-modal" class="modal">
        <div class="modal-content">
            <h3>Abrir Chat</h3>
            <input type="password" id="abrir-chat-senha-input" placeholder="Digite a senha do chat">
            <button class="confirm-btn" onclick="abrirChat()">Abrir</button>
            <button class="cancel-btn" onclick="fecharModal('open-chat-modal')">Cancelar</button>
        </div>
    </div>

    <div id="chat-modal" class="modal">
        <div class="modal-content">
            <div class="chat-header">Chat</div>
            <div class="chat-body">
                <div class="user-list">
                    <h4>Fichas Disponíveis</h4>
                    <div id="available-fichas"></div>
                </div>
                <div class="conversation" id="conversation-area">
                    <p>Selecione uma ficha para conversar</p>
                </div>
            </div>
            <div class="chat-input">
                <input type="text" id="mensagem-input" placeholder="Digite sua mensagem">
                <button class="confirm-btn" onclick="enviarMensagem()">Enviar</button>
            </div>
            <button class="cancel-btn" onclick="fecharModal('chat-modal')" style="margin-top: 10px;">Fechar</button>
        </div>
    </div>

    <div id="background-modal" class="modal">
        <div class="modal-content">
            <h3>Plano de Fundo</h3>
            <label for="background-image-input">Escolha uma imagem:</label>
            <input type="file" id="background-image-input" accept="image/*">
            <div class="radio-group">
                <label><input type="radio" name="background-size" value="cover" checked> Cover</label>
                <label><input type="radio" name="background-size" value="contain"> Contain</label>
                <label><input type="radio" name="background-size" value="auto"> Auto</label>
            </div>
            <button class="confirm-btn" onclick="aplicarPlanoDeFundo()">Aplicar</button>
            <button class="cancel-btn" onclick="excluirPlanoDeFundo()">Excluir</button>
            <button class="cancel-btn" onclick="fecharModal('background-modal')">Cancelar</button>
        </div>
    </div>

    <div id="confirmar-compra-modal" class="modal">
         <div class="modal-content">
              <h3>Confirmar Seleção</h3>
              <p>Deseja selecionar esta raça?</p>
              <button id="confirmar-compra-btn" class="confirm-btn">Sim</button>
              <button class="cancel-btn" onclick="fecharModal('confirmar-compra-modal')">Não</button>
         </div>
    </div>

    <audio id="new-message-sound" src="https://www.soundjay.com/buttons/beep-01a.mp3" preload="auto"></audio>

    <script>
        const database = firebase.database(), fichas = {}, nivelData = { 0: { pd: 25, xp: 0 }, 1: { pd: 30, xp: 100 }, 2: { pd: 35, xp: 250 }, 3: { pd: 40, xp: 450 }, 4: { pd: 45, xp: 700 }, 5: { pd: 50, xp: 1000 }, 6: { pd: 55, xp: 1350 }, 7: { pd: 60, xp: 1750 }, 8: { pd: 65, xp: 2200 }, 9: { pd: 70, xp: 2700 }, 10: { pd: 75, xp: 3250 } };
        let currentFichaId = "ficha-matriz", isFichaLocked = false, fichaPassword = null, isFichaUnlocked = false, chatPassword = null, isChatOpen = false, selectedChatUser = null;

        const vantagensData = [
            { nome: "Afinidade Elemental (3)", custo: 3, descricao: "Aumenta o ataque mágico em 10 pontos para um elemento específico.", restricao: "inicio" },
            { nome: "Combo Físico (4)", custo: 4, descricao: "Aumenta velocidade de corrida em 25 km/h, altura do pulo em 2m e distância do pulo em 6m." },
            { nome: "Regeneração Aprimorada (5)", custo: 5, descricao: "Dobra a regeneração de vida, magia e vigor por turno." }
        ];
        const desvantagensData = [
            { nome: "Fraqueza Elemental (3)", ganho: 3, descricao: "Recebe 20% mais dano de um elemento específico." },
            { nome: "Lentidão (2)", ganho: 2, descricao: "Reduz a velocidade de corrida em 10 km/h." },
            { nome: "Fragilidade (4)", ganho: 4, descricao: "Reduz a vida total em 20 pontos." }
        ];
        const racasData = [
            { nome: "Elfo (4)", custo: 4, descricao: "Seres ágeis e conectados à natureza.", vantagens: ["+10 em Agilidade", "Afinidade Elemental (Grátis)"] },
            { nome: "Orc (3)", custo: 3, descricao: "Guerreiros fortes e resistentes.", vantagens: ["+10 em Força", "+5 em Constituição"] },
            { nome: "Humano (2)", custo: 2, descricao: "Versáteis e adaptáveis.", vantagens: ["+5 em todos os atributos"] }
        ];

        const nomePersonagemInput = document.getElementById("nome-personagem"), descricaoPersonagemInput = document.getElementById("descricao-personagem"), experienciaInput = document.getElementById("experiencia"), pontosHabilidadeSpan = document.getElementById("pontos-habilidade"), pontosVantagemSpan = document.getElementById("pontos-vantagem"), nivelSpan = document.getElementById("nivel"), forcaInput = document.getElementById("forca"), destrezaInput = document.getElementById("destreza"), agilidadeInput = document.getElementById("agilidade"), constituicaoInput = document.getElementById("constituicao"), inteligenciaInput = document.getElementById("inteligencia"), ataqueSpan = document.getElementById("ataque"), ataqueMagicoSpan = document.getElementById("ataque-magico"), acertoSpan = document.getElementById("acerto"), esquivaSpan = document.getElementById("esquiva"), rdfSpan = document.getElementById("rdf"), rdmSpan = document.getElementById("rdm"), armaDireitaNomeInput = document.getElementById("arma-direita-nome"), armaDireitaAtaqueInput = document.getElementById("arma-direita-ataque"), armaDireitaAtaqueMagicoInput = document.getElementById("arma-direita-ataque-magico"), armaEsquerdaNomeInput = document.getElementById("arma-esquerda-nome"), armaEsquerdaAtaqueInput = document.getElementById("arma-esquerda-ataque"), armaEsquerdaAtaqueMagicoInput = document.getElementById("arma-esquerda-ataque-magico"), inventarioSlots = document.getElementById("inventario-slots"), pesoTotalSpan = document.getElementById("peso-total"), magiasList = document.getElementById("magias-list"), vantagensListDisplay = document.getElementById("vantagens-list-display"), desvantagensListDisplay = document.getElementById("desvantagens-list-display"), classeNomeInput = document.getElementById("classe-nome"), classeDescricaoInput = document.getElementById("classe-descricao"), racaNomeSpan = document.getElementById("raca-nome"), racaDescricaoInput = document.getElementById("raca-descricao"), velocidadeCorridaSpan = document.getElementById("velocidade-corrida"), alturaPuloSpan = document.getElementById("altura-pulo"), distanciaPuloSpan = document.getElementById("distancia-pulo"), resetPontosButton = document.getElementById("reset-pontos"), recomecarButton = document.getElementById("recomecar"), bloquearFichaButton = document.getElementById("bloquear-ficha"), vantagensDesvantagensBtn = document.getElementById("vantagens-desvantagens-btn"), racasBtn = document.getElementById("racas-btn"), classesBtn = document.getElementById("classes-btn"), luaBtn = document.getElementById("lua-btn"), solBtn = document.getElementById("sol-btn"), corFundoBtn = document.getElementById("cor-fundo-btn"), backgroundColorSelector = document.getElementById("background-color-selector"), anotacoesBtn = document.getElementById("anotacoes-btn"), anotacoesTextarea = document.getElementById("anotacoes-textarea"), adicionarMagiaBtn = document.getElementById("adicionar-magia-btn"), diceContainer = document.getElementById("dice-container"), diceRoll = document.getElementById("dice-roll"), diceResult = document.getElementById("dice-result"), notification = document.getElementById("notification"), characterImageInput = document.getElementById("character-image-input"), characterImage = document.getElementById("character-image"), vantagensDesvantagensPanel = document.getElementById("vantagens-desvantagens-panel"), vantagensList = document.getElementById("vantagens-list"), desvantagensList = document.getElementById("desvantagens-list"), salvarVantagensBtn = document.getElementById("salvar-vantagens-btn"), fecharPaginaBtn = document.getElementById("fechar-pagina-btn"), racasPanel = document.getElementById("racas-panel"), racasList = document.getElementById("racas-list"), salvarRacasBtn = document.getElementById("salvar-racas-btn"), fecharRacasBtn = document.getElementById("fechar-racas-btn"), classesPanel = document.getElementById("classes-panel"), fecharClassesBtn = document.getElementById("fechar-classes-btn"), chatBtn = document.getElementById("chat-btn"), availableFichasDiv = document.getElementById("available-fichas"), mensagemInput = document.getElementById("mensagem-input"), planoFundoBtn = document.getElementById("plano-fundo-btn"), backgroundModal = document.getElementById("background-modal"), backgroundImageInput = document.getElementById("background-image-input"), confirmarSalvarBtn = document.getElementById("confirmar-salvar-btn"), newMessageSound = document.getElementById("new-message-sound");

        let atributosInputs = [forcaInput, destrezaInput, agilidadeInput, constituicaoInput, inteligenciaInput], experiencia = 0, nivel = 0, pontosHabilidadeTotal = nivelData[0].pd, pontosHabilidadeUsados = 0, vidaBase = 50, vidaTotal = 50, vidaAtual = 50, magiaTotal = 20, magiaAtual = 20, vigorTotal = 10, vigorAtual = 10, vantagensSelecionadas = [], desvantagensSelecionadas = [], tempVantagensSelecionadas = [], tempDesvantagensSelecionadas = [], racaSelecionada = null, tempRacaSelecionada = null, previousValues = new Map(), senhaMatriz = "1234";

        function fecharModal(modalId) { document.getElementById(modalId).style.display = "none"; }

        function carregarFichas() {
            database.ref('fichas').on('value', snapshot => {
                const data = snapshot.val(); if (data) Object.assign(fichas, data);
                atualizarAbasFichas(); carregarFicha(currentFichaId); atualizarListaFichasChat();
            });
        }

        function atualizarAbasFichas() {
            const sidebar = document.getElementById("fichas-sidebar"); sidebar.innerHTML = '<div id="add-ficha-btn"><span>+ Fichas</span></div>';
            for (const fichaId in fichas) {
                const tab = document.createElement("div"); tab.className = "ficha-tab"; const span = document.createElement("span"); span.textContent = fichas[fichaId].nomeFicha || "Sem Nome"; tab.appendChild(span);
                tab.onclick = () => { currentFichaId = fichaId; carregarFicha(fichaId); Array.from(sidebar.children).forEach(t => t.classList.remove("active")); tab.classList.add("active"); }; sidebar.appendChild(tab);
            }
            document.getElementById("add-ficha-btn").onclick = () => { const nome = prompt("Nome da nova ficha:"); if (nome) { const newFichaRef = database.ref('fichas').push(); newFichaRef.set({ nomeFicha: nome }); currentFichaId = newFichaRef.key; } };
            if (fichas[currentFichaId]) sidebar.children[Object.keys(fichas).indexOf(currentFichaId) + 1]?.classList.add("active");
        }

        function carregarFicha(fichaId) {
            const ficha = fichas[fichaId]; if (!ficha) return;
            nomePersonagemInput.value = ficha.nomeFicha || ""; descricaoPersonagemInput.value = ficha.descricao || ""; experiencia = ficha.experiencia || 0; experienciaInput.value = experiencia; nivel = ficha.nivel || 0; nivelSpan.textContent = nivel;
            pontosHabilidadeTotal = nivelData[nivel].pd; pontosHabilidadeSpan.textContent = pontosHabilidadeTotal - (ficha.pontosHabilidadeUsados || 0); pontosHabilidadeUsados = ficha.pontosHabilidadeUsados || 0;
            forcaInput.value = ficha.forca || 0; destrezaInput.value = ficha.destreza || 0; agilidadeInput.value = ficha.agilidade || 0; constituicaoInput.value = ficha.constituicao || 0; inteligenciaInput.value = ficha.inteligencia || 0;
            armaDireitaNomeInput.value = ficha.armaDireitaNome || ""; armaDireitaAtaqueInput.value = ficha.armaDireitaAtaque || 0; armaDireitaAtaqueMagicoInput.value = ficha.armaDireitaAtaqueMagico || 0;
            armaEsquerdaNomeInput.value = ficha.armaEsquerdaNome || ""; armaEsquerdaAtaqueInput.value = ficha.armaEsquerdaAtaque || 0; armaEsquerdaAtaqueMagicoInput.value = ficha.armaEsquerdaAtaqueMagico || 0;
            const slots = inventarioSlots.querySelectorAll(".inventory-slot"); ficha.inventario?.forEach((item, i) => { if (slots[i]) { slots[i].querySelector(".inventory-item").value = item.nome; slots[i].querySelector(".inventory-weight").value = item.peso; } });
            magiasList.innerHTML = ""; (ficha.magias || []).forEach((magia, i) => { const input = document.createElement("input"); input.type = "text"; input.className = "magia-nome"; input.value = magia; input.placeholder = `Magia/Habilidade ${i + 1}`; magiasList.appendChild(input); });
            while (magiasList.children.length < 10) { const input = document.createElement("input"); input.type = "text"; input.className = "magia-nome"; input.placeholder = `Magia/Habilidade ${magiasList.children.length + 1}`; magiasList.appendChild(input); }
            vantagensSelecionadas = ficha.vantagens?.split("\n") || []; desvantagensSelecionadas = ficha.desvantagens?.split("\n") || []; racaSelecionada = ficha.raca || null;
            vantagensListDisplay.innerHTML = ""; desvantagensListDisplay.innerHTML = ""; vantagensSelecionadas.forEach(v => { const div = document.createElement("div"); div.textContent = v; div.className = "list-item"; div.onclick = () => removerVantagem(v); vantagensListDisplay.appendChild(div); });
            desvantagensSelecionadas.forEach(d => { const div = document.createElement("div"); div.textContent = d; div.className = "list-item"; div.onclick = () => removerDesvantagem(d); desvantagensListDisplay.appendChild(div); });
            classeNomeInput.value = ficha.classeNome || ""; classeDescricaoInput.value = ficha.classeDescricao || ""; racaNomeSpan.textContent = racaSelecionada ? racaSelecionada.split(" (")[0] : ""; racaDescricaoInput.value = ficha.racaDescricao || "";
            vidaAtual = ficha.vidaAtual || 50; magiaAtual = ficha.magiaAtual || 20; vigorAtual = ficha.vigorAtual || 10; document.getElementById("vida-atual").textContent = vidaAtual; document.getElementById("magia-atual").textContent = magiaAtual; document.getElementById("vigor-atual").textContent = vigorAtual.toFixed(1);
            anotacoesTextarea.value = ficha.anotacoes || ""; calcularAtributos(); pontosVantagemSpan.textContent = getPontosVantagem(); isFichaLocked = ficha.isLocked || false; fichaPassword = ficha.password || null; isFichaUnlocked = false;
            chatPassword = ficha.chatPassword || null; atualizarEstadoChatBotao(); aplicarPlanoDeFundoInicial(); aplicarCorDeFundoInicial(); document.body.classList.toggle("dark-mode", ficha.darkMode || false); atualizarBotaoBloquear();
            atributosInputs.forEach(input => previousValues.set(input, input.value));
        }

        function atualizarBotaoBloquear() { bloquearFichaButton.textContent = isFichaLocked ? (isFichaUnlocked ? "Bloquear Ficha (Desbloqueada)" : "Desbloquear Ficha") : "Bloquear Ficha"; }

        function salvarDados() {
            if (!currentFichaId) return;
            const magias = Array.from(magiasList.children).map(input => input.value).filter(Boolean), inventario = Array.from(inventarioSlots.querySelectorAll(".inventory-slot")).map(slot => ({ nome: slot.querySelector(".inventory-item").value, peso: slot.querySelector(".inventory-weight").value }));
            const dados = {
                nomeFicha: nomePersonagemInput.value, descricao: descricaoPersonagemInput.value, experiencia: parseInt(experienciaInput.value) || 0, nivel: nivel, pontosHabilidadeUsados: pontosHabilidadeUsados,
                forca: parseInt(forcaInput.value) || 0, destreza: parseInt(destrezaInput.value) || 0, agilidade: parseInt(agilidadeInput.value) || 0, constituicao: parseInt(constituicaoInput.value) || 0, inteligencia: parseInt(inteligenciaInput.value) || 0,
                armaDireitaNome: armaDireitaNomeInput.value, armaDireitaAtaque: parseInt(armaDireitaAtaqueInput.value) || 0, armaDireitaAtaqueMagico: parseInt(armaDireitaAtaqueMagicoInput.value) || 0,
                armaEsquerdaNome: armaEsquerdaNomeInput.value, armaEsquerdaAtaque: parseInt(armaEsquerdaAtaqueInput.value) || 0, armaEsquerdaAtaqueMagico: parseInt(armaEsquerdaAtaqueMagicoInput.value) || 0,
                inventario: inventario, magias: magias, vantagens: vantagensSelecionadas.join("\n"), desvantagens: desvantagensSelecionadas.join("\n"), raca: racaSelecionada, classeNome: classeNomeInput.value,
                classeDescricao: classeDescricaoInput.value, racaDescricao: racaDescricaoInput.value, vidaAtual: vidaAtual, magiaAtual: magiaAtual, vigorAtual: vigorAtual, anotacoes: anotacoesTextarea.value,
                backgroundImage: document.body.style.backgroundImage !== "none" ? document.body.style.backgroundImage.slice(5, -2) : null, backgroundSize: document.body.style.backgroundSize || "cover",
                backgroundColor: document.body.style.backgroundColor || "#f0e6d2", darkMode: document.body.classList.contains("dark-mode"), isLocked: isFichaLocked, password: fichaPassword, chatPassword: chatPassword
            };
            database.ref(`fichas/${currentFichaId}`).update(dados).then(() => { showNotification("Ficha salva com sucesso!", "save-success"); if (!fichas[currentFichaId]) { fichas[currentFichaId] = {}; } Object.assign(fichas[currentFichaId], dados); atualizarAbasFichas(); });
        }

        function atualizarNivel() {
            let newNivel = nivel; for (let i = 10; i >= 0; i--) { if (experiencia >= nivelData[i].xp) { newNivel = i; break; } }
            if (newNivel !== nivel) { nivel = newNivel; nivelSpan.textContent = nivel; pontosHabilidadeTotal = nivelData[nivel].pd; pontosHabilidadeSpan.textContent = pontosHabilidadeTotal - pontosHabilidadeUsados; calcularAtributos(); salvarDados(); }
        }

        function getPontosVantagem() {
            let ph = 8 + Math.floor(nivel / 2); vantagensSelecionadas.forEach(v => { const vantagem = vantagensData.find(vd => vd.nome === v); if (vantagem) ph -= vantagem.custo; });
            desvantagensSelecionadas.forEach(d => { const desvantagem = desvantagensData.find(dd => dd.nome === d); if (desvantagem) ph += desvantagem.ganho; });
            if (racaSelecionada) { const raca = racasData.find(r => r.nome === racaSelecionada); if (raca) ph -= raca.custo; } return ph;
        }

        function calcularPontosVantagemTemp() {
            let ph = 8 + Math.floor(nivel / 2); tempVantagensSelecionadas.forEach(v => { const vantagem = vantagensData.find(vd => vd.nome === v); if (vantagem) ph -= vantagem.custo; });
            tempDesvantagensSelecionadas.forEach(d => { const desvantagem = desvantagensData.find(dd => dd.nome === d); if (desvantagem) ph += desvantagem.ganho; });
            if (tempRacaSelecionada) { const raca = racasData.find(r => r.nome === tempRacaSelecionada); if (raca) ph -= raca.custo; } return ph;
        }

        function aumentarVida() { if (vidaAtual < vidaTotal) { vidaAtual++; document.getElementById("vida-atual").textContent = vidaAtual; salvarDados(); } }
        function diminuirVida() { if (vidaAtual > 0) { vidaAtual--; document.getElementById("vida-atual").textContent = vidaAtual; salvarDados(); } }
        function aumentarMagia() { if (magiaAtual < magiaTotal) { magiaAtual++; document.getElementById("magia-atual").textContent = magiaAtual; salvarDados(); } }
        function diminuirMagia() { if (magiaAtual > 0) { magiaAtual--; document.getElementById("magia-atual").textContent = magiaAtual; salvarDados(); } }
        function aumentarVigor() { if (vigorAtual < vigorTotal) { vigorAtual = Math.min(vigorAtual + 0.1, vigorTotal); document.getElementById("vigor-atual").textContent = vigorAtual.toFixed(1); salvarDados(); } }
        function diminuirVigor() { if (vigorAtual > 0) { vigorAtual = Math.max(vigorAtual - 0.1, 0); document.getElementById("vigor-atual").textContent = vigorAtual.toFixed(1); salvarDados(); } }

        function calcularAtributos() {
            const forca = parseInt(forcaInput.value) || 0, destreza = parseInt(destrezaInput.value) || 0, agilidade = parseInt(agilidadeInput.value) || 0,
                  inteligencia = parseInt(inteligenciaInput.value) || 0, constituicao = parseInt(constituicaoInput.value) || 0;
            let totalPontos = forca + destreza + agilidade + inteligencia + constituicao;
            if (totalPontos > pontosHabilidadeTotal) {
                alert("Pontos de habilidade insuficientes!");
                forcaInput.value = previousValues.get(forcaInput) || "0"; destrezaInput.value = previousValues.get(destrezaInput) || "0";
                agilidadeInput.value = previousValues.get(agilidadeInput) || "0"; inteligenciaInput.value = previousValues.get(inteligenciaInput) || "0";
                constituicaoInput.value = previousValues.get(constituicaoInput) || "0"; return;
            }
            pontosHabilidadeUsados = totalPontos; pontosHabilidadeSpan.textContent = pontosHabilidadeTotal - pontosHabilidadeUsados;

            let ataque = forca + Math.floor(destreza / 5), acerto = Math.floor(destreza / 3) + Math.floor(agilidade / 10),
                esquiva = Math.floor(agilidade / 3), rdf = Math.floor(forca / 5), rdm = Math.floor(inteligencia / 5),
                ataqueMagico = inteligencia, magiaBase = 20 + 3 * constituicao, vigorBase = 10 + 0.4 * constituicao;
            vidaBase = 50 + (constituicao * (3 + Math.floor(forca / 10))) + 10 * nivel;
            if (inteligencia >= 10) magiaBase += constituicao * Math.floor(inteligencia / 10);

            ataque += (parseInt(armaDireitaAtaqueInput.value) || 0) + (parseInt(armaEsquerdaAtaqueInput.value) || 0);
            ataqueMagico += (parseInt(armaDireitaAtaqueMagicoInput.value) || 0) + (parseInt(armaEsquerdaAtaqueMagicoInput.value) || 0);

            const velocidadeBase = 25 + Math.floor(agilidade / 3) * 3, alturaPuloBase = 1 + Math.floor(forca / 10), distanciaPuloBase = 3 + 3 * Math.min(Math.floor(forca / 5), Math.floor(agilidade / 5));
            let bonusVelocidade = vantagensSelecionadas.includes("Combo Físico (4)") ? 25 : 0, bonusAlturaPulo = vantagensSelecionadas.includes("Combo Físico (4)") ? 2 : 0, bonusDistanciaPulo = vantagensSelecionadas.includes("Combo Físico (4)") ? 6 : 0;

            velocidadeCorridaSpan.textContent = velocidadeBase + bonusVelocidade; alturaPuloSpan.textContent = alturaPuloBase + bonusAlturaPulo; distanciaPuloSpan.textContent = distanciaPuloBase + bonusDistanciaPulo;
            ataqueSpan.textContent = ataque; ataqueMagicoSpan.textContent = ataqueMagico; acertoSpan.textContent = acerto; esquivaSpan.textContent = esquiva; rdfSpan.textContent = rdf; rdmSpan.textContent = rdm;
            vidaTotal = Math.ceil(vidaBase); magiaTotal = Math.ceil(magiaBase); vigorTotal = parseFloat(vigorBase.toFixed(1));

            // Don't reset current values here, just update totals. Current values are loaded/managed elsewhere.
            document.getElementById("vida-total").textContent = vidaTotal; document.getElementById("magia-total").textContent = magiaTotal; document.getElementById("vigor-total").textContent = vigorTotal.toFixed(1);
            // Update current values display in case they exceed the new total
            document.getElementById("vida-atual").textContent = Math.min(vidaAtual, vidaTotal); document.getElementById("magia-atual").textContent = Math.min(magiaAtual, magiaTotal); document.getElementById("vigor-atual").textContent = Math.min(vigorAtual, vigorTotal).toFixed(1);

            const regeneracaoVida = (0.2 * constituicao).toFixed(1), regeneracaoMagia = (0.8 * constituicao).toFixed(1), regeneracaoVigor = (0.4 * constituicao).toFixed(1);
            document.getElementById("regeneracao-vida").textContent = regeneracaoVida; document.getElementById("regeneracao-magia").textContent = regeneracaoMagia; document.getElementById("regeneracao-vigor").textContent = regeneracaoVigor;

            const atributos = [{ span: ataqueSpan, valor: ataque }, { span: ataqueMagicoSpan, valor: ataqueMagico }, { span: acertoSpan, valor: acerto }, { span: esquivaSpan, valor: esquiva }, { span: rdfSpan, valor: rdf }, { span: rdmSpan, valor: rdm }];
            atributos.forEach(a => a.span.classList.remove("atributo-fogo"));
            const maxAtributo = atributos.reduce((prev, curr) => prev.valor > curr.valor ? prev : curr, { valor: 0 });
            if (maxAtributo.valor > 0) maxAtributo.span.classList.add("atributo-fogo");
        }

        function resetarPontos() {
            if (isFichaLocked && !isFichaUnlocked) return abrirModalSenha(resetPontosButton); // Pass element for context
            if (confirm("Tem certeza que deseja reiniciar os pontos? Você precisará da permissão do GM.")) {
                document.getElementById("senha-gm-modal").style.display = "flex"; document.getElementById("senha-gm-input").value = "";
                document.getElementById("confirmar-senha-gm-btn").onclick = () => {
                    if (document.getElementById("senha-gm-input").value === senhaMatriz) {
                        atributosInputs.forEach(input => input.value = 0); pontosHabilidadeUsados = 0; pontosHabilidadeSpan.textContent = pontosHabilidadeTotal;
                        velocidadeCorridaSpan.textContent = "25"; alturaPuloSpan.textContent = "1"; distanciaPuloSpan.textContent = "3";
                        calcularAtributos(); pontosVantagemSpan.textContent = getPontosVantagem(); salvarDados(); fecharModal("senha-gm-modal");
                    } else { alert("Senha do GM incorreta!"); fecharModal("senha-gm-modal"); }
                };
            }
        }

        function recomecarFicha() {
             if (isFichaLocked && !isFichaUnlocked) return abrirModalSenha(recomecarButton); // Pass element for context
            if (confirm("Tem certeza que deseja recomeçar a ficha? Todas as alterações serão perdidas.")) {
                atributosInputs.forEach(input => input.value = 0); pontosHabilidadeUsados = 0; experiencia = 0; nivel = 0; // Reset XP and level
                pontosHabilidadeTotal = nivelData[nivel].pd; pontosHabilidadeUsados = 0; nivelSpan.textContent = nivel; pontosHabilidadeSpan.textContent = pontosHabilidadeTotal; vidaBase = 50;
                velocidadeCorridaSpan.textContent = "25"; alturaPuloSpan.textContent = "1"; distanciaPuloSpan.textContent = "3";
                nomePersonagemInput.value = ""; descricaoPersonagemInput.value = ""; experienciaInput.value = 0; // Set XP input too
                armaDireitaNomeInput.value = ""; armaDireitaAtaqueInput.value = "0"; armaDireitaAtaqueMagicoInput.value = "0";
                armaEsquerdaNomeInput.value = ""; armaEsquerdaAtaqueInput.value = "0"; armaEsquerdaAtaqueMagicoInput.value = "0";
                magiasList.innerHTML = ""; for (let i = 0; i < 10; i++) { const input = document.createElement("input"); input.type = "text"; input.className = "magia-nome"; input.placeholder = `Magia/Habilidade ${i + 1}`; magiasList.appendChild(input); }
                const slots = inventarioSlots.querySelectorAll(".inventory-slot"); slots.forEach(slot => { slot.querySelector(".inventory-item").value = ""; slot.querySelector(".inventory-weight neo").value = "0"; });
                characterImage.style.display = "none"; characterImage.src = ""; vantagensSelecionadas = []; desvantagensSelecionadas = []; racaSelecionada = null;
                vantagensListDisplay.innerHTML = ""; desvantagensListDisplay.innerHTML = ""; anotacoesTextarea.value = "";
                classeNomeInput.value = ""; classeDescricaoInput.value = ""; racaNomeSpan.textContent = ""; racaDescricaoInput.value = "";
                calcularAtributos(); // Calculate based on zeroed stats
                // Reset current HP/MP/Stamina to new totals
                vidaAtual = vidaTotal; magiaAtual = magiaTotal; vigorAtual = vigorTotal;
                document.getElementById("vida-atual").textContent = vidaAtual; document.getElementById("magia-atual").textContent = magiaAtual; document.getElementById("vigor-atual").textContent = vigorAtual.toFixed(1);
                pontosVantagemSpan.textContent = getPontosVantagem(); // Recalculate PH
                salvarDados();
            }
        }

        bloquearFichaButton.onclick = () => {
            if (isFichaLocked) abrirModalSenha();
            else { document.getElementById("bloquear-ficha-modal").style.display = "flex"; document.getElementById("senha-bloqueio-input").value = ""; document.getElementById("senha-bloqueio-input").focus(); }
        };

        function bloquearFicha() {
            const senha = document.getElementById("senha-bloqueio-input").value;
            if (senha.length !== 4 || !/^\d{4}$/.test(senha)) return alert("A senha deve ter exatamente 4 dígitos numéricos!");
            // Removed disadvantage check here, can be done elsewhere if needed
            isFichaLocked = true; fichaPassword = senha;
            database.ref(`fichas/${currentFichaId}`).update({ isLocked: true, password: senha }).then(() => {
                fecharModal("bloquear-ficha-modal"); alert("Ficha bloqueada com sucesso!"); atualizarBotaoBloquear();
            }).catch(error => console.error("Erro ao bloquear ficha:", error));
        }

        function abrirModalSenha(element = null) {
            document.getElementById("password-modal").style.display = "flex"; document.getElementById("senha-desbloqueio-input").value = ""; document.getElementById("senha-desbloqueio-input").focus();
            if (element) document.getElementById("password-modal").dataset.elementId = element.id; else delete document.getElementById("password-modal").dataset.elementId;
        }

        function desbloquearFicha() {
            const senha = document.getElementById("senha-desbloqueio-input").value, modal = document.getElementById("password-modal"), elementId = modal.dataset.elementId;
            if (senha !== senhaMatriz && senha !== fichaPassword) return alert("Senha incorreta!");
            isFichaUnlocked = true; // Unlock temporarily
            if (currentFichaId !== "ficha-matriz" && senha !== senhaMatriz) {
                // Ask if permanent unlock is desired
                if(confirm("Senha correta! Deseja desbloquear a ficha permanentemente? (Cancelar para desbloqueio temporário)")) {
                    database.ref(`fichas/${currentFichaId}`).update({ isLocked: false, password: null }).then(() => {
                         isFichaLocked = false; // Update local state
                         fichaPassword = null; // Update local state
                         fecharModal("password-modal"); alert("Ficha desbloqueada permanentemente!"); atualizarBotaoBloquear();
                         // Trigger original action if needed
                         if (elementId === "reset-pontos") resetarPontos(); else if (elementId === "recomecar") recomecarFicha();
                    }).catch(error => console.error("Erro ao desbloquear ficha:", error));
                } else {
                     fecharModal("password-modal"); alert("Ficha desbloqueada temporariamente!");
                     // Trigger original action if needed
                     if (elementId === "reset-pontos") resetarPontos(); else if (elementId === "recomecar") recomecarFicha();
                }
            } else { // Using GM password or on Matrix sheet
                fecharModal("password-modal"); alert(`Ficha desbloqueada temporariamente ${senha === senhaMatriz ? 'com a senha matriz!' : ''}`);
                // Trigger original action if needed
                if (elementId === "reset-pontos") resetarPontos(); else if (elementId === "recomecar") recomecarFicha();
            }
        }


        function cancelarDesbloqueio() {
            const modal = document.getElementById("password-modal"), elementId = modal.dataset.elementId;
            // If an input triggered the lock, revert its value
            if (elementId && document.getElementById(elementId) && previousValues.has(document.getElementById(elementId))) {
                 document.getElementById(elementId).value = previousValues.get(document.getElementById(elementId)) || "";
            }
            fecharModal("password-modal");
        }


        function verificarAlteracao(event) {
            const input = event.target;
            // Store previous value *before* checking lock, only if different from current
            const currentVal = input.value;
            if(!previousValues.has(input) || previousValues.get(input) !== currentVal) {
                 // Find the value just before the input event started (might require more complex handling like tracking focus/blur)
                 // For simplicity, let's assume the value before 'beforeinput' is the one to revert to.
                 // This might not be perfect if multiple inputs happen quickly.
                 // Let's capture on focus instead.
                 // Updated logic: Capture on focus, check lock on input.
            }

             // Check lock on actual input attempt
             if (isFichaLocked && !isFichaUnlocked) {
                 event.preventDefault(); // Prevent the input
                 // Revert to stored value if possible (use value captured on focus)
                 input.value = previousValues.get(input) || "";
                 abrirModalSenha(input); // Pass the input itself for context if needed
             } else {
                // Update previous value *after* successful input allowed
                // Handled by the 'input' event listener now
            }
        }

        document.querySelectorAll('input[type="text"],input[type="number"],textarea').forEach(input => {
            input.addEventListener("focus", (event) => {
                // Store value on focus to revert if needed
                previousValues.set(event.target, event.target.value);
            });
            // Removed beforeinput listener, check lock directly on input attempt
            input.addEventListener("input", (event) => { // Check lock on input
                const inputTarget = event.target;
                if (isFichaLocked && !isFichaUnlocked) {
                    // Prevent change and show password modal
                    inputTarget.value = previousValues.get(inputTarget) || ""; // Revert
                    abrirModalSenha(inputTarget);
                } else {
                    // Allowed change, update previous value map for next potential revert
                    previousValues.set(inputTarget, inputTarget.value);
                    // Trigger calculations and save
                    if (inputTarget.id === "experiencia") { experiencia = parseInt(inputTarget.value) || 0; atualizarNivel(); }
                    else if (atributosInputs.includes(inputTarget)) { calcularAtributos(); } // Check PH moved inside calculate
                    else if (inputTarget.id.includes("arma")) { calcularAtributos(); }
                    // Handle inventory weight change separately if needed for peso total update
                    else if (inputTarget.classList.contains('inventory-weight')) { calcularPesoTotal(); }

                    salvarDados(); // Save on every valid input
                }
            });
        });
        nomePersonagemInput.oninput = salvarDados; // Keep direct save for name


        characterImageInput.onchange = e => {
            const file = e.target.files[0]; if (file) { const reader = new FileReader(); reader.onload = e => { characterImage.src = e.target.result; characterImage.style.display = "block"; salvarDados(); }; reader.readAsDataURL(file); }
        };
        document.getElementById("excluir-ficha").onclick = () => {
            if (currentFichaId === "ficha-matriz") return alert("A ficha matriz não pode ser excluída!");
            if (isFichaLocked && !isFichaUnlocked) return abrirModalSenha(document.getElementById("excluir-ficha")); // Pass element
            if (confirm("Tem certeza que deseja excluir esta ficha?"))
                database.ref(`fichas/${currentFichaId}`).remove().then(() => { currentFichaId = "ficha-matriz"; carregarFicha(currentFichaId); atualizarAbasFichas(); });
        };
        let isDragging = false, currentX = 0, currentY = 0, initialX, initialY; // Initialize currentX/Y
        // Get initial position on first load correctly
        document.addEventListener('DOMContentLoaded', () => {
            currentX = diceContainer.offsetLeft;
            currentY = diceContainer.offsetTop;
        });
        diceContainer.onmousedown = e => { isDragging = true; initialX = e.clientX - currentX; initialY = e.clientY - currentY; diceContainer.style.cursor = "grabbing"; };
        document.onmousemove = e => { if (isDragging) { e.preventDefault(); currentX = e.clientX - initialX; currentY = e.clientY - initialY; diceContainer.style.left = `${currentX}px`; diceContainer.style.top = `${currentY}px`; diceContainer.style.right = "auto"; } };
        document.onmouseup = () => { if(isDragging) {isDragging = false; diceContainer.style.cursor = "move";} }; // Check isDragging before resetting cursor


        database.ref('dadosRolados').on('child_added', snapshot => { const dado = snapshot.val(); if (dado.fichaId !== currentFichaId) showNotification(`${dado.nomeFicha} rolou: ${dado.resultado}`, "normal-result"); });
        diceRoll.onclick = () => {
            if (isFichaLocked && !isFichaUnlocked) return abrirModalSenha(diceRoll); // Pass element
            diceRoll.textContent = "Rolling..."; diceResult.style.display = "none"; diceRoll.classList.remove("critical-failure", "critical-success");
            setTimeout(() => {
                const roll = Math.floor(Math.random() * 20) + 1, fichaNome = fichas[currentFichaId]?.nomeFicha || "Sem Nome";
                diceRoll.textContent = roll; let notificationClass = "normal-result", notificationMsg = `${fichaNome} rolou: ${roll}`;
                if (roll === 1) { diceRoll.classList.add("critical-failure"); notificationClass = "critical-failure"; notificationMsg = `${fichaNome} - FALHA CRÍTICA!`; }
                else if (roll === 20) { diceRoll.classList.add("critical-success"); notificationClass = "critical-success"; notificationMsg = `${fichaNome} - SUCESSO CRÍTICO!`; }
                else { diceResult.textContent = notificationMsg; diceResult.style.display = "block"; }
                showNotification(notificationMsg, notificationClass);
                const dadoRef = database.ref('dadosRolados').push(); dadoRef.set({ fichaId: currentFichaId, nomeFicha: fichaNome, resultado: roll });
            }, 1000);
        };

        vantagensDesvantagensBtn.onclick = () => {
            if (isFichaLocked && !isFichaUnlocked) return abrirModalSenha(vantagensDesvantagensBtn); // Pass element
            tempDesvantagensSelecionadas = [...desvantagensSelecionadas];
            document.getElementById("ph-temp").textContent = calcularPontosVantagemTemp();
            vantagensList.innerHTML = "";
            desvantagensList.innerHTML = "";
            vantagensData.forEach(v => {
                const div = document.createElement("div");
                div.className = "vantagem-item";
                div.textContent = `${v.nome} - Custo: ${v.custo}`;
                div.onclick = () => selecionarVantagemTemp(v);
                if (tempVantagensSelecionadas.includes(v.nome)) div.classList.add("comprada");
                vantagensList.appendChild(div);
            });
            desvantagensData.forEach(d => {
                const div = document.createElement("div");
                div.className = "desvantagem-item";
                div.textContent = `${d.nome} - Ganho: ${d.ganho}`;
                div.onclick = () => selecionarDesvantagemTemp(d);
                if (tempDesvantagensSelecionadas.includes(d.nome)) div.classList.add("comprada");
                desvantagensList.appendChild(div);
            });
            vantagensDesvantagensPanel.style.display = "block";
        };

        function selecionarVantagemTemp(vantagem) {
            if (tempVantagensSelecionadas.includes(vantagem.nome)) {
                tempVantagensSelecionadas = tempVantagensSelecionadas.filter(v => v !== vantagem.nome);
            } else {
                const phTemp = calcularPontosVantagemTemp() - vantagem.custo;
                if (phTemp >= 0) {
                    tempVantagensSelecionadas.push(vantagem.nome);
                } else {
                    alert("Pontos de vantagem insuficientes!");
                }
            }
            document.getElementById("ph-temp").textContent = calcularPontosVantagemTemp();
            vantagensList.querySelectorAll(".vantagem-item").forEach(div => {
                if (div.textContent.startsWith(vantagem.nome)) {
                    div.classList.toggle("comprada", tempVantagensSelecionadas.includes(vantagem.nome));
                }
            });
        }

        function selecionarDesvantagemTemp(desvantagem) {
            if (tempDesvantagensSelecionadas.includes(desvantagem.nome)) {
                tempDesvantagensSelecionadas = tempDesvantagensSelecionadas.filter(d => d !== desvantagem.nome);
            } else {
                tempDesvantagensSelecionadas.push(desvantagem.nome);
            }
            document.getElementById("ph-temp").textContent = calcularPontosVantagemTemp();
            desvantagensList.querySelectorAll(".desvantagem-item").forEach(div => {
                if (div.textContent.startsWith(desvantagem.nome)) {
                    div.classList.toggle("comprada", tempDesvantagensSelecionadas.includes(desvantagem.nome));
                }
            });
        }

        salvarVantagensBtn.onclick = () => {
            const phFinal = calcularPontosVantagemTemp();
            if (phFinal < 0) {
                alert("Pontos de vantagem negativos! Ajuste suas seleções.");
            } else {
                vantagensSelecionadas = [...tempVantagensSelecionadas];
                desvantagensSelecionadas = [...tempDesvantagensSelecionadas];
                pontosVantagemSpan.textContent = phFinal;
                vantagensListDisplay.innerHTML = "";
                desvantagensListDisplay.innerHTML = "";
                vantagensSelecionadas.forEach(v => {
                    const div = document.createElement("div");
                    div.textContent = v;
                    div.className = "list-item";
                    div.onclick = () => removerVantagem(v);
                    vantagensListDisplay.appendChild(div);
                });
                desvantagensSelecionadas.forEach(d => {
                    const div = document.createElement("div");
                    div.textContent = d;
                    div.className = "list-item";
                    div.onclick = () => removerDesvantagem(d);
                    desvantagensListDisplay.appendChild(div);
                });
                salvarDados();
                vantagensDesvantagensPanel.style.display = "none";
            }
        };

        fecharPaginaBtn.onclick = () => {
            vantagensDesvantagensPanel.style.display = "none";
        };

        racasBtn.onclick = () => {
            if (isFichaLocked && !isFichaUnlocked) return abrirModalSenha(racasBtn); // Pass element
            tempRacaSelecionada = racaSelecionada;
            document.getElementById("ph-temp-raca").textContent = calcularPontosVantagemTemp();
            racasList.innerHTML = "";
            racasData.forEach(r => {
                const div = document.createElement("div");
                div.className = "raca-item";
                div.innerHTML = `<h3>${r.nome}</h3><p>${r.descricao}</p><p>Vantagens: ${r.vantagens.join(", ")}</p>`;
                div.onclick = () => selecionarRacaTemp(r);
                if (tempRacaSelecionada === r.nome) div.classList.add("comprada");
                racasList.appendChild(div);
            });
            racasPanel.style.display = "block";
        };

        function selecionarRacaTemp(raca) {
            if (tempRacaSelecionada === raca.nome) {
                tempRacaSelecionada = null;
            } else {
                const phTemp = calcularPontosVantagemTemp() - raca.custo;
                if (phTemp >= 0) {
                    tempRacaSelecionada = raca.nome;
                } else {
                    alert("Pontos de vantagem insuficientes!");
                }
            }
            document.getElementById("ph-temp-raca").textContent = calcularPontosVantagemTemp();
            racasList.querySelectorAll(".raca-item").forEach(div => {
                div.classList.toggle("comprada", tempRacaSelecionada === raca.nome);
            });
        }

        salvarRacasBtn.onclick = () => {
            const phFinal = calcularPontosVantagemTemp();
            if (phFinal < 0) {
                alert("Pontos de vantagem negativos! Ajuste suas seleções.");
            } else {
                racaSelecionada = tempRacaSelecionada;
                pontosVantagemSpan.textContent = phFinal;
                racaNomeSpan.textContent = racaSelecionada ? racaSelecionada.split(" (")[0] : "";
                racaDescricaoInput.value = racaSelecionada ? racasData.find(r => r.nome === racaSelecionada).descricao : "";
                salvarDados();
                racasPanel.style.display = "none";
            }
        };

        fecharRacasBtn.onclick = () => {
            racasPanel.style.display = "none";
        };

        classesBtn.onclick = () => {
            if (isFichaLocked && !isFichaUnlocked) return abrirModalSenha(classesBtn); // Pass element
            classesPanel.style.display = "block";
        };

        fecharClassesBtn.onclick = () => {
            classesPanel.style.display = "none";
        };

        luaBtn.onclick = () => {
            document.body.classList.add("dark-mode");
            salvarDados();
        };

        solBtn.onclick = () => {
            document.body.classList.remove("dark-mode");
            salvarDados();
        };

        corFundoBtn.onclick = () => {
            backgroundColorSelector.style.display = backgroundColorSelector.style.display === "none" ? "flex" : "none";
        };

        backgroundColorSelector.querySelectorAll(".color-option").forEach(option => {
            option.onclick = () => {
                document.body.style.backgroundColor = option.dataset.color;
                document.body.style.backgroundImage = "none";
                salvarDados();
                backgroundColorSelector.style.display = "none";
            };
        });

        anotacoesBtn.onclick = () => {
            anotacoesTextarea.style.display = anotacoesTextarea.style.display === "none" ? "block" : "none";
        };

        anotacoesTextarea.onblur = () => {
            anotacoesTextarea.style.display = "none";
            salvarDados();
        };

        adicionarMagiaBtn.onclick = () => {
            if (isFichaLocked && !isFichaUnlocked) return abrirModalSenha(adicionarMagiaBtn); // Pass element
            const input = document.createElement("input");
            input.type = "text";
            input.className = "magia-nome";
            input.placeholder = `Magia/Habilidade ${magiasList.children.length + 1}`;
            magiasList.appendChild(input);
        };

        function calcularPesoTotal() {
            const pesos = Array.from(inventarioSlots.querySelectorAll(".inventory-weight")).map(input => parseFloat(input.value) || 0);
            const total = pesos.reduce((a, b) => a + b, 0);
            pesoTotalSpan.textContent = total.toFixed(2);
        }

        inventarioSlots.querySelectorAll(".inventory-weight").forEach(input => {
            input.addEventListener("input", calcularPesoTotal);
        });

        function showNotification(message, className) {
            notification.textContent = message;
            notification.className = className;
            notification.style.display = "block";
            setTimeout(() => {
                notification.style.display = "none";
            }, 3000);
        }

        function aplicarPlanoDeFundoInicial() {
            const ficha = fichas[currentFichaId];
            if (ficha && ficha.backgroundImage) {
                document.body.style.backgroundImage = `url(${ficha.backgroundImage})`;
                document.body.style.backgroundSize = ficha.backgroundSize || "cover";
            } else {
                document.body.style.backgroundImage = "none";
            }
        }

        function aplicarCorDeFundoInicial() {
            const ficha = fichas[currentFichaId];
            if (ficha && ficha.backgroundColor) {
                document.body.style.backgroundColor = ficha.backgroundColor;
            } else {
                document.body.style.backgroundColor = "#f0e6d2";
            }
        }

        planoFundoBtn.onclick = () => {
            if (isFichaLocked && !isFichaUnlocked) return abrirModalSenha(planoFundoBtn); // Pass element
            backgroundModal.style.display = "flex";
        };

        function aplicarPlanoDeFundo() {
            const file = backgroundImageInput.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = e => {
                    const img = new Image();
                    img.onload = () => {
                        const size = document.querySelector('input[name="background-size"]:checked').value;
                        document.body.style.backgroundImage = `url(${e.target.result})`;
                        document.body.style.backgroundSize = size;
                        salvarDados();
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            } else {
                alert("Selecione uma imagem!");
            }
        }

        function excluirPlanoDeFundo() {
            document.body.style.backgroundImage = "none";
            salvarDados();
        }

        // Funções do Chat
        function definirSenhaChat() {
            const senha = document.getElementById("chat-senha-input").value;
            const confirmarSenha = document.getElementById("chat-confirmar-senha-input").value;
            if (senha !== confirmarSenha) return alert("As senhas não coincidem!");
            chatPassword = senha;
            database.ref(`fichas/${currentFichaId}`).update({ chatPassword: senha }).then(() => {
                alert("Senha do chat definida com sucesso!");
                fecharModal("chat-password-modal");
            });
        }

        function abrirChat() {
            const senha = document.getElementById("abrir-chat-senha-input").value;
            if (senha !== chatPassword) return alert("Senha incorreta!");
            isChatOpen = true;
            fecharModal("open-chat-modal");
            chatModal.style.display = "flex";
            atualizarListaFichasChat();
        }

        function atualizarListaFichasChat() {
            availableFichasDiv.innerHTML = "";
            for (const fichaId in fichas) {
                if (fichaId !== currentFichaId) {
                    const div = document.createElement("div");
                    div.className = "user-item";
                    div.textContent = fichas[fichaId].nomeFicha || "Sem Nome";
                    div.onclick = () => selecionarChatUser(fichaId);
                    availableFichasDiv.appendChild(div);
                }
            }
        }

        function selecionarChatUser(fichaId) {
            selectedChatUser = fichaId;
            conversationArea.innerHTML = "";
            database.ref(`chat/${currentFichaId}/${selectedChatUser}`).on('child_added', snapshot => {
                const msg = snapshot.val();
                const msgDiv = document.createElement("div");
                msgDiv.className = "message-container";
                const senderDiv = document.createElement("div");
                senderDiv.className = "sender-name";
                senderDiv.textContent = msg.sender;
                const msgContent = document.createElement("div");
                msgContent.className = "message";
                msgContent.textContent = msg.text;
                if (msg.sender === fichas[currentFichaId].nomeFicha) {
                    msgContent.classList.add("sent");
                }
                msgDiv.appendChild(senderDiv);
                msgDiv.appendChild(msgContent);
                conversationArea.appendChild(msgDiv);
            });
        }

        function enviarMensagem() {
            if (!selectedChatUser) return alert("Selecione uma ficha para conversar!");
            const mensagem = mensagemInput.value.trim();
            if (!mensagem) return;
            const msg = {
                sender: fichas[currentFichaId].nomeFicha,
                text: mensagem,
                timestamp: new Date().toISOString()
            };
            database.ref(`chat/${currentFichaId}/${selectedChatUser}`).push(msg);
            database.ref(`chat/${selectedChatUser}/${currentFichaId}`).push(msg);
            mensagemInput.value = "";
        }

        chatBtn.onclick = () => {
            if (!chatPassword) {
                document.getElementById("chat-password-modal").style.display = "flex";
            } else if (!isChatOpen) {
                document.getElementById("open-chat-modal").style.display = "flex";
            } else {
                chatModal.style.display = "flex";
            }
        };

        // Notificações de novas mensagens
        database.ref('chat').on('child_added', snapshot => {
            const chatData = snapshot.val();
            for (const conversaId in chatData) {
                if (conversaId.includes(currentFichaId)) {
                    const conversa = chatData[conversaId];
                    for (const msgId in conversa) {
                        const msg = conversa[msgId];
                        if (msg.sender !== fichas[currentFichaId].nomeFicha) {
                            newMessageSound.play();
                            chatBtn.dataset.unread = parseInt(chatBtn.dataset.unread || 0) + 1;
                            chatBtn.setAttribute("data-unread", chatBtn.dataset.unread);
                        }
                    }
                }
            }
        });

        carregarFichas();
    </script>
</body>
</html>
