<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ficha de Personagem RPG</title>
    <link href="https://fonts.googleapis.com/css2?family=MedievalSharp&family=Inter:wght@400;600&display=swap"
        rel="stylesheet">
    <script src="https://unpkg.com/@tailwindcss/browser@4"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <style>
        /* Estilos CSS permanecem os mesmos do arquivo original */
        /* ... (Todo o CSS original aqui) ... */

        /* MODIFICA√á√ÉO: Adicionado espa√ßamento para os novos bot√µes no modal de fundo */
         #background-modal .modal-content button {
            margin-top: 10px; /* Adiciona espa√ßo entre os bot√µes */
        }
        #background-modal .modal-content .color-input-group {
             margin-bottom: 15px; /* Espa√ßo abaixo do seletor de cor */
         }

        body {
            font-family: 'Inter', sans-serif;
            /* background: #f5f5f5; */ /* Removido para priorizar cor/imagem de fundo */
            color: #000;
            display: flex;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            background-color: #d2b48c; /* Cor de pergaminho padr√£o */
            background-image: none; /* Inicialmente sem imagem de fundo */
            background-size: cover;
            background-position: center;
            transition: background 0.3s, color 0.3s
        }

        body.dark-mode {
            background: #121212;
            color: #e0e0e0
            /* Manter a imagem/cor de fundo se houver, apenas ajustar cor do texto */
        }

        /* ... (Restante do CSS original aqui) ... */

         /* Estilos para o modal de plano de fundo */
        #background-modal {
            display: none;
        }

        #background-modal .modal-content {
            width: 450px; /* Um pouco mais largo para acomodar bot√µes */
            text-align: left;
        }

        #background-modal .modal-content label {
            display: block;
            margin-bottom: 5px;
            margin-top: 10px; /* Espa√ßo acima dos labels */
        }

        #background-modal .modal-content input[type="file"] {
             margin-bottom: 10px;
         }

         #background-modal .modal-content input[type="color"] {
             width: 100%; /* Ocupa a largura toda */
             height: 40px; /* Altura razo√°vel */
             padding: 5px;
             border: 1px solid #ccc;
             border-radius: 4px;
             box-sizing: border-box; /* Inclui padding e border na largura total */
             margin-bottom: 15px;
         }


        #background-modal .modal-content .radio-group {
            margin-bottom: 15px;
        }

        #background-modal .modal-content .radio-group label {
            display: inline-block;
            margin-right: 10px;
            margin-top: 0; /* Reset margin-top para radio buttons */
        }
    </style>
</head>

<body>
    <div id="chat-btn-container">
        <button id="chat-btn" data-unread="0">üí¨ Chat</button>
    </div>

    <div id="fichas-sidebar">
        <div id="add-ficha-btn"><span>+ Fichas</span></div>
    </div>

    <div id="ficha-container">
        <h1 id="nome-personagem-titulo">Ficha de Personagem</h1>
        <div id="game-master-message">Voc√™ virou o Game Master</div>

        <div id="character-image-container" onclick="document.getElementById('character-image-input').click()">
            <img id="character-image" alt="Imagem do Personagem">
            <input type="file" id="character-image-input" accept="image/*" style="display:none">
        </div>

        <div id="dice-container">
            <label>Role seu dado:</label>
            <div id="dice-roll">-</div>
            <div id="dice-result"></div>
        </div>

        <div id="ficha-content">
            <section id="informacoes-basicas">
                <h2>Informa√ß√µes B√°sicas</h2>
                <label for="nome-personagem">Nome do Personagem:</label>
                <input type="text" id="nome-personagem" placeholder="Digite o nome do seu personagem">

                <label for="descricao-personagem">Descri√ß√£o do Personagem:</label>
                <textarea id="descricao-personagem" placeholder="Digite a descri√ß√£o do seu personagem"></textarea>
            </section>

            <section id="recursos">
                <h2>Recursos</h2>
                <div class="vida-magia-vigor">
                    <div class="atributo-container vida">
                         <h3>Vida</h3>
                        <div class="valor-total medieval-box">
                            <span>Vida Total: </span>
                            <span id="vida-total" readonly>50</span>
                         </div>
                        <div class="valor-atual medieval-box">
                            <span>Vida Atual: </span>
                             <button onclick="diminuirVida()" title="Diminuir Vida">‚ñº</button>
                            <span id="vida-atual">50</span>
                            <button onclick="aumentarVida()" title="Aumentar Vida">‚ñ≤</button>
                        </div>
                         <div class="regeneracao">
                            <span>Regenera√ß√£o por turno: <span id="regeneracao-vida">0</span> (parado)</span>
                        </div>
                    </div>

                     <div class="atributo-container magia">
                        <h3>Magia</h3>
                        <div class="valor-total medieval-box">
                            <span>Magia Total: </span>
                             <span id="magia-total" readonly>20</span>
                        </div>
                        <div class="valor-atual medieval-box">
                             <span>Magia Atual: </span>
                            <button onclick="diminuirMagia()" title="Diminuir Magia">‚ñº</button>
                            <span id="magia-atual">20</span>
                            <button onclick="aumentarMagia()" title="Aumentar Magia">‚ñ≤</button>
                         </div>
                        <div class="regeneracao">
                            <span>Regenera√ß√£o por turno: <span id="regeneracao-magia">0</span></span>
                         </div>
                    </div>

                    <div class="atributo-container vigor">
                        <h3>Vigor</h3>
                        <div class="valor-total medieval-box">
                             <span>Vigor Total: </span>
                            <span id="vigor-total" readonly>10</span>
                        </div>
                         <div class="valor-atual medieval-box">
                            <span>Vigor Atual: </span>
                            <button onclick="diminuirVigor()" title="Diminuir Vigor">‚ñº</button>
                            <span id="vigor-atual">10</span>
                             <button onclick="aumentarVigor()" title="Aumentar Vigor">‚ñ≤</button>
                        </div>
                        <div class="regeneracao">
                             <span>Regenera√ß√£o por turno: <span id="regeneracao-vigor">0</span> (parado)</span>
                        </div>
                    </div>
                </div>
            </section>

            <section id="atributos">
                 <h2>Atributos</h2>
                <div class="atributos-container">
                    <div class="atributos-coluna">
                        <div class="atributo">
                            <label for="forca" title="Afeta ataque e RDF">For√ßa:</label>
                            <input type="number" id="forca" value="0" min="0">
                        </div>

                        <div class="atributo">
                             <label for="destreza" title="Afeta ataque e acerto">Destreza:</label>
                            <input type="number" id="destreza" value="0" min="0">
                        </div>

                        <div class="atributo">
                             <label for="agilidade" title="Afeta esquiva e acerto">Agilidade:</label>
                            <input type="number" id="agilidade" value="0" min="0">
                        </div>

                         <div class="atributo">
                            <label for="constituicao" title="Afeta vida, magia e vigor">Constitui√ß√£o:</label>
                            <input type="number" id="constituicao" value="0" min="0">
                         </div>

                        <div class="atributo">
                            <label for="inteligencia" title="Afeta ataque m√°gico e RDM">Intelig√™ncia:</label>
                            <input type="number" id="inteligencia" value="0" min="0">
                         </div>
                    </div>

                    <div class="atributos-coluna-destaque">
                        <div class="atributo-destaque">
                             <label>Ataque:</label>
                            <span id="ataque" readonly>0</span>
                        </div>
                        <div class="atributo-destaque">
                             <label>Ataque M√°gico:</label>
                            <span id="ataque-magico" readonly>0</span>
                        </div>
                        <div class="atributo-destaque">
                             <label>Acerto:</label>
                            <span id="acerto" readonly>0</span>
                        </div>
                         <div class="atributo-destaque">
                            <label>Esquiva:</label>
                            <span id="esquiva" readonly>0</span>
                        </div>
                         <div class="atributo-destaque">
                            <label>RDF:</label>
                            <span id="rdf" readonly>0</span>
                        </div>
                         <div class="atributo-destaque">
                            <label>RDM:</label>
                            <span id="rdm" readonly>0</span>
                         </div>
                    </div>
                </div>
            </section>

            <section id="combate">
                <h2>Combate</h2>
                <div class="armamento-container">
                     <div class="armamento-coluna">
                        <label>Armamento M√£o Direita:</label>
                        <div class="flex items-center mb-2">
                            <input type="text" id="arma-direita-nome" placeholder="Nome da Arma" class="mr-2">
                            <span>Ataque </span>
                            <input type="number" id="arma-direita-ataque" value="0" class="w-20 mr-2">
                            <span>Ataque M√°gico </span>
                             <input type="number" id="arma-direita-ataque-magico" value="0" class="w-20">
                        </div>
                    </div>
                    <div class="armamento-coluna">
                         <label>Armamento M√£o Esquerda:</label>
                        <div class="flex items-center">
                            <input type="text" id="arma-esquerda-nome" placeholder="Nome da Arma" class="mr-2">
                             <span>Ataque </span>
                            <input type="number" id="arma-esquerda-ataque" value="0" class="w-20 mr-2">
                            <span>Ataque M√°gico </span>
                            <input type="number" id="arma-esquerda-ataque-magico" value="0" class="w-20">
                        </div>
                    </div>
                </div>
            </section>

            <section id="inventario-habilidades">
                 <h2>Invent√°rio e Habilidades</h2>
                <div class="flex gap-20">
                    <div style="width:50%">
                        <label>Invent√°rio (Peso Total: <span id="peso-total">0</span> kg):</label>
                        <div id="inventario-slots">
                             <div class="inventory-slot">
                                <input type="text" placeholder="Item 1" class="inventory-item">
                                <input type="number" min="0" value="0" class="inventory-weight" title="Peso em kg">
                            </div>
                            <div class="inventory-slot">
                                <input type="text" placeholder="Item 2" class="inventory-item">
                                 <input type="number" min="0" value="0" class="inventory-weight">
                            </div>
                            <div class="inventory-slot">
                                 <input type="text" placeholder="Item 3" class="inventory-item">
                                <input type="number" min="0" value="0" class="inventory-weight">
                            </div>
                             <div class="inventory-slot">
                                <input type="text" placeholder="Item 4" class="inventory-item">
                                <input type="number" min="0" value="0" class="inventory-weight">
                             </div>
                            <div class="inventory-slot">
                                <input type="text" placeholder="Item 5" class="inventory-item">
                                 <input type="number" min="0" value="0" class="inventory-weight">
                            </div>
                            <div class="inventory-slot">
                                 <input type="text" placeholder="Item 6" class="inventory-item">
                                <input type="number" min="0" value="0" class="inventory-weight">
                            </div>
                             <div class="inventory-slot">
                                <input type="text" placeholder="Item 7" class="inventory-item">
                                <input type="number" min="0" value="0" class="inventory-weight">
                             </div>
                            <div class="inventory-slot">
                                <input type="text" placeholder="Item 8" class="inventory-item">
                                 <input type="number" min="0" value="0" class="inventory-weight">
                            </div>
                            <div class="inventory-slot">
                                <input type="text" placeholder="Item 9" class="inventory-item">
                                     <input type="number" min="0" value="0" class="inventory-weight">
                            </div>
                            <div class="inventory-slot">
                                 <input type="text" placeholder="Item 10" class="inventory-item">
                                <input type="number" min="0" value="0" class="inventory-weight">
                            </div>
                         </div>
                    </div>

                    <div style="width:50%">
                        <label>Magias e Habilidades:</label>
                         <div id="magias-list" class="magias-container">
                            <input type="text" placeholder="Magia/Habilidade 1" class="magia-nome">
                            <input type="text" placeholder="Magia/Habilidade 2" class="magia-nome">
                            <input type="text" placeholder="Magia/Habilidade 3" class="magia-nome">
                            <input type="text" placeholder="Magia/Habilidade 4" class="magia-nome">
                            <input type="text" placeholder="Magia/Habilidade 5" class="magia-nome">
                            <input type="text" placeholder="Magia/Habilidade 6" class="magia-nome">
                             <input type="text" placeholder="Magia/Habilidade 7" class="magia-nome">
                            <input type="text" placeholder="Magia/Habilidade 8" class="magia-nome">
                            <input type="text" placeholder="Magia/Habilidade 9" class="magia-nome">
                             <input type="text" placeholder="Magia/Habilidade 10" class="magia-nome">
                        </div>
                        <button id="adicionar-magia-btn">Adicionar Magia</button>
                    </div>
                 </div>

                <div class="mt-4">
                    <label>Vantagens:</label>
                    <div id="vantagens-list-display" class="list-display"></div>
                    <label>Desvantagens:</label>
                     <div id="desvantagens-list-display" class="list-display"></div>
                </div>

                <div class="classe-raca-container">
                    <label>Classe:</label>
                    <input type="text" id="classe-nome" placeholder="Nome da Classe">
                     <textarea id="classe-descricao" placeholder="Descri√ß√£o da Classe"
                        class="expandable-textarea"></textarea>

                    <label>Ra√ßa:</label>
                    <span id="raca-nome" onclick="abrirModalRaca()"></span>
                     <textarea id="raca-descricao" placeholder="Descri√ß√£o da Ra√ßa" class="expandable-textarea"
                        readonly></textarea>
                </div>
            </section>

            <section id="locomocao">
                <h2>Locomo√ß√£o</h2>
                 <div class="locomotion-container">
                    <div class="locomotion-item">
                        <label>Velocidade de Corrida (km/h):</label>
                        <span>üèÉ‚Äç‚ôÇÔ∏è</span>
                         <span id="velocidade-corrida" readonly>25</span>
                    </div>
                    <div class="locomotion-item">
                        <label>Altura do Pulo (m):</label>
                        <span>‚¨ÜÔ∏è</span>
                         <span id="altura-pulo" readonly>1</span>
                    </div>
                    <div class="locomotion-item">
                        <label>Dist√¢ncia do Pulo (m):</label>
                         <span>‚û°Ô∏è</span>
                        <span id="distancia-pulo" readonly>3</span>
                    </div>
                </div>
            </section>

            <section id="status">
                <h2>Status</h2>
                <div class="flex gap-20">
                    <div>
                        <label>Experi√™ncia:</label>
                         <input type="number" id="experiencia" value="0" min="0">
                        <label>Pontos de Habilidade (PD):</label>
                        <span id="pontos-habilidade" readonly>25</span>
                        <label>Pontos de Vantagem (PH):</label>
                         <span id="pontos-vantagem" readonly>8</span>
                    </div>
                    <div>
                    </div>
                </div>
                 <div id="nivel-container">
                    <label>N√≠vel:</label>
                    <span id="nivel">0</span>
                </div>
            </section>

            <div style="display:flex;justify-content:center;gap:20px;margin-bottom:20px">
                 <button id="vantagens-desvantagens-btn">Vantagens e Desvantagens</button>
                <button id="racas-btn">Ra√ßas üè∞</button>
                <button id="classes-btn">Classes ‚öîÔ∏è</button>
            </div>

            <div class="botoes-container">
                <button id="reset-pontos" class="botao botao-reset">Reiniciar Pontos</button>
                 <button id="recomecar" class="botao botao-recomecar">Recome√ßar</button>
                <button id="bloquear-ficha" class="botao botao-bloquear">Bloquear Ficha</button>
                <button id="lua-btn" class="botao">üåô</button>
                <button id="sol-btn" class="botao">‚òÄÔ∏è</button>
                <button id="plano-fundo-btn" class="botao">Plano de fundo</button>
            </div>

             <button id="excluir-ficha" class="botao botao-excluir">Excluir Ficha</button>
        </div>
    </div>

    <button id="anotacoes-btn">Anota√ß√µes</button>
    <textarea id="anotacoes-textarea" placeholder="Suas anota√ß√µes aqui..."></textarea>

    <button id="historico-dados-btn">Hist√≥rico de dados</button>
    <div id="historico-dados-panel">
        <h3>Hist√≥rico de Dados</h3>
        <div id="historico-lista"></div>
        <button id="excluir-historico-btn">Excluir hist√≥rico</button>
    </div>

    <div id="vantagens-desvantagens-panel">
        <h2>Vantagens e Desvantagens</h2>
         <div>Pontos de Vantagem Tempor√°rios: <span id="ph-temp">0</span></div>
        <div id="vantagens-list"></div>
        <div id="desvantagens-list"></div>
        <button id="salvar-vantagens-btn">SALVAR ALTERA√á√ïES</button>
        <button id="fechar-pagina-btn">Fechar P√°gina</button>
    </div>

    <div id="racas-panel">
        <h2>Ra√ßas</h2>
        <div id="racas-list"></div>
        <button id="salvar-racas-btn">SALVAR ALTERA√á√ïES</button>
        <button id="fechar-racas-btn">Fechar P√°gina</button>
    </div>

    <div id="classes-panel">
         <h2>Classes</h2>
        <button id="fechar-classes-btn">Fechar P√°gina</button>
    </div>

    <div id="nome-ficha-modal" class="modal">
        <div class="modal-content">
            <h3>D√™ um Nome √† Ficha</h3>
            <input type="text" id="nome-ficha-input" placeholder="Nome da ficha" maxlength="20">
            <button class="confirm-btn" onclick="criarNovaFicha()">Confirmar</button>
            <button class="cancel-btn" onclick="fecharModal('nome-ficha-modal')">Cancelar</button>
         </div>
    </div>

    <div id="bloquear-ficha-modal" class="modal">
        <div class="modal-content">
            <h3>Ponha sua Senha de 4 D√≠gitos</h3>
            <input type="password" id="senha-bloqueio-input" placeholder="Senha (4 d√≠gitos)" maxlength="4">
            <button class="confirm-btn" onclick="bloquearFicha()">Confirmar</button>
            <button class="cancel-btn" onclick="fecharModal('bloquear-ficha-modal')">Cancelar</button>
        </div>
     </div>

    <div id="password-modal" class="modal">
        <div class="modal-content">
            <h3>Digite sua Senha</h3>
            <input type="password" id="senha-desbloqueio-input" placeholder="Senha (4 d√≠gitos)" maxlength="4">
            <button class="confirm-btn" onclick="desbloquearFicha()">Confirmar</button>
            <button class="cancel-btn" onclick="cancelarDesbloqueio()">Cancelar</button>
        </div>
    </div>

    <div id="confirmar-compra-modal" class="modal">
         <div class="modal-content">
            <h3>Tem certeza que quer comprar isso?</h3>
            <button class="confirm-btn" id="confirmar-compra-btn">Sim</button>
            <button class="cancel-btn" onclick="fecharModal('confirmar-compra-modal')">N√£o</button>
        </div>
    </div>

    <div id="salvar-vantagens-modal" class="modal">
        <div class="modal-content">
            <h3>Se salvar, as altera√ß√µes n√£o poder√£o ser desfeitas.</h3>
             <button class="confirm-btn" id="confirmar-salvar-vantagens-btn">OK</button>
            <button class="cancel-btn" onclick="fecharModal('salvar-vantagens-modal')">Cancelar</button>
        </div>
    </div>

    <div id="senha-gm-modal" class="modal">
        <div class="modal-content">
            <h3>Pe√ßa permiss√£o ao GM</h3>
            <input type="password" id="senha-gm-input" placeholder="Senha GM">
            <button class="confirm-btn" id="confirmar-senha-gm-btn">Confirmar</button>
             <button class="cancel-btn" onclick="fecharModal('senha-gm-modal')">Cancelar</button>
        </div>
    </div>

    <div id="raca-opcoes-modal" class="modal">
        <div class="modal-content">
            <h3>O que voc√™ deseja fazer?</h3>
            <button class="confirm-btn" onclick="excluirRacaSelecionadaModal()">Excluir Ra√ßa</button>
            <button class="confirm-btn" onclick="editarRacaSelecionadaModal()" style="margin-top: 10px;">Editar Ra√ßa</button>
            <button class="cancel-btn" onclick="fecharModal('raca-opcoes-modal')">Cancelar</button>
         </div>
    </div>

    <div id="editar-raca-modal" class="modal">
        <div class="modal-content">
            <h3>Editar Ra√ßa</h3>
            <label for="editar-raca-nome">Nome:</label>
            <input type="text" id="editar-raca-nome">
            <label for="editar-raca-descricao">Descri√ß√£o:</label>
            <textarea id="editar-raca-descricao"></textarea>
             <button class="confirm-btn" onclick="salvarEdicaoRaca()">Salvar</button>
            <button class="cancel-btn" onclick="fecharModal('editar-raca-modal')">Cancelar</button>
        </div>
    </div>

    <div id="chat-password-modal" class="modal">
        <div class="modal-content">
            <h3>Definir Senha do Chat</h3>
            <input type="password" id="chat-senha-input" placeholder="Senha do Chat">
            <input type="password" id="chat-confirmar-senha-input" placeholder="Confirmar Senha">
             <button class="confirm-btn" onclick="definirSenhaChat()">Confirmar</button>
            <button class="cancel-btn" onclick="fecharModal('chat-password-modal')">Cancelar</button>
        </div>
    </div>

    <div id="open-chat-modal" class="modal">
        <div class="modal-content">
            <h3>Digite a Senha do Chat</h3>
            <input type="password" id="abrir-chat-senha-input" placeholder="Senha do Chat">
            <button class="confirm-btn" onclick="abrirChat()">Confirmar</button>
             <button class="cancel-btn" onclick="fecharModal('open-chat-modal')">Cancelar</button>
        </div>
    </div>

    <div id="chat-modal" class="modal">
        <div class="modal-content">
            <div class="chat-header">
                Chat Privado
            </div>
            <div class="chat-body">
                 <div class="user-list">
                    <h4>Fichas Online</h4>
                    <div id="available-fichas">
                        </div>
                </div>
                 <div class="conversation" id="conversation-area">
                    </div>
            </div>
            <div class="chat-input">
                <input type="text" id="mensagem-input" placeholder="Digite sua mensagem...">
                <button onclick="enviarMensagem()">Enviar</button>
             </div>
            <button class="cancel-btn" onclick="fecharModal('chat-modal')">Fechar Chat</button>
        </div>
    </div>


    <div id="notification"></div>

    <audio id="new-message-sound" preload="auto">
        <source src="notification_sound.mp3" type="audio/mpeg">
    </audio>

    <div id="background-modal" class="modal">
        <div class="modal-content">
            <h3>Plano de Fundo</h3>

            <label for="background-image-input">Selecionar Imagem:</label>
            <input type="file" id="background-image-input" accept="image/*">

            <div class="radio-group">
                <label><input type="radio" name="background-size" value="cover" checked>Preencher Tela</label>
                <label><input type="radio" name="background-size" value="100% 100%">Estender</label>
                <label><input type="radio" name="background-size" value="auto">Tamanho Normal</label>
             </div>
            <button class="confirm-btn" onclick="salvarImagemFundo()">Salvar Imagem</button>

            <hr style="margin: 15px 0;"> <label for="background-color-input">Selecionar Cor:</label>
            <input type="color" id="background-color-input" value="#d2b48c"> <button class="confirm-btn" onclick="salvarCorFundo()">Salvar Cor</button>

            <hr style="margin: 15px 0;"> <button class="cancel-btn" onclick="excluirPlanoDeFundo()">Remover Plano de Fundo</button>
            <button class="cancel-btn" onclick="fecharModal('background-modal')">Cancelar</button>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBbbwbwPXv6gztkyP3TXK-DtooEI7FcClI",
            authDomain: "ficha-de-rpg-b9685.firebaseapp.com",
             databaseURL: "https://ficha-de-rpg-b9685-default-rtdb.firebaseio.com",
            projectId: "ficha-de-rpg-b9685",
            storageBucket: "ficha-de-rpg-b9685.firebasestorage.app",
            messagingSenderId: "528610398062",
            appId: "1:528610398062:web:8fdb9cfd5ded8167613b7f"
        };
        firebase.initializeApp(firebaseConfig);

        const database = firebase.database();

        // ... (Vari√°veis globais como fichas, currentFichaId, etc. - Sem altera√ß√µes aqui) ...
        let fichas = {},
            currentFichaId = null,
            isFichaLocked = false,
            fichaPassword = null,
            isFichaUnlocked = false,
            senhaMatriz = "1040",
            vantagensSelecionadas = [],
            desvantagensSelecionadas = [],
            tempVantagensSelecionadas = [],
            tempDesvantagensSelecionadas = [],
            racaSelecionada = null,
            tempRacaSelecionada = null,
            vidaTotal,
            vidaAtual,
            magiaTotal,
            magiaAtual,
            vigorTotal,
            vigorAtual,
            previousValues = new Map(),
            chatPassword = null,
            isChatOpen = false,
            selectedChatUser = null;

        // ... (Dados de Vantagens, Desvantagens, Ra√ßas - Sem altera√ß√µes aqui) ...
        const vantagensData = [{
            nome: "Maestria com Armas curtas (2)",
            custo: 2,
            descricao: "Adiciona +1 em ataque, +1 em acerto com armas curtas."
        }, {
            nome: "Maestria com armas pesadas (2)",
            custo: 2,
            descricao: "Adiciona +2 em ataque com armas pesadas."
        }, {
            nome: "Maestria com armas de longo alcance (2)",
            custo: 2,
            descricao: "Adiciona +2 em acerto com armas de longo alcance."
        }, {
            nome: "Furtar (2)",
            custo: 2,
            descricao: "+4 em testes de furto."
        }, {
            nome: "L√°bia (2)",
            custo: 2,
            descricao: "+5 em testes de l√°bia."
        }, {
            nome: "Velejar (1)",
            custo: 1,
            descricao: ""
        }, {
            nome: "Beleza (1)",
            custo: 1,
            descricao: "Aumenta em +3 o teste em l√°bia, paquera e persuas√£o."
        }, {
            nome: "Boa Fama (2)",
            custo: 2,
            descricao: "Aumenta em +4 chance de descontos em armamentos, pousadas, alimentos, etc."
        }, {
            nome: "Arremedo (2)",
            custo: 2,
            descricao: "Capacidade de imitar qualquer som SIMPLES."
        }, {
            nome: "Destemor (1)",
            custo: 1,
            descricao: "Dificilmente √© assustado por algo."
        }, {
            nome: "Empatia (3)",
            custo: 3,
            descricao: "Sensibilidade extraordin√°ria em rela√ß√£o aos outras pessoas. √â um talento excelente para identificar impostores, possess√µes por espirito, etc."
        }, {
            nome: "Empatia com animais (1)",
            custo: 1,
            descricao: "Pode compreender as motiva√ß√µes dos animais."
        }, {
            nome: "Patrono (4)",
            custo: 4,
            descricao: "Possui um mentor/mestre/professor, at√© mesmo uma organiza√ß√£o/guilda que pode lhe oferecer ajuda."
        }, {
            nome: "Reconhecimento Social (2)",
            custo: 2,
            descricao: "√â membro de uma ra√ßa, classe, sexo ou grupo muito respeitado, temido ou venerado pela sociedade. Adiciona +2 pontos o teste em l√°bia, paquera e persuas√£o."
        }, {
            nome: "Riqueza (2)",
            custo: 2,
            descricao: "Inicia com 20 moedas de ouro."
        }, {
            nome: "Aptid√£o para magia (4)",
            custo: 4,
            descricao: "Adiciona 15% a mais de dano e gasta 15% a menos de magia para toda vez que usa a magia que voc√™ tem aptid√£o."
        }, {
            nome: "Combo F√≠sico (4)",
            custo: 4,
            descricao: "Essa vantagem lhe concede come√ßar sua locomo√ß√£o com 50km velocidade corrida, pulo de 3 metros de altura e 9 metros de dist√¢ncia.",
            restricao: "inicio"
        }, {
            nome: "Nadar (1)",
             custo: 1,
            descricao: ""
        }, {
            nome: "Escalar (2)",
            custo: 2,
            descricao: ""
        }, {
            nome: "Segunda l√≠ngua (1)",
             custo: 1,
            descricao: "Fala mais um idioma."
        }, {
            nome: "Paquerador (2)",
            custo: 2,
            descricao: "Adiciona +4 em teste para paquera e persuas√£o envolvendo flerte."
        }, {
            nome: "Senso de perigo (5)",
            custo: 5,
            descricao: "Sempre que houver algo grave para ocorrer o mestre do RPG pedir√° pra voc√™ jogar um dado para reagir."
        }, {
            nome: "Acrobata (3)",
            custo: 3,
            descricao: "Adiciona + fama ao lutar em p√∫blico."
        }, {
            nome: "Equil√≠brio Perfeito (3)",
            custo: 3,
            descricao: "Adiciona +8 em testes de equil√≠brio."
        }, {
            nome: "Tecnologia (2)",
            custo: 2,
            descricao: "Voc√™ √© engenhoso, pode inventar coisas, criar objetos improvisados."
        }, {
            nome: "Poder Oculto (7)",
            custo: 7,
            descricao: "Quando sua vida estiver em 10%, voc√™ ativa o poder oculto aumentando todos seus atributos em 50%. Mas a partir do momento em que sua vida sai dos 10%, os atributos voltam ao normal."
        }, {
            nome: "Sobreviv√™ncia em floresta (2)",
            custo: 2,
            descricao: "Tem facilidade para achar cavernas, criar assentamentos, barracas, achar comida e gravar caminhos no meio da floresta. Facilidade para achar √°gua, etc."
        }];

        const desvantagensData = [{
            nome: "Fobia (+2)",
            ganho: 2,
            descricao: "Voc√™ tem um medo irracional de algo espec√≠fico."
        }, {
            nome: "M√° Fama (+2)",
            ganho: 2,
            descricao: "Voc√™ √© mal visto pela sociedade, dificultando intera√ß√µes sociais."
        }, {
            nome: "Alcoolismo (+2)",
            ganho: 2,
            descricao: "Voc√™ tem uma depend√™ncia de √°lcool que afeta suas decis√µes."
        }, {
            nome: "Altru√≠smo (+2)",
            ganho: 2,
            descricao: "Se sacrifica por outras pessoas e pouco se importa com fama ou riqueza."
        }, {
            nome: "Avareza (+2)",
            ganho: 2,
            descricao: "Preocupa√ß√£o permanente na conserva√ß√£o de riquezas."
        }, {
            nome: "Bullying (+3)",
            ganho: 3,
            descricao: "Gosta de ca√ßoar, agredir, denegrir, difamar e apontar defeitos tanto em amigos quanto inimigos."
        }, {
            nome: "Circunspe√ß√£o (+2)",
            ganho: 2,
            descricao: "N√£o entende piadas, entende tudo de forma literal e acredita que todos est√£o sempre falando s√©rio."
        }, {
            nome: "Compuls√µes (+3)",
            ganho: 3,
            descricao: "H√°bito ou v√≠cio que toma boa parte dos seus recursos e tempo."
        }, {
            nome: "Covardia (+2)",
            ganho: 2,
            descricao: "Tem extremo cuidado com seu bem-estar f√≠sico e dificuldade em assumir riscos."
        }, {
            nome: "Dependentes (+4)",
            ganho: 4,
            descricao: "Possui algu√©m que depende de voc√™ a todo momento (filhos, parentes, entes queridos, etc.)."
        }, {
            nome: "F√∫ria (+2)",
            ganho: 2,
            descricao: "Tend√™ncia a perder o controle e partir para um ataque fren√©tico, ativado por dano, insulto ou aleatoriamente."
        }, {
            nome: "Honestidade (+3)",
            ganho: 3,
            descricao: "N√£o consegue mentir ou omitir, sempre fala a verdade e desmascara mentiras."
        }, {
            nome: "Impulsividade (+2)",
            ganho: 2,
            descricao: "Sempre age sem pensar."
        }, {
            nome: "Lux√∫ria (+2)",
            ganho: 2,
            descricao: "Desejo incontrol√°vel por romance."
        }, {
            nome: "Magnetismo Sobrenatural (+2)",
            ganho: 2,
            descricao: "Coisas estranhas acontecem com seu personagem em um n√≠vel alarmante."
        }, {
            nome: "No Limite (+4)",
            ganho: 4,
            descricao: "Assume riscos extremamente irracionais diante de perigo mortal (ex.: enfrentar um boss sozinho)."
        }, {
            nome: "Teimosia (+1)",
            ganho: 1,
            descricao: "Quer sempre fazer as coisas do seu modo e n√£o segue planos que n√£o sejam seus."
        }, {
            nome: "Amn√©sia (+2)",
            ganho: 2,
            descricao: "Em certos momentos, n√£o consegue lembrar de coisas importantes."
        }];

        let racasData = [{
            nome: "Humano (3)",
            custo: 3,
            descricao: "Os humanos s√£o vers√°teis, ambiciosos e mestres em se adaptar a qualquer situa√ß√£o. Suas vantagens refletem uma capacidade excepcional de prosperar em qualquer ambiente.",
            vantagens: ["Explorador Nato: Come√ßam com um cavalo de ra√ßa superior (mais r√°pido e resistente), equipamentos de montaria completos (selas, suprimentos para semanas) e um mapa detalhado de uma regi√£o inicial √† escolha, permitindo explorar √°reas distantes com facilidade e seguran√ßa.", "Mestre das Profiss√µes: Escolhem uma profiss√£o com benef√≠cios. Ferreiro Lend√°rio: Criam armas e armaduras com 5 pontos de qualidade automaticamente e podem forjar itens com propriedades √∫nicas (ex.: espada que brilha ao detectar inimigos). Costureiro Arcano: Produzem vestimentas leves ou armaduras com resist√™ncia a dois elementos (ex.: fogo e gelo) e b√¥nus de regenera√ß√£o passiva de energia ou vida. Arquiteto Vision√°rio: Constroem estruturas permanentes em metade do tempo e com o dobro da resist√™ncia, podendo criar bases estrat√©gicas com defesas embutidas (ex.: torres de vigia).", "Rede de Influ√™ncia: Iniciam com uma rede de contatos: um aliado influente (guildas, mercadores ou l√≠deres locais) oferecendo acesso a informa√ß√µes secretas ou at√© interven√ß√£o em conflitos.", "Determina√ß√£o Inabal√°vel: Uma vez por dia, podem ignorar completamente uma situa√ß√£o de desvantagem (ex.: exaust√£o, ferimento grave ou efeito m√°gico negativo), agindo como se estivessem em plena capacidade por um curto per√≠odo."]
        }, {
            nome: "Elfo (4)",
            custo: 4,
             descricao: "Os elfos s√£o s√°bios, m√°gicos e profundamente conectados ao mundo natural. Suas vantagens agora destacam sua supremacia m√°gica e harmonia com a natureza.",
            vantagens: ["Sabedoria Ancestral: Dominam uma √°rea de conhecimento (ex.: arcana, hist√≥ria, natureza) com maestria, podendo decifrar pergaminhos, ru√≠nas ou magias antigas automaticamente, e aprendem 1 l√≠nguas extra.", "Vis√£o √âlfica Suprema: Enxergam no escuro at√© 10 metros, detectam magias fracas em um raio de 20 metros e percebem inten√ß√µes hostis em seres vivos com um teste muito dif√≠cil, 19 ou +.", "Escudo M√°gico: Ganham resist√™ncia inata a um tipo de efeito magico hostil (n√£o apenas encantamentos), reduzindo o dano ou a dura√ß√£o desses efeitos em 50%, refletindo sua ess√™ncia m√°gica."]
        }, {
            nome: "An√£o (4)",
            custo: 4,
            descricao: "Os an√µes s√£o resilientes, habilidosos e ligados √† terra. Suas vantagens agora enfatizam sua supremacia em crafting e sobreviv√™ncia em condi√ß√µes extremas.",
            vantagens: ["Fortitude Indom√°vel: Trabalham por 3 dias sem descanso, ignorando efeitos de fadiga, e recuperam vida e energia ao dormir em ambientes rochosos ou subterr√¢neos duas vezes mais r√°pido.", "Artes√£o: Escolhem uma especializa√ß√£o com impacto massivo: Mestre Minerador: Identificam e extraem recursos raros (ex.: mithril) com o dobro da velocidade e podem abrir t√∫neis tempor√°rios em rochas s√≥lidas com ferramentas improvisadas. Forjador de Lendas: Produzem armas e armaduras com 10 pontos de qualidade e propriedades m√°gicas tempor√°rias (ex.: arma que causa dano elemental extra), al√©m de reparar itens quebrados durante um curto periodo de tempo (1 a 2 dias). Joalheiro Divino: Criam artefatos que armazenam magias moderadas (ex.: um anel que lan√ßa uma bola de fogo uma vez por dia) ou concedem b√¥nus Tempor√°rios a atributos (ex.: +1 for√ßa).", "Senhor das Profundezas: Nunca se perdem em ambientes subterr√¢neos, detectam armadilhas (naturais ou artificiais) automaticamente e podem sentir vibra√ß√µes no solo para prever emboscadas ou colapsos."]
        }, {
            nome: "Orc (3)",
            custo: 3,
             descricao: "Os orcs s√£o guerreiros ferozes e l√≠deres carism√°ticos pela for√ßa. Suas vantagens agora amplificam sua presen√ßa intimidadora e poder bruto.",
            vantagens: ["Lenda entre Guerreiros: Inspiram temor e respeito em qualquer cultura que valorize for√ßa, garantindo alian√ßas com fac√ß√µes marciais e acesso a miss√µes √©picas; inimigos menores fogem automaticamente em sua presen√ßa (teste dif√≠cil, 16 ou +).", "Resili√™ncia Brutal: Lutam sem penalidades mesmo com ferimentos graves e s√≥ caem quando atingem PV 0, al√©m de regenerarem ferimentos leves passivamente fora de combate.", "Dom√≠nio da Intimida√ß√£o: Podem for√ßar inimigos a se renderem ou recuarem com um grito poderoso uma vez por encontro, afetando grupos inteiros, e ganham b√¥nus massivos em negocia√ß√µes baseadas em for√ßa ou medo.", "F√∫ria Ancestral: Entram em um estado de f√∫ria duas vezes por dia, duplicando for√ßa e resist√™ncia por um curto per√≠odo."]
        }, {
             nome: "Meio Animal (Selvagem) (4)",
            custo: 4,
            descricao: "Os meio animais combinam instinto primal com ast√∫cia. Suas vantagens agora os tornam mestres da sobreviv√™ncia e predadores supremos.",
            vantagens: ["Sentidos Predat√≥rios: Pode escolher um sentido agu√ßado de acordo com sua parte animal. (vis√£o, olfato, audi√ß√£o), permitindo rastrear alvos a quil√¥metros, detectar inimigos invis√≠veis e evitar qualquer surpresa com um teste moderado, 12 ou +.", "Senhor dos Terrenos: Adaptam-se completamente a um ambiente (ex.: floresta, deserto, p√¢ntano), ignorando todos os efeitos negativos e ganhando b√¥nus de movimento e furtividade nesses locais. b√¥nus +1.", "Frenesi Instintivo: Uma vez por dia, canalizam seus instintos para ganhar velocidade sobrenatural (dobro de movimento), ataques adicionais e uma percep√ß√£o quase premonit√≥ria de perigos, tornando-os ca√ßadores ou fugitivos imbat√≠veis por um curto per√≠odo (10 min)."]
        }];


        function criarFichaMatriz() {
            const fichaId = "ficha-matriz";
            const fichaMatriz = {
                 nomeFicha: "Matriz",
                nomePersonagem: "Personagem Matriz",
                descricaoPersonagem: "Ficha original do sistema",
                forca: "0",
                destreza: "0",
                agilidade: "0",
                 inteligencia: "0",
                constituicao: "0",
                experiencia: "0",
                armaDireitaNome: "",
                armaDireitaAtaque: "0",
                armaDireitaAtaqueMagico: "0",
                 armaEsquerdaNome: "",
                armaEsquerdaAtaque: "0",
                armaEsquerdaAtaqueMagico: "0",
                vantagens: "",
                magiasHabilidades: "",
                desvantagens: "",
                 inventario: Array(10).fill({
                    item: "",
                    peso: "0"
                }),
                velocidadeCorrida: "25",
                 alturaPulo: "1",
                distanciaPulo: "3",
                isLocked: true,
                password: senhaMatriz,
                imagem: null,
                anotacoes: "",
                 classeNome: "",
                classeDescricao: "",
                racaNome: "",
                racaDescricao: "",
                racaSelecionada: "",
                chatPassword: null, // Adicionado campo para a senha do chat
                 // MODIFICA√á√ÉO: Removidos backgroundImage e backgroundSize daqui, ser√£o lidos do localStorage
            };
            database.ref("fichas/ficha-matriz").once("value", snapshot => {
                if (snapshot.exists()) {
                    currentFichaId = fichaId;
                    carregarFicha(fichaId);
                    carregarFichas();
                    // MODIFICA√á√ÉO: aplicarPlanoDeFundoInicial √© chamado antes de carregarFichas agora
                    // aplicarPlanoDeFundoInicial(); // Aplicar plano de fundo ao carregar
                } else {
                    database.ref(`fichas/${fichaId}`).set(fichaMatriz).then(() => {
                        currentFichaId = fichaId;
                        carregarFicha(fichaId);
                         // MODIFICA√á√ÉO: aplicarPlanoDeFundoInicial √© chamado antes de carregarFichas agora
                        // aplicarPlanoDeFundoInicial(); // Aplicar plano de fundo ao carregar
                    });
                }
            });
         }

        function carregarFichas() {
            database.ref("fichas").on("value", snapshot => {
                fichas = snapshot.val() || {};
                if (fichas["ficha-matriz"]) {
                    atualizarAbasFichas();
                     atualizarListaFichasChat();
                    verificarNovasMensagens(); // Verificar mensagens ao carregar fichas
                } else {
                    criarFichaMatriz();
                }
            });
         }

        function atualizarAbasFichas() {
            const sidebar = document.getElementById("fichas-sidebar");
            const addBtn = document.getElementById("add-ficha-btn");

            while (sidebar.children.length > 1) {
                sidebar.removeChild(sidebar.children[0]);
             }

            for (let fichaId in fichas) {
                if (fichaId !== "ficha-matriz") {
                    const tab = document.createElement("div");
                    tab.className = "ficha-tab";
                    const span = document.createElement("span");
                    span.textContent = fichas[fichaId].nomeFicha || "Sem Nome";
                    tab.appendChild(span);
                    tab.dataset.fichaId = fichaId;
                    if (fichaId === currentFichaId) tab.classList.add("active");

                    tab.onclick = () => {
                        currentFichaId = fichaId;
                        carregarFicha(fichaId);
                        atualizarAbasFichas();
                        atualizarListaFichasChat(); // Atualizar lista de fichas no chat ao trocar de ficha
                        verificarNovasMensagens(); // Verificar mensagens ao trocar de ficha
                    };
                    sidebar.insertBefore(tab, addBtn);
                }
            }
        }

        document.getElementById("add-ficha-btn").onclick = () => {
            document.getElementById("nome-ficha-modal").style.display = "flex";
            document.getElementById("nome-ficha-input").value = "";
            document.getElementById("nome-ficha-input").focus();
        };

        function criarNovaFicha() {
            const nomeFicha = document.getElementById("nome-ficha-input").value.trim();
            if (!nomeFicha) return alert("Por favor, d√™ um nome √† ficha!");

            const novaFichaId = database.ref("fichas").push().key;
            const novaFicha = {
                nomeFicha,
                nomePersonagem: "",
                descricaoPersonagem: "",
                forca: "0",
                destreza: "0",
                 agilidade: "0",
                inteligencia: "0",
                constituicao: "0",
                experiencia: "0",
                armaDireitaNome: "",
                armaDireitaAtaque: "0",
                 armaDireitaAtaqueMagico: "0",
                armaEsquerdaNome: "",
                armaEsquerdaAtaque: "0",
                armaEsquerdaAtaqueMagico: "0",
                vantagens: "",
                magiasHabilidades: Array(10).fill("").join("\n"),
                 desvantagens: "",
                inventario: Array(10).fill({
                    item: "",
                    peso: "0"
                }),
                velocidadeCorrida: "25",
                alturaPulo: "1",
                distanciaPulo: "3",
                isLocked: false,
                password: null,
                imagem: null,
                 anotacoes: "",
                classeNome: "",
                classeDescricao: "",
                racaNome: "",
                racaDescricao: "",
                racaSelecionada: "",
                 chatPassword: null, // Adicionado campo para a senha do chat
                // MODIFICA√á√ÉO: Removidos backgroundImage e backgroundSize daqui
            };
            database.ref(`fichas/${novaFichaId}`).set(novaFicha).then(() => {
                currentFichaId = novaFichaId;
                carregarFicha(novaFichaId);
                fecharModal("nome-ficha-modal");
                atualizarAbasFichas();
                atualizarListaFichasChat(); // Atualizar lista de fichas no chat ao criar nova ficha
             }).catch(error => console.error("Erro ao criar nova ficha:", error));
         }

        function fecharModal(modalId) {
            document.getElementById(modalId).style.display = "none";
         }

        // ... (Sele√ß√£o de elementos DOM - Sem altera√ß√µes significativas, apenas adicionado background-color-input) ...
        const nomePersonagemInput = document.getElementById("nome-personagem"),
            descricaoPersonagemInput = document.getElementById("descricao-personagem"),
            forcaInput = document.getElementById("forca"),
            destrezaInput = document.getElementById("destreza"),
            agilidadeInput = document.getElementById("agilidade"),
            inteligenciaInput = document.getElementById("inteligencia"),
            constituicaoInput = document.getElementById("constituicao"),
             ataqueSpan = document.getElementById("ataque"),
            ataqueMagicoSpan = document.getElementById("ataque-magico"),
            acertoSpan = document.getElementById("acerto"),
            esquivaSpan = document.getElementById("esquiva"),
            rdfSpan = document.getElementById("rdf"),
            rdmSpan = document.getElementById("rdm"),
            armaDireitaNomeInput = document.getElementById("arma-direita-nome"),
             armaDireitaAtaqueInput = document.getElementById("arma-direita-ataque"),
            armaDireitaAtaqueMagicoInput = document.getElementById("arma-direita-ataque-magico"),
            armaEsquerdaNomeInput = document.getElementById("arma-esquerda-nome"),
            armaEsquerdaAtaqueInput = document.getElementById("arma-esquerda-ataque"),
            armaEsquerdaAtaqueMagicoInput = document.getElementById("arma-esquerda-ataque-magico"),
            resetPontosButton = document.getElementById("reset-pontos"),
            recomecarButton = document.getElementById("recomecar"),
             bloquearFichaButton = document.getElementById("bloquear-ficha"),
            experienciaInput = document.getElementById("experiencia"),
            nivelSpan = document.getElementById("nivel"),
            pontosHabilidadeSpan = document.getElementById("pontos-habilidade"),
            pontosVantagemSpan = document.getElementById("pontos-vantagem"),
            velocidadeCorridaSpan = document.getElementById("velocidade-corrida"),
            alturaPuloSpan = document.getElementById("altura-pulo"),
             distanciaPuloSpan = document.getElementById("distancia-pulo"),
            nomePersonagemTitulo = document.getElementById("nome-personagem-titulo"),
            gameMasterMessage = document.getElementById("game-master-message"),
            vantagensListDisplay = document.getElementById("vantagens-list-display"),
            desvantagensListDisplay = document.getElementById("desvantagens-list-display"),
            inventarioSlots = document.getElementById("inventario-slots"),
            pesoTotalSpan = document.getElementById("peso-total"),
            diceContainer = document.getElementById("dice-container"),
            diceRoll = document.getElementById("dice-roll"),
            diceResult = document.getElementById("dice-result"),
            notification = document.getElementById("notification"),
            characterImageInput = document.getElementById("character-image-input"),
            characterImage = document.getElementById("character-image"),
            vantagensDesvantagensBtn = document.getElementById("vantagens-desvantagens-btn"),
            vantagensDesvantagensPanel = document.getElementById("vantagens-desvantagens-panel"),
             vantagensList = document.getElementById("vantagens-list"),
            desvantagensList = document.getElementById("desvantagens-list"),
            salvarVantagensBtn = document.getElementById("salvar-vantagens-btn"),
            fecharPaginaBtn = document.getElementById("fechar-pagina-btn"),
            fichaContainer = document.getElementById("ficha-container"),
            magiasList = document.getElementById("magias-list"),
            adicionarMagiaBtn = document.getElementById("adicionar-magia-btn"),
             anotacoesBtn = document.getElementById("anotacoes-btn"),
            anotacoesTextarea = document.getElementById("anotacoes-textarea"),
            racasBtn = document.getElementById("racas-btn"),
            classesBtn = document.getElementById("classes-btn"),
            racasPanel = document.getElementById("racas-panel"),
            classesPanel = document.getElementById("classes-panel"),
            fecharRacasBtn = document.getElementById("fechar-racas-btn"),
             fecharClassesBtn = document.getElementById("fechar-classes-btn"),
            classeNomeInput = document.getElementById("classe-nome"),
            classeDescricaoInput = document.getElementById("classe-descricao"),
            racaNomeSpan = document.getElementById("raca-nome"),
            racaDescricaoInput = document.getElementById("raca-descricao"),
            luaBtn = document.getElementById("lua-btn"),
            solBtn = document.getElementById("sol-btn"),
             salvarRacasBtn = document.getElementById("salvar-racas-btn"),
            racasList = document.getElementById("racas-list"),
            atributosInputs = [forcaInput, destrezaInput, agilidadeInput, inteligenciaInput, constituicaoInput],
            chatBtn = document.getElementById("chat-btn"),
            availableFichasDiv = document.getElementById("available-fichas"),
            conversationAreaDiv = document.getElementById("conversation-area"),
            mensagemInput = document.getElementById("mensagem-input"),
             newMessageSound = document.getElementById("new-message-sound"),
            planoFundoBtn = document.getElementById("plano-fundo-btn"),
            backgroundImageInput = document.getElementById("background-image-input"),
            backgroundColorInput = document.getElementById("background-color-input"), // MODIFICA√á√ÉO: Adicionado
            backgroundModal = document.getElementById("background-modal");


        // ... (Vari√°veis de n√≠vel, xp, etc. e dados de n√≠vel - Sem altera√ß√µes) ...
         let nivel = 0,
            nivelAnterior = 0,
            pontosHabilidadeTotal = 25,
            pontosHabilidadeUsados = 0,
            experiencia = 0,
            vidaBase = 50;
         const nivelData = [{
            nivel: 0,
            xp: 0,
            pd: 25,
            ph: 8
        }, {
            nivel: 1,
            xp: 10,
             pd: 31,
            ph: 9
        }, {
            nivel: 2,
            xp: 30,
            pd: 37,
            ph: 10
        }, {
            nivel: 3,
             xp: 60,
            pd: 43,
            ph: 11
        }, {
            nivel: 4,
            xp: 100,
            pd: 49,
            ph: 12
         }, {
            nivel: 5,
            xp: 150,
            pd: 55,
            ph: 13
        }, {
            nivel: 6,
            xp: 210,
             pd: 61,
            ph: 14
        }, {
            nivel: 7,
            xp: 280,
            pd: 67,
            ph: 15
        }, {
             nivel: 8,
            xp: 360,
            pd: 73,
            ph: 16
        }, {
            nivel: 9,
            xp: 450,
            pd: 79,
             ph: 17
        }, {
            nivel: 10,
            xp: 550,
            pd: 85,
            ph: 18
        }, {
            nivel: 11,
            xp: 670,
            pd: 91,
            ph: 19
        }, {
            nivel: 12,
            xp: 810,
            pd: 97,
            ph: 20
        }, {
             nivel: 13,
            xp: 970,
            pd: 103,
            ph: 21
        }, {
            nivel: 14,
            xp: 1150,
            pd: 109,
             ph: 22
        }, {
            nivel: 15,
            xp: 1350,
            pd: 115,
            ph: 23
        }, {
            nivel: 16,
             xp: 1570,
            pd: 121,
            ph: 24
        }, {
            nivel: 17,
            xp: 1810,
            pd: 127,
            ph: 25
         }, {
            nivel: 18,
            xp: 2070,
            pd: 133,
            ph: 26
        }, {
            nivel: 19,
            xp: 2350,
             pd: 139,
            ph: 27
        }, {
            nivel: 20,
            xp: 2650,
            pd: 145,
            ph: 28
        }, {
            nivel: 21,
             xp: 2980,
            pd: 148,
            ph: 29
        }, {
            nivel: 22,
            xp: 3340,
            pd: 151,
            ph: 30
         }, {
            nivel: 23,
            xp: 3730,
            pd: 154,
            ph: 31
        }, {
            nivel: 24,
            xp: 4150,
             pd: 157,
            ph: 32
        }, {
            nivel: 25,
            xp: 4600,
            pd: 160,
            ph: 33
        }, {
             nivel: 26,
            xp: 5080,
            pd: 163,
            ph: 34
        }, {
            nivel: 27,
            xp: 5590,
            pd: 166,
             ph: 35
        }, {
            nivel: 28,
            xp: 6130,
            pd: 169,
            ph: 36
        }, {
            nivel: 29,
            xp: 8000,
             pd: 219,
            ph: 37
        }, {
            nivel: 30,
            xp: 10000,
            pd: 319,
            ph: 38
        }];

        function carregarFicha(fichaId) {
            if (!fichas[fichaId]) return;
            const ficha = fichas[fichaId];

            // Carregar dados normais da ficha do Firebase
            nomePersonagemInput.value = ficha.nomePersonagem || "";
            descricaoPersonagemInput.value = ficha.descricaoPersonagem || "";
            forcaInput.value = ficha.forca || "0";
            destrezaInput.value = ficha.destreza || "0";
            agilidadeInput.value = ficha.agilidade || "0";
            inteligenciaInput.value = ficha.inteligencia || "0";
            constituicaoInput.value = ficha.constituicao || "0";
            experienciaInput.value = ficha.experiencia || "0";
            armaDireitaNomeInput.value = ficha.armaDireitaNome || "";
            armaDireitaAtaqueInput.value = ficha.armaDireitaAtaque || "0";
            armaDireitaAtaqueMagicoInput.value = ficha.armaDireitaAtaqueMagico || "0";
            armaEsquerdaNomeInput.value = ficha.armaEsquerdaNome || "";
            armaEsquerdaAtaqueInput.value = ficha.armaEsquerdaAtaque || "0";
            armaEsquerdaAtaqueMagicoInput.value = ficha.armaEsquerdaAtaqueMagico || "0";

            velocidadeCorridaSpan.textContent = ficha.velocidadeCorrida || "25";
            alturaPuloSpan.textContent = ficha.alturaPulo || "1";
            distanciaPuloSpan.textContent = ficha.distanciaPulo || "3";

            isFichaLocked = ficha.isLocked || false;
            fichaPassword = ficha.password || null;
            isFichaUnlocked = false;

            vantagensSelecionadas = ficha.vantagens ? ficha.vantagens.split("\n").filter(v => v.trim()) : [];
            desvantagensSelecionadas = ficha.desvantagens ? ficha.desvantagens.split("\n").filter(d => d.trim()) : [];

            racaSelecionada = ficha.racaSelecionada || "";
            racaNomeSpan.textContent = racaSelecionada.split(" (")[0];
            racaDescricaoInput.value = racasData.find(r => r.nome === racaSelecionada)?.vantagens.join("\n\n") || "";

            vantagensListDisplay.innerHTML = "";
            desvantagensListDisplay.innerHTML = "";

            vantagensSelecionadas.forEach(v => {
                const div = document.createElement("div");
                 div.textContent = v;
                div.className = "list-item";
                div.onclick = () => removerVantagem(v);
                vantagensListDisplay.appendChild(div);
            });

            desvantagensSelecionadas.forEach(d => {
                const div = document.createElement("div");
                div.textContent = d;
                div.className = "list-item";
                div.onclick = () => removerDesvantagem(d);
                desvantagensListDisplay.appendChild(div);
            });

            const inventario = Array.isArray(ficha.inventario) ? ficha.inventario : Array(10).fill({ item: "", peso: "0" });
            const slots = inventarioSlots.querySelectorAll(".inventory-slot");
            slots.forEach((slot, i) => {
                const itemInput = slot.querySelector(".inventory-item");
                const weightInput = slot.querySelector(".inventory-weight");
                itemInput.value = inventario[i]?.item || "";
                weightInput.value = inventario[i]?.peso || "0";
            });
            calcularPesoTotal();

            const magias = ficha.magiasHabilidades ? ficha.magiasHabilidades.split("\n") : Array(10).fill("");
            magiasList.innerHTML = "";
            magias.forEach((m, i) => {
                const input = document.createElement("input");
                input.type = "text";
                input.className = "magia-nome";
                input.placeholder = `Magia/Habilidade ${i+1}`;
                input.value = m;
                 magiasList.appendChild(input);
            });
            anotacoesTextarea.value = ficha.anotacoes || "";

            classeNomeInput.value = ficha.classeNome || "";
            classeDescricaoInput.value = ficha.classeDescricao || "";
            if (ficha.imagem) {
                characterImage.src = ficha.imagem;
                characterImage.style.display = "block";
            } else {
                characterImage.style.display = "none";
            }

            atualizarBotaoBloquear();
            atualizarVantagensDesvantagensPanel(); // Atualiza os pain√©is com base nos dados carregados
            atualizarRacasPanel(); // Atualiza os pain√©is com base nos dados carregados


            experiencia = parseInt(experienciaInput.value) || 0;
            atualizarNivel();
            calcularAtributos();

            // Inicializa vida/magia/vigor se n√£o estiverem definidos ainda
            // Garante que os valores atuais n√£o excedam os totais recalculados
            vidaAtual = vidaAtual !== undefined ? Math.min(vidaAtual, vidaTotal) : vidaTotal;
            magiaAtual = magiaAtual !== undefined ? Math.min(magiaAtual, magiaTotal) : magiaTotal;
            vigorAtual = vigorAtual !== undefined ? Math.min(vigorAtual, vigorTotal) : vigorTotal;


            document.getElementById("vida-atual").textContent = vidaAtual;
            document.getElementById("magia-atual").textContent = magiaAtual;
            document.getElementById("vigor-atual").textContent = vigorAtual.toFixed(1);
            pontosVantagemSpan.textContent = getPontosVantagem();

            previousValues.clear();
            document.querySelectorAll('input[type="text"],input[type="number"],textarea').forEach(input => previousValues.set(input, input.value));

            chatPassword = ficha.chatPassword;
            atualizarEstadoChatBotao();

            // MODIFICA√á√ÉO: A aplica√ß√£o inicial do background √© feita por aplicarPlanoDeFundoInicial() antes de carregar a ficha.
            // N√£o precisamos mais carregar do 'ficha' aqui.

            // Limpar o input de file de background ao trocar de ficha
            backgroundImageInput.value = null;
         }

        function atualizarBotaoBloquear() {
            bloquearFichaButton.textContent = isFichaLocked ? "Desbloquear Ficha" : "Bloquear Ficha";
            bloquearFichaButton.classList.toggle("botao-bloquear", !isFichaLocked);
            bloquearFichaButton.classList.toggle("botao-desbloquear", isFichaLocked);
        }

        function salvarDados() {
            if (!currentFichaId) return;
            if (isFichaLocked && !isFichaUnlocked) return abrirModalSenha();

            const inventario = Array.from(inventarioSlots.querySelectorAll(".inventory-slot")).map(slot => ({
                item: slot.querySelector(".inventory-item").value,
                peso: slot.querySelector(".inventory-weight").value
            }));
            const magias = Array.from(magiasList.querySelectorAll(".magia-nome")).map(input => input.value);

            const dados = {
                nomePersonagem: nomePersonagemInput.value,
                descricaoPersonagem: descricaoPersonagemInput.value,
                forca: forcaInput.value,
                destreza: destrezaInput.value,
                agilidade: agilidadeInput.value,
                 inteligencia: inteligenciaInput.value,
                constituicao: constituicaoInput.value,
                experiencia: experienciaInput.value,
                armaDireitaNome: armaDireitaNomeInput.value,
                armaDireitaAtaque: armaDireitaAtaqueInput.value,
                armaDireitaAtaqueMagico: armaDireitaAtaqueMagicoInput.value,
                 armaEsquerdaNome: armaEsquerdaNomeInput.value,
                armaEsquerdaAtaque: armaEsquerdaAtaqueInput.value,
                armaEsquerdaAtaqueMagico: armaEsquerdaAtaqueMagicoInput.value,
                vantagens: vantagensSelecionadas.join("\n"),
                magiasHabilidades: magias.join("\n"),
                desvantagens: desvantagensSelecionadas.join("\n"),
                 inventario,
                velocidadeCorrida: velocidadeCorridaSpan.textContent,
                alturaPulo: alturaPuloSpan.textContent,
                distanciaPulo: distanciaPuloSpan.textContent,
                isLocked: isFichaLocked,
                password: fichaPassword,
                 imagem: characterImage.src.startsWith('data:image') ? characterImage.src : null, // Salva imagem apenas se for data URL
                anotacoes: anotacoesTextarea.value,
                classeNome: classeNomeInput.value,
                classeDescricao: classeDescricaoInput.value,
                racaNome: racaNomeSpan.textContent,
                racaDescricao: racaDescricaoInput.value,
                 racaSelecionada: racaSelecionada,
                chatPassword: chatPassword,
                // MODIFICA√á√ÉO: Removidos backgroundImage e backgroundSize daqui
            };
            database.ref(`fichas/${currentFichaId}`).update(dados).then(() => {
                showNotification("Salvo no Firebase!", "save-success"); // Mensagem pode ser ajustada
                previousValues.clear();
                document.querySelectorAll('input[type="text"],input[type="number"],textarea').forEach(input => previousValues.set(input, input.value));
            });
         }

        // ... (Fun√ß√µes calcularNivel, atualizarNivel, getPontosVantagem, calcularPontosVantagemTemp - Sem altera√ß√µes) ...
        function calcularNivel(exp) {
            return nivelData.findLast(data => exp >= data.xp)?.nivel || 0;
        }

        function atualizarNivel() {
            nivelAnterior = nivel;
            nivel = calcularNivel(experiencia);
            nivelSpan.textContent = nivel;
            pontosHabilidadeTotal = nivelData[nivel].pd;
            pontosVantagemSpan.textContent = getPontosVantagem();
            if (nivel > nivelAnterior) {
                nivelSpan.classList.add("aura-azul");
                setTimeout(() => nivelSpan.classList.remove("aura-azul"), 20000);
            }

            gameMasterMessage.style.display = nivel >= 30 ? "block" : "none";
            fichaContainer.classList.toggle("aura-azul", nivel >= 30);

            calcularAtributos();
        }

        function getPontosVantagem() {
            let ph = nivelData[nivel].ph;
            vantagensSelecionadas.forEach(v => {
                const vantagem = vantagensData.find(d => d.nome === v);
                if (vantagem) ph -= vantagem.custo;
            });
            desvantagensSelecionadas.forEach(d => {
                const desvantagem = desvantagensData.find(desv => desv.nome === d);
                if (desvantagem) ph += desvantagem.ganho;
            });
            if (racaSelecionada) {
                const raca = racasData.find(r => r.nome === racaSelecionada);
                if (raca) ph -= raca.custo;
            }

            return ph;
         }

        function calcularPontosVantagemTemp() {
            let ph = nivelData[nivel].ph;
            tempVantagensSelecionadas.forEach(v => {
                const vantagem = vantagensData.find(d => d.nome === v);
                if (vantagem) ph -= vantagem.custo;
            });
            tempDesvantagensSelecionadas.forEach(d => {
                const desvantagem = desvantagensData.find(desv => desv.nome === d);
                if (desvantagem) ph += desvantagem.ganho;
            });
            if (tempRacaSelecionada) {
                const raca = racasData.find(r => r.nome === tempRacaSelecionada);
                if (raca) ph -= raca.custo;
            }

            return ph;
         }


        // ... (Fun√ß√µes aumentar/diminuir Vida, Magia, Vigor - Sem altera√ß√µes) ...
        function aumentarVida() {
            if (vidaAtual < vidaTotal) {
                vidaAtual++;
                document.getElementById("vida-atual").textContent = vidaAtual;
                salvarDados();
            }
        }

        function diminuirVida() {
            if (vidaAtual > 0) {
                vidaAtual--;
                document.getElementById("vida-atual").textContent = vidaAtual;
                salvarDados();
            }
        }

        function aumentarMagia() {
            if (magiaAtual < magiaTotal) {
                magiaAtual++;
                document.getElementById("magia-atual").textContent = magiaAtual;
                salvarDados();
            }
        }

        function diminuirMagia() {
            if (magiaAtual > 0) {
                magiaAtual--;
                document.getElementById("magia-atual").textContent = magiaAtual;
                salvarDados();
            }
        }

        function aumentarVigor() {
            if (vigorAtual < vigorTotal) {
                vigorAtual = Math.min(vigorAtual + 0.1, vigorTotal);
                document.getElementById("vigor-atual").textContent = vigorAtual.toFixed(1);
                salvarDados();
            }
        }

        function diminuirVigor() {
            if (vigorAtual > 0) {
                vigorAtual = Math.max(vigorAtual - 0.1, 0);
                document.getElementById("vigor-atual").textContent = vigorAtual.toFixed(1);
                salvarDados();
            }
        }


        // ... (Fun√ß√£o calcularAtributos - Sem altera√ß√µes) ...
        function calcularAtributos() {
            const forca = parseInt(forcaInput.value) || 0,
                destreza = parseInt(destrezaInput.value) || 0,
                agilidade = parseInt(agilidadeInput.value) || 0,
                inteligencia = parseInt(inteligenciaInput.value) || 0,
                constituicao = parseInt(constituicaoInput.value) || 0;

            let totalPontos = forca + destreza + agilidade + inteligencia + constituicao;
            if (totalPontos > pontosHabilidadeTotal) {
                alert("Pontos de habilidade insuficientes!");
                forcaInput.value = previousValues.get(forcaInput) || "0";
                destrezaInput.value = previousValues.get(destrezaInput) || "0";
                agilidadeInput.value = previousValues.get(agilidadeInput) || "0";
                inteligenciaInput.value = previousValues.get(inteligenciaInput) || "0";
                constituicaoInput.value = previousValues.get(constituicaoInput) || "0";
                return;
            }

            pontosHabilidadeUsados = totalPontos;
            pontosHabilidadeSpan.textContent = pontosHabilidadeTotal - pontosHabilidadeUsados;

            let ataque = forca + Math.floor(destreza / 5),
                acerto = Math.floor(destreza / 3) + Math.floor(agilidade / 10),
                esquiva = Math.floor(agilidade / 3),
                rdf = Math.floor(forca / 5),
                rdm = Math.floor(inteligencia / 5),
                 ataqueMagico = inteligencia,
                magiaBase = 20 + 3 * constituicao,
                vigorBase = 10 + 0.4 * constituicao;
            vidaBase = 50 + (constituicao * (3 + Math.floor(forca / 10))) + 10 * nivel;
            if (inteligencia >= 10) magiaBase += constituicao * Math.floor(inteligencia / 10);

            ataque += (parseInt(armaDireitaAtaqueInput.value) || 0) + (parseInt(armaEsquerdaAtaqueInput.value) || 0);
            ataqueMagico += (parseInt(armaDireitaAtaqueMagicoInput.value) || 0) + (parseInt(armaEsquerdaAtaqueMagicoInput.value) || 0);

            const velocidadeBase = 25 + Math.floor(agilidade / 3) * 3,
                alturaPuloBase = 1 + Math.floor(forca / 10),
                distanciaPuloBase = 3 + 3 * Math.min(Math.floor(forca / 5), Math.floor(agilidade / 5));
            let bonusVelocidade = vantagensSelecionadas.includes("Combo F√≠sico (4)") ? 25 : 0,
                bonusAlturaPulo = vantagensSelecionadas.includes("Combo F√≠sico (4)") ? 2 : 0,
                bonusDistanciaPulo = vantagensSelecionadas.includes("Combo F√≠sico (4)") ? 6 : 0;

            velocidadeCorridaSpan.textContent = velocidadeBase + bonusVelocidade;
            alturaPuloSpan.textContent = alturaPuloBase + bonusAlturaPulo;
            distanciaPuloSpan.textContent = distanciaPuloBase + bonusDistanciaPulo;
            ataqueSpan.textContent = ataque;
            ataqueMagicoSpan.textContent = ataqueMagico;
            acertoSpan.textContent = acerto;
            esquivaSpan.textContent = esquiva;
            rdfSpan.textContent = rdf;
            rdmSpan.textContent = rdm;
            vidaTotal = Math.ceil(vidaBase);
            magiaTotal = Math.ceil(magiaBase);
            vigorTotal = parseFloat(vigorBase.toFixed(1));

             // Garante que os valores atuais n√£o excedam os totais recalculados
            vidaAtual = vidaAtual !== undefined ? Math.min(vidaAtual, vidaTotal) : vidaTotal;
            magiaAtual = magiaAtual !== undefined ? Math.min(magiaAtual, magiaTotal) : magiaTotal;
            vigorAtual = vigorAtual !== undefined ? Math.min(vigorAtual, vigorTotal) : vigorTotal;

            document.getElementById("vida-total").textContent = vidaTotal;
            document.getElementById("magia-total").textContent = magiaTotal;
            document.getElementById("vigor-total").textContent = vigorTotal.toFixed(1);
            document.getElementById("vida-atual").textContent = vidaAtual;
            document.getElementById("magia-atual").textContent = magiaAtual;
            document.getElementById("vigor-atual").textContent = vigorAtual.toFixed(1);
            const regeneracaoVida = (0.2 * constituicao).toFixed(1),
                regeneracaoMagia = (0.8 * constituicao).toFixed(1),
                regeneracaoVigor = (0.4 * constituicao).toFixed(1);
            document.getElementById("regeneracao-vida").textContent = regeneracaoVida;
            document.getElementById("regeneracao-magia").textContent = regeneracaoMagia;
            document.getElementById("regeneracao-vigor").textContent = regeneracaoVigor;

            const atributos = [{
                span: ataqueSpan,
                valor: ataque
            }, {
                span: ataqueMagicoSpan,
                valor: ataqueMagico
             }, {
                span: acertoSpan,
                valor: acerto
            }, {
                span: esquivaSpan,
                valor: esquiva
            }, {
                span: rdfSpan,
                valor: rdf
            }, {
                span: rdmSpan,
                valor: rdm
            }];
            atributos.forEach(a => a.span.classList.remove("atributo-fogo"));

            const maxAtributo = atributos.reduce((prev, curr) => prev.valor > curr.valor ? prev : curr, {
                valor: 0
            });
            if (maxAtributo.valor > 0) maxAtributo.span.classList.add("atributo-fogo");
        }


        // ... (Fun√ß√µes resetarPontos, recomecarFicha, bloquear/desbloquear ficha, verificarAlteracao, listeners de input - Sem altera√ß√µes) ...
        function resetarPontos() {
            if (isFichaLocked && !isFichaUnlocked) return abrirModalSenha();
            if (confirm("Tem certeza que deseja reiniciar os pontos? Voc√™ precisar√° da permiss√£o do GM.")) {
                document.getElementById("senha-gm-modal").style.display = "flex";
                document.getElementById("senha-gm-input").value = "";
                document.getElementById("confirmar-senha-gm-btn").onclick = () => {
                    if (document.getElementById("senha-gm-input").value === senhaMatriz) {
                        atributosInputs.forEach(input => input.value = 0);
                        pontosHabilidadeUsados = 0;
                        pontosHabilidadeSpan.textContent = pontosHabilidadeTotal;
                        velocidadeCorridaSpan.textContent = "25";
                        alturaPuloSpan.textContent = "1";
                        distanciaPuloSpan.textContent = "3";
                        calcularAtributos();
                        pontosVantagemSpan.textContent = getPontosVantagem();
                        salvarDados();
                        fecharModal("senha-gm-modal");
                    } else {
                        alert("Senha do GM incorreta!");
                        fecharModal("senha-gm-modal");
                    }
                };
             }
        }

        function recomecarFicha() {
            if (confirm("Tem certeza que deseja recome√ßar a ficha? Todas as altera√ß√µes ser√£o perdidas.")) {
                atributosInputs.forEach(input => input.value = 0);
                pontosHabilidadeUsados = 0;
                pontosHabilidadeSpan.textContent = pontosHabilidadeTotal;
                velocidadeCorridaSpan.textContent = "25";
                alturaPuloSpan.textContent = "1";
                distanciaPuloSpan.textContent = "3";
                nomePersonagemInput.value = "";
                descricaoPersonagemInput.value = "";
                experienciaInput.value = 0;
                nivel = 0;
                pontosHabilidadeTotal = nivelData[nivel].pd;
                pontosHabilidadeUsados = 0;
                nivelSpan.textContent = nivel;
                pontosHabilidadeSpan.textContent = pontosHabilidadeTotal;
                vidaBase = 50;

                armaDireitaNomeInput.value = "";
                armaDireitaAtaqueInput.value = "0";
                armaDireitaAtaqueMagicoInput.value = "0";
                armaEsquerdaNomeInput.value = "";
                armaEsquerdaAtaqueInput.value = "0";
                armaEsquerdaAtaqueMagicoInput.value = "0";

                magiasList.innerHTML = "";
                for (let i = 0; i < 10; i++) {
                    const input = document.createElement("input");
                    input.type = "text";
                    input.className = "magia-nome";
                    input.placeholder = `Magia/Habilidade ${i+1}`;
                    magiasList.appendChild(input);
                 }

                const slots = inventarioSlots.querySelectorAll(".inventory-slot");
                slots.forEach(slot => {
                    slot.querySelector(".inventory-item").value = "";
                    slot.querySelector(".inventory-weight").value = "0";
                });
                characterImage.style.display = "none";
                characterImage.src = "";

                vantagensSelecionadas = [];
                desvantagensSelecionadas = [];
                racaSelecionada = null;

                vantagensListDisplay.innerHTML = "";
                desvantagensListDisplay.innerHTML = "";

                anotacoesTextarea.value = "";

                classeNomeInput.value = "";
                classeDescricaoInput.value = "";
                racaNomeSpan.textContent = "";
                racaDescricaoInput.value = "";

                calcularAtributos();
                pontosVantagemSpan.textContent = getPontosVantagem();
                salvarDados();
            }
        }

        bloquearFichaButton.onclick = () => {
            if (isFichaLocked) abrirModalSenha();
            else {
                document.getElementById("bloquear-ficha-modal").style.display = "flex";
                document.getElementById("senha-bloqueio-input").value = "";
                document.getElementById("senha-bloqueio-input").focus();
            }
        };
        function bloquearFicha() {
            const senha = document.getElementById("senha-bloqueio-input").value;
            if (senha.length !== 4 || !/^\d{4}$/.test(senha)) return alert("A senha deve ter exatamente 4 d√≠gitos num√©ricos!");
            if (desvantagensSelecionadas.length > 3) return alert("Voc√™ pode ter no m√°ximo 3 desvantagens!");

            isFichaLocked = true;
            fichaPassword = senha;
            database.ref(`fichas/${currentFichaId}`).update({
                isLocked: true,
                password: senha
            }).then(() => {
                fecharModal("bloquear-ficha-modal");
                alert("Ficha bloqueada com sucesso!");
                atualizarBotaoBloquear();

             }).catch(error => console.error("Erro ao bloquear ficha:", error));
         }

        function abrirModalSenha(element = null) {
            document.getElementById("password-modal").style.display = "flex";
            document.getElementById("senha-desbloqueio-input").value = "";
            document.getElementById("senha-desbloqueio-input").focus();
            if (element) document.getElementById("password-modal").dataset.elementId = element.id;
            else delete document.getElementById("password-modal").dataset.elementId;
         }

        function desbloquearFicha() {
            const senha = document.getElementById("senha-desbloqueio-input").value,
                modal = document.getElementById("password-modal"),
                elementId = modal.dataset.elementId;
            if (senha !== senhaMatriz && senha !== fichaPassword) return alert("Senha incorreta!");

            isFichaUnlocked = true;
            if (currentFichaId !== "ficha-matriz" && senha !== senhaMatriz) {
                database.ref(`fichas/${currentFichaId}`).update({
                    isLocked: false,
                    password: null
                }).then(() => {

                     fecharModal("password-modal");
                    alert("Ficha desbloqueada permanentemente!");
                    atualizarBotaoBloquear();
                    if (elementId === "reset-pontos") resetarPontos();
                    else if (elementId === "recomecar") recomecarFicha();
                     else if (elementId) {
                        previousValues.set(document.getElementById(elementId), document.getElementById(elementId).value);
                        salvarDados();
                    }

                 }).catch(error => console.error("Erro ao desbloquear ficha:", error));
             } else {
                fecharModal("password-modal");
                alert("Ficha desbloqueada temporariamente com a senha matriz!");
                if (elementId === "reset-pontos") resetarPontos();
                else if (elementId === "recomecar") recomecarFicha();
                else if (elementId) {
                    previousValues.set(document.getElementById(elementId), document.getElementById(elementId).value);
                    salvarDados();
                }
            }
        }

        function cancelarDesbloqueio() {
            const modal = document.getElementById("password-modal"),
                elementId = modal.dataset.elementId;
            if (elementId) document.getElementById(elementId).value = previousValues.get(document.getElementById(elementId)) || "";
            fecharModal("password-modal");
        }

        function verificarAlteracao(event) {
            const input = event.target;
            if (isFichaLocked && !isFichaUnlocked) {
                event.preventDefault();
                // Guarda o valor que estava ANTES da tentativa de edi√ß√£o
                input.value = previousValues.get(input) || ""; // Restaura valor anterior visualmente
                abrirModalSenha(input); // Abre modal para desbloquear e permitir a edi√ß√£o
            } else {
                 // Permite a altera√ß√£o e atualiza o valor "anterior" para o novo valor
                 // A chamada salvarDados() no listener 'input' far√° a persist√™ncia
                 // Mas atualizamos o previousValues aqui para refletir o estado antes da *pr√≥xima* altera√ß√£o
                 previousValues.set(input, input.value);
             }
        }


        document.querySelectorAll('input[type="text"],input[type="number"],textarea').forEach(input => {
            // 'focus' guarda o valor ANTES de qualquer mudan√ßa no campo focado
             input.addEventListener('focus', (event) => {
                 if (!previousValues.has(event.target)) {
                     previousValues.set(event.target, event.target.value);
                 }
             });
             // 'blur' ou 'change' podem ser usados para salvar, mas 'input' √© mais reativo
             input.addEventListener('input', (event) => {
                 // Verifica se a ficha est√° bloqueada ANTES de salvar
                 if (isFichaLocked && !isFichaUnlocked) {
                      // Se estiver bloqueada, restaura o valor que estava antes do foco
                     event.target.value = previousValues.get(event.target) || "";
                     // N√£o salva e idealmente n√£o deveria chegar aqui se 'verificarAlteracao' funcionar
                 } else {
                     // Ficha desbloqueada ou nunca bloqueada, processa e salva
                     if (input.id === "experiencia") {
                         experiencia = parseInt(input.value) || 0;
                         atualizarNivel();
                     } else if (atributosInputs.includes(input)) {
                         // Valida√ß√£o de pontos j√° acontece em calcularAtributos
                         calcularAtributos();
                     } else if (input.id.includes("arma")) {
                         calcularAtributos();
                     }
                     // Atualiza o valor "anterior" para refletir a mudan√ßa bem-sucedida
                     previousValues.set(event.target, event.target.value);
                     salvarDados(); // Salva a altera√ß√£o
                 }
             });

             // Adiciona 'beforeinput' para PREVENIR a mudan√ßa se bloqueado
             input.addEventListener('beforeinput', (event) => {
                 if (isFichaLocked && !isFichaUnlocked) {
                     event.preventDefault(); // Impede a altera√ß√£o no input
                     abrirModalSenha(event.target); // Abre o modal para desbloquear
                 }
                 // Se desbloqueado, n√£o faz nada, permite o input
             });

        });

        // Salvar nome/descri√ß√£o do personagem
        nomePersonagemInput.oninput = () => { if (!isFichaLocked || isFichaUnlocked) salvarDados(); };
        descricaoPersonagemInput.oninput = () => { if (!isFichaLocked || isFichaUnlocked) salvarDados(); };
        classeNomeInput.oninput = () => { if (!isFichaLocked || isFichaUnlocked) salvarDados(); };
        classeDescricaoInput.oninput = () => { if (!isFichaLocked || isFichaUnlocked) salvarDados(); };


        // ... (Upload da imagem do personagem - Sem altera√ß√µes) ...
        characterImageInput.onchange = e => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = e => {
                    characterImage.src = e.target.result;
                    characterImage.style.display = "block";
                    salvarDados(); // Salva a imagem no Firebase junto com outros dados
                };
                reader.readAsDataURL(file);
            }
        };

        // ... (Excluir ficha - Sem altera√ß√µes) ...
        document.getElementById("excluir-ficha").onclick = () => {
            if (currentFichaId === "ficha-matriz") return alert("A ficha matriz n√£o pode ser exclu√≠da!");
            if (isFichaLocked && !isFichaUnlocked) return abrirModalSenha();
            if (confirm("Tem certeza que deseja excluir esta ficha?"))
                database.ref(`fichas/${currentFichaId}`).remove().then(() => {
                    currentFichaId = "ficha-matriz";
                    carregarFicha(currentFichaId);
                    atualizarAbasFichas();

                 });
        };

        // ... (Arrastar e rolar dados, notifica√ß√µes - Sem altera√ß√µes) ...
        let isDragging = false,
            currentX = diceContainer.offsetLeft,
            currentY = diceContainer.offsetTop,
            initialX, initialY;
        diceContainer.onmousedown = e => {
            isDragging = true;
            initialX = e.clientX - currentX;
            initialY = e.clientY - currentY;
            diceContainer.style.cursor = "grabbing";
        };
        document.onmousemove = e => {
            if (isDragging) {
                e.preventDefault();
                currentX = e.clientX - initialX;
                currentY = e.clientY - initialY;
                diceContainer.style.left = `${currentX}px`;
                diceContainer.style.top = `${currentY}px`;
                diceContainer.style.right = "auto";
             }
        };

        document.onmouseup = () => {
            isDragging = false;
            diceContainer.style.cursor = "move";
        };

        database.ref('dadosRolados').on('child_added', snapshot => {
            const dado = snapshot.val();
             if(currentFichaId && dado.fichaId !== currentFichaId) { // S√≥ notifica dados de OUTRAS fichas
                 showNotification(`${dado.nomeFicha} rolou: ${dado.resultado}`, "normal-result");
             }
        });

        diceRoll.onclick = () => {
            if (isFichaLocked && !isFichaUnlocked) return abrirModalSenha();
            diceRoll.textContent = "Rolling...";
            diceResult.style.display = "none";
            diceRoll.classList.remove("critical-failure", "critical-success");

            setTimeout(() => {
                const roll = Math.floor(Math.random() * 20) + 1;
                const fichaNome = fichas[currentFichaId]?.nomeFicha || "Sem Nome"; // Garante que a ficha existe

                diceRoll.textContent = roll;
                let notificationMsg = `${fichaNome} rolou: ${roll}`;
                let notificationClass = "normal-result";


                if (roll === 1) {
                    diceRoll.classList.add("critical-failure");
                    notificationMsg = `${fichaNome} - FALHA CR√çTICA! (${roll})`;
                    notificationClass = "critical-failure";
                 } else if (roll === 20) {
                     diceRoll.classList.add("critical-success");
                    notificationMsg = `${fichaNome} - SUCESSO CR√çTICO! (${roll})`;
                    notificationClass = "critical-success";
                 } else {
                     diceResult.textContent = notificationMsg; // Mostra o resultado normal abaixo do dado
                     diceResult.style.display = "block";
                     // notificationMsg e notificationClass j√° est√£o corretos
                 }

                 // Mostra a notifica√ß√£o grande no centro
                 showNotification(notificationMsg, notificationClass);

                 // Salva no Firebase
                 const dadoRef = database.ref('dadosRolados').push();
                 dadoRef.set({
                     fichaId: currentFichaId,
                     nomeFicha: fichaNome,
                     resultado: roll,
                     timestamp: firebase.database.ServerValue.TIMESTAMP // Adiciona timestamp
                 });
             }, 1000);
        };


        // ... (Vantagens/Desvantagens: Abrir painel - Sem altera√ß√µes) ...
        vantagensDesvantagensBtn.onclick = () => {
            if (isFichaLocked && !isFichaUnlocked) return abrirModalSenha();
            tempVantagensSelecionadas = [...vantagensSelecionadas];
            tempDesvantagensSelecionadas = [...desvantagensSelecionadas];
            vantagensDesvantagensPanel.style.display = "block";
            document.getElementById("salvar-vantagens-btn").style.display = "none"; // Esconde salvar inicialmente
            atualizarVantagensDesvantagensPanel();
        };

        // ... (Vantagens/Desvantagens: Fechar painel - Sem altera√ß√µes) ...
        fecharPaginaBtn.onclick = () => {
            vantagensDesvantagensPanel.style.display = "none";
        };

        // ... (Vantagens/Desvantagens: Bot√£o Salvar -> Abre modal de confirma√ß√£o - Sem altera√ß√µes) ...
        salvarVantagensBtn.onclick = () => {
             // Verifica se tem desvantagens demais ANTES de abrir a confirma√ß√£o final
            if (tempDesvantagensSelecionadas.length > 3) {
                 alert("Voc√™ pode ter no m√°ximo 3 desvantagens!");
                 return; // Impede de abrir o modal de confirma√ß√£o
             }
            document.getElementById("salvar-vantagens-modal").style.display = "flex";
        };

        // ... (Vantagens/Desvantagens: Confirma√ß√£o do Salvamento - L√≥gica principal revisada) ...
        // MODIFICA√á√ÉO: Esta fun√ß√£o agora lida APENAS com Vantagens/Desvantagens
        // A l√≥gica de salvar Ra√ßas foi movida para o salvarRacasBtn.onclick
        document.getElementById("confirmar-salvar-vantagens-btn").onclick = () => {
             // Dupla verifica√ß√£o de desvantagens (caso o usu√°rio tenha modificado ap√≥s clicar em salvar)
             if (tempDesvantagensSelecionadas.length > 3) {
                 alert("Voc√™ pode ter no m√°ximo 3 desvantagens!");
                 fecharModal('salvar-vantagens-modal'); // Fecha o modal de confirma√ß√£o
                 return; // N√£o salva
             }

            // Salvar Vantagens/Desvantagens
            vantagensSelecionadas = [...tempVantagensSelecionadas];
            desvantagensSelecionadas = [...tempDesvantagensSelecionadas];

            // Atualizar a exibi√ß√£o na ficha principal
            vantagensListDisplay.innerHTML = "";
            desvantagensListDisplay.innerHTML = "";
            vantagensSelecionadas.forEach(v => {
                const div = document.createElement("div");
                div.textContent = v;
                div.className = "list-item";
                div.onclick = () => removerVantagem(v);
                vantagensListDisplay.appendChild(div);
             });
            desvantagensSelecionadas.forEach(d => {
                const div = document.createElement("div");
                div.textContent = d;
                div.className = "list-item";
                div.onclick = () => removerDesvantagem(d);
                desvantagensListDisplay.appendChild(div);
             });

            pontosVantagemSpan.textContent = getPontosVantagem(); // Recalcula PH
            salvarDados(); // Salva no Firebase
            calcularAtributos(); // Recalcula atributos derivados

            // MODIFICA√á√ÉO: Fecha o painel e o modal de confirma√ß√£o
            vantagensDesvantagensPanel.style.display = "none";
            fecharModal("salvar-vantagens-modal");
        };


        // ... (Fun√ß√£o atualizarVantagensDesvantagensPanel - Sem altera√ß√µes) ...
        function atualizarVantagensDesvantagensPanel() {
            vantagensList.innerHTML = "<h3>Vantagens</h3>";
            desvantagensList.innerHTML = "<h3>Desvantagens</h3>";

            vantagensData.forEach(v => {
                const div = document.createElement("div");
                div.className = "vantagem-item";
                div.textContent = `${v.nome} - Custo: ${v.custo} PH - ${v.descricao}`;

                if (tempVantagensSelecionadas.includes(v.nome)) div.classList.add("comprada");


                 div.onclick = () => {
                    // Verifica se j√° foi salva permanentemente
                    if (vantagensSelecionadas.includes(v.nome)) {
                         alert("Esta vantagem j√° foi salva e s√≥ pode ser removida com permiss√£o do GM.");
                         return; // N√£o faz nada se j√° salva
                     }

                     // Se n√£o salva, permite adicionar/remover da lista tempor√°ria
                    if (tempVantagensSelecionadas.includes(v.nome)) {
                         tempVantagensSelecionadas = tempVantagensSelecionadas.filter(t => t !== v.nome);
                     } else {
                         if (v.restricao === "inicio" && nivel > 0) {
                             alert("A compra dessa vantagem √© somente no n√≠vel 0.");
                             return;
                         }
                        if (calcularPontosVantagemTemp() >= v.custo) {
                             tempVantagensSelecionadas.push(v.nome);
                         } else {
                             alert("Pontos de Vantagem insuficientes!");
                             return;
                         }
                     }
                    atualizarVantagensDesvantagensPanel();
                    document.getElementById("salvar-vantagens-btn").style.display = "block"; // Mostra o bot√£o salvar
                };

                vantagensList.appendChild(div);
            });

            desvantagensData.forEach(d => {
                const div = document.createElement("div");
                div.className = "desvantagem-item";
                div.textContent = `${d.nome} - Ganho: ${d.ganho} PH - ${d.descricao}`;

                if (tempDesvantagensSelecionadas.includes(d.nome)) div.classList.add("comprada");


                 div.onclick = () => {
                     // Verifica se j√° foi salva permanentemente
                     if (desvantagensSelecionadas.includes(d.nome)) {
                          alert("Esta desvantagem j√° foi salva e s√≥ pode ser removida com permiss√£o do GM.");
                          return; // N√£o faz nada se j√° salva
                      }

                     // Se n√£o salva, permite adicionar/remover da lista tempor√°ria
                    if (tempDesvantagensSelecionadas.includes(d.nome)) {
                         tempDesvantagensSelecionadas = tempDesvantagensSelecionadas.filter(t => t !== d.nome);
                     } else {
                         if (tempDesvantagensSelecionadas.length < 3) {
                             tempDesvantagensSelecionadas.push(d.nome);
                         } else {
                             alert("Voc√™ j√° atingiu o limite de 3 desvantagens!");
                             return;
                         }
                     }
                    atualizarVantagensDesvantagensPanel();
                     document.getElementById("salvar-vantagens-btn").style.display = "block"; // Mostra o bot√£o salvar
                };

                desvantagensList.appendChild(div);
            });
            document.getElementById("ph-temp").textContent = calcularPontosVantagemTemp();
        }


        // ... (Fun√ß√µes removerVantagem, removerDesvantagem - Sem altera√ß√µes) ...
         function removerVantagem(v) {
            if (isFichaLocked && !isFichaUnlocked) return abrirModalSenha();
            if (confirm(`Voc√™ deseja remover a vantagem "${v}"? Isso requer permiss√£o do GM.`)) {
                document.getElementById("senha-gm-modal").style.display = "flex";
                document.getElementById("senha-gm-input").value = "";
                document.getElementById("confirmar-senha-gm-btn").onclick = () => {
                    if (document.getElementById("senha-gm-input").value === senhaMatriz) {
                        vantagensSelecionadas = vantagensSelecionadas.filter(t => t !== v);
                        // Remove da exibi√ß√£o na ficha
                         const itemToRemove = Array.from(vantagensListDisplay.children).find(div => div.textContent === v);
                         if (itemToRemove) itemToRemove.remove();

                        pontosVantagemSpan.textContent = getPontosVantagem();
                        salvarDados(); // Salva a lista atualizada
                        fecharModal("senha-gm-modal");
                        calcularAtributos();
                     } else {
                        alert("Senha do GM incorreta!");
                        fecharModal("senha-gm-modal");
                    }
                };
             }
        }

        function removerDesvantagem(d) {
            if (isFichaLocked && !isFichaUnlocked) return abrirModalSenha();
            if (confirm(`Voc√™ deseja remover a desvantagem "${d}"? Isso requer permiss√£o do GM.`)) {
                document.getElementById("senha-gm-modal").style.display = "flex";
                document.getElementById("senha-gm-input").value = "";
                document.getElementById("confirmar-senha-gm-btn").onclick = () => {
                    if (document.getElementById("senha-gm-input").value === senhaMatriz) {
                        desvantagensSelecionadas = desvantagensSelecionadas.filter(t => t !== d);
                         // Remove da exibi√ß√£o na ficha
                         const itemToRemove = Array.from(desvantagensListDisplay.children).find(div => div.textContent === d);
                         if (itemToRemove) itemToRemove.remove();

                        pontosVantagemSpan.textContent = getPontosVantagem();
                        salvarDados(); // Salva a lista atualizada
                        fecharModal("senha-gm-modal");
                        calcularAtributos();
                     } else {
                        alert("Senha do GM incorreta!");
                        fecharModal("senha-gm-modal");
                    }
                };
             }
        }


        // ... (Fun√ß√£o calcularPesoTotal e listener - Sem altera√ß√µes) ...
        function calcularPesoTotal() {
            pesoTotalSpan.textContent = Array.from(inventarioSlots.querySelectorAll(".inventory-weight")).reduce((total, weight) => total + (parseFloat(weight.value) || 0), 0).toFixed(1);
         }
        inventarioSlots.addEventListener("input", calcularPesoTotal);


        // ... (Anota√ß√µes: Abrir/fechar, salvar - Sem altera√ß√µes) ...
        anotacoesBtn.onclick = () => {
            anotacoesTextarea.style.display = anotacoesTextarea.style.display === "block" ? "none" : "block";
             if (anotacoesTextarea.style.display === 'block') {
                 anotacoesTextarea.focus(); // Foca no textarea ao abrir
             }
        };

        document.addEventListener('click', function(event) {
            if (anotacoesTextarea.style.display === "block" && !anotacoesTextarea.contains(event.target) && !anotacoesBtn.contains(event.target))
                anotacoesTextarea.style.display = 'none';
        });
        anotacoesTextarea.oninput = salvarDados;


        // ... (Adicionar Magia - Sem altera√ß√µes) ...
        adicionarMagiaBtn.onclick = () => {
            if (magiasList.children.length < 20) {
                const input = document.createElement("input");
                input.type = "text";
                input.className = "magia-nome";
                input.placeholder = `Magia/Habilidade ${magiasList.children.length+1}`;
                magiasList.appendChild(input);
                 // Adiciona listener para salvar quando este novo input for alterado
                 input.addEventListener('input', () => { if (!isFichaLocked || isFichaUnlocked) salvarDados(); });
                 input.addEventListener('beforeinput', verificarAlteracao);
                 input.addEventListener('focus', (event) => {
                    if (!previousValues.has(event.target)) {
                        previousValues.set(event.target, event.target.value);
                    }
                 });
                salvarDados(); // Salva a adi√ß√£o do campo vazio
             } else alert("Voc√™ atingiu o limite de 20 magias/habilidades!");
        };

        // ... (Ra√ßas: Abrir painel - Sem altera√ß√µes) ...
        racasBtn.onclick = () => {
            if (isFichaLocked && !isFichaUnlocked) return abrirModalSenha();
            tempRacaSelecionada = racaSelecionada;
            atualizarRacasPanel();
            racasPanel.style.display = "block";
            document.getElementById("salvar-racas-btn").style.display = "none"; // Esconde o bot√£o salvar inicialmente
        };

        // ... (Ra√ßas: Fechar painel - Sem altera√ß√µes) ...
        fecharRacasBtn.onclick = () => {
            racasPanel.style.display = "none";
        };

        // MODIFICA√á√ÉO: L√≥gica de salvar Ra√ßas movida para c√°
        salvarRacasBtn.onclick = () => {
            // Verifica se uma ra√ßa foi selecionada temporariamente E √© diferente da permanente
             if (tempRacaSelecionada && tempRacaSelecionada !== racaSelecionada) {
                 const raca = racasData.find(r => r.nome === tempRacaSelecionada);
                 if (raca) {
                     // Verifica se tem PH suficiente para a NOVA ra√ßa selecionada
                     // Calcula PH *sem* a ra√ßa antiga e *com* a nova
                     let phNecessario = raca.custo;
                     let phAtualSemRaca = getPontosVantagem(); // PH com a ra√ßa atual (se houver)
                     const racaAntiga = racasData.find(r => r.nome === racaSelecionada);
                     if(racaAntiga) {
                         phAtualSemRaca += racaAntiga.custo; // Adiciona de volta o custo da ra√ßa antiga
                     }

                     if (phAtualSemRaca >= phNecessario) {
                         // Abre modal de confirma√ß√£o espec√≠fico para ra√ßas
                         document.getElementById("salvar-vantagens-modal").style.display = "flex"; // Reutilizando o modal por enquanto
                         // MODIFICA√á√ÉO: Redireciona a confirma√ß√£o para salvar a RA√áA
                         document.getElementById("confirmar-salvar-vantagens-btn").onclick = confirmarSalvarRaca;
                     } else {
                         alert("Pontos de Vantagem insuficientes para selecionar esta ra√ßa!");
                     }
                 }
             } else if (!tempRacaSelecionada && racaSelecionada) {
                  // Caso o usu√°rio esteja tentando REMOVER a ra√ßa (desmarcou)
                  alert("Para remover uma ra√ßa j√° salva, use as op√ß√µes na ficha principal (requer permiss√£o do GM).");
             } else {
                  // Nenhuma mudan√ßa na ra√ßa (ou nenhuma ra√ßa selecionada)
                  racasPanel.style.display = "none"; // Apenas fecha o painel
             }
        };

        // MODIFICA√á√ÉO: Nova fun√ß√£o para confirmar o salvamento da Ra√ßa
        function confirmarSalvarRaca() {
             if (tempRacaSelecionada && tempRacaSelecionada !== racaSelecionada) {
                 const raca = racasData.find(r => r.nome === tempRacaSelecionada);
                 if (raca) {
                      // Calcula PH novamente para garantir
                     let phNecessario = raca.custo;
                     let phAtualSemRaca = getPontosVantagem();
                     const racaAntiga = racasData.find(r => r.nome === racaSelecionada);
                     if(racaAntiga) {
                         phAtualSemRaca += racaAntiga.custo;
                     }

                     if (phAtualSemRaca >= phNecessario) {
                         racaSelecionada = tempRacaSelecionada;
                         racaNomeSpan.textContent = racaSelecionada.split(" (")[0];
                         racaDescricaoInput.value = raca.vantagens.join("\n\n");
                         pontosVantagemSpan.textContent = getPontosVantagem(); // Recalcula PH final
                         salvarDados(); // Salva no Firebase
                         calcularAtributos(); // Recalcula atributos

                         // MODIFICA√á√ÉO: Fecha o painel de ra√ßas e o modal de confirma√ß√£o
                         racasPanel.style.display = "none";
                         fecharModal("salvar-vantagens-modal");

                          // MODIFICA√á√ÉO: Restaura o onclick do bot√£o de confirma√ß√£o para Vantagens/Desvantagens
                         document.getElementById("confirmar-salvar-vantagens-btn").onclick = confirmarSalvarVantagensDesvantagens; // Assume que essa fun√ß√£o existe ou ser√° criada

                     } else {
                          // Seguran√ßa extra caso PH mude entre cliques
                          alert("Erro: Pontos de Vantagem insuficientes!");
                          fecharModal("salvar-vantagens-modal");
                          // Restaura o onclick
                          document.getElementById("confirmar-salvar-vantagens-btn").onclick = confirmarSalvarVantagensDesvantagens;
                     }
                 }
             }
        }

         // MODIFICA√á√ÉO: Renomeia a fun√ß√£o original de confirma√ß√£o para clareza
         const confirmarSalvarVantagensDesvantagens = document.getElementById("confirmar-salvar-vantagens-btn").onclick;


        // ... (Fun√ß√£o atualizarRacasPanel - Adiciona verifica√ß√£o para mostrar bot√£o salvar) ...
        function atualizarRacasPanel() {
            racasList.innerHTML = "";
            racasData.forEach(r => {
                const div = document.createElement("div");
                div.className = "raca-item";
                div.innerHTML = `<h3>${r.nome}</h3><p>${r.descricao}</p><p><strong>Vantagens:</strong></p><ul>${r.vantagens.map(v => `<li>${v}</li>`).join("")}</ul>`;

                if (tempRacaSelecionada === r.nome) div.classList.add("comprada");

                div.onclick = () => {
                     // Se j√° existe uma ra√ßa salva permanentemente, n√£o permite sele√ß√£o aqui
                     if (racaSelecionada && racaSelecionada !== r.nome) {
                          alert("Voc√™ j√° selecionou uma ra√ßa. Para alterar, use as op√ß√µes na ficha principal (requer permiss√£o do GM).");
                          return;
                      }
                      // Se est√° clicando na ra√ßa j√° salva, permite desmarcar temporariamente (mas n√£o salva remo√ß√£o aqui)
                      if (racaSelecionada && racaSelecionada === r.nome) {
                          if (tempRacaSelecionada === r.nome) {
                              tempRacaSelecionada = null; // Desmarca temporariamente
                          } else {
                              // N√£o deveria acontecer se a l√≥gica acima estiver correta, mas por seguran√ßa
                              tempRacaSelecionada = r.nome;
                          }
                      }
                      // Se nenhuma ra√ßa salva permanentemente
                      else if (!racaSelecionada) {
                          if (tempRacaSelecionada === r.nome) {
                              tempRacaSelecionada = null; // Desmarca temporariamente
                          } else {
                               // Verifica PH ANTES de marcar temporariamente
                               let phNecessario = r.custo;
                               let phAtualTemp = calcularPontosVantagemTemp(); // Usa PH tempor√°rio
                               if (tempRacaSelecionada) { // Se j√° tinha outra ra√ßa tempor√°ria, devolve o custo dela
                                    const racaTempAntiga = racasData.find(rt => rt.nome === tempRacaSelecionada);
                                    if(racaTempAntiga) phAtualTemp += racaTempAntiga.custo;
                               }

                               if(phAtualTemp >= phNecessario) {
                                    tempRacaSelecionada = r.nome; // Marca temporariamente
                               } else {
                                   alert("Pontos de Vantagem insuficientes para selecionar esta ra√ßa!");
                                   return; // N√£o marca
                               }
                          }
                      }

                    atualizarRacasPanel(); // Re-renderiza para mostrar sele√ß√£o/desmarca√ß√£o
                    // MODIFICA√á√ÉO: Mostra o bot√£o salvar APENAS se a sele√ß√£o tempor√°ria for diferente da permanente
                     if(tempRacaSelecionada !== racaSelecionada) {
                         document.getElementById("salvar-racas-btn").style.display = "block";
                     } else {
                         document.getElementById("salvar-racas-btn").style.display = "none";
                     }
                 };
                racasList.appendChild(div);
            });
        }


        // ... (Fun√ß√µes abrirModalRaca, excluirRacaSelecionadaModal, editarRacaSelecionadaModal, salvarEdicaoRaca - Sem altera√ß√µes) ...
         function abrirModalRaca() {
            // S√≥ mostra op√ß√µes se uma ra√ßa estiver selecionada
             if (racaSelecionada) {
                 document.getElementById("raca-opcoes-modal").style.display = "flex";
             } else {
                 alert("Nenhuma ra√ßa selecionada para editar ou excluir.");
             }
        }

        function excluirRacaSelecionadaModal() {
            fecharModal('raca-opcoes-modal');
            if (isFichaLocked && !isFichaUnlocked) return abrirModalSenha();
            if (confirm("Tem certeza que deseja excluir a ra√ßa selecionada? Isso requer permiss√£o do GM.")) {
                document.getElementById("senha-gm-modal").style.display = "flex";
                document.getElementById("senha-gm-input").value = "";
                document.getElementById("confirmar-senha-gm-btn").onclick = () => {
                    if (document.getElementById("senha-gm-input").value === senhaMatriz) {
                        // Devolve os pontos da ra√ßa
                         const racaRemovida = racasData.find(r => r.nome === racaSelecionada);
                         // A atualiza√ß√£o de pontos acontece automaticamente ao recalcular getPontosVantagem()

                        racaSelecionada = null;
                        racaNomeSpan.textContent = "";
                        racaDescricaoInput.value = "";
                        pontosVantagemSpan.textContent = getPontosVantagem(); // Atualiza PH exibido
                        salvarDados(); // Salva a remo√ß√£o no Firebase
                        fecharModal("senha-gm-modal");
                     } else {
                        alert("Senha do GM incorreta!");
                        fecharModal("senha-gm-modal");
                    }
                };
             }
        }


        function editarRacaSelecionadaModal() {
            if (isFichaLocked && !isFichaUnlocked) return abrirModalSenha();
            fecharModal('raca-opcoes-modal');
            document.getElementById("editar-raca-modal").style.display = "flex";
            document.getElementById("editar-raca-nome").value = racaNomeSpan.textContent;
            document.getElementById("editar-raca-descricao").value = racaDescricaoInput.value;
         }

        function salvarEdicaoRaca() {
            if (isFichaLocked && !isFichaUnlocked) return abrirModalSenha();
             // Edi√ß√£o n√£o requer permiss√£o do GM por enquanto, apenas desbloqueio da ficha
             //if (confirm("Tem certeza que deseja editar a ra√ßa selecionada?")) {
                 // document.getElementById("senha-gm-modal").style.display = "flex";
                 // document.getElementById("senha-gm-input").value = "";
                 // document.getElementById("confirmar-senha-gm-btn").onclick = () => {
                 //     if (document.getElementById("senha-gm-input").value === senhaMatriz) {
                         racaNomeSpan.textContent = document.getElementById("editar-raca-nome").value;
                         racaDescricaoInput.value = document.getElementById("editar-raca-descricao").value;
                         fecharModal('editar-raca-modal');
                         salvarDados(); // Salva as edi√ß√µes
                         //fecharModal("senha-gm-modal");
                 //     } else {
                 //         alert("Senha do GM incorreta!");
                 //         fecharModal("senha-gm-modal");
                 //     }
                 // };
             //}
        }


        // ... (Classes: Abrir/fechar painel - Sem altera√ß√µes) ...
        classesBtn.onclick = () => {
            classesPanel.style.display = "block";
         };

        fecharClassesBtn.onclick = () => {
            classesPanel.style.display = "none";
         };


        // ... (Dark Mode: Bot√µes lua/sol - Sem altera√ß√µes) ...
        luaBtn.onclick = () => {
            document.body.classList.add("dark-mode");
            // Salvar prefer√™ncia de modo escuro se desejar (ex: localStorage.setItem('darkMode', 'true'))
        };
        solBtn.onclick = () => {
            document.body.classList.remove("dark-mode");
             // Salvar prefer√™ncia de modo escuro se desejar (ex: localStorage.setItem('darkMode', 'false'))
        };

        // ... (Atribui√ß√£o dos bot√µes reset/recome√ßar - Sem altera√ß√µes) ...
        resetPontosButton.onclick = resetarPontos;
        recomecarButton.onclick = recomecarFicha;

        // ... (Fun√ß√£o showNotification - Sem altera√ß√µes) ...
        function showNotification(message, type) {
            notification.textContent = message;
            notification.className = type; // Adiciona a classe para estiliza√ß√£o (ex: critical-failure)
            notification.style.display = "block";
            setTimeout(() => {
                notification.style.display = "none";
                notification.className = ""; // Remove a classe ap√≥s o tempo
            }, 3000); // Aumentado para 3 segundos
         }


        // ... (Hist√≥rico de Dados: Abrir/fechar, carregar, excluir - Sem altera√ß√µes) ...
         // -- Hist√≥rico de Dados --
         const historicoDadosBtn = document.getElementById("historico-dados-btn");
         const historicoDadosPanel = document.getElementById("historico-dados-panel");
         const historicoLista = document.getElementById("historico-lista");
         const excluirHistoricoBtn = document.getElementById("excluir-historico-btn");

        historicoDadosBtn.onclick = () => {
            historicoDadosPanel.style.display = historicoDadosPanel.style.display === "block" ? "none" : "block";
        };

         // Fechar painel se clicar fora
        document.addEventListener('click', function(event) {
            if (historicoDadosPanel.style.display === "block" && !historicoDadosPanel.contains(event.target) && !historicoDadosBtn.contains(event.target)) {
                historicoDadosPanel.style.display = "none";
            }
        });

        // Carregar hist√≥rico do Firebase
        database.ref('dadosRolados').orderByChild('timestamp').limitToLast(50).on('value', snapshot => { // Ordena por timestamp, limita aos √∫ltimos 50
            historicoLista.innerHTML = ""; // Limpa a lista
            if (snapshot.exists()) {
                 const dadosArray = [];
                 snapshot.forEach(childSnapshot => {
                     dadosArray.push(childSnapshot.val()); // Adiciona cada resultado a um array
                 });
                 // Inverte o array para mostrar os mais recentes primeiro
                 dadosArray.reverse().forEach(dado => {
                    const div = document.createElement("div");
                     const dataHora = dado.timestamp ? new Date(dado.timestamp).toLocaleString('pt-BR') : ''; // Formata data/hora
                     div.textContent = `[${dataHora}] ${dado.nomeFicha} rolou: ${dado.resultado}`;
                     if (dado.resultado === 1) div.style.color = 'red';
                     if (dado.resultado === 20) div.style.color = 'green';
                     historicoLista.appendChild(div);
                 });
             } else {
                 historicoLista.textContent = "Nenhum dado rolado ainda.";
             }
        });


        excluirHistoricoBtn.onclick = () => {
            if (isFichaLocked && !isFichaUnlocked) return abrirModalSenha();
             if (confirm("Tem certeza que deseja excluir TODO o hist√≥rico de dados? Isso requer permiss√£o do GM.")) {
                 document.getElementById("senha-gm-modal").style.display = "flex";
                 document.getElementById("senha-gm-input").value = "";
                 document.getElementById("confirmar-senha-gm-btn").onclick = () => {
                     if (document.getElementById("senha-gm-input").value === senhaMatriz) {
                         database.ref('dadosRolados').remove().then(() => {
                             alert("Hist√≥rico de dados exclu√≠do com sucesso!");
                             fecharModal("senha-gm-modal");
                             historicoLista.innerHTML = "Hist√≥rico exclu√≠do."; // Atualiza a exibi√ß√£o
                         }).catch(error => {
                             alert("Erro ao excluir hist√≥rico.");
                             console.error("Erro ao excluir hist√≥rico:", error);
                              fecharModal("senha-gm-modal");
                         });
                      } else {
                         alert("Senha do GM incorreta!");
                         fecharModal("senha-gm-modal");
                     }
                 };
              }
        };


        // ... (Funcionalidade do Chat Completa - Sem altera√ß√µes) ...
         // -- Funcionalidade do Chat --
        chatBtn.onclick = () => {
            if (!chatPassword) {
                // Se n√£o h√° senha definida para esta ficha, abre modal para definir
                document.getElementById("chat-password-modal").style.display = "flex";
                document.getElementById("chat-senha-input").value = "";
                document.getElementById("chat-confirmar-senha-input").value = "";
                document.getElementById("chat-senha-input").focus();
             } else {
                 // Se j√° tem senha, abre modal para digitar a senha e entrar
                 document.getElementById("open-chat-modal").style.display = "flex";
                 document.getElementById("abrir-chat-senha-input").value = "";
                 document.getElementById("abrir-chat-senha-input").focus();
             }
        };

        function definirSenhaChat() {
            const senha = document.getElementById("chat-senha-input").value;
            const confirmarSenha = document.getElementById("chat-confirmar-senha-input").value;
            if (senha !== confirmarSenha) {
                alert("As senhas n√£o coincidem.");
                return;
            }
            if (senha.length < 4) {
                alert("A senha deve ter pelo menos 4 caracteres.");
                return;
            }
            chatPassword = senha; // Atualiza a vari√°vel local
            // Salva a senha no Firebase para esta ficha
            database.ref(`fichas/${currentFichaId}`).update({ chatPassword: senha }).then(() => {
                fecharModal("chat-password-modal");
                alert("Senha do chat definida!");
                atualizarEstadoChatBotao(); // Atualiza o texto do bot√£o de chat
            }).catch(error => {
                 console.error("Erro ao definir senha do chat:", error);
                 alert("Erro ao definir senha do chat.");
             });
         }

        function abrirChat() {
            const senhaDigitada = document.getElementById("abrir-chat-senha-input").value;
            if (senhaDigitada === chatPassword) {
                fecharModal("open-chat-modal");
                document.getElementById("chat-modal").style.display = "flex";
                isChatOpen = true; // Marca que o chat est√° aberto
                selectedChatUser = null; // Reseta usu√°rio selecionado
                conversationAreaDiv.innerHTML = ""; // Limpa √°rea de conversa
                atualizarListaFichasChat(); // Garante que a lista de usu√°rios est√° atualizada
                marcarMensagensComoLidas(); // Marca mensagens como lidas ao abrir
                chatBtn.dataset.unread = 0; // Zera o contador visual
             } else {
                alert("Senha do chat incorreta.");
             }
        }

         // Fun√ß√£o para fechar o modal do chat
         function fecharChatModal() {
             fecharModal('chat-modal');
             isChatOpen = false; // Marca que o chat foi fechado
             verificarNovasMensagens(); // Reativa a verifica√ß√£o de novas mensagens n√£o lidas
         }
          // Adiciona o handler ao bot√£o de fechar do chat modal
         const fecharChatBtn = document.querySelector('#chat-modal .cancel-btn');
         if (fecharChatBtn) {
             fecharChatBtn.onclick = fecharChatModal;
         }


        function atualizarEstadoChatBotao() {
            if (chatPassword) {
                chatBtn.textContent = "üí¨ Chat"; // Texto padr√£o se a senha est√° definida
             } else {
                chatBtn.textContent = "üí¨ Definir Chat"; // Texto para indicar que precisa definir senha
             }
        }

        function atualizarListaFichasChat() {
            availableFichasDiv.innerHTML = "";
            for (const fichaId in fichas) {
                // Lista todas as fichas exceto a matriz e a pr√≥pria ficha atual
                if (fichaId !== "ficha-matriz" && fichaId !== currentFichaId) {
                    const ficha = fichas[fichaId];
                    // S√≥ lista fichas que TEM uma senha de chat definida (implica que podem usar o chat)
                     if(ficha.chatPassword) {
                         const userDiv = document.createElement("div");
                         userDiv.className = "user-item";
                         userDiv.textContent = ficha.nomeFicha || "Sem Nome";
                         userDiv.dataset.fichaId = fichaId;
                         // Adiciona indicador de mensagens n√£o lidas (opcional)
                         // userDiv.dataset.unreadCount = 0; // Inicializa contador
                         userDiv.onclick = () => iniciarConversa(fichaId, ficha.nomeFicha || "Sem Nome");
                         availableFichasDiv.appendChild(userDiv);
                     }
                 }
            }
             // Atualizar contadores de n√£o lidas na lista de usu√°rios (implementa√ß√£o futura se necess√°rio)
             // atualizarContadoresNaoLidasLista();
        }


        function iniciarConversa(otherFichaId, otherFichaNome) {
            selectedChatUser = otherFichaId;
            // Limpa a √°rea de conversa e adiciona cabe√ßalho
            conversationAreaDiv.innerHTML = `<div class="chat-header">Conversa com ${otherFichaNome}</div><div id="mensagens-${getChatId(currentFichaId, otherFichaId)}" class="mensagens-area"></div>`;
            // Remove destaque de usu√°rio anterior, destaca o novo
             Array.from(availableFichasDiv.children).forEach(div => {
                 div.style.fontWeight = div.dataset.fichaId === otherFichaId ? 'bold' : 'normal';
                 div.style.backgroundColor = div.dataset.fichaId === otherFichaId ? '#e0e0e0' : 'transparent'; // Adapte cores para dark mode
             });
            carregarMensagens(otherFichaId);
             marcarMensagensComoLidas(otherFichaId); // Marca mensagens desta conversa como lidas
        }


        function enviarMensagem() {
            if (!selectedChatUser) {
                alert("Selecione uma ficha para enviar a mensagem.");
                return;
            }
            const mensagem = mensagemInput.value.trim();
            if (mensagem) {
                 const chatId = getChatId(currentFichaId, selectedChatUser);
                 const chatRef = database.ref('mensagens').child(chatId).push();
                 chatRef.set({
                    senderId: currentFichaId,
                    senderName: fichas[currentFichaId]?.nomeFicha || "Eu", // Adiciona nome do remetente
                    receiverId: selectedChatUser,
                    content: mensagem,
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    readByReceiver: false // Adiciona status de leitura
                });
                mensagemInput.value = ""; // Limpa o input
                 // O listener 'carregarMensagens' vai adicionar a mensagem enviada √† tela
             }
        }

         // Vari√°vel para armazenar listeners ativos e evitar duplica√ß√£o
         let activeChatListeners = {};

        function carregarMensagens(otherFichaId) {
             const chatId = getChatId(currentFichaId, otherFichaId);
             const mensagensDivId = `mensagens-${chatId}`;
             const mensagensDiv = document.getElementById(mensagensDivId);

             if (!mensagensDiv) {
                 console.error("Elemento de mensagens n√£o encontrado:", mensagensDivId);
                 return;
             }

             // Remove listener antigo para esta conversa, se existir
             if (activeChatListeners[chatId]) {
                  database.ref('mensagens').child(chatId).off('child_added', activeChatListeners[chatId]);
                  delete activeChatListeners[chatId];
                  console.log("Listener removido para:", chatId);
             }


             // Adiciona novo listener
             const listener = database.ref('mensagens').child(chatId).orderByChild('timestamp').on('child_added', snapshot => {
                const mensagemData = snapshot.val();
                 if (!mensagemData) return; // Ignora se data for null

                 const messageContainer = document.createElement("div");
                messageContainer.className = "message-container";

                 // Adiciona Nome do Remetente (opcional, pode poluir)
                 // const senderNameDiv = document.createElement("div");
                 // senderNameDiv.className = "sender-name";
                 // senderNameDiv.textContent = mensagemData.senderName || (mensagemData.senderId === currentFichaId ? 'Eu' : 'Outro');
                 // messageContainer.appendChild(senderNameDiv);

                 const mensagemDiv = document.createElement("div");
                 // Adiciona classe 'sent' ou 'received'
                mensagemDiv.className = `message ${mensagemData.senderId === currentFichaId ? 'sent' : 'received'}`;
                mensagemDiv.textContent = mensagemData.content;

                 messageContainer.appendChild(mensagemDiv);

                 // Verifica se o elemento de mensagens ainda existe antes de adicionar
                 const currentMensagensDiv = document.getElementById(mensagensDivId);
                 if(currentMensagensDiv) {
                    currentMensagensDiv.appendChild(messageContainer);
                    // Auto-scroll para a √∫ltima mensagem
                    currentMensagensDiv.scrollTop = currentMensagensDiv.scrollHeight;

                    // Marca como lida se recebida e chat/conversa aberta
                     if (mensagemData.receiverId === currentFichaId && mensagemData.senderId === selectedChatUser && !mensagemData.readByReceiver) {
                         database.ref('mensagens').child(chatId).child(snapshot.key).update({ readByReceiver: true });
                     }

                 } else {
                     console.warn("Tentativa de adicionar mensagem a um elemento que n√£o existe mais:", mensagensDivId);
                     // Remove o listener se o elemento sumiu
                      database.ref('mensagens').child(chatId).off('child_added', listener);
                      delete activeChatListeners[chatId];
                 }

             });

             // Armazena o listener ativo
             activeChatListeners[chatId] = listener;
              console.log("Listener adicionado para:", chatId);

         }


        function getChatId(id1, id2) {
            // Cria um ID √∫nico e consistente para a conversa entre dois usu√°rios
            return id1 < id2 ? `${id1}_${id2}` : `${id2}_${id1}`;
        }

        // Vari√°vel para debounce da notifica√ß√£o sonora
         let soundTimeout = null;

        function verificarNovasMensagens() {
            if (!currentFichaId || !database) return; // Sai se n√£o estiver pronto

             // Listener para todas as mensagens (otimizar se necess√°rio)
             database.ref('mensagens').on('value', (snapshot) => {
                if (!snapshot.exists()) {
                     chatBtn.dataset.unread = 0;
                     return;
                 };

                 let unreadCountTotal = 0;
                 let playSound = false;

                 snapshot.forEach((chat) => {
                    const chatId = chat.key;
                     // Verifica apenas chats que incluem a ficha atual
                     if (chatId.includes(currentFichaId)) {
                         chat.forEach((mensagemSnapshot) => {
                            const mensagem = mensagemSnapshot.val();
                             // Conta mensagens recebidas, n√£o enviadas pela ficha atual, e n√£o lidas
                             if (mensagem.receiverId === currentFichaId &&
                                 mensagem.senderId !== currentFichaId &&
                                 !mensagem.readByReceiver)
                             {
                                 unreadCountTotal++;
                                 // Verifica se o chat espec√≠fico est√° fechado ou se √© de outro usu√°rio
                                 if (!isChatOpen || (isChatOpen && mensagem.senderId !== selectedChatUser)) {
                                      playSound = true; // Indica que um som deve ser tocado
                                  }
                             }
                        });
                    }
                });

                 // Atualiza o contador visual no bot√£o do chat
                 chatBtn.dataset.unread = unreadCountTotal > 0 ? unreadCountTotal : 0;
                 chatBtn.style.animation = unreadCountTotal > 0 ? 'pulsar-aura 1.5s infinite' : 'none'; // Efeito visual


                 // Toca o som apenas uma vez por verifica√ß√£o se houver novas mensagens n√£o lidas
                  // e o chat geral estiver fechado ou a conversa espec√≠fica n√£o estiver ativa
                 if (playSound) {
                      // Debounce para evitar m√∫ltiplos sons muito pr√≥ximos
                     clearTimeout(soundTimeout);
                     soundTimeout = setTimeout(() => {
                         newMessageSound.play().catch(e => console.warn("Erro ao tocar som:", e)); // Toca o som
                     }, 300); // Atraso de 300ms
                 }
            });
        }

         // Marca mensagens como lidas (quando abre o chat ou a conversa)
         function marcarMensagensComoLidas(otherUserId = null) {
             if (!currentFichaId) return;

             database.ref('mensagens').once('value', snapshot => {
                 if (!snapshot.exists()) return;

                 snapshot.forEach(chat => {
                     const chatId = chat.key;
                     if (chatId.includes(currentFichaId)) {
                          // Se otherUserId √© fornecido, marca s√≥ dessa conversa
                          // Se n√£o, marca todas as recebidas (quando abre o chat geral)
                         const targetSender = otherUserId ? otherUserId : null;

                         chat.forEach(msgSnapshot => {
                             const msg = msgSnapshot.val();
                             const msgKey = msgSnapshot.key;
                              // Marca como lida se:
                              // 1. Foi recebida pela ficha atual
                              // 2. N√£o foi lida ainda
                              // 3. (Opcional) √â do sender espec√≠fico OU nenhum sender espec√≠fico foi dado
                             if (msg.receiverId === currentFichaId && !msg.readByReceiver &&
                                 (!targetSender || msg.senderId === targetSender))
                             {
                                 database.ref('mensagens').child(chatId).child(msgKey).update({ readByReceiver: true });
                             }
                         });
                     }
                 });
             });
         }


        // --- MODIFICA√á√ïES PARA PLANO DE FUNDO com localStorage ---

        planoFundoBtn.onclick = () => {
            // Pr√©-popula os inputs com os valores atuais do localStorage ou defaults
            const storedSize = localStorage.getItem('fichaBackgroundSize') || 'cover';
            const storedColor = localStorage.getItem('fichaBackgroundColor') || '#d2b48c'; // Default pergaminho

            backgroundColorInput.value = storedColor;
            document.querySelectorAll('input[name="background-size"]').forEach(radio => {
                radio.checked = radio.value === storedSize;
            });
            backgroundImageInput.value = null; // Limpa sele√ß√£o de arquivo anterior

            backgroundModal.style.display = "flex";
        };

        // MODIFICA√á√ÉO: Fun√ß√£o para salvar a IMAGEM e TIPO de preenchimento
        function salvarImagemFundo() {
            const file = backgroundImageInput.files[0];
            const selectedSize = document.querySelector('input[name="background-size"]:checked').value;

            if (file) {
                const reader = new FileReader();
                reader.onload = e => {
                    const imageUrl = e.target.result; // Base64 Data URL

                    // Salva no localStorage
                    localStorage.setItem('fichaBackgroundImage', imageUrl);
                    localStorage.setItem('fichaBackgroundSize', selectedSize);
                    localStorage.removeItem('fichaBackgroundColor'); // Imagem tem prioridade

                    // Aplica imediatamente
                    document.body.style.backgroundImage = `url('${imageUrl}')`;
                    document.body.style.backgroundSize = selectedSize;
                    document.body.style.backgroundColor = ''; // Remove cor s√≥lida

                    showNotification("Imagem de fundo salva!", "save-success");
                    fecharModal('background-modal');
                };
                reader.onerror = () => {
                     alert("Erro ao ler o arquivo da imagem.");
                 };
                reader.readAsDataURL(file);
             } else if (localStorage.getItem('fichaBackgroundImage')) {
                 // Se n√£o selecionou novo arquivo, mas j√° existe imagem, salva apenas o SIZE
                 localStorage.setItem('fichaBackgroundSize', selectedSize);
                 document.body.style.backgroundSize = selectedSize; // Aplica size
                 showNotification("Tipo de preenchimento da imagem salvo!", "save-success");
                 fecharModal('background-modal');
             }
              else {
                alert("Nenhuma imagem selecionada para salvar.");
            }
        }

        // MODIFICA√á√ÉO: Fun√ß√£o para salvar a COR S√ìLIDA
        function salvarCorFundo() {
            const color = backgroundColorInput.value;

            if (color) {
                 // Salva no localStorage
                localStorage.setItem('fichaBackgroundColor', color);
                localStorage.removeItem('fichaBackgroundImage'); // Cor tem prioridade sobre imagem antiga
                localStorage.removeItem('fichaBackgroundSize'); // Size n√£o se aplica a cor

                 // Aplica imediatamente
                document.body.style.backgroundColor = color;
                document.body.style.backgroundImage = 'none'; // Remove imagem

                showNotification("Cor de fundo salva!", "save-success");
                fecharModal('background-modal');
            } else {
                 // Teoricamente, o input color sempre tem um valor, mas por seguran√ßa
                 alert("Nenhuma cor selecionada.");
             }
        }


        // MODIFICA√á√ÉO: Fun√ß√£o para REMOVER imagem/cor e voltar ao padr√£o
        function excluirPlanoDeFundo() {
            if (confirm("Tem certeza que deseja remover o plano de fundo personalizado e voltar ao padr√£o?")) {
                 // Limpa localStorage
                localStorage.removeItem('fichaBackgroundImage');
                localStorage.removeItem('fichaBackgroundColor');
                localStorage.removeItem('fichaBackgroundSize');

                 // Aplica estilo padr√£o (cor pergaminho)
                document.body.style.backgroundImage = 'none';
                document.body.style.backgroundColor = '#d2b48c'; // Cor padr√£o definida no CSS
                document.body.style.backgroundSize = 'cover'; // Reset size

                showNotification("Plano de fundo removido.", "normal-result"); // Usando normal-result para feedback
                fecharModal('background-modal');
            }
        }

        // MODIFICA√á√ÉO: Fun√ß√£o para aplicar o fundo do localStorage ao carregar a p√°gina
        function aplicarPlanoDeFundoInicial() {
            console.log("Aplicando plano de fundo inicial do localStorage...");
            const storedImage = localStorage.getItem('fichaBackgroundImage');
            const storedColor = localStorage.getItem('fichaBackgroundColor');
            const storedSize = localStorage.getItem('fichaBackgroundSize') || 'cover'; // Default 'cover'

            if (storedImage) {
                console.log("Aplicando imagem:", storedSize);
                document.body.style.backgroundImage = `url('${storedImage}')`;
                document.body.style.backgroundSize = storedSize;
                document.body.style.backgroundColor = ''; // Garante que n√£o haja cor s√≥lida por baixo
            } else if (storedColor) {
                 console.log("Aplicando cor:", storedColor);
                document.body.style.backgroundColor = storedColor;
                document.body.style.backgroundImage = 'none';
            } else {
                 console.log("Nenhum fundo salvo, usando padr√£o.");
                 // Estilo padr√£o j√° definido no CSS, mas podemos garantir aqui se necess√°rio
                 document.body.style.backgroundColor = '#d2b48c';
                 document.body.style.backgroundImage = 'none';
                 document.body.style.backgroundSize = 'cover';
            }
        }

        // --- FIM DAS MODIFICA√á√ïES DE PLANO DE FUNDO ---

        // MODIFICA√á√ÉO: Chama a fun√ß√£o para aplicar o fundo inicial ANTES de carregar as fichas
        aplicarPlanoDeFundoInicial();
        carregarFichas(); // Carrega as fichas do Firebase

    </script>
</body>

</html>
