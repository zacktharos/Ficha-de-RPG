<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ficha de Personagem RPG</title>
    <link href="https://fonts.googleapis.com/css2?family=MedievalSharp&family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@tailwindcss/browser@4"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: #f5f5f5;
            color: #000;
            display: flex;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            background-image: url('medieval_background.jpg');
            background-size: cover;
            background-position: center;
            transition: background 0.3s, color 0.3s;
        }
        body.dark-mode {
            background: #121212;
            color: #e0e0e0;
        }
        #fichas-sidebar {
            width: 100%;
            height: 60px;
            background: #fff;
            padding: 10px 0;
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: flex-start;
            position: fixed;
            top: 0;
            left: 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            z-index: 1000;
            overflow-x: auto;
            opacity: 0; /* Coluna invisível */
        }
        .ficha-tab {
            width: 100px;
            height: 50px;
            background: #f0e6d2;
            border: 2px solid #b8860b;
            border-radius: 10px 10px 0 0;
            margin-right: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.2);
        }
        .ficha-tab:hover {
            background: #a0522d;
            transform: translateY(-5px);
        }
        .ficha-tab.active {
            background: #a0522d;
            transform: translateY(-5px);
        }
        .ficha-tab span {
            font-family: 'MedievalSharp', serif;
            color: #000;
            font-size: 0.9rem;
            text-align: center;
            max-width: 90px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        #add-ficha-btn {
            width: 100px;
            height: 50px;
            background: #f0e6d2;
            border: 2px solid #b8860b;
            border-radius: 10px 10px 0 0;
            margin-right: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: transform 0.2s ease;
            box-shadow: 0 0 10px #ffd700, 0 0 20px #ffd700;
            z-index: 1001;
        }
        #add-ficha-btn span {
            font-family: 'MedievalSharp', serif;
            color: #000;
            font-size: 0.9rem;
        }
        #add-ficha-btn:hover {
            background: #a0522d;
            transform: translateY(-5px);
        }
        #ficha-container {
            background: rgba(240,230,210,0.95);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.2);
            width: 95%;
            max-width: 1200px;
            margin: 80px auto 20px;
            border: 2px solid #b8860b;
            position: relative;
        }
        body.dark-mode #ficha-container {
            background: rgba(30,30,30,0.95);
            color: #e0e0e0;
        }
        /* Outros estilos mantidos, omitidos por brevidade */
    </style>
</head>
<body>
    <div id="fichas-sidebar">
        <div id="add-ficha-btn"><span>+ Fichas</span></div>
    </div>
    <div id="ficha-container">
        <h1 id="nome-personagem-titulo">Ficha de Personagem</h1>
        <div id="game-master-message">Você virou o Game Master</div>
        <div id="character-image-container" onclick="document.getElementById('character-image-input').click()">
            <img id="character-image" alt="Imagem do Personagem">
            <input type="file" id="character-image-input" accept="image/*" style="display:none">
        </div>
        <div id="ficha-content">
            <!-- HTML da ficha mantido, omitido por brevidade -->
        </div>
    </div>
    <!-- Outros elementos HTML mantidos, omitidos por brevidade -->
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBbbwbwPXv6gztkyP3TXK-DtooEI7FcClI",
            authDomain: "ficha-de-rpg-b9685.firebaseapp.com",
            databaseURL: "https://ficha-de-rpg-b9685-default-rtdb.firebaseio.com",
            projectId: "ficha-de-rpg-b9685",
            storageBucket: "ficha-de-rpg-b9685.firebasestorage.app",
            messagingSenderId: "528610398062",
            appId: "1:528610398062:web:8fdb9cfd5ded8167613b7f"
        };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        let fichas = {}, currentFichaId = null, isFichaLocked = false, fichaPassword = null, isFichaUnlocked = false, senhaMatriz = "1040",
            vantagensSelecionadas = [], desvantagensSelecionadas = [], tempVantagensSelecionadas = [], tempDesvantagensSelecionadas = [],
            racaSelecionada = null, tempRacaSelecionada = null, vidaTotal, vidaAtual, magiaTotal, magiaAtual, vigorTotal, vigorAtual,
            previousValues = new Map();

        const vantagensData = [
            {nome: "Maestria com Armas curtas (2)", custo: 2, descricao: "Adiciona +1 em ataque, +1 em acerto com armas curtas."},
            {nome: "Maestria com armas pesadas (2)", custo: 2, descricao: "Adiciona +2 em ataque com armas pesadas."},
            {nome: "Maestria com armas de longo alcance (2)", custo: 2, descricao: "Adiciona +2 em acerto com armas de longo alcance."},
            // Outras vantagens mantidas, omitidas por brevidade
        ];
        const desvantagensData = [
            // Desvantagens mantidas, omitidas por brevidade
        ];
        const racasData = [
            // Raças mantidas, omitidas por brevidade
        ];
        const nivelData = [
            {nivel: 0, xp: 0, pd: 25, ph: 8}, // Alterado para ph: 8
            {nivel: 1, xp: 10, pd: 31, ph: 6},
            // Outros níveis mantidos, omitidos por brevidade
        ];

        function criarFichaMatriz() {
            const fichaId = "ficha-matriz";
            const fichaMatriz = {
                nomeFicha: "Matriz",
                nomePersonagem: "Personagem Matriz",
                // Outros campos mantidos, omitidos por brevidade
            };
            database.ref("fichas/ficha-matriz").once("value", snapshot => {
                if (snapshot.exists()) {
                    currentFichaId = fichaId;
                    carregarFicha(fichaId);
                    carregarFichas();
                } else {
                    database.ref(`fichas/${fichaId}`).set(fichaMatriz).then(() => {
                        currentFichaId = fichaId;
                        carregarFicha(fichaId);
                    });
                }
            });
        }

        function carregarFichas() {
            database.ref("fichas").on("value", snapshot => {
                fichas = snapshot.val() || {};
                if (fichas["ficha-matriz"]) {
                    atualizarAbasFichas();
                } else {
                    criarFichaMatriz();
                }
            });
        }

        function atualizarAbasFichas() {
            const sidebar = document.getElementById("fichas-sidebar");
            const addBtn = document.getElementById("add-ficha-btn");
            while (sidebar.children.length > 1) sidebar.removeChild(sidebar.children[0]);
            for (let fichaId in fichas) {
                if (fichaId !== "ficha-matriz") {
                    const tab = document.createElement("div");
                    tab.className = "ficha-tab";
                    const span = document.createElement("span");
                    span.textContent = fichas[fichaId].nomeFicha || "Sem Nome";
                    tab.appendChild(span);
                    tab.dataset.fichaId = fichaId;
                    if (fichaId === currentFichaId) tab.classList.add("active");
                    tab.onclick = () => {
                        currentFichaId = fichaId;
                        carregarFicha(fichaId);
                        atualizarAbasFichas();
                    };
                    sidebar.insertBefore(tab, addBtn);
                }
            }
        }

        function verificarAlteracao(event) {
            const input = event.target;
            if (isFichaLocked && !isFichaUnlocked) {
                event.preventDefault();
                abrirModalSenha(input);
            } else {
                previousValues.set(input, input.value);
            }
        }

        function abrirModalSenha(element = null) {
            document.getElementById("senha-gm-modal").style.display = "flex";
            document.getElementById("senha-gm-input").value = "";
            document.getElementById("senha-gm-input").focus();
            if (element) document.getElementById("senha-gm-modal").dataset.elementId = element.id;
            else delete document.getElementById("senha-gm-modal").dataset.elementId;
            document.getElementById("confirmar-senha-gm-btn").onclick = () => {
                const senha = document.getElementById("senha-gm-input").value;
                if (senha === senhaMatriz) {
                    isFichaUnlocked = true;
                    fecharModal("senha-gm-modal");
                    if (element) {
                        previousValues.set(element, element.value);
                        salvarDados();
                    }
                } else {
                    alert("Senha do GM incorreta!");
                    fecharModal("senha-gm-modal");
                }
            };
        }

        function calcularAtributos() {
            const forca = parseInt(forcaInput.value) || 0,
                  destreza = parseInt(destrezaInput.value) || 0,
                  agilidade = parseInt(agilidadeInput.value) || 0,
                  inteligencia = parseInt(inteligenciaInput.value) || 0,
                  constituicao = parseInt(constituicaoInput.value) || 0;
            let totalPontos = forca + destreza + agilidade + inteligencia + constituicao;
            if (totalPontos > pontosHabilidadeTotal) {
                alert("Pontos de habilidade insuficientes!");
                forcaInput.value = previousValues.get(forcaInput) || "0";
                destrezaInput.value = previousValues.get(destrezaInput) || "0";
                agilidadeInput.value = previousValues.get(agilidadeInput) || "0";
                inteligenciaInput.value = previousValues.get(inteligenciaInput) || "0";
                constituicaoInput.value = previousValues.get(constituicaoInput) || "0";
                return;
            }
            pontosHabilidadeUsados = totalPontos;
            pontosHabilidadeSpan.textContent = pontosHabilidadeTotal - pontosHabilidadeUsados;
            let ataque = forca + Math.floor(destreza / 5),
                acerto = Math.floor(destreza / 3) + Math.floor(agilidade / 10),
                esquiva = Math.floor(agilidade / 3),
                rdf = Math.floor(forca / 5),
                rdm = Math.floor(inteligencia / 5),
                ataqueMagico = inteligencia,
                magiaBase = 20 + 3 * constituicao,
                vigorBase = 10 + 0.4 * constituicao;
            vidaBase = 50 + (constituicao * (3 + Math.floor(forca / 10))) + 10 * nivel;
            if (inteligencia >= 10) magiaBase += constituicao * Math.floor(inteligencia / 10);
            ataque += (parseInt(armaDireitaAtaqueInput.value) || 0) + (parseInt(armaEsquerdaAtaqueInput.value) || 0);
            ataqueMagico += (parseInt(armaDireitaAtaqueMagicoInput.value) || 0) + (parseInt(armaEsquerdaAtaqueMagicoInput.value) || 0);
            const velocidadeBase = 25 + Math.floor(agilidade / 3) * 3,
                  alturaPuloBase = 1 + Math.floor(forca / 10),
                  distanciaPuloBase = 3 + 3 * Math.min(Math.floor(forca / 5), Math.floor(agilidade / 5));
            let bonusVelocidade = vantagensSelecionadas.includes("Combo Físico (4)") ? 25 : 0,
                bonusAlturaPulo = vantagensSelecionadas.includes("Combo Físico (4)") ? 2 : 0,
                bonusDistanciaPulo = vantagensSelecionadas.includes("Combo Físico (4)") ? 6 : 0;
            velocidadeCorridaSpan.textContent = velocidadeBase + bonusVelocidade;
            alturaPuloSpan.textContent = alturaPuloBase + bonusAlturaPulo;
            distanciaPuloSpan.textContent = distanciaPuloBase + bonusDistanciaPulo;
            // Removido bônus automáticos para "Maestria com Armas curtas", "Maestria com armas pesadas" e "Maestria com armas de longo alcance"
            ataqueSpan.textContent = ataque;
            ataqueMagicoSpan.textContent = ataqueMagico;
            acertoSpan.textContent = acerto;
            esquivaSpan.textContent = esquiva;
            rdfSpan.textContent = rdf;
            rdmSpan.textContent = rdm;
            vidaTotal = Math.ceil(vidaBase);
            magiaTotal = Math.ceil(magiaBase);
            vigorTotal = parseFloat(vigorBase.toFixed(1));
            vidaAtual = vidaAtual === undefined ? vidaTotal : Math.min(vidaAtual, vidaTotal);
            magiaAtual = magiaAtual === undefined ? magiaTotal : Math.min(magiaAtual, magiaTotal);
            vigorAtual = vigorAtual === undefined ? vigorTotal : Math.min(vigorAtual, vigorTotal);
            document.getElementById("vida-total").textContent = vidaTotal;
            document.getElementById("magia-total").textContent = magiaTotal;
            document.getElementById("vigor-total").textContent = vigorTotal.toFixed(1);
            document.getElementById("vida-atual").textContent = vidaAtual;
            document.getElementById("magia-atual").textContent = magiaAtual;
            document.getElementById("vigor-atual").textContent = vigorAtual.toFixed(1);
            const regeneracaoVida = (0.2 * constituicao).toFixed(1),
                  regeneracaoMagia = (0.8 * constituicao).toFixed(1),
                  regeneracaoVigor = (0.4 * constituicao).toFixed(1);
            document.getElementById("regeneracao-vida").textContent = regeneracaoVida;
            document.getElementById("regeneracao-magia").textContent = regeneracaoMagia;
            document.getElementById("regeneracao-vigor").textContent = regeneracaoVigor;
            const atributos = [
                { span: ataqueSpan, valor: ataque },
                { span: ataqueMagicoSpan, valor: ataqueMagico },
                { span: acertoSpan, valor: acerto },
                { span: esquivaSpan, valor: esquiva },
                { span: rdfSpan, valor: rdf },
                { span: rdmSpan, valor: rdm }
            ];
            atributos.forEach(a => a.span.classList.remove("atributo-fogo"));
            const maxAtributo = atributos.reduce((prev, curr) => prev.valor > curr.valor ? prev : curr, { valor: 0 });
            if (maxAtributo.valor > 0) maxAtributo.span.classList.add("atributo-fogo");
        }

        function removerRaca() {
            if (isFichaLocked && !isFichaUnlocked) {
                abrirModalSenha();
                document.getElementById("confirmar-senha-gm-btn").onclick = () => {
                    if (document.getElementById("senha-gm-input").value === senhaMatriz) {
                        racaSelecionada = null;
                        racaNomeInput.value = "";
                        racaDescricaoInput.value = "";
                        pontosVantagemSpan.textContent = getPontosVantagem();
                        salvarDados();
                        fecharModal("senha-gm-modal");
                    } else {
                        alert("Senha do GM incorreta!");
                        fecharModal("senha-gm-modal");
                    }
                };
            }
        }

        // Outras funções mantidas, omitidas por brevidade
        carregarFichas();
    </script>
</body>
</html>
