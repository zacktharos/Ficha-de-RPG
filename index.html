<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ficha de Personagem RPG</title>
    <link href="https://fonts.googleapis.com/css2?family=MedievalSharp&family=Inter:wght@400;600&display=swap"
        rel="stylesheet">
    <script src="https://unpkg.com/@tailwindcss/browser@4"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0e6d2; /* Cor de pergaminho padr√£o */
            color: #000;
            display: flex;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            background-image: none;
            background-size: cover;
            background-position: center;
            transition: background 0.3s, color 0.3s
        }

        body.dark-mode {
            background-color: #121212 !important; /* Garante que o fundo seja sempre escuro */
            color: #e0e0e0
        }

        #chat-btn-container {
            position: fixed;
            left: 10px;
            top: calc(50% - 120px);
            z-index: 1000;
        }

        #chat-btn {
            padding: 15px;
            background: #f0e6d2;
            border: 2px solid #b8860b;
            border-radius: 8px;
            font-family: 'MedievalSharp', serif;
            font-size: 1.2rem;
            color: #000;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 3px 3px 7px rgba(0, 0, 0, 0.3);
            z-index: 1000;
        }

        #chat-btn:hover {
            background: #a0522d;
            transform: translateY(-3px);
        }

        #chat-btn::after {
            content: attr(data-unread);
            position: absolute;
            top: -10px;
            right: -10px;
            background-color: red;
            color: white;
            border-radius: 50%;
            padding: 5px;
            font-size: 0.8rem;
            min-width: 20px;
            text-align: center;
            display: none;
        }

        #chat-btn[data-unread]:after {
            display: block;
        }

        body.dark-mode #chat-btn {
            background: #1e1e1e;
            color: #e0e0e0;
            border-color: #444;
        }

        body.dark-mode #chat-btn:hover {
            background: #333;
        }

        #fichas-sidebar {
            width: 100%;
            height: 60px;
            padding: 0;
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: flex-start;
            position: fixed;
            top: 0;
            left: 0;
            z-index: 1000;
            overflow-x: auto;
            background: transparent
        }

        .ficha-tab {
            visibility: visible;
            width: 100px;
            height: 50px;
            background: #f0e6d2;
            border: 2px solid #b8860b;
            border-radius: 10px 10px 0 0;
            margin-right: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.2)
        }

        .ficha-tab:hover {
            background: #a0522d;
            transform: translateY(-5px)
        }

        .ficha-tab.active {
            background: #a0522d;
            transform: translateY(-5px)
        }

        .ficha-tab span {
            font-family: 'MedievalSharp', serif;
            color: #000;
            font-size: 0.9rem;
            text-align: center;
            max-width: 90px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap
        }

        #add-ficha-btn {
            width: 100px;
            height: 50px;
            background: #f0e6d2;
            border: 2px solid #b8860b;
            border-radius: 10px 10px 0 0;
            margin-right: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: transform 0.2s ease;
            box-shadow: 0 0 10px #ffd700, 0 0 20px #ffd700;
            z-index: 1001
        }

        #add-ficha-btn span {
            font-family: 'MedievalSharp', serif;
            color: #000;
            font-size: 0.9rem
        }

        #add-ficha-btn:hover {
            background: #a0522d;
            transform: translateY(-5px)
        }

        #ficha-container {
            background: rgba(240, 230, 210, 0.95);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
            width: 95%;
            max-width: 1200px;
            margin: 80px auto 20px;
            border: 2px solid #b8860b;
            position: relative;
            z-index: 1;
        }

        body.dark-mode #ficha-container {
            background: rgba(30, 30, 30, 0.95);
            color: #e0e0e0
        }

        #ficha-container.aura-azul {
            box-shadow: 0 0 30px 15px #00BFFF;
            animation: pulsar-aura 2s infinite
        }

        @keyframes pulsar-aura {
            0% {
                box-shadow: 0 0 20px #00BFFF, 0 0 30px #00BFFF, 0 0 40px #00BFFF
            }

            50% {
                box-shadow: 0 0 30px #00BFFF, 0 0 50px #00BFFF, 0 0 60px #00BFFF
            }

            100% {
                box-shadow: 0 0 20px #00BFFF, 0 0 30px #00BFFF, 0 0 40px #00BFFF
            }
        }

        h1#nome-personagem-titulo {
            font-family: 'MedievalSharp', serif;
            color: #1C2526;
            font-size: 3rem;
            margin-bottom: 20px;
            text-align: center;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
            animation: raios 2s infinite linear
        }

        @keyframes raios {
            0% {
                text-shadow: 0 0 5px #FFD700, 0 0 10px #FFD700, 0 0 15px #FFD700, 0 0 20px #FF4500
            }

            50% {
                text-shadow: 0 0 10px #FFD700, 0 0 15px #FFD700, 0 0 20px #FF4500, 0 0 25px #FF4500
            }

            100% {
                text-shadow: 0 0 5px #FFD700, 0 0 10px #FFD700, 0 0 15px #FFD700, 0 0 20px #FF4500
            }
        }

        #game-master-message {
            display: none;
            color: blue;
            font-size: 1.5rem;
            text-align: center;
            font-family: 'MedievalSharp', serif;
            margin-bottom: 10px
        }

        section {
            background: #f0e6d2;
            border: 2px solid #b8860b;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px
        }

        section h2 {
            text-align: center
        }

        body.dark-mode section {
            background: #1e1e1e;
            border-color: #444
        }

        label {
            font-weight: 600;
            color: #000;
            margin-bottom: 8px;
            display: block
        }

        body.dark-mode label {
            color: #e0e0e0
        }

        input[type="text"],
        input[type="number"],
        textarea {
            padding: 10px;
            border: 2px solid #b8860b;
            border-radius: 6px;
            width: calc(100% - 24px);
            margin-bottom: 15px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
            background: #fff;
            color: #000
        }

        body.dark-mode input[type="text"],
        body.dark-mode input[type="number"],
        body.dark-mode textarea {
            background: #333;
            color: #e0e0e0;
            border-color: #555
        }

        input[type="text"]:focus,
        input[type="number"]:focus,
        textarea:focus {
            border-color: #a0522d;
            outline: none;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1)
        }

        input[readonly],
        span[readonly] {
            background: #e8e8e8;
            border: 1px solid #ccc;
            cursor: not-allowed
        }

        body.dark-mode input[readonly],
        body.dark-mode span[readonly] {
            background: #444;
            border-color: #666
        }

        textarea {
            resize: vertical
        }

        .atributos-container {
            display: flex;
            justify-content: space-between;
            gap: 20px
        }

        .atributos-coluna,
        .atributos-coluna-destaque {
            width: 48%;
            display: flex;
            flex-direction: column;
            align-items: flex-start
        }

        .atributos-coluna-destaque {
            background: #fff;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #b8860b
        }

        body.dark-mode .atributos-coluna-destaque {
            background: #333;
            border-color: #555
        }

        .atributo-destaque {
            padding: 8px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%
        }

        .atributo-destaque label {
            font-size: 1.1rem;
            font-weight: 700;
            color: #a0522d
        }

        .atributo-destaque span {
            font-size: 1.2rem;
            font-family: 'MedievalSharp', serif;
            color: #000
        }

        body.dark-mode .atributo-destaque span {
            color: #e0e0e0
        }

        .atributo-fogo {
            animation: fogo 1.5s infinite
        }

        @keyframes fogo {
            0% {
                text-shadow: 0 0 5px #ff4500, 0 0 10px #ff4500
            }

            50% {
                text-shadow: 0 0 10px #ff4500, 0 0 15px #ffd700
            }

            100% {
                text-shadow: 0 0 5px #ff4500, 0 0 10px #ff4500
            }
        }

        .vida-magia-vigor {
            display: flex;
            justify-content: space-around;
            gap: 15px;
            flex-wrap: wrap
        }

        .atributo-container {
            background: rgba(255, 255, 255, 0.8);
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #b8860b;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            width: 30%;
            min-width: 200px;
            text-align: center
        }

        body.dark-mode .atributo-container {
            background: rgba(50, 50, 50, 0.8)
        }

        .atributo-container::before {
            font-size: 1.5rem;
            margin-bottom: 5px;
            display: block
        }

        .atributo-container.vida::before {
            content: "‚ù§Ô∏è"
        }

        .atributo-container.magia::before {
            content: "‚ú®"
        }

        .atributo-container.vigor::before {
            content: "‚ö°"
        }

        .medieval-box {
            background: #f0e6d2;
            border: 2px solid #b8860b;
            border-radius: 8px;
            padding: 10px;
            margin: 5px 0;
            text-align: center
        }

        body.dark-mode .medieval-box {
            background: #1e1e1e;
            border-color: #444
        }

        .regeneracao {
            font-size: 0.8rem;
            color: #555;
            margin-top: 5px
        }

        body.dark-mode .regeneracao {
            color: #aaa
        }

        button {
            background: #b8860b;
            color: #fff;
            border: none;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 1.2rem;
            border-radius: 4px;
            margin: 0 5px;
            transition: background-color 0.3s ease
        }

        body.dark-mode button {
            background: #555
        }

        button:hover {
            background: #a0522d
        }

        body.dark-mode button:hover {
            background: #777
        }

        .botoes-container {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
            margin-bottom: 20px; /* Adicionado margem inferior para separar da anota√ß√£o */
        }

        .botao {
            padding: 12px 25px;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            font-family: 'MedievalSharp', serif;
            color: #fff;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3)
        }

        body.dark-mode .botao {
            background: #555
        }

        body.dark-mode .botao:hover {
            background: #777
        }

        .botao-reset {
            background: #b8860b
        }

        .botao-reset:hover {
            background: #a0522d;
            transform: translateY(-2px)
        }

        .botao-recomecar {
            background: #a52a2a
        }

        .botao-recomecar:hover {
            background: #8b0000;
            transform: translateY(-2px)
        }

        .botao-bloquear,
        .botao-desbloquear {
            background: #4a4a4a
        }

        .botao-bloquear:hover,
        .botao-desbloquear:hover {
            background: #2a2a2a;
            transform: translateY(-2px)
        }

        #nivel-container {
            text-align: center;
            margin-top: 10px
        }

        #nivel {
            padding: 10px;
            background: #f0e6d2;
            border: 3px solid #000;
            border-radius: 50%;
            width: 100px;
            height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3.125rem;
            box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.5);
            margin: 0 auto
        }

        body.dark-mode #nivel {
            background: #1e1e1e;
            border-color: #444
        }

        #nivel.aura-azul {
            animation: pulsar-aura 2s 10
        }

        .expandable-textarea {
            height: 100px;
            width: 100%;
            background: #fff;
            border: 2px solid #b8860b;
            border-radius: 6px;
            padding: 10px;
            font-size: 0.9rem;
            transition: height 0.3s ease
        }

        body.dark-mode .expandable-textarea {
            background: #333
        }

        .expandable-textarea:focus {
            height: 15cm
        }

        #dice-container {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 200px;
            text-align: center;
            font-family: 'MedievalSharp', serif;
            cursor: move;
            z-index: 10;
            user-select: none
        }

        #dice-container label {
            font-size: 1.2rem;
            color: #000;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 10px
        }

        body.dark-mode #dice-container label {
            color: #e0e0e0
        }

        #dice-container label::before {
            content: "üé≤";
            margin-right: 5px;
            font-size: 1.5rem
        }

        #dice-roll {
            width: 100px;
            height: 100px;
            background: #f0e6d2;
            border: 2px solid #b8860b;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            cursor: pointer;
            margin: 0 auto;
            position: relative;
            transition: all 0.3s ease
        }

        body.dark-mode #dice-roll {
            background: #1e1e1e;
            border-color: #444
        }

        #dice-roll::before {
            content: "‚öÖ";
            font-size: 1.5rem;
            position: absolute;
            top: 5px;
            right: 5px;
            color: #a0522d
        }

        #dice-result {
            margin-top: 10px;
            font-size: 1rem;
            color: #000;
            display: none;
            animation: blink 1s infinite
        }

        body.dark-mode #dice-result {
            color: #e0e0e0
        }

        @keyframes blink {
            50% {
                opacity: 0
            }
        }

        #dice-roll.critical-failure {
            animation: aura-vermelha 2s infinite
        }

        #dice-roll.critical-success {
            animation: aura-verde 2s infinite
        }

        @keyframes aura-vermelha {
            0% {
                box-shadow: 0 0 5px #ff0000, 0 0 10px #ff0000
            }

            50% {
                box-shadow: 0 0 15px #ff0000, 0 0 20px #ff0000
            }

            100% {
                box-shadow: 0 0 5px #ff0000, 0 0 10px #ff0000
            }
        }

        @keyframes aura-verde {
            0% {
                box-shadow: 0 0 5px #00ff00, 0 0 10px #00ff00
            }

            50% {
                box-shadow: 0 0 15px #00ff00, 0 0 20px #00ff00
            }

            100% {
                box-shadow: 0 0 5px #00ff00, 0 0 10px #00ff00
            }
        }

        #notification {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 20px;
            border-radius: 8px;
            font-family: 'MedievalSharp', serif;
            font-size: 1.5rem;
            color: #fff;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
            display: none;
            z-index: 100;
            background: rgba(0, 0, 0, 0.7);
            transition: opacity 0.3s ease
        }

        #notification.critical-failure {
            background: rgba(255, 0, 0, 0.8);
            animation: aura-vermelha 2s infinite
        }

        #notification.critical-success {
            background: rgba(0, 255, 0, 0.8);
            animation: aura-verde 2s infinite
        }

        #notification.normal-result,
        #notification.save-success {
            animation: blink 1s infinite
        }

        #notification.save-success {
            background: rgba(0, 200, 0, 0.8)
        }

        #character-image-container {
            position: absolute;
            top: 10px;
            left: 10px;
            width: 100px;
            height: 100px;
            background: #f0e6d2;
            border: 2px solid #b8860b;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            overflow: hidden;
            z-index: 10
        }

        body.dark-mode #character-image-container {
            background: #1e1e1e
        }

        #character-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: none
        }

        #character-image-container:hover {
            box-shadow: 0 0 10px #ffd700
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000
        }

        .modal-content {
            background: #f0e6d2;
            padding: 20px;
            border-radius: 8px;
            border: 2px solid #b8860b;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            width: 300px;
            text-align: center
        }

        body.dark-mode .modal-content {
            background: #1e1e1e;
            border-color: #444
        }

        .modal-content h3 {
            font-family: 'MedievalSharp', serif;
            color: #000;
            margin-bottom: 15px
        }

        body.dark-mode .modal-content h3 {
            color: #e0e0e0
        }

        .modal-content input {
            width: calc(100% - 20px);
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #ccc;
            border-radius: 6px
        }

        body.dark-mode .modal-content input {
            background: #333;
            color: #e0e0e0;
            border-color: #555
        }

        .modal-content button {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-family: 'MedievalSharp', serif;
            color: #fff;
            cursor: pointer;
            margin: 0 5px
        }

        .modal-content .confirm-btn {
            background: #b8860b
        }

        .modal-content .confirm-btn:hover {
            background: #a0522d
        }

        .modal-content .cancel-btn {
            background: #a52a2a
        }

        .modal-content .cancel-btn:hover {
            background: #8b0000
        }

        #vantagens-desvantagens-btn,
        #racas-btn,
        #classes-btn {
            padding: 10px 20px;
            background: #f0e6d2;
            border: 2px solid #b8860b;
            border-radius: 6px;
            font-family: 'MedievalSharp', serif;
            font-size: 1rem;
            color: #000;
            cursor: pointer;
            transition: background-color 0.3s ease;
            z-index: 10
        }

        body.dark-mode #vantagens-desvantagens-btn,
        body.dark-mode #racas-btn,
        body.dark-mode #classes-btn {
            background: #1e1e1e;
            color: #e0e0e0
        }

        #vantagens-desvantagens-btn:hover,
        #racas-btn:hover,
        #classes-btn:hover {
            background: #a0522d;
            color: #fff
        }

        #vantagens-desvantagens-panel,
        #racas-panel,
        #classes-panel {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(240, 230, 210, 0.95);
            padding: 20px;
            overflow-y: auto;
            z-index: 999;
            border: 2px solid #b8860b;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.3)
        }

        body.dark-mode #vantagens-desvantagens-panel,
        body.dark-mode #racas-panel,
        body.dark-mode #classes-panel {
            background: rgba(30, 30, 30, 0.95)
        }

        #vantagens-desvantagens-panel h2,
        #racas-panel h2,
        #classes-panel h2 {
            font-family: 'MedievalSharp', serif;
            font-size: 2rem;
            text-align: center;
            color: #a0522d;
            margin-bottom: 20px
        }

        #racas-panel h2 {
            font-size: 3rem
        }

        .vantagem-item,
        .desvantagem-item,
        .raca-item {
            padding: 10px;
            margin: 5px 0;
            background: #fff;
            border: 1px solid #ccc;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.3s ease
        }

        body.dark-mode .vantagem-item,
        body.dark-mode .desvantagem-item,
        body.dark-mode .raca-item {
            background: #333;
            border-color: #555
        }

        .vantagem-item:hover,
        .desvantagem-item:hover,
        .raca-item:hover {
            background: #f0e6d2
        }

        body.dark-mode .vantagem-item:hover,
        body.dark-mode .desvantagem-item:hover,
        body.dark-mode .raca-item:hover {
            background: #444
        }

        .vantagem-item.comprada,
        .raca-item.comprada {
            background: #ffcccc;
            color: #f00;
            cursor: default
        }

        .desvantagem-item.comprada {
            background: #ccffcc;
            color: #080;
            cursor: default
        }

        #salvar-vantagens-btn,
        #salvar-racas-btn,
        #fechar-pagina-btn,
        #fechar-racas-btn,
        #fechar-classes-btn {
            position: fixed;
            bottom: 20px;
            padding: 12px 25px;
            background: #a52a2a;
            color: #fff;
            border: none;
            border-radius: 6px;
            font-family: 'MedievalSharp', serif;
            font-size: 1.2rem;
            cursor: pointer;
            transition: transform 0.2s ease
        }

        #salvar-vantagens-btn,
        #salvar-racas-btn {
            right: 250px;
            animation: aura-verde-btn 2s infinite;
            display: none;
            background: #000
        }

        #fechar-pagina-btn,
        #fechar-racas-btn,
        #fechar-classes-btn {
            right: 20px
        }

        #salvar-vantagens-btn:hover,
        #salvar-racas-btn:hover,
        #fechar-pagina-btn:hover,
        #fechar-racas-btn:hover,
        #fechar-classes-btn:hover {
            transform: translateY(-2px)
        }

        @keyframes aura-verde-btn {
            0% {
                box-shadow: 0 0 5px #00ff00, 0 0 10px #00ff00
            }

            50% {
                box-shadow: 0 0 15px #00ff00, 0 0 20px #00ff00
            }

            100% {
                box-shadow: 0 0 5px #00ff00, 0 0 10px #00ff00
            }
        }

        .locomotion-container {
            background: #8B4513;
            border: 3px solid #FFD700;
            border-radius: 10px;
            padding: 15px;
            color: #FFD700;
            font-family: 'MedievalSharp', serif
        }

        .locomotion-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px
        }

        .locomotion-item label {
            font-weight: bold;
            color: #FFD700
        }

        .locomotion-item span {
            font-size: 1.2rem;
            color: #FFF;
            text-shadow: 1px 1px 2px #000;
            margin-left: 5px;
            font-weight: bold
        }

        #distancia-pulo,
        #altura-pulo,
        #velocidade-corrida {
            background-color: #8B4513;
            border-color: #8B4513
        }

        .list-display {
            background: #fff;
            border: 2px solid #b8860b;
            border-radius: 6px;
            padding: 10px;
            min-height: 100px;
            max-height: 200px;
            overflow-y: auto
        }

        body.dark-mode .list-display {
            background: #333;
            border-color: #555
        }

        .list-item {
            cursor: pointer;
            margin-bottom: 5px;
            padding: 5px;
            border-bottom: 1px solid #ccc
        }

        body.dark-mode .list-item {
            border-color: #555
        }

        .list-item:hover {
            background: #e0e0e0
        }

        body.dark-mode .list-item:hover {
            background: #444
        }

        .inventory-slot {
            display: flex;
            align-items: center;
            margin-bottom: 10px
        }

        .inventory-slot input[type="text"] {
            flex-grow: 1;
            margin-right: 10px
        }

        .inventory-slot input[type="number"] {
            width: 60px
        }

        #anotacoes-btn {
            position: fixed;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            padding: 10px 20px;
            background: #f0e6d2;
            border: 2px solid #b8860b;
            border-radius: 6px;
            font-family: 'MedievalSharp', serif;
            font-size: 1rem;
            color: #000;
            cursor: pointer;
            transition: background-color 0.3s ease;
            z-index: 1000;
        }

        body.dark-mode #anotacoes-btn {
            background: #1e1e1e;
            color: #e0e0e0
        }

        #anotacoes-btn:hover {
            background: #a0522d;
            color: #fff
        }

        #anotacoes-textarea {
            display: none;
            position: fixed;
            left: 60px;
            top: 50%;
            transform: translateY(-50%);
            width: 400px;
            height: 400px;
            background: #fff;
            border: 2px solid #b8860b;
            border-radius: 6px;
            padding: 10px;
            font-size: 0.9rem;
            resize: none;
            z-index: 1001;
        }

        body.dark-mode #anotacoes-textarea {
            background: #333;
            color: #e0e0e0
        }

        #historico-dados-btn {
            position: fixed;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            padding: 10px 20px;
            background: #f0e6d2;
            border: 2px solid #b8860b;
            border-radius: 6px;
            font-family: 'MedievalSharp', serif;
            font-size: 1rem;
            color: #000;
            cursor: pointer;
            transition: background-color 0.3s ease
        }

        body.dark-mode #historico-dados-btn {
            background: #1e1e1e;
            color: #e0e0e0
        }

        #historico-dados-btn:hover {
            background: #a0522d;
            color: #fff
        }

        #historico-dados-panel {
            display: none;
            position: fixed;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            width: 300px;
            background: #fff;
            border: 2px solid #b8860b;
            border-radius: 6px;
            padding: 10px;
            max-height: 400px;
            overflow-y: auto
        }

        body.dark-mode #historico-dados-panel {
            background: #333;
            border-color: #555
        }

        #historico-dados-panel h3 {
            font-family: 'MedievalSharp', serif;
            color: #000;
            margin-bottom: 10px
        }

        body.dark-mode #historico-dados-panel h3 {
            color: #e0e0e0
        }

        #historico-lista div {
            padding: 5px;
            border-bottom: 1px solid #ccc
        }

        body.dark-mode #historico-lista div {
            border-color: #555
        }

        #excluir-historico-btn {
            background: #a52a2a;
            color: #fff;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            margin-top: 10px
        }

        #excluir-historico-btn:hover {
            background: #8b0000
        }

        .magias-container {
            max-height: 300px;
            overflow-y: auto;
            border: 2px solid #b8860b;
            border-radius: 6px;
            padding: 10px;
            background: #fff
        }

        body.dark-mode .magias-container {
            background: #333;
            border-color: #555
        }

        .magias-container input {
            margin-bottom: 10px
        }

        #adicionar-magia-btn {
            background: #b8860b;
            color: #fff;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            display: block;
            margin-top: 10px
        }

        #adicionar-magia-btn:hover {
            background: #a0522d
        }

        .classe-raca-container {
            background: #f0e6d2;
            border: 2px solid #b8860b;
            padding: 10px;
            border-radius: 6px;
            margin-top: 10px
        }

        body.dark-mode .classe-raca-container {
            background: #1e1e1e;
            border-color: #444
        }

        .classe-raca-container label {
            font-family: 'MedievalSharp', serif;
            color: #a0522d;
            font-size: 1.2rem
        }

        .classe-raca-container span[onclick] {
            background: #fff;
            border: 2px solid #b8860b;
            padding: 10px;
            cursor: pointer;
            display: block
        }

        body.dark-mode .classe-raca-container span[onclick] {
            background: #333;
            color: #e0e0e0
        }

        .classe-raca-container textarea {
            width: 100%;
            background: #fff;
            border: 2px solid #b8860b
        }

        body.dark-mode .classe-raca-container textarea {
            background: #333;
            color: #e0e0e0
        }

        .raca-item {
            margin-bottom: 20px;
            padding: 10px;
            background: #fff;
            border: 2px solid #b8860b;
            border-radius: 6px
        }

        .raca-item h3 {
            font-family: 'MedievalSharp', serif;
            font-size: 1.5rem;
            color: #a0522d
        }

        .raca-item p {
            font-size: 1rem;
            color: #000
        }

        body.dark-mode .raca-item {
            background: #333;
            border-color: #555
        }

        body.dark-mode .raca-item p {
            color: #e0e0e0
        }

        @media (max-width: 768px) {
            body {
                padding: 10px
            }

            #ficha-container {
                padding: 15px
            }

            h1#nome-personagem-titulo {
                font-size: 2rem
            }

            section h2 {
                font-size: 1.2rem
            }

            input,
            textarea {
                font-size: 0.9rem
            }

            .atributos-container,
            .vida-magia-vigor {
                flex-direction: column
            }

            .atributos-coluna,
            .atributos-coluna-destaque,
            .atributo-container {
                width: 100%
            }
        }

        /* Estilos para o modal de chat */
        #chat-modal {
            display: none;
        }

        #chat-modal .modal-content {
            width: 500px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
        }

        #chat-modal .chat-header {
            padding: 10px;
            border-bottom: 1px solid #ccc;
            font-family: 'MedievalSharp', serif;
            font-size: 1.5rem;
            text-align: center;
        }

        #chat-modal .chat-body {
            flex-grow: 1;
            display: flex;
            overflow: hidden;
        }

        #chat-modal .user-list {
            width: 150px;
            border-right: 1px solid #ccc;
            overflow-y: auto;
            padding: 10px;
        }

        #chat-modal .user-list h4 {
            font-family: 'MedievalSharp', serif;
            margin-bottom: 5px;
        }

        #chat-modal .user-list .user-item {
            padding: 8px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }

        #chat-modal .user-list .user-item:hover {
            background-color: #f0e6d2;
        }

        body.dark-mode #chat-modal .user-list .user-item:hover {
            background-color: #333;
        }

        #chat-modal .conversation {
            flex-grow: 1;
            padding: 10px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        #chat-modal .message-container {
            display: flex;
            flex-direction: column;
            margin-bottom: 8px;
        }

        #chat-modal .message {
            padding: 8px;
            border-radius: 5px;
            background-color: #e0e0e0;
            color: #000;
            width: fit-content;
            max-width: 80%;
        }

        body.dark-mode #chat-modal .message {
            background-color: #444;
            color: #e0e0e0;
        }

        #chat-modal .message.sent {
            background-color: #cce5ff;
            align-self: flex-end;
        }

        body.dark-mode #chat-modal .message.sent {
            background-color: #6699cc;
            color: #e0e0e0;
        }

        #chat-modal .sender-name {
            font-size: 0.8rem;
            color: #777;
            margin-bottom: 2px;
        }

        body.dark-mode #chat-modal .sender-name {
            color: #aaa;
        }

        #chat-modal .chat-input {
            padding: 10px;
            border-top: 1px solid #ccc;
            display: flex;
        }

        #chat-modal .chat-input input[type="text"] {
            flex-grow: 1;
            padding: 8px;
            border-radius: 5px;
            border: 1px solid #ccc;
            margin-right: 10px;
        }

        body.dark-mode #chat-modal .chat-input input[type="text"] {
            background-color: #333;
            color: #e0e0e0;
            border-color: #555;
        }

        #chat-modal .chat-input button {
            padding: 8px 15px;
            border-radius: 5px;
        }

        /* Estilos para os modais de senha do chat */
        #chat-password-modal .modal-content,
        #open-chat-modal .modal-content {
            width: 350px;
        }

        /* Espa√ßamento dos bot√µes de ra√ßa */
        #raca-opcoes-modal .modal-content button:nth-child(2) {
            margin-top: 10px;
        }

        /* Estilos para o modal de plano de fundo */
        #background-modal {
            display: none;
        }

        #background-modal .modal-content {
            width: 400px;
            text-align: left;
        }

        #background-modal .modal-content label {
            display: block;
            margin-bottom: 5px;
        }

        #background-modal .modal-content input[type="file"] {
            margin-bottom: 10px;
        }

        #background-modal .modal-content .radio-group {
            margin-bottom: 15px;
        }

        #background-modal .modal-content .radio-group label {
            display: inline-block;
            margin-right: 10px;
        }

        /* Estilos para o seletor de cor de fundo */
        #background-color-selector {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .color-option {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            border: 1px solid #ccc;
        }
    </style>
</head>

<body>
    <div id="chat-btn-container">
        <button id="chat-btn" data-unread="0">üí¨ Chat</button>
    </div>

    <div id="fichas-sidebar">
        <div id="add-ficha-btn"><span>+ Fichas</span></div>
    </div>

    <div id="ficha-container">
        <h1 id="nome-personagem-titulo">Ficha de Personagem</h1>
        <div id="game-master-message">Voc√™ virou o Game Master</div>

        <div id="character-image-container" onclick="document.getElementById('character-image-input').click()">
            <img id="character-image" alt="Imagem do Personagem">
            <input type="file" id="character-image-input" accept="image/*" style="display:none">
        </div>

        <div id="dice-container">
            <label>Role seu dado:</label>
            <div id="dice-roll">-</div>
            <div id="dice-result"></div>
        </div>

        <div id="ficha-content">
            <section id="informacoes-basicas">
                <h2>Informa√ß√µes B√°sicas</h2>
                <label for="nome-personagem">Nome do Personagem:</label>
                <input type="text" id="nome-personagem" placeholder="Digite o nome do seu personagem">

                <label for="descricao-personagem">Descri√ß√£o do Personagem:</label>
                <textarea id="descricao-personagem" placeholder="Digite a descri√ß√£o do seu personagem"></textarea>
            </section>

            <section id="recursos">
                <h2>Recursos</h2>
                <div class="vida-magia-vigor">
                    <div class="atributo-container vida">
                        <h3>Vida</h3>
                        <div class="valor-total medieval-box">
                            <span>Vida Total: </span>
                            <span id="vida-total" readonly>50</span>
                        </div>
                        <div class="valor-atual medieval-box">
                            <span>Vida Atual: </span>
                            <button onclick="diminuirVida()" title="Diminuir Vida">‚ñº</button>
                            <span id="vida-atual">50</span>
                            <button onclick="aumentarVida()" title="Aumentar Vida">‚ñ≤</button>
                        </div>
                        <div class="regeneracao">
                            <span>Regenera√ß√£o por turno: <span id="regeneracao-vida">0</span> (parado)</span>
                        </div>
                    </div>

                    <div class="atributo-container magia">
                        <h3>Magia</h3>
                        <div class="valor-total medieval-box">
                            <span>Magia Total: </span>
                            <span id="magia-total" readonly>20</span>
                        </div>
                        <div class="valor-atual medieval-box">
                            <span>Magia Atual: </span>
                            <button onclick="diminuirMagia()" title="Diminuir Magia">‚ñº</button>
                            <span id="magia-atual">20</span>
                            <button onclick="aumentarMagia()" title="Aumentar Magia">‚ñ≤</button>
                        </div>
                        <div class="regeneracao">
                            <span>Regenera√ß√£o por turno: <span id="regeneracao-magia">0</span></span>
                        </div>
                    </div>

                    <div class="atributo-container vigor">
                        <h3>Vigor</h3>
                        <div class="valor-total medieval-box">
                            <span>Vigor Total: </span>
                            <span id="vigor-total" readonly>10</span>
                        </div>
                        <div class="valor-atual medieval-box">
                            <span>Vigor Atual: </span>
                            <button onclick="diminuirVigor()" title="Diminuir Vigor">‚ñº</button>
                            <span id="vigor-atual">10</span>
                            <button onclick="aumentarVigor()" title="Aumentar Vigor">‚ñ≤</button>
                        </div>
                        <div class="regeneracao">
                            <span>Regenera√ß√£o por turno: <span id="regeneracao-vigor">0</span> (parado)</span>
                        </div>
                    </div>
                </div>
            </section>

            <section id="atributos">
                <h2>Atributos</h2>
                <div class="atributos-container">
                    <div class="atributos-coluna">
                        <div class="atributo">
                            <label for="forca" title="Afeta ataque e RDF">For√ßa:</label>
                            <input type="number" id="forca" value="0" min="0">
                        </div>

                        <div class="atributo">
                            <label for="destreza" title="Afeta ataque e acerto">Destreza:</label>
                            <input type="number" id="destreza" value="0" min="0">
                        </div>

                        <div class="atributo">
                            <label for="agilidade" title="Afeta esquiva e acerto">Agilidade:</label>
                            <input type="number" id="agilidade" value="0" min="0">
                        </div>

                        <div class="atributo">
                            <label for="constituicao" title="Afeta vida, magia e vigor">Constitui√ß√£o:</label>
                            <input type="number" id="constituicao" value="0" min="0">
                        </div>

                        <div class="atributo">
                            <label for="inteligencia" title="Afeta ataque m√°gico e RDM">Intelig√™ncia:</label>
                            <input type="number" id="inteligencia" value="0" min="0">
                        </div>
                    </div>

                    <div class="atributos-coluna-destaque">
                        <div class="atributo-destaque">
                            <label>Ataque:</label>
                            <span id="ataque" readonly>0</span>
                        </div>
                        <div class="atributo-destaque">
                            <label>Ataque M√°gico:</label>
                            <span id="ataque-magico" readonly>0</span>
                        </div>
                        <div class="atributo-destaque">
                            <label>Acerto:</label>
                            <span id="acerto" readonly>0</span>
                        </div>
                        <div class="atributo-destaque">
                            <label>Esquiva:</label>
                            <span id="esquiva" readonly>0</span>
                        </div>
                        <div class="atributo-destaque">
                            <label>RDF:</label>
                            <span id="rdf" readonly>0</span>
                        </div>
                        <div class="atributo-destaque">
                            <label>RDM:</label>
                            <span id="rdm" readonly>0</span>
                        </div>
                    </div>
                </div>
            </section>

            <section id="combate">
                <h2>Combate</h2>
                <div class="armamento-container">
                    <div class="armamento-coluna">
                        <label>Armamento M√£o Direita:</label>
                        <div class="flex items-center mb-2">
                            <input type="text" id="arma-direita-nome" placeholder="Nome da Arma"
                                class="mr-2">
                            <span>Ataque </span>
                            <input type="number" id="arma-direita-ataque" value="0" class="w-20 mr-2">
                            <span>Ataque M√°gico </span>
                            <input type="number" id="arma-direita-ataque-magico" value="0" class="w-20">
                        </div>
                    </div>
                    <div class="armamento-coluna">
                        <label>Armamento M√£o Esquerda:</label>
                        <div class="flex items-center">
                            <input type="text" id="arma-esquerda-nome" placeholder="Nome da Arma" class="mr-2">
                            <span>Ataque </span>
                            <input type="number" id="arma-esquerda-ataque" value="0" class="w-20 mr-2">
                            <span>Ataque M√°gico </span>
                            <input type="number" id="arma-esquerda-ataque-magico" value="0" class="w-20">
                        </div>
                    </div>
                </div>
            </section>

            <section id="inventario-habilidades">
                <h2>Invent√°rio e Habilidades</h2>
                <div class="flex gap-20">
                    <div style="width:50%">
                        <label>Invent√°rio (Peso Total: <span
                                id="peso-total">0</span> kg):</label>
                        <div id="inventario-slots">
                            <div class="inventory-slot">
                                <input type="text" placeholder="Item 1" class="inventory-item">
                                <input type="number" min="0" value="0" class="inventory-weight" title="Peso em kg">
                            </div>
                            <div class="inventory-slot">
                                <input type="text" placeholder="Item 2" class="inventory-item">
                                <input type="number" min="0" value="0" class="inventory-weight">
                            </div>
                            <div class="inventory-slot">
                                <input type="text" placeholder="Item 3" class="inventory-item">
                                <input type="number" min="0" value="0" class="inventory-weight">
                            </div>
                            <div class="inventory-slot">
                                <input type="text" placeholder="Item 4" class="inventory-item">
                                <input type="number" min="0" value="0" class="inventory-weight">
                            </div>
                            <div class="inventory-slot">
                                <input type="text" placeholder="Item 5" class="inventory-item">
                                <input type="number" min="0" value="0" class="inventory-weight">
                            </div>
                            <div class="inventory-slot">
                                <input type="text" placeholder="Item 6" class="inventory-item">
                                <input type="number" min="0" value="0" class="inventory-weight">
                            </div>
                            <div class="inventory-slot">
                                <input type="text" placeholder="Item 7" class="inventory-item">
                                <input type="number" min="0" value="0" class="inventory-weight">
                            </div>
                            <div class="inventory-slot">
                                <input type="text" placeholder="Item 8" class="inventory-item">
                                <input type="number" min="0" value="0" class="inventory-weight">
                            </div>
                            <div class="inventory-slot">
                                <input type="text" placeholder="Item 9" class="inventory-item">
                                <input type="number" min="0" value="0" class="inventory-weight">
                            </div>
                            <div class="inventory-slot">
                                <input type="text" placeholder="Item 10" class="inventory-item">
                                <input type="number" min="0" value="0" class="inventory-weight">
                            </div>
                        </div>
                    </div>

                    <div style="width:50%">
                        <label>Magias e Habilidades:</label>
                        <div id="magias-list" class="magias-container">
                            <input type="text" placeholder="Magia/Habilidade 1" class="magia-nome">
                            <input type="text" placeholder="Magia/Habilidade 2"
                                class="magia-nome">
                            <input type="text" placeholder="Magia/Habilidade 3" class="magia-nome">
                            <input type="text" placeholder="Magia/Habilidade 4" class="magia-nome">
                            <input type="text" placeholder="Magia/Habilidade 5" class="magia-nome">
                            <input type="text" placeholder="Magia/Habilidade 6" class="magia-nome">
                            <input type="text" placeholder="Magia/Habilidade 7" class="magia-nome">
                            <input type="text" placeholder="Magia/Habilidade 8" class="magia-nome">
                            <input type="text" placeholder="Magia/Habilidade 9" class="magia-nome">
                            <input type="text" placeholder="Magia/Habilidade 10" class="magia-nome">
                        </div>
                        <button id="adicionar-magia-btn">Adicionar Magia</button>
                    </div>
                </div>

                <div class="mt-4">
                    <label>Vantagens:</label>
                    <div
                        id="vantagens-list-display" class="list-display"></div>
                    <label>Desvantagens:</label>
                    <div id="desvantagens-list-display" class="list-display"></div>
                </div>

                <div class="classe-raca-container">
                    <label>Classe:</label>
                    <input type="text" id="classe-nome" placeholder="Nome da Classe">
                    <textarea id="classe-descricao" placeholder="Descri√ß√£o da Classe"
                        class="expandable-textarea"></textarea>

                    <label>Ra√ßa:</label>
                    <span id="raca-nome" onclick="abrirModalRaca()"></span>
                    <textarea id="raca-descricao" placeholder="Descri√ß√£o da Ra√ßa" class="expandable-textarea"
                        readonly></textarea>
                </div>
            </section>

            <section id="locomocao">
                <h2>Locomo√ß√£o</h2>
                <div class="locomotion-container">
                    <div class="locomotion-item">
                        <label>Velocidade de Corrida (km/h):</label>
                        <span>üèÉ‚Äç‚ôÇÔ∏è</span>
                        <span id="velocidade-corrida" readonly>25</span>
                    </div>
                    <div class="locomotion-item">
                        <label>Altura do Pulo
                            (m):</label>
                        <span>‚¨ÜÔ∏è</span>
                        <span id="altura-pulo" readonly>1</span>
                    </div>
                    <div class="locomotion-item">
                        <label>Dist√¢ncia do Pulo (m):</label>
                        <span>‚û°Ô∏è</span>
                        <span id="distancia-pulo" readonly>3</span>
                    </div>
                </div>
            </section>

            <section id="status">
                <h2>Status</h2>
                <div class="flex gap-20">
                    <div>
                        <label>Experi√™ncia:</label>
                        <input type="number" id="experiencia" value="0" min="0">
                        <label>Pontos de Habilidade (PD):</label>
                        <span id="pontos-habilidade" readonly>25</span>
                        <label>Pontos de Vantagem (PH):</label>
                        <span id="pontos-vantagem" readonly>8</span>
                    </div>
                    <div>
                    </div>
                </div>
                <div id="nivel-container">
                    <label>N√≠vel:</label>
                    <span id="nivel">0</span>
                </div>
            </section>

            <div style="display:flex;justify-content:center;gap:20px;margin-bottom:20px">
                <button id="vantagens-desvantagens-btn">Vantagens e Desvantagens</button>
                <button id="racas-btn">Ra√ßas üè∞</button>
                <button id="classes-btn">Classes ‚öîÔ∏è</button>
            </div>

            <div class="botoes-container">
                <button id="reset-pontos" class="botao botao-reset" style="background-color: #800000;">Reiniciar Pontos</button>
                <button id="recomecar" class="botao botao-recomecar" style="background-color: #800000;">Recome√ßar</button>
                <button id="bloquear-ficha" class="botao botao-bloquear" style="background-color: #800000;">Bloquear Ficha</button>
                <button id="excluir-ficha" class="botao botao-excluir" style="background-color: #800000;">Excluir Ficha</button>
                <button id="sol-btn" class="botao" style="background-color: #ffdd00;
            color: #333;">‚òÄÔ∏è</button>
                <button id="cor-fundo-btn" class="botao">üé®</button>
                <button id="lua-btn" class="botao" style="background-color: #333;
            color: #eee;">üåô</button>
                <button id="plano-fundo-btn" class="botao" style="background-color: #800000;">Plano de fundo</button>
                <div style="display: inline-block;">
                    <div id="background-color-selector" style="display: none;
            position: absolute; background-color: #fff; border: 1px solid #ccc; padding: 10px; border-radius: 5px;
            z-index: 1002;">
                        <div class="color-option" style="background-color: #800000;" data-color="#800000"></div>
                        <div class="color-option" style="background-color: #000080;" data-color="#000080"></div>
                        <div class="color-option" style="background-color: #ffffff;" data-color="#ffffff"></div>
                        <div class="color-option" style="background-color: #f0e6d2;" data-color="#f0e6d2"></div>
                        <div class="color-option" style="background-color: #ffc0cb;" data-color="#ffc0cb"></div>
                        <div class="color-option" style="background-color: #006400;" data-color="#006400"></div>
                        <div class="color-option" style="background-color: #ff0000;" data-color="#ff0000"></div>
                        <div class="color-option" style="background-color: #808080;" data-color="#808080"></div>
                    </div>
                </div>
            </div>
        </div>

        <button id="anotacoes-btn">Anota√ß√µes</button>
        <textarea id="anotacoes-textarea" placeholder="Suas anota√ß√µes aqui..."></textarea>

        <button id="historico-dados-btn">Hist√≥rico de dados</button>
        <div id="historico-dados-panel">
            <h3>Hist√≥rico de Dados</h3>
            <div id="historico-lista"></div>
            <button id="excluir-historico-btn">Excluir hist√≥rico</button>
        </div>

        <div id="vantagens-desvantagens-panel">
            <h2>Vantagens e Desvantagens</h2>
            <div>Pontos de Vantagem Tempor√°rios: <span id="ph-temp">0</span></div>
            <div id="vantagens-list"></div>
            <div id="desvantagens-list"></div>
            <button id="salvar-vantagens-btn">SALVAR</button>
            <button id="fechar-pagina-btn">Fechar P√°gina</button>
        </div>

        <div id="racas-panel">
            <h2>Ra√ßas</h2>
            <div id="racas-list"></div>
            <button id="salvar-racas-btn">SALVAR</button>
            <button id="fechar-racas-btn">Fechar P√°gina</button>
        </div>

        <div id="classes-panel">
            <h2>Classes</h2>
            <button id="fechar-classes-btn">Fechar P√°gina</button>
        </div>

        <div id="nome-ficha-modal" class="modal">
            <div class="modal-content">
                <h3>D√™ um Nome √† Ficha</h3>
                <input type="text" id="nome-ficha-input" placeholder="Nome da ficha" maxlength="20">
                <button class="confirm-btn" onclick="criarNovaFicha()">Confirmar</button>
                <button class="cancel-btn" onclick="fecharModal('nome-ficha-modal')">Cancelar</button>
            </div>
        </div>

        <div id="bloquear-ficha-modal" class="modal">
            <div class="modal-content">
                <h3>Ponha sua Senha de 4 D√≠gitos</h3>
                <input type="password" id="senha-bloqueio-input" placeholder="Senha (4 d√≠gitos)" maxlength="4">
                <button class="confirm-btn" onclick="bloquearFicha()">Confirmar</button>
                <button class="cancel-btn" onclick="fecharModal('bloquear-ficha-modal')">Cancelar</button>
            </div>
        </div>

        <div id="password-modal" class="modal">
            <div class="modal-content">
                <h3>Digite sua Senha</h3>
                <input type="password" id="senha-desbloqueio-input" placeholder="Senha (4 d√≠gitos)" maxlength="4">
                <button class="confirm-btn" onclick="desbloquearFicha()">Confirmar</button>
                <button class="cancel-btn" onclick="cancelarDesbloqueio()">Cancelar</button>
            </div>
        </div>

        <div id="confirmar-compra-modal" class="modal">
            <div class="modal-content">
                <h3>Tem certeza que quer comprar
                    isso?</h3>
                <button class="confirm-btn" id="confirmar-compra-btn">Sim</button>
                <button class="cancel-btn" onclick="fecharModal('confirmar-compra-modal')">N√£o</button>
            </div>
        </div>

        <div id="salvar-vantagens-modal" class="modal">
            <div class="modal-content">
                <h3>Se salvar, as altera√ß√µes n√£o poder√£o ser desfeitas.</h3>
                <button class="confirm-btn" id="confirmar-salvar-vantagens-btn">OK</button>
                <button class="cancel-btn"
                    onclick="fecharModal('salvar-vantagens-modal')">Cancelar</button>
            </div>
        </div>

        <div id="senha-gm-modal" class="modal">
            <div class="modal-content">
                <h3>Pe√ßa permiss√£o ao GM</h3>
                <input type="password" id="senha-gm-input" placeholder="Senha GM">
                <button class="confirm-btn" id="confirmar-senha-gm-btn">Confirmar</button>
                <button class="cancel-btn" onclick="fecharModal('senha-gm-modal')">Cancelar</button>
            </div>
        </div>

        <div id="raca-opcoes-modal" class="modal">
            <div class="modal-content">
                <h3>O que voc√™ deseja fazer?</h3>
                <button class="confirm-btn" onclick="excluirRacaSelecionadaModal()">Excluir Ra√ßa</button>
                <button class="confirm-btn" onclick="editarRacaSelecionadaModal()" style="margin-top: 10px;">Editar Ra√ßa</button>
                <button class="cancel-btn" onclick="fecharModal('raca-opcoes-modal')">Cancelar</button>
            </div>
        </div>

        <div id="editar-raca-modal" class="modal">
            <div class="modal-content">
                <h3>Editar Ra√ßa</h3>
                <label for="editar-raca-nome">Nome:</label>
                <input type="text" id="editar-raca-nome">
                <label for="editar-raca-descricao">Descri√ß√£o:</label>
                <textarea id="editar-raca-descricao"></textarea>
                <button class="confirm-btn" onclick="salvarEdicaoRaca()">Salvar</button>
                <button class="cancel-btn" onclick="fecharModal('editar-raca-modal')">Cancelar</button>
            </div>
        </div>

        <div id="chat-password-modal" class="modal">
            <div class="modal-content">
                <h3>Definir Senha do Chat</h3>
                <input type="password" id="chat-senha-input" placeholder="Senha do Chat">
                <input type="password" id="chat-confirmar-senha-input" placeholder="Confirmar Senha">
                <button class="confirm-btn" onclick="definirSenhaChat()">Confirmar</button>
                <button class="cancel-btn" onclick="fecharModal('chat-password-modal')">Cancelar</button>
            </div>
        </div>

        <div id="open-chat-modal" class="modal">
            <div class="modal-content">
                <h3>Digite a Senha do Chat</h3>
                <input type="password" id="abrir-chat-senha-input" placeholder="Senha do Chat">
                <button class="confirm-btn" onclick="abrirChat()">Confirmar</button>
                <button class="cancel-btn" onclick="fecharModal('open-chat-modal')">Cancelar</button>
            </div>
        </div>

        <div id="chat-modal" class="modal">
            <div class="modal-content">
                <div class="chat-header">
                    Chat Privado
                </div>
                <div class="chat-body">
                    <div class="user-list">
                        <h4>Fichas Online</h4>
                        <div id="available-fichas">
                        </div>
                    </div>
                    <div class="conversation" id="conversation-area">
                    </div>
                </div>
                <div class="chat-input">
                    <input type="text" id="mensagem-input" placeholder="Digite sua mensagem...">
                    <button onclick="enviarMensagem()">Enviar</button>
                </div>
                <button class="cancel-btn" onclick="fecharModal('chat-modal')">Fechar Chat</button>
            </div>
        </div>

        <div id="notification"></div>

        <audio id="new-message-sound" preload="auto">
            <source src="notification_sound.mp3" type="audio/mpeg">
        </audio>

        <div id="background-modal" class="modal">
            <div class="modal-content">
                <h3>Plano de Fundo</h3>
                <label for="background-image-input">Selecionar Imagem:</label>
                <input type="file" id="background-image-input" accept="image/*">

                <div class="radio-group">
                    <label><input type="radio" name="background-size" value="cover" checked>Preencher Tela</label>
                    <label><input type="radio" name="background-size" value="100% 100%">Estender</label>
                    <label><input type="radio" name="background-size" value="auto">Tamanho Normal</label>
                </div>

                <button class="confirm-btn" onclick="aplicarPlanoDeFundo()">Aplicar</button>
                <button class="cancel-btn" onclick="fecharModal('background-modal')">Cancelar</button>
                <button class="cancel-btn" onclick="excluirPlanoDeFundo()">Excluir Imagem</button>
            </div>
        </div>

        <script>
            const firebaseConfig = {
                apiKey: "AIzaSyBbbwbwPXv6gztkyP3TXK-DtooEI7FcClI",
                authDomain: "ficha-de-rpg-b9685.firebaseapp.com",
                databaseURL: "https://ficha-de-rpg-b9685-default-rtdb.firebaseio.com",
                projectId: "ficha-de-rpg-b9685",
                storageBucket: "ficha-de-rpg-b9685.firebasestorage.app",
                messagingSenderId: "528610398062",
                appId: "1:528610398062:web:8fdb9cfd5ded8167613b7f"
            };
            firebase.initializeApp(firebaseConfig);

            const database = firebase.database();

            let fichas = {},
                currentFichaId = null,
                isFichaLocked = false,
                fichaPassword = null,
                isFichaUnlocked = false,
                senhaMatriz = "1040",
                vantagensSelecionadas = [],
                desvantagensSelecionadas = [],
                tempVantagensSelecionadas = [],
                tempDesvantagensSelecionadas = [],
                racaSelecionada = null,
                tempRacaSelecionada = null,
                vidaTotal,
                vidaAtual,
                magiaTotal,
                magiaAtual,
                vigorTotal,
                vigorAtual,
                previousValues = new Map(),
                chatPassword = null,
                isChatOpen = false,
                selectedChatUser = null;
            const vantagensData = [{
                nome: "Maestria com Armas curtas (2)",
                custo: 2,
                descricao: "Adiciona +1 em ataque, +1 em acerto com armas curtas."
            }, {
                nome: "Maestria com armas pesadas (2)",
                custo: 2,
                descricao: "Adiciona +2 em ataque com armas pesadas."
            }, {
                nome: "Maestria com armas de longo alcance (2)",
                custo: 2,
                descricao: "Adiciona +2 em acerto com armas de longo alcance."
            }, {
                nome: "Furtar (2)",
                custo: 2,
                descricao: "+4 em testes de furto."
            }, {
                nome: "L√°bia (2)",
                custo: 2,
                descricao: "+5 em testes de l√°bia."
            }, {
                nome: "Velejar (1)",
                custo: 1,
                descricao: ""
            }, {
                nome: "Beleza (1)",
                custo: 1,
                descricao: "Aumenta em +3 o teste em l√°bia, paquera e persuas√£o."
            }, {
                nome: "Boa Fama (2)",
                custo: 2,
                descricao: "Aumenta em +4 chance de descontos em armamentos, pousadas, alimentos, etc."
            }, {
                nome: "Arremedo (2)",
                custo: 2,
                descricao: "Capacidade de imitar qualquer som SIMPLES."
            }, {
                nome: "Destemor (1)",
                custo: 1,
                descricao: "Dificilmente √© assustado por algo."
            }, {
                nome: "Empatia (3)",
                custo: 3,
                descricao: "Sensibilidade extraordin√°ria em rela√ß√£o aos outras pessoas. √â um talento excelente para identificar impostores, possess√µes por espirito, etc."
            }, {
                nome: "Empatia com animais (1)",
                custo: 1,
                descricao: "Pode compreender as motiva√ß√µes dos animais."
            }, {
                nome: "Patrono (4)",
                custo: 4,
                descricao: "Possui um mentor/mestre/professor, at√© mesmo uma organiza√ß√£o/guilda que pode lhe oferecer ajuda."
            }, {
                nome: "Reconhecimento Social (2)",
                custo: 2,
                descricao: "√â membro de uma ra√ßa, classe, sexo ou grupo muito respeitado, temido ou venerado pela sociedade. Adiciona +2 pontos o teste em l√°bia, paquera e persuas√£o."
            }, {
                nome: "Riqueza (2)",
                custo: 2,
                descricao: "Inicia com 20 moedas de ouro."
            }, {
                nome: "Aptid√£o para magia (4)",
                custo: 4,
                descricao: "Adiciona 15% a mais de dano e gasta 15% a menos de magia para toda vez que usa a magia que voc√™ tem aptid√£o."
            }, {
                nome: "Combo F√≠sico (4)",
                custo: 4,
                descricao: "Essa vantagem lhe concede come√ßar sua locomo√ß√£o com 50km velocidade corrida, pulo de 3 metros de altura e 9 metros de dist√¢ncia.",
                restricao: "inicio"
            }, {
                nome: "Nadar (1)",
                custo: 1,
                descricao: ""
            }, {
                nome: "Escalar (2)",
                custo: 2,
                descricao: ""
            }, {
                nome: "Segunda l√≠ngua (1)",
                custo: 1,
                descricao: "Fala mais um idioma."
            }, {
                nome: "Paquerador (2)",
                custo: 2,
                descricao: "Adiciona +4 em teste para paquera e persuas√£o envolvendo flerte."
            }, {
                nome: "Senso de perigo (5)",
                custo: 5,
                descricao: "Sempre que houver algo grave para ocorrer o mestre do RPG pedir√° pra voc√™ jogar um dado para reagir."
            }, {
                nome: "Acrobata (3)",
                custo: 3,
                descricao: "Adiciona + fama ao lutar em p√∫blico."
            }, {
                nome: "Equil√≠brio Perfeito (3)",
                custo: 3,
                descricao: "Adiciona +8 em testes de equil√≠brio."
            }, {
                nome: "Tecnologia (2)",
                custo: 2,
                descricao: "Voc√™ √© engenhoso, pode inventar coisas, criar objetos improvisados."
            }, {
                nome: "Poder Oculto (7)",
                custo: 7,
                descricao: "Quando sua vida estiver em 10%, voc√™ ativa o poder oculto aumentando todos seus atributos em 50%. Mas a partir do momento em que sua vida sai dos 10%, os atributos voltam ao normal."
            }, {
                nome: "Sobreviv√™ncia em floresta (2)",
                custo: 2,
                descricao: "Tem facilidade para achar cavernas, criar assentamentos, barracas, achar comida e gravar caminhos no meio da floresta. Facilidade para achar √°gua, etc."
            }];

            const desvantagensData = [{
                nome: "Fobia (+2)",
                ganho: 2,
                descricao: "Voc√™ tem um medo irracional de algo espec√≠fico."
            }, {
                nome: "M√° Fama (+2)",
                ganho: 2,
                descricao: "Voc√™ √© mal visto pela sociedade, dificultando intera√ß√µes sociais."
            }, {
                nome: "Alcoolismo (+2)",
                ganho: 2,
                descricao: "Voc√™ tem uma depend√™ncia de √°lcool que afeta suas decis√µes."
            }, {
                nome: "Altru√≠smo (+2)",
                ganho: 2,
                descricao: "Se sacrifica por outras pessoas e pouco se importa com fama ou riqueza."
            }, {
                nome: "Avareza (+2)",
                ganho: 2,
                descricao: "Preocupa√ß√£o permanente na conserva√ß√£o de riquezas."
            }, {
                nome: "Bullying (+3)",
                ganho: 3,
                descricao: "Gosta de ca√ßoar, agredir, denegrir, difamar e apontar defeitos tanto em amigos quanto inimigos."
            }, {
                nome: "Circunspe√ß√£o (+2)",
                ganho: 2,
                descricao: "N√£o entende piadas, entende tudo de forma literal e acredita que todos est√£o sempre falando s√©rio."
            }, {
                nome: "Compuls√µes (+3)",
                ganho: 3,
                descricao: "H√°bito ou v√≠cio que toma boa parte dos seus recursos e tempo."
            }, {
                nome: "Covardia (+2)",
                ganho: 2,
                descricao: "Tem extremo cuidado com seu bem-estar f√≠sico e dificuldade em assumir riscos."
            }, {
                nome: "Dependentes (+4)",
                ganho: 4,
                descricao: "Possui algu√©m que depende de voc√™ a todo momento (filhos, parentes, entes queridos, etc.)."
            }, {
                nome: "F√∫ria (+2)",
                ganho: 2,
                descricao: "Tend√™ncia a perder o controle e partir para um ataque fren√©tico, ativado por dano, insulto ou aleatoriamente."
            }, {
                nome: "Honestidade (+3)",
                ganho: 3,
                descricao: "N√£o consegue mentir ou omitir, sempre fala a verdade e desmascara mentiras."
            }, {
                nome: "Impulsividade (+2)",
                ganho: 2,
                descricao: "Sempre age sem pensar."
            }, {
                nome: "Lux√∫ria (+2)",
                ganho: 2,
                descricao: "Desejo incontrol√°vel por romance."
            }, {
                nome: "Magnetismo Sobrenatural (+2)",
                ganho: 2,
                descricao: "Coisas estranhas acontecem com seu personagem em um n√≠vel alarmante."
            }, {
                nome: "No Limite (+4)",
                ganho: 4,
                descricao: "Assume riscos extremamente irracionais diante de perigo mortal (ex.: enfrentar um boss sozinho)."
            }, {
                nome: "Teimosia (+1)",
                ganho: 1,
                descricao: "Quer sempre fazer as coisas do seu modo e n√£o segue planos que n√£o sejam seus."
            }, {
                nome: "Amn√©sia (+2)",
                ganho: 2,
                descricao: "Em certos momentos, n√£o consegue lembrar de coisas importantes."
            }];

            let racasData = [{
                nome: "Humano (3)",
                custo: 3,
                descricao: "Os humanos s√£o vers√°teis, ambiciosos e mestres em se adaptar a qualquer situa√ß√£o. Suas vantagens refletem uma capacidade excepcional de prosperar em qualquer ambiente.",
                vantagens: ["Explorador Nato: Come√ßam com um cavalo de ra√ßa superior (mais r√°pido e resistente), equipamentos de montaria completos (selas, suprimentos para semanas) e um mapa detalhado de uma regi√£o inicial √† escolha, permitindo explorar √°reas distantes com facilidade e seguran√ßa.", "Mestre das Profiss√µes: Escolhem uma profiss√£o com benef√≠cios. Ferreiro Lend√°rio: Criam armas e armaduras com 5 pontos de qualidade automaticamente e podem forjar itens com propriedades √∫nicas (ex.: espada que brilha ao detectar inimigos). Costureiro Arcano: Produzem vestimentas leves ou armaduras com resist√™ncia a dois elementos (ex.: fogo e gelo) e b√¥nus de regenera√ß√£o passiva de energia ou vida. Arquiteto Vision√°rio: Constroem estruturas permanentes em metade do tempo e com o dobro da resist√™ncia, podendo criar bases estrat√©gicas com defesas embutidas (ex.: torres de vigia).", "Rede de Influ√™ncia: Iniciam com uma rede de contatos: um aliado influente (guildas, mercadores ou l√≠deres locais) oferecendo acesso a informa√ß√µes secretas ou at√© interven√ß√£o em conflitos.", "Determina√ß√£o Inabal√°vel: Uma vez por dia, podem ignorar completamente uma situa√ß√£o de desvantagem (ex.: exaust√£o, ferimento grave ou efeito m√°gico negativo), agindo como se estivessem em plena capacidade por um curto per√≠odo."]
            }, {
                nome: "Elfo (4)",
                custo: 4,
                descricao: "Os elfos s√£o s√°bios, m√°gicos e profundamente conectados ao mundo natural.\nSuas vantagens agora destacam sua supremacia m√°gica e harmonia com a natureza.",
                vantagens: ["Sabedoria Ancestral: Dominam uma √°rea de conhecimento (ex.: arcana, hist√≥ria, natureza) com maestria, podendo decifrar pergaminhos, ru√≠nas ou magias antigas automaticamente, e aprendem 1 l√≠nguas extra.", "Vis√£o √âlfica Suprema: Enxergam no escuro at√© 10 metros, detectam magias fracas em um raio de 20 metros e percebem inten√ß√µes hostis em seres vivos com um teste muito dif√≠cil, 19 ou +.", "Escudo M√°gico: Ganham resist√™ncia inata a um tipo de efeito magico hostil (n√£o apenas encantamentos), reduzindo o dano ou a dura√ß√£o desses efeitos em 50%, refletindo sua ess√™ncia m√°gica."]
            }, {
                nome: "An√£o (4)",
                custo: 4,
                descricao: "Os an√µes s√£o resilientes, habilidosos e ligados √† terra.\nSuas vantagens agora enfatizam sua supremacia em crafting e sobreviv√™ncia em condi√ß√µes extremas.",
                vantagens: ["Fortitude Indom√°vel: Trabalham por 3 dias sem descanso, ignorando efeitos de fadiga, e recuperam vida e energia ao dormir em ambientes rochosos ou subterr√¢neos duas vezes mais r√°pido.", "Artes√£o: Escolhem uma especializa√ß√£o com impacto massivo: Mestre Minerador: Identificam e extraem recursos raros (ex.: mithril) com o dobro da velocidade e podem abrir t√∫neis tempor√°rios em rochas s√≥lidas com ferramentas improvisadas.\nForjador de Lendas: Produzem armas e armaduras com 10 pontos de qualidade e propriedades m√°gicas tempor√°rias (ex.: arma que causa dano elemental extra), al√©m de reparar itens quebrados durante um curto periodo de tempo (1 a 2 dias).\nJoalheiro Divino: Criam artefatos que armazenam magias moderadas (ex.: um anel que lan√ßa uma bola de fogo uma vez por dia) ou concedem b√¥nus Tempor√°rios a atributos (ex.: +1 for√ßa).", "Senhor das Profundezas: Nunca se perdem em ambientes subterr√¢neos, detectam armadilhas (naturais ou artificiais) automaticamente e podem sentir vibra√ß√µes no solo para prever emboscadas ou colapsos."]
            }, {
                nome: "Orc (3)",
                custo: 3,
                descricao: "Os orcs s√£o guerreiros feroces e l√≠deres carism√°ticos pela for√ßa.\nSuas vantagens agora amplificam sua presen√ßa intimidadora e poder bruto.",
                vantagens: ["Lenda entre Guerreiros: Inspiram temor e respeito em qualquer cultura que valorize for√ßa, garantindo alian√ßas com fac√ß√µes marciais e acesso a miss√µes √©picas;\ninimigos menores fogem automaticamente em sua presen√ßa (teste dif√≠cil, 16 ou +).", "Resili√™ncia Brutal: Lutam sem penalidades mesmo com ferimentos graves e s√≥ caem quando atingem PV 0, al√©m de regenerarem ferimentos leves passivamente fora de combate.", "Dom√≠nio da Intimida√ß√£o: Podem for√ßar inimigos a se renderem ou recuarem com um grito poderoso uma vez por encontro, afetando grupos inteiros, e ganham b√¥nus massivos em negocia√ß√µes baseadas em for√ßa ou medo.", "F√∫ria Ancestral: Entram em um estado de f√∫ria duas vezes por dia, duplicando for√ßa e resist√™ncia por um curto per√≠odo."]
            }, {
                nome: "Meio Animal (Selvagem) (4)",
                custo: 4,
                descricao: "Os meio animais combinam instinto primal com ast√∫cia.\nSuas vantagens agora os tornam mestres da sobreviv√™ncia e predadores supremos.",
                vantagens: ["Sentidos Predat√≥rios: Pode escolher um sentido agu√ßado de acordo com sua parte animal.\n(vis√£o, olfato, audi√ß√£o), permitindo rastrear alvos a quil√¥metros, detectar inimigos invis√≠veis e evitar qualquer surpresa com um teste moderado, 12 ou +.", "Senhor dos Terrenos: Adaptam-se completamente a um ambiente (ex.: floresta, deserto, p√¢ntano), ignorando todos os efeitos negativos e ganhando b√¥nus de movimento e furtividade nesses locais.\nb√¥nus +1.", "Frenesi Instintivo: Uma vez por dia, canalizam seus instintos para ganhar velocidade sobrenatural (dobro de movimento), ataques adicionais e uma percep√ß√£o quase premonit√≥ria de perigos, tornando-os ca√ßadores ou fugitivos imbat√≠veis por um curto per√≠odo (10 min)."]
            }];

            function criarFichaMatriz() {
                const fichaId = "ficha-matriz";
                const fichaMatriz = {
                    nomeFicha: "Matriz",
                    nomePersonagem: "Personagem Matriz",
                    descricaoPersonagem: "Ficha original do sistema",
                    forca: "0",
                    destreza: "0",
                    agilidade: "0",
                    inteligencia: "0",
                    constituicao: "0",
                    experiencia: "0",
                    armaDireitaNome: "",
                    armaDireitaAtaque: "0",
                    armaDireitaAtaqueMagico: "0",
                    armaEsquerdaNome: "",
                    armaEsquerdaAtaque: "0",
                    armaEsquerdaAtaqueMagico: "0",
                    vantagens: "",
                    magiasHabilidades: "",
                    desvantagens: "",
                    inventario: Array(10).fill({
                        item: "",
                        peso: "0"
                    }),
                    velocidadeCorrida: "25",
                    alturaPulo: "1",
                    distanciaPulo: "3",
                    isLocked: true,
                    password: senhaMatriz,
                    imagem: null,
                    anotacoes: "",
                    classeNome: "",
                    classeDescricao: "",
                    racaNome: "",
                    racaDescricao: "",
                    racaSelecionada: "",
                    chatPassword: null, // Adicionado campo para a senha do chat
                    backgroundImage: null, // Adicionado campo para a imagem de fundo
                    backgroundSize: 'cover', // Adicionado campo para o tamanho da imagem de fundo
                    backgroundColor: '#f0e6d2' // Adicionado campo para a cor de fundo
                };
                database.ref("fichas/ficha-matriz").once("value", snapshot => {
                    if (snapshot.exists()) {
                        currentFichaId = fichaId;
                        carregarFicha(fichaId);
                        carregarFichas();
                        aplicarPlanoDeFundoInicial();
                        aplicarCorDeFundoInicial();
                    } else {
                        database.ref(`fichas/${fichaId}`).set(fichaMatriz).then(() => {
                            currentFichaId = fichaId;
                            carregarFicha(fichaId);
                            aplicarPlanoDeFundoInicial();
                            aplicarCorDeFundoInicial();
                        });
                    }
                });
            }

            function carregarFichas() {
                database.ref("fichas").on("value", snapshot => {
                    fichas = snapshot.val() || {};
                    if (fichas["ficha-matriz"]) {
                        atualizarAbasFichas();
                        atualizarListaFichasChat();
                        verificarNovasMensagens();
                    } else {
                        criarFichaMatriz();
                    }
                });
            }

            function atualizarAbasFichas() {
                const sidebar = document.getElementById("fichas-sidebar");
                const addBtn = document.getElementById("add-ficha-btn");

                while (sidebar.children.length > 1) {
                    sidebar.removeChild(sidebar.children[0]);
                }

                for (let fichaId in fichas) {
                    if (fichaId !== "ficha-matriz") {
                        const tab = document.createElement("div");
                        tab.className = "ficha-tab";
                        const span = document.createElement("span");
                        span.textContent = fichas[fichaId].nomeFicha || "Sem Nome";
                        tab.appendChild(span);
                        tab.dataset.fichaId = fichaId;
                        if (fichaId === currentFichaId) tab.classList.add("active");

                        tab.onclick = () => {
                            currentFichaId = fichaId;
                            carregarFicha(fichaId);
                            atualizarAbasFichas();
                            atualizarListaFichasChat();
                            verificarNovasMensagens();
                        };

                        sidebar.insertBefore(tab, addBtn);
                    }
                }
            }

            document.getElementById("add-ficha-btn").onclick = () => {
                document.getElementById("nome-ficha-modal").style.display = "flex";
                document.getElementById("nome-ficha-input").value = "";
                document.getElementById("nome-ficha-input").focus();
            };

            function criarNovaFicha() {
                const nomeFicha = document.getElementById("nome-ficha-input").value.trim();
                if (!nomeFicha) return alert("Por favor, d√™ um nome √† ficha!");

                const novaFichaId = database.ref("fichas").push().key;
                const novaFicha = {
                    nomeFicha,
                    nomePersonagem: "",
                    descricaoPersonagem: "",
                    forca: "0",
                    destreza: "0",
                    agilidade: "0",
                    inteligencia: "0",
                    constituicao: "0",
                    experiencia: "0",
                    armaDireitaNome: "",
                    armaDireitaAtaque: "0",
                    armaDireitaAtaqueMagico: "0",
                    armaEsquerdaNome: "",
                    armaEsquerdaAtaque: "0",
                    armaEsquerdaAtaqueMagico: "0",
                    vantagens: "",
                    magiasHabilidades: Array(10).fill("").join("\n"),
                    desvantagens: "",
                    inventario: Array(10).fill({
                        item: "",
                        peso: "0"
                    }),
                    velocidadeCorrida: "25",
                    alturaPulo: "1",
                    distanciaPulo: "3",
                    isLocked: false,
                    password: null,
                    imagem: null,
                    anotacoes: "",
                    classeNome: "",
                    classeDescricao: "",
                    racaNome: "",
                    racaDescricao: "",
                    racaSelecionada: "",
                    chatPassword: null,
                    backgroundImage: null,
                    backgroundSize: 'cover',
                    backgroundColor: '#f0e6d2'
                };
                database.ref(`fichas/${novaFichaId}`).set(novaFicha).then(() => {
                    currentFichaId = novaFichaId;
                    carregarFicha(novaFichaId);
                    fecharModal("nome-ficha-modal");
                    atualizarAbasFichas();
                    atualizarListaFichasChat();
                }).catch(error => console.error("Erro ao criar nova ficha:", error));
            }

            function fecharModal(modalId) {
                document.getElementById(modalId).style.display = "none";
            }

            const nomePersonagemInput = document.getElementById("nome-personagem"),
                descricaoPersonagemInput = document.getElementById("descricao-personagem"),
                forcaInput = document.getElementById("forca"),
                destrezaInput = document.getElementById("destreza"),
                agilidadeInput = document.getElementById("agilidade"),
                inteligenciaInput = document.getElementById("inteligencia"),
                constituicaoInput = document.getElementById("constituicao"),
                ataqueSpan = document.getElementById("ataque"),
                ataqueMagicoSpan = document.getElementById("ataque-magico"),
                acertoSpan = document.getElementById("acerto"),
                esquivaSpan = document.getElementById("esquiva"),
                rdfSpan = document.getElementById("rdf"),
                rdmSpan = document.getElementById("rdm"),
                armaDireitaNomeInput = document.getElementById("arma-direita-nome"),
                armaDireitaAtaqueInput = document.getElementById("arma-direita-ataque"),
                armaDireitaAtaqueMagicoInput = document.getElementById("arma-direita-ataque-magico"),
                armaEsquerdaNomeInput = document.getElementById("arma-esquerda-nome"),
                armaEsquerdaAtaqueInput = document.getElementById("arma-esquerda-ataque"),
                armaEsquerdaAtaqueMagicoInput = document.getElementById("arma-esquerda-ataque-magico"),
                resetPontosButton = document.getElementById("reset-pontos"),
                recomecarButton = document.getElementById("recomecar"),
                bloquearFichaButton = document.getElementById("bloquear-ficha"),
                experienciaInput = document.getElementById("experiencia"),
                nivelSpan = document.getElementById("nivel"),
                pontosHabilidadeSpan = document.getElementById("pontos-habilidade"),
                pontosVantagemSpan = document.getElementById("pontos-vantagem"),
                velocidadeCorridaSpan = document.getElementById("velocidade-corrida"),
                alturaPuloSpan = document.getElementById("altura-pulo"),
                distanciaPuloSpan = document.getElementById("distancia-pulo"),
                nomePersonagemTitulo = document.getElementById("nome-personagem-titulo"),
                gameMasterMessage = document.getElementById("game-master-message"),
                vantagensListDisplay = document.getElementById("vantagens-list-display"),
                desvantagensListDisplay = document.getElementById("desvantagens-list-display"),
                inventarioSlots = document.getElementById("inventario-slots"),
                pesoTotalSpan = document.getElementById("peso-total"),
                diceContainer = document.getElementById("dice-container"),
                diceRoll = document.getElementById("dice-roll"),
                diceResult = document.getElementById("dice-result"),
                notification = document.getElementById("notification"),
                characterImageInput = document.getElementById("character-image-input"),
                characterImage = document.getElementById("character-image"),
                vantagensDesvantagensBtn = document.getElementById("vantagens-desvantagens-btn"),
                vantagensDesvantagensPanel = document.getElementById("vantagens-desvantagens-panel"),
                vantagensList = document.getElementById("vantagens-list"),
                desvantagensList = document.getElementById("desvantagens-list"),
                salvarVantagensBtn = document.getElementById("salvar-vantagens-btn"),
                fecharPaginaBtn = document.getElementById("fechar-pagina-btn"),
                fichaContainer = document.getElementById("ficha-container"),
                magiasList = document.getElementById("magias-list"),
                adicionarMagiaBtn = document.getElementById("adicionar-magia-btn"),
                anotacoesBtn = document.getElementById("anotacoes-btn"),
                anotacoesTextarea = document.getElementById("anotacoes-textarea"),
                racasBtn = document.getElementById("racas-btn"),
                classesBtn = document.getElementById("classes-btn"),
                racasPanel = document.getElementById("racas-panel"),
                classesPanel = document.getElementById("classes-panel"),
                fecharRacasBtn = document.getElementById("fechar-racas-btn"),
                fecharClassesBtn = document.getElementById("fechar-classes-btn"),
                classeNomeInput = document.getElementById("classe-nome"),
                classeDescricaoInput = document.getElementById("classe-descricao"),
                racaNomeSpan = document.getElementById("raca-nome"),
                racaDescricaoInput = document.getElementById("raca-descricao"),
                luaBtn = document.getElementById("lua-btn"),
                solBtn = document.getElementById("sol-btn"),
                salvarRacasBtn = document.getElementById("salvar-racas-btn"),
                racasList = document.getElementById("racas-list"),
                atributosInputs = [forcaInput, destrezaInput, agilidadeInput, inteligenciaInput, constituicaoInput],
                chatBtn = document.getElementById("chat-btn"),
                availableFichasDiv = document.getElementById("available-fichas"),
                conversationAreaDiv = document.getElementById("conversation-area"),
                mensagemInput = document.getElementById("mensagem-input"),
                newMessageSound = document.getElementById("new-message-sound"),
                planoFundoBtn = document.getElementById("plano-fundo-btn"),
                backgroundImageInput = document.getElementById("background-image-input"),
                backgroundModal = document.getElementById("background-modal"),
                corFundoBtn = document.getElementById("cor-fundo-btn"),
                backgroundColorSelector = document.getElementById("background-color-selector");
            let nivel = 0,
                nivelAnterior = 0,
                pontosHabilidadeTotal = 25,
                pontosHabilidadeUsados = 0,
                experiencia = 0,
                vidaBase = 50;
            const nivelData = [{
                nivel: 0,
                xp: 0,
                pd: 25,
                ph: 8
            }, {
                nivel: 1,
                xp: 10,
                pd: 31,
                ph: 9
            }, {
                nivel: 2,
                xp: 30,
                pd: 37,
                ph: 10
            }, {
                nivel: 3,
                xp: 60,
                pd: 43,
                ph: 11
            }, {
                nivel: 4,
                xp: 100,
                pd: 49,
                ph: 12
            }, {
                nivel: 5,
                xp: 150,
                pd: 55,
                ph: 13
            }, {
                nivel: 6,
                xp: 210,
                pd: 61,
                ph: 14
            }, {
                nivel: 7,
                xp: 280,
                pd: 67,
                ph: 15
            }, {
                nivel: 8,
                xp: 360,
                pd: 73,
                ph: 16
            }, {
                nivel: 9,
                xp: 450,
                pd: 79,
                ph: 17
            }, {
                nivel: 10,
                xp: 550,
                pd: 85,
                ph: 18
            }, {
                nivel: 11,
                xp: 670,
                pd: 91,
                ph: 19
            }, {
                nivel: 12,
                xp: 810,
                pd: 97,
                ph: 20
            }, {
                nivel: 13,
                xp: 970,
                pd: 103,
                ph: 21
            }, {
                nivel: 14,
                xp: 1150,
                pd: 109,
                ph: 22
            }, {
                nivel: 15,
                xp: 1350,
                pd: 115,
                ph: 23
            }, {
                nivel: 16,
                xp: 1570,
                pd: 121,
                ph: 24
            }, {
                nivel: 17,
                xp: 1810,
                pd: 127,
                ph: 25
            }, {
                nivel: 18,
                xp: 2070,
                pd: 133,
                ph: 26
            }, {
                nivel: 19,
                xp: 2350,
                pd: 139,
                ph: 27
            }, {
                nivel: 20,
                xp: 2650,
                pd: 145,
                ph: 28
            }, {
                nivel: 21,
                xp: 2980,
                pd: 148,
                ph: 29
            }, {
                nivel: 22,
                xp: 3340,
                pd: 151,
                ph: 30
            }, {
                nivel: 23,
                xp: 3730,
                pd: 154,
                ph: 31
            }, {
                nivel: 24,
                xp: 4150,
                pd: 157,
                ph: 32
            }, {
                nivel: 25,
                xp: 4600,
                pd: 160,
                ph: 33
            }, {
                nivel: 26,
                xp: 5080,
                pd: 163,
                ph: 34
            }, {
                nivel: 27,
                xp: 5590,
                pd: 166,
                ph: 35
            }, {
                nivel: 28,
                xp: 6130,
                pd: 169,
                ph: 36
            }, {
                nivel: 29,
                xp: 8000,
                pd: 219,
                ph: 37
            }, {
                nivel: 30,
                xp: 10000,
                pd: 319,
                ph: 38
            }];

            function carregarFicha(fichaId) {
                if (!fichas[fichaId]) return;
                const ficha = fichas[fichaId];

                nomePersonagemInput.value = ficha.nomePersonagem || "";
                descricaoPersonagemInput.value = ficha.descricaoPersonagem || "";
                forcaInput.value = ficha.forca || "0";
                destrezaInput.value = ficha.destreza || "0";
                agilidadeInput.value = ficha.agilidade || "0";
                inteligenciaInput.value = ficha.inteligencia || "0";
                constituicaoInput.value = ficha.constituicao || "0";
                experienciaInput.value = ficha.experiencia || "0";
                armaDireitaNomeInput.value = ficha.armaDireitaNome || "";
                armaDireitaAtaqueInput.value = ficha.armaDireitaAtaque || "0";
                armaDireitaAtaqueMagicoInput.value = ficha.armaDireitaAtaqueMagico || "0";
                armaEsquerdaNomeInput.value = ficha.armaEsquerdaNome || "";
                armaEsquerdaAtaqueInput.value = ficha.armaEsquerdaAtaque || "0";
                armaEsquerdaAtaqueMagicoInput.value = ficha.armaEsquerdaAtaqueMagico || "0";

                velocidadeCorridaSpan.textContent = ficha.velocidadeCorrida || "25";
                alturaPuloSpan.textContent = ficha.alturaPulo || "1";
                distanciaPuloSpan.textContent = ficha.distanciaPulo || "3";

                isFichaLocked = ficha.isLocked || false;
                fichaPassword = ficha.password || null;
                isFichaUnlocked = false;

                vantagensSelecionadas = ficha.vantagens ? ficha.vantagens.split("\n").filter(v => v.trim()) : [];
                desvantagensSelecionadas = ficha.desvantagens ?
                    ficha.desvantagens.split("\n").filter(d => d.trim()) : [];

                racaSelecionada = ficha.racaSelecionada || "";
                racaNomeSpan.textContent = racaSelecionada.split(" (")[0];
                racaDescricaoInput.value = racasData.find(r => r.nome === racaSelecionada)?.vantagens.join("\n\n") || "";

                vantagensListDisplay.innerHTML = "";
                desvantagensListDisplay.innerHTML = "";

                vantagensSelecionadas.forEach(v => {
                    const div = document.createElement("div");
                    div.textContent = v;
                    div.className = "list-item";
                    div.onclick = () => removerVantagem(v);
                    vantagensListDisplay.appendChild(div);
                });

                desvantagensSelecionadas.forEach(d => {
                    const div = document.createElement("div");
                    div.textContent = d;
                    div.className = "list-item";
                    div.onclick = () => removerDesvantagem(d);
                    desvantagensListDisplay.appendChild(div);
                });

                const inventario =
                    Array.isArray(ficha.inventario) ?
                    ficha.inventario : Array(10).fill({
                        item: "",
                        peso: "0"
                    });
                const slots = inventarioSlots.querySelectorAll(".inventory-slot");
                slots.forEach((slot, i) => {
                    const itemInput = slot.querySelector(".inventory-item");
                    const weightInput = slot.querySelector(".inventory-weight");
                    itemInput.value = inventario[i]?.item || "";
                    weightInput.value = inventario[i]?.peso || "0";
                });
                calcularPesoTotal();

                const magias = ficha.magiasHabilidades ? ficha.magiasHabilidades.split("\n") : Array(10).fill("");
                magiasList.innerHTML = "";
                magias.forEach((m, i) => {
                    const input = document.createElement("input");
                    input.type = "text";
                    input.className = "magia-nome";
                    input.placeholder = `Magia/Habilidade ${i+1}`;
                    input.value = m;
                    magiasList.appendChild(input);
                });
                anotacoesTextarea.value = ficha.anotacoes || "";

                classeNomeInput.value = ficha.classeNome || "";
                classeDescricaoInput.value = ficha.classeDescricao || "";
                if (ficha.imagem) {
                    characterImage.src = ficha.imagem;
                    characterImage.style.display = "block";
                } else {
                    characterImage.style.display = "none";
                }

                atualizarBotaoBloquear();
                atualizarVantagensDesvantagensPanel();
                atualizarRacasPanel();

                experiencia = parseInt(experienciaInput.value) || 0;
                atualizarNivel();
                calcularAtributos();

                vidaAtual = vidaTotal;
                magiaAtual = magiaTotal;
                vigorAtual = vigorTotal;

                document.getElementById("vida-atual").textContent = vidaAtual;
                document.getElementById("magia-atual").textContent = magiaAtual;
                document.getElementById("vigor-atual").textContent = vigorAtual.toFixed(1);
                pontosVantagemSpan.textContent = getPontosVantagem();

                previousValues.clear();
                document.querySelectorAll('input[type="text"],input[type="number"],textarea').forEach(input => previousValues.set(input, input.value));

                chatPassword = ficha.chatPassword;
                atualizarEstadoChatBotao();

                const backgroundImage = ficha.backgroundImage;
                const backgroundSize = ficha.backgroundSize || 'cover';
                if (backgroundImage) {
                    document.body.style.backgroundImage = `url('${backgroundImage}')`;
                    document.body.style.backgroundSize = backgroundSize;
                } else {
                    document.body.style.backgroundImage = 'none';
                }
                const radioButtons = document.querySelectorAll('input[name="background-size"]');
                radioButtons.forEach(radio => {
                    radio.checked = radio.value === backgroundSize;
                });
                const backgroundColor = ficha.backgroundColor || '#f0e6d2';
                document.body.style.backgroundColor = backgroundColor;
                const colorOptions = document.querySelectorAll('#background-color-selector .color-option');
                colorOptions.forEach(option => {
                    if (option.dataset.color === backgroundColor) {
                        option.classList.add('active');
                    } else {
                        option.classList.remove('active');
                    }
                });
            }

            function atualizarBotaoBloquear() {
                bloquearFichaButton.textContent = isFichaLocked ?
                    "Desbloquear Ficha" : "Bloquear Ficha";
                bloquearFichaButton.classList.toggle("botao-bloquear", !isFichaLocked);
                bloquearFichaButton.classList.toggle("botao-desbloquear", isFichaLocked);
            }

            function salvarDados() {
                if (!currentFichaId) return;
                if (isFichaLocked && !isFichaUnlocked) return abrirModalSenha();

                const inventario = Array.from(inventarioSlots.querySelectorAll(".inventory-slot")).map(slot => ({
                    item: slot.querySelector(".inventory-item").value,
                    peso: slot.querySelector(".inventory-weight").value
                }));
                const magias = Array.from(magiasList.querySelectorAll(".magia-nome")).map(input => input.value);

                const dados = {
                    nomePersonagem: nomePersonagemInput.value,
                    descricaoPersonagem: descricaoPersonagemInput.value,
                    forca: forcaInput.value,
                    destreza: destrezaInput.value,
                    agilidade: agilidadeInput.value,
                    inteligencia: inteligenciaInput.value,
                    constituicao: constituicaoInput.value,
                    experiencia: experienciaInput.value,
                    armaDireitaNome: armaDireitaNomeInput.value,
                    armaDireitaAtaque: armaDireitaAtaqueInput.value,
                    armaDireitaAtaqueMagico: armaDireitaAtaqueMagicoInput.value,
                    armaEsquerdaNome: armaEsquerdaNomeInput.value,
                    armaEsquerdaAtaque: armaEsquerdaAtaqueInput.value,
                    armaEsquerdaAtaqueMagico: armaEsquerdaAtaqueMagicoInput.value,
                    vantagens: vantagensSelecionadas.join("\n"),
                    magiasHabilidades: magias.join("\n"),
                    desvantagens: desvantagensSelecionadas.join("\n"),
                    inventario,
                    velocidadeCorrida: velocidadeCorridaSpan.textContent,
                    alturaPulo: alturaPuloSpan.textContent,
                    distanciaPulo: distanciaPuloSpan.textContent,
                    isLocked: isFichaLocked,
                    password: fichaPassword,
                    imagem: characterImage.src ||
                        null,
                    anotacoes: anotacoesTextarea.value,
                    classeNome: classeNomeInput.value,
                    classeDescricao: classeDescricaoInput.value,
                    racaNome: racaNomeSpan.textContent,
                    racaDescricao: racaDescricaoInput.value,
                    racaSelecionada: racaSelecionada,
                    chatPassword: chatPassword,
                    backgroundImage: document.body.style.backgroundImage === 'none' ?
                        null : document.body.style.backgroundImage.slice(5, -2),
                    backgroundSize: document.body.style.backgroundSize,
                    backgroundColor: document.body.style.backgroundColor
                };
                database.ref(`fichas/${currentFichaId}`).update(dados).then(() => {
                    showNotification("Salvo!", "save-success");
                    previousValues.clear();
                    document.querySelectorAll('input[type="text"],input[type="number"],textarea').forEach(input => previousValues.set(input, input.value));
                });
            }

            function calcularNivel(exp) {
                return nivelData.findLast(data => exp >= data.xp)?.nivel ||
                    0;
            }

            function atualizarNivel() {
                nivelAnterior = nivel;
                nivel = calcularNivel(experiencia);
                nivelSpan.textContent = nivel;
                pontosHabilidadeTotal = nivelData[nivel].pd;
                pontosVantagemSpan.textContent = getPontosVantagem();
                if (nivel > nivelAnterior) {
                    nivelSpan.classList.add("aura-azul");
                    setTimeout(() => nivelSpan.classList.remove("aura-azul"), 20000);
                }

                gameMasterMessage.style.display = nivel >= 30 ?
                    "block" : "none";
                fichaContainer.classList.toggle("aura-azul", nivel >= 30);

                calcularAtributos();
            }

            function getPontosVantagem() {
                let ph = nivelData[nivel].ph;
                vantagensSelecionadas.forEach(v => {
                    const vantagem = vantagensData.find(d => d.nome === v);
                    if (vantagem) ph -= vantagem.custo;
                });
                desvantagensSelecionadas.forEach(d => {
                    const desvantagem = desvantagensData.find(desv => desv.nome === d);
                    if (desvantagem) ph += desvantagem.ganho;
                });
                if (racaSelecionada) {
                    const raca = racasData.find(r => r.nome === racaSelecionada);
                    if (raca) ph -= raca.custo;
                }

                return ph;
            }

            function calcularPontosVantagemTemp() {
                let ph = nivelData[nivel].ph;
                tempVantagensSelecionadas.forEach(v => {
                    const vantagem = vantagensData.find(d => d.nome === v);
                    if (vantagem) ph -= vantagem.custo;
                });
                tempDesvantagensSelecionadas.forEach(d => {
                    const desvantagem = desvantagensData.find(desv => desv.nome === d);
                    if (desvantagem) ph += desvantagem.ganho;
                });
                if (tempRacaSelecionada) {
                    const raca = racasData.find(r => r.nome === tempRacaSelecionada);
                    if (raca) ph -= raca.custo;
                }

                return ph;
            }

            function aumentarVida() {
                if (vidaAtual < vidaTotal) {
                    vidaAtual++;
                    document.getElementById("vida-atual").textContent = vidaAtual;
                    salvarDados();
                }
            }

            function diminuirVida() {
                if (vidaAtual > 0) {
                    vidaAtual--;
                    document.getElementById("vida-atual").textContent = vidaAtual;
                    salvarDados();
                }
            }

            function aumentarMagia() {
                if (magiaAtual < magiaTotal) {
                    magiaAtual++;
                    document.getElementById("magia-atual").textContent = magiaAtual;
                    salvarDados();
                }
            }

            function diminuirMagia() {
                if (magiaAtual > 0) {
                    magiaAtual--;
                    document.getElementById("magia-atual").textContent = magiaAtual;
                    salvarDados();
                }
            }

            function aumentarVigor() {
                if (vigorAtual < vigorTotal) {
                    vigorAtual = Math.min(vigorAtual + 0.1, vigorTotal);
                    document.getElementById("vigor-atual").textContent = vigorAtual.toFixed(1);
                    salvarDados();
                }
            }

            function diminuirVigor() {
                if (vigorAtual > 0) {
                    vigorAtual = Math.max(vigorAtual - 0.1, 0);
                    document.getElementById("vigor-atual").textContent = vigorAtual.toFixed(1);
                    salvarDados();
                }
            }

            function calcularAtributos() {
                const forca = parseInt(forcaInput.value) ||
                    0,
                    destreza = parseInt(destrezaInput.value) ||
                    0,
                    agilidade = parseInt(agilidadeInput.value) ||
                    0,
                    inteligencia = parseInt(inteligenciaInput.value) ||
                    0,
                    constituicao = parseInt(constituicaoInput.value) ||
                    0;

                let totalPontos = forca + destreza + agilidade + inteligencia + constituicao;
                if (totalPontos > pontosHabilidadeTotal) {
                    alert("Pontos de habilidade insuficientes!");
                    forcaInput.value = previousValues.get(forcaInput) || "0";
                    destrezaInput.value = previousValues.get(destrezaInput) || "0";
                    agilidadeInput.value = previousValues.get(agilidadeInput) || "0";
                    inteligenciaInput.value = previousValues.get(inteligenciaInput) || "0";
                    constituicaoInput.value = previousValues.get(constituicaoInput) || "0";
                    return;
                }

                pontosHabilidadeUsados = totalPontos;
                pontosHabilidadeSpan.textContent = pontosHabilidadeTotal - pontosHabilidadeUsados;

                let ataque = forca + Math.floor(destreza / 5),
                    acerto = Math.floor(destreza / 3) + Math.floor(agilidade / 10),
                    esquiva = Math.floor(agilidade / 3),
                    rdf = Math.floor(forca / 5),
                    rdm = Math.floor(inteligencia / 5),
                    ataqueMagico = inteligencia,
                    magiaBase = 20 + 3 * constituicao,
                    vigorBase = 10 + 0.4 * constituicao;
                vidaBase = 50 + (constituicao * (3 + Math.floor(forca / 10))) + 10 * nivel;
                if (inteligencia >= 10) magiaBase += constituicao * Math.floor(inteligencia / 10);

                ataque += (parseInt(armaDireitaAtaqueInput.value) || 0) + (parseInt(armaEsquerdaAtaqueInput.value) || 0);
                ataqueMagico += (parseInt(armaDireitaAtaqueMagicoInput.value) || 0) + (parseInt(armaEsquerdaAtaqueMagicoInput.value) || 0);

                const velocidadeBase = 25 + Math.floor(agilidade / 3) * 3,
                    alturaPuloBase = 1 + Math.floor(forca / 10),
                    distanciaPuloBase = 3 + 3 * Math.min(Math.floor(forca / 5), Math.floor(agilidade / 5));
                let bonusVelocidade = vantagensSelecionadas.includes("Combo F√≠sico (4)") ? 25 : 0,
                    bonusAlturaPulo = vantagensSelecionadas.includes("Combo F√≠sico (4)") ?
                    2 : 0,
                    bonusDistanciaPulo = vantagensSelecionadas.includes("Combo F√≠sico (4)") ?
                    6 : 0;

                velocidadeCorridaSpan.textContent = velocidadeBase + bonusVelocidade;
                alturaPuloSpan.textContent = alturaPuloBase + bonusAlturaPulo;
                distanciaPuloSpan.textContent = distanciaPuloBase + bonusDistanciaPulo;
                ataqueSpan.textContent = ataque;
                ataqueMagicoSpan.textContent = ataqueMagico;
                acertoSpan.textContent = acerto;
                esquivaSpan.textContent = esquiva;
                rdfSpan.textContent = rdf;
                rdmSpan.textContent = rdm;
                vidaTotal = Math.ceil(vidaBase);
                magiaTotal = Math.ceil(magiaBase);
                vigorTotal = parseFloat(vigorBase.toFixed(1));

                vidaAtual = vidaAtual === undefined ? vidaTotal : Math.min(vidaAtual, vidaTotal);
                magiaAtual = magiaAtual === undefined ? magiaTotal : Math.min(magiaAtual, magiaTotal);
                vigorAtual = vigorAtual === undefined ? vigorTotal : Math.min(vigorAtual, vigorTotal);
                document.getElementById("vida-total").textContent = vidaTotal;
                document.getElementById("magia-total").textContent = magiaTotal;
                document.getElementById("vigor-total").textContent = vigorTotal.toFixed(1);
                document.getElementById("vida-atual").textContent = vidaAtual;
                document.getElementById("magia-atual").textContent = magiaAtual;
                document.getElementById("vigor-atual").textContent = vigorAtual.toFixed(1);
                const regeneracaoVida = (0.2 * constituicao).toFixed(1),
                    regeneracaoMagia = (0.8 * constituicao).toFixed(1),
                    regeneracaoVigor = (0.4 * constituicao).toFixed(1);
                document.getElementById("regeneracao-vida").textContent = regeneracaoVida;
                document.getElementById("regeneracao-magia").textContent = regeneracaoMagia;
                document.getElementById("regeneracao-vigor").textContent = regeneracaoVigor;

                const atributos = [{
                    span: ataqueSpan,
                    valor: ataque
                }, {
                    span: ataqueMagicoSpan,
                    valor: ataqueMagico
                }, {
                    span: acertoSpan,
                    valor: acerto
                }, {
                    span: esquivaSpan,
                    valor: esquiva
                }, {
                    span: rdfSpan,
                    valor: rdf
                }, {
                    span: rdmSpan,
                    valor: rdm
                }];
                atributos.forEach(a => a.span.classList.remove("atributo-fogo"));

                const maxAtributo = atributos.reduce((prev, curr) => prev.valor > curr.valor ? prev : curr, {
                    valor: 0
                });
                if (maxAtributo.valor > 0) maxAtributo.span.classList.add("atributo-fogo");
            }

            function resetarPontos() {
                if (isFichaLocked && !isFichaUnlocked) return abrirModalSenha();
                if (confirm("Tem certeza que deseja reiniciar os pontos? Voc√™ precisar√° da permiss√£o do GM.")) {
                    document.getElementById("senha-gm-modal").style.display = "flex";
                    document.getElementById("senha-gm-input").value = "";
                    document.getElementById("confirmar-senha-gm-btn").onclick = () => {
                        if (document.getElementById("senha-gm-input").value === senhaMatriz) {
                            atributosInputs.forEach(input => input.value = 0);
                            pontosHabilidadeUsados = 0;
                            pontosHabilidadeSpan.textContent = pontosHabilidadeTotal;
                            velocidadeCorridaSpan.textContent = "25";
                            alturaPuloSpan.textContent = "1";
                            distanciaPuloSpan.textContent = "3";
                            calcularAtributos();
                            pontosVantagemSpan.textContent = getPontosVantagem();
                            salvarDados();
                            fecharModal("senha-gm-modal");
                        } else {
                            alert("Senha do GM incorreta!");
                            fecharModal("senha-gm-modal");
                        }
                    };
                }
            }

            function recomecarFicha() {
                if (confirm("Tem certeza que deseja recome√ßar a ficha? Todas as altera√ß√µes ser√£o perdidas.")) {
                    atributosInputs.forEach(input => input.value = 0);
                    pontosHabilidadeUsados = 0;
                    pontosHabilidadeSpan.textContent = pontosHabilidadeTotal;
                    velocidadeCorridaSpan.textContent = "25";
                    alturaPuloSpan.textContent = "1";
                    distanciaPuloSpan.textContent = "3";
                    nomePersonagemInput.value = "";
                    descricaoPersonagemInput.value = "";
                    experienciaInput.value = 0;
                    nivel = 0;
                    pontosHabilidadeTotal = nivelData[nivel].pd;
                    pontosHabilidadeUsados = 0;
                    nivelSpan.textContent = nivel;
                    pontosHabilidadeSpan.textContent = pontosHabilidadeTotal;
                    vidaBase = 50;

                    armaDireitaNomeInput.value = "";
                    armaDireitaAtaqueInput.value = "0";
                    armaDireitaAtaqueMagicoInput.value = "0";
                    armaEsquerdaNomeInput.value = "";
                    armaEsquerdaAtaqueInput.value = "0";
                    armaEsquerdaAtaqueMagicoInput.value = "0";

                    magiasList.innerHTML = "";
                    for (let i = 0; i < 10; i++) {
                        const input = document.createElement("input");
                        input.type = "text";
                        input.className = "magia-nome";
                        input.placeholder = `Magia/Habilidade ${i+1}`;
                        magiasList.appendChild(input);
                    }

                    const slots = inventarioSlots.querySelectorAll(".inventory-slot");
                    slots.forEach(slot => {
                        slot.querySelector(".inventory-item").value = "";
                        slot.querySelector(".inventory-weight").value = "0";
                    });
                    characterImage.style.display = "none";
                    characterImage.src = "";

                    vantagensSelecionadas = [];
                    desvantagensSelecionadas = [];
                    racaSelecionada = null;

                    vantagensListDisplay.innerHTML = "";
                    desvantagensListDisplay.innerHTML = "";

                    anotacoesTextarea.value = "";

                    classeNomeInput.value = "";
                    classeDescricaoInput.value = "";
                    racaNomeSpan.textContent = "";
                    racaDescricaoInput.value = "";

                    calcularAtributos();
                    pontosVantagemSpan.textContent = getPontosVantagem();
                    salvarDados();
                }
            }

            bloquearFichaButton.onclick = () => {
                if (isFichaLocked) abrirModalSenha();
                else {
                    document.getElementById("bloquear-ficha-modal").style.display = "flex";
                    document.getElementById("senha-bloqueio-input").value = "";
                    document.getElementById("senha-bloqueio-input").focus();
                }
            };

            function bloquearFicha() {
                const senha = document.getElementById("senha-bloqueio-input").value;
                if (senha.length !== 4 || !/^\d{4}$/.test(senha)) return alert("A senha deve ter exatamente 4 d√≠gitos num√©ricos!");
                if (desvantagensSelecionadas.length > 3) return alert("Voc√™ pode ter no m√°ximo 3 desvantagens!");

                isFichaLocked = true;
                fichaPassword = senha;
                database.ref(`fichas/${currentFichaId}`).update({
                    isLocked: true,
                    password: senha
                }).then(() => {
                    fecharModal("bloquear-ficha-modal");
                    alert("Ficha bloqueada com sucesso!");
                    atualizarBotaoBloquear();
                }).catch(error => console.error("Erro ao bloquear ficha:", error));
            }

            function abrirModalSenha(element = null) {
                document.getElementById("password-modal").style.display = "flex";
                document.getElementById("senha-desbloqueio-input").value = "";
                document.getElementById("senha-desbloqueio-input").focus();
                if (element) document.getElementById("password-modal").dataset.elementId = element.id;
                else delete document.getElementById("password-modal").dataset.elementId;
            }

            function desbloquearFicha() {
                const senha = document.getElementById("senha-desbloqueio-input").value,
                    modal = document.getElementById("password-modal"),
                    elementId = modal.dataset.elementId;
                if (senha !== senhaMatriz && senha !== fichaPassword) return alert("Senha incorreta!");

                isFichaUnlocked = true;
                if (currentFichaId !== "ficha-matriz" && senha !== senhaMatriz) {
                    database.ref(`fichas/${currentFichaId}`).update({
                        isLocked: false,
                        password: null
                    }).then(() => {
                        fecharModal("password-modal");
                        alert("Ficha desbloqueada permanentemente!");
                        atualizarBotaoBloquear();
                        if (elementId === "reset-pontos") resetarPontos();
                        else if (elementId === "recomecar") recomecarFicha();
                        else if (elementId) {
                            previousValues.set(document.getElementById(elementId), document.getElementById(elementId).value);
                            salvarDados();
                        }
                    }).catch(error => console.error("Erro ao desbloquear ficha:", error));
                } else {
                    fecharModal("password-modal");
                    alert("Ficha desbloqueada temporariamente com a senha matriz!");
                    if (elementId === "reset-pontos") resetarPontos();
                    else if (elementId === "recomecar") recomecarFicha();
                    else if (elementId) {
                        previousValues.set(document.getElementById(elementId), document.getElementById(elementId).value);
                        salvarDados();
                    }
                }
            }

            function cancelarDesbloqueio() {
                const modal = document.getElementById("password-modal"),
                    elementId = modal.dataset.elementId;
                if (elementId) document.getElementById(elementId).value = previousValues.get(document.getElementById(elementId)) || "";
                fecharModal("password-modal");
            }

            function verificarAlteracao(event) {
                const input = event.target;
                if (isFichaLocked && !isFichaUnlocked) {
                    event.preventDefault();
                    previousValues.set(input, input.value);
                    abrirModalSenha(input);
                } else previousValues.set(input, input.value);
            }

            document.querySelectorAll('input[type="text"],input[type="number"],textarea').forEach(input => {
                input.addEventListener("beforeinput", verificarAlteracao);
                input.addEventListener("input", () => {
                    if (!isFichaLocked || isFichaUnlocked) {
                        if (input.id === "experiencia") {
                            experiencia = parseInt(input.value) || 0;
                            atualizarNivel();
                        } else if (atributosInputs.includes(input)) {
                            const forca = parseInt(forcaInput.value) || 0,
                                destreza = parseInt(destrezaInput.value) || 0,
                                agilidade = parseInt(agilidadeInput.value) || 0,
                                inteligencia = parseInt(inteligenciaInput.value) || 0,
                                constituicao = parseInt(constituicaoInput.value) || 0;
                            const totalPontos = forca + destreza + agilidade + inteligencia + constituicao;
                            if (totalPontos > pontosHabilidadeTotal) {
                                alert("Pontos de habilidade insuficientes!");
                                input.value = previousValues.get(input) || "0";
                                return;
                            }
                            calcularAtributos();
                        } else if (input.id.includes("arma")) calcularAtributos();
                        salvarDados();
                    }
                });
            });
            nomePersonagemInput.oninput = salvarDados;

            characterImageInput.onchange = e => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = e => {
                        characterImage.src = e.target.result;
                        characterImage.style.display = "block";
                        salvarDados();
                    };
                    reader.readAsDataURL(file);
                }
            };
            document.getElementById("excluir-ficha").onclick = () => {
                if (currentFichaId === "ficha-matriz") return alert("A ficha matriz n√£o pode ser exclu√≠da!");
                if (isFichaLocked && !isFichaUnlocked) return abrirModalSenha();
                if (confirm("Tem certeza que deseja excluir esta ficha?"))
                    database.ref(`fichas/${currentFichaId}`).remove().then(() => {
                        currentFichaId = "ficha-matriz";
                        carregarFicha(currentFichaId);
                        atualizarAbasFichas();
                    });
            };
            let isDragging = false,
                currentX = diceContainer.offsetLeft,
                currentY = diceContainer.offsetTop,
                initialX, initialY;
            diceContainer.onmousedown = e => {
                isDragging = true;
                initialX = e.clientX - currentX;
                initialY = e.clientY - currentY;
                diceContainer.style.cursor = "grabbing";
            };
            document.onmousemove = e => {
                if (isDragging) {
                    e.preventDefault();
                    currentX = e.clientX - initialX;
                    currentY = e.clientY - initialY;
                    diceContainer.style.left = `${currentX}px`;
                    diceContainer.style.top = `${currentY}px`;
                    diceContainer.style.right = "auto";
                }
            };

            document.onmouseup = () => {
                isDragging = false;
                diceContainer.style.cursor = "move";
            };

            database.ref('dadosRolados').on('child_added', snapshot => {
                const dado = snapshot.val();
                if (dado.fichaId !== currentFichaId) {
                    showNotification(`${dado.nomeFicha} rolou: ${dado.resultado}`, "normal-result");
                }
            });
            diceRoll.onclick = () => {
                if (isFichaLocked && !isFichaUnlocked) return abrirModalSenha();
                diceRoll.textContent = "Rolling...";
                diceResult.style.display = "none";
                diceRoll.classList.remove("critical-failure", "critical-success");

                setTimeout(() => {
                    const roll = Math.floor(Math.random() * 20) + 1,
                        fichaNome = fichas[currentFichaId].nomeFicha || "Sem Nome";

                    diceRoll.textContent = roll;

                    if (roll === 1) {
                        diceRoll.classList.add("critical-failure");
                        notification.textContent = `${fichaNome} - FALHA CR√çTICA!`;
                        notification.classList.add("critical-failure");
                    } else if (roll === 20) {
                        diceRoll.classList.add("critical-success");
                        notification.textContent = `${fichaNome} - SUCESSO CR√çTICO!`;
                        notification.classList.add("critical-success");
                    } else {
                        diceResult.textContent = `${fichaNome} rolou: ${roll}`;
                        diceResult.style.display = "block";
                        notification.textContent = `${fichaNome} rolou: ${roll}`;
                        notification.classList.add("normal-result");
                    }

                    notification.style.display = "block";
                    setTimeout(() => {
                        notification.style.display = "none";
                        notification.classList.remove("critical-failure", "critical-success", "normal-result");
                    }, 2000);
                    const dadoRef = database.ref('dadosRolados').push();
                    dadoRef.set({
                        fichaId: currentFichaId,
                        nomeFicha: fichaNome,
                        resultado: roll
                    });
                }, 1000);
            };

            vantagensDesvantagensBtn.onclick = () => {
                if (isFichaLocked && !isFichaUnlocked) return abrirModalSenha();
                tempVantagensSelecionadas = [...vantagensSelecionadas];
                tempDesvantagensSelecionadas = [...desvantagensSelecionadas];
                vantagensDesvantagensPanel.style.display = "block";
                document.getElementById("salvar-vantagens-btn").style.display = "none";
                atualizarVantagensDesvantagensPanel();
            };
            fecharPaginaBtn.onclick = () => {
                vantagensDesvantagensPanel.style.display = "none";
            };
            salvarVantagensBtn.onclick = () => {
                document.getElementById("salvar-vantagens-modal").style.display = "flex";
            };
            document.getElementById("confirmar-salvar-vantagens-btn").onclick = () => {
                if (tempDesvantagensSelecionadas.length > 3) return alert("Voc√™ pode ter no m√°ximo 3 desvantagens!");
                vantagensSelecionadas = [...tempVantagensSelecionadas];
                desvantagensSelecionadas = [...tempDesvantagensSelecionadas];

                vantagensListDisplay.innerHTML = "";
                desvantagensListDisplay.innerHTML = "";
                vantagensSelecionadas.forEach(v => {
                    const div = document.createElement("div");
                    div.textContent = v;
                    div.className = "list-item";
                    div.onclick = () => removerVantagem(v);
                    vantagensListDisplay.appendChild(div);
                });

                desvantagensSelecionadas.forEach(d => {
                    const div = document.createElement("div");
                    div.textContent = d;
                    div.className = "list-item";
                    div.onclick = () => removerDesvantagem(d);
                    desvantagensListDisplay.appendChild(div);
                });

                pontosVantagemSpan.textContent = getPontosVantagem();
                salvarDados();
                vantagensDesvantagensPanel.style.display = "none";
                fecharModal("salvar-vantagens-modal");
                calcularAtributos();
            };

            function atualizarVantagensDesvantagensPanel() {
                vantagensList.innerHTML = "<h3>Vantagens</h3>";
                desvantagensList.innerHTML = "<h3>Desvantagens</h3>";

                vantagensData.forEach(v => {
                    const div = document.createElement("div");
                    div.className = "vantagem-item";
                    div.textContent = `${v.nome} - Custo: ${v.custo} PH - ${v.descricao}`;

                    if (tempVantagensSelecionadas.includes(v.nome)) div.classList.add("comprada");

                    div.onclick = () => {
                        if (vantagensSelecionadas.includes(v.nome)) alert("Esta vantagem j√° foi salva e s√≥ pode ser removida com permiss√£o do GM.");
                        else if (tempVantagensSelecionadas.includes(v.nome)) tempVantagensSelecionadas = tempVantagensSelecionadas.filter(t => t !== v.nome);
                        else {
                            if (v.restricao === "inicio" && nivel > 0) return alert("A compra dessa vantagem √© somente no n√≠vel 0.");
                            if (calcularPontosVantagemTemp() >= v.custo) tempVantagensSelecionadas.push(v.nome);
                            else alert("Pontos de Vantagem insuficientes!");
                        }
                        atualizarVantagensDesvantagensPanel();
                        document.getElementById("salvar-vantagens-btn").style.display = "block";
                    };

                    vantagensList.appendChild(div);
                });

                desvantagensData.forEach(d => {
                    const div = document.createElement("div");
                    div.className = "desvantagem-item";
                    div.textContent = `${d.nome} - Ganho: ${d.ganho} PH - ${d.descricao}`;

                    if (tempDesvantagensSelecionadas.includes(d.nome)) div.classList.add("comprada");

                    div.onclick = () => {
                        if (desvantagensSelecionadas.includes(d.nome)) alert("Esta desvantagem j√° foi salva e s√≥ pode ser removida com permiss√£o do GM.");
                        else if (tempDesvantagensSelecionadas.includes(d.nome)) tempDesvantagensSelecionadas = tempDesvantagensSelecionadas.filter(t => t !== d.nome);
                        else {
                            if (tempDesvantagensSelecionadas.length < 3) tempDesvantagensSelecionadas.push(d.nome);
                            else alert("Voc√™ j√° atingiu o limite de 3 desvantagens!");
                        }
                        atualizarVantagensDesvantagensPanel();
                        document.getElementById("salvar-vantagens-btn").style.display = "block";
                    };

                    desvantagensList.appendChild(div);
                });
                document.getElementById("ph-temp").textContent = calcularPontosVantagemTemp();
            }

            function removerVantagem(v) {
                if (isFichaLocked && !isFichaUnlocked) return abrirModalSenha();
                if (confirm(`Voc√™ deseja remover a vantagem "${v}"?`)) {
                    document.getElementById("senha-gm-modal").style.display = "flex";
                    document.getElementById("senha-gm-input").value = "";
                    document.getElementById("confirmar-senha-gm-btn").onclick = () => {
                        if (document.getElementById("senha-gm-input").value === senhaMatriz) {
                            vantagensSelecionadas = vantagensSelecionadas.filter(t => t !== v);
                            Array.from(vantagensListDisplay.children).find(div => div.textContent === v)?.remove();
                            pontosVantagemSpan.textContent = getPontosVantagem();
                            database.ref(`fichas/${currentFichaId}/vantagens`).set(vantagensSelecionadas.join("\n"));
                            fecharModal("senha-gm-modal");
                            calcularAtributos();
                        } else {
                            alert("Senha do GM incorreta!");
                            fecharModal("senha-gm-modal");
                        }
                    };
                }
            }

            function removerDesvantagem(d) {
                if (isFichaLocked && !isFichaUnlocked) return abrirModalSenha();
                if (confirm(`Voc√™ deseja remover a desvantagem "${d}"?`)) {
                    document.getElementById("senha-gm-modal").style.display = "flex";
                    document.getElementById("senha-gm-input").value = "";
                    document.getElementById("confirmar-senha-gm-btn").onclick = () => {
                        if (document.getElementById("senha-gm-input").value === senhaMatriz) {
                            desvantagensSelecionadas = desvantagensSelecionadas.filter(t => t !== d);
                            Array.from(desvantagensListDisplay.children).find(div => div.textContent === d)?.remove();
                            pontosVantagemSpan.textContent = getPontosVantagem();
                            database.ref(`fichas/${currentFichaId}/desvantagens`).set(desvantagensSelecionadas.join("\n"));
                            fecharModal("senha-gm-modal");
                            calcularAtributos();
                        } else {
                            alert("Senha do GM incorreta!");
                            fecharModal("senha-gm-modal");
                        }
                    };
                }
            }

            function calcularPesoTotal() {
                pesoTotalSpan.textContent = Array.from(inventarioSlots.querySelectorAll(".inventory-weight")).reduce((total, weight) => total + (parseFloat(weight.value) || 0), 0).toFixed(1);
            }

            inventarioSlots.addEventListener("input", calcularPesoTotal);
            anotacoesBtn.onclick = () => {
                anotacoesTextarea.style.display = anotacoesTextarea.style.display === "block" ?
                    "none" : "block";
            };

            document.addEventListener('click', function(event) {
                if (anotacoesTextarea.style.display === "block" && !anotacoesTextarea.contains(event.target) && !anotacoesBtn.contains(event.target))
                    anotacoesTextarea.style.display = 'none';
            });
            anotacoesTextarea.oninput = salvarDados;

            adicionarMagiaBtn.onclick = () => {
                if (magiasList.children.length < 20) {
                    const input = document.createElement("input");
                    input.type = "text";
                    input.className = "magia-nome";
                    input.placeholder = `Magia/Habilidade ${magiasList.children.length+1}`;
                    magiasList.appendChild(input);
                    salvarDados();
                } else alert("Voc√™ atingiu o limite de 20 magias/habilidades!");
            };
            racasBtn.onclick = () => {
                if (isFichaLocked && !isFichaUnlocked) return abrirModalSenha();
                tempRacaSelecionada = racaSelecionada;
                atualizarRacasPanel();
                racasPanel.style.display = "block";
                document.getElementById("salvar-racas-btn").style.display = "none";
            };
            fecharRacasBtn.onclick = () => {
                racasPanel.style.display = "none";
            };
            salvarRacasBtn.onclick = () => {
                document.getElementById("salvar-vantagens-modal").style.display = "flex";
            };
            document.getElementById("confirmar-salvar-vantagens-btn").onclick = () => {
                if (tempRacaSelecionada && tempRacaSelecionada !== racaSelecionada) {
                    const raca = racasData.find(r => r.nome === tempRacaSelecionada);
                    if (raca) {
                        racaSelecionada = tempRacaSelecionada;
                        racaNomeSpan.textContent = racaSelecionada.split(" (")[0];
                        racaDescricaoInput.value = raca.vantagens.join("\n\n");
                        pontosVantagemSpan.textContent = getPontosVantagem();
                        salvarDados();
                        racasPanel.style.display = "none";
                        fecharModal("salvar-vantagens-modal");
                    }
                } else {
                    vantagensSelecionadas = [...tempVantagensSelecionadas];
                    desvantagensSelecionadas = [...tempDesvantagensSelecionadas];

                    vantagensListDisplay.innerHTML = "";
                    desvantagensListDisplay.innerHTML = "";

                    vantagensSelecionadas.forEach(v => {
                        const div = document.createElement("div");
                        div.textContent = v;
                        div.className = "list-item";
                        div.onclick = () => removerVantagem(v);
                        vantagensListDisplay.appendChild(div);
                    });

                    desvantagensSelecionadas.forEach(d => {
                        const div = document.createElement("div");
                        div.textContent = d;
                        div.className = "list-item";
                        div.onclick = () => removerDesvantagem(d);
                        desvantagensListDisplay.appendChild(div);
                    });
                    pontosVantagemSpan.textContent = getPontosVantagem();
                    salvarDados();
                    vantagensDesvantagensPanel.style.display = "none";
                    fecharModal("salvar-vantagens-modal");
                    calcularAtributos();
                }
            };

            function atualizarRacasPanel() {
                racasList.innerHTML = "";
                racasData.forEach(r => {
                    const div = document.createElement("div");
                    div.className = "raca-item";
                    div.innerHTML = `<h3>${r.nome}</h3><p>${r.descricao}</p><p><strong>Vantagens:</strong></p><ul>${r.vantagens.map(v => `<li>${v}</li>`).join("")}</ul>`;

                    if (tempRacaSelecionada === r.nome) div.classList.add("comprada");

                    div.onclick = () => {
                        if (racaSelecionada) alert("Voc√™ j√° selecionou uma ra√ßa e s√≥ pode alter√°-la com permiss√£o do GM.");
                        else if (tempRacaSelecionada === r.nome) tempRacaSelecionada = null;
                        else {
                            if (calcularPontosVantagemTemp() >= r.custo) {
                                tempRacaSelecionada = r.nome;
                                document.getElementById("confirmar-compra-modal").style.display = "flex";
                                document.getElementById("confirmar-compra-btn").onclick = () => {
                                    atualizarRacasPanel();
                                    document.getElementById("salvar-racas-btn").style.display = "block";
                                    fecharModal("confirmar-compra-modal");
                                };
                            } else alert("Pontos de Vantagem insuficientes!");
                        }
                        atualizarRacasPanel();
                    };
                    racasList.appendChild(div);
                });
            }

            function abrirModalRaca() {
                document.getElementById("raca-opcoes-modal").style.display = "flex";
            }

            function excluirRacaSelecionadaModal() {
                fecharModal('raca-opcoes-modal');
                if (confirm("Tem certeza que deseja excluir a ra√ßa selecionada?")) {
                    document.getElementById("senha-gm-modal").style.display = "flex";
                    document.getElementById("senha-gm-input").value = "";
                    document.getElementById("confirmar-senha-gm-btn").onclick = () => {
                        if (document.getElementById("senha-gm-input").value === senhaMatriz) {
                            racaSelecionada = null;
                            racaNomeSpan.textContent = "";
                            racaDescricaoInput.value = "";
                            pontosVantagemSpan.textContent = getPontosVantagem();
                            salvarDados();
                            fecharModal("senha-gm-modal");
                        } else {
                            alert("Senha do GM incorreta!");
                            fecharModal("senha-gm-modal");
                        }
                    };
                }
            }


            function editarRacaSelecionadaModal() {
                if (isFichaLocked && !isFichaUnlocked) return abrirModalSenha();
                fecharModal('raca-opcoes-modal');
                document.getElementById("editar-raca-modal").style.display = "flex";
                document.getElementById("editar-raca-nome").value = racaNomeSpan.textContent;
                document.getElementById("editar-raca-descricao").value = racaDescricaoInput.value;
            }

            function salvarEdicaoRaca() {
                if (isFichaLocked && !isFichaUnlocked) return abrirModalSenha();
                if (confirm("Tem certeza que deseja editar a ra√ßa selecionada?")) {
                    document.getElementById("senha-gm-modal").style.display = "flex";
                    document.getElementById("senha-gm-input").value = "";
                    document.getElementById("confirmar-senha-gm-btn").onclick = () => {
                        if (document.getElementById("senha-gm-input").value === senhaMatriz) {
                            racaNomeSpan.textContent = document.getElementById("editar-raca-nome").value;
                            racaDescricaoInput.value = document.getElementById("editar-raca-descricao").value;
                            fecharModal('editar-raca-modal');
                            salvarDados();
                            fecharModal("senha-gm-modal");
                        } else {
                            alert("Senha do GM incorreta!");
                            fecharModal("senha-gm-modal");
                        }
                    };
                }
            }

            classesBtn.onclick = () => {
                classesPanel.style.display = "block";
            };

            fecharClassesBtn.onclick = () => {
                classesPanel.style.display = "none";
            };

            luaBtn.onclick = () => {
                document.body.classList.add("dark-mode");
            };
            solBtn.onclick = () => {
                document.body.classList.remove("dark-mode");
            };
            resetPontosButton.onclick = resetarPontos;
            recomecarButton.onclick = recomecarFicha;

            function showNotification(message, type) {
                notification.textContent = message;
                notification.className = type;
                notification.style.display = "block";
                setTimeout(() => {
                    notification.style.display = "none";
                    notification.className = "";
                }, 2000);
            }

            document.getElementById("historico-dados-btn").onclick = () => {
                document.getElementById("historico-dados-panel").style.display = "block";
            };

            document.addEventListener('click', function(event) {
                const panel = document.getElementById("historico-dados-panel");
                if (panel.style.display === "block" && !panel.contains(event.target) && !document.getElementById("historico-dados-btn").contains(event.target))
                    panel.style.display = "none";
            });
            database.ref('dadosRolados').on('value', snapshot => {
                const dados = snapshot.val();
                const lista = document.getElementById("historico-lista");
                lista.innerHTML = "";
                if (dados) {
                    for (let key in dados) {
                        const dado = dados[key];
                        const div = document.createElement("div");
                        div.textContent = `${dado.nomeFicha} rolou: ${dado.resultado}`;
                        lista.appendChild(div);
                    }
                }
            });

            document.getElementById("excluir-historico-btn").onclick = () => {
                document.getElementById("senha-gm-modal").style.display = "flex";
                document.getElementById("senha-gm-input").value = "";
                document.getElementById("confirmar-senha-gm-btn").onclick = () => {
                    if (document.getElementById("senha-gm-input").value === senhaMatriz) {
                        database.ref('dadosRolados').remove().then(() => {
                            alert("Hist√≥rico de dados exclu√≠do com sucesso!");
                            fecharModal("senha-gm-modal");
                        });
                    } else {
                        alert("Senha do GM incorreta!");
                        fecharModal("senha-gm-modal");
                    }
                };
            };
            // Funcionalidade do Chat
            chatBtn.onclick = () => {
                if (!chatPassword) {
                    document.getElementById("chat-password-modal").style.display = "flex";
                } else {
                    document.getElementById("open-chat-modal").style.display = "flex";
                }
            };

            function definirSenhaChat() {
                const senha = document.getElementById("chat-senha-input").value;
                const confirmarSenha = document.getElementById("chat-confirmar-senha-input").value;
                if (senha !== confirmarSenha) {
                    alert("As senhas n√£o coincidem.");
                    return;
                }
                if (senha.length < 4) {
                    alert("A senha deve ter pelo menos 4 caracteres.");
                    return;
                }
                chatPassword = senha;
                database.ref(`fichas/${currentFichaId}`).update({
                    chatPassword: senha
                }).then(() => {
                    fecharModal("chat-password-modal");
                    alert("Senha do chat definida!");
                    atualizarEstadoChatBotao();
                }).catch(error => console.error("Erro ao definir senha do chat:", error));
            }

            function abrirChat() {
                const senhaDigitada = document.getElementById("abrir-chat-senha-input").value;
                if (senhaDigitada === chatPassword) {
                    fecharModal("open-chat-modal");
                    document.getElementById("chat-modal").style.display = "flex";
                    isChatOpen = true;
                    selectedChatUser = null;
                    document.getElementById("conversation-area").innerHTML = "";
                } else {
                    alert("Senha do chat incorreta.");
                }
            }

            function atualizarEstadoChatBotao() {
                if (chatPassword) {
                    chatBtn.textContent = "üí¨ Chat";
                } else {
                    chatBtn.textContent = "üí¨ Definir Chat";
                }
            }

            function atualizarListaFichasChat() {
                availableFichasDiv.innerHTML = "";
                for (const fichaId in fichas) {
                    if (fichaId !== "ficha-matriz" && fichaId !== currentFichaId) {
                        const ficha = fichas[fichaId];
                        const userDiv = document.createElement("div");
                        userDiv.className = "user-item";
                        userDiv.textContent = ficha.nomeFicha || "Sem Nome";
                        userDiv.dataset.fichaId = fichaId;
                        userDiv.onclick = () => iniciarConversa(fichaId, ficha.nomeFicha || "Sem Nome");
                        availableFichasDiv.appendChild(userDiv);
                    }
                }
            }

            function iniciarConversa(otherFichaId, otherFichaNome) {
                selectedChatUser = otherFichaId;
                document.getElementById("conversation-area").innerHTML = `<h3>Conversa com ${otherFichaNome}</h3><div id="mensagens"></div>`;
                carregarMensagens(otherFichaId);
            }

            function enviarMensagem() {
                if (!selectedChatUser) {
                    alert("Selecione uma ficha para enviar a mensagem.");
                    return;
                }
                const mensagem = mensagemInput.value.trim();
                if (mensagem) {
                    const chatRef = database.ref('mensagens').child(getChatId(currentFichaId, selectedChatUser)).push();
                    chatRef.set({
                        senderId: currentFichaId,
                        receiverId: selectedChatUser,
                        content: mensagem,
                        timestamp: firebase.database.ServerValue.TIMESTAMP
                    });
                    mensagemInput.value = "";
                }
            }

            function carregarMensagens(otherFichaId) {
                const mensagensDiv = document.getElementById("mensagens");
                database.ref('mensagens').child(getChatId(currentFichaId, otherFichaId)).orderByChild('timestamp').on('child_added', snapshot => {
                    const mensagemData = snapshot.val();
                    const messageContainer = document.createElement("div");
                    messageContainer.className = "message-container";
                    const senderName = document.createElement("div");
                    senderName.className = "sender-name";
                    senderName.textContent = fichas[mensagemData.senderId]?.nomeFicha || 'Desconhecido';
                    const mensagemDiv = document.createElement("div");
                    mensagemDiv.className = `message ${mensagemData.senderId === currentFichaId ? 'sent' : 'received'}`;
                    mensagemDiv.textContent = mensagemData.content;
                    messageContainer.appendChild(senderName);
                    messageContainer.appendChild(mensagemDiv);
                    mensagensDiv.appendChild(messageContainer);
                    mensagensDiv.scrollTop = mensagensDiv.scrollHeight;
                });
            }

            function getChatId(id1, id2) {
                return id1 < id2 ?
                    `${id1}_${id2}` : `${id2}_${id1}`;
            }

            function verificarNovasMensagens() {
                if (!currentFichaId) return;
                database.ref('mensagens').on('value', (snapshot) => {
                    let unreadCount = 0;
                    snapshot.forEach((chat) => {
                        const chatId = chat.key;
                        if (chatId.includes(currentFichaId)) {
                            chat.forEach((mensagemSnapshot) => {
                                const mensagem = mensagemSnapshot.val();
                                if (mensagem.receiverId === currentFichaId && mensagem.senderId !== currentFichaId && !isChatOpen) {
                                    unreadCount++;
                                }
                            });
                        }
                    });
                    chatBtn.dataset.unread = unreadCount > 0 ? unreadCount : 0;
                    if (unreadCount > 0 && !isChatOpen) {
                        newMessageSound.play();
                    }
                });
            }

            // Funcionalidade do Plano de Fundo
            planoFundoBtn.onclick = () => {
                backgroundModal.style.display = "flex";
            };

            function aplicarPlanoDeFundo() {
                const file = backgroundImageInput.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = e => {
                        const imageUrl = e.target.result;
                        document.body.style.backgroundImage = `url('${imageUrl}')`;
                        const selectedSize = document.querySelector('input[name="background-size"]:checked').value;
                        document.body.style.backgroundSize = selectedSize;
                        salvarDados();
                        fecharModal('background-modal');
                    };
                    reader.readAsDataURL(file);
                } else if (document.body.style.backgroundImage !== 'none') {
                    const selectedSize = document.querySelector('input[name="background-size"]:checked').value;
                    document.body.style.backgroundSize = selectedSize;
                    salvarDados();
                    fecharModal('background-modal');
                } else {
                    alert("Nenhuma imagem selecionada.");
                }
            }

            function excluirPlanoDeFundo() {
                if (confirm("Tem certeza que deseja remover a imagem de fundo?")) {
                    document.body.style.backgroundImage = 'none';
                    salvarDados();
                    fecharModal('background-modal');
                }
            }

            function aplicarPlanoDeFundoInicial() {
                if (currentFichaId && fichas[currentFichaId] && fichas[currentFichaId].backgroundImage) {
                    document.body.style.backgroundImage = `url('${fichas[currentFichaId].backgroundImage}')`;
                    document.body.style.backgroundSize = fichas[currentFichaId].backgroundSize || 'cover';
                }
            }

            // Funcionalidade da Cor de Fundo
            corFundoBtn.onclick = () => {
                backgroundColorSelector.style.display = backgroundColorSelector.style.display === 'none' ?
                    'flex' : 'none';
            };

            backgroundColorSelector.addEventListener('click', function(event) {
                if (event.target.classList.contains('color-option')) {
                    const color = event.target.dataset.color;
                    document.body.style.backgroundColor = color;
                    salvarDados();
                    backgroundColorSelector.style.display = 'none';
                    const colorOptions = document.querySelectorAll('#background-color-selector .color-option');
                    colorOptions.forEach(option => option.classList.remove('active'));
                    event.target.classList.add('active');
                }
            });

            function aplicarCorDeFundoInicial() {
                if (currentFichaId && fichas[currentFichaId] && fichas[currentFichaId].backgroundColor) {
                    document.body.style.backgroundColor = fichas[currentFichaId].backgroundColor;
                    const colorOptions = document.querySelectorAll('#background-color-selector .color-option');
                    colorOptions.forEach(option => {
                        if (option.dataset.color === fichas[currentFichaId].backgroundColor) {
                            option.classList.add('active');
                        } else {
                            option.classList.remove('active');
                        }
                    });
                }
            }

            carregarFichas();
        </script>
</body>

</html>
