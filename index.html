html
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ficha de Personagem RPG</title>
    <link href="https://fonts.googleapis.com/css2?family=MedievalSharp&family=Inter:wght@400;600&family=Times+New+Roman&family=Arial&family=Courier+New&family=Georgia&family=Verdana&family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --cor-borda-secao: #b8860b;
            --estilo-borda-secao: solid;
            --largura-borda-secao: 2px;
            --ficha-internal-glow: transparent 0 0 0 0 inset; /* Default no glow/shadow */
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0e6d2; /* Cor padr√£o modo claro */
            color: #000;
            display: flex;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            background-image: none;
            background-size: cover;
            background-position: center;
            background-attachment: scroll;
            transition: background-color 0.3s, color 0.3s, font-family 0.3s, box-shadow 0.3s;
            box-shadow: none; /* Ensure no body glow by default */
        }
        body.dark-mode {
            background-color: #121212 !important; /* Cor padr√£o modo escuro */
            color: #e0e0e0;
            box-shadow: none; /* Ensure no body glow in dark mode */
        }
        #fichas-sidebar {
            width: 100%; height: 60px; padding: 0; display: flex; flex-direction: row;
            align-items: center; justify-content: flex-start; position: fixed;
            top: 0; left: 0; z-index: 1000; overflow-x: auto; background: transparent;
        }
        .ficha-tab {
            visibility: visible; width: 100px; height: 50px; background: #f0e6d2;
            border: 2px solid #b8860b; border-radius: 10px 10px 0 0; margin-right: 10px;
            display: flex; align-items: center; justify-content: center; cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.2);
        }
        .ficha-tab:hover, .ficha-tab.active { background: #a0522d; transform: translateY(-5px); }
        .ficha-tab span {
            font-family: 'MedievalSharp', serif; color: #000; font-size: 0.9rem; text-align: center;
            max-width: 90px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
        }
        #add-ficha-btn {
            width: 100px; height: 50px; background: #f0e6d2; border: 2px solid #b8860b;
            border-radius: 10px 10px 0 0; margin-right: 10px; display: flex; align-items: center;
            justify-content: center; cursor: pointer; transition: transform 0.2s ease;
            box-shadow: 0 0 10px #ffd700, 0 0 20px #ffd700; z-index: 1001;
        }
        #add-ficha-btn span { font-family: 'MedievalSharp', serif; color: #000; font-size: 0.9rem; }
        #add-ficha-btn:hover { background: #a0522d; transform: translateY(-5px); }
        #ficha-container {
            background: #f0e6d2;
            padding: 30px; border-radius: 12px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2), var(--ficha-internal-glow); /* MODIFIED: Uses var for internal shadow */
            width: 95%; max-width: 1200px;
            margin: 80px auto 20px; border: 2px solid #b8860b; position: relative; z-index: 1;
            transition: font-family 0.3s, background-color 0.3s, box-shadow 0.3s, border 0.3s;
        }
        body.dark-mode #ficha-container {
            background: #121212; /* Dark mode ficha background */
            color: #e0e0e0;
            /* The var(--ficha-internal-glow) will be transparent in dark mode via JS */
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2), var(--ficha-internal-glow);
        }

        @keyframes pulsar-aura { /* Used for Nivel 30+ Ficha Aura */
            0% { box-shadow: 0 0 20px #00BFFF, 0 0 30px #00BFFF, 0 0 40px #00BFFF, var(--ficha-internal-glow); }
            50% { box-shadow: 0 0 30px #00BFFF, 0 0 50px #00BFFF, 0 0 60px #00BFFF, var(--ficha-internal-glow); }
            100% { box-shadow: 0 0 20px #00BFFF, 0 0 30px #00BFFF, 0 0 40px #00BFFF, var(--ficha-internal-glow); }
        }
        #ficha-container.aura-azul {
            animation: pulsar-aura 2s infinite;
        }

        h1#nome-personagem-titulo {
            font-family: 'MedievalSharp', serif; color: #1C2526; font-size: 3rem; margin-bottom: 20px;
            text-align: center; text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1); animation: raios 2s infinite linear;
             transition: color 0.3s, text-shadow 0.3s;
        }
        body.dark-mode h1#nome-personagem-titulo {
             color: #c58c5a;
        }
        @keyframes raios {
            0% { text-shadow: 0 0 5px #FFD700, 0 0 10px #FFD700, 0 0 15px #FFD700, 0 0 20px #FF4500; }
            50% { text-shadow: 0 0 10px #FFD700, 0 0 15px #FFD700, 0 0 20px #FF4500, 0 0 25px #FF4500; }
            100% { text-shadow: 0 0 5px #FFD700, 0 0 10px #FFD700, 0 0 15px #FFD700, 0 0 20px #FF4500; }
        }
        #game-master-message { display: none; color: blue; font-size: 1.5rem; text-align: center; font-family: 'MedievalSharp', serif; margin-bottom: 10px; }

        section {
            border-width: var(--largura-borda-secao);
            border-style: var(--estilo-borda-secao);
            border-color: var(--cor-borda-secao);
            border-radius: 8px; padding: 15px; margin-bottom: 20px;
            transition: background-color 0.3s, box-shadow 0.3s, border 0.3s; /* Added box-shadow transition for section shadow */
            /* box-shadow is now controlled by JS for sections */
        }
        body.dark-mode section {
             border-color: #555; /* Default dark mode border for sections */
             /* background-color will be set by JS to dark mode default */
             /* box-shadow will be set to none by JS in dark mode */
        }


        section h2 {
            text-align: center; font-family: 'MedievalSharp', serif; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
             transition: color 0.3s;
        }
        section h2 .collapse-icon { margin-left: 10px; font-size: 1.2rem; transition: transform 0.2s; }
        section .section-content.collapsed { display: none; }
        section h2 .collapse-icon.collapsed { transform: rotate(-90deg); }

        label { font-weight: 600; color: #000; margin-bottom: 8px; display: block;  transition: color 0.3s; }
        body.dark-mode label { color: #e0e0e0; }
        input[type="text"], input[type="number"], textarea, select {
            padding: 10px; border: 2px solid #b8860b; border-radius: 6px; width: 100%;
            margin-bottom: 15px; font-size: 1rem; transition: border-color 0.3s ease, background-color 0.3s, color 0.3s;
            background: #fff; color: #000;
            box-sizing: border-box;
        }
        .recurso-atual-input {
            width: 70px !important;
            text-align: center;
            font-family: 'MedievalSharp', serif;
            font-size: 1.1rem;
            padding: 5px 2px;
            margin: 0 3px !important;
            -moz-appearance: textfield;
            box-sizing: border-box;
        }
        .recurso-atual-input::-webkit-outer-spin-button,
        .recurso-atual-input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        body.dark-mode input[type="text"], body.dark-mode input[type="number"], body.dark-mode textarea, body.dark-mode select {
            background: #333; color: #e0e0e0; border-color: #555;
        }
        input[type="text"]:focus, input[type="number"]:focus, textarea:focus, select:focus {
            border-color: #a0522d; outline: none; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        input[readonly], span[readonly] { background: #e8e8e8; border: 1px solid #ccc; cursor: not-allowed; }
        body.dark-mode input[readonly], body.dark-mode span[readonly] { background: #444; border-color: #666; }
        textarea { resize: vertical; }
        .atributos-container { display: flex; justify-content: space-between; gap: 20px; }
        .atributos-coluna, .atributos-coluna-destaque {
            width: 48%; display: flex; flex-direction: column; align-items: flex-start;
            transition: background-color 0.3s, border-color 0.3s;
        }
        .atributos-coluna-destaque { background: #fff; padding: 10px; border-radius: 6px; border: 1px solid #b8860b; }
        body.dark-mode .atributos-coluna-destaque { background: #333; border-color: #555; }
        .atributo-destaque { padding: 8px; margin-bottom: 10px; display: flex; align-items: center; justify-content: space-between; width: 100%; }
        .atributo-destaque label { font-size: 1.1rem; font-weight: 700; color: #a0522d; }
        .atributo-destaque span { font-size: 1.2rem; font-family: 'MedievalSharp', serif; color: #000; transition: color 0.3s; }
        body.dark-mode .atributo-destaque span { color: #e0e0e0; }
        .atributo-fogo { animation: fogo 1.5s infinite; }
        @keyframes fogo {
            0% { text-shadow: 0 0 5px #ff4500, 0 0 10px #ff4500; }
            50% { text-shadow: 0 0 10px #ff4500, 0 0 15px #ffd700; }
            100% { text-shadow: 0 0 5px #ff4500, 0 0 10px #ff4500; }
        }
        .vida-magia-vigor { display: flex; justify-content: space-around; gap: 15px; flex-wrap: wrap; }
        .atributo-container {
            background: rgba(255, 255, 255, 0.8); padding: 12px; border-radius: 8px; border: 1px solid #b8860b;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); width: 30%; min-width: 200px; text-align: center;
             transition: background-color 0.3s, border-color 0.3s, box-shadow 0.3s;
        }
        body.dark-mode .atributo-container { background: rgba(50, 50, 50, 0.8); } /* Will be overridden by JS if fichaInternalBackground is dark mode default */
        .atributo-container::before { font-size: 1.5rem; margin-bottom: 5px; display: block; }
        .atributo-container.vida::before { content: "‚ù§Ô∏è"; }
        .atributo-container.magia::before { content: "‚ú®"; }
        .atributo-container.vigor::before { content: "‚ö°"; }
        .medieval-box { background: #f0e6d2; border: 2px solid #b8860b; border-radius: 8px; padding: 10px; margin: 5px 0; text-align: center; transition: background-color 0.3s, border-color 0.3s;}
        body.dark-mode .medieval-box { background: #1e1e1e; border-color: #444; }
        .valor-atual.medieval-box { display: flex; align-items: center; justify-content: center; }

        .regeneracao { font-size: 0.8rem; color: #555; margin-top: 5px; transition: color 0.3s; }
        body.dark-mode .regeneracao { color: #aaa; }
        button {
            background: #b8860b; color: #fff; border: none; padding: 5px 10px;
            cursor: pointer; font-size: 1.2rem; border-radius: 4px; margin: 0 5px;
            transition: background-color 0.3s ease, transform 0.1s ease, box-shadow 0.1s ease, color 0.3s;
        }
        body.dark-mode button { background: #555; }
        button:hover { background: #a0522d; }
        body.dark-mode button:hover { background: #777; }

        .button-clicked {
            transform: scale(0.97);
            box-shadow: inset 1px 1px 3px rgba(0,0,0,0.3);
        }

        .botoes-container { display: flex; justify-content: center; gap: 10px; margin-top: 20px; margin-bottom: 20px; flex-wrap: wrap; }
        .botao {
            padding: 12px 25px; border: none; border-radius: 6px; font-size: 1rem; cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.1s ease, color 0.3s, text-shadow 0.3s, border 0.3s;
            font-family: 'MedievalSharp', serif;
            color: #fff; text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
        }
        body.dark-mode .botao { background: #555; }
        body.dark-mode .botao:hover { background: #777; }
        #reset-pontos, #recomecar, #bloquear-ficha, #excluir-ficha, #gm-mode-btn, #customizacao-btn {
            background-color: #800000;
        }
        .botao-reset:hover, .botao-recomecar:hover, .botao-bloquear:hover, .botao-desbloquear:hover, #excluir-ficha:hover, #gm-mode-btn:hover, #customizacao-btn:hover {
            background: #a0522d; transform: translateY(-2px);
        }
        #gm-mode-btn.gm-active { background-color: #006400; }

        .icon-btn {
            padding: 10px; width: 44px; height: 44px;
            font-size: 1.2rem; line-height: 1; text-align: center;
        }
        #lua-btn { background-color: #333; color: #eee; }
        #sol-btn { background-color: #ffdd00; color: #333; }
        #nivel-container { text-align: center; margin-top: 10px; }
        #nivel {
            padding: 10px; background: #f0e6d2; border: 3px solid #000; border-radius: 50%;
            width: 100px; height: 100px; display: flex; align-items: center; justify-content: center;
            font-size: 3.125rem; box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.5); margin: 0 auto;
            font-family: 'MedievalSharp', serif;
             transition: background-color 0.3s, border-color 0.3s, box-shadow 0.3s;
        }
        body.dark-mode #nivel { background: #1e1e1e; border-color: #444; }
        #nivel.aura-azul { animation: pulsar-aura 5s 1; }
        .expandable-textarea {
            height: 100px; width: 100%; background: #fff; border: 2px solid #b8860b;
            border-radius: 6px; padding: 10px; font-size: 0.9rem; transition: height 0.3s ease, background-color 0.3s, border-color 0.3s;
        }
        body.dark-mode .expandable-textarea { background: #333; }
        .expandable-textarea:focus { height: 15cm; }

        #dice-container {
            position: absolute; top: 20px; right: 20px; width: auto;
            text-align: center;
            font-family: 'MedievalSharp', serif; cursor: move; z-index: 10; user-select: none;
            perspective: 800px;
        }
        #dice-container label { font-size: 1.2rem; color: #000; display: flex; align-items: center; justify-content: center; margin-bottom: 10px; }
        body.dark-mode #dice-container label { color: #e0e0e0; }
        #dice-container label::before { content: "üé≤"; margin-right: 5px; font-size: 1.5rem; }

        .dice-roll-area { display: flex; align-items: center; justify-content: center; gap: 10px; position: relative;}

        #dice-roll {
            width: 100px; height: 100px;
            background-color: var(--dice-bg-color, #f0e6d2);
            color: var(--dice-number-color, #000000);
            border: 2px solid #b8860b;
            border-radius: 10px;
            display: flex; align-items: center; justify-content: center;
            font-size: 2.5rem;
            cursor: pointer;
            margin: 0;
            position: relative;
            transition: transform 0.3s ease, box-shadow 0.3s ease, background-color 0.3s, color 0.3s, background-image 0.3s, border-color 0.3s;
            font-family: 'MedievalSharp', serif;
            transform-style: preserve-3d;
            background-size: cover;
            background-position: center;
        }
        body.dark-mode #dice-roll { border-color: #444; }

        #dice-roll.is-rolling { animation: rollTheDie 1s ease-out forwards; }
        #dice-roll.is-rolling-fast { animation: rollTheDieFast 0.5s ease-out forwards; }
        #dice-roll.is-rolling-jump { animation: rollTheDieJump 1.2s cubic-bezier(0.5, -0.5, 0.5, 1.5) forwards; }

        @keyframes rollTheDie {
            0% { transform: rotateX(0deg) rotateY(0deg) rotateZ(0deg) scale(1); box-shadow: 0 0 5px #b8860b; }
            25% { transform: rotateX(360deg) rotateY(-270deg) rotateZ(180deg) scale(1.1) translateX(-10px) translateY(5px); box-shadow: 0 0 10px #a0522d, 0 0 15px #FFD700; }
            50% { transform: rotateX(-180deg) rotateY(360deg) rotateZ(-360deg) scale(0.9) translateX(10px) translateY(-10px); box-shadow: 0 0 15px #b8860b, 0 0 20px #a0522d; }
            75% { transform: rotateX(270deg) rotateY(-180deg) rotateZ(270deg) scale(1.05) translateX(-5px) translateY(8px); box-shadow: 0 0 10px #FFD700, 0 0 15px #a0522d; }
            100% { transform: rotateX(0deg) rotateY(0deg) rotateZ(0deg) scale(1); box-shadow: 0 0 5px #b8860b; }
        }
        @keyframes rollTheDieFast {
            0% { transform: rotateZ(0deg) scale(1); }
            100% { transform: rotateZ(720deg) scale(1); }
        }
        @keyframes rollTheDieJump {
            0% { transform: translateY(0) rotate(0deg) scale(1); }
            25% { transform: translateY(-30px) rotate(180deg) scale(1.2); }
            50% { transform: translateY(0) rotate(360deg) scale(1); }
            75% { transform: translateY(-15px) rotate(540deg) scale(1.1); }
            100% { transform: translateY(0) rotate(720deg) scale(1); }
        }

        #dice-result { margin-top: 10px; font-size: 1rem; color: #000; display: none; animation: blink 1s infinite; transition: color 0.3s; }
        body.dark-mode #dice-result { color: #e0e0e0; }
        @keyframes blink { 50% { opacity: 0; } }

        #dice-roll.critical-failure { animation: aura-vermelha 0.5s 4; }
        #dice-roll.critical-success { animation: aura-verde 0.5s 4; }
        @keyframes aura-vermelha {
            0%, 100% { box-shadow: 0 0 5px #ff0000, 0 0 10px #ff0000, 0 0 15px #ff0000 !important; }
            50% { box-shadow: 0 0 20px #ff0000, 0 0 30px #ff0000, 0 0 40px #ff0000 !important; }
        }
        @keyframes aura-verde {
            0%, 100% { box-shadow: 0 0 5px #00ff00, 0 0 10px #00ff00, 0 0 15px #00ff00 !important; }
            50% { box-shadow: 0 0 20px #00ff00, 0 0 30px #00ff00, 0 0 40px #00ff00 !important; }
        }

        #change-dice-type-btn {
            background-color: #d2b48c; color: #3a2800; border: 1px solid #b8860b;
            width: 55px; height: 36px; font-size: 0.9rem; padding: 5px;
            box-sizing: border-box;
             transition: background-color 0.3s, color 0.3s, border-color 0.3s;
        }
        body.dark-mode #change-dice-type-btn { background-color: #4a3c2a; color: #f0e6d2; border-color: #6b5230; }

        #dice-options-menu {
            display: none;
            position: absolute;
            top: 40px;
            right: 0;
            background-color: #f0e6d2;
            border: 1px solid #b8860b;
            border-radius: 4px;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.2);
            z-index: 110;
            padding: 5px;
            flex-direction: column;
            gap: 5px;
             transition: background-color 0.3s, border-color 0.3s;
        }
        body.dark-mode #dice-options-menu { background-color: #1e1e1e; border-color: #444; }
        .dice-option-btn {
            width: 100%;
            padding: 8px 10px;
            font-size: 0.9rem;
            background-color: #e6cca7; color: #3a2800;
            border: 1px solid #b8860b; border-radius: 3px;
            text-align: center;
            margin:0;
             transition: background-color 0.3s, color 0.3s, border-color 0.3s;
        }
        .dice-option-btn:hover { background-color: #d2b48c; }
        body.dark-mode .dice-option-btn { background-color: #3a2f1e; color: #f0e6d2; border-color: #5c4b35; }
        body.dark-mode .dice-option-btn:hover { background-color: #4a3c2a; }

        #fireworks-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 0; pointer-events: none; overflow: hidden;
        }
        .firework-particle {
            position: absolute; border-radius: 50%; opacity: 1;
        }
        @keyframes particle-trail {
            0% { opacity: 1; transform: scale(1) translateY(0px); }
            50% { opacity: 0.7; }
            100% { opacity: 0; transform: scale(0.3) translateY(40px); }
        }

        #dice-history-trigger {
            position: fixed;
            top: calc(50% + 70px);
            right: 10px;
            transform: translateY(-50%);
            padding: 10px 15px;
            background: #a0522d;
            color: white;
            border: 2px solid #b8860b;
            border-right: none;
            border-radius: 6px 0 0 6px;
            font-family: 'MedievalSharp', serif;
            font-size: 1rem;
            cursor: pointer;
            z-index: 1000;
            writing-mode: vertical-rl;
            text-orientation: mixed;
            transition: background-color 0.3s, border-color 0.3s;
        }
        body.dark-mode #dice-history-trigger { background-color: #555; border-color: #444;}

        #dice-history-panel {
            position: fixed;
            right: 50px;
            top: calc(50% + 70px);
            transform: translateY(-50%);
            width: 400px;
            max-height: 400px;
            background: #fff;
            border: 2px solid #b8860b;
            border-radius: 6px;
            padding: 15px;
            font-size: 0.9rem;
            z-index: 1001;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            display: none;
            flex-direction: column;
            transition: background-color 0.3s, border-color 0.3s, color 0.3s;
        }
        body.dark-mode #dice-history-panel { background: #333; color: #e0e0e0; border-color: #555;}

        #dice-history-panel h2 {
            font-family: 'MedievalSharp', serif; font-size: 1.5rem; text-align: center;
            color: #a0522d; margin-bottom: 10px; flex-shrink: 0; transition: color 0.3s;
        }
        body.dark-mode #dice-history-panel h2 { color: #c58c5a;}

        #dice-history-list {
            flex-grow: 1;
            overflow-y: auto;
            background: #f9f2e7;
            border: 1px solid #b8860b;
            border-radius: 4px;
            padding: 8px;
            margin-bottom: 10px;
             transition: background-color 0.3s, border-color 0.3s;
        }
        body.dark-mode #dice-history-list { background: #2a2a2a; border-color: #555; }
        .dice-history-item {
            padding: 6px 4px;
            border-bottom: 1px dashed #d2b48c;
            font-size: 0.9rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: border-bottom-color 0.3s;
        }
        body.dark-mode .dice-history-item { border-bottom-color: #4a3c2a; }
        .dice-history-item:last-child { border-bottom: none; }
        .dice-history-item .timestamp { font-size: 0.7rem; color: #777; margin-left: 8px; white-space: nowrap; transition: color 0.3s; }
        body.dark-mode .dice-history-item .timestamp { color: #aaa; }

        .dice-history-buttons { display: flex; justify-content: space-between; margin-top: auto; flex-shrink: 0;}
        #fechar-historico-btn, #limpar-historico-btn {
            padding: 8px 15px; font-size: 0.9rem; flex-basis: 48%;
        }
        #limpar-historico-btn { background-color: #800000; }
        #limpar-historico-btn:hover { background-color: #a00000; }
        body.dark-mode #limpar-historico-btn { background-color: #400000;}
        body.dark-mode #limpar-historico-btn:hover { background-color: #600000;}

        #notification {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); padding: 20px;
            border-radius: 8px; font-family: 'MedievalSharp', serif; font-size: 1.5rem; color: #fff;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5); display: none; z-index: 2000;
            background: rgba(0, 0, 0, 0.7); transition: opacity 0.3s ease;
        }
        #notification.critical-failure { background: rgba(255, 0, 0, 0.8); animation: aura-vermelha 2s infinite; }
        #notification.critical-success { background: rgba(0, 255, 0, 0.8); animation: aura-verde 2s infinite; }
        #notification.normal-result { animation: blink 1s infinite; }
        #notification.save-success { background: rgba(0, 200, 0, 0.8); }

        #character-image-container {
            position: absolute; top: 10px; left: 10px; width: 100px; height: 100px; background: #f0e6d2;
            border: 2px solid #b8860b; border-radius: 8px; display: flex; align-items: center;
            justify-content: center; cursor: pointer; overflow: hidden; z-index: 10;
            transition: background-color 0.3s, border-color 0.3s;
        }
        body.dark-mode #character-image-container { background: #1e1e1e; }
        #character-image { width: 100%; height: 100%; object-fit: cover; display: none; }
        #character-image-container:hover { box-shadow: 0 0 10px #ffd700; }
        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.5); justify-content: center; align-items: center; z-index: 1000;
        }
        .modal-content {
            background: #f0e6d2; padding: 20px; border-radius: 8px; border: 2px solid #b8860b;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3); width: 300px; text-align: center;
            transition: background-color 0.3s, border-color 0.3s;
        }
        body.dark-mode .modal-content { background: #1e1e1e; border-color: #444; }
        .modal-content h3 { font-family: 'MedievalSharp', serif; color: #000; margin-bottom: 15px; transition: color 0.3s; }
        body.dark-mode .modal-content h3 { color: #e0e0e0; }
        .modal-content input, .modal-content select {
            width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 6px;
        }
        body.dark-mode .modal-content input, body.dark-mode .modal-content select { background: #333; color: #e0e0e0; border-color: #555; }
        .modal-content button {
            padding: 10px 20px; border: none; border-radius: 6px; font-family: 'MedievalSharp', serif;
            color: #fff; cursor: pointer; margin: 0 5px;
        }
        .modal-content .confirm-btn { background: #b8860b; }
        .modal-content .confirm-btn:hover { background: #a0522d; }
        .modal-content .cancel-btn { background: #a52a2a; }
        .modal-content .cancel-btn:hover { background: #8b0000; }

        #customizacao-modal .modal-content {
            width: 550px;
            max-height: 90vh;
            overflow-y: auto;
            text-align: left;
        }
        #customizacao-modal .modal-content h3 {
            text-align: center;
            font-size: 1.8rem;
            color: #a0522d;
        }
        body.dark-mode #customizacao-modal .modal-content h3 { color: #c58c5a;}

        #customizacao-modal fieldset {
            border: 1px solid #b8860b;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 20px;
            transition: border-color 0.3s;
        }
        body.dark-mode #customizacao-modal fieldset { border-color: #555; }

        #customizacao-modal legend {
            font-family: 'MedievalSharp', serif;
            font-size: 1.3rem;
            color: #800000;
            padding: 0 10px;
            font-weight: bold;
            transition: color 0.3s;
        }
        body.dark-mode #customizacao-modal legend { color: #d2b48c;}

        #customizacao-modal .input-group {
            margin-bottom: 15px;
        }
        #customizacao-modal .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: normal;
        }
        #customizacao-modal .input-group input[type="color"],
        #customizacao-modal .input-group input[type="file"],
        #customizacao-modal .input-group select,
        #customizacao-modal .input-group input[type="number"],
        #customizacao-modal .input-group input[type="range"] {
            width: 100%;
            box-sizing: border-box;
        }

        #customizacao-modal .radio-group label {
            display: inline-block;
            margin-right: 15px;
            font-weight: normal;
        }
        #customizacao-modal .radio-group input[type="radio"] {
           width: auto;
           margin-right: 5px;
        }
        #customizacao-modal .custom-dice-texture-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }
        #customizacao-modal .custom-dice-texture-controls button {
            flex-shrink: 0;
        }


        #vantagens-desvantagens-btn, #racas-btn, #classes-btn {
            padding: 10px 20px; background: #f0e6d2; border: 2px solid #b8860b; border-radius: 6px;
            font-family: 'MedievalSharp', serif; font-size: 1rem; color: #000; cursor: pointer;
            transition: background-color 0.3s ease, border-color 0.3s, color 0.3s; z-index: 10;
        }
        body.dark-mode #vantagens-desvantagens-btn, body.dark-mode #racas-btn, body.dark-mode #classes-btn {
            background: #1e1e1e; color: #e0e0e0;
        }
        #vantagens-desvantagens-btn:hover, #racas-btn:hover, #classes-btn:hover { background: #a0522d; color: #fff; }
        #vantagens-desvantagens-panel, #racas-panel, #classes-panel {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(240, 230, 210, 0.95); padding: 20px; overflow-y: auto; z-index: 999;
            border: 2px solid #b8860b; box-shadow: 0 0 20px rgba(0, 0, 0, 0.3);
             transition: background-color 0.3s, border-color 0.3s;
        }
        body.dark-mode #vantagens-desvantagens-panel, body.dark-mode #racas-panel, body.dark-mode #classes-panel {
            background: rgba(30, 30, 30, 0.95);
        }
        #vantagens-desvantagens-panel h2, #racas-panel h2, #classes-panel h2 {
            font-family: 'MedievalSharp', serif; font-size: 2rem; text-align: center;
            color: #a0522d; margin-bottom: 20px; transition: color 0.3s;
        }
        #racas-panel h2 { font-size: 3rem; }
        .vantagem-item, .desvantagem-item, .raca-item {
            padding: 10px; margin: 5px 0; background: #fff; border: 1px solid #ccc;
            border-radius: 6px; cursor: pointer; transition: background-color 0.3s ease, border-color 0.3s, color 0.3s;
        }
        body.dark-mode .vantagem-item, body.dark-mode .desvantagem-item, body.dark-mode .raca-item {
            background: #333; border-color: #555;
        }
        .vantagem-item:hover, .desvantagem-item:hover, .raca-item:hover { background: #f0e6d2; }
        body.dark-mode .vantagem-item:hover, body.dark-mode .desvantagem-item:hover, body.dark-mode .raca-item:hover { background: #444; }
        .vantagem-item.comprada, .raca-item.comprada { background: #ffcccc; color: #f00; cursor: default; }
        .desvantagem-item.comprada { background: #ccffcc; color: #080; cursor: default; }
        #salvar-vantagens-btn, #salvar-racas-btn, #fechar-pagina-btn, #fechar-racas-btn, #fechar-classes-btn {
            position: fixed; bottom: 20px; padding: 12px 25px; background: #a52a2a; color: #fff;
            border: none; border-radius: 6px; font-family: 'MedievalSharp', serif; font-size: 1.2rem;
            cursor: pointer; transition: transform 0.2s ease, background-color 0.3s;
        }
        #salvar-vantagens-btn, #salvar-racas-btn { right: 250px; animation: aura-verde-btn 2s infinite; display: none; background: #000; }
        #fechar-pagina-btn, #fechar-racas-btn, #fechar-classes-btn { right: 20px; }
        #salvar-vantagens-btn:hover, #salvar-racas-btn:hover, #fechar-pagina-btn:hover, #fechar-racas-btn:hover, #fechar-classes-btn:hover {
            transform: translateY(-2px);
        }
        @keyframes aura-verde-btn {
            0% { box-shadow: 0 0 5px #00ff00, 0 0 10px #00ff00; }
            50% { box-shadow: 0 0 15px #00ff00, 0 0 20px #00ff00; }
            100% { box-shadow: 0 0 5px #00ff00, 0 0 10px #00ff00; }
        }
        .locomotion-container { background: #8B4513; border: 3px solid #FFD700; border-radius: 10px; padding: 15px; color: #FFD700; font-family: 'MedievalSharp', serif; transition: background-color 0.3s, border-color 0.3s, color 0.3s; }
        .locomotion-item { display: flex; align-items: center; margin-bottom: 10px; }
        .locomotion-item label { font-weight: bold; color: #FFD700; }
        .locomotion-item span { font-size: 1.2rem; color: #FFF; text-shadow: 1px 1px 2px #000; margin-left: 5px; font-weight: bold; }
        #distancia-pulo, #altura-pulo, #velocidade-corrida { background-color: #8B4513; border-color: #8B4513; }
        .list-display { background: #fff; border: 2px solid #b8860b; border-radius: 6px; padding: 10px; min-height: 100px; max-height: 200px; overflow-y: auto;  transition: background-color 0.3s, border-color 0.3s;}
        body.dark-mode .list-display { background: #333; border-color: #555; }
        .list-item { cursor: pointer; margin-bottom: 5px; padding: 5px; border-bottom: 1px solid #ccc; transition: border-color 0.3s;}
        body.dark-mode .list-item { border-color: #555; }
        .list-item:hover { background: #e0e0e0; }
        body.dark-mode .list-item:hover { background: #444; }
        .inventory-slot { display: flex; align-items: center; margin-bottom: 10px; }
        .inventory-slot input[type="text"] { flex-grow: 1; margin-right: 10px; }
        .inventory-slot input[type="number"] { width: 60px; }
        #anotacoes-btn {
            position: fixed; left: 10px; top: 50%; transform: translateY(-50%); padding: 10px 15px;
            background: #f0e6d2; border: 2px solid #b8860b; border-left: none;
            border-radius: 0 6px 6px 0;
            font-family: 'MedievalSharp', serif; font-size: 1rem; color: #000; cursor: pointer;
            transition: background-color 0.3s ease, border-color 0.3s; z-index: 1000;
            writing-mode: vertical-rl; text-orientation: mixed;
        }
        body.dark-mode #anotacoes-btn { background: #1e1e1e; color: #e0e0e0; border-color: #444;}
        #anotacoes-btn:hover { background: #a0522d; color: #fff; }
        #anotacoes-textarea {
            display: none; position: fixed; left: 50px;
            top: 50%; transform: translateY(-50%);
            width: 400px; height: 400px; background: #fff; border: 2px solid #b8860b;
            border-radius: 6px; padding: 10px; font-size: 0.9rem; resize: none; z-index: 1001;
             transition: background-color 0.3s, border-color 0.3s, color 0.3s;
        }
        body.dark-mode #anotacoes-textarea { background: #333; color: #e0e0e0; }

        /*******************************************************
        *      STYLES FOR UPGRADED MAGIC SYSTEM START HERE     *
        ********************************************************/

        .magias-container {
            max-height: 400px; /* Increased height */
            overflow-y: auto;
            border: 2px solid #b8860b;
            border-radius: 6px;
            padding: 10px;
            background: #fff;
            transition: background-color 0.3s, border-color 0.3s;
        }
        body.dark-mode .magias-container { background: #333; border-color: #555; }

        .magia-item {
            display: flex;
            flex-direction: column;
            gap: 5px;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px dashed #b8860b;
        }
         body.dark-mode .magia-item { border-bottom-color: #555; }
        .magia-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        .magia-item .magia-nome {
             font-weight: bold;
             margin-bottom: 5px !important;
             font-size: 1.1rem;
        }
        .magia-detalhes {
            display: flex;
            align-items: center;
            flex-wrap: wrap; /* Allow wrapping on small screens */
            gap: 10px;
        }
        .magia-detalhes input, .magia-detalhes select {
            margin-bottom: 0 !important; /* Override default margin */
            padding: 8px;
            font-size: 0.9rem;
        }
        /* --- MODIFIED: Adjusted width and added new class for vigor cost --- */
        .magia-detalhes .magia-custo, .magia-detalhes .magia-custo-vigor {
            width: 60px !important; text-align: center;
        }
        .magia-detalhes .magia-dano { flex-grow: 1; min-width: 100px;}
        .magia-detalhes .magia-tipo { width: 120px !important; flex-grow: 1; }
        .lancar-magia-btn {
             font-size: 1.3rem;
             padding: 4px 8px;
             line-height: 1;
             min-width: 40px;
             flex-shrink: 0;
             margin-left: auto !important; /* Push button to the end */
        }
        .lancar-magia-btn:hover {
            box-shadow: 0 0 8px #00e5ff;
            text-shadow: 0 0 5px #fff;
        }
        body.dark-mode .lancar-magia-btn:hover {
             box-shadow: 0 0 8px #c58c5a;
        }

        #adicionar-magia-btn {
            background: #b8860b; color: #fff; padding: 8px 16px; border-radius: 6px;
            cursor: pointer; display: block; margin-top: 10px;
        }
        #adicionar-magia-btn:hover { background: #a0522d; }
        body.dark-mode #adicionar-magia-btn { background: #555; }
        body.dark-mode #adicionar-magia-btn:hover { background: #777; }

        /*******************************************************
        *       STYLES FOR UPGRADED MAGIC SYSTEM END HERE      *
        ********************************************************/


        .classe-raca-container { background: #f0e6d2; border: 2px solid #b8860b; padding: 10px; border-radius: 6px; margin-top: 10px; transition: background-color 0.3s, border-color 0.3s;}
        body.dark-mode .classe-raca-container { background: #1e1e1e; border-color: #444; }
        .classe-raca-container label { font-family: 'MedievalSharp', serif; color: #a0522d; font-size: 1.2rem; transition: color 0.3s;}
        .classe-raca-container span[data-action="abrir-modal-raca"] { background: #fff; border: 2px solid #b8860b; padding: 10px; cursor: pointer; display: block;  transition: background-color 0.3s, border-color 0.3s;}
        body.dark-mode .classe-raca-container span[data-action="abrir-modal-raca"] { background: #333; color: #e0e0e0; }
        .classe-raca-container textarea { width: 100%; background: #fff; border: 2px solid #b8860b; }
        body.dark-mode .classe-raca-container textarea { background: #333; color: #e0e0e0; }
        .raca-item { margin-bottom: 20px; padding: 10px; background: #fff; border: 2px solid #b8860b; border-radius: 6px; }
        .raca-item h3 { font-family: 'MedievalSharp', serif; font-size: 1.5rem; color: #a0522d;  transition: color 0.3s;}
        .raca-item p { font-size: 1rem; color: #000; transition: color 0.3s;}
        body.dark-mode .raca-item { background: #333; border-color: #555; }
        body.dark-mode .raca-item p { color: #e0e0e0; }
        .theme-buttons-container { display: flex; justify-content: center; align-items:center; gap: 10px; margin-top: -10px; margin-bottom: 20px; flex-wrap: wrap; }

        .lock-icon { margin-left: 5px; cursor: help; }

        .gm-edit-icon {
            font-size: 0.8rem;
            margin-left: 5px;
            cursor: pointer;
            display: none;
            color: #007bff;
        }
        body.gm-mode-active .gm-edit-icon {
            display: inline;
        }
        body.dark-mode .gm-edit-icon {
            color: #61dafb;
        }
        .gm-edit-icon:hover {
            text-shadow: 0 0 3px currentColor;
        }
        #custom-tooltip {
            position: absolute;
            visibility: hidden;
            background-color: #333;
            color: white;
            padding: 8px 12px;
            border-radius: 5px;
            font-size: 0.85rem;
            z-index: 2000;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s ease-in-out;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            max-width: 250px;
            text-align: left;
        }
        body.dark-mode #custom-tooltip {
            background-color: #f0e6d2;
            color: #1e1e1e;
            border: 1px solid #444;
        }
        #custom-tooltip.visible {
            visibility: visible;
            opacity: 1;
        }

        #confirmar-salvar-atributos-texto {
            background-color: yellow; /* Amarelo */
            color: #333; /* Texto escuro para contraste com amarelo */
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px; /* Added margin for spacing */
            animation: glow-red-text 1.5s infinite alternate;
            font-weight: bold;
            font-size: 1.1rem; /* Slightly larger font for emphasis */
        }

        @keyframes glow-red-text {
            0% { text-shadow: 0 0 5px red, 0 0 10px red; box-shadow: 0 0 8px yellow, inset 0 0 5px rgba(255,0,0,0.3); }
            100% { text-shadow: 0 0 10px red, 0 0 15px orangered, 0 0 20px orangered; box-shadow: 0 0 15px yellow, inset 0 0 10px rgba(255,0,0,0.5); }
        }

        /**********************************************
        *      NEW STYLES START HERE                 *
        ***********************************************/

        .attribute-dice-icon {
            cursor: pointer;
            margin-left: 8px;
            display: inline-block;
            transition: transform 0.2s;
            font-size: 1rem;
            user-select: none;
        }

        .attribute-dice-icon:hover {
            transform: scale(1.2);
        }

        .attribute-dice-icon.selected {
            animation: glow-yellow 1s infinite alternate;
        }

        @keyframes glow-yellow {
            from {
                text-shadow: 0 0 5px #ffd700, 0 0 10px #ffd700, 0 0 15px #ff8c00;
            }
            to {
                text-shadow: 0 0 10px #ffd700, 0 0 20px #ffae42, 0 0 25px #ff8c00;
                transform: scale(1.1);
            }
        }

        #notification .final-sum-result {
            font-size: 2.5em; /* Significantly larger */
            font-weight: bold;
            display: inline-block; /* Needed for animation */
            animation: rgb-flicker 0.5s infinite;
        }

        @keyframes rgb-flicker {
            0%   { color: red; text-shadow: 0 0 5px red; }
            25%  { color: lime; text-shadow: 0 0 5px lime;}
            50%  { color: blue; text-shadow: 0 0 5px blue;}
            75%  { color: yellow; text-shadow: 0 0 5px yellow;}
            100% { color: magenta; text-shadow: 0 0 5px magenta;}
        }

        /**********************************************
        *      NEW THEME STYLES START HERE            *
        ***********************************************/

        /* --- Animations --- */
        @keyframes futuristic-glow {
            from { text-shadow: 0 0 4px #fff, 0 0 8px #fff, 0 0 12px #00aaff, 0 0 16px #00aaff; }
            to { text-shadow: 0 0 8px #fff, 0 0 12px #00aaff, 0 0 16px #00aaff, 0 0 20px #00aaff; }
        }
        @keyframes fire-flicker-shadow {
            0%,100% { text-shadow: 0 0 4px #fff, 0 0 10px #ff0, 0 0 20px #f80; }
            50% { text-shadow: 0 0 6px #fff, 0 0 15px #ff0, 0 0 25px #f60; }
        }
        @keyframes fire-flicker-border {
            0%,100% { border-color: #f80; box-shadow: 0 0 10px #f80; }
            50% { border-color: #ff0; box-shadow: 0 0 20px #ff0; }
        }
        @keyframes water-flow {
            0%{background-position:0% 50%}
            50%{background-position:100% 50%}
            100%{background-position:0% 50%}
        }
        @keyframes air-drift {
            0% { transform: translateX(0); opacity: 0.7; }
            50% { transform: translateX(5px); opacity: 1; }
            100% { transform: translateX(0); opacity: 0.7; }
        }
        @keyframes earth-rumble-shadow {
             0%, 100% { text-shadow: 1px 1px 2px #3d2b1f; }
             50% { text-shadow: -1px -1px 2px #3d2b1f; }
        }

        /* --- Futuristic Theme --- */
        .theme-futurista {
            font-family: 'Orbitron', sans-serif !important;
            background: #05080d url('data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"%3E%3Cg fill="%230a142e" fill-opacity="0.4"%3E%3Crect x="0" y="0" width="100" height="1"/%3E%3Crect x="0" y="0" width="1" height="100"/%3E%3C/g%3E%3C/svg%3E') !important;
            color: #00e5ff;
        }
        .theme-futurista #ficha-container {
            background-color: rgba(1, 4, 15, 0.85);
            border: 2px solid #00aaff;
            border-radius: 4px;
            box-shadow: 0 0 25px rgba(0, 170, 255, 0.6), inset 0 0 15px rgba(0, 170, 255, 0.4);
        }
        .theme-futurista h1#nome-personagem-titulo { font-family: 'Orbitron', sans-serif !important; color: #ffffff; animation: futuristic-glow 1.5s infinite alternate; }
        .theme-futurista section {
            background-color: rgba(10, 25, 50, 0.7);
            border-color: #0077cc;
            border-style: solid;
            box-shadow: inset 0 0 8px rgba(0, 120, 200, 0.5);
        }
        .theme-futurista section h2, .theme-futurista .atributo-destaque label { font-family: 'Orbitron', sans-serif !important; color: #00e5ff; }
        .theme-futurista .botao, .theme-futurista button {
            background-color: transparent; border: 2px solid #00aaff; color: #00e5ff;
            text-shadow: 0 0 5px #00e5ff; border-radius: 4px;
        }
        .theme-futurista .botao:hover, .theme-futurista button:hover { background-color: rgba(0, 170, 255, 0.2); transform: scale(1.05); }
        .theme-futurista input, .theme-futurista textarea, .theme-futurista select {
            background-color: #0a1020; color: #00e5ff; border: 1px solid #0077cc;
        }
        .theme-futurista #dice-roll { background-color: #0a1020; color: #00e5ff; border-color: #00aaff; box-shadow: 0 0 10px #00aaff; }

        /* --- Elemental Fogo Theme --- */
        .theme-elemental-fogo { background-color: #2b0c00 !important; }
        .theme-elemental-fogo #ficha-container {
            background-color: rgba(50, 0, 0, 0.7);
            border: 2px solid #ff4500;
            box-shadow: 0 0 30px #ff4500, inset 0 0 20px #8b0000;
            animation: fire-flicker-border 3s infinite linear;
        }
        .theme-elemental-fogo h1, .theme-elemental-fogo h2, .theme-elemental-fogo .atributo-destaque label { color: #ffd700; animation: fire-flicker-shadow 2s infinite alternate; }
        .theme-elemental-fogo section { background-color: rgba(60, 10, 0, 0.7); border-color: #f80; }
        .theme-elemental-fogo .botao, .theme-elemental-fogo button { background: #c04000; border: 1px solid #ff4500; color: #fff; }
        .theme-elemental-fogo input, .theme-elemental-fogo textarea { background-color: #4a1c00; border-color: #c04000; color: #ffebcd; }
        .theme-elemental-fogo #dice-roll {
             background: radial-gradient(circle, #ffcc00 0%, #ff4500 100%); color: #401000;
             border: 2px solid #f80; text-shadow: 0 0 5px #fff; animation: fire-flicker-border 2s infinite alternate;
        }

        /* --- Elemental Agua Theme --- */
        .theme-elemental-agua { background-color: #0b2c3c !important; color: #e0f7fa; }
        .theme-elemental-agua #ficha-container {
            background: linear-gradient(135deg, rgba(20, 80, 120, 0.8), rgba(5, 40, 60, 0.8));
            background-size: 200% 200%;
            border: 2px solid #33cccc;
            border-radius: 20px;
            box-shadow: 0 0 25px #33cccc, inset 0 0 15px rgba(51, 204, 204, 0.4);
            animation: water-flow 8s ease infinite;
        }
        .theme-elemental-agua section { border-radius: 15px; background-color: rgba(10, 50, 80, 0.7); border-color: #17a2b8; }
        .theme-elemental-agua h1, .theme-elemental-agua h2, .theme-elemental-agua .atributo-destaque label { color: #b2ebf2; text-shadow: 0 0 8px #fff; }
        .theme-elemental-agua .botao, .theme-elemental-agua button { background-color: #007b8a; border-radius: 50px; border: 1px solid #17a2b8; }
        .theme-elemental-agua input, .theme-elemental-agua textarea { background-color: #0f3f54; border-color: #17a2b8; border-radius: 10px; color: #e0f7fa; }
        .theme-elemental-agua #dice-roll {
             background: radial-gradient(circle, #b2ebf2, #17a2b8); color: #0b2c3c;
             border-radius: 50%; border: 2px solid #33cccc; box-shadow: 0 0 10px #33cccc, inset 0 0 8px #fff;
        }

        /* --- Elemental Ar Theme --- */
        .theme-elemental-ar { background-color: #e8f7fe !important; color: #2c3e50; }
        .theme-elemental-ar #ficha-container {
            background-color: rgba(255, 255, 255, 0.7);
            border: 2px solid #add8e6;
            box-shadow: 0 0 30px rgba(173, 216, 230, 0.7); backdrop-filter: blur(3px);
        }
        .theme-elemental-ar section { background-color: rgba(240, 248, 255, 0.8); border-color: #cce7ff; border-style: dashed; animation: air-drift 10s infinite alternate; }
        .theme-elemental-ar h1, .theme-elemental-ar h2, .theme-elemental-ar .atributo-destaque label { color: #3498db; }
        .theme-elemental-ar .botao, .theme-elemental-ar button { background-color: #a7d7ec; color: #2c3e50; border: none; text-shadow: none; }
        .theme-elemental-ar input, .theme-elemental-ar textarea { background-color: #f0f8ff; border-color: #a7d7ec; }
        .theme-elemental-ar #dice-roll {
            background: #fff; color: #3498db; border-color: #a7d7ec;
            box-shadow: 0 0 15px #a7d7ec; opacity: 0.9;
        }

        /* --- Elemental Terra Theme --- */
        .theme-elemental-terra { background-color: #3e2e21 !important; }
        .theme-elemental-terra #ficha-container {
            background-color: rgba(139, 69, 19, 0.7);
            border-image: url('data:image/svg+xml,%3Csvg width="100" height="100" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"%3E%3Cpath d="M7.7,64.4c2.9-2.3,4.3-5.5,4.3-8.8c0-3.9-1.9-7.5-5.2-9.7c-2.3-1.6-4.9-2.4-7.8-2.4c-8,0-14.4,6.5-14.4,14.4 c0,8,6.5,14.4,14.4,14.4c1.1,0,2.2-0.1,3.3-0.4c0.9,1.7,2.2,3.3,4,4.6c2.9,2.2,6.4,3.3,10.2,3.3c3.2,0,6.2-0.8,8.8-2.5 c-3.3-3-5-7.1-5-11.4C20.4,70.5,15.1,65.2,7.7,64.4z" fill="%23654321"/%3E%3C/svg%3E') 30 stretch;
            border-width: 15px;
            border-style: solid;
        }
        .theme-elemental-terra section { background-color: rgba(111, 60, 20, 0.7); border: 2px solid #5d4037; }
        .theme-elemental-terra h1, .theme-elemental-terra h2 { color: #f0e2d2; text-shadow: 2px 2px 3px #3e2e21; font-weight: bold; animation: earth-rumble-shadow 4s infinite; }
        .theme-elemental-terra .atributo-destaque label { color: #f0e2d2; }
        .theme-elemental-terra .botao, .theme-elemental-terra button { background-color: #5d4037; color: #f0e2d2; text-shadow: 1px 1px 2px #000; font-weight: bold; border: 1px solid #3e2e21;}
        .theme-elemental-terra input, .theme-elemental-terra textarea { background-color: #d7ccc8; color: #3e2e21; border-color: #5d4037; font-weight: bold; }
        .theme-elemental-terra #dice-roll {
            background-image: url('data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="100" height="100"%3E%3Cdefs%3E%3Cpattern id="p" width="100" height="100" patternUnits="userSpaceOnUse"%3E%3Cpath id="a" data-color="fill" fill="%235a4433" d="M11 0a5 5 0 0 0-5 5v3l-5 5v3l-1 1v5l1 1v2l-1 1v4l1 1v2l-1 1v5l1 1v2l-1 1v4l1 1v3l5 5h3l5-5h2l-1-1h4l1 1h2l-1-1h4l1 1h2l-1-1h4l1 1h2l-1-1h4l1 1h2l5-5h3l5 5h3l-5-5v-3l5-5v-3l1-1v-5l-1-1v-2l1-1v-4l-1-1v-2l1-1v-5l-1-1v-2l1-1v-4l-1-1v-2l-1-1v-5l-1-1v-3l-5-5h-3l-5 5h-2l1 1h-4l-1-1h-2l1 1h-4l-1-1h-2l1 1h-4l-1-1h-2l1 1h-4l-1-1h-2l-5 5h-3z"/%3E%3C/pattern%3E%3C/defs%3E%3Crect fill="url(%23p)" width="100%" height="100%"/%3E%3C/svg%3E');
            color: #f0e2d2; border-color: #3e2e21; border-width: 3px; font-weight: bold; text-shadow: 2px 2px 2px #000;
        }

        /**********************************************
        *          NEW THEME STYLES END HERE          *
        ***********************************************/

        /**********************************************
        *      STYLES FOR NEW BUTTONS START HERE       *
        ***********************************************/

        /* Um cont√™iner para o input e seus bot√µes de +/- */
        .input-com-botoes-wrapper {
            display: flex;
            align-items: center;
            gap: 5px; /* Espa√ßo entre os bot√µes e o input */
            margin-left: auto; /* Alinha o grupo de input √† direita */
        }

        /* Reduz o tamanho dos inputs de atributo para caber os bot√µes */
        .input-com-botoes-wrapper input[type="number"] {
            width: 70px !important;
            text-align: center;
            margin: 0 !important; /* Sobrescreve a margem padr√£o */
            font-size: 1.1rem;
            -moz-appearance: textfield; /* Remove os seletores padr√£o do Firefox */
        }

        /* Remove os seletores padr√£o do Chrome/Safari/Edge */
        .input-com-botoes-wrapper input[type="number"]::-webkit-outer-spin-button,
        .input-com-botoes-wrapper input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        /* Estilo dos novos bot√µes de atributo e experi√™ncia */
        .attr-btn {
            background: #b8860b;
            color: #fff;
            border: none;
            padding: 0;
            cursor: pointer;
            font-size: 1.5rem; /* Um pouco maior para facilitar o toque */
            line-height: 1;
            border-radius: 4px;
            transition: background-color 0.3s ease, transform 0.1s ease;
            width: 34px; /* Largura fixa */
            height: 34px; /* Altura fixa */
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0;
        }

        body.dark-mode .attr-btn {
            background: #555;
        }

        .attr-btn:hover {
            background: #a0522d;
        }
        body.dark-mode .attr-btn:hover {
             background: #777;
        }
        
        /* Ajusta o layout da linha do atributo prim√°rio para que os bot√µes fiquem alinhados */
        #atributos .atributo, #status .status-item {
             display: flex;
             justify-content: space-between;
             align-items: center;
             margin-bottom: 10px;
        }
        #atributos .atributo label, #status .status-item label {
            flex-grow: 1;
             margin-bottom: 0; /* Remove a margem padr√£o para melhor alinhamento */
        }
        #status .status-item label {
            display:flex;
            align-items:center;
        }
        /**********************************************
        *       STYLES FOR NEW BUTTONS END HERE        *
        ***********************************************/


        @media (max-width: 768px) {
            body { padding: 10px; }
            #ficha-container { padding: 15px; margin-top: 70px; }
            h1#nome-personagem-titulo { font-size: 2rem; }
            section h2 { font-size: 1.2rem; }
            input, textarea, select { font-size: 0.9rem; }
            .atributos-container, .vida-magia-vigor { flex-direction: column; }
            .atributos-coluna, .atributos-coluna-destaque, .atributo-container { width: 100%; }
            .botoes-container, .theme-buttons-container { flex-wrap: wrap; }
            #inventario-habilidades > .section-content > .flex { flex-direction: column; }
            #inventario-habilidades > .section-content > .flex > div { width: 100%; }


             #dice-container { 
                position: relative; 
                top: auto; right: auto; 
                margin: 0 auto 20px auto;
                width: 100%;
            }
            #dice-roll { width: 80px; height: 80px; font-size: 2rem; }
            #change-dice-type-btn {width: 45px; font-size: 0.8rem;}
            #dice-options-menu { top: 35px; }

            #anotacoes-btn { padding: 8px 10px; font-size: 0.9rem;}
            #anotacoes-textarea { left: 40px; width: calc(100vw - 60px); height: 300px; }

            #dice-history-trigger {
                padding: 8px 10px; font-size: 0.9rem;
                top: calc(50% + 120px);
            }
            #dice-history-panel {
                right: 40px; width: calc(100vw - 60px); max-height: 300px;
                top: calc(50% + 120px);
            }
            #customizacao-modal .modal-content {
                 width: 90%;
            }
            /* Responsive Magic section */
            .magia-detalhes { flex-wrap: wrap; }
        }
        #raca-opcoes-modal .modal-content button:nth-child(2) { margin-top: 10px; }

    </style>
</head>
<body class="">
    <div id="fichas-sidebar">
        <div id="add-ficha-btn"><span>+ Fichas</span></div>
    </div>
    <div id="ficha-container">
        <h1 id="nome-personagem-titulo">Ficha de Personagem</h1>
        <div id="game-master-message">Voc√™ virou o Game Master</div>
        <div id="character-image-container">
            <img id="character-image" alt="Imagem do Personagem">
            <input type="file" id="character-image-input" accept="image/*" style="display:none">
        </div>
        <div id="dice-container">
            <label>Role seu dado:</label>
            <div class="dice-roll-area">
                <div id="dice-roll">-</div>
                <button id="change-dice-type-btn" class="botao icon-btn" title="Mudar Tipo de Dado">D20</button>
            </div>
            <div id="dice-options-menu">
                <button class="dice-option-btn" data-dice-max="20">D20</button>
                <button class="dice-option-btn" data-dice-max="12">D12</button>
                <button class="dice-option-btn" data-dice-max="6">D6</button>
                <button class="dice-option-btn" data-dice-max="4">D4</button>
                <button class="dice-option-btn" data-dice-max="3">D3</button>
            </div>
            <div id="dice-result"></div>
        </div>
        <div id="ficha-content">
            <section id="informacoes-basicas">
                <h2>Informa√ß√µes B√°sicas <span class="collapse-icon">‚ñº</span></h2>
                <div class="section-content">
                    <label for="nome-personagem">Nome do Personagem:</label>
                    <input type="text" id="nome-personagem" placeholder="Digite o nome do seu personagem">
                    <label for="descricao-personagem">Descri√ß√£o do Personagem:</label>
                    <textarea id="descricao-personagem" placeholder="Digite a descri√ß√£o do seu personagem"></textarea>
                </div>
            </section>
            <section id="recursos">
                <h2>Recursos <span class="collapse-icon">‚ñº</span></h2>
                <div class="section-content">
                    <div class="vida-magia-vigor">
                        <div class="atributo-container vida">
                            <h3>Vida</h3>
                            <div class="valor-total medieval-box">
                                <span>Vida Total: </span>
                                <span id="vida-total">50</span> <span class="gm-edit-icon" data-target-id="vida-total" data-label="Vida Total">‚úèÔ∏è</span>
                            </div>
                            <div class="valor-atual medieval-box">
                                <span>Vida Atual: </span>
                                <button id="btn-diminuir-vida" title="Diminuir Vida">‚ñº</button>
                                <input type="number" id="vida-atual-input" class="recurso-atual-input" value="50" min="0">
                                <button id="btn-aumentar-vida" title="Aumentar Vida">‚ñ≤</button>
                            </div>
                            <div class="regeneracao">
                                <span>Regenera√ß√£o por turno: <span id="regeneracao-vida">0</span> (parado)</span>
                            </div>
                        </div>
                        <div class="atributo-container magia">
                            <h3>Magia</h3>
                            <div class="valor-total medieval-box">
                                <span>Magia Total: </span>
                                <span id="magia-total">20</span> <span class="gm-edit-icon" data-target-id="magia-total" data-label="Magia Total">‚úèÔ∏è</span>
                            </div>
                            <div class="valor-atual medieval-box">
                                <span>Magia Atual: </span>
                                <button id="btn-diminuir-magia" title="Diminuir Magia">‚ñº</button>
                                <input type="number" id="magia-atual-input" class="recurso-atual-input" value="20" min="0">
                                <button id="btn-aumentar-magia" title="Aumentar Magia">‚ñ≤</button>
                            </div>
                            <div class="regeneracao">
                                <span>Regenera√ß√£o por turno: <span id="regeneracao-magia">0</span></span>
                            </div>
                        </div>
                        <div class="atributo-container vigor">
                            <h3>Vigor</h3>
                            <div class="valor-total medieval-box">
                                <span>Vigor Total: </span>
                                <span id="vigor-total">10</span> <span class="gm-edit-icon" data-target-id="vigor-total" data-label="Vigor Total">‚úèÔ∏è</span>
                            </div>
                            <div class="valor-atual medieval-box">
                                <span>Vigor Atual: </span>
                                <button id="btn-diminuir-vigor" title="Diminuir Vigor">‚ñº</button>
                                <input type="number" id="vigor-atual-input" class="recurso-atual-input" value="10" min="0" step="0.1">
                                <button id="btn-aumentar-vigor" title="Aumentar Vigor">‚ñ≤</button>
                            </div>
                            <div class="regeneracao">
                                <span>Regenera√ß√£o por turno: <span id="regeneracao-vigor">0</span> (parado)</span>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
            <section id="atributos">
                <h2>Atributos <span class="collapse-icon">‚ñº</span></h2>
                <div class="section-content">
                    <div class="atributos-container">
                        <div class="atributos-coluna">
                            <div class="atributo">
                                <label for="forca" title="For√ßa: Afeta dano f√≠sico corpo a corpo, capacidade de carga e resist√™ncia a dano f√≠sico (RDF). B√¥nus em alguns testes de atletismo.">For√ßa:</label>
                                <div class="input-com-botoes-wrapper">
                                    <button id="btn-diminuir-forca" class="attr-btn" title="Diminuir For√ßa">‚ñº</button>
                                    <input type="number" id="forca" value="0" min="0">
                                    <button id="btn-aumentar-forca" class="attr-btn" title="Aumentar For√ßa">‚ñ≤</button>
                                </div>
                                <span class="attribute-dice-icon" data-attribute-source="forca" title="Rolar com For√ßa">üé≤</span>
                                <span class="gm-edit-icon" data-target-id="forca" data-label="For√ßa">‚úèÔ∏è</span>
                            </div>
                            <div class="atributo">
                                <label for="destreza" title="Destreza: Afeta precis√£o de ataques (Acerto), chance de desviar de ataques (Esquiva com Agilidade) e dano com armas de destreza (ex: arcos, adagas).">Destreza:</label>
                                <div class="input-com-botoes-wrapper">
                                    <button id="btn-diminuir-destreza" class="attr-btn" title="Diminuir Destreza">‚ñº</button>
                                    <input type="number" id="destreza" value="0" min="0">
                                    <button id="btn-aumentar-destreza" class="attr-btn" title="Aumentar Destreza">‚ñ≤</button>
                                </div>
                                <span class="attribute-dice-icon" data-attribute-source="destreza" title="Rolar com Destreza">üé≤</span>
                                <span class="gm-edit-icon" data-target-id="destreza" data-label="Destreza">‚úèÔ∏è</span>
                            </div>
                            <div class="atributo">
                                <label for="agilidade" title="Agilidade: Afeta chance de desviar de ataques (Esquiva), iniciativa em combate e testes de acrobacia, furtividade.">Agilidade:</label>
                                <div class="input-com-botoes-wrapper">
                                    <button id="btn-diminuir-agilidade" class="attr-btn" title="Diminuir Agilidade">‚ñº</button>
                                    <input type="number" id="agilidade" value="0" min="0">
                                    <button id="btn-aumentar-agilidade" class="attr-btn" title="Aumentar Agilidade">‚ñ≤</button>
                                </div>
                                <span class="attribute-dice-icon" data-attribute-source="agilidade" title="Rolar com Agilidade">üé≤</span>
                                <span class="gm-edit-icon" data-target-id="agilidade" data-label="Agilidade">‚úèÔ∏è</span>
                            </div>
                            <div class="atributo">
                                <label for="constituicao" title="Constitui√ß√£o: Define seus Pontos de Vida (PV) base, Pontos de Magia (PM) base, Pontos de Vigor (PVg) base e regenera√ß√£o desses recursos.">Constitui√ß√£o:</label>
                                <div class="input-com-botoes-wrapper">
                                    <button id="btn-diminuir-constituicao" class="attr-btn" title="Diminuir Constitui√ß√£o">‚ñº</button>
                                    <input type="number" id="constituicao" value="0" min="0">
                                    <button id="btn-aumentar-constituicao" class="attr-btn" title="Aumentar Constitui√ß√£o">‚ñ≤</button>
                                </div>
                                <span class="attribute-dice-icon" data-attribute-source="constituicao" title="Rolar com Constitui√ß√£o">üé≤</span>
                                <span class="gm-edit-icon" data-target-id="constituicao" data-label="Constitui√ß√£o">‚úèÔ∏è</span>
                            </div>
                            <div class="atributo">
                                <label for="inteligencia" title="Intelig√™ncia: Afeta dano m√°gico, resist√™ncia a dano m√°gico (RDM), quantidade de per√≠cias conhecidas e testes de conhecimento.">Intelig√™ncia:</label>
                                <div class="input-com-botoes-wrapper">
                                    <button id="btn-diminuir-inteligencia" class="attr-btn" title="Diminuir Intelig√™ncia">‚ñº</button>
                                    <input type="number" id="inteligencia" value="0" min="0">
                                    <button id="btn-aumentar-inteligencia" class="attr-btn" title="Aumentar Intelig√™ncia">‚ñ≤</button>
                                </div>
                                <span class="attribute-dice-icon" data-attribute-source="inteligencia" title="Rolar com Intelig√™ncia">üé≤</span>
                                <span class="gm-edit-icon" data-target-id="inteligencia" data-label="Intelig√™ncia">‚úèÔ∏è</span>
                            </div>
                        </div>
                        <div class="atributos-coluna-destaque">
                            <div class="atributo-destaque">
                                <label title="For√ßa + (Destreza / 5) + B√¥nus de Armas. Dano f√≠sico.">Ataque:</label>
                                <span><span id="ataque">0</span><span class="attribute-dice-icon" data-attribute-source="ataque" title="Rolar com Ataque">üé≤</span></span>
                                <span class="gm-edit-icon" data-target-id="ataque" data-label="Ataque">‚úèÔ∏è</span>
                            </div>
                            <div class="atributo-destaque">
                                <label title="Intelig√™ncia + B√¥nus de Armas M√°gicas. Dano m√°gico.">Ataque M√°gico:</label>
                                <span><span id="ataque-magico">0</span><span class="attribute-dice-icon" data-attribute-source="ataque-magico" title="Rolar com Ataque M√°gico">üé≤</span></span>
                                <span class="gm-edit-icon" data-target-id="ataque-magico" data-label="Ataque M√°gico">‚úèÔ∏è</span>
                            </div>
                            <div class="atributo-destaque">
                                <label title="(Destreza / 3) + (Agilidade / 10). Chance de acertar ataques.">Acerto:</label>
                                <span><span id="acerto">0</span><span class="attribute-dice-icon" data-attribute-source="acerto" title="Rolar com Acerto">üé≤</span></span>
                                <span class="gm-edit-icon" data-target-id="acerto" data-label="Acerto">‚úèÔ∏è</span>
                            </div>
                            <div class="atributo-destaque">
                                <label title="(Agilidade / 3). Chance de evitar ataques.">Esquiva:</label>
                                <span><span id="esquiva">0</span><span class="attribute-dice-icon" data-attribute-source="esquiva" title="Rolar com Esquiva">üé≤</span></span>
                                <span class="gm-edit-icon" data-target-id="esquiva" data-label="Esquiva">‚úèÔ∏è</span>
                            </div>
                            <div class="atributo-destaque">
                                <label title="(For√ßa / 5). Redu√ß√£o de dano f√≠sico.">RDF:</label>
                                <span><span id="rdf">0</span><span class="attribute-dice-icon" data-attribute-source="rdf" title="Rolar com RDF">üé≤</span></span>
                                <span class="gm-edit-icon" data-target-id="rdf" data-label="RDF">‚úèÔ∏è</span>
                            </div>
                            <div class="atributo-destaque">
                                <label title="(Intelig√™ncia / 5). Redu√ß√£o de dano m√°gico.">RDM:</label>
                                <span><span id="rdm">0</span><span class="attribute-dice-icon" data-attribute-source="rdm" title="Rolar com RDM">üé≤</span></span>
                                <span class="gm-edit-icon" data-target-id="rdm" data-label="RDM">‚úèÔ∏è</span>
                            </div>
                        </div>
                    </div>
                    <div style="text-align: center; margin-top: 15px;">
                        <button id="salvar-atributos-btn" class="botao" style="display: none; background-color: #006400;">Salvar Atributos M√≠nimos</button>
                    </div>
                </div>
            </section>
            <section id="combate">
                <h2>Combate <span class="collapse-icon">‚ñº</span></h2>
                <div class="section-content">
                    <div class="armamento-container">
                        <div class="armamento-coluna">
                            <label>Armamento M√£o Direita:</label>
                            <div class="flex items-center mb-2">
                                <input type="text" id="arma-direita-nome" placeholder="Nome da Arma" class="mr-2">
                                <span>Ataque </span>
                                <input type="number" id="arma-direita-ataque" value="0" class="w-20 mr-2">
                                <span>Ataque M√°gico </span>
                                <input type="number" id="arma-direita-ataque-magico" value="0" class="w-20">
                            </div>
                        </div>
                        <div class="armamento-coluna">
                            <label>Armamento M√£o Esquerda:</label>
                            <div class="flex items-center">
                                <input type="text" id="arma-esquerda-nome" placeholder="Nome da Arma" class="mr-2">
                                <span>Ataque </span>
                                <input type="number" id="arma-esquerda-ataque" value="0" class="w-20 mr-2">
                                <span>Ataque M√°gico </span>
                                <input type="number" id="arma-esquerda-ataque-magico" value="0" class="w-20">
                            </div>
                        </div>
                    </div>
                </div>
            </section>
            <section id="inventario-habilidades">
                <h2>Invent√°rio e Habilidades <span class="collapse-icon">‚ñº</span></h2>
                <div class="section-content">
                    <div class="flex gap-20">
                        <div style="width:50%">
                            <label>Invent√°rio (Peso Total: <span id="peso-total">0</span> kg / <span id="capacidade-carga">5</span> kg <span class="gm-edit-icon" data-target-id="capacidade-carga" data-label="Capacidade Carga">‚úèÔ∏è</span>):</label>
                            <div id="inventario-slots">
                                <div class="inventory-slot"><input type="text" placeholder="Item 1" class="inventory-item"><input type="number" min="0" value="0" class="inventory-weight" title="Peso em kg"></div>
                                <div class="inventory-slot"><input type="text" placeholder="Item 2" class="inventory-item"><input type="number" min="0" value="0" class="inventory-weight"></div>
                                <div class="inventory-slot"><input type="text" placeholder="Item 3" class="inventory-item"><input type="number" min="0" value="0" class="inventory-weight"></div>
                                <div class="inventory-slot"><input type="text" placeholder="Item 4" class="inventory-item"><input type="number" min="0" value="0" class="inventory-weight"></div>
                                <div class="inventory-slot"><input type="text" placeholder="Item 5" class="inventory-item"><input type="number" min="0" value="0" class="inventory-weight"></div>
                                <div class="inventory-slot"><input type="text" placeholder="Item 6" class="inventory-item"><input type="number" min="0" value="0" class="inventory-weight"></div>
                                <div class="inventory-slot"><input type="text" placeholder="Item 7" class="inventory-item"><input type="number" min="0" value="0" class="inventory-weight"></div>
                                <div class="inventory-slot"><input type="text" placeholder="Item 8" class="inventory-item"><input type="number" min="0" value="0" class="inventory-weight"></div>
                                <div class="inventory-slot"><input type="text" placeholder="Item 9" class="inventory-item"><input type="number" min="0" value="0" class="inventory-weight"></div>
                                <div class="inventory-slot"><input type="text" placeholder="Item 10" class="inventory-item"><input type="number" min="0" value="0" class="inventory-weight"></div>
                            </div>
                        </div>
                        <div style="width:50%">
                            <label>Magias e Habilidades:</label>
                            <div id="magias-list" class="magias-container">
                                <!-- MAGIC ITEMS WILL BE DYNAMICALLY INSERTED HERE BY JAVASCRIPT -->
                            </div>
                            <button id="adicionar-magia-btn">Adicionar Magia</button>
                        </div>
                    </div>
                    <div class="mt-4">
                        <label>Vantagens:</label>
                        <div id="vantagens-list-display" class="list-display"></div>
                        <label>Desvantagens:</label>
                        <div id="desvantagens-list-display" class="list-display"></div>
                    </div>
                    <div class="classe-raca-container">
                        <label>Classe:</label>
                        <input type="text" id="classe-nome" placeholder="Nome da Classe">
                        <textarea id="classe-descricao" placeholder="Descri√ß√£o da Classe" class="expandable-textarea"></textarea>
                        <label>Ra√ßa:</label>
                        <span id="raca-nome" data-action="abrir-modal-raca"></span>
                        <textarea id="raca-descricao" placeholder="Descri√ß√£o da Ra√ßa" class="expandable-textarea" readonly></textarea>
                    </div>
                </div>
            </section>
            <section id="locomocao">
                <h2>Locomo√ß√£o <span class="collapse-icon">‚ñº</span></h2>
                <div class="section-content">
                    <div class="locomotion-container">
                        <div class="locomotion-item">
                            <label>Velocidade de Corrida (km/h):</label><span>üèÉ‚Äç‚ôÇÔ∏è</span>
                            <span id="velocidade-corrida">25</span>
                            <span class="attribute-dice-icon" data-attribute-source="velocidade-corrida" title="Rolar com Velocidade de Corrida">üé≤</span>
                            <span class="gm-edit-icon" data-target-id="velocidade-corrida" data-label="Velocidade Corrida">‚úèÔ∏è</span>
                        </div>
                        <div class="locomotion-item">
                            <label>Altura do Pulo (m):</label><span>‚¨ÜÔ∏è</span>
                            <span id="altura-pulo">1</span>
                            <span class="attribute-dice-icon" data-attribute-source="altura-pulo" title="Rolar com Altura do Pulo">üé≤</span>
                             <span class="gm-edit-icon" data-target-id="altura-pulo" data-label="Altura Pulo">‚úèÔ∏è</span>
                        </div>
                        <div class="locomotion-item">
                            <label>Dist√¢ncia do Pulo (m):</label><span>‚û°Ô∏è</span>
                            <span id="distancia-pulo">3</span>
                            <span class="attribute-dice-icon" data-attribute-source="distancia-pulo" title="Rolar com Dist√¢ncia do Pulo">üé≤</span>
                            <span class="gm-edit-icon" data-target-id="distancia-pulo" data-label="Dist√¢ncia Pulo">‚úèÔ∏è</span>
                        </div>
                    </div>
                </div>
            </section>
            <section id="status">
                <h2>Status <span class="collapse-icon">‚ñº</span></h2>
                <div class="section-content">
                    <div class="flex gap-20">
                        <div>
                            <div class="status-item">
                                <label for="experiencia">Experi√™ncia: <span id="xp-lock-icon" class="lock-icon" title="Apenas o Mestre pode alterar a experi√™ncia. Pe√ßa para ele digitar a senha.">üîí</span></label>
                                <div class="input-com-botoes-wrapper">
                                    <button id="btn-diminuir-xp" class="attr-btn" title="Diminuir Experi√™ncia">‚ñº</button>
                                    <input type="number" id="experiencia" value="0" min="0">
                                    <button id="btn-aumentar-xp" class="attr-btn" title="Aumentar Experi√™ncia">‚ñ≤</button>
                                </div>
                            </div>
                            <label>Pontos de Habilidade (PD):</label>
                            <span id="pontos-habilidade">25</span> <span class="gm-edit-icon" data-target-id="pontos-habilidade" data-label="Pontos Habilidade">‚úèÔ∏è</span>
                            <label>Pontos de Vantagem (PH):</label>
                            <span id="pontos-vantagem">8</span> <span class="gm-edit-icon" data-target-id="pontos-vantagem" data-label="Pontos Vantagem">‚úèÔ∏è</span>
                        </div>
                        <div></div>
                    </div>
                    <div id="nivel-container">
                        <label>N√≠vel:</label>
                        <span id="nivel">0</span> <span class="gm-edit-icon" data-target-id="nivel" data-label="N√≠vel">‚úèÔ∏è</span>
                    </div>
                </div>
            </section>

            <div style="display:flex;justify-content:center;gap:20px;margin-bottom:20px">
                <button id="vantagens-desvantagens-btn" class="botao">Vantagens e Desvantagens</button>
                <button id="racas-btn" class="botao">Ra√ßas üè∞</button>
                <button id="classes-btn" class="botao">Classes ‚öîÔ∏è</button>
            </div>

            <div class="botoes-container">
                <button id="reset-pontos" class="botao botao-reset">Reiniciar Pontos</button>
                <button id="recomecar" class="botao botao-recomecar">Recome√ßar</button>
                <button id="bloquear-ficha" class="botao botao-bloquear">Bloquear Ficha</button>
                <button id="customizacao-btn" class="botao">Customiza√ß√£o üé®</button>
                <button id="excluir-ficha" class="botao botao-excluir">Excluir Ficha</button>
                <button id="gm-mode-btn" class="botao">Modo Mestre GM üëë</button>
            </div>

            <div class="theme-buttons-container">
                <button id="lua-btn" class="botao icon-btn" title="Modo Noturno">üåô</button>
                <button id="sol-btn" class="botao icon-btn" title="Modo Claro">‚òÄÔ∏è</button>
            </div>
        </div>
    </div>
    <button id="anotacoes-btn">Anota√ß√µes</button>
    <textarea id="anotacoes-textarea" placeholder="Suas anota√ß√µes aqui..."></textarea>

    <div id="vantagens-desvantagens-panel">
        <h2>Vantagens e Desvantagens</h2>
        <div>Pontos de Vantagem Tempor√°rios: <span id="ph-temp">0</span></div>
        <div id="vantagens-list"></div>
        <div id="desvantagens-list"></div>
        <button id="salvar-vantagens-btn">SALVAR</button>
        <button id="fechar-pagina-btn">Fechar P√°gina</button>
    </div>
    <div id="racas-panel">
        <h2>Ra√ßas</h2>
        <div id="ph-temp-raca-container" style="text-align: center; margin-bottom: 10px;">Pontos de Vantagem Tempor√°rios: <span id="ph-temp-raca">0</span></div> <div id="racas-list"></div>
        <button id="salvar-racas-btn">SALVAR</button>
        <button id="fechar-racas-btn">Fechar P√°gina</button>
    </div>
    <div id="classes-panel">
        <h2>Classes</h2>
        <button id="fechar-classes-btn">Fechar P√°gina</button>
    </div>
    <div id="nome-ficha-modal" class="modal">
        <div class="modal-content">
            <h3>D√™ um Nome √† Ficha</h3>
            <input type="text" id="nome-ficha-input" placeholder="Nome da ficha" maxlength="20">
            <button class="confirm-btn" data-action="confirmar-nova-ficha">Confirmar</button>
            <button class="cancel-btn" data-action="fechar-modal">Cancelar</button>
        </div>
    </div>
    <div id="bloquear-ficha-modal" class="modal">
        <div class="modal-content">
            <h3>Crie uma Senha de 4 D√≠gitos</h3>
            <input type="password" id="senha-bloqueio-input" placeholder="Senha (4 d√≠gitos)" maxlength="4">
            <button class="confirm-btn" data-action="confirmar-bloqueio">Confirmar</button>
            <button class="cancel-btn" data-action="fechar-modal">Cancelar</button>
        </div>
    </div>
    <div id="password-modal" class="modal">
        <div class="modal-content">
            <h3>Digite sua Senha</h3>
            <input type="password" id="senha-desbloqueio-input" placeholder="Senha (4 d√≠gitos)" maxlength="4">
            <button class="confirm-btn" data-action="confirmar-desbloqueio">Confirmar</button>
            <button class="cancel-btn" data-action="cancelar-desbloqueio">Cancelar</button>
        </div>
    </div>
     <div id="confirm-modal" class="modal">
        <div class="modal-content">
            <h3 id="confirm-modal-title">Voc√™ tem certeza?</h3>
            <p id="confirm-modal-text" style="margin-bottom: 15px;"></p>
            <button class="confirm-btn" id="confirm-modal-yes-btn">Sim</button>
            <button class="cancel-btn" id="confirm-modal-no-btn">N√£o</button>
        </div>
    </div>
    <div id="salvar-vantagens-modal" class="modal"> 
        <div class="modal-content">
            <h3 id="salvar-modal-texto">Se salvar, as altera√ß√µes n√£o poder√£o ser desfeitas.</h3>
            <button class="confirm-btn" id="confirmar-salvar-btn">OK</button> 
            <button class="cancel-btn" data-action="fechar-modal">Cancelar</button>
        </div>
    </div>
    <div id="confirmar-salvar-atributos-modal" class="modal">
        <div class="modal-content">
            <h3 id="confirmar-salvar-atributos-texto">Ao clicar em salvar, as altera√ß√µes n√£o poder√£o ser desfeitas.</h3>
            <button class="confirm-btn" id="confirmar-salvar-atributos-ok-btn">OK</button>
            <button class="cancel-btn" data-action="fechar-modal">Cancelar</button>
        </div>
    </div>
    <div id="senha-gm-modal" class="modal">
        <div class="modal-content">
            <h3 id="senha-gm-titulo">Pe√ßa permiss√£o ao GM</h3>
            <input type="password" id="senha-gm-input" placeholder="Senha GM">
            <button class="confirm-btn" id="confirmar-senha-gm-btn">Confirmar</button>
            <button class="cancel-btn" data-action="fechar-modal">Cancelar</button>
        </div>
    </div>
    <div id="raca-opcoes-modal" class="modal">
        <div class="modal-content">
            <h3>O que voc√™ deseja fazer?</h3>
            <button class="confirm-btn" data-action="excluir-raca">Excluir Ra√ßa</button>
            <button class="confirm-btn" data-action="editar-raca" style="margin-top: 10px;">Editar Ra√ßa</button>
            <button class="cancel-btn" data-action="fechar-modal">Cancelar</button>
        </div>
    </div>
    <div id="editar-raca-modal" class="modal">
        <div class="modal-content">
            <h3>Editar Ra√ßa</h3>
            <label for="editar-raca-nome">Nome:</label>
            <input type="text" id="editar-raca-nome">
            <label for="editar-raca-descricao">Descri√ß√£o:</label>
            <textarea id="editar-raca-descricao"></textarea>
            <button class="confirm-btn" data-action="salvar-edicao-raca">Salvar</button>
            <button class="cancel-btn" data-action="fechar-modal">Cancelar</button>
        </div>
    </div>
    <div id="notification"></div>

    <!-- MODAL DE CUSTOMIZA√á√ÉO GERAL -->
    <div id="customizacao-modal" class="modal">
        <div class="modal-content">
            <h3>Painel de Customiza√ß√£o</h3>

             <fieldset>
                <legend>Modelo de Ficha</legend>
                <div class="input-group">
                    <label for="theme-selector">Tema da Ficha:</label>
                    <select id="theme-selector">
                        <option value="theme-medieval">Medieval (Padr√£o)</option>
                        <option value="theme-futurista">Futurista</option>
                        <option value="theme-elemental">Elemental</option>
                    </select>
                </div>
                <div class="input-group" id="elemental-theme-group" style="display: none;">
                    <label for="elemental-theme-selector">Elemento:</label>
                    <select id="elemental-theme-selector">
                        <option value="fogo">Fogo</option>
                        <option value="agua">√Ågua</option>
                        <option value="ar">Ar</option>
                        <option value="terra">Terra</option>
                    </select>
                </div>
                <button class="confirm-btn" data-action="preparar-aplicar-tema" style="width:100%;">Aplicar Modelo</button>
            </fieldset>

            <fieldset>
                <legend>Apar√™ncia da P√°gina e Ficha</legend>
                <div class="input-group">
                    <label for="background-color-input">Cor de Fundo (P√°gina):</label>
                    <input type="color" id="background-color-input" value="#f0e6d2">
                </div>
                <div class="input-group">
                    <label for="ficha-internal-background-color-input">Cor de Fundo Base (Interior da Ficha e Se√ß√µes):</label>
                    <input type="color" id="ficha-internal-background-color-input" value="#f0e6d2">
                </div>
                <div class="input-group">
                    <label for="font-selector">Fonte Principal da Ficha:</label>
                    <select id="font-selector" title="Fonte Principal" style="width: 100%; background-color: #f0e6d2; color:black; border:1px solid #b8860b; padding: 10px; border-radius: 6px; ">
                        <option value="'Inter', sans-serif">Padr√£o (Inter)</option>
                        <option value="'MedievalSharp', cursive">Medieval</option>
                         <option value="'Orbitron', sans-serif">Futurista (Orbitron)</option>
                        <option value="'Times New Roman', Times, serif">Times New Roman</option>
                        <option value="'Arial', Helvetica, sans-serif">Arial</option>
                        <option value="'Courier New', Courier, monospace">Courier New</option>
                        <option value="'Georgia', serif">Georgia</option>
                        <option value="'Verdana', Geneva, sans-serif">Verdana</option>
                    </select>
                </div>
            </fieldset>

            <fieldset>
                <legend>Transpar√™ncia da Ficha</legend>
                <div class="input-group">
                    <label for="ficha-transparency-slider">N√≠vel de Opacidade (0% = Totalmente Transparente, 100% = Totalmente Opaco): <span id="ficha-transparency-value">100</span>%</label>
                    <input type="range" id="ficha-transparency-slider" min="0" max="100" value="100">
                </div>
                <button class="cancel-btn" data-action="restaurar-opacidade" style="width:100%;">Restaurar Opacidade Padr√£o (100%)</button>
            </fieldset>

            <fieldset>
                <legend>Sombra (Interna)</legend>
                <div class="input-group">
                    <label for="shadow-color-ficha">Cor da Sombra (Ficha/Se√ß√µes - Interno):</label>
                    <input type="color" id="shadow-color-ficha" value="#000000">
                </div>
                <div class="input-group">
                    <label for="shadow-intensity-ficha-slider">Intensidade da Sombra (Ficha/Se√ß√µes - Interno): <span id="shadow-intensity-ficha-value">0</span>%</label>
                    <input type="range" id="shadow-intensity-ficha-slider" min="0" max="100" value="0">
                </div>
                <button class="cancel-btn" data-action="restaurar-sombra" style="width:100%; margin-top: 10px;">Restaurar Sombra Padr√£o</button>
            </fieldset>

            <fieldset>
                <legend>Plano de Fundo da Ficha (Imagem de fundo apenas da P√°gina)</legend>
                <div class="input-group">
                    <label for="background-image-input">Selecionar Imagem:</label>
                    <input type="file" id="background-image-input" accept="image/*">
                </div>
                <div class="radio-group input-group">
                    <label><input type="radio" name="background-size" value="cover" checked> Preencher Tela (Fixo)</label>
                    <label><input type="radio" name="background-size" value="100% 100%"> Estender (Rol√°vel)</label>
                    <label><input type="radio" name="background-size" value="auto"> Tamanho Normal (Rol√°vel)</label>
                </div>
                <button class="confirm-btn" data-action="aplicar-bg">Aplicar Imagem de Fundo da P√°gina</button>
                <button class="cancel-btn" data-action="excluir-bg">Excluir Imagem de Fundo da P√°gina</button>
            </fieldset>

            <fieldset>
                <legend>Estilos das Se√ß√µes da Ficha</legend>
                <div class="input-group">
                    <label for="cor-borda-secao-input">Cor da Borda das Se√ß√µes:</label>
                    <input type="color" id="cor-borda-secao-input" value="#b8860b">
                </div>
                <div class="input-group">
                    <label for="estilo-borda-secao-select">Estilo da Borda das Se√ß√µes:</label>
                    <select id="estilo-borda-secao-select">
                        <option value="solid">S√≥lida</option>
                        <option value="dashed">Tracejada</option>
                        <option value="dotted">Pontilhada</option>
                        <option value="double">Dupla</option>
                        <option value="groove">Groove</option>
                        <option value="ridge">Ridge</option>
                    </select>
                </div>
                 <div class="input-group">
                    <label for="largura-borda-secao-input">Largura da Borda (px):</label>
                    <input type="number" id="largura-borda-secao-input" min="0" max="10" value="2">
                </div>
                <button class="confirm-btn" data-action="aplicar-estilos-secao">Aplicar Estilos de Se√ß√£o</button>
            </fieldset>

            <fieldset>
                <legend>Customiza√ß√£o do Dado</legend>
                <div class="input-group">
                    <label for="dice-color-input">Cor de Fundo do Dado:</label>
                    <input type="color" id="dice-color-input" value="#f0e6d2">
                </div>
                 <div class="input-group">
                    <label for="dice-number-color-input">Cor do N√∫mero no Dado:</label>
                    <input type="color" id="dice-number-color-input" value="#000000">
                </div>
                <div class="input-group custom-dice-texture-controls">
                    <div style="flex-grow: 1;">
                        <label for="dice-texture-input">Textura do Dado (Imagem 100x100px):</label>
                        <input type="file" id="dice-texture-input" accept="image/*">
                    </div>
                    <button id="remove-dice-texture-btn" class="botao icon-btn" title="Remover Textura do Dado" style="background-color:#cc0000; padding: 10px;">üóëÔ∏è</button>
                </div>
                <div class="input-group">
                     <label for="dice-animation-selector">Anima√ß√£o do Dado ao Rolar:</label>
                     <select id="dice-animation-selector" title="Anima√ß√£o do Dado" style="width: 100%; background-color: #f0e6d2; color:black; border:1px solid #b8860b; padding: 10px; border-radius: 6px;">
                        <option value="padrao">Anima√ß√£o Padr√£o</option>
                        <option value="rapido">Giro R√°pido</option>
                        <option value="salto">Salto e Queda</option>
                    </select>
                </div>
            </fieldset>

            <fieldset>
                <legend>Reiniciar Apar√™ncia</legend>
                <div class="input-group">
                   <p style="font-size: 0.9em; margin-bottom: 10px;">Isto ir√° restaurar todas as configura√ß√µes de apar√™ncia (temas, cores, fontes, fundos, etc.) para o padr√£o medieval claro, sem afetar seus pontos e dados de personagem.</p>
                   <button id="reset-estetica-btn" class="botao botao-reset" style="width:100%;">Reiniciar Est√©tica para Padr√£o</button>
                </div>
            </fieldset>

            <button class="cancel-btn" data-action="fechar-modal" style="margin-top: 20px; width: 100%;">Fechar Customiza√ß√£o</button>
        </div>
    </div>

    <!-- NEW THEME CONFIRMATION MODAL -->
    <div id="confirmar-tema-modal" class="modal">
        <div class="modal-content">
            <h3>Quer manter a altera√ß√£o?</h3>
            <p>A ficha voltar√° ao modelo anterior se clicar em "N√£o".</p>
            <button class="confirm-btn" id="confirmar-tema-sim-btn">Sim</button>
            <button class="cancel-btn" id="confirmar-tema-nao-btn">N√£o</button>
        </div>
    </div>


    <div id="fireworks-container"></div>
    <div id="dice-history-trigger">Hist√≥rico de Dados</div>
    <div id="dice-history-panel">
        <h2>Hist√≥rico de Rolagens</h2>
        <div id="dice-history-list">
        </div>
        <div class="dice-history-buttons">
            <button id="limpar-historico-btn" class="botao">Limpar Hist√≥rico</button>
            <button id="fechar-historico-btn" class="botao">Fechar Caixa</button>
        </div>
    </div>
    <div id="custom-tooltip"></div>

    <script>
    // IIFE to encapsulate code and avoid polluting global scope
    (function() {
        'use strict';

        // =================================================================================
        // 1. CONSTANTS & STATE VARIABLES
        // =================================================================================
        const RGP_FICHAS_KEY = 'rpgFichas';
        const RPG_CURRENT_FICHA_ID_KEY = 'rpgCurrentFichaId';
        const FICHA_MATRIZ_ID = "ficha-matriz";
        const SENHA_MESTRE = "1040";
        const REPEAT_DELAY_MS = 75;
        const XP_UNLOCK_DURATION_MS = 20000;

        // --- State Variables ---
        let fichas = {};
        let currentFichaId = null;
        let isFichaLocked = false;
        let fichaPassword = null;
        let isFichaUnlockedTemporarily = false;
        let isGmModeActive = false;
        
        let vantagensSelecionadas = [];
        let desvantagensSelecionadas = [];
        let tempVantagensSelecionadas = [];
        let tempDesvantagensSelecionadas = [];
        let racaSelecionada = null;
        let tempRacaSelecionada = null;
        
        let vidaTotal, vidaAtual, magiaTotal, magiaAtual, vigorTotal, vigorAtual;
        let nivel = 0, nivelAnterior = 0, pontosHabilidadeTotal = 25, pontosHabilidadeUsados = 0;
        
        const previousValues = new Map();
        let currentActionIntervalId = null;
        let xpUnlockTimerId = null;
        let isDiceRolling = false;
        let currentDiceMax = 20;
        let selectedAttributeIcon = null;
        let previousTheme = '';
        let tooltipTimeoutId = null;

        // =================================================================================
        // 2. DATA MODELS (Vantagens, Desvantagens, Ra√ßas, N√≠veis)
        // =================================================================================
        const vantagensData = [
            { nome: "Maestria com Armas curtas (2)", custo: 2, descricao: "+1 em ataque, +1 em acerto com armas curtas." }, { nome: "Maestria com armas pesadas (2)", custo: 2, descricao: "+2 em ataque com armas pesadas." }, { nome: "Maestria com armas de longo alcance (2)", custo: 2, descricao: "+2 em acerto com armas de longo alcance." }, { nome: "Furtar (2)", custo: 2, descricao: "+4 em testes de furto." }, { nome: "L√°bia (2)", custo: 2, descricao: "+5 em testes de l√°bia." }, { nome: "Velejar (1)", custo: 1, descricao: "" }, { nome: "Beleza (1)", custo: 1, descricao: "+3 o teste em l√°bia, paquera e persuas√£o." }, { nome: "Boa Fama (2)", custo: 2, descricao: "+4 chance de descontos em armamentos, pousadas, alimentos, etc." }, { nome: "Arremedo (2)", custo: 2, descricao: "Capacidade de imitar qualquer som SIMPLES." }, { nome: "Destemor (1)", custo: 1, descricao: "Dificilmente √© assustado por algo." }, { nome: "Empatia (3)", custo: 3, descricao: "Sensibilidade extraordin√°ria em rela√ß√£o aos outras pessoas. Excelente para identificar impostores, possess√µes por espirito, etc." }, { nome: "Empatia com animais (1)", custo: 1, descricao: "Pode compreender as motiva√ß√µes dos animais." }, { nome: "Patrono (4)", custo: 4, descricao: "Possui um mentor/mestre/professor, at√© mesmo uma organiza√ß√£o/guilda que pode lhe oferecer ajuda." }, { nome: "Reconhecimento Social (2)", custo: 2, descricao: "Membro de um grupo respeitado/temido/venerado. +2 teste em l√°bia, paquera e persuas√£o." }, { nome: "Riqueza (2)", custo: 2, descricao: "Inicia com 20 moedas de ouro." }, { nome: "Aptid√£o para magia (4)", custo: 4, descricao: "+15% dano e -15% custo de magia para a magia que tem aptid√£o." }, { nome: "Combo F√≠sico (4)", custo: 4, descricao: "Inicia com 50km velocidade corrida, pulo de 3m altura e 9m dist√¢ncia.", restricao: "inicio" }, { nome: "Nadar (1)", custo: 1, descricao: "" }, { nome: "Escalar (2)", custo: 2, descricao: "" }, { nome: "Segunda l√≠ngua (1)", custo: 1, descricao: "Fala mais um idioma." }, { nome: "Paquerador (2)", custo: 2, descricao: "+4 em teste para paquera e persuas√£o envolvendo flerte." }, { nome: "Senso de perigo (5)", custo: 5, descricao: "Quando algo grave ocorrer o mestre pedir√° pra voc√™ jogar um dado para reagir." }, { nome: "Acrobata (3)", custo: 3, descricao: "+ fama ao lutar em p√∫blico." }, { nome: "Equil√≠brio Perfeito (3)", custo: 3, descricao: "+8 em testes de equil√≠brio." }, { nome: "Tecnologia (2)", custo: 2, descricao: "Engenhoso, pode inventar coisas, criar objetos improvisados." }, { nome: "Poder Oculto (7)", custo: 7, descricao: "Com 10% vida, ativa +50% em todos atributos. Volta ao normal acima de 10% vida." }, { nome: "Sobreviv√™ncia em floresta (2)", custo: 2, descricao: "Facilidade para achar cavernas, criar assentamentos, achar comida, gravar caminhos, achar √°gua, etc." }
        ];
        const desvantagensData = [
            { nome: "Fobia (+2)", ganho: 2, descricao: "Medo irracional de algo espec√≠fico." }, { nome: "M√° Fama (+2)", ganho: 2, descricao: "Mal visto pela sociedade, dificultando intera√ß√µes sociais." }, { nome: "Alcoolismo (+2)", ganho: 2, descricao: "Depend√™ncia de √°lcool que afeta suas decis√µes." }, { nome: "Altru√≠smo (+2)", ganho: 2, descricao: "Se sacrifica por outras pessoas, poco se importa com fama ou riqueza." }, { nome: "Avareza (+2)", ganho: 2, descricao: "Preocupa√ß√£o permanente na conserva√ß√£o de riquezas." }, { nome: "Bullying (+3)", ganho: 3, descricao: "Gosta de ca√ßoar, agredir, denegrir, difamar e apontar defeitos." }, { nome: "Circunspe√ß√£o (+2)", ganho: 2, descricao: "N√£o entende piadas, entende tudo literal e acredita que todos est√£o s√©rios." }, { nome: "Compuls√µes (+3)", ganho: 3, descricao: "H√°bito ou v√≠cio que toma boa parte dos seus recursos e tempo." }, { nome: "Covardia (+2)", ganho: 2, descricao: "Extremo cuidado com bem-estar f√≠sico e dificuldade em assumir riscos." }, { nome: "Dependentes (+4)", ganho: 4, descricao: "Algu√©m depende de voc√™ a todo momento (filhos, parentes, etc.)." }, { nome: "F√∫ria (+2)", ganho: 2, descricao: "Tend√™ncia a perder o controle e atacar freneticamente (ativado por dano, insulto ou aleat√≥rio)." }, { nome: "Honestidade (+3)", ganho: 3, descricao: "N√£o consegue mentir ou omitir, sempre fala a verdade e desmascara mentiras." }, { nome: "Impulsividade (+2)", ganho: 2, descricao: "Sempre age sem pensar." }, { nome: "Lux√∫ria (+2)", ganho: 2, descricao: "Desejo incontrol√°vel por romance." }, { nome: "Magnetismo Sobrenatural (+2)", ganho: 2, descricao: "Coisas estranhas acontecem com seu personagem em n√≠vel alarmante." }, { nome: "No Limite (+4)", ganho: 4, descricao: "Assume riscos extremamente irracionais diante de perigo mortal." }, { nome: "Teimosia (+1)", ganho: 1, descricao: "Quer sempre fazer as coisas do seu modo, n√£o segue planos que n√£o sejam seus." }, { nome: "Amn√©sia (+2)", ganho: 2, descricao: "Em certos momentos, n√£o consegue lembrar de coisas importantes." }
        ];
        const racasData = [
            { nome: "Humano (3)", custo: 3, descricao: "Vers√°teis, ambiciosos, mestres em adapta√ß√£o.", vantagens: ["Explorador Nato: Cavalo superior, equipamentos, mapa detalhado.", "Mestre das Profiss√µes: Escolha (Ferreiro Lend√°rio, Costureiro Arcano, Arquiteto Vision√°rio) com benef√≠cios √∫nicos.", "Rede de Influ√™ncia: Aliado influente (guildas, mercadores, l√≠deres) com acesso a informa√ß√µes ou ajuda.", "Determina√ß√£o Inabal√°vel: Uma vez/dia, ignore uma desvantagem (exaust√£o, ferimento, magia) por um curto per√≠odo."] }, { nome: "Elfo (4)", custo: 4, descricao: "S√°bios, m√°gicos, conectados √† natureza.", vantagens: ["Sabedoria Ancestral: Domina √°rea (arcana, hist√≥ria, natureza), decifra itens antigos, aprende 1 l√≠ngua extra.", "Vis√£o √âlfica Suprema: Enxerga 10m escuro, detecta magias fracas 20m, percebe inten√ß√µes hostis (teste 19+).", "Escudo M√°gico: Resist√™ncia inata a um tipo de efeito m√°gico hostil (dano ou dura√ß√£o -50%)."] }, { nome: "An√£o (4)", custo: 4, descricao: "Resilientes, habilidosos, ligados √† terra.", vantagens: ["Fortitude Indom√°vel: Trabalha 3 dias sem descanso, recupera vida/energia 2x mais r√°pido em rocha/subterr√¢neo.", "Artes√£o: Escolha (Mestre Minerador, Forjador de Lendas, Joalheiro Divino) com impacto massivo.", "Senhor das Profundezas: Nunca se perde subterr√¢neo, detecta armadilhas, sente vibra√ß√µes (prever emboscada/colapso)."] }, { nome: "Orc (3)", custo: 3, descricao: "Guerreiros ferozes, l√≠deres pela for√ßa.", vantagens: ["Lenda entre Guerreiros: Inspira temor/respeito, alian√ßas marciais, acesso miss√µes √©picas; inimigos menores fogem (teste 16+).", "Resili√™ncia Brutal: Luta sem penalidades com ferimentos graves, s√≥ cai com PV 0, regenera ferimentos leves fora de combate.", "Dom√≠nio da Intimida√ß√£o: For√ßa inimigos a render/recuar com grito (1x/encontro, afeta grupos), b√¥nus massivo negocia√ß√µes (for√ßa/medo).", "F√∫ria Ancestral: F√∫ria 2x/dia (dobra for√ßa/resist√™ncia por curto per√≠odo)."] }, { nome: "Meio Animal (Selvagem) (4)", custo: 4, descricao: "Instinto primal com ast√∫cia.", vantagens: ["Sentidos Predat√≥rios: Escolha (vis√£o, olfato, audi√ß√£o) agu√ßado; rastreia km, detecta invis√≠veis, evita surpresa (teste 12+).", "Senhor dos Terrenos: Adapta-se a 1 ambiente (floresta, deserto, p√¢ntano), ignora efeitos negativos, b√¥nus movimento/furtividade (+1).", "Frenesi Instintivo: 1x/dia, velocidade sobrenatural (2x movimento), ataques adicionais, percep√ß√£o pr√©-monit√≥ria (10 min)."] }
        ];
        const nivelData = [
            { nivel: 0, xp: 0, pd: 25, ph: 8 }, { nivel: 1, xp: 10, pd: 31, ph: 9 }, { nivel: 2, xp: 30, pd: 37, ph: 10 }, { nivel: 3, xp: 60, pd: 43, ph: 11 }, { nivel: 4, xp: 100, pd: 49, ph: 12 }, { nivel: 5, xp: 150, pd: 55, ph: 13 }, { nivel: 6, xp: 210, pd: 61, ph: 14 }, { nivel: 7, xp: 280, pd: 67, ph: 15 }, { nivel: 8, xp: 360, pd: 73, ph: 16 }, { nivel: 9, xp: 450, pd: 79, ph: 17 }, { nivel: 10, xp: 550, pd: 85, ph: 18 }, { nivel: 11, xp: 670, pd: 91, ph: 19 }, { nivel: 12, xp: 810, pd: 97, ph: 20 }, { nivel: 13, xp: 970, pd: 103, ph: 21 }, { nivel: 14, xp: 1150, pd: 109, ph: 22 }, { nivel: 15, xp: 1350, pd: 115, ph: 23 }, { nivel: 16, xp: 1570, pd: 121, ph: 24 }, { nivel: 17, xp: 1810, pd: 127, ph: 25 }, { nivel: 18, xp: 2070, pd: 133, ph: 26 }, { nivel: 19, xp: 2350, pd: 139, ph: 27 }, { nivel: 20, xp: 2650, pd: 145, ph: 28 }, { nivel: 21, xp: 2980, pd: 148, ph: 29 }, { nivel: 22, xp: 3340, pd: 151, ph: 30 }, { nivel: 23, xp: 3730, pd: 154, ph: 31 }, { nivel: 24, xp: 4150, pd: 157, ph: 32 }, { nivel: 25, xp: 4600, pd: 160, ph: 33 }, { nivel: 26, xp: 5080, pd: 163, ph: 34 }, { nivel: 27, xp: 5590, pd: 166, ph: 35 }, { nivel: 28, xp: 6130, pd: 169, ph: 36 }, { nivel: 29, xp: 8000, pd: 219, ph: 37 }, { nivel: 30, xp: 10000, pd: 319, ph: 38 }
        ];

        // =================================================================================
        // 3. DOM ELEMENT CACHING
        // =================================================================================
        const DOMElements = {};
        function cacheDOMElements() {
            const ids = [
                "nome-personagem", "descricao-personagem", "forca", "destreza", "agilidade",
                "inteligencia", "constituicao", "ataque", "ataque-magico", "acerto", "esquiva", "rdf", "rdm",
                "arma-direita-nome", "arma-direita-ataque", "arma-direita-ataque-magico", "arma-esquerda-nome",
                "arma-esquerda-ataque", "arma-esquerda-ataque-magico", "reset-pontos", "recomecar", "bloquear-ficha",
                "experiencia", "xp-lock-icon", "nivel", "pontos-habilidade", "pontos-vantagem", "velocidade-corrida",
                "altura-pulo", "distancia-pulo", "nome-personagem-titulo", "game-master-message",
                "vantagens-list-display", "desvantagens-list-display", "inventario-slots", "peso-total",
                "capacidade-carga", "dice-container", "dice-roll", "dice-result", "change-dice-type-btn",
                "dice-options-menu", "notification", "character-image-input", "character-image",
                "vantagens-desvantagens-btn", "vantagens-desvantagens-panel", "vantagens-list", "desvantagens-list",
                "salvar-vantagens-btn", "fechar-pagina-btn", "ficha-container", "magias-list", "adicionar-magia-btn",
                "anotacoes-btn", "anotacoes-textarea", "racas-btn", "classes-btn", "racas-panel", "classes-panel",
                "fechar-racas-btn", "fechar-classes-btn", "classe-nome", "classe-descricao", "raca-nome",
                "raca-descricao", "lua-btn", "sol-btn", "salvar-racas-btn", "racas-list", "salvar-atributos-btn",
                "customizacao-btn", "customizacao-modal", "background-image-input", "cor-borda-secao-input",
                "estilo-borda-secao-select", "largura-borda-secao-input", "dice-texture-input",
                "remove-dice-texture-btn", "dice-animation-selector", "background-color-input",
                "ficha-internal-background-color-input", "font-selector", "dice-color-input", "dice-number-color-input",
                "ficha-transparency-slider", "ficha-transparency-value", "shadow-color-ficha",
                "shadow-intensity-ficha-slider", "shadow-intensity-ficha-value", "confirmar-salvar-btn",
                "ph-temp-raca", "senha-gm-titulo", "dice-history-trigger", "dice-history-panel", "dice-history-list",
                "fechar-historico-btn", "limpar-historico-btn", "custom-tooltip", "gm-mode-btn", "vida-atual-input",
                "magia-atual-input", "vigor-atual-input", "confirmar-salvar-atributos-modal",
                "confirmar-salvar-atributos-ok-btn", "theme-selector", "elemental-theme-group",
                "elemental-theme-selector", "confirmar-tema-modal", "confirmar-tema-sim-btn",
                "confirmar-tema-nao-btn", "fireworks-container", "add-ficha-btn", 'character-image-container',
                'btn-diminuir-vida', 'btn-aumentar-vida', 'btn-diminuir-magia', 'btn-aumentar-magia',
                'btn-diminuir-vigor', 'btn-aumentar-vigor', 'btn-diminuir-forca', 'btn-aumentar-forca',
                'btn-diminuir-destreza', 'btn-aumentar-destreza', 'btn-diminuir-agilidade', 'btn-aumentar-agilidade',
                'btn-diminuir-constituicao', 'btn-aumentar-constituicao', 'btn-diminuir-inteligencia',
                'btn-aumentar-inteligencia', 'btn-diminuir-xp', 'btn-aumentar-xp', 'excluir-ficha',
                'reset-estetica-btn', 'nome-ficha-modal', 'nome-ficha-input', 'bloquear-ficha-modal',
                'senha-bloqueio-input', 'password-modal', 'senha-desbloqueio-input', 'confirm-modal',
                'confirm-modal-title', 'confirm-modal-text', 'confirm-modal-yes-btn', 'confirm-modal-no-btn',
                'salvar-vantagens-modal', 'salvar-modal-texto', 'senha-gm-modal', 'senha-gm-input',
                'confirmar-senha-gm-btn', 'raca-opcoes-modal', 'editar-raca-modal', 'editar-raca-nome',
                'editar-raca-descricao'
            ];
            ids.forEach(id => DOMElements[id] = document.getElementById(id));
            DOMElements.atributosInputs = [DOMElements.forca, DOMElements.destreza, DOMElements.agilidade, DOMElements.inteligencia, DOMElements.constituicao];
        }
        
        // =================================================================================
        // 4. DATA PERSISTENCE (LocalStorage)
        // =================================================================================

        function getFichasFromStorage() {
            try {
                const fichasJSON = localStorage.getItem(RGP_FICHAS_KEY);
                return fichasJSON ? JSON.parse(fichasJSON) : {};
            } catch (e) {
                console.error("Erro ao ler fichas do localStorage:", e);
                return {};
            }
        }

        function saveFichasToStorage(fichasObj) {
            try {
                localStorage.setItem(RGP_FICHAS_KEY, JSON.stringify(fichasObj));
            } catch (e) {
                console.error("Erro ao salvar fichas no localStorage:", e);
                showNotification("Erro ao salvar! O armazenamento pode estar cheio.", "critical-failure", 5000);
            }
        }

        function getCurrentFichaIdFromStorage() {
            return localStorage.getItem(RPG_CURRENT_FICHA_ID_KEY);
        }

        function saveCurrentFichaIdToStorage(fichaId) {
            localStorage.setItem(RPG_CURRENT_FICHA_ID_KEY, fichaId);
        }

        // =================================================================================
        // 5. CORE LOGIC (Calculations, Saving, Loading)
        // =================================================================================

        /**
         * Gera um ID √∫nico para novas fichas.
         */
        function generateLocalId() {
            return `local_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
        }
        
        /**
         * Cria a ficha Matriz se ela n√£o existir.
         */
        function criarFichaMatriz() {
            fichas = getFichasFromStorage();
            if (!fichas[FICHA_MATRIZ_ID]) {
                const fichaMatriz = {
                    nomeFicha: "Matriz", nomePersonagem: "Personagem Matriz", descricaoPersonagem: "Ficha original do sistema",
                    forca: "0", destreza: "0", agilidade: "0", inteligencia: "0", constituicao: "0", experiencia: "0",
                    armaDireitaNome: "", armaDireitaAtaque: "0", armaDireitaAtaqueMagico: "0",
                    armaEsquerdaNome: "", armaEsquerdaAtaque: "0", armaEsquerdaAtaqueMagico: "0",
                    vantagens: "", 
                    magiasHabilidades: Array(5).fill({ nome: '', custo: '', custoVigor: '', dano: '', tipo: '' }),
                    desvantagens: "",
                    inventario: Array(10).fill({ item: "", peso: "0" }),
                    isLocked: true, password: SENHA_MESTRE, imagem: null, anotacoes: "",
                    classeNome: "", classeDescricao: "", racaNome: "", racaDescricao: "", racaSelecionada: "",
                    vidaAtual: 50, magiaAtual: 20, vigorAtual: 10,
                    diceRolls: [], collapsedSections: {}, gmOverrides: {},
                    lockedAtributos: { forca: 0, destreza: 0, agilidade: 0, constituicao: 0, inteligencia: 0 },
                    // Default Customization
                    theme: 'theme-medieval', darkMode: false, fontFamily: "'Inter', sans-serif",
                    backgroundColor: null, fichaInternalBackgroundColor: null, backgroundImage: null, 
                    backgroundSize: 'cover', backgroundAttachment: 'scroll', fichaTransparencyLevel: 100,
                    corBordaSecao: '#b8860b', estiloBordaSecao: 'solid', larguraBordaSecao: '2px',
                    shadowColorFicha: '#000000', shadowIntensityFicha: 0,
                    diceColor: null, diceNumberColor: null, texturaDado: null, animacaoDado: 'padrao'
                };
                fichas[FICHA_MATRIZ_ID] = fichaMatriz;
                saveFichasToStorage(fichas);
            }
        }

        /**
         * Carrega as fichas do localStorage e exibe a ficha ativa.
         */
        function carregarFichas() {
            criarFichaMatriz();
            fichas = getFichasFromStorage();
            const storedCurrentFichaId = getCurrentFichaIdFromStorage();

            if (storedCurrentFichaId && fichas[storedCurrentFichaId]) {
                currentFichaId = storedCurrentFichaId;
            } else {
                currentFichaId = FICHA_MATRIZ_ID;
                saveCurrentFichaIdToStorage(currentFichaId);
            }
            carregarFicha(currentFichaId);
            atualizarAbasFichas();
        }

        /**
         * Cria uma nova ficha de personagem.
         */
        function criarNovaFicha() {
            const nomeFicha = DOMElements.nomeFichaInput.value.trim();
            if (!nomeFicha) {
                showNotification("Por favor, d√™ um nome √† ficha!", "normal-result");
                return;
            }
            const novaFichaId = generateLocalId();
            // Herda as configura√ß√µes padr√£o da Matriz
            const novaFicha = JSON.parse(JSON.stringify(fichas[FICHA_MATRIZ_ID]));
            
            // Sobrescreve com dados iniciais para uma nova ficha
            novaFicha.nomeFicha = nomeFicha;
            novaFicha.nomePersonagem = "";
            novaFicha.descricaoPersonagem = "";
            novaFicha.isLocked = false;
            novaFicha.password = null;
            novaFicha.darkMode = document.body.classList.contains('dark-mode');

            fichas[novaFichaId] = novaFicha;
            saveFichasToStorage(fichas);
            
            currentFichaId = novaFichaId;
            saveCurrentFichaIdToStorage(currentFichaId);
            
            carregarFicha(novaFichaId);
            fecharModal('nome-ficha-modal');
            atualizarAbasFichas();
        }
        
        /**
         * Carrega os dados de uma ficha espec√≠fica na interface.
         * @param {string} fichaId - O ID da ficha a ser carregada.
         */
        function carregarFicha(fichaId) {
            if (!fichas[fichaId]) {
                console.error("Ficha n√£o encontrada:", fichaId, "Carregando Matriz como fallback.");
                currentFichaId = FICHA_MATRIZ_ID;
                saveCurrentFichaIdToStorage(currentFichaId);
                if (!fichas[currentFichaId]) criarFichaMatriz();
                fichaId = currentFichaId;
            }
            const ficha = fichas[fichaId];
            if (!ficha) {
                alert("Erro cr√≠tico: N√£o foi poss√≠vel carregar a ficha " + fichaId);
                return;
            }

            // --- Robustez: Garante que todas as propriedades existam no objeto da ficha ---
            const defaultFicha = fichas[FICHA_MATRIZ_ID] || {};
            for (const key in defaultFicha) {
                if (ficha[key] === undefined) {
                    ficha[key] = defaultFicha[key];
                }
            }
            // Garante que o objeto de magias seja um array
            if (!Array.isArray(ficha.magiasHabilidades)) {
                ficha.magiasHabilidades = Array(5).fill({ nome: '', custo: '', custoVigor: '', dano: '', tipo: '' });
            }

            // --- Carregamento dos dados na UI ---
            if (ficha.darkMode) {
                 document.body.classList.add('dark-mode');
            } else {
                 document.body.classList.remove('dark-mode');
            }

            DOMElements.nomePersonagem.value = ficha.nomePersonagem || "";
            DOMElements.descricaoPersonagem.value = ficha.descricaoPersonagem || "";
            DOMElements.forca.value = ficha.forca || "0";
            DOMElements.destreza.value = ficha.destreza || "0";
            DOMElements.agilidade.value = ficha.agilidade || "0";
            DOMElements.inteligencia.value = ficha.inteligencia || "0";
            DOMElements.constituicao.value = ficha.constituicao || "0";
            DOMElements.experiencia.value = ficha.experiencia || "0";
            DOMElements.armaDireitaNome.value = ficha.armaDireitaNome || "";
            DOMElements.armaDireitaAtaque.value = ficha.armaDireitaAtaque || "0";
            DOMElements.armaDireitaAtaqueMagico.value = ficha.armaDireitaAtaqueMagico || "0";
            DOMElements.armaEsquerdaNome.value = ficha.armaEsquerdaNome || "";
            DOMElements.armaEsquerdaAtaque.value = ficha.armaEsquerdaAtaque || "0";
            DOMElements.armaEsquerdaAtaqueMagico.value = ficha.armaEsquerdaAtaqueMagico || "0";
            DOMElements.anotacoesTextarea.value = ficha.anotacoes || "";
            DOMElements.classeNome.value = ficha.classeNome || "";
            DOMElements.classeDescricao.value = ficha.classeDescricao || "";
            
            isFichaLocked = ficha.isLocked || false;
            fichaPassword = ficha.password || null;
            isFichaUnlockedTemporarily = false;

            vantagensSelecionadas = ficha.vantagens ? ficha.vantagens.split("\n").filter(v => v.trim()) : [];
            desvantagensSelecionadas = ficha.desvantagens ? ficha.desvantagens.split("\n").filter(d => d.trim()) : [];
            racaSelecionada = ficha.racaSelecionada || null;
            
            atualizarDisplayVantagensDesvantagens();
            atualizarDisplayRaca();

            const inventario = Array.isArray(ficha.inventario) ? ficha.inventario : Array(10).fill({ item: "", peso: "0" });
            const slots = DOMElements.inventarioSlots.querySelectorAll(".inventory-slot");
            slots.forEach((slot, i) => { 
                slot.querySelector(".inventory-item").value = inventario[i]?.item || ""; 
                slot.querySelector(".inventory-weight").value = inventario[i]?.peso || "0"; 
            });
            
            DOMElements.magiasList.innerHTML = "";
            ficha.magiasHabilidades.forEach(magiaData => criarSlotMagia(magiaData));

            if (ficha.imagem && ficha.imagem.startsWith('data:image')) { 
                DOMElements.characterImage.src = ficha.imagem; 
                DOMElements.characterImage.style.display = "block"; 
            } else { 
                DOMElements.characterImage.src = ''; 
                DOMElements.characterImage.style.display = "none"; 
            }

            atualizarBotaoBloquear();
            
            // Reset do desbloqueio de XP
            DOMElements.experiencia.readOnly = true;
            DOMElements.xpLockIcon.textContent = 'üîí';
            if (xpUnlockTimerId) clearTimeout(xpUnlockTimerId);

            nivel = 0; // Reseta para recalcular
            atualizarNivel();

            vidaAtual = ficha.vidaAtual !== undefined ? parseInt(ficha.vidaAtual) : vidaTotal;
            magiaAtual = ficha.magiaAtual !== undefined ? parseInt(ficha.magiaAtual) : magiaTotal;
            vigorAtual = ficha.vigorAtual !== undefined ? parseFloat(ficha.vigorAtual) : vigorTotal;
            
            DOMElements.vidaAtualInput.value = Math.min(vidaAtual, vidaTotal);
            DOMElements.magiaAtualInput.value = Math.min(magiaAtual, magiaTotal);
            DOMElements.vigorAtualInput.value = (Math.min(vigorAtual, vigorTotal)).toFixed(1);

            // Armazena valores iniciais para reverter em caso de bloqueio
            previousValues.clear();
            document.querySelectorAll('input, textarea, select').forEach(el => {
                previousValues.set(el, el.value);
            });
            
            // Aplica todas as customiza√ß√µes visuais
            aplicarTodasAsCustomizacoesVisuais(ficha);
            aplicarEstadoColapsoSecoes(ficha.collapsedSections);

            // Atualiza estado do Modo GM
            document.body.classList.toggle("gm-mode-active", isGmModeActive);
            DOMElements.gmModeBtn.classList.toggle("gm-active", isGmModeActive);
            DOMElements.gmModeBtn.textContent = isGmModeActive ? "Modo Mestre Ativo üëë" : "Modo Mestre GM üëë";
            
            DOMElements.salvarAtributosBtn.style.display = "none";
        }
        
        /**
         * Salva todos os dados da ficha atual no objeto 'fichas' e no localStorage.
         */
        function salvarDados() {
            if (!currentFichaId || !fichas[currentFichaId] || (isFichaLocked && !isFichaUnlockedTemporarily)) return;

            const fichaAtual = fichas[currentFichaId];
            
            const inventario = Array.from(DOMElements.inventarioSlots.querySelectorAll(".inventory-slot")).map(slot => ({ item: slot.querySelector(".inventory-item").value, peso: slot.querySelector(".inventory-weight").value }));
            const magias = Array.from(DOMElements.magiasList.querySelectorAll(".magia-item")).map(item => ({
                nome: item.querySelector('.magia-nome').value,
                custo: item.querySelector('.magia-custo').value,
                custoVigor: item.querySelector('.magia-custo-vigor').value,
                dano: item.querySelector('.magia-dano').value,
                tipo: item.querySelector('.magia-tipo').value
            }));

            // Dados b√°sicos e atributos
            fichaAtual.nomePersonagem = DOMElements.nomePersonagem.value;
            fichaAtual.descricaoPersonagem = DOMElements.descricaoPersonagem.value;
            fichaAtual.forca = DOMElements.forca.value;
            fichaAtual.destreza = DOMElements.destreza.value;
            fichaAtual.agilidade = DOMElements.agilidade.value;
            fichaAtual.inteligencia = DOMElements.inteligencia.value;
            fichaAtual.constituicao = DOMElements.constituicao.value;
            fichaAtual.experiencia = DOMElements.experiencia.value;
            
            // Combate
            fichaAtual.armaDireitaNome = DOMElements.armaDireitaNome.value;
            fichaAtual.armaDireitaAtaque = DOMElements.armaDireitaAtaque.value;
            fichaAtual.armaDireitaAtaqueMagico = DOMElements.armaDireitaAtaqueMagico.value;
            fichaAtual.armaEsquerdaNome = DOMElements.armaEsquerdaNome.value;
            fichaAtual.armaEsquerdaAtaque = DOMElements.armaEsquerdaAtaque.value;
            fichaAtual.armaEsquerdaAtaqueMagico = DOMElements.armaEsquerdaAtaqueMagico.value;
            
            // Listas e Textos
            fichaAtual.vantagens = vantagensSelecionadas.join("\n");
            fichaAtual.desvantagens = desvantagensSelecionadas.join("\n");
            fichaAtual.magiasHabilidades = magias; 
            fichaAtual.inventario = inventario;
            fichaAtual.anotacoes = DOMElements.anotacoesTextarea.value;
            
            // Classe e Ra√ßa
            fichaAtual.classeNome = DOMElements.classeNome.value;
            fichaAtual.classeDescricao = DOMElements.classeDescricao.value;
            fichaAtual.racaNome = DOMElements.racaNome.textContent;
            fichaAtual.racaDescricao = DOMElements.racaDescricao.value;
            fichaAtual.racaSelecionada = racaSelecionada;

            // Estado da Ficha
            fichaAtual.isLocked = isFichaLocked;
            fichaAtual.password = fichaPassword;
            fichaAtual.imagem = DOMElements.characterImage.src.startsWith('data:image') ? DOMElements.characterImage.src : null;

            // Recursos atuais
            fichaAtual.vidaAtual = parseInt(DOMElements.vidaAtualInput.value) || 0;
            fichaAtual.magiaAtual = parseInt(DOMElements.magiaAtualInput.value) || 0;
            fichaAtual.vigorAtual = parseFloat(DOMElements.vigorAtualInput.value) || 0;

            // Customiza√ß√£o Visual (salvo mesmo se n√£o estiver no modo customiza√ß√£o)
            fichaAtual.darkMode = document.body.classList.contains("dark-mode");
            fichaAtual.theme = getCurrentThemeFromClasses();
            fichaAtual.fontFamily = DOMElements.fontSelector.value;
            fichaAtual.backgroundColor = DOMElements.backgroundColorInput.value;
            fichaAtual.fichaInternalBackgroundColor = DOMElements.fichaInternalBackgroundColorInput.value;
            fichaAtual.fichaTransparencyLevel = parseInt(DOMElements.fichaTransparencySlider.value);
            
            const bgImageStyle = document.body.style.backgroundImage;
            fichaAtual.backgroundImage = (bgImageStyle === 'none' || bgImageStyle === '') ? null : bgImageStyle.slice(5, -2).replace(/"/g, "").replace(/'/g, "");
            fichaAtual.backgroundSize = document.body.style.backgroundSize;
            fichaAtual.backgroundAttachment = document.body.style.backgroundAttachment;
            
            fichaAtual.corBordaSecao = DOMElements.corBordaSecaoInput.value;
            fichaAtual.estiloBordaSecao = DOMElements.estiloBordaSecaoSelect.value;
            fichaAtual.larguraBordaSecao = DOMElements.larguraBordaSecaoInput.value + 'px';
            
            fichaAtual.shadowColorFicha = DOMElements.shadowColorFichaInput.value;
            fichaAtual.shadowIntensityFicha = parseInt(DOMElements.shadowIntensityFichaSlider.value);
            
            fichaAtual.diceColor = DOMElements.diceColorInput.value;
            fichaAtual.diceNumberColor = DOMElements.diceNumberColorInput.value;
            fichaAtual.animacaoDado = DOMElements.diceAnimationSelector.value;
            
            // N√£o salvamos texturaDado aqui, √© salvo em sua pr√≥pria fun√ß√£o `aplicarTexturaDado`

            saveFichasToStorage(fichas);
        }
        
        /**
         * Lida com a exclus√£o da ficha atual.
         */
        function excluirFicha() {
            if (currentFichaId === FICHA_MATRIZ_ID) {
                showNotification("A ficha matriz n√£o pode ser exclu√≠da!", "normal-result");
                return;
            }
            if (isFichaLocked && !isFichaUnlockedTemporarily) {
                abrirModalSenha(null, excluirFicha); // Passa a pr√≥pria fun√ß√£o como callback
                return;
            }

            abrirModalConfirmacao(
                "Excluir Ficha?",
                "Tem certeza que deseja excluir esta ficha? Esta a√ß√£o n√£o pode ser desfeita.",
                () => {
                    delete fichas[currentFichaId];
                    saveFichasToStorage(fichas);
                    currentFichaId = FICHA_MATRIZ_ID;
                    saveCurrentFichaIdToStorage(currentFichaId);
                    carregarFicha(currentFichaId);
                    atualizarAbasFichas();
                    showNotification("Ficha exclu√≠da.", "save-success");
                }
            );
        }

        // ... (restante das fun√ß√µes principais como calcularAtributos, atualizarNivel, etc.) ...
        
        // =================================================================================
        // 6. UI & VISUAL FUNCTIONS
        // =================================================================================
        
        function showNotification(message, type, duration = 3000) {
            const notification = DOMElements.notification;
            notification.innerHTML = message;
            notification.className = type;
            notification.style.display = "block";
            setTimeout(() => {
                notification.style.display = "none";
                notification.className = "";
                notification.innerHTML = "";
            }, duration);
        }
        
        function fecharModal(modalId) { 
            const modal = document.getElementById(modalId);
            if(modal) modal.style.display = "none"; 
        }

        function abrirModal(modalId) {
            const modal = document.getElementById(modalId);
            if(modal) modal.style.display = "flex";
        }
        
        function abrirModalConfirmacao(title, text, onConfirm) {
            DOMElements.confirmModalTitle.textContent = title;
            DOMElements.confirmModalText.textContent = text;

            const yesBtn = DOMElements.confirmModalYesBtn;
            const noBtn = DOMElements.confirmModalNoBtn;
            
            const handleConfirm = () => {
                onConfirm();
                fecharModal('confirm-modal');
                cleanup();
            };
            const handleCancel = () => {
                fecharModal('confirm-modal');
                cleanup();
            };
            const cleanup = () => {
                yesBtn.removeEventListener('click', handleConfirm);
                noBtn.removeEventListener('click', handleCancel);
            };

            yesBtn.addEventListener('click', handleConfirm);
            noBtn.addEventListener('click', handleCancel);
            
            abrirModal('confirm-modal');
        }

        function atualizarAbasFichas() {
            const sidebar = document.getElementById("fichas-sidebar");
            const addBtn = DOMElements.addFichaBtn;
            
            // Limpa abas existentes, exceto o bot√£o de adicionar
            sidebar.innerHTML = ''; 
            sidebar.appendChild(addBtn);

            // Adiciona a Matriz primeiro
            const sortedIds = [FICHA_MATRIZ_ID, ...Object.keys(fichas).filter(id => id !== FICHA_MATRIZ_ID)];

            for (const fichaId of sortedIds) {
                if (!fichas[fichaId]) continue;
                
                const tab = document.createElement("div");
                tab.className = "ficha-tab";
                const span = document.createElement("span");
                span.textContent = fichas[fichaId].nomeFicha || "Sem Nome";
                tab.appendChild(span);
                tab.dataset.fichaId = fichaId;
                
                if (fichaId === currentFichaId) tab.classList.add("active");
                
                tab.addEventListener('click', () => {
                    if(currentFichaId !== fichaId) {
                        currentFichaId = fichaId;
                        saveCurrentFichaIdToStorage(currentFichaId);
                        carregarFicha(fichaId);
                        atualizarAbasFichas();
                    }
                });
                
                sidebar.insertBefore(tab, addBtn);
            }
        }
        
        function aplicarTodasAsCustomizacoesVisuais(ficha) {
            limparClassesDeTema();
            aplicarClassesDeTema(ficha.theme || 'theme-medieval');
            aplicarPlanoDeFundoInicial(ficha);
            aplicarFonteInicial(ficha);
            aplicarEstilosFichaInicial(ficha);
            aplicarCustomizacoesDadoInicial(ficha);
            aplicarCoresDadoInicial(ficha);
            aplicarEstilosDeFundoVisuais();
            aplicarEstilosDeSombra();
        }

        // ... (outras fun√ß√µes de UI como aplicarFonteInicial, etc.)

        // =================================================================================
        // 7. EVENT HANDLERS & SETUP
        // =================================================================================

        function setupEventListeners() {
            // Bot√µes principais
            DOMElements.addFichaBtn.addEventListener('click', () => abrirModal('nome-ficha-modal'));
            DOMElements.resetPontos.addEventListener('click', resetarPontos);
            DOMElements.recomecar.addEventListener('click', recomecarFicha);
            DOMElements.bloquearFicha.addEventListener('click', () => {
                if (isFichaLocked) {
                    abrirModalSenha();
                } else {
                    abrirModal('bloquear-ficha-modal');
                }
            });
            DOMElements.excluirFicha.addEventListener('click', excluirFicha);
            DOMElements.customizacaoBtn.addEventListener('click', abrirModalCustomizacao);
            DOMElements.gmModeBtn.addEventListener('click', toggleGmMode);
            
            // Modais
            document.querySelectorAll('[data-action="fechar-modal"]').forEach(btn => 
                btn.addEventListener('click', (e) => fecharModal(e.target.closest('.modal').id))
            );
            DOMElements.nomeFichaModal.querySelector('[data-action="confirmar-nova-ficha"]').addEventListener('click', criarNovaFicha);
            DOMElements.bloquearFichaModal.querySelector('[data-action="confirmar-bloqueio"]').addEventListener('click', bloquearFicha);
            DOMElements.passwordModal.querySelector('[data-action="confirmar-desbloqueio"]').addEventListener('click', desbloquearFicha);
            DOMElements.passwordModal.querySelector('[data-action="cancelar-desbloqueio"]').addEventListener('click', cancelarDesbloqueio);

            // ... (restante dos event listeners para customiza√ß√£o, etc.)
            
            // Inputs de Atributos e Recursos
            DOMElements.atributosInputs.forEach(input => {
                input.addEventListener("focus", (event) => previousValues.set(event.target, event.target.value));
                input.addEventListener("input", handleAttributeInput);
            });
            
            [DOMElements.vidaAtualInput, DOMElements.magiaAtualInput, DOMElements.vigorAtualInput].forEach(input => {
                input.addEventListener('input', handleResourceInput);
                input.addEventListener('focus', (event) => previousValues.set(event.target, event.target.value));
            });

            // Bot√µes +/- (Hold)
            setupHoldButtonEvents(DOMElements.btnAumentarVida, aumentarVida);
            setupHoldButtonEvents(DOMElements.btnDiminuirVida, diminuirVida);
            // ... (para todos os bot√µes +/-)
        }

        function handleAttributeInput(event) {
            const inputTarget = event.target;
            const ficha = fichas[currentFichaId];
            if (!ficha) return;
            
            if (isFichaLocked && !isFichaUnlockedTemporarily && currentFichaId !== FICHA_MATRIZ_ID) {
                inputTarget.value = previousValues.get(inputTarget) || ((ficha.lockedAtributos && ficha.lockedAtributos[inputTarget.id]) || "0");
                abrirModalSenha(inputTarget);
                return;
            }

            let currentValue = parseInt(inputTarget.value) || 0;
            const lockedValue = (ficha.lockedAtributos && ficha.lockedAtributos[inputTarget.id] !== undefined)
                                ? ficha.lockedAtributos[inputTarget.id] : 0;
            
            if (currentValue < lockedValue && !isGmModeActive) {
                showNotification(`O valor de ${inputTarget.labels[0].textContent.replace(":", "")} n√£o pode ser menor que o m√≠nimo salvo: ${lockedValue}.`, "normal-result", 4000);
                inputTarget.value = lockedValue;
            }

            // Mostra o bot√£o "Salvar M√≠nimos" se houver altera√ß√µes para salvar
            let hasChangesToSave = DOMElements.atributosInputs.some(inp => (parseInt(inp.value) || 0) > ((ficha.lockedAtributos && ficha.lockedAtributos[inp.id]) || 0));
            DOMElements.salvarAtributosBtn.style.display = hasChangesToSave ? "inline-block" : "none";

            calcularAtributos();
            salvarDados();
        }

        // ... (restante das fun√ß√µes de handling de eventos)

        // =================================================================================
        // 8. INITIALIZATION
        // =================================================================================
        
        document.addEventListener('DOMContentLoaded', () => {
            cacheDOMElements();
            setupEventListeners();
            carregarFichas();

            // Configura√ß√£o do arrastar do dado
            if (DOMElements.diceContainer) {
                let isDragging = false, currentX, currentY, initialX, initialY;
                DOMElements.diceContainer.addEventListener('mousedown', e => { 
                    isDragging = true; 
                    currentX = DOMElements.diceContainer.offsetLeft;
                    currentY = DOMElements.diceContainer.offsetTop;
                    initialX = e.clientX - currentX; 
                    initialY = e.clientY - currentY; 
                    DOMElements.diceContainer.style.cursor = "grabbing"; 
                });
                document.addEventListener('mousemove', e => { 
                    if (isDragging) { 
                        e.preventDefault(); 
                        currentX = e.clientX - initialX; 
                        currentY = e.clientY - initialY; 
                        DOMElements.diceContainer.style.left = `${currentX}px`; 
                        DOMElements.diceContainer.style.top = `${currentY}px`; 
                        DOMElements.diceContainer.style.right = "auto"; 
                    } 
                });
                document.addEventListener('mouseup', () => { 
                    if(isDragging) {
                        isDragging = false; 
                        DOMElements.diceContainer.style.cursor = "move";
                    }
                });
            }
        });

    })(); // End of IIFE
    </script>
</body>
</html>
