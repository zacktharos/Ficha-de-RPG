<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ficha de Personagem RPG</title>
    <link href="https://fonts.googleapis.com/css2?family=MedievalSharp&family=Inter:wght@400;600&display=swap"
        rel="stylesheet">
    <script src="https://unpkg.com/@tailwindcss/browser@4"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <style>
        /* Estilos Gerais e Modo Escuro (Início) */
        :root {
            --cor-fundo-externo-padrao: #f5f5f5;
            --cor-fundo-interno-padrao: rgba(240, 230, 210, 0.95);
            --cor-texto-padrao: #000;
            --cor-fundo-externo-dark: #121212;
            --cor-fundo-interno-dark: rgba(30, 30, 30, 0.95);
            --cor-texto-dark: #e0e0e0;
            --borda-padrao: #b8860b;
            --borda-dark: #444;
            --bg-secao-padrao: #f0e6d2;
            --bg-secao-dark: #1e1e1e;
            --input-bg-padrao: #fff;
            --input-bg-dark: #333;
            --input-borda-padrao: #b8860b;
            --input-borda-dark: #555;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--cor-fundo-externo-padrao);
            color: var(--cor-texto-padrao);
            display: flex;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            /* Imagem removida inicialmente, será controlada pelo JS */
            background-image: none;
            background-size: cover;
            background-position: center;
            background-attachment: fixed; /* Para a imagem não rolar */
            transition: background 0.3s, color 0.3s;
        }

        body.dark-mode {
            background-color: var(--cor-fundo-externo-dark);
            color: var(--cor-texto-dark);
            background-image: none; /* Garante que a cor sólida do dark mode apareça */
        }

        /* Estilos para a ficha e seções */
        #ficha-container {
            background: var(--cor-fundo-interno-padrao);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
            width: 95%;
            max-width: 1200px;
            margin: 80px auto 20px;
            border: 2px solid var(--borda-padrao);
            position: relative;
            transition: background 0.3s, border-color 0.3s;
        }

        body.dark-mode #ficha-container {
            background: var(--cor-fundo-interno-dark);
            border-color: var(--borda-dark);
        }

        section {
            background: var(--bg-secao-padrao);
            border: 2px solid var(--borda-padrao);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            transition: background 0.3s, border-color 0.3s;
        }

        body.dark-mode section {
            background: var(--bg-secao-dark);
            border-color: var(--borda-dark);
        }

        /* Estilos para inputs, labels e outros elementos */
        label {
            font-weight: 600;
            color: var(--cor-texto-padrao);
            margin-bottom: 8px;
            display: block;
            transition: color 0.3s;
        }

        body.dark-mode label {
            color: var(--cor-texto-dark);
        }

        input[type="text"],
        input[type="number"],
        textarea {
            padding: 10px;
            border: 2px solid var(--input-borda-padrao);
            border-radius: 6px;
            width: calc(100% - 24px);
            margin-bottom: 15px;
            font-size: 1rem;
            transition: border-color 0.3s ease, background-color 0.3s, color 0.3s;
            background: var(--input-bg-padrao);
            color: var(--cor-texto-padrao);
        }

        body.dark-mode input[type="text"],
        body.dark-mode input[type="number"],
        body.dark-mode textarea {
            background: var(--input-bg-dark);
            color: var(--cor-texto-dark);
            border-color: var(--input-borda-dark);
        }

         input[type="text"]:focus,
        input[type="number"]:focus,
        textarea:focus {
            border-color: #a0522d;
            outline: none;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1)
        }

        input[readonly],
        span[readonly] {
            background: #e8e8e8;
            border: 1px solid #ccc;
            cursor: not-allowed;
        }

         body.dark-mode input[readonly],
        body.dark-mode span[readonly] {
            background: #444;
            border-color: #666;
        }

        /* ... (restante dos seus estilos CSS existentes - omitidos por brevidade) ... */
        h1#nome-personagem-titulo {
             font-family: 'MedievalSharp', serif;
             /* Cor inicial pode ser sobrescrita pelo dark mode */
             color: #1C2526;
             font-size: 3rem;
             margin-bottom: 20px;
             text-align: center;
             text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
             animation: raios 2s infinite linear;
             transition: color 0.3s;
        }
        body.dark-mode h1#nome-personagem-titulo {
             color: var(--cor-texto-dark); /* Ajusta cor no dark mode */
        }

        .medieval-box {
            background: var(--bg-secao-padrao);
            border: 2px solid var(--borda-padrao);
            border-radius: 8px;
            padding: 10px;
            margin: 5px 0;
            text-align: center;
            transition: background 0.3s, border-color 0.3s;
        }

        body.dark-mode .medieval-box {
            background: var(--bg-secao-dark);
            border-color: var(--borda-dark);
        }

        .regeneracao {
            font-size: 0.8rem;
            color: #555;
            margin-top: 5px;
            transition: color 0.3s;
        }

        body.dark-mode .regeneracao {
            color: #aaa;
        }

        button {
            background: #b8860b;
            color: #fff;
            border: none;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 1.2rem;
            border-radius: 4px;
            margin: 0 5px;
            transition: background-color 0.3s ease;
        }

        body.dark-mode button {
            /* Ajuste se necessário para botões específicos */
        }
        body.dark-mode button:not(.botao):not(.ficha-tab):not(#add-ficha-btn):not(#chat-btn) {
             background: #555;
        }

        button:hover {
            background: #a0522d;
        }

        body.dark-mode button:not(.botao):not(.ficha-tab):not(#add-ficha-btn):not(#chat-btn):hover {
             background: #777;
        }


        .botao {
            padding: 12px 25px;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease, color 0.3s;
            font-family: 'MedievalSharp', serif;
            color: #fff;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
        }

         body.dark-mode .botao:not(#lua-btn):not(#sol-btn):not(#cor-fundo-btn) { /* Evita sobrescrever botões de tema */
             background: #555;
         }

         body.dark-mode .botao:not(#lua-btn):not(#sol-btn):not(#cor-fundo-btn):hover {
             background: #777;
         }

        .botao-reset {
            background: #b8860b;
        }
        .botao-reset:hover {
            background: #a0522d;
            transform: translateY(-2px);
        }
        .botao-recomecar, .botao-excluir {
            background: #a52a2a;
        }
        .botao-recomecar:hover, .botao-excluir:hover {
            background: #8b0000;
            transform: translateY(-2px);
        }
         .botao-bloquear, .botao-desbloquear {
            background: #4a4a4a;
        }
        .botao-bloquear:hover, .botao-desbloquear:hover {
            background: #2a2a2a;
            transform: translateY(-2px);
        }
        #lua-btn, #sol-btn, #cor-fundo-btn {
            background: #4a4a4a; /* Cor base para botões de tema */
        }
        #lua-btn:hover, #sol-btn:hover, #cor-fundo-btn:hover {
            background: #2a2a2a;
            transform: translateY(-2px);
        }

        /* ... (Demais estilos inalterados) ... */

         #dice-container label {
            font-size: 1.2rem;
            color: var(--cor-texto-padrao); /* Usa variável */
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 10px;
            transition: color 0.3s;
        }

        body.dark-mode #dice-container label {
            color: var(--cor-texto-dark); /* Usa variável */
        }
        #dice-roll {
            width: 100px;
            height: 100px;
            background: var(--bg-secao-padrao); /* Usa variável */
            border: 2px solid var(--borda-padrao); /* Usa variável */
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            cursor: pointer;
            margin: 0 auto;
            position: relative;
            transition: all 0.3s ease;
            color: var(--cor-texto-padrao); /* Garante cor do texto */
        }

        body.dark-mode #dice-roll {
            background: var(--bg-secao-dark); /* Usa variável */
            border-color: var(--borda-dark); /* Usa variável */
            color: var(--cor-texto-dark); /* Garante cor do texto no dark mode */
        }

        #dice-result {
            margin-top: 10px;
            font-size: 1rem;
            color: var(--cor-texto-padrao); /* Usa variável */
            display: none;
            animation: blink 1s infinite;
            transition: color 0.3s;
        }

        body.dark-mode #dice-result {
            color: var(--cor-texto-dark); /* Usa variável */
        }

        #character-image-container {
             position: absolute;
             top: 10px;
             left: 10px;
             width: 100px;
             height: 100px;
             background: var(--bg-secao-padrao); /* Usa variável */
             border: 2px solid var(--borda-padrao); /* Usa variável */
             border-radius: 8px;
             display: flex;
             align-items: center;
             justify-content: center;
             cursor: pointer;
             overflow: hidden;
             z-index: 10;
             transition: background 0.3s, border-color 0.3s;
        }

        body.dark-mode #character-image-container {
             background: var(--bg-secao-dark); /* Usa variável */
             border-color: var(--borda-dark); /* Usa variável */
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: var(--bg-secao-padrao); /* Usa variável */
            padding: 20px;
            border-radius: 8px;
            border: 2px solid var(--borda-padrao); /* Usa variável */
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            /* width: 300px; */ /* Removido para permitir larguras diferentes */
            text-align: center;
            transition: background 0.3s, border-color 0.3s;
            color: var(--cor-texto-padrao); /* Cor do texto no modal */
        }

        body.dark-mode .modal-content {
            background: var(--bg-secao-dark); /* Usa variável */
            border-color: var(--borda-dark); /* Usa variável */
            color: var(--cor-texto-dark); /* Cor do texto no modal dark */
        }

         .modal-content h3 {
             font-family: 'MedievalSharp', serif;
             color: var(--cor-texto-padrao); /* Ajustado */
             margin-bottom: 15px;
             transition: color 0.3s;
         }
         body.dark-mode .modal-content h3 {
             color: var(--cor-texto-dark); /* Ajustado */
         }

        /* Estilos para o novo Modal de Cores */
        #cor-fundo-modal .modal-content {
            width: 450px; /* Largura média */
            max-height: 80vh;
            overflow-y: auto;
        }

        .color-section {
            margin-bottom: 20px;
        }

        .color-section h4 {
            font-family: 'MedievalSharp', serif;
            font-size: 1.3rem;
            margin-bottom: 10px;
            text-align: left;
            /* Color já herda do modal-content */
        }

        .color-options {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .color-circle {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid transparent;
            transition: border-color 0.2s, transform 0.2s;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
            background-size: cover; /* Para o padrão Exército */
            background-position: center; /* Para o padrão Exército */
        }

        .color-circle:hover {
            transform: scale(1.1);
        }

        .color-circle.selected {
            border-color: #ffd700; /* Destaque dourado para selecionado */
            transform: scale(1.1);
        }

        #cor-fundo-modal .modal-buttons {
            display: flex;
            justify-content: space-around;
            margin-top: 20px;
        }

         #cor-fundo-modal button {
            padding: 10px 20px;
            font-family: 'MedievalSharp', serif;
         }

        #salvar-cores-btn { background-color: #228B22; } /* Verde */
        #excluir-cores-btn { background-color: #DC143C; } /* Vermelho */
        #cancelar-cores-btn { background-color: #696969; } /* Cinza */

        #salvar-cores-btn:hover { background-color: #006400; }
        #excluir-cores-btn:hover { background-color: #8B0000; }
        #cancelar-cores-btn:hover { background-color: #505050; }


        /* ... (restante dos estilos CSS - ajuste variáveis conforme necessário) ... */
        #fichas-sidebar {
            /* ... */
            background: transparent; /* Mantém transparente */
             /* ... */
        }
        .ficha-tab, #add-ficha-btn {
             background: var(--bg-secao-padrao);
             border: 2px solid var(--borda-padrao);
             /* ... */
             transition: background-color 0.3s ease, transform 0.2s ease, border-color 0.3s;
        }
        body.dark-mode .ficha-tab, body.dark-mode #add-ficha-btn {
             background: var(--bg-secao-dark);
             border-color: var(--borda-dark);
        }
        .ficha-tab span, #add-ficha-btn span {
             color: var(--cor-texto-padrao);
             transition: color 0.3s;
        }
         body.dark-mode .ficha-tab span, body.dark-mode #add-ficha-btn span {
             color: var(--cor-texto-dark);
         }
         .ficha-tab:hover, #add-ficha-btn:hover {
            background: #a0522d;
            transform: translateY(-5px);
        }
        .ficha-tab.active {
            background: #a0522d; /* Cor ativa pode ser mantida */
            transform: translateY(-5px);
        }

         #chat-btn {
            padding: 15px;
            background: var(--bg-secao-padrao); /* Usa variável */
            border: 2px solid var(--borda-padrao); /* Usa variável */
            border-radius: 8px;
            font-family: 'MedievalSharp', serif;
            font-size: 1.2rem;
            color: var(--cor-texto-padrao); /* Usa variável */
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s, border-color 0.3s, color 0.3s;
            box-shadow: 3px 3px 7px rgba(0, 0, 0, 0.3);
         }
         #chat-btn:hover {
            background: #a0522d;
            transform: translateY(-3px);
        }
         body.dark-mode #chat-btn {
            background: var(--bg-secao-dark); /* Usa variável */
            color: var(--cor-texto-dark); /* Usa variável */
            border-color: var(--borda-dark); /* Usa variável */
        }
        body.dark-mode #chat-btn:hover {
            background: #333;
        }

    </style>
</head>

<body>
    <div id="chat-btn-container">
        <button id="chat-btn" data-unread="0">💬 Chat</button>
    </div>

    <div id="fichas-sidebar">
        <div id="add-ficha-btn"><span>+ Fichas</span></div>
    </div>

    <div id="ficha-container">
         <div class="botoes-container">
                <button id="reset-pontos" class="botao botao-reset">Reiniciar Pontos</button>
                 <button id="recomecar" class="botao botao-recomecar">Recomeçar</button>
                <button id="bloquear-ficha" class="botao botao-bloquear">Bloquear Ficha</button>
                <button id="lua-btn" class="botao" title="Modo Escuro">🌙</button>
                <button id="sol-btn" class="botao" title="Modo Claro">☀️</button>
                <button id="cor-fundo-btn" class="botao" title="Cor de Fundo">🎨</button>
            </div>

            <button id="excluir-ficha" class="botao botao-excluir">Excluir Ficha</button>
        </div>

    <button id="anotacoes-btn">Anotações</button>
    <textarea id="anotacoes-textarea" placeholder="Suas anotações aqui..."></textarea>

    <button id="historico-dados-btn">Histórico de dados</button>
    <div id="historico-dados-panel">
        <h3>Histórico de Dados</h3>
        <div id="historico-lista"></div>
        <button id="excluir-historico-btn">Excluir histórico</button>
    </div>


    <div id="vantagens-desvantagens-panel">
        <h2>Vantagens e Desvantagens</h2>
        <div>Pontos de Vantagem Temporários: <span id="ph-temp">0</span></div>
        <div id="vantagens-list"></div>
         <div id="desvantagens-list"></div>
        <button id="salvar-vantagens-btn">SALVAR</button>
        <button id="fechar-pagina-btn">Fechar Página</button>
    </div>
    <div id="nome-ficha-modal" class="modal">
        </div>
    <div id="bloquear-ficha-modal" class="modal">
         </div>
    <div id="password-modal" class="modal">
         </div>
    <div id="chat-modal" class="modal">
         </div>

    <div id="cor-fundo-modal" class="modal">
        <div class="modal-content">
            <h3>Escolha as Cores de Fundo</h3>

            <div class="color-section">
                <h4>Cor de fundo parte externa</h4>
                <div class="color-options" id="cores-externas">
                    </div>
            </div>

            <div class="color-section">
                <h4>Cor de fundo parte interna</h4>
                <div class="color-options" id="cores-internas">
                    </div>
            </div>

            <div class="modal-buttons">
                <button id="salvar-cores-btn" class="botao">Salvar</button>
                <button id="excluir-cores-btn" class="botao">Excluir</button>
                <button id="cancelar-cores-btn" class="botao">Cancelar</button>
            </div>
        </div>
    </div>


    <div id="notification"></div>

    <audio id="new-message-sound" preload="auto">
        <source src="notification_sound.mp3" type="audio/mpeg">
        </audio>

    <script>
        // ... (Configuração Firebase e variáveis globais existentes) ...
        const firebaseConfig = {
            apiKey: "AIzaSyBbbwbwPXv6gztkyP3TXK-DtooEI7FcClI", // ATENÇÃO: Expor a API Key publicamente pode ser um risco. Considere usar regras de segurança do Firebase.
            authDomain: "ficha-de-rpg-b9685.firebaseapp.com",
            databaseURL: "https://ficha-de-rpg-b9685-default-rtdb.firebaseio.com",
            projectId: "ficha-de-rpg-b9685",
            storageBucket: "ficha-de-rpg-b9685.firebasestorage.app",
            messagingSenderId: "528610398062",
            appId: "1:528610398062:web:8fdb9cfd5ded8167613b7f"
        };
        firebase.initializeApp(firebaseConfig);

        const database = firebase.database();

        let fichas = {},
            currentFichaId = null,
            isFichaLocked = false,
            fichaPassword = null,
            isFichaUnlocked = false,
            senhaMatriz = "1040", // ATENÇÃO: Senha fixa no código não é seguro.
            vantagensSelecionadas = [],
            desvantagensSelecionadas = [],
            tempVantagensSelecionadas = [],
            tempDesvantagensSelecionadas = [],
            racaSelecionada = null,
            tempRacaSelecionada = null,
            vidaTotal,
            vidaAtual,
            magiaTotal,
            magiaAtual,
            vigorTotal,
            vigorAtual,
            previousValues = new Map(),
            chatPassword = null,
            isChatOpen = false,
            selectedChatUser = null;

        // Definições de dados (vantagens, desvantagens, racas, nivel) - Omitidos por brevidade
        const vantagensData = [/* ... seu array de vantagens ... */];
        const desvantagensData = [/* ... seu array de desvantagens ... */];
        let racasData = [/* ... seu array de raças ... */];
        const nivelData = [/* ... seu array de níveis ... */];


        // Elementos do DOM (adicionar os novos)
        const nomePersonagemInput = document.getElementById("nome-personagem");
        // ... (todos os outros getElementById existentes) ...
        const luaBtn = document.getElementById("lua-btn");
        const solBtn = document.getElementById("sol-btn");
        const corFundoBtn = document.getElementById("cor-fundo-btn"); // Novo
        const corFundoModal = document.getElementById("cor-fundo-modal"); // Novo
        const coresExternasContainer = document.getElementById("cores-externas"); // Novo
        const coresInternasContainer = document.getElementById("cores-internas"); // Novo
        const salvarCoresBtn = document.getElementById("salvar-cores-btn"); // Novo
        const excluirCoresBtn = document.getElementById("excluir-cores-btn"); // Novo
        const cancelarCoresBtn = document.getElementById("cancelar-cores-btn"); // Novo
        const fichaContainer = document.getElementById("ficha-container"); // Já deve existir, mas referenciar aqui

        // --- INÍCIO: Nova Funcionalidade de Cores ---

        const defaultExternalBg = 'url("medieval_background.jpg")'; // Background padrão externo
        const defaultInternalBg = 'rgba(240, 230, 210, 0.95)'; // Background padrão interno
        const defaultExternalBgColor = '#f5f5f5'; // Fallback de cor externa
        const defaultInternalBgColor = 'rgba(240, 230, 210, 0.95)'; // Cor interna padrão

        const colorOptions = [
            { name: 'Pergaminho', external: defaultExternalBg, internal: defaultInternalBgColor, preview: '#f0e6d2' }, // Usar preview para o círculo
            { name: 'Bordô', value: '#800000' },
            { name: 'Azul Escuro', value: '#00008B' },
            { name: 'Azul Claro', value: '#ADD8E6' },
            { name: 'Verde Escuro', value: '#006400' },
            { name: 'Verde Claro', value: '#90EE90' },
            { name: 'Rosa Claro', value: '#FFB6C1' },
            { name: 'Rosa Escuro', value: '#FF1493' },
            { name: 'Branco', value: '#FFFFFF' },
            { name: 'Laranja', value: '#FFA500' },
            { name: 'Roxo', value: '#800080' },
            { name: 'Vermelho', value: '#FF0000' },
            { name: 'Amarelo', value: '#FFFF00' },
            { name: 'Exército', value: 'linear-gradient(45deg, #556B2F, #8FBC8F, #2E8B57, #6B8E23)', preview: '#556B2F' } // Gradiente como valor
        ];

        let selectedExternalColor = localStorage.getItem('externalBg') || defaultExternalBg;
        let selectedInternalColor = localStorage.getItem('internalBg') || defaultInternalBg;
        let tempExternalColor = selectedExternalColor;
        let tempInternalColor = selectedInternalColor;
        let originalExternalColor = selectedExternalColor; // Para cancelar
        let originalInternalColor = selectedInternalColor; // Para cancelar

        // Função para aplicar cores ao body e ficha-container
        function applyColors(externalBg, internalBg) {
            // Aplica cor externa
            if (externalBg.startsWith('url') || externalBg.startsWith('linear-gradient')) {
                document.body.style.backgroundImage = externalBg;
                document.body.style.backgroundColor = ''; // Limpa cor sólida se for imagem/gradiente
            } else {
                document.body.style.backgroundColor = externalBg;
                document.body.style.backgroundImage = 'none'; // Remove imagem/gradiente
            }

            // Aplica cor interna
             if (fichaContainer) {
                 // Gradientes/Imagens não são diretamente suportados em rgba, então tratamos como cor sólida
                 if (internalBg.startsWith('url') || internalBg.startsWith('linear-gradient')) {
                     // Se precisar de gradiente/imagem interna, a lógica seria mais complexa
                     // Por ora, aplicamos a cor de preview como fallback
                     const colorData = colorOptions.find(c => c.value === internalBg);
                     fichaContainer.style.background = colorData ? colorData.preview || internalBg : internalBg;
                 } else {
                     fichaContainer.style.background = internalBg;
                 }
            }

            // Força atualização de variáveis CSS se necessário (opcional, dependendo dos estilos)
            // document.documentElement.style.setProperty('--cor-fundo-externo-atual', externalBg);
            // document.documentElement.style.setProperty('--cor-fundo-interno-atual', internalBg);
        }


        // Função para gerar os círculos de cores
        function generateColorCircles() {
            coresExternasContainer.innerHTML = '';
            coresInternasContainer.innerHTML = '';

            colorOptions.forEach(color => {
                const externalCircle = document.createElement('div');
                externalCircle.className = 'color-circle';
                const externalValue = color.external || color.value; // Pega valor específico externo ou o geral
                externalCircle.style.background = color.preview || color.value; // Usa preview ou valor para o círculo
                externalCircle.dataset.value = externalValue;
                externalCircle.title = color.name;
                if (tempExternalColor === externalValue) {
                    externalCircle.classList.add('selected');
                }
                externalCircle.onclick = () => selectColor('external', externalValue, externalCircle);
                coresExternasContainer.appendChild(externalCircle);

                const internalCircle = document.createElement('div');
                internalCircle.className = 'color-circle';
                 const internalValue = color.internal || color.value; // Pega valor específico interno ou o geral
                internalCircle.style.background = color.preview || color.value; // Usa preview ou valor para o círculo
                internalCircle.dataset.value = internalValue;
                internalCircle.title = color.name;
                if (tempInternalColor === internalValue) {
                    internalCircle.classList.add('selected');
                }
                internalCircle.onclick = () => selectColor('internal', internalValue, internalCircle);
                coresInternasContainer.appendChild(internalCircle);
            });
        }

        // Função chamada ao selecionar uma cor
        function selectColor(type, value, element) {
            if (type === 'external') {
                tempExternalColor = value;
                // Desmarca outros e marca o selecionado
                coresExternasContainer.querySelectorAll('.color-circle').forEach(c => c.classList.remove('selected'));
                element.classList.add('selected');
            } else if (type === 'internal') {
                tempInternalColor = value;
                 // Desmarca outros e marca o selecionado
                coresInternasContainer.querySelectorAll('.color-circle').forEach(c => c.classList.remove('selected'));
                element.classList.add('selected');
            }
            // Aplica preview imediatamente
            applyColors(tempExternalColor, tempInternalColor);
        }

        // Abrir Modal de Cores
        corFundoBtn.onclick = () => {
            // Salva cores atuais caso cancele
            originalExternalColor = document.body.style.backgroundImage || document.body.style.backgroundColor || defaultExternalBg;
             if(originalExternalColor === 'none') originalExternalColor = document.body.style.backgroundColor || defaultExternalBg; // Handle 'none' case

            originalInternalColor = fichaContainer.style.background || defaultInternalBg;

            tempExternalColor = selectedExternalColor; // Reseta temps para os salvos
            tempInternalColor = selectedInternalColor;
            generateColorCircles(); // Gera círculos com base nos temps
            corFundoModal.style.display = 'flex';
        };

        // Fechar Modal
        function closeColorModal() {
            corFundoModal.style.display = 'none';
        }

        // Botão Salvar Cores
        salvarCoresBtn.onclick = () => {
            selectedExternalColor = tempExternalColor;
            selectedInternalColor = tempInternalColor;
            localStorage.setItem('externalBg', selectedExternalColor);
            localStorage.setItem('internalBg', selectedInternalColor);
            applyColors(selectedExternalColor, selectedInternalColor); // Aplica definitivamente
            // Remove a classe dark-mode se cores customizadas forem salvas,
            // para evitar conflitos visuais inesperados.
            document.body.classList.remove('dark-mode');
            closeColorModal();
        };

        // Botão Excluir Cores (Resetar)
        excluirCoresBtn.onclick = () => {
            selectedExternalColor = defaultExternalBg;
            selectedInternalColor = defaultInternalBg;
            localStorage.removeItem('externalBg');
            localStorage.removeItem('internalBg');
            applyColors(selectedExternalColor, selectedInternalColor); // Aplica padrões
             // Se estava em dark mode antes de customizar, pode ser necessário reaplicar
            if (localStorage.getItem('darkMode') === 'enabled') {
                 document.body.classList.add('dark-mode');
                 applyDarkModeStyles(); // Aplica estilos dark explicitamente
            } else {
                 document.body.classList.remove('dark-mode');
                 applyLightModeStyles(); // Aplica estilos light explicitamente
            }
            closeColorModal();
        };

        // Botão Cancelar Cores
        cancelarCoresBtn.onclick = () => {
            applyColors(originalExternalColor, originalInternalColor); // Reverte para as cores antes de abrir o modal
            closeColorModal();
        };

        // Carregar preferências ao iniciar
        function loadColorPreferences() {
             const savedExternal = localStorage.getItem('externalBg');
             const savedInternal = localStorage.getItem('internalBg');

             // Aplica cores salvas apenas se existirem, senão usa o padrão inicial (com imagem)
             if (savedExternal || savedInternal) {
                 selectedExternalColor = savedExternal || defaultExternalBg;
                 selectedInternalColor = savedInternal || defaultInternalBg;
                 applyColors(selectedExternalColor, selectedInternalColor);
                 document.body.classList.remove('dark-mode'); // Garante que modo dark não interfira inicialmente se houver customização
             } else {
                 // Aplica a imagem de fundo padrão se não houver cores salvas
                 applyColors(defaultExternalBg, defaultInternalBg);
                  // Verifica se o modo escuro estava ativo
                 if (localStorage.getItem('darkMode') === 'enabled') {
                     document.body.classList.add('dark-mode');
                     applyDarkModeStyles();
                 }
             }
        }


         // --- FIM: Nova Funcionalidade de Cores ---

        // --- Modificações no Modo Escuro/Claro ---

        function applyDarkModeStyles() {
            document.body.style.backgroundColor = 'var(--cor-fundo-externo-dark)';
            document.body.style.backgroundImage = 'none'; // Remove imagem no dark mode
            document.body.style.color = 'var(--cor-texto-dark)';
            if(fichaContainer) fichaContainer.style.background = 'var(--cor-fundo-interno-dark)';
             // ... (outras adaptações de estilo específicas do dark mode, se necessário)
            localStorage.setItem('darkMode', 'enabled');
        }

        function applyLightModeStyles() {
            // Volta para o padrão (que pode ser customizado ou o original)
            const currentExternal = localStorage.getItem('externalBg') || defaultExternalBg;
            const currentInternal = localStorage.getItem('internalBg') || defaultInternalBg;
            applyColors(currentExternal, currentInternal); // Reapplica cores (customizadas ou padrão)
            document.body.style.color = 'var(--cor-texto-padrao)';
            localStorage.setItem('darkMode', 'disabled');
        }


        luaBtn.onclick = () => {
            document.body.classList.add("dark-mode");
            // Remove cores customizadas ao ativar modo escuro via botão
            localStorage.removeItem('externalBg');
            localStorage.removeItem('internalBg');
            applyDarkModeStyles();
        };

        solBtn.onclick = () => {
            document.body.classList.remove("dark-mode");
             // Remove cores customizadas ao ativar modo claro via botão
            localStorage.removeItem('externalBg');
            localStorage.removeItem('internalBg');
            applyLightModeStyles();
        };

         // Inicialização (carregar tema)
         function initializeTheme() {
             loadColorPreferences(); // Carrega cores customizadas ou padrão com imagem
             // Se não houver cores customizadas, verifica o dark mode salvo
             if (!localStorage.getItem('externalBg') && !localStorage.getItem('internalBg')) {
                 if (localStorage.getItem('darkMode') === 'enabled') {
                     document.body.classList.add('dark-mode');
                     applyDarkModeStyles(); // Garante aplicação correta do dark mode
                 }
             }
         }


        // ... (Restante das suas funções JavaScript existentes: criarFichaMatriz, carregarFichas, etc.) ...
         function carregarFicha(fichaId) {
            if (!fichas[fichaId]) return;
            const ficha = fichas[fichaId];

            // Carrega dados da ficha (omitido por brevidade, igual ao seu código original)
             nomePersonagemInput.value = ficha.nomePersonagem || "";
             // ... resto do carregamento ...

             // Atualiza exibição
             atualizarBotaoBloquear();
             atualizarVantagensDesvantagensPanel();
             atualizarRacasPanel();
             experiencia = parseInt(experienciaInput.value) || 0;
             atualizarNivel(); // Isso chama calcularAtributos()
             // Recalcula e atualiza Vida/Magia/Vigor após atributos
             vidaAtual = vidaTotal; // Ou carregar valor salvo se houver lógica para isso
             magiaAtual = magiaTotal;
             vigorAtual = vigorTotal;
             if(document.getElementById("vida-atual")) document.getElementById("vida-atual").textContent = vidaAtual;
             if(document.getElementById("magia-atual")) document.getElementById("magia-atual").textContent = magiaAtual;
             if(document.getElementById("vigor-atual")) document.getElementById("vigor-atual").textContent = vigorAtual.toFixed(1);
             if(pontosVantagemSpan) pontosVantagemSpan.textContent = getPontosVantagem();


             // Mantém o código de previousValues
             previousValues.clear();
             document.querySelectorAll('input[type="text"],input[type="number"],textarea').forEach(input => previousValues.set(input, input.value));

             // Carrega senha do chat
             chatPassword = ficha.chatPassword;
             atualizarEstadoChatBotao(); // Atualiza botão do chat
        }

        // ... (Todas as outras funções: calcularAtributos, salvarDados, resetarPontos, etc.) ...
         function calcularAtributos() {
            // ... (seu código de cálculo existente) ...

             // Certifique-se de que os totais são atualizados após o cálculo
             vidaTotal = Math.ceil(vidaBase);
             magiaTotal = Math.ceil(magiaBase);
             vigorTotal = parseFloat(vigorBase.toFixed(1));

            // Atualiza os spans dos totais na interface
             if(document.getElementById("vida-total")) document.getElementById("vida-total").textContent = vidaTotal;
             if(document.getElementById("magia-total")) document.getElementById("magia-total").textContent = magiaTotal;
             if(document.getElementById("vigor-total")) document.getElementById("vigor-total").textContent = vigorTotal.toFixed(1);

             // Atualiza os valores atuais se estiverem indefinidos ou excederem o novo total
             vidaAtual = (vidaAtual === undefined || vidaAtual > vidaTotal) ? vidaTotal : vidaAtual;
             magiaAtual = (magiaAtual === undefined || magiaAtual > magiaTotal) ? magiaTotal : magiaAtual;
             vigorAtual = (vigorAtual === undefined || vigorAtual > vigorTotal) ? vigorTotal : vigorAtual;

            // Atualiza os spans dos valores atuais na interface
             if(document.getElementById("vida-atual")) document.getElementById("vida-atual").textContent = vidaAtual;
             if(document.getElementById("magia-atual")) document.getElementById("magia-atual").textContent = magiaAtual;
             if(document.getElementById("vigor-atual")) document.getElementById("vigor-atual").textContent = vigorAtual.toFixed(1);


             // ... (restante da função calcularAtributos) ...
        }


        // Inicialização Geral
        initializeTheme(); // Carrega o tema (cores ou modo escuro/claro)
        carregarFichas(); // Carrega os dados das fichas do Firebase

        // --- Listener para garantir que a ficha é carregada após a estrutura ---
        document.addEventListener('DOMContentLoaded', (event) => {
            // Chama initializeTheme novamente ou funções específicas se necessário
             // Se carregarFichas for assíncrono e demorar, pode ser preciso
             // garantir que a primeira ficha seja carregada aqui ou dentro de carregarFichas.
             // Exemplo: Se currentFichaId for definido após carregarFichas:
             // database.ref("fichas").once("value", snapshot => { ... carregarFicha(currentFichaId); });
        });


    </script>
</body>

</html>
