<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ficha de Personagem RPG</title>
    <link href="https://fonts.googleapis.com/css2?family=MedievalSharp&family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@tailwindcss/browser@4"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0e6d2; /* Cor de pergaminho padrão */
            color: #000;
            display: flex;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            background-image: none;
            background-size: cover;
            background-position: center;
            background-attachment: fixed; /* Adicionado para fixar o fundo ao viewport */
            transition: background 0.3s, color 0.3s;
        }
        body.dark-mode {
            background-color: #121212 !important; /* Garante que o fundo seja sempre escuro */
            color: #e0e0e0;
        }
        body.dark-mode input,
        body.dark-mode textarea,
        body.dark-mode select,
        body.dark-mode .section {
            background-color: #2c2c2c;
            border-color: #444;
            color: #e0e0e0;
        }
        body.dark-mode .section {
            border: 1px solid #444;
        }
        body.dark-mode .add-button,
        body.dark-mode .remove-button,
        body.dark-mode button {
            background-color: #444;
            color: #e0e0e0;
        }
        body.dark-mode .add-button:hover,
        body.dark-mode .remove-button:hover,
        body.dark-mode button:hover {
            background-color: #555;
        }
        body.dark-mode .tab {
            background-color: #2c2c2c;
            border-color: #444;
        }
        body.dark-mode .tab.active {
            background-color: #444;
        }
        body.dark-mode #ficha-selector option {
            background-color: #2c2c2c;
            color: #e0e0e0;
        }
        body.dark-mode #background-color-selector {
            background-color: #2c2c2c;
            border-color: #444;
        }
        body.dark-mode .color-option {
             border: 1px solid #555;
        }
        body.dark-mode .color-option.active {
            border-color: #fff;
        }


        .container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .header-left {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        .header-right {
            display: flex;
            align-items: center;
            gap: 10px;
             position: relative; /* Needed for color picker positioning */
        }

        h1 {
            font-family: 'MedievalSharp', cursive;
            font-size: 2.5rem;
            margin: 0;
            flex-shrink: 0; /* Prevent title from shrinking too much */
        }
        .ficha-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-grow: 1; /* Allow controls to take available space */
            flex-wrap: wrap; /* Allow controls to wrap */
            justify-content: center; /* Center controls when wrapped */
        }

        #ficha-selector {
            padding: 8px 12px;
            border-radius: 5px;
            border: 1px solid #8B4513; /* Marrom */
            background-color: #fff;
            font-family: 'Inter', sans-serif;
        }

        button {
            padding: 8px 15px;
            border-radius: 5px;
            border: none;
            background-color: #8B4513; /* Marrom */
            color: white;
            cursor: pointer;
            font-family: 'Inter', sans-serif;
            transition: background-color 0.2s ease;
        }
        button:hover {
            background-color: #A0522D; /* Sienna */
        }
        button#theme-toggle,
        button#upload-bg-btn,
        button#remove-bg-btn,
        button#cor-fundo-btn {
            background: none;
            border: none;
            font-size: 1.5rem; /* Tamanho do ícone */
            cursor: pointer;
            color: inherit; /* Herda a cor do texto (útil para dark mode) */
            padding: 5px;
            line-height: 1; /* Ajusta a altura da linha para centralizar o ícone */
        }
        button#theme-toggle:hover,
        button#upload-bg-btn:hover,
        button#remove-bg-btn:hover,
        button#cor-fundo-btn:hover {
            opacity: 0.7;
        }
         #background-color-selector {
            position: absolute;
            top: 100%; /* Position below the button */
            right: 0;
            background-color: white;
            border: 1px solid #ccc;
            border-radius: 5px;
            padding: 10px;
            display: none; /* Hidden by default */
            flex-direction: column;
            gap: 5px;
            z-index: 10; /* Ensure it's above other content */
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .color-options-grid {
             display: grid;
             grid-template-columns: repeat(4, 1fr); /* 4 columns */
             gap: 5px;
         }
        .color-option {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            border: 1px solid #eee;
            transition: transform 0.1s ease, border-color 0.1s ease;
        }
         .color-option:hover {
             transform: scale(1.1);
         }
         .color-option.active {
            border: 3px solid #555; /* Highlight selected color */
            transform: scale(1.1);
         }


        input[type="text"], input[type="number"], select, textarea {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
            background-color: #fff; /* Fundo branco padrão */
            color: #000; /* Texto preto padrão */
            transition: background-color 0.3s, border-color 0.3s, color 0.3s;
        }
        textarea {
            resize: vertical;
            min-height: 80px;
        }

        .tabs {
            display: flex;
            margin-bottom: 15px;
            flex-wrap: wrap; /* Allow tabs to wrap on smaller screens */
        }
        .tab {
            padding: 10px 15px;
            cursor: pointer;
            border: 1px solid #ccc;
            border-bottom: none;
            border-radius: 5px 5px 0 0;
            background-color: #e0e0e0;
            margin-right: 5px;
            margin-bottom: -1px; /* Overlap border */
            transition: background-color 0.2s ease;
            font-weight: 600; /* Make tab text bolder */
        }
        .tab.active {
            background-color: #f0e6d2; /* Match body background */
            border-bottom: 1px solid #f0e6d2;
        }
        body.dark-mode .tab.active {
             background-color: #2c2c2c; /* Match dark mode section background */
             border-bottom: 1px solid #2c2c2c;
             border-color: #444;
         }

        .tab-content {
            display: none;
            padding: 20px;
            border: 1px solid #ccc;
            border-radius: 0 5px 5px 5px;
            background-color: rgba(255, 255, 255, 0.8); /* Slightly transparent white */
            margin-top: -1px; /* Connect with tabs */
        }
        .tab-content.active {
            display: block;
        }
        body.dark-mode .tab-content {
             background-color: rgba(44, 44, 44, 0.9); /* Darker transparent background */
             border-color: #444;
         }

        .grid-container {
            display: grid;
            gap: 15px;
        }
        .grid-cols-2 { grid-template-columns: repeat(2, 1fr); }
        .grid-cols-3 { grid-template-columns: repeat(3, 1fr); }
        .grid-cols-4 { grid-template-columns: repeat(4, 1fr); }
        .grid-cols-6 { grid-template-columns: repeat(6, 1fr); }
        .col-span-full { grid-column: 1 / -1; }

        .section {
            background-color: rgba(255, 255, 255, 0.6); /* More transparent white for inner sections */
            padding: 15px;
            border-radius: 5px;
            border: 1px solid #ddd; /* Lighter border */
            transition: background-color 0.3s, border-color 0.3s;
        }
        h3 {
            font-family: 'MedievalSharp', cursive;
            font-size: 1.5rem;
            margin-top: 0;
            margin-bottom: 10px;
            border-bottom: 1px solid #8B4513;
            padding-bottom: 5px;
        }
        body.dark-mode h3 {
             border-bottom-color: #aaa;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .list-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            gap: 10px;
        }
        .list-item input[type="text"] {
            flex-grow: 1;
            margin-bottom: 0; /* Remove default margin */
        }
        .add-button, .remove-button {
            padding: 5px 10px;
            font-size: 0.9rem;
            line-height: 1;
             flex-shrink: 0; /* Prevent buttons from shrinking */
        }

        /* Responsive adjustments */
        @media (max-width: 1024px) {
            .grid-cols-6 { grid-template-columns: repeat(3, 1fr); }
            .grid-cols-4 { grid-template-columns: repeat(2, 1fr); }
        }
        @media (max-width: 768px) {
            h1 { font-size: 2rem; }
            .header { flex-direction: column; align-items: flex-start; gap: 15px; }
            .header-left, .header-right { width: 100%; justify-content: space-between;} /* Space out elements */
            .ficha-controls { justify-content: flex-start; gap: 5px;} /* Align controls left */
            .tabs { margin-bottom: 10px; }
            .tab { padding: 8px 12px; font-size: 0.9rem; margin-right: 3px;}
            .grid-cols-2, .grid-cols-3, .grid-cols-4, .grid-cols-6 { grid-template-columns: 1fr; }
            .tab-content { padding: 15px; }
             button { padding: 6px 12px; font-size: 0.9rem;}
             #ficha-selector { padding: 6px 10px;}
             #background-color-selector {
                 position: fixed; /* Make it fixed for better mobile view */
                 bottom: 10px;
                 left: 10px;
                 right: 10px;
                 top: auto; /* Reset top positioning */
                 width: auto; /* Adjust width */
             }

        }
         @media (max-width: 480px) {
             h1 { font-size: 1.8rem; }
             body { padding: 10px; }
              .header-right { gap: 5px; } /* Reduce gap for icons */
             button#theme-toggle,
             button#upload-bg-btn,
             button#remove-bg-btn,
             button#cor-fundo-btn {
                 font-size: 1.3rem;
                 padding: 3px;
             }
             .color-options-grid { grid-template-columns: repeat(5, 1fr); } /* More colors per row */
             .color-option { width: 25px; height: 25px; }
         }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
             <div class="header-left">
                <h1 id="sheet-title">Ficha de Personagem</h1>
                 <div class="ficha-controls">
                     <select id="ficha-selector" title="Selecionar Ficha"></select>
                     <button id="nova-ficha-btn" title="Criar Nova Ficha">+</button>
                     <button id="renomear-ficha-btn" title="Renomear Ficha Atual">✏️</button>
                     <button id="duplicar-ficha-btn" title="Duplicar Ficha Atual">📄</button>
                     <button id="deletar-ficha-btn" title="Deletar Ficha Atual">🗑️</button>
                 </div>
             </div>
            <div class="header-right">
                <button id="upload-bg-btn" title="Carregar Imagem de Fundo">🖼️</button>
                <input type="file" id="bg-upload" accept="image/*" style="display: none;">
                <button id="remove-bg-btn" title="Remover Imagem de Fundo">🚫</button>
                 <button id="cor-fundo-btn" title="Selecionar Cor de Fundo">🎨</button>
                 <div id="background-color-selector">
                     <p style="margin: 0 0 5px 0; text-align: center; font-weight: bold;">Cor de Fundo</p>
                     <div class="color-options-grid">
                         <div class="color-option" data-color="#f0e6d2" style="background-color: #f0e6d2;" title="Pergaminho Padrão"></div>
                         <div class="color-option" data-color="#ffffff" style="background-color: #ffffff;" title="Branco"></div>
                         <div class="color-option" data-color="#f5f5f5" style="background-color: #f5f5f5;" title="Branco Suave"></div>
                         <div class="color-option" data-color="#e0e0e0" style="background-color: #e0e0e0;" title="Cinza Claro"></div>
                         <div class="color-option" data-color="#bdbdbd" style="background-color: #bdbdbd;" title="Cinza Médio"></div>
                         <div class="color-option" data-color="#9e9e9e" style="background-color: #9e9e9e;" title="Cinza"></div>
                         <div class="color-option" data-color="#757575" style="background-color: #757575;" title="Cinza Escuro"></div>
                         <div class="color-option" data-color="#424242" style="background-color: #424242;" title="Cinza Muito Escuro"></div>
                         <div class="color-option" data-color="#212121" style="background-color: #212121;" title="Quase Preto"></div>
                         <div class="color-option" data-color="#121212" style="background-color: #121212;" title="Preto (Modo Escuro)"></div>
                         <div class="color-option" data-color="#efebe9" style="background-color: #efebe9;" title="Marrom Muito Claro"></div>
                         <div class="color-option" data-color="#d7ccc8" style="background-color: #d7ccc8;" title="Marrom Claro"></div>
                         <div class="color-option" data-color="#bcaaa4" style="background-color: #bcaaa4;" title="Marrom Médio"></div>
                         <div class="color-option" data-color="#a1887f" style="background-color: #a1887f;" title="Marrom"></div>
                         <div class="color-option" data-color="#8d6e63" style="background-color: #8d6e63;" title="Marrom Escuro"></div>
                         <div class="color-option" data-color="#6d4c41" style="background-color: #6d4c41;" title="Marrom Café"></div>
                         <div class="color-option" data-color="#4e342e" style="background-color: #4e342e;" title="Marrom Muito Escuro"></div>
                         <div class="color-option" data-color="#ffe0b2" style="background-color: #ffe0b2;" title="Pêssego Claro"></div>
                         <div class="color-option" data-color="#ffcc80" style="background-color: #ffcc80;" title="Laranja Claro"></div>
                          <div class="color-option" data-color="#ffb74d" style="background-color: #ffb74d;" title="Laranja"></div>
                          <div class="color-option" data-color="#c8e6c9" style="background-color: #c8e6c9;" title="Verde Claro"></div>
                          <div class="color-option" data-color="#81c784" style="background-color: #81c784;" title="Verde Médio"></div>
                          <div class="color-option" data-color="#4caf50" style="background-color: #4caf50;" title="Verde"></div>
                           <div class="color-option" data-color="#388e3c" style="background-color: #388e3c;" title="Verde Escuro"></div>
                           <div class="color-option" data-color="#bbdefb" style="background-color: #bbdefb;" title="Azul Claro"></div>
                           <div class="color-option" data-color="#64b5f6" style="background-color: #64b5f6;" title="Azul Médio"></div>
                           <div class="color-option" data-color="#2196f3" style="background-color: #2196f3;" title="Azul"></div>
                           <div class="color-option" data-color="#1976d2" style="background-color: #1976d2;" title="Azul Escuro"></div>
                          <div class="color-option" data-color="#e1bee7" style="background-color: #e1bee7;" title="Roxo Claro"></div>
                          <div class="color-option" data-color="#ba68c8" style="background-color: #ba68c8;" title="Roxo Médio"></div>
                          <div class="color-option" data-color="#9c27b0" style="background-color: #9c27b0;" title="Roxo"></div>
                           <div class="color-option" data-color="#7b1fa2" style="background-color: #7b1fa2;" title="Roxo Escuro"></div>
                           <div class="color-option" data-color="#ffcdd2" style="background-color: #ffcdd2;" title="Vermelho Claro"></div>
                           <div class="color-option" data-color="#ef9a9a" style="background-color: #ef9a9a;" title="Vermelho Médio"></div>
                           <div class="color-option" data-color="#f44336" style="background-color: #f44336;" title="Vermelho"></div>
                            <div class="color-option" data-color="#d32f2f" style="background-color: #d32f2f;" title="Vermelho Escuro"></div>

                     </div>
                 </div>
                <button id="theme-toggle" title="Alternar Tema Claro/Escuro">☀️</button> </div>
        </div>

        <div class="tabs">
            <div class="tab active" data-tab="principal">Principal</div>
            <div class="tab" data-tab="atributos">Atributos & Perícias</div>
            <div class="tab" data-tab="combate">Combate</div>
            <div class="tab" data-tab="inventario">Inventário</div>
            <div class="tab" data-tab="magias">Magias & Habilidades</div>
            <div class="tab" data-tab="historia">História & Notas</div>
        </div>

        <form id="ficha-form">
            <div id="principal" class="tab-content active">
                <div class="grid-container grid-cols-3">
                    <div class="section col-span-1">
                        <label for="nome">Nome do Personagem:</label>
                        <input type="text" id="nome" name="nome" data-save="true">
                    </div>
                    <div class="section col-span-1">
                        <label for="raca">Raça:</label>
                        <input type="text" id="raca" name="raca" data-save="true">
                    </div>
                    <div class="section col-span-1">
                        <label for="classe">Classe:</label>
                        <input type="text" id="classe" name="classe" data-save="true">
                    </div>
                    <div class="section col-span-1">
                        <label for="nivel">Nível:</label>
                        <input type="number" id="nivel" name="nivel" min="1" value="1" data-save="true">
                    </div>
                    <div class="section col-span-1">
                        <label for="antecedente">Antecedente:</label>
                        <input type="text" id="antecedente" name="antecedente" data-save="true">
                    </div>
                    <div class="section col-span-1">
                        <label for="tendencia">Tendência:</label>
                        <input type="text" id="tendencia" name="tendencia" data-save="true">
                    </div>
                    <div class="section col-span-1">
                        <label for="xp">Pontos de Experiência:</label>
                        <input type="number" id="xp" name="xp" min="0" value="0" data-save="true">
                    </div>
                     <div class="section col-span-2">
                        <label for="inspiracao">Inspiração:</label>
                        <input type="text" id="inspiracao" name="inspiracao" data-save="true">
                    </div>

                    <div class="section col-span-full">
                         <h3>Aparência</h3>
                        <textarea id="aparencia" name="aparencia" rows="4" placeholder="Descreva a aparência do seu personagem..." data-save="true"></textarea>
                    </div>
                </div>
            </div>

            <div id="atributos" class="tab-content">
                <div class="grid-container grid-cols-4">
                    <div class="section col-span-1">
                        <h3>Atributos</h3>
                        <div>
                            <label for="forca">Força:</label>
                            <input type="number" id="forca" name="forca" class="atributo" data-save="true">
                            <input type="text" id="mod_forca" name="mod_forca" readonly placeholder="Mod">
                        </div>
                        <div>
                            <label for="destreza">Destreza:</label>
                            <input type="number" id="destreza" name="destreza" class="atributo" data-save="true">
                             <input type="text" id="mod_destreza" name="mod_destreza" readonly placeholder="Mod">
                        </div>
                        <div>
                            <label for="constituicao">Constituição:</label>
                            <input type="number" id="constituicao" name="constituicao" class="atributo" data-save="true">
                             <input type="text" id="mod_constituicao" name="mod_constituicao" readonly placeholder="Mod">
                        </div>
                        <div>
                            <label for="inteligencia">Inteligência:</label>
                            <input type="number" id="inteligencia" name="inteligencia" class="atributo" data-save="true">
                             <input type="text" id="mod_inteligencia" name="mod_inteligencia" readonly placeholder="Mod">
                        </div>
                        <div>
                            <label for="sabedoria">Sabedoria:</label>
                            <input type="number" id="sabedoria" name="sabedoria" class="atributo" data-save="true">
                             <input type="text" id="mod_sabedoria" name="mod_sabedoria" readonly placeholder="Mod">
                        </div>
                        <div>
                            <label for="carisma">Carisma:</label>
                            <input type="number" id="carisma" name="carisma" class="atributo" data-save="true">
                             <input type="text" id="mod_carisma" name="mod_carisma" readonly placeholder="Mod">
                        </div>
                         <div>
                            <label for="bonus_proficiencia">Bônus de Proficiência:</label>
                            <input type="text" id="bonus_proficiencia" name="bonus_proficiencia" readonly placeholder="+X">
                        </div>
                    </div>

                    <div class="section col-span-2">
                        <h3>Perícias</h3>
                        <div id="pericias-list" class="grid-container grid-cols-2">
                            </div>
                    </div>

                     <div class="section col-span-1">
                        <h3>Salvaguardas</h3>
                         <div id="salvaguardas-list">
                             </div>

                         <h3 style="margin-top: 20px;">Outras Proficiências & Idiomas</h3>
                        <textarea id="outras_proficiencias" name="outras_proficiencias" rows="8" placeholder="Armas, armaduras, ferramentas, idiomas..." data-save="true"></textarea>
                    </div>
                </div>
            </div>

            <div id="combate" class="tab-content">
                <div class="grid-container grid-cols-3">
                    <div class="section">
                        <label for="ca">Classe de Armadura (CA):</label>
                        <input type="number" id="ca" name="ca" data-save="true">
                    </div>
                     <div class="section">
                        <label for="iniciativa">Iniciativa:</label>
                        <input type="text" id="iniciativa" name="iniciativa" readonly placeholder="+X">
                    </div>
                     <div class="section">
                        <label for="deslocamento">Deslocamento:</label>
                        <input type="text" id="deslocamento" name="deslocamento" data-save="true">
                    </div>

                    <div class="section col-span-1">
                         <h3>Pontos de Vida</h3>
                        <label for="pv_maximos">PV Máximos:</label>
                        <input type="number" id="pv_maximos" name="pv_maximos" data-save="true">
                        <label for="pv_atuais">PV Atuais:</label>
                        <input type="number" id="pv_atuais" name="pv_atuais" data-save="true">
                        <label for="pv_temporarios">PV Temporários:</label>
                        <input type="number" id="pv_temporarios" name="pv_temporarios" data-save="true">
                    </div>

                     <div class="section col-span-1">
                         <h3>Dados de Vida</h3>
                        <label for="dados_vida_total">Total:</label>
                        <input type="text" id="dados_vida_total" name="dados_vida_total" placeholder="Ex: 5d10" data-save="true">
                        <label for="dados_vida_restantes">Restantes:</label>
                         <input type="text" id="dados_vida_restantes" name="dados_vida_restantes" data-save="true"> </div>

                     <div class="section col-span-1">
                         <h3>Testes Contra Morte</h3>
                         <label>Sucessos:</label>
                         <div>
                             <input type="checkbox" id="morte_s1" name="morte_s1" data-save="true">
                             <input type="checkbox" id="morte_s2" name="morte_s2" data-save="true">
                             <input type="checkbox" id="morte_s3" name="morte_s3" data-save="true">
                         </div>
                         <label>Falhas:</label>
                         <div>
                             <input type="checkbox" id="morte_f1" name="morte_f1" data-save="true">
                             <input type="checkbox" id="morte_f2" name="morte_f2" data-save="true">
                             <input type="checkbox" id="morte_f3" name="morte_f3" data-save="true">
                         </div>
                     </div>

                    <div class="section col-span-full">
                        <h3>Ataques & Conjuração</h3>
                        <div id="ataques-list">
                            <div class="grid-container grid-cols-4" style="font-weight: bold; margin-bottom: 5px;">
                                <span>Nome</span>
                                <span>Bônus de Ataque</span>
                                <span>Dano / Tipo</span>
                                <span>Ações</span>
                             </div>
                            </div>
                        <button type="button" class="add-button" data-list="ataques-list" data-template="ataque-template">Adicionar Ataque</button>
                    </div>

                     <div class="section col-span-full">
                        <h3>Equipamento de Combate</h3>
                         <textarea id="equip_combate" name="equip_combate" rows="4" placeholder="Armadura vestida, escudo, itens empunhados..." data-save="true"></textarea>
                    </div>
                </div>
            </div>

            <div id="inventario" class="tab-content">
                 <div class="grid-container grid-cols-3">
                     <div class="section col-span-1">
                         <h3>Moedas</h3>
                        <label for="moedas_pc">PC (Peças de Cobre):</label>
                        <input type="number" id="moedas_pc" name="moedas_pc" min="0" value="0" data-save="true">
                        <label for="moedas_pp">PP (Peças de Prata):</label>
                        <input type="number" id="moedas_pp" name="moedas_pp" min="0" value="0" data-save="true">
                         <label for="moedas_pe">PE (Peças de Electro):</label>
                        <input type="number" id="moedas_pe" name="moedas_pe" min="0" value="0" data-save="true">
                        <label for="moedas_po">PO (Peças de Ouro):</label>
                        <input type="number" id="moedas_po" name="moedas_po" min="0" value="0" data-save="true">
                        <label for="moedas_pl">PL (Peças de Platina):</label>
                        <input type="number" id="moedas_pl" name="moedas_pl" min="0" value="0" data-save="true">
                     </div>
                     <div class="section col-span-2">
                        <h3>Equipamentos & Itens</h3>
                        <textarea id="equipamentos_itens" name="equipamentos_itens" rows="10" placeholder="Mochila, corda, tochas, rações, itens mágicos, etc..." data-save="true"></textarea>
                    </div>
                      <div class="section col-span-full">
                        <h3>Tesouros</h3>
                        <textarea id="tesouros" name="tesouros" rows="5" placeholder="Gemas, obras de arte, itens valiosos..." data-save="true"></textarea>
                    </div>
                 </div>
            </div>

            <div id="magias" class="tab-content">
                 <div class="grid-container grid-cols-3">
                     <div class="section col-span-1">
                        <label for="classe_conjuradora">Classe Conjuradora:</label>
                        <input type="text" id="classe_conjuradora" name="classe_conjuradora" data-save="true">
                         <label for="atributo_conjuracao">Atributo Chave:</label>
                        <input type="text" id="atributo_conjuracao" name="atributo_conjuracao" data-save="true">
                         <label for="cd_magia">CD da Magia:</label>
                        <input type="text" id="cd_magia" name="cd_magia" readonly>
                        <label for="bonus_ataque_magia">Bônus de Ataque Mágico:</label>
                        <input type="text" id="bonus_ataque_magia" name="bonus_ataque_magia" readonly>
                    </div>
                    <div class="section col-span-2">
                         <h3>Habilidades & Talentos</h3>
                         <textarea id="habilidades_talentos" name="habilidades_talentos" rows="8" placeholder="Características de classe, raça, talentos..." data-save="true"></textarea>
                    </div>
                 </div>

                  <div class="grid-container grid-cols-1" style="margin-top: 15px;">
                     <div class="section">
                         <h3>Espaços de Magia</h3>
                         <div class="grid-container grid-cols-5"> <div><label>Truques</label><input type="text" id="magias_nivel_0" name="magias_nivel_0" readonly placeholder="Ilimitado"></div>
                             <div><label>Nível 1</label><input type="number" id="espacos_nivel_1_total" name="espacos_nivel_1_total" placeholder="Total" min="0" data-save="true"><input type="number" id="espacos_nivel_1_usados" name="espacos_nivel_1_usados" placeholder="Usados" min="0" data-save="true"></div>
                             <div><label>Nível 2</label><input type="number" id="espacos_nivel_2_total" name="espacos_nivel_2_total" placeholder="Total" min="0" data-save="true"><input type="number" id="espacos_nivel_2_usados" name="espacos_nivel_2_usados" placeholder="Usados" min="0" data-save="true"></div>
                              <div><label>Nível 3</label><input type="number" id="espacos_nivel_3_total" name="espacos_nivel_3_total" placeholder="Total" min="0" data-save="true"><input type="number" id="espacos_nivel_3_usados" name="espacos_nivel_3_usados" placeholder="Usados" min="0" data-save="true"></div>
                              <div><label>Nível 4</label><input type="number" id="espacos_nivel_4_total" name="espacos_nivel_4_total" placeholder="Total" min="0" data-save="true"><input type="number" id="espacos_nivel_4_usados" name="espacos_nivel_4_usados" placeholder="Usados" min="0" data-save="true"></div>
                              <div><label>Nível 5</label><input type="number" id="espacos_nivel_5_total" name="espacos_nivel_5_total" placeholder="Total" min="0" data-save="true"><input type="number" id="espacos_nivel_5_usados" name="espacos_nivel_5_usados" placeholder="Usados" min="0" data-save="true"></div>
                              <div><label>Nível 6</label><input type="number" id="espacos_nivel_6_total" name="espacos_nivel_6_total" placeholder="Total" min="0" data-save="true"><input type="number" id="espacos_nivel_6_usados" name="espacos_nivel_6_usados" placeholder="Usados" min="0" data-save="true"></div>
                              <div><label>Nível 7</label><input type="number" id="espacos_nivel_7_total" name="espacos_nivel_7_total" placeholder="Total" min="0" data-save="true"><input type="number" id="espacos_nivel_7_usados" name="espacos_nivel_7_usados" placeholder="Usados" min="0" data-save="true"></div>
                              <div><label>Nível 8</label><input type="number" id="espacos_nivel_8_total" name="espacos_nivel_8_total" placeholder="Total" min="0" data-save="true"><input type="number" id="espacos_nivel_8_usados" name="espacos_nivel_8_usados" placeholder="Usados" min="0" data-save="true"></div>
                              <div><label>Nível 9</label><input type="number" id="espacos_nivel_9_total" name="espacos_nivel_9_total" placeholder="Total" min="0" data-save="true"><input type="number" id="espacos_nivel_9_usados" name="espacos_nivel_9_usados" placeholder="Usados" min="0" data-save="true"></div>
                         </div>
                     </div>

                    <div class="section">
                        <h3>Magias Conhecidas/Preparadas</h3>
                         <textarea id="magias_conhecidas" name="magias_conhecidas" rows="15" placeholder="Liste as magias por nível, indicando as preparadas se aplicável..." data-save="true"></textarea>
                    </div>
                 </div>
            </div>

            <div id="historia" class="tab-content">
                <div class="grid-container grid-cols-2">
                     <div class="section col-span-1">
                         <h3>Personalidade</h3>
                        <textarea id="personalidade" name="personalidade" rows="5" placeholder="Traços de personalidade..." data-save="true"></textarea>
                    </div>
                    <div class="section col-span-1">
                         <h3>Ideais</h3>
                        <textarea id="ideais" name="ideais" rows="5" placeholder="O que o personagem busca?" data-save="true"></textarea>
                    </div>
                    <div class="section col-span-1">
                         <h3>Vínculos</h3>
                        <textarea id="vinculos" name="vinculos" rows="5" placeholder="Conexões importantes (pessoas, lugares, objetos)..." data-save="true"></textarea>
                    </div>
                     <div class="section col-span-1">
                         <h3>Defeitos</h3>
                        <textarea id="defeitos" name="defeitos" rows="5" placeholder="Fraquezas e falhas..." data-save="true"></textarea>
                    </div>
                    <div class="section col-span-full">
                         <h3>História do Personagem</h3>
                        <textarea id="historia_personagem" name="historia_personagem" rows="10" placeholder="O passado do seu personagem..." data-save="true"></textarea>
                    </div>
                    <div class="section col-span-full">
                         <h3>Aliados & Organizações</h3>
                        <textarea id="aliados_organizacoes" name="aliados_organizacoes" rows="6" placeholder="Grupos, facções, NPCs amigos..." data-save="true"></textarea>
                    </div>
                    <div class="section col-span-full">
                         <h3>Notas Adicionais</h3>
                        <textarea id="notas_adicionais" name="notas_adicionais" rows="8" placeholder="Anotações gerais da campanha, lembretes..." data-save="true"></textarea>
                    </div>
                </div>
            </div>
        </form>
    </div>

    <template id="ataque-template">
         <div class="list-item grid-container grid-cols-4">
             <input type="text" name="ataque_nome[]" placeholder="Nome" data-save="true">
             <input type="text" name="ataque_bonus[]" placeholder="+X" data-save="true">
             <input type="text" name="ataque_dano[]" placeholder="Dano / Tipo" data-save="true">
            <button type="button" class="remove-button">Remover</button>
         </div>
    </template>

    <script>
        // --- Firebase Configuration ---
        // Substitua com suas credenciais do Firebase
        const firebaseConfig = {
            apiKey: "SUA_API_KEY",
            authDomain: "SEU_AUTH_DOMAIN",
            databaseURL: "SEU_DATABASE_URL",
            projectId: "SEU_PROJECT_ID",
            storageBucket: "SEU_STORAGE_BUCKET",
            messagingSenderId: "SEU_MESSAGING_SENDER_ID",
            appId: "SEU_APP_ID"
        };

        // Initialize Firebase
        try {
            firebase.initializeApp(firebaseConfig);
            const database = firebase.database();
            console.log("Firebase inicializado com sucesso.");
            // Habilitar/Desabilitar controles online com base na inicialização
             habilitarControlesOnline(true);
        } catch (error) {
            console.error("Erro ao inicializar o Firebase:", error);
            alert("Não foi possível conectar ao Firebase. O salvamento online está desativado. Verifique a configuração e sua conexão.");
            // Desabilitar controles online
            habilitarControlesOnline(false);
        }

        function habilitarControlesOnline(habilitar) {
             // Por enquanto, não há botões específicos para desabilitar,
             // mas esta função pode ser usada no futuro se necessário.
             // Ex: document.getElementById('save-online-btn').disabled = !habilitar;
             console.log("Controles Online:", habilitar ? "Habilitados" : "Desabilitados");
         }

        // --- DOM Elements ---
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');
        const form = document.getElementById('ficha-form');
        const fichaSelector = document.getElementById('ficha-selector');
        const novaFichaBtn = document.getElementById('nova-ficha-btn');
        const renomearFichaBtn = document.getElementById('renomear-ficha-btn');
        const duplicarFichaBtn = document.getElementById('duplicar-ficha-btn');
        const deletarFichaBtn = document.getElementById('deletar-ficha-btn');
        const sheetTitle = document.getElementById('sheet-title');
        const themeToggleBtn = document.getElementById('theme-toggle');
        const bgUploadBtn = document.getElementById('upload-bg-btn');
        const bgUploadInput = document.getElementById('bg-upload');
        const removeBgBtn = document.getElementById('remove-bg-btn');
        const corFundoBtn = document.getElementById('cor-fundo-btn');
        const backgroundColorSelector = document.getElementById('background-color-selector');


        // --- State ---
        let fichas = {}; // Armazena todas as fichas carregadas
        let currentFichaId = null;
        const localStorageKey = 'rpg_fichas_local';
        const defaultFichaIdPrefix = 'ficha_';

         // --- Constants ---
        const ATRIBUTOS = ['forca', 'destreza', 'constituicao', 'inteligencia', 'sabedoria', 'carisma'];
        const PERICIAS = {
            'Acrobacia': 'destreza', 'Arcanismo': 'inteligencia', 'Atletismo': 'forca',
            'Atuação': 'carisma', 'Enganação': 'carisma', 'Furtividade': 'destreza',
            'História': 'inteligencia', 'Intimidação': 'carisma', 'Intuição': 'sabedoria',
            'Investigação': 'inteligencia', 'Lidar com Animais': 'sabedoria', 'Medicina': 'sabedoria',
            'Natureza': 'inteligencia', 'Percepção': 'sabedoria', 'Persuasão': 'carisma',
            'Prestidigitação': 'destreza', 'Religião': 'inteligencia', 'Sobrevivência': 'sabedoria'
        };

        // --- Initialization ---
        function initializeUI() {
            gerarCamposPericiasESalvaguardas();
            setupEventListeners();
            loadThemePreference(); // Carrega tema antes de carregar fichas
            carregarFichas(); // Carrega fichas do localStorage ou cria uma nova
            updateUIForCurrentFicha(); // Atualiza a UI com a ficha atual (ou vazia)
        }

         // --- Core Functions ---

         function getFichaDataFromForm() {
            const data = {};
            const inputs = form.querySelectorAll('[data-save="true"]');
            inputs.forEach(input => {
                const name = input.name || input.id; // Use name first, fallback to id
                 if (!name) return; // Skip inputs without name/id

                 // Handle checkboxes
                if (input.type === 'checkbox') {
                    data[name] = input.checked;
                }
                // Handle dynamic lists (like attacks)
                else if (name.endsWith('[]')) {
                    const key = name.slice(0, -2); // Remove '[]'
                    if (!data[key]) {
                        data[key] = [];
                    }
                    // Find the parent list-item to group related fields
                    const listItem = input.closest('.list-item');
                    if (listItem) {
                        const itemIndex = Array.from(listItem.parentNode.children).indexOf(listItem) -1; // Adjust for header/template
                        if (!data[key][itemIndex]) {
                             data[key][itemIndex] = {};
                         }
                        // Store the value within the item object using the specific input name
                        const inputNameWithoutArray = input.name.replace('[]', ''); // e.g., ataque_nome
                         data[key][itemIndex][inputNameWithoutArray] = input.value;
                    }
                }
                // Handle regular inputs
                else {
                    data[name] = input.value;
                }
            });

            // Clean up dynamic list data (remove empty slots if any were skipped)
            Object.keys(data).forEach(key => {
                 if (Array.isArray(data[key])) {
                     data[key] = data[key].filter(item => item !== null && item !== undefined); // Remove potential empty slots
                 }
             });


             // Save background settings
             data.backgroundImage = document.body.style.backgroundImage || 'none';
             data.backgroundColor = document.body.style.backgroundColor || '#f0e6d2';


            return data;
        }

        function populateFormWithFichaData(fichaId) {
            form.reset(); // Clear the form first
            // Reset dynamic lists
            document.getElementById('ataques-list').innerHTML = `
                 <div class="grid-container grid-cols-4" style="font-weight: bold; margin-bottom: 5px;">
                     <span>Nome</span>
                     <span>Bônus de Ataque</span>
                     <span>Dano / Tipo</span>
                    <span>Ações</span>
                 </div>`; // Reset attacks list with header

            const data = fichas[fichaId];
            if (!data) return; // No data for this ficha

            const inputs = form.querySelectorAll('[data-save="true"]');
            inputs.forEach(input => {
                const name = input.name || input.id;
                if (!name) return;

                if (name.endsWith('[]')) {
                     // Skip dynamic list fields here, they are handled below
                     return;
                 }

                if (data.hasOwnProperty(name)) {
                    if (input.type === 'checkbox') {
                        input.checked = data[name];
                    } else {
                        input.value = data[name];
                    }
                    // Trigger change event for calculated fields
                    if (input.classList.contains('atributo') || input.id === 'nivel') {
                        input.dispatchEvent(new Event('input'));
                    }
                 } else {
                     // Clear field if data doesn't exist for it
                     if (input.type === 'checkbox') {
                         input.checked = false;
                     } else {
                         input.value = '';
                         // Set defaults for numbers if needed
                         if (input.type === 'number') {
                              if (input.id === 'nivel') input.value = 1;
                             else if (input.id === 'xp' || input.id.startsWith('moedas_')) input.value = 0;
                          }
                     }
                 }
            });

             // Populate dynamic lists
             populateList('ataques-list', data.ataque || [], 'ataque-template'); // 'ataque' matches the key in getFichaDataFromForm

              // Apply background settings
              if (data.backgroundImage && data.backgroundImage !== 'none') {
                  document.body.style.backgroundImage = data.backgroundImage;
              } else {
                   document.body.style.backgroundImage = 'none';
                   // Apply background color only if no image
                  aplicarCorDeFundo(data.backgroundColor || '#f0e6d2'); // Apply saved or default color
              }
             if (!data.backgroundImage || data.backgroundImage === 'none'){
                 aplicarCorDeFundo(data.backgroundColor || '#f0e6d2');
             }

            calcularCamposDerivados(); // Recalculate all derived fields
             updateSheetTitle(data.nome || `Ficha ${fichaId.replace(defaultFichaIdPrefix, '')}`);
             aplicarCorDeFundoInicial(); // Ensure correct color swatch is active
        }


        function salvarDados() {
            if (!currentFichaId) return; // Don't save if no ficha is selected

             const fichaData = getFichaDataFromForm();
             fichas[currentFichaId] = fichaData;

            // Save to localStorage
            try {
                 localStorage.setItem(localStorageKey, JSON.stringify(fichas));
                 console.log(`Ficha ${currentFichaId} salva localmente.`);
             } catch (e) {
                 console.error("Erro ao salvar no localStorage:", e);
                 alert("Erro ao salvar ficha localmente. Verifique o espaço disponível.");
             }

             // Attempt to save to Firebase (if initialized)
            if (typeof database !== 'undefined' && database !== null) {
                database.ref('fichas/' + currentFichaId).set(fichaData)
                    .then(() => console.log(`Ficha ${currentFichaId} salva no Firebase.`))
                    .catch((error) => {
                         console.error(`Erro ao salvar ${currentFichaId} no Firebase:`, error);
                         // alert(`Erro ao salvar ficha ${currentFichaId} online.`); // Optional user feedback
                    });
            }

             // Update ficha name in selector if it changed
            const currentOption = fichaSelector.querySelector(`option[value="${currentFichaId}"]`);
             if (currentOption && currentOption.text !== (fichaData.nome || `Ficha ${currentFichaId.replace(defaultFichaIdPrefix, '')}`)) {
                 currentOption.text = fichaData.nome || `Ficha ${currentFichaId.replace(defaultFichaIdPrefix, '')}`;
             }
             // Update page title as well
             updateSheetTitle(fichaData.nome || `Ficha ${currentFichaId.replace(defaultFichaIdPrefix, '')}`);
        }

        function carregarFichas() {
            // 1. Load from LocalStorage
            const localData = localStorage.getItem(localStorageKey);
            if (localData) {
                try {
                    fichas = JSON.parse(localData);
                    console.log("Fichas carregadas do localStorage:", Object.keys(fichas).length);
                } catch (e) {
                    console.error("Erro ao carregar dados do localStorage:", e);
                    fichas = {}; // Reset if corrupted
                }
            } else {
                fichas = {};
                 console.log("Nenhuma ficha encontrada no localStorage.");
            }

             // 2. Attempt to load from Firebase (and merge/overwrite local)
            if (typeof database !== 'undefined' && database !== null) {
                 database.ref('fichas').once('value')
                    .then((snapshot) => {
                        const firebaseData = snapshot.val();
                        if (firebaseData) {
                             console.log("Fichas carregadas do Firebase:", Object.keys(firebaseData).length);
                            // Merge Firebase data into local data
                             // Firebase data takes precedence if IDs conflict
                            fichas = { ...fichas, ...firebaseData };
                            // Save the potentially merged data back to localStorage
                             try {
                                localStorage.setItem(localStorageKey, JSON.stringify(fichas));
                                console.log("Fichas do Firebase mescladas e salvas localmente.");
                             } catch (e) {
                                console.error("Erro ao salvar dados mesclados do Firebase no localStorage:", e);
                             }
                        } else {
                             console.log("Nenhuma ficha encontrada no Firebase.");
                        }
                         // Always repopulate selector and UI after attempting Firebase load
                         atualizarSeletorFichas();
                         updateUIForCurrentFicha();
                     })
                     .catch((error) => {
                         console.error("Erro ao carregar fichas do Firebase:", error);
                         // If Firebase fails, still proceed with local data
                         atualizarSeletorFichas();
                         updateUIForCurrentFicha();
                     });
            } else {
                 // If Firebase isn't initialized, just use local data
                 atualizarSeletorFichas();
                updateUIForCurrentFicha();
            }
        }


         function criarNovaFicha() {
            const existingIds = Object.keys(fichas).map(id => parseInt(id.replace(defaultFichaIdPrefix, ''))).filter(num => !isNaN(num));
            const nextIdNum = existingIds.length > 0 ? Math.max(...existingIds) + 1 : 1;
            const newFichaId = `${defaultFichaIdPrefix}${nextIdNum}`;

             const nomeNovaFicha = prompt("Digite o nome para a nova ficha:", `Nova Ficha ${nextIdNum}`);
             if (!nomeNovaFicha) return; // User cancelled

            currentFichaId = newFichaId;
            fichas[currentFichaId] = { nome: nomeNovaFicha }; // Initialize with name

             // Add to selector and select it
            const option = document.createElement('option');
            option.value = currentFichaId;
            option.textContent = nomeNovaFicha;
            fichaSelector.appendChild(option);
            fichaSelector.value = currentFichaId;


             populateFormWithFichaData(currentFichaId); // Clear form for the new ficha
             salvarDados(); // Save the initial state (mostly empty + name)
             updateSheetTitle(nomeNovaFicha);
             aplicarCorDeFundoPadrao(); // Reset background for new sheet
             console.log(`Nova ficha criada: ${currentFichaId}`);
        }

        function renomearFichaAtual() {
            if (!currentFichaId) {
                 alert("Nenhuma ficha selecionada para renomear.");
                 return;
            }
            const fichaAtual = fichas[currentFichaId];
            const nomeAntigo = fichaAtual?.nome || `Ficha ${currentFichaId.replace(defaultFichaIdPrefix, '')}`;
            const novoNome = prompt("Digite o novo nome para a ficha:", nomeAntigo);

            if (novoNome && novoNome !== nomeAntigo) {
                 fichaAtual.nome = novoNome; // Update name in data object
                salvarDados(); // Save changes (this will also update selector text and title)
                console.log(`Ficha ${currentFichaId} renomeada para: ${novoNome}`);
            }
        }

        function duplicarFichaAtual() {
            if (!currentFichaId) {
                 alert("Nenhuma ficha selecionada para duplicar.");
                 return;
            }

             const existingIds = Object.keys(fichas).map(id => parseInt(id.replace(defaultFichaIdPrefix, ''))).filter(num => !isNaN(num));
             const nextIdNum = existingIds.length > 0 ? Math.max(...existingIds) + 1 : 1;
             const newFichaId = `${defaultFichaIdPrefix}${nextIdNum}`;

             const fichaOriginal = fichas[currentFichaId];
             const nomeOriginal = fichaOriginal?.nome || `Ficha ${currentFichaId.replace(defaultFichaIdPrefix, '')}`;
             const nomeNovaFicha = `${nomeOriginal} (Cópia)`;

            // Deep copy the original ficha data
             const fichaDuplicada = JSON.parse(JSON.stringify(fichaOriginal));
             fichaDuplicada.nome = nomeNovaFicha; // Set the new name

            currentFichaId = newFichaId; // Switch to the new ficha
            fichas[currentFichaId] = fichaDuplicada;

            // Add to selector and select it
            const option = document.createElement('option');
            option.value = currentFichaId;
            option.textContent = nomeNovaFicha;
            fichaSelector.appendChild(option);
            fichaSelector.value = currentFichaId;

            populateFormWithFichaData(currentFichaId); // Load the duplicated data into the form
             salvarDados(); // Save the new duplicated ficha
             updateSheetTitle(nomeNovaFicha);
             console.log(`Ficha ${currentFichaId} duplicada como: ${newFichaId}`);
         }

        function deletarFichaAtual() {
            if (!currentFichaId) {
                 alert("Nenhuma ficha selecionada para deletar.");
                 return;
            }
            const fichaNome = fichas[currentFichaId]?.nome || `Ficha ${currentFichaId.replace(defaultFichaIdPrefix, '')}`;
             if (!confirm(`Tem certeza que deseja deletar a ficha "${fichaNome}"?\nEsta ação não pode ser desfeita.`)) {
                 return;
             }

             const idToDelete = currentFichaId;

             // Remove from local data
             delete fichas[idToDelete];
             currentFichaId = null; // Reset current ID

            // Attempt to remove from Firebase
            if (typeof database !== 'undefined' && database !== null) {
                 database.ref('fichas/' + idToDelete).remove()
                     .then(() => console.log(`Ficha ${idToDelete} deletada do Firebase.`))
                     .catch((error) => console.error(`Erro ao deletar ${idToDelete} do Firebase:`, error));
             }

             // Update localStorage
             try {
                 localStorage.setItem(localStorageKey, JSON.stringify(fichas));
                 console.log(`Ficha ${idToDelete} removida do localStorage.`);
             } catch (e) {
                 console.error("Erro ao atualizar localStorage após deletar:", e);
             }

            // Update UI
             atualizarSeletorFichas(); // Rebuild selector
            updateUIForCurrentFicha(); // Load the next available ficha or clear the form
            console.log(`Ficha ${idToDelete} deletada.`);
        }

        function atualizarSeletorFichas() {
             fichaSelector.innerHTML = ''; // Clear existing options

            const fichaIds = Object.keys(fichas);

            if (fichaIds.length === 0) {
                 // No fichas exist, create a default one? Or leave empty?
                 // For now, let's leave it empty, user can create one.
                 currentFichaId = null;
                 console.log("Nenhuma ficha disponível.");
                updateSheetTitle("Ficha de Personagem"); // Reset title
                 aplicarCorDeFundoPadrao();
                 // Disable rename/duplicate/delete buttons if needed
                 renomearFichaBtn.disabled = true;
                 duplicarFichaBtn.disabled = true;
                 deletarFichaBtn.disabled = true;
                 return;
             }

             // Enable buttons
             renomearFichaBtn.disabled = false;
             duplicarFichaBtn.disabled = false;
             deletarFichaBtn.disabled = false;


            fichaIds.sort((a, b) => { // Sort alphabetically by name, then by ID number
                const nameA = fichas[a]?.nome || `Ficha ${a.replace(defaultFichaIdPrefix, '')}`;
                const nameB = fichas[b]?.nome || `Ficha ${b.replace(defaultFichaIdPrefix, '')}`;
                 if (nameA.toLowerCase() < nameB.toLowerCase()) return -1;
                 if (nameA.toLowerCase() > nameB.toLowerCase()) return 1;
                 // If names are the same, sort by ID number
                 const idNumA = parseInt(a.replace(defaultFichaIdPrefix, ''));
                 const idNumB = parseInt(b.replace(defaultFichaIdPrefix, ''));
                 return idNumA - idNumB;
            }).forEach(id => {
                const option = document.createElement('option');
                option.value = id;
                 option.textContent = fichas[id]?.nome || `Ficha ${id.replace(defaultFichaIdPrefix, '')}`;
                fichaSelector.appendChild(option);
            });

             // Try to keep the previously selected ficha, otherwise select the first one
            if (currentFichaId && fichas[currentFichaId]) {
                fichaSelector.value = currentFichaId;
            } else if (fichaIds.length > 0) {
                 currentFichaId = fichaSelector.options[0].value; // Select the first one in the sorted list
                fichaSelector.value = currentFichaId;
            } else {
                 currentFichaId = null; // Should not happen if check above works, but safety first
             }
         }


        function updateUIForCurrentFicha() {
             if (currentFichaId && fichas[currentFichaId]) {
                 populateFormWithFichaData(currentFichaId);
                 renomearFichaBtn.disabled = false;
                 duplicarFichaBtn.disabled = false;
                 deletarFichaBtn.disabled = false;
             } else {
                 // No ficha selected or available, clear the form and disable buttons
                 form.reset();
                 calcularCamposDerivados(); // Ensure calculated fields are cleared/reset
                 document.getElementById('ataques-list').innerHTML = `
                     <div class="grid-container grid-cols-4" style="font-weight: bold; margin-bottom: 5px;">
                         <span>Nome</span>
                         <span>Bônus de Ataque</span>
                         <span>Dano / Tipo</span>
                         <span>Ações</span>
                     </div>`; // Reset attacks list
                 updateSheetTitle("Ficha de Personagem");
                 renomearFichaBtn.disabled = true;
                 duplicarFichaBtn.disabled = true;
                 deletarFichaBtn.disabled = true;
                 aplicarCorDeFundoPadrao(); // Reset background when no sheet is loaded
                 aplicarCorDeFundoInicial(); // Reset color picker selection
             }
         }

         function updateSheetTitle(name) {
             sheetTitle.textContent = name || "Ficha de Personagem";
             document.title = name ? `${name} - Ficha RPG` : "Ficha de Personagem RPG"; // Update browser tab title
         }

        function aplicarCorDeFundoPadrao() {
             document.body.style.backgroundColor = '#f0e6d2'; // Default parchment
             document.body.style.backgroundImage = 'none';
             // Reset color picker selection visually
             document.querySelectorAll('#background-color-selector .color-option').forEach(option => {
                 option.classList.toggle('active', option.dataset.color === '#f0e6d2');
             });
        }

        function aplicarCorDeFundo(color) {
            if (!color) return;
             document.body.style.backgroundColor = color;
            // Deactivate other options and activate the selected one
            document.querySelectorAll('#background-color-selector .color-option').forEach(option => {
                option.classList.toggle('active', option.dataset.color === color);
            });
        }


        // --- UI Generation ---
        function gerarCamposPericiasESalvaguardas() {
            const periciasContainer = document.getElementById('pericias-list');
            const salvaguardasContainer = document.getElementById('salvaguardas-list');
            periciasContainer.innerHTML = ''; // Clear existing
             salvaguardasContainer.innerHTML = ''; // Clear existing


             // Gerar Salvaguardas
             ATRIBUTOS.forEach(attr => {
                 const div = document.createElement('div');
                 div.className = 'list-item'; // Use list-item for alignment
                 div.innerHTML = `
                     <input type="checkbox" id="prof_salv_${attr}" name="prof_salv_${attr}" data-save="true" style="width: auto; margin-right: 5px;">
                     <input type="text" id="valor_salv_${attr}" name="valor_salv_${attr}" readonly placeholder="+X" style="flex-grow: 0.3; margin-right: 5px;">
                    <label for="prof_salv_${attr}" style="margin-bottom: 0; font-weight: normal;">${attr.charAt(0).toUpperCase() + attr.slice(1)}</label>
                `;
                salvaguardasContainer.appendChild(div);
             });

             // Gerar Perícias
            Object.entries(PERICIAS).sort((a, b) => a[0].localeCompare(b[0])).forEach(([nome, attr]) => {
                const idBase = nome.toLowerCase().replace(/ /g, '_').normalize("NFD").replace(/[\u0300-\u036f]/g, ""); // Create unique ID
                const div = document.createElement('div');
                div.className = 'list-item'; // Use list-item for alignment
                div.innerHTML = `
                     <input type="checkbox" id="prof_pericia_${idBase}" name="prof_pericia_${idBase}" data-save="true" style="width: auto; margin-right: 5px;">
                     <input type="text" id="valor_pericia_${idBase}" name="valor_pericia_${idBase}" readonly placeholder="+X" style="flex-grow: 0.3; margin-right: 5px;">
                     <label for="prof_pericia_${idBase}" title="${attr.charAt(0).toUpperCase() + attr.slice(1)}" style="margin-bottom: 0; font-weight: normal;">${nome}</label>
                `;
                periciasContainer.appendChild(div);
            });
        }

        // --- Calculation Functions ---
        function calcularModificador(valorAtributo) {
            const val = parseInt(valorAtributo, 10);
            if (isNaN(val)) return 0;
            return Math.floor((val - 10) / 2);
        }

        function formatarModificador(mod) {
            return mod >= 0 ? `+${mod}` : `${mod}`;
        }

         function calcularBonusProficiencia(nivel) {
            const lvl = parseInt(nivel, 10);
            if (isNaN(lvl) || lvl < 1) return 0;
            return Math.ceil(lvl / 4) + 1;
         }

        function calcularCamposDerivados() {
            const nivel = parseInt(document.getElementById('nivel').value, 10) || 1;
            const bonusProf = calcularBonusProficiencia(nivel);
            document.getElementById('bonus_proficiencia').value = formatarModificador(bonusProf);

             let modificadores = {};

            // Calcular Modificadores de Atributos
            ATRIBUTOS.forEach(attr => {
                const input = document.getElementById(attr);
                const mod = calcularModificador(input.value);
                 modificadores[attr] = mod;
                document.getElementById(`mod_${attr}`).value = formatarModificador(mod);
             });

            // Calcular Iniciativa (baseado em Destreza)
            document.getElementById('iniciativa').value = formatarModificador(modificadores.destreza);

             // Calcular Salvaguardas
            ATRIBUTOS.forEach(attr => {
                const profCheckbox = document.getElementById(`prof_salv_${attr}`);
                 const valorFinal = modificadores[attr] + (profCheckbox.checked ? bonusProf : 0);
                 document.getElementById(`valor_salv_${attr}`).value = formatarModificador(valorFinal);
            });

             // Calcular Perícias
             Object.entries(PERICIAS).forEach(([nome, attr]) => {
                 const idBase = nome.toLowerCase().replace(/ /g, '_').normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                 const profCheckbox = document.getElementById(`prof_pericia_${idBase}`);
                 const valorFinal = modificadores[attr] + (profCheckbox.checked ? bonusProf : 0);
                 document.getElementById(`valor_pericia_${idBase}`).value = formatarModificador(valorFinal);
             });

             // Calcular CD Magia e Bônus de Ataque Mágico
            const attrConjuracaoInput = document.getElementById('atributo_conjuracao');
            const attrConjuracao = attrConjuracaoInput.value.toLowerCase().trim();
            let modConjuracao = 0;
            if (modificadores.hasOwnProperty(attrConjuracao)) {
                modConjuracao = modificadores[attrConjuracao];
            } else {
                 // Maybe try to guess based on common class attributes if empty? Or just default to 0.
                 // For now, default to 0 if attribute name is invalid or empty.
             }

             const cdMagia = 8 + bonusProf + modConjuracao;
             const bonusAtaqueMagia = bonusProf + modConjuracao;

             document.getElementById('cd_magia').value = isNaN(cdMagia) ? '' : cdMagia;
             document.getElementById('bonus_ataque_magia').value = isNaN(bonusAtaqueMagia) ? '' : formatarModificador(bonusAtaqueMagia);

         }


        // --- Dynamic List Functions ---
        function adicionarItemLista(button) {
            const listId = button.dataset.list;
            const templateId = button.dataset.template;
            const listContainer = document.getElementById(listId);
            const template = document.getElementById(templateId);

            if (!listContainer || !template) {
                console.error("List container or template not found for", listId, templateId);
                return;
            }

            const clone = template.content.cloneNode(true);
             // Add remove button listener to the new item
             const removeBtn = clone.querySelector('.remove-button');
            if (removeBtn) {
                removeBtn.onclick = (e) => removerItemLista(e.target);
            }

            // Add save listeners to the new inputs within the cloned item
            const newInputs = clone.querySelectorAll('[data-save="true"]');
            newInputs.forEach(input => {
                input.addEventListener('input', salvarDados);
                input.addEventListener('change', salvarDados); // For checkboxes/selects
             });


            listContainer.appendChild(clone);
             salvarDados(); // Save after adding the new (empty) item structure
        }

        function removerItemLista(button) {
            const listItem = button.closest('.list-item');
            if (listItem) {
                 listItem.remove();
                 salvarDados(); // Save after removing item
             }
         }

         function populateList(listId, itemsData, templateId) {
             const listContainer = document.getElementById(listId);
             const template = document.getElementById(templateId); // Needed to find input names

             if (!listContainer || !template) return;

             // Clear existing dynamic items (keep header if it exists)
             const header = listContainer.querySelector('.grid-container'); // Assuming header is a grid
             listContainer.innerHTML = ''; // Clear all
             if(header) listContainer.appendChild(header); // Add header back if it existed


             if (!itemsData || !Array.isArray(itemsData)) return; // No data or invalid data

             itemsData.forEach(itemData => {
                 if (!itemData) return; // Skip empty items if any

                 const clone = template.content.cloneNode(true);
                 const inputs = clone.querySelectorAll('input[type="text"], input[type="number"], select, textarea'); // Find inputs in the template clone

                inputs.forEach(input => {
                    const inputName = input.name.replace('[]', ''); // Get base name, e.g., 'ataque_nome'
                    if (itemData.hasOwnProperty(inputName)) {
                         input.value = itemData[inputName];
                    }
                     // Add listeners for saving
                     input.addEventListener('input', salvarDados);
                     input.addEventListener('change', salvarDados);
                 });

                 // Add remove button listener
                 const removeBtn = clone.querySelector('.remove-button');
                 if (removeBtn) {
                     removeBtn.onclick = (e) => removerItemLista(e.target);
                 }

                 listContainer.appendChild(clone);
             });
         }


        // --- Event Listeners Setup ---
        function setupEventListeners() {
            // Tab switching
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    tabs.forEach(t => t.classList.remove('active'));
                    tabContents.forEach(c => c.classList.remove('active'));
                    tab.classList.add('active');
                    document.getElementById(tab.dataset.tab).classList.add('active');
                });
            });

            // Auto-save on input change
            form.addEventListener('input', (event) => {
                 if (event.target.matches('[data-save="true"]')) {
                     salvarDados();
                 }
                 // Recalculate derived fields if relevant inputs change
                 if (event.target.matches('.atributo, #nivel, input[type="checkbox"][name^="prof_"]')) {
                     calcularCamposDerivados();
                     // Need to save again after calculations update readonly fields if they were part of the form data (they aren't currently)
                     // salvarDados(); // Uncomment if calculated fields need explicit saving
                 }
            });
             // Also save on 'change' for elements like checkboxes and selects
             form.addEventListener('change', (event) => {
                 if (event.target.matches('[data-save="true"][type="checkbox"], [data-save="true"][type="radio"], [data-save="true"]select')) {
                     salvarDados();
                      // Recalculate if a proficiency checkbox changed
                     if (event.target.matches('input[type="checkbox"][name^="prof_"]')) {
                         calcularCamposDerivados();
                     }
                 }
             });


            // Ficha management buttons
            novaFichaBtn.addEventListener('click', criarNovaFicha);
            renomearFichaBtn.addEventListener('click', renomearFichaAtual);
            duplicarFichaBtn.addEventListener('click', duplicarFichaAtual);
            deletarFichaBtn.addEventListener('click', deletarFichaAtual);
            fichaSelector.addEventListener('change', () => {
                 currentFichaId = fichaSelector.value;
                 updateUIForCurrentFicha(); // Load selected ficha data
            });

            // Add item buttons (e.g., add attack)
            document.querySelectorAll('.add-button').forEach(button => {
                button.addEventListener('click', () => adicionarItemLista(button));
            });

            // Initial setup for any existing remove buttons (though populated lists handle this now)
             document.querySelectorAll('.remove-button').forEach(button => {
                 button.addEventListener('click', () => removerItemLista(button));
             });

              // Theme toggle
             themeToggleBtn.addEventListener('click', toggleTheme);

              // Background Image Handling
             bgUploadBtn.addEventListener('click', () => bgUploadInput.click());
             bgUploadInput.addEventListener('change', handleBackgroundUpload);
             removeBgBtn.addEventListener('click', removeBackgroundImage);

             // Background Color Handling
             corFundoBtn.onclick = () => {
                 backgroundColorSelector.style.display = backgroundColorSelector.style.display === 'none' || backgroundColorSelector.style.display === '' ? 'flex' : 'none';
            };
             backgroundColorSelector.addEventListener('click', (event) => {
                 if (event.target.classList.contains('color-option')) {
                     const color = event.target.dataset.color;
                     aplicarCorDeFundo(color); // Apply the color visually
                     document.body.style.backgroundImage = 'none'; // Remove background image when color is chosen
                     salvarDados(); // Save the new background color state
                     backgroundColorSelector.style.display = 'none'; // Hide picker
                 }
             });
             // Close color picker if clicking outside
             document.addEventListener('click', function(event) {
                 if (!backgroundColorSelector.contains(event.target) && !corFundoBtn.contains(event.target)) {
                     backgroundColorSelector.style.display = 'none';
                 }
             });


         }

        // --- Theme Management ---
        function toggleTheme() {
            document.body.classList.toggle('dark-mode');
            const isDarkMode = document.body.classList.contains('dark-mode');
            themeToggleBtn.textContent = isDarkMode ? '🌙' : '☀️'; // Update icon
            localStorage.setItem('theme', isDarkMode ? 'dark' : 'light'); // Save preference
             console.log("Theme toggled to:", isDarkMode ? 'Dark' : 'Light');
             // Update background color picker active state if dark mode default is selected
             aplicarCorDeFundoInicial();

         }

        function loadThemePreference() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                document.body.classList.add('dark-mode');
                themeToggleBtn.textContent = '🌙';
             } else {
                 document.body.classList.remove('dark-mode');
                 themeToggleBtn.textContent = '☀️';
             }
             console.log("Loaded theme preference:", savedTheme || 'light');
         }

         // --- Background Image Functions ---
         function handleBackgroundUpload(event) {
             const file = event.target.files[0];
             if (file && file.type.startsWith('image/')) {
                 const reader = new FileReader();
                 reader.onload = function(e) {
                     document.body.style.backgroundImage = `url('${e.target.result}')`;
                     document.body.style.backgroundColor = ''; // Clear background color when image is set
                     salvarDados(); // Save the new background image state
                     // Optionally reset background color picker selection
                      document.querySelectorAll('#background-color-selector .color-option').forEach(option => option.classList.remove('active'));
                 }
                 reader.readAsDataURL(file);
             } else {
                 alert("Por favor, selecione um arquivo de imagem válido.");
             }
             // Reset input value so the same file can be selected again if needed
             event.target.value = null;
         }

         function removeBackgroundImage() {
              document.body.style.backgroundImage = 'none';
             // Optionally, restore the last used background color or a default
              const lastColor = fichas[currentFichaId]?.backgroundColor || '#f0e6d2';
              aplicarCorDeFundo(lastColor);
              salvarDados(); // Save the state without the background image
          }

        // --- Background Color Functionality --- (Simplified version, full logic in EventListeners)
        function aplicarCorDeFundoInicial() {
            const fichaBgColor = fichas[currentFichaId]?.backgroundColor;
            const currentBgColor = document.body.style.backgroundColor; // Get the actual current color
             const hasBgImage = document.body.style.backgroundImage && document.body.style.backgroundImage !== 'none';

            let colorToApply = '#f0e6d2'; // Default

            if (!hasBgImage) { // Only apply/highlight color if no image is set
                 if (currentFichaId && fichas[currentFichaId] && fichaBgColor) {
                      colorToApply = fichaBgColor; // Use saved color for the sheet
                 } else if (currentBgColor) {
                     colorToApply = currentBgColor; // Use whatever color is currently set
                 }

                 document.body.style.backgroundColor = colorToApply; // Ensure body has the color
                 // Update the color picker visual selection
                 document.querySelectorAll('#background-color-selector .color-option').forEach(option => {
                     // Use rgbToHex to compare accurately as 'backgroundColor' might return rgb()
                     option.classList.toggle('active', option.dataset.color === colorToApply || option.style.backgroundColor === colorToApply);
                 });
             } else {
                 // If there's a background image, remove the active state from color swatches
                 document.querySelectorAll('#background-color-selector .color-option').forEach(option => option.classList.remove('active'));
             }
         }


        // --- Utility Functions ---
         // Helper to convert rgb(a) string to hex (optional, but useful for comparisons)
        function rgbToHex(rgb) {
            if (!rgb || !rgb.startsWith('rgb')) return rgb; // Return original if not rgb or empty
             // Choose correct separator
             const separator = rgb.indexOf(',') > -1 ? ',' : ' ';
             // Turn "rgb(r, g, b)" into [r, g, b]
             const rgbValues = rgb.substr(4).split(')')[0].split(separator);

             let r = (+rgbValues[0]).toString(16),
                 g = (+rgbValues[1]).toString(16),
                 b = (+rgbValues[2]).toString(16);

             if (r.length == 1) r = '0' + r;
             if (g.length == 1) g = '0' + g;
             if (b.length == 1) b = '0' + b;

             return '#' + r + g + b;
         }


        // --- Start the application ---
        document.addEventListener('DOMContentLoaded', initializeUI);

    </script>
</body>
</html>
